<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/LJ/Comment.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/LJ/Comment.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">29.3%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># LiveJournal comment object.</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Just framing right now, not much to see here!</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">6</td><td colspan="7"></td></tr><tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ::Comment;</td></tr>
<tr><td class="h">8</td><td colspan="7"></td></tr><tr><td class="h">9</td><td><div class="c3">6</div><div class="c3">6</div><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L9">6</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">10</td><td><div class="c3">6</div><div class="c3">6</div><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L10">6</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use Carp qw/ croak /;</td></tr>
<tr><td class="h">11</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">use Class::Autouse qw(</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Entry</td></tr>
<tr><td class="h">13</td><td><div class="c3">6</div><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L13">6</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">14</td><td colspan="7"></td></tr><tr><td class="h">15</td><td><div class="c3">6</div><div class="c3">6</div><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L15">6</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use lib &quot;$LJ::HOME/cgi-bin&quot;;</td></tr>
<tr><td class="h">16</td><td colspan="7"></td></tr><tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">require &quot;htmlcontrols.pl&quot;;</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">require &quot;talklib.pl&quot;;</td></tr>
<tr><td class="h">19</td><td colspan="7"></td></tr><tr><td class="h">20</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># internal fields:</td></tr>
<tr><td class="h">21</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">22</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    journalid:     journalid where the commend was</td></tr>
<tr><td class="h">23</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                   posted,                          always present</td></tr>
<tr><td class="h">24</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    jtalkid:       jtalkid identifying this comment</td></tr>
<tr><td class="h">25</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                   within the journal_u,            always present</td></tr>
<tr><td class="h">26</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">27</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    nodetype:      single-char nodetype identifier, loaded if _loaded_row</td></tr>
<tr><td class="h">28</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    nodeid:        nodeid to which this comment</td></tr>
<tr><td class="h">29</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                   applies (often an entry itemid), loaded if _loaded_row</td></tr>
<tr><td class="h">30</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">31</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    parenttalkid:  talkid of parent comment,        loaded if _loaded_row</td></tr>
<tr><td class="h">32</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    posterid:      userid of posting user           lazily loaded at access</td></tr>
<tr><td class="h">33</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    datepost_unix: unixtime from the &#39;datepost&#39;     loaded if _loaded_row</td></tr>
<tr><td class="h">34</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    state:         comment state identifier,        loaded if _loaded_row</td></tr>
<tr><td class="h">35</td><td colspan="7"></td></tr><tr><td class="h">36</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    body:          text of comment,                 loaded if _loaded_text</td></tr>
<tr><td class="h">37</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    body_orig:     text of comment w/o transcoding, present if unknown8bit</td></tr>
<tr><td class="h">38</td><td colspan="7"></td></tr><tr><td class="h">39</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    subject:       subject of comment,              loaded if _loaded_text</td></tr>
<tr><td class="h">40</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    subject_orig   subject of comment w/o transcoding, present if unknown8bit</td></tr>
<tr><td class="h">41</td><td colspan="7"></td></tr><tr><td class="h">42</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    props:   hashref of props,                    loaded if _loaded_props</td></tr>
<tr><td class="h">43</td><td colspan="7"></td></tr><tr><td class="h">44</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    _loaded_text:   loaded talktext2 row</td></tr>
<tr><td class="h">45</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    _loaded_row:    loaded talk2 row</td></tr>
<tr><td class="h">46</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    _loaded_props:  loaded props</td></tr>
<tr><td class="h">47</td><td colspan="7"></td></tr><tr><td class="h">48</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">my %singletons = (); # journalid-&gt;jtalkid-&gt;singleton</td></tr>
<tr><td class="h">49</td><td colspan="7"></td></tr><tr><td class="h">50</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub reset_singletons {</td></tr>
<tr><td class="h">51</td><td><div class="c3">43</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L51">43</a></div></td><td><div class="c0">0</div></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;%singletons = ();</td></tr>
<tr><td class="h">52</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">53</td><td colspan="7"></td></tr><tr><td class="h">54</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Comment::new</td></tr>
<tr><td class="h">56</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: comment</td></tr>
<tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets a comment given journal_u entry and jtalkid.</td></tr>
<tr><td class="h">58</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uobj, opts?</td></tr>
<tr><td class="h">59</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uobj: A user id or user object ($u) to load the comment for.</td></tr>
<tr><td class="h">60</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: Hash of optional keypairs.</td></tr>
<tr><td class="h">61</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           jtalkid =&gt; talkid journal itemid (no anum)</td></tr>
<tr><td class="h">62</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: A new LJ::Comment object. Returns undef on failure.</td></tr>
<tr><td class="h">63</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">64</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub instance {</td></tr>
<tr><td class="h">65</td><td><div class="c3">1014</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L65">1014</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">66</td><td><div class="c3">1014</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self  = bless {};</td></tr>
<tr><td class="h">67</td><td colspan="7"></td></tr><tr><td class="h">68</td><td><div class="c3">1014</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uuserid = shift;</td></tr>
<tr><td class="h">69</td><td><div class="c3">1014</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $n_arg   = scalar @_;</td></tr>
<tr><td class="h">70</td><td><div class="c3">1014</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L70">100</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L70">67</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;wrong number of arguments&quot;)</td></tr>
<tr><td class="h">71</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $n_arg &amp;&amp; ($n_arg % 2 == 0);</td></tr>
<tr><td class="h">72</td><td colspan="7"></td></tr><tr><td class="h">73</td><td><div class="c3">1011</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %opts = @_;</td></tr>
<tr><td class="h">74</td><td colspan="7"></td></tr><tr><td class="h">75</td><td><div class="c3">1011</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L75">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{journalid} = LJ::want_userid($uuserid) or</td></tr>
<tr><td class="h">76</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;invalid journalid parameter&quot;);</td></tr>
<tr><td class="h">77</td><td colspan="7"></td></tr><tr><td class="h">78</td><td><div class="c3">1005</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{jtalkid} = int(delete $opts{jtalkid});</td></tr>
<tr><td class="h">79</td><td colspan="7"></td></tr><tr><td class="h">80</td><td><div class="c3">1005</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L80">100</a></div></td><td></td><td></td><td></td><td><div>116008</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $dtalkid = int(delete $opts{dtalkid})) {</td></tr>
<tr><td class="h">81</td><td><div class="c3">227</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{jtalkid} = $dtalkid &gt;&gt; 8;</td></tr>
<tr><td class="h">82</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">83</td><td colspan="7"></td></tr><tr><td class="h">84</td><td><div class="c3">1005</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L84">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;need to supply jtalkid or dtalkid&quot;)</td></tr>
<tr><td class="h">85</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $self-&gt;{jtalkid};</td></tr>
<tr><td class="h">86</td><td colspan="7"></td></tr><tr><td class="h">87</td><td><div class="c3">1002</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L87">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;unknown parameter: &quot; . join(&quot;, &quot;, keys %opts))</td></tr>
<tr><td class="h">88</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if %opts;</td></tr>
<tr><td class="h">89</td><td colspan="7"></td></tr><tr><td class="h">90</td><td><div class="c3">999</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalid = $self-&gt;{journalid};</td></tr>
<tr><td class="h">91</td><td><div class="c3">999</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jtalkid   = $self-&gt;{jtalkid};</td></tr>
<tr><td class="h">92</td><td colspan="7"></td></tr><tr><td class="h">93</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do we have a singleton for this comment?</td></tr>
<tr><td class="h">94</td><td><div class="c3">999</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--condition.html#L94">100</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$singletons{$journalid} ||= {};</td></tr>
<tr><td class="h">95</td><td><div class="c3">999</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L95">100</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $singletons{$journalid}-&gt;{$jtalkid}</td></tr>
<tr><td class="h">96</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $singletons{$journalid}-&gt;{$jtalkid};</td></tr>
<tr><td class="h">97</td><td colspan="7"></td></tr><tr><td class="h">98</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# save the singleton if it doesn&#39;t exist</td></tr>
<tr><td class="h">99</td><td><div class="c3">250</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$singletons{$journalid}-&gt;{$jtalkid} = $self;</td></tr>
<tr><td class="h">100</td><td colspan="7"></td></tr><tr><td class="h">101</td><td><div class="c3">250</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L101">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;need to supply jtalkid&quot;) unless $self-&gt;{jtalkid};</td></tr>
<tr><td class="h">102</td><td><div class="c3">250</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L102">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;unknown parameters: &quot; . join(&quot;, &quot;, keys %opts))</td></tr>
<tr><td class="h">103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if %opts;</td></tr>
<tr><td class="h">104</td><td><div class="c3">250</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self;</td></tr>
<tr><td class="h">105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*new = \&amp;instance;</td></tr>
<tr><td class="h">107</td><td colspan="7"></td></tr><tr><td class="h">108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method. takes a ?thread= or ?replyto= URL</td></tr>
<tr><td class="h">109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># to a comment, and returns that comment object</td></tr>
<tr><td class="h">110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new_from_url {</td></tr>
<tr><td class="h">111</td><td><div class="c3">13</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L111">13</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $url) = @_;</td></tr>
<tr><td class="h">112</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$url =~ s!#.*!!;</td></tr>
<tr><td class="h">113</td><td colspan="7"></td></tr><tr><td class="h">114</td><td><div class="c3">13</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L114">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($url =~ /(.+?)\?(?:thread|replyto)\=(\d+)/) {</td></tr>
<tr><td class="h">115</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new_from_url($1);</td></tr>
<tr><td class="h">116</td><td><div class="c3">13</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L116">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $entry;</td></tr>
<tr><td class="h">117</td><td><div class="c3">13</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Comment-&gt;new($entry-&gt;journal, dtalkid =&gt; $2);</td></tr>
<tr><td class="h">118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">119</td><td colspan="7"></td></tr><tr><td class="h">120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">122</td><td colspan="7"></td></tr><tr><td class="h">123</td><td colspan="7"></td></tr><tr><td class="h">124</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Comment::create</td></tr>
<tr><td class="h">126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: comment</td></tr>
<tr><td class="h">127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Create a new comment. Add them to DB.</td></tr>
<tr><td class="h">128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: </td></tr>
<tr><td class="h">129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: A new LJ::Comment object. Returns undef on failure.</td></tr>
<tr><td class="h">130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">131</td><td colspan="7"></td></tr><tr><td class="h">132</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create {</td></tr>
<tr><td class="h">133</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L133">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %opts  = @_;</td></tr>
<tr><td class="h">135</td><td colspan="7"></td></tr><tr><td class="h">136</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L136">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $need_captcha = delete($opts{ need_captcha }) || 0;</td></tr>
<tr><td class="h">137</td><td colspan="7"></td></tr><tr><td class="h">138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# %talk_opts emulates parameters received from web form.</td></tr>
<tr><td class="h">139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Fill it with nessesary options.</td></tr>
<tr><td class="h">140</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %talk_opts = map { $_ =&gt; delete $opts{$_} }</td></tr>
<tr><td class="h">141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qw(nodetype parenttalkid body subject props);</td></tr>
<tr><td class="h">142</td><td colspan="7"></td></tr><tr><td class="h">143</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# poster and journal should be $u objects,</td></tr>
<tr><td class="h">144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# but talklib wants usernames... we&#39;ll map here</td></tr>
<tr><td class="h">145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalu = delete $opts{journal};</td></tr>
<tr><td class="h">146</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L146">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid journal for new comment: $journalu&quot;</td></tr>
<tr><td class="h">147</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::isu($journalu);</td></tr>
<tr><td class="h">148</td><td colspan="7"></td></tr><tr><td class="h">149</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posteru = delete $opts{poster};</td></tr>
<tr><td class="h">150</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L150">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid poster for new comment: $posteru&quot;</td></tr>
<tr><td class="h">151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::isu($posteru);</td></tr>
<tr><td class="h">152</td><td colspan="7"></td></tr><tr><td class="h">153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# LJ::Talk::init uses &#39;itemid&#39;, not &#39;ditemid&#39;.</td></tr>
<tr><td class="h">154</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talk_opts{itemid} = delete $opts{ditemid};</td></tr>
<tr><td class="h">155</td><td colspan="7"></td></tr><tr><td class="h">156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# LJ::Talk::init needs journal name</td></tr>
<tr><td class="h">157</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talk_opts{journal} = $journalu-&gt;user;</td></tr>
<tr><td class="h">158</td><td colspan="7"></td></tr><tr><td class="h">159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Strictly parameters check. Do not allow any unused params to be passed in.</td></tr>
<tr><td class="h">160</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L160">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak (__PACKAGE__ . &quot;-&gt;create: Unsupported params: &quot; . join &quot; &quot; =&gt; keys %opts )</td></tr>
<tr><td class="h">161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if %opts;</td></tr>
<tr><td class="h">162</td><td colspan="7"></td></tr><tr><td class="h">163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Move props values to the talk_opts hash.</td></tr>
<tr><td class="h">164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Because LJ::Talk::Post::init needs this.</td></tr>
<tr><td class="h">165</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $key (  keys %{ $talk_opts{props} }  ){</td></tr>
<tr><td class="h">166</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $talk_key = &quot;prop_$key&quot;;</td></tr>
<tr><td class="h">167</td><td colspan="7"></td></tr><tr><td class="h">168</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L168">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$talk_opts{$talk_key} = delete $talk_opts{props}-&gt;{$key} </td></tr>
<tr><td class="h">169</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if not exists $talk_opts{$talk_key};</td></tr>
<tr><td class="h">170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">171</td><td colspan="7"></td></tr><tr><td class="h">172</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# The following 2 options are necessary for successful user authentification </td></tr>
<tr><td class="h">173</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# in the depth of LJ::Talk::Post::init.</td></tr>
<tr><td class="h">174</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#</td></tr>
<tr><td class="h">175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this almost certainly should be &#39;usertype=user&#39; rather than</td></tr>
<tr><td class="h">176</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#        &#39;cookieuser&#39; with $remote passed below.  Gross.</td></tr>
<tr><td class="h">177</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L177">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talk_opts{cookieuser} ||= $posteru-&gt;user;</td></tr>
<tr><td class="h">178</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L178">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talk_opts{usertype}   ||= &#39;cookieuser&#39;;</td></tr>
<tr><td class="h">179</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L179">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talk_opts{nodetype}   ||= &#39;L&#39;;</td></tr>
<tr><td class="h">180</td><td colspan="7"></td></tr><tr><td class="h">181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## init.  this handles all the error-checking, as well.</td></tr>
<tr><td class="h">182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @errors       = ();</td></tr>
<tr><td class="h">183</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $init = LJ::Talk::Post::init(\%talk_opts, $posteru, \$need_captcha, \@errors); </td></tr>
<tr><td class="h">184</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L184">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak( join &quot;\n&quot; =&gt; @errors )</td></tr>
<tr><td class="h">185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless defined $init;</td></tr>
<tr><td class="h">186</td><td colspan="7"></td></tr><tr><td class="h">187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check max comments</td></tr>
<tr><td class="h">188</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L188">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak (&quot;Sorry, this entry already has the maximum number of comments allowed.&quot;)</td></tr>
<tr><td class="h">189</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if LJ::Talk::Post::over_maxcomments($init-&gt;{journalu}, $init-&gt;{item}-&gt;{&#39;jitemid&#39;});</td></tr>
<tr><td class="h">190</td><td colspan="7"></td></tr><tr><td class="h">191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# no replying to frozen comments</td></tr>
<tr><td class="h">192</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L192">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&#39;No reply to frozen thread&#39;)</td></tr>
<tr><td class="h">193</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $init-&gt;{parent}-&gt;{state} eq &#39;F&#39;;</td></tr>
<tr><td class="h">194</td><td colspan="7"></td></tr><tr><td class="h">195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## insertion</td></tr>
<tr><td class="h">196</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $wasscreened = ($init-&gt;{parent}-&gt;{state} eq &#39;S&#39;);</td></tr>
<tr><td class="h">197</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err;</td></tr>
<tr><td class="h">198</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L198">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak ($err)</td></tr>
<tr><td class="h">199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::Talk::Post::post_comment($init-&gt;{entryu},  $init-&gt;{journalu},</td></tr>
<tr><td class="h">200</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{comment}, $init-&gt;{parent}, </td></tr>
<tr><td class="h">201</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{item},   \$err,</td></tr>
<tr><td class="h">202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">203</td><td colspan="7"></td></tr><tr><td class="h">204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return </td></tr>
<tr><td class="h">205</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Comment-&gt;new($init-&gt;{journalu}, jtalkid =&gt; $init-&gt;{comment}-&gt;{talkid});</td></tr>
<tr><td class="h">206</td><td colspan="7"></td></tr><tr><td class="h">207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">208</td><td colspan="7"></td></tr><tr><td class="h">209</td><td colspan="7"></td></tr><tr><td class="h">210</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub absorb_row {</td></tr>
<tr><td class="h">211</td><td><div class="c3">430</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L211">430</a></div></td><td><div class="c0">0</div></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, %row) = @_;</td></tr>
<tr><td class="h">212</td><td colspan="7"></td></tr><tr><td class="h">213</td><td><div class="c3">430</div><div class="c3">430</div></td><td></td><td></td><td></td><td></td><td><div>4000</div><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{$_} = $row{$_} foreach (qw(nodetype nodeid parenttalkid posterid datepost state));</td></tr>
<tr><td class="h">214</td><td><div class="c3">430</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{_loaded_row} = 1;</td></tr>
<tr><td class="h">215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">216</td><td colspan="7"></td></tr><tr><td class="h">217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub url {</td></tr>
<tr><td class="h">218</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L218">3</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self    = shift;</td></tr>
<tr><td class="h">219</td><td colspan="7"></td></tr><tr><td class="h">220</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dtalkid = $self-&gt;dtalkid;</td></tr>
<tr><td class="h">221</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry   = $self-&gt;entry;</td></tr>
<tr><td class="h">222</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $url     = $entry-&gt;url;</td></tr>
<tr><td class="h">223</td><td colspan="7"></td></tr><tr><td class="h">224</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$url?thread=$dtalkid&quot; . LJ::Talk::comment_anchor( $dtalkid );</td></tr>
<tr><td class="h">225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*thread_url = \&amp;url;</td></tr>
<tr><td class="h">227</td><td colspan="7"></td></tr><tr><td class="h">228</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub reply_url {</td></tr>
<tr><td class="h">229</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L229">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self    = shift;</td></tr>
<tr><td class="h">230</td><td colspan="7"></td></tr><tr><td class="h">231</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dtalkid = $self-&gt;dtalkid;</td></tr>
<tr><td class="h">232</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry   = $self-&gt;entry;</td></tr>
<tr><td class="h">233</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $url     = $entry-&gt;url;</td></tr>
<tr><td class="h">234</td><td colspan="7"></td></tr><tr><td class="h">235</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$url?replyto=$dtalkid&quot;;</td></tr>
<tr><td class="h">236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">237</td><td colspan="7"></td></tr><tr><td class="h">238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub parent_url {</td></tr>
<tr><td class="h">239</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L239">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self    = shift;</td></tr>
<tr><td class="h">240</td><td colspan="7"></td></tr><tr><td class="h">241</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parent  = $self-&gt;parent;</td></tr>
<tr><td class="h">242</td><td colspan="7"></td></tr><tr><td class="h">243</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L243">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $parent;</td></tr>
<tr><td class="h">244</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $parent-&gt;url;</td></tr>
<tr><td class="h">245</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">246</td><td colspan="7"></td></tr><tr><td class="h">247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unscreen_url {</td></tr>
<tr><td class="h">248</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L248">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self    = shift;</td></tr>
<tr><td class="h">249</td><td colspan="7"></td></tr><tr><td class="h">250</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dtalkid = $self-&gt;dtalkid;</td></tr>
<tr><td class="h">251</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry   = $self-&gt;entry;</td></tr>
<tr><td class="h">252</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journal = $entry-&gt;journal-&gt;{user};</td></tr>
<tr><td class="h">253</td><td colspan="7"></td></tr><tr><td class="h">254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return</td></tr>
<tr><td class="h">255</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;$LJ::SITEROOT/talkscreen&quot; .</td></tr>
<tr><td class="h">256</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;?mode=unscreen&amp;journal=$journal&quot; .</td></tr>
<tr><td class="h">257</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&amp;talkid=$dtalkid&quot;;</td></tr>
<tr><td class="h">258</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">259</td><td colspan="7"></td></tr><tr><td class="h">260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_url {</td></tr>
<tr><td class="h">261</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L261">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self    = shift;</td></tr>
<tr><td class="h">262</td><td colspan="7"></td></tr><tr><td class="h">263</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dtalkid = $self-&gt;dtalkid;</td></tr>
<tr><td class="h">264</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry   = $self-&gt;entry;</td></tr>
<tr><td class="h">265</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journal = $entry-&gt;journal-&gt;{user};</td></tr>
<tr><td class="h">266</td><td colspan="7"></td></tr><tr><td class="h">267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return</td></tr>
<tr><td class="h">268</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;$LJ::SITEROOT/delcomment&quot; .</td></tr>
<tr><td class="h">269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;?journal=$journal&amp;id=$dtalkid&quot;;</td></tr>
<tr><td class="h">270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">271</td><td colspan="7"></td></tr><tr><td class="h">272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub edit_url {</td></tr>
<tr><td class="h">273</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L273">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self    = shift;</td></tr>
<tr><td class="h">274</td><td colspan="7"></td></tr><tr><td class="h">275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dtalkid = $self-&gt;dtalkid;</td></tr>
<tr><td class="h">276</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry   = $self-&gt;entry;</td></tr>
<tr><td class="h">277</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $url     = $entry-&gt;url;</td></tr>
<tr><td class="h">278</td><td colspan="7"></td></tr><tr><td class="h">279</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$url?edit=$dtalkid&quot;;</td></tr>
<tr><td class="h">280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">281</td><td colspan="7"></td></tr><tr><td class="h">282</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return img tag of userpic that the comment poster used</td></tr>
<tr><td class="h">283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub poster_userpic {</td></tr>
<tr><td class="h">284</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L284">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">285</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pic_kw = $self-&gt;prop(&#39;picture_keyword&#39;);</td></tr>
<tr><td class="h">286</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posteru = $self-&gt;poster;</td></tr>
<tr><td class="h">287</td><td colspan="7"></td></tr><tr><td class="h">288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# anonymous poster, no userpic</td></tr>
<tr><td class="h">289</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L289">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&quot; unless $posteru;</td></tr>
<tr><td class="h">290</td><td colspan="7"></td></tr><tr><td class="h">291</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# new from keyword falls back to the default userpic if</td></tr>
<tr><td class="h">292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# there was no keyword, or if the keyword is no longer used</td></tr>
<tr><td class="h">293</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pic = LJ::Userpic-&gt;new_from_keyword($posteru, $pic_kw);</td></tr>
<tr><td class="h">294</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L294">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $pic-&gt;imgtag_nosize if $pic;</td></tr>
<tr><td class="h">295</td><td colspan="7"></td></tr><tr><td class="h">296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# no userpic with comment</td></tr>
<tr><td class="h">297</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&quot;;</td></tr>
<tr><td class="h">298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">299</td><td colspan="7"></td></tr><tr><td class="h">300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return LJ::User of journal comment is in</td></tr>
<tr><td class="h">301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub journal {</td></tr>
<tr><td class="h">302</td><td><div class="c3">2681</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L302">2681</a></div></td><td><div class="c0">0</div></td><td><div>20002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">303</td><td><div class="c3">2681</div></td><td></td><td></td><td></td><td></td><td><div>40001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::load_userid($self-&gt;{journalid});</td></tr>
<tr><td class="h">304</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">305</td><td colspan="7"></td></tr><tr><td class="h">306</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub journalid {</td></tr>
<tr><td class="h">307</td><td><div class="c3">1109</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L307">1109</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">308</td><td><div class="c3">1109</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{journalid};</td></tr>
<tr><td class="h">309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">310</td><td colspan="7"></td></tr><tr><td class="h">311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return LJ::Entry of entry comment is in, or undef if it&#39;s not</td></tr>
<tr><td class="h">312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># a nodetype of L</td></tr>
<tr><td class="h">313</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub entry {</td></tr>
<tr><td class="h">314</td><td><div class="c3">680</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L314">680</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">315</td><td colspan="7"></td></tr><tr><td class="h">316</td><td><div class="c3">680</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L316">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L316">33</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $self &amp;&amp; $self-&gt;valid;</td></tr>
<tr><td class="h">317</td><td><div class="c3">680</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Entry-&gt;new($self-&gt;journal, jitemid =&gt; $self-&gt;nodeid);</td></tr>
<tr><td class="h">318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">319</td><td colspan="7"></td></tr><tr><td class="h">320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub jtalkid {</td></tr>
<tr><td class="h">321</td><td><div class="c3">2158</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L321">2158</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">322</td><td><div class="c3">2158</div></td><td></td><td></td><td></td><td></td><td><div>20000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{jtalkid};</td></tr>
<tr><td class="h">323</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">324</td><td colspan="7"></td></tr><tr><td class="h">325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub dtalkid {</td></tr>
<tr><td class="h">326</td><td><div class="c3">16</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L326">16</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">327</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry = $self-&gt;entry;</td></tr>
<tr><td class="h">328</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ($self-&gt;jtalkid * 256) + $entry-&gt;anum;</td></tr>
<tr><td class="h">329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">330</td><td colspan="7"></td></tr><tr><td class="h">331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub nodeid {</td></tr>
<tr><td class="h">332</td><td><div class="c3">1108</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L332">1108</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">333</td><td colspan="7"></td></tr><tr><td class="h">334</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we want to fast-path and not preload_rows here if we can avoid it...</td></tr>
<tr><td class="h">335</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# this sometimes gets called en masse on a bunch of comments, and</td></tr>
<tr><td class="h">336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if there are a lot, the preload_rows calls (which do nothing) cause</td></tr>
<tr><td class="h">337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the apache request to time out.</td></tr>
<tr><td class="h">338</td><td><div class="c3">1108</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L338">50</a></div></td><td></td><td></td><td></td><td><div>28002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{nodeid} if $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">339</td><td colspan="7"></td></tr><tr><td class="h">340</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self-&gt;unloaded_singletons] );</td></tr>
<tr><td class="h">341</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{nodeid};</td></tr>
<tr><td class="h">342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">343</td><td colspan="7"></td></tr><tr><td class="h">344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub nodetype {</td></tr>
<tr><td class="h">345</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L345">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">346</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self-&gt;unloaded_singletons] );</td></tr>
<tr><td class="h">347</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{nodetype};</td></tr>
<tr><td class="h">348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">349</td><td colspan="7"></td></tr><tr><td class="h">350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub parenttalkid {</td></tr>
<tr><td class="h">351</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L351">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">352</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self-&gt;unloaded_singletons ]);</td></tr>
<tr><td class="h">353</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{parenttalkid};</td></tr>
<tr><td class="h">354</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">355</td><td colspan="7"></td></tr><tr><td class="h">356</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a LJ::Comment object for the parent</td></tr>
<tr><td class="h">357</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub parent {</td></tr>
<tr><td class="h">358</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L358">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">359</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L359">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ptalkid = $self-&gt;parenttalkid or return undef;</td></tr>
<tr><td class="h">360</td><td colspan="7"></td></tr><tr><td class="h">361</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Comment-&gt;new($self-&gt;journal, jtalkid =&gt; $ptalkid);</td></tr>
<tr><td class="h">362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">363</td><td colspan="7"></td></tr><tr><td class="h">364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns an array of LJ::Comment objects with parentid == $self-&gt;jtalkid</td></tr>
<tr><td class="h">365</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub children {</td></tr>
<tr><td class="h">366</td><td><div class="c3">54</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L366">54</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">367</td><td colspan="7"></td></tr><tr><td class="h">368</td><td><div class="c3">54</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry = $self-&gt;entry;</td></tr>
<tr><td class="h">369</td><td><div class="c3">54</div><div class="c3">1134</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return grep { $_-&gt;{parenttalkid} == $self-&gt;{jtalkid} } $entry-&gt;comment_list;</td></tr>
<tr><td class="h">370</td><td colspan="7"></td></tr><tr><td class="h">371</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: It might be a good idea to check to see if the entry object had</td></tr>
<tr><td class="h">372</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#        comments cached above, then fall back to a query to select a list</td></tr>
<tr><td class="h">373</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#        from db or memcache</td></tr>
<tr><td class="h">374</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">375</td><td colspan="7"></td></tr><tr><td class="h">376</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub has_children {</td></tr>
<tr><td class="h">377</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L377">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">378</td><td colspan="7"></td></tr><tr><td class="h">379</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L379">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;children ? 1 : 0;</td></tr>
<tr><td class="h">380</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">381</td><td colspan="7"></td></tr><tr><td class="h">382</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub has_nondeleted_children {</td></tr>
<tr><td class="h">383</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L383">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $nondeleted_children = grep { ! $_-&gt;is_deleted } $_[0]-&gt;children;</td></tr>
<tr><td class="h">384</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L384">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $nondeleted_children ? 1 : 0;</td></tr>
<tr><td class="h">385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">386</td><td colspan="7"></td></tr><tr><td class="h">387</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns true if entry currently exists.  (it&#39;s possible for a given</td></tr>
<tr><td class="h">388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $u, to make a fake jitemid and that&#39;d be a valid skeleton LJ::Entry</td></tr>
<tr><td class="h">389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># object, even though that jitemid hasn&#39;t been created yet, or was</td></tr>
<tr><td class="h">390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># previously deleted)</td></tr>
<tr><td class="h">391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub valid {</td></tr>
<tr><td class="h">392</td><td><div class="c3">693</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L392">693</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">393</td><td><div class="c3">693</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $self-&gt;journal;</td></tr>
<tr><td class="h">394</td><td><div class="c3">693</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L394">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L394">33</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u &amp;&amp; $u-&gt;{clusterid};</td></tr>
<tr><td class="h">395</td><td><div class="c3">693</div></td><td></td><td></td><td></td><td></td><td><div>16000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self-&gt;unloaded_singletons ]);</td></tr>
<tr><td class="h">396</td><td><div class="c3">693</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">397</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">398</td><td colspan="7"></td></tr><tr><td class="h">399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># when was this comment left?</td></tr>
<tr><td class="h">400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unixtime {</td></tr>
<tr><td class="h">401</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L401">3</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">402</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self-&gt;unloaded_singletons ]);</td></tr>
<tr><td class="h">403</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::mysqldate_to_time($self-&gt;{datepost}, 0);</td></tr>
<tr><td class="h">404</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">405</td><td colspan="7"></td></tr><tr><td class="h">406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns LJ::User object for the poster of this entry, or undef for anonymous</td></tr>
<tr><td class="h">407</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub poster {</td></tr>
<tr><td class="h">408</td><td><div class="c3">654</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L408">654</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">409</td><td><div class="c3">654</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::load_userid($self-&gt;posterid);</td></tr>
<tr><td class="h">410</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">411</td><td colspan="7"></td></tr><tr><td class="h">412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub posterid {</td></tr>
<tr><td class="h">413</td><td><div class="c3">654</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L413">654</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">414</td><td><div class="c3">654</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self-&gt;unloaded_singletons ]);</td></tr>
<tr><td class="h">415</td><td><div class="c3">654</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{posterid};</td></tr>
<tr><td class="h">416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">417</td><td colspan="7"></td></tr><tr><td class="h">418</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub all_singletons {</td></tr>
<tr><td class="h">419</td><td><div class="c3">1456</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L419">1456</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">420</td><td><div class="c3">1456</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @singletons;</td></tr>
<tr><td class="h">421</td><td><div class="c3">1456</div><div class="c3">1456</div><div class="c3">1456</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>8000</div><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @singletons, values %{$singletons{$_}} foreach keys %singletons;</td></tr>
<tr><td class="h">422</td><td><div class="c3">1456</div></td><td></td><td></td><td></td><td></td><td><div>20002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @singletons;</td></tr>
<tr><td class="h">423</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">424</td><td colspan="7"></td></tr><tr><td class="h">425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns an array of unloaded comment singletons</td></tr>
<tr><td class="h">426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unloaded_singletons {</td></tr>
<tr><td class="h">427</td><td><div class="c3">1372</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L427">1372</a></div></td><td><div class="c0">0</div></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">428</td><td><div class="c3">1372</div><div class="c3">45093</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>216010</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return grep { ! $_-&gt;{_loaded_row} } $self-&gt;all_singletons;</td></tr>
<tr><td class="h">429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">430</td><td colspan="7"></td></tr><tr><td class="h">431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns an array of comment singletons which don&#39;t have text loaded yet</td></tr>
<tr><td class="h">432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unloaded_text_singletons {</td></tr>
<tr><td class="h">433</td><td><div class="c3">24</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L433">24</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">434</td><td><div class="c3">24</div><div class="c3">1050</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return grep { ! $_-&gt;{_loaded_text} } $self-&gt;all_singletons;</td></tr>
<tr><td class="h">435</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">436</td><td colspan="7"></td></tr><tr><td class="h">437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns an array of comment singletons which don&#39;t have prop rows loaded yet</td></tr>
<tr><td class="h">438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unloaded_prop_singletons {</td></tr>
<tr><td class="h">439</td><td><div class="c3">48</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L439">48</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">440</td><td><div class="c3">48</div><div class="c3">701</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return grep { ! $_-&gt;{_loaded_props} } $self-&gt;all_singletons;</td></tr>
<tr><td class="h">441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">442</td><td colspan="7"></td></tr><tr><td class="h">443</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method:</td></tr>
<tr><td class="h">444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub preload_rows {</td></tr>
<tr><td class="h">445</td><td><div class="c3">1372</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L445">1372</a></div></td><td><div class="c0">0</div></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $obj_list) = @_;</td></tr>
<tr><td class="h">446</td><td colspan="7"></td></tr><tr><td class="h">447</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @to_load =</td></tr>
<tr><td class="h">448</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(map  { [ $_-&gt;journal, $_-&gt;jtalkid ] }</td></tr>
<tr><td class="h">449</td><td><div class="c3">1372</div></td><td></td><td></td><td></td><td></td><td><div>12003</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { ! $_-&gt;{_loaded_row} } @$obj_list);</td></tr>
<tr><td class="h">450</td><td colspan="7"></td></tr><tr><td class="h">451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# already loaded?</td></tr>
<tr><td class="h">452</td><td><div class="c3">1372</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L452">100</a></div></td><td></td><td></td><td></td><td><div>24001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless @to_load;</td></tr>
<tr><td class="h">453</td><td colspan="7"></td></tr><tr><td class="h">454</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# args: ([ journalid, jtalkid ], ...)</td></tr>
<tr><td class="h">455</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @rows = LJ::Talk::get_talk2_row_multi(@to_load);</td></tr>
<tr><td class="h">456</td><td colspan="7"></td></tr><tr><td class="h">457</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make a mapping of journalid-jtalkid =&gt; $row</td></tr>
<tr><td class="h">458</td><td><div class="c3">233</div><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %row_map = map { join(&quot;-&quot;, $_-&gt;{journalid}, $_-&gt;{jtalkid}) =&gt; $_ } @rows;</td></tr>
<tr><td class="h">459</td><td colspan="7"></td></tr><tr><td class="h">460</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>8002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $obj (@$obj_list) {</td></tr>
<tr><td class="h">461</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = $obj-&gt;journal;</td></tr>
<tr><td class="h">462</td><td colspan="7"></td></tr><tr><td class="h">463</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $row = $row_map{join(&quot;-&quot;, $u-&gt;id, $obj-&gt;jtalkid)};</td></tr>
<tr><td class="h">464</td><td><div class="c3">236</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L464">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $row;</td></tr>
<tr><td class="h">465</td><td colspan="7"></td></tr><tr><td class="h">466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# absorb row into the given LJ::Comment object</td></tr>
<tr><td class="h">467</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$obj-&gt;absorb_row(%$row);</td></tr>
<tr><td class="h">468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">469</td><td colspan="7"></td></tr><tr><td class="h">470</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">472</td><td colspan="7"></td></tr><tr><td class="h">473</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns true if loaded, zero if not.</td></tr>
<tr><td class="h">474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># also sets _loaded_text and subject and event.</td></tr>
<tr><td class="h">475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _load_text {</td></tr>
<tr><td class="h">476</td><td><div class="c3">24</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L476">24</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">477</td><td><div class="c3">24</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L477">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">478</td><td colspan="7"></td></tr><tr><td class="h">479</td><td><div class="c3">24</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry  = $self-&gt;entry;</td></tr>
<tr><td class="h">480</td><td><div class="c3">24</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entryu = $entry-&gt;journal;</td></tr>
<tr><td class="h">481</td><td><div class="c3">24</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry_uid = $entryu-&gt;id;</td></tr>
<tr><td class="h">482</td><td colspan="7"></td></tr><tr><td class="h">483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# find singletons which don&#39;t already have text loaded</td></tr>
<tr><td class="h">484</td><td><div class="c3">24</div><div class="c3">219</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @to_load = grep { $_-&gt;journalid == $entry_uid } $self-&gt;unloaded_text_singletons;</td></tr>
<tr><td class="h">485</td><td colspan="7"></td></tr><tr><td class="h">486</td><td><div class="c3">24</div><div class="c3">219</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret  = LJ::get_talktext2($entryu, map { $_-&gt;jtalkid } @to_load);</td></tr>
<tr><td class="h">487</td><td><div class="c3">24</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L487">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L487">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $ret &amp;&amp; ref $ret;</td></tr>
<tr><td class="h">488</td><td colspan="7"></td></tr><tr><td class="h">489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# iterate over comment objects we retrieved and set their subject/body/loaded members</td></tr>
<tr><td class="h">490</td><td><div class="c3">24</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $c_obj (@to_load) {</td></tr>
<tr><td class="h">491</td><td><div class="c3">219</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tt = $ret-&gt;{$c_obj-&gt;jtalkid};</td></tr>
<tr><td class="h">492</td><td><div class="c3">219</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L492">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L492">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless ($tt &amp;&amp; ref $tt);</td></tr>
<tr><td class="h">493</td><td colspan="7"></td></tr><tr><td class="h">494</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# raw subject and body</td></tr>
<tr><td class="h">495</td><td><div class="c3">219</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$c_obj-&gt;{subject} = $tt-&gt;[0];</td></tr>
<tr><td class="h">496</td><td><div class="c3">219</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$c_obj-&gt;{body}    = $tt-&gt;[1];</td></tr>
<tr><td class="h">497</td><td colspan="7"></td></tr><tr><td class="h">498</td><td><div class="c3">219</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L498">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($c_obj-&gt;prop(&quot;unknown8bit&quot;)) {</td></tr>
<tr><td class="h">499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# save the old ones away, so we can get back at them if we really need to</td></tr>
<tr><td class="h">500</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$c_obj-&gt;{subject_orig} = $c_obj-&gt;{subject};</td></tr>
<tr><td class="h">501</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$c_obj-&gt;{body_orig}    = $c_obj-&gt;{body};</td></tr>
<tr><td class="h">502</td><td colspan="7"></td></tr><tr><td class="h">503</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: really convert all the props?  what if we binary-pack some in the future?</td></tr>
<tr><td class="h">504</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::item_toutf8($c_obj-&gt;journal, \$c_obj-&gt;{subject}, \$c_obj-&gt;{body}, $c_obj-&gt;{props});</td></tr>
<tr><td class="h">505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">506</td><td colspan="7"></td></tr><tr><td class="h">507</td><td><div class="c3">219</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$c_obj-&gt;{_loaded_text} = 1;</td></tr>
<tr><td class="h">508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">509</td><td colspan="7"></td></tr><tr><td class="h">510</td><td><div class="c3">24</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">511</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">512</td><td colspan="7"></td></tr><tr><td class="h">513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _set_text {</td></tr>
<tr><td class="h">514</td><td><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L514">15</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, %opts) = @_;</td></tr>
<tr><td class="h">515</td><td colspan="7"></td></tr><tr><td class="h">516</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jtalkid = $self-&gt;jtalkid;</td></tr>
<tr><td class="h">517</td><td><div class="c3">15</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L517">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;can&#39;t set text on unsaved comment&quot;</td></tr>
<tr><td class="h">518</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $jtalkid;</td></tr>
<tr><td class="h">519</td><td colspan="7"></td></tr><tr><td class="h">520</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %doing      = ();</td></tr>
<tr><td class="h">521</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %original   = ();</td></tr>
<tr><td class="h">522</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %compressed = ();</td></tr>
<tr><td class="h">523</td><td colspan="7"></td></tr><tr><td class="h">524</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $part (qw(subject body)) {</td></tr>
<tr><td class="h">525</td><td><div class="c3">30</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L525">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless exists $opts{$part};</td></tr>
<tr><td class="h">526</td><td colspan="7"></td></tr><tr><td class="h">527</td><td><div class="c3">21</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$original{$part} = delete $opts{$part};</td></tr>
<tr><td class="h">528</td><td><div class="c3">21</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L528">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;$part is not utf-8&quot; unless LJ::is_utf8($original{$part});</td></tr>
<tr><td class="h">529</td><td colspan="7"></td></tr><tr><td class="h">530</td><td><div class="c3">21</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$doing{$part}++;</td></tr>
<tr><td class="h">531</td><td><div class="c3">21</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$compressed{$part} = LJ::text_compress($original{$part});</td></tr>
<tr><td class="h">532</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">533</td><td colspan="7"></td></tr><tr><td class="h">534</td><td><div class="c3">15</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L534">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;must set either body or subject&quot; unless %doing;</td></tr>
<tr><td class="h">535</td><td colspan="7"></td></tr><tr><td class="h">536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if the comment is unknown8bit, then we must be setting both subject and body,</td></tr>
<tr><td class="h">537</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# else we&#39;ll have one side utf-8 and the other side unknown, but no metadata</td></tr>
<tr><td class="h">538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# capable of expressing &quot;subject is unknown8bit, but not body&quot;.</td></tr>
<tr><td class="h">539</td><td><div class="c3">15</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L539">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;prop(&#39;unknown8bit&#39;)) {</td></tr>
<tr><td class="h">540</td><td><div class="c3">6</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L540">100</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L540">67</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Can&#39;t set text on unknown8bit comments unless both subject and body are specified&quot;</td></tr>
<tr><td class="h">541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $doing{subject} &amp;&amp; $doing{body};</td></tr>
<tr><td class="h">542</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">543</td><td colspan="7"></td></tr><tr><td class="h">544</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalu  = $self-&gt;journal;</td></tr>
<tr><td class="h">545</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalid = $self-&gt;journalid;</td></tr>
<tr><td class="h">546</td><td colspan="7"></td></tr><tr><td class="h">547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# need to set new values in the database</td></tr>
<tr><td class="h">548</td><td><div class="c3">12</div><div class="c3">18</div><div class="c3">24</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $set_sql  = join(&quot;, &quot;, map { &quot;$_=?&quot; } grep { $doing{$_} } qw(subject body));</td></tr>
<tr><td class="h">549</td><td><div class="c3">12</div><div class="c3">18</div><div class="c3">24</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @set_vals = map { $compressed{$_} } grep { $doing{$_} } qw(subject body);</td></tr>
<tr><td class="h">550</td><td colspan="7"></td></tr><tr><td class="h">551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update is okay here because we verified we have a jtalkid, presumably from this table</td></tr>
<tr><td class="h">552</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# -- compressed versions of the text here</td></tr>
<tr><td class="h">553</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;do(&quot;UPDATE talktext2 SET $set_sql WHERE journalid=? AND jtalkid=?&quot;,</td></tr>
<tr><td class="h">554</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, @set_vals, $journalid, $jtalkid);</td></tr>
<tr><td class="h">555</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L555">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die $journalu-&gt;errstr if $journalu-&gt;err;</td></tr>
<tr><td class="h">556</td><td colspan="7"></td></tr><tr><td class="h">557</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# need to also update memcache</td></tr>
<tr><td class="h">558</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# -- uncompressed versions here</td></tr>
<tr><td class="h">559</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = join(&quot;:&quot;, $journalu-&gt;clusterid, $journalid, $jtalkid);</td></tr>
<tr><td class="h">560</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $part (qw(subject body)) {</td></tr>
<tr><td class="h">561</td><td><div class="c3">24</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L561">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $doing{$part};</td></tr>
<tr><td class="h">562</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$journalid, &quot;talk$part:$memkey&quot;], $original{$part});</td></tr>
<tr><td class="h">563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">564</td><td colspan="7"></td></tr><tr><td class="h">565</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# got this far in setting text, and we know we used to be unknown8bit, except the text</td></tr>
<tr><td class="h">566</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we just set was utf8, so clear the unknown8bit flag</td></tr>
<tr><td class="h">567</td><td><div class="c3">12</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L567">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;prop(&#39;unknown8bit&#39;)) {</td></tr>
<tr><td class="h">568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# set to 0 instead of delete so we can find these records later</td></tr>
<tr><td class="h">569</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;set_prop(&#39;unknown8bit&#39;, &#39;0&#39;);</td></tr>
<tr><td class="h">570</td><td colspan="7"></td></tr><tr><td class="h">571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">572</td><td colspan="7"></td></tr><tr><td class="h">573</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if text is already loaded, then we can just set whatever we&#39;ve modified in $self</td></tr>
<tr><td class="h">574</td><td><div class="c3">12</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L574">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--condition.html#L574">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($doing{subject} &amp;&amp; $doing{body}) {</td></tr>
<tr><td class="h">575</td><td><div class="c3">6</div><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{$_} = $original{$_} foreach qw(subject body);</td></tr>
<tr><td class="h">576</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{_loaded_text} = 1;</td></tr>
<tr><td class="h">577</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">578</td><td><div class="c3">6</div><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{$_} = undef foreach qw(subject body);</td></tr>
<tr><td class="h">579</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{_loaded_text} = 0;</td></tr>
<tr><td class="h">580</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# otherwise _loaded_text=0 and we won&#39;t do any optimizations</td></tr>
<tr><td class="h">582</td><td colspan="7"></td></tr><tr><td class="h">583</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">584</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">585</td><td colspan="7"></td></tr><tr><td class="h">586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_subject {</td></tr>
<tr><td class="h">587</td><td><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L587">6</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $text) = @_;</td></tr>
<tr><td class="h">588</td><td colspan="7"></td></tr><tr><td class="h">589</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;_set_text( subject =&gt; $text );</td></tr>
<tr><td class="h">590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">591</td><td colspan="7"></td></tr><tr><td class="h">592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_body {</td></tr>
<tr><td class="h">593</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L593">3</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $text) = @_;</td></tr>
<tr><td class="h">594</td><td colspan="7"></td></tr><tr><td class="h">595</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;_set_text( body =&gt; $text );</td></tr>
<tr><td class="h">596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">597</td><td colspan="7"></td></tr><tr><td class="h">598</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_subject_and_body {</td></tr>
<tr><td class="h">599</td><td><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L599">6</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $subject, $body) = @_;</td></tr>
<tr><td class="h">600</td><td colspan="7"></td></tr><tr><td class="h">601</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;_set_text( subject =&gt; $subject, body =&gt; $body );</td></tr>
<tr><td class="h">602</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">603</td><td colspan="7"></td></tr><tr><td class="h">604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub prop {</td></tr>
<tr><td class="h">605</td><td><div class="c3">303</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L605">303</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $prop) = @_;</td></tr>
<tr><td class="h">606</td><td><div class="c3">303</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L606">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_props unless $self-&gt;{_loaded_props};</td></tr>
<tr><td class="h">607</td><td><div class="c3">303</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{props}{$prop};</td></tr>
<tr><td class="h">608</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">609</td><td colspan="7"></td></tr><tr><td class="h">610</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_prop {</td></tr>
<tr><td class="h">611</td><td><div class="c3">153</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L611">153</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $prop, $val) = @_;</td></tr>
<tr><td class="h">612</td><td colspan="7"></td></tr><tr><td class="h">613</td><td><div class="c3">153</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;set_props($prop =&gt; $val);</td></tr>
<tr><td class="h">614</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">615</td><td colspan="7"></td></tr><tr><td class="h">616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># allows the caller to pass raw SQL to set a prop (e.g. UNIX_TIMESTAMP())</td></tr>
<tr><td class="h">617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># do not use this if setting a value given by the user</td></tr>
<tr><td class="h">618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_prop_raw {</td></tr>
<tr><td class="h">619</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L619">3</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $prop, $val) = @_;</td></tr>
<tr><td class="h">620</td><td colspan="7"></td></tr><tr><td class="h">621</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;set_props_raw($prop =&gt; $val);</td></tr>
<tr><td class="h">622</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">623</td><td colspan="7"></td></tr><tr><td class="h">624</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_prop {</td></tr>
<tr><td class="h">625</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L625">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $prop) = @_;</td></tr>
<tr><td class="h">626</td><td colspan="7"></td></tr><tr><td class="h">627</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;set_props($prop =&gt; undef);</td></tr>
<tr><td class="h">628</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">629</td><td colspan="7"></td></tr><tr><td class="h">630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub props {</td></tr>
<tr><td class="h">631</td><td><div class="c3">204</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L631">204</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $prop) = @_;</td></tr>
<tr><td class="h">632</td><td><div class="c3">204</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L632">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_props unless $self-&gt;{_loaded_props};</td></tr>
<tr><td class="h">633</td><td><div class="c3">204</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L633">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{props} || {};</td></tr>
<tr><td class="h">634</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">635</td><td colspan="7"></td></tr><tr><td class="h">636</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _load_props {</td></tr>
<tr><td class="h">637</td><td><div class="c3">48</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L637">48</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">638</td><td><div class="c3">48</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L638">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $self-&gt;{_loaded_props};</td></tr>
<tr><td class="h">639</td><td colspan="7"></td></tr><tr><td class="h">640</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# find singletons which don&#39;t already have text loaded</td></tr>
<tr><td class="h">641</td><td><div class="c3">48</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalid = $self-&gt;journalid;</td></tr>
<tr><td class="h">642</td><td><div class="c3">48</div><div class="c3">231</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @to_load = grep { $_-&gt;journalid == $journalid } $self-&gt;unloaded_prop_singletons;</td></tr>
<tr><td class="h">643</td><td colspan="7"></td></tr><tr><td class="h">644</td><td><div class="c3">48</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop_ret = {};</td></tr>
<tr><td class="h">645</td><td><div class="c3">48</div><div class="c3">231</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_talk_props2($journalid, [ map { $_-&gt;jtalkid } @to_load ], $prop_ret);</td></tr>
<tr><td class="h">646</td><td colspan="7"></td></tr><tr><td class="h">647</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# iterate over comment objects to load and fill in their props members</td></tr>
<tr><td class="h">648</td><td><div class="c3">48</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $c_obj (@to_load) {</td></tr>
<tr><td class="h">649</td><td><div class="c3">231</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--condition.html#L649">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$c_obj-&gt;{props} = $prop_ret-&gt;{$c_obj-&gt;jtalkid} || {};</td></tr>
<tr><td class="h">650</td><td><div class="c3">231</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$c_obj-&gt;{_loaded_props} = 1;</td></tr>
<tr><td class="h">651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">652</td><td colspan="7"></td></tr><tr><td class="h">653</td><td><div class="c3">48</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">654</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">655</td><td colspan="7"></td></tr><tr><td class="h">656</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_props {</td></tr>
<tr><td class="h">657</td><td><div class="c3">168</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L657">168</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, %props) = @_;</td></tr>
<tr><td class="h">658</td><td colspan="7"></td></tr><tr><td class="h">659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# call this so that get_prop() calls below will be cached</td></tr>
<tr><td class="h">660</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_props(&quot;talk&quot;);</td></tr>
<tr><td class="h">661</td><td colspan="7"></td></tr><tr><td class="h">662</td><td><div class="c3">168</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L662">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $set_raw = delete $props{_raw} ? 1 : 0;</td></tr>
<tr><td class="h">663</td><td colspan="7"></td></tr><tr><td class="h">664</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalid = $self-&gt;journalid;</td></tr>
<tr><td class="h">665</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalu  = $self-&gt;journal;</td></tr>
<tr><td class="h">666</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jtalkid   = $self-&gt;jtalkid;</td></tr>
<tr><td class="h">667</td><td colspan="7"></td></tr><tr><td class="h">668</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @vals = ();</td></tr>
<tr><td class="h">669</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @to_del = ();</td></tr>
<tr><td class="h">670</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %tprops = ();</td></tr>
<tr><td class="h">671</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @prop_vals = ();</td></tr>
<tr><td class="h">672</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $key (keys %props) {</td></tr>
<tr><td class="h">673</td><td><div class="c3">180</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;talk&quot;, $key);</td></tr>
<tr><td class="h">674</td><td><div class="c3">180</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L674">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $p;</td></tr>
<tr><td class="h">675</td><td colspan="7"></td></tr><tr><td class="h">676</td><td><div class="c3">180</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $val = $props{$key};</td></tr>
<tr><td class="h">677</td><td colspan="7"></td></tr><tr><td class="h">678</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# build lists for inserts and deletes, also update $self</td></tr>
<tr><td class="h">679</td><td><div class="c3">180</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L679">100</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $val) {</td></tr>
<tr><td class="h">680</td><td><div class="c3">168</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L680">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($set_raw) {</td></tr>
<tr><td class="h">681</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @vals, ($journalid, $jtalkid, $p-&gt;{tpropid});</td></tr>
<tr><td class="h">682</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @prop_vals, $val;</td></tr>
<tr><td class="h">683</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tprops{$p-&gt;{tpropid}} = $key;</td></tr>
<tr><td class="h">684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">685</td><td><div class="c3">159</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @vals, ($journalid, $jtalkid, $p-&gt;{tpropid}, $val);</td></tr>
<tr><td class="h">686</td><td><div class="c3">159</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{props}-&gt;{$key} = $props{$key};</td></tr>
<tr><td class="h">687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">689</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @to_del, $p-&gt;{tpropid};</td></tr>
<tr><td class="h">690</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $self-&gt;{props}-&gt;{$key};</td></tr>
<tr><td class="h">691</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">692</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">693</td><td colspan="7"></td></tr><tr><td class="h">694</td><td><div class="c3">168</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L694">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@vals) {</td></tr>
<tr><td class="h">695</td><td><div class="c3">162</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $bind;</td></tr>
<tr><td class="h">696</td><td><div class="c3">162</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L696">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($set_raw) {</td></tr>
<tr><td class="h">697</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @binds;</td></tr>
<tr><td class="h">698</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $prop_val (@prop_vals) {</td></tr>
<tr><td class="h">699</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @binds, &quot;(?,?,?,$prop_val)&quot;;</td></tr>
<tr><td class="h">700</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">701</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bind = join(&quot;,&quot;, @binds);</td></tr>
<tr><td class="h">702</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">703</td><td><div class="c3">156</div><div class="c3">159</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bind = join(&quot;,&quot;, map { &quot;(?,?,?,?)&quot; } 1..(@vals/4));</td></tr>
<tr><td class="h">704</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">705</td><td><div class="c3">162</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;do(&quot;REPLACE INTO talkprop2 (journalid, jtalkid, tpropid, value) &quot;.</td></tr>
<tr><td class="h">706</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES $bind&quot;, undef, @vals);</td></tr>
<tr><td class="h">707</td><td><div class="c3">162</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L707">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die $journalu-&gt;errstr if $journalu-&gt;err;</td></tr>
<tr><td class="h">708</td><td colspan="7"></td></tr><tr><td class="h">709</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get the raw prop values back out of the database to store on the object</td></tr>
<tr><td class="h">710</td><td><div class="c3">162</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L710">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($set_raw) {</td></tr>
<tr><td class="h">711</td><td><div class="c3">6</div><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $bind = join(&quot;,&quot;, map { &quot;?&quot; } keys %tprops);</td></tr>
<tr><td class="h">712</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $journalu-&gt;prepare(&quot;SELECT tpropid, value FROM talkprop2 WHERE journalid = ? AND jtalkid = ? AND tpropid IN ($bind)&quot;);</td></tr>
<tr><td class="h">713</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($journalid, $jtalkid, keys %tprops);</td></tr>
<tr><td class="h">714</td><td colspan="7"></td></tr><tr><td class="h">715</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my $row = $sth-&gt;fetchrow_hashref) {</td></tr>
<tr><td class="h">716</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tpropid = $row-&gt;{tpropid};</td></tr>
<tr><td class="h">717</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{props}-&gt;{$tprops{$tpropid}} = $row-&gt;{value};</td></tr>
<tr><td class="h">718</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">720</td><td colspan="7"></td></tr><tr><td class="h">721</td><td><div class="c3">162</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L721">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::_T_COMMENT_SET_PROPS_INSERT) {</td></tr>
<tr><td class="h">722</td><td><div class="c3">162</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::_T_COMMENT_SET_PROPS_INSERT-&gt;();</td></tr>
<tr><td class="h">723</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">724</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">725</td><td colspan="7"></td></tr><tr><td class="h">726</td><td><div class="c3">168</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L726">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@to_del) {</td></tr>
<tr><td class="h">727</td><td><div class="c3">9</div><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $bind = join(&quot;,&quot;, map { &quot;?&quot; } @to_del);</td></tr>
<tr><td class="h">728</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;do(&quot;DELETE FROM talkprop2 WHERE journalid=? AND jtalkid=? AND tpropid IN ($bind)&quot;,</td></tr>
<tr><td class="h">729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $journalid, $jtalkid, @to_del);</td></tr>
<tr><td class="h">730</td><td><div class="c3">9</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L730">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die $journalu-&gt;errstr if $journalu-&gt;err;</td></tr>
<tr><td class="h">731</td><td colspan="7"></td></tr><tr><td class="h">732</td><td><div class="c3">9</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L732">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::_T_COMMENT_SET_PROPS_DELETE) {</td></tr>
<tr><td class="h">733</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::_T_COMMENT_SET_PROPS_DELETE-&gt;();</td></tr>
<tr><td class="h">734</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">735</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">736</td><td colspan="7"></td></tr><tr><td class="h">737</td><td><div class="c3">168</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L737">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L737">67</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@vals || @to_del) {</td></tr>
<tr><td class="h">738</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete([$journalid, &quot;talkprop:$journalid:$jtalkid&quot;]);</td></tr>
<tr><td class="h">739</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">740</td><td colspan="7"></td></tr><tr><td class="h">741</td><td><div class="c3">168</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">743</td><td colspan="7"></td></tr><tr><td class="h">744</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_props_raw {</td></tr>
<tr><td class="h">745</td><td><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L745">6</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, %props) = @_;</td></tr>
<tr><td class="h">746</td><td colspan="7"></td></tr><tr><td class="h">747</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;set_props(%props, _raw =&gt; 1);</td></tr>
<tr><td class="h">748</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">749</td><td colspan="7"></td></tr><tr><td class="h">750</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># raw utf8 text, with no HTML cleaning</td></tr>
<tr><td class="h">751</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subject_raw {</td></tr>
<tr><td class="h">752</td><td><div class="c3">156</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L752">156</a></div></td><td><div class="c0">0</div></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">753</td><td><div class="c3">156</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L753">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text  unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">754</td><td><div class="c3">156</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{subject};</td></tr>
<tr><td class="h">755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">756</td><td colspan="7"></td></tr><tr><td class="h">757</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># raw text as user sent us, without transcoding while correcting for unknown8bit</td></tr>
<tr><td class="h">758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subject_orig {</td></tr>
<tr><td class="h">759</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L759">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">760</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L760">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">761</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L761">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{subject_orig} || $self-&gt;{subject};</td></tr>
<tr><td class="h">762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">763</td><td colspan="7"></td></tr><tr><td class="h">764</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># raw utf8 text, with no HTML cleaning</td></tr>
<tr><td class="h">765</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub body_raw {</td></tr>
<tr><td class="h">766</td><td><div class="c3">75</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L766">75</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">767</td><td><div class="c3">75</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L767">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">768</td><td colspan="7"></td></tr><tr><td class="h">769</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# die if we didn&#39;t load any body text</td></tr>
<tr><td class="h">770</td><td><div class="c3">75</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L770">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Couldn&#39;t load body text&quot; unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">771</td><td colspan="7"></td></tr><tr><td class="h">772</td><td><div class="c3">75</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{body};</td></tr>
<tr><td class="h">773</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">774</td><td colspan="7"></td></tr><tr><td class="h">775</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># raw text as user sent us, without transcoding while correcting for unknown8bit</td></tr>
<tr><td class="h">776</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub body_orig {</td></tr>
<tr><td class="h">777</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L777">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">778</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L778">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">779</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L779">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{body_orig} || $self-&gt;{body};</td></tr>
<tr><td class="h">780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">781</td><td colspan="7"></td></tr><tr><td class="h">782</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># comment body, cleaned</td></tr>
<tr><td class="h">783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub body_html {</td></tr>
<tr><td class="h">784</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L784">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">785</td><td colspan="7"></td></tr><tr><td class="h">786</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts;</td></tr>
<tr><td class="h">787</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{preformatted} = $self-&gt;prop(&quot;opt_preformatted&quot;);</td></tr>
<tr><td class="h">788</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L788">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{anon_comment} = $self-&gt;poster ? 0 : 1;</td></tr>
<tr><td class="h">789</td><td colspan="7"></td></tr><tr><td class="h">790</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $body = $self-&gt;body_raw;</td></tr>
<tr><td class="h">791</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L791">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_comment(\$body, $opts) if $body;</td></tr>
<tr><td class="h">792</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $body;</td></tr>
<tr><td class="h">793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">794</td><td colspan="7"></td></tr><tr><td class="h">795</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># comement body, but trimmed to $char_max</td></tr>
<tr><td class="h">796</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub body_html_summary {</td></tr>
<tr><td class="h">797</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L797">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $self, $char_max ) = @_;</td></tr>
<tr><td class="h">798</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::html_trim( $self-&gt;body_html, $char_max );</td></tr>
<tr><td class="h">799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">800</td><td colspan="7"></td></tr><tr><td class="h">801</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># comment body, plaintext</td></tr>
<tr><td class="h">802</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub body_text {</td></tr>
<tr><td class="h">803</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L803">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">804</td><td colspan="7"></td></tr><tr><td class="h">805</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $body = $self-&gt;body_html;</td></tr>
<tr><td class="h">806</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::strip_html($body);</td></tr>
<tr><td class="h">807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">808</td><td colspan="7"></td></tr><tr><td class="h">809</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subject_html {</td></tr>
<tr><td class="h">810</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L810">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">811</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L811">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">812</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::ehtml($self-&gt;{subject});</td></tr>
<tr><td class="h">813</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">814</td><td colspan="7"></td></tr><tr><td class="h">815</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subject_text {</td></tr>
<tr><td class="h">816</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L816">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">817</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $subject = $self-&gt;subject_raw;</td></tr>
<tr><td class="h">818</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::ehtml($subject);</td></tr>
<tr><td class="h">819</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">820</td><td colspan="7"></td></tr><tr><td class="h">821</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub state {</td></tr>
<tr><td class="h">822</td><td><div class="c3">22</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L822">22</a></div></td><td><div class="c0">0</div></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">823</td><td><div class="c3">22</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self-&gt;unloaded_singletons] );</td></tr>
<tr><td class="h">824</td><td><div class="c3">22</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{state};</td></tr>
<tr><td class="h">825</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">826</td><td colspan="7"></td></tr><tr><td class="h">827</td><td colspan="7"></td></tr><tr><td class="h">828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_active {</td></tr>
<tr><td class="h">829</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L829">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">830</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L830">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;state eq &#39;A&#39; ? 1 : 0;</td></tr>
<tr><td class="h">831</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">832</td><td colspan="7"></td></tr><tr><td class="h">833</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_screened {</td></tr>
<tr><td class="h">834</td><td><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L834">4</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">835</td><td><div class="c3">4</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L835">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;state eq &#39;S&#39; ? 1 : 0;</td></tr>
<tr><td class="h">836</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">837</td><td colspan="7"></td></tr><tr><td class="h">838</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_deleted {</td></tr>
<tr><td class="h">839</td><td><div class="c3">13</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L839">13</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">840</td><td><div class="c3">13</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L840">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;state eq &#39;D&#39; ? 1 : 0;</td></tr>
<tr><td class="h">841</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">842</td><td colspan="7"></td></tr><tr><td class="h">843</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_frozen {</td></tr>
<tr><td class="h">844</td><td><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L844">4</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">845</td><td><div class="c3">4</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Comment-pm--branch.html#L845">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;state eq &#39;F&#39; ? 1 : 0;</td></tr>
<tr><td class="h">846</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">847</td><td colspan="7"></td></tr><tr><td class="h">848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub visible_to {</td></tr>
<tr><td class="h">849</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L849">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $u) = @_;</td></tr>
<tr><td class="h">850</td><td colspan="7"></td></tr><tr><td class="h">851</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L851">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L851">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $self-&gt;entry &amp;&amp; $self-&gt;entry-&gt;visible_to($u);</td></tr>
<tr><td class="h">852</td><td colspan="7"></td></tr><tr><td class="h">853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# screened comment</td></tr>
<tr><td class="h">854</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L854">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L854">0</a></div><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L854">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $self-&gt;is_screened &amp;&amp;</td></tr>
<tr><td class="h">855</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!( LJ::can_manage($u, $self-&gt;journal)           # owns the journal</td></tr>
<tr><td class="h">856</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| LJ::u_equals($u, $self-&gt;poster)           # posted the comment</td></tr>
<tr><td class="h">857</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| LJ::u_equals($u, $self-&gt;entry-&gt;poster )); # posted the entry</td></tr>
<tr><td class="h">858</td><td colspan="7"></td></tr><tr><td class="h">859</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# comments from suspended users aren&#39;t visible</td></tr>
<tr><td class="h">860</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L860">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L860">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $self-&gt;poster &amp;&amp; $self-&gt;poster-&gt;is_suspended;</td></tr>
<tr><td class="h">861</td><td colspan="7"></td></tr><tr><td class="h">862</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">864</td><td colspan="7"></td></tr><tr><td class="h">865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub remote_can_delete {</td></tr>
<tr><td class="h">866</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L866">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">867</td><td colspan="7"></td></tr><tr><td class="h">868</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::User-&gt;remote;</td></tr>
<tr><td class="h">869</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;user_can_delete($remote);</td></tr>
<tr><td class="h">870</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">871</td><td colspan="7"></td></tr><tr><td class="h">872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub user_can_delete {</td></tr>
<tr><td class="h">873</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L873">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">874</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $targetu = shift;</td></tr>
<tr><td class="h">875</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L875">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::isu($targetu);</td></tr>
<tr><td class="h">876</td><td colspan="7"></td></tr><tr><td class="h">877</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalu = $self-&gt;journal;</td></tr>
<tr><td class="h">878</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posteru  = $self-&gt;poster;</td></tr>
<tr><td class="h">879</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L879">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $poster   = $posteru ? $posteru-&gt;{user} : undef;</td></tr>
<tr><td class="h">880</td><td colspan="7"></td></tr><tr><td class="h">881</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::can_delete($targetu, $journalu, $posteru, $poster);</td></tr>
<tr><td class="h">882</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">883</td><td colspan="7"></td></tr><tr><td class="h">884</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub remote_can_edit {</td></tr>
<tr><td class="h">885</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L885">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">886</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $errref = shift;</td></tr>
<tr><td class="h">887</td><td colspan="7"></td></tr><tr><td class="h">888</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">889</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;user_can_edit($remote, $errref);</td></tr>
<tr><td class="h">890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">891</td><td colspan="7"></td></tr><tr><td class="h">892</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub user_can_edit {</td></tr>
<tr><td class="h">893</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L893">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">894</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">895</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $errref = shift;</td></tr>
<tr><td class="h">896</td><td colspan="7"></td></tr><tr><td class="h">897</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L897">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u;</td></tr>
<tr><td class="h">898</td><td colspan="7"></td></tr><tr><td class="h">899</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit.invalid&#39;);</td></tr>
<tr><td class="h">900</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L900">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L900">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $self &amp;&amp; $self-&gt;valid;</td></tr>
<tr><td class="h">901</td><td colspan="7"></td></tr><tr><td class="h">902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# comment editing must be enabled and the user must have the cap</td></tr>
<tr><td class="h">903</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit&#39;);</td></tr>
<tr><td class="h">904</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L904">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::is_enabled(&quot;edit_comments&quot;);</td></tr>
<tr><td class="h">905</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L905">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;get_cap(&quot;edit_comments&quot;);</td></tr>
<tr><td class="h">906</td><td colspan="7"></td></tr><tr><td class="h">907</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# entry cannot be suspended</td></tr>
<tr><td class="h">908</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L908">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $self-&gt;entry-&gt;is_suspended;</td></tr>
<tr><td class="h">909</td><td colspan="7"></td></tr><tr><td class="h">910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user must be the poster of the comment</td></tr>
<tr><td class="h">911</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L911">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($u-&gt;equals($self-&gt;poster)) {</td></tr>
<tr><td class="h">912</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit.notyours&#39;);</td></tr>
<tr><td class="h">913</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">914</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">915</td><td colspan="7"></td></tr><tr><td class="h">916</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user cannot be read-only</td></tr>
<tr><td class="h">917</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L917">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;is_readonly;</td></tr>
<tr><td class="h">918</td><td colspan="7"></td></tr><tr><td class="h">919</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journal = $self-&gt;journal;</td></tr>
<tr><td class="h">920</td><td colspan="7"></td></tr><tr><td class="h">921</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# journal owner must have commenting enabled</td></tr>
<tr><td class="h">922</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L922">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journal-&gt;prop(&#39;opt_showtalklinks&#39;) eq &quot;N&quot;) {</td></tr>
<tr><td class="h">923</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit.commentingdisabled&#39;);</td></tr>
<tr><td class="h">924</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">925</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">926</td><td colspan="7"></td></tr><tr><td class="h">927</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user cannot be banned from commenting</td></tr>
<tr><td class="h">928</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L928">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journal-&gt;has_banned($u)) {</td></tr>
<tr><td class="h">929</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit.banned&#39;);</td></tr>
<tr><td class="h">930</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">931</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">932</td><td colspan="7"></td></tr><tr><td class="h">933</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user must be a friend if friends-only commenting is on</td></tr>
<tr><td class="h">934</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L934">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L934">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journal-&gt;prop(&#39;opt_whocanreply&#39;) eq &quot;friends&quot; &amp;&amp; !$journal-&gt;trusts_or_has_member( $u )) {</td></tr>
<tr><td class="h">935</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit.notfriend&#39;);</td></tr>
<tr><td class="h">936</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">937</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">938</td><td colspan="7"></td></tr><tr><td class="h">939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# comment cannot have any replies; deleted comments don&#39;t count</td></tr>
<tr><td class="h">940</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L940">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;has_nondeleted_children) {</td></tr>
<tr><td class="h">941</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit.haschildren&#39;);</td></tr>
<tr><td class="h">942</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">944</td><td colspan="7"></td></tr><tr><td class="h">945</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# comment cannot be deleted</td></tr>
<tr><td class="h">946</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L946">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;is_deleted) {</td></tr>
<tr><td class="h">947</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit.isdeleted&#39;);</td></tr>
<tr><td class="h">948</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">949</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">950</td><td colspan="7"></td></tr><tr><td class="h">951</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# comment cannot be frozen</td></tr>
<tr><td class="h">952</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L952">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;is_frozen) {</td></tr>
<tr><td class="h">953</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit.isfrozen&#39;);</td></tr>
<tr><td class="h">954</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">955</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">956</td><td colspan="7"></td></tr><tr><td class="h">957</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# comment must be visible to the user</td></tr>
<tr><td class="h">958</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L958">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($self-&gt;visible_to($u)) {</td></tr>
<tr><td class="h">959</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml(&#39;talk.error.cantedit.notvisible&#39;);</td></tr>
<tr><td class="h">960</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">961</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">962</td><td colspan="7"></td></tr><tr><td class="h">963</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$errref = &quot;&quot;;</td></tr>
<tr><td class="h">964</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">965</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">966</td><td colspan="7"></td></tr><tr><td class="h">967</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mark_as_spam {</td></tr>
<tr><td class="h">968</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L968">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">969</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::mark_comment_as_spam($self-&gt;poster, $self-&gt;jtalkid)</td></tr>
<tr><td class="h">970</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">971</td><td colspan="7"></td></tr><tr><td class="h">972</td><td colspan="7"></td></tr><tr><td class="h">973</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns comment action buttons (screen, freeze, delete, etc...)</td></tr>
<tr><td class="h">974</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub manage_buttons {</td></tr>
<tr><td class="h">975</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L975">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">976</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dtalkid = $self-&gt;dtalkid;</td></tr>
<tr><td class="h">977</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journal = $self-&gt;journal;</td></tr>
<tr><td class="h">978</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jargent = &quot;journal=$journal-&gt;{&#39;user&#39;}&amp;amp;&quot;;</td></tr>
<tr><td class="h">979</td><td colspan="7"></td></tr><tr><td class="h">980</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L980">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote() or return &#39;&#39;;</td></tr>
<tr><td class="h">981</td><td colspan="7"></td></tr><tr><td class="h">982</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $managebtns = &#39;&#39;;</td></tr>
<tr><td class="h">983</td><td colspan="7"></td></tr><tr><td class="h">984</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L984">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39; unless $self-&gt;entry-&gt;poster;</td></tr>
<tr><td class="h">985</td><td colspan="7"></td></tr><tr><td class="h">986</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L986">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $poster = $self-&gt;poster ? $self-&gt;poster-&gt;user : &quot;&quot;;</td></tr>
<tr><td class="h">987</td><td colspan="7"></td></tr><tr><td class="h">988</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L988">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;remote_can_edit) {</td></tr>
<tr><td class="h">989</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$managebtns .= &quot;&lt;a href=&#39;&quot; . $self-&gt;edit_url . &quot;&#39;&gt;&quot; . LJ::img(&quot;editcomment&quot;, &quot;&quot;, { &#39;align&#39; =&gt; &#39;absmiddle&#39;, &#39;hspace&#39; =&gt; 2, &#39;vspace&#39; =&gt; }) . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">991</td><td colspan="7"></td></tr><tr><td class="h">992</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L992">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::Talk::can_delete($remote, $self-&gt;journal, $self-&gt;entry-&gt;poster, $poster)) {</td></tr>
<tr><td class="h">993</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$managebtns .= &quot;&lt;a href=&#39;$LJ::SITEROOT/delcomment?${jargent}id=$dtalkid&#39;&gt;&quot; . LJ::img(&quot;btn_del&quot;, &quot;&quot;, { &#39;align&#39; =&gt; &#39;absmiddle&#39;, &#39;hspace&#39; =&gt; 2, &#39;vspace&#39; =&gt; }) . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">995</td><td colspan="7"></td></tr><tr><td class="h">996</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L996">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::Talk::can_freeze($remote, $self-&gt;journal, $self-&gt;entry-&gt;poster, $poster)) {</td></tr>
<tr><td class="h">997</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L997">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($self-&gt;is_frozen) {</td></tr>
<tr><td class="h">998</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$managebtns .= &quot;&lt;a href=&#39;$LJ::SITEROOT/talkscreen?mode=freeze&amp;amp;${jargent}talkid=$dtalkid&#39;&gt;&quot; . LJ::img(&quot;btn_freeze&quot;, &quot;&quot;, { align =&gt; &#39;absmiddle&#39;, hspace =&gt; 2, vspace =&gt; }) . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">999</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1000</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$managebtns .= &quot;&lt;a href=&#39;$LJ::SITEROOT/talkscreen?mode=unfreeze&amp;amp;${jargent}talkid=$dtalkid&#39;&gt;&quot; . LJ::img(&quot;btn_unfreeze&quot;, &quot;&quot;, { align =&gt; &#39;absmiddle&#39;, hspace =&gt; 2, vspace =&gt; }) . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">1001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1002</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1003</td><td colspan="7"></td></tr><tr><td class="h">1004</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1004">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::Talk::can_screen($remote, $self-&gt;journal, $self-&gt;entry-&gt;poster, $poster)) {</td></tr>
<tr><td class="h">1005</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1005">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($self-&gt;is_screened) {</td></tr>
<tr><td class="h">1006</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$managebtns .= &quot;&lt;a href=&#39;$LJ::SITEROOT/talkscreen?mode=screen&amp;amp;${jargent}talkid=$dtalkid&#39;&gt;&quot; . LJ::img(&quot;btn_scr&quot;, &quot;&quot;, { &#39;align&#39; =&gt; &#39;absmiddle&#39;, &#39;hspace&#39; =&gt; 2, &#39;vspace&#39; =&gt; }) . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">1007</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1008</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$managebtns .= &quot;&lt;a href=&#39;$LJ::SITEROOT/talkscreen?mode=unscreen&amp;amp;${jargent}talkid=$dtalkid&#39;&gt;&quot; . LJ::img(&quot;btn_unscr&quot;, &quot;&quot;, { &#39;align&#39; =&gt; &#39;absmiddle&#39;, &#39;hspace&#39; =&gt; 2, &#39;vspace&#39; =&gt; }) . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">1009</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1010</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1011</td><td colspan="7"></td></tr><tr><td class="h">1012</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $managebtns;</td></tr>
<tr><td class="h">1013</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1014</td><td colspan="7"></td></tr><tr><td class="h">1015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns info for javscript comment management</td></tr>
<tr><td class="h">1016</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub info {</td></tr>
<tr><td class="h">1017</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1017">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1018</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1018">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote() or return;</td></tr>
<tr><td class="h">1019</td><td colspan="7"></td></tr><tr><td class="h">1020</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %LJ_cmtinfo;</td></tr>
<tr><td class="h">1021</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ_cmtinfo{&#39;canAdmin&#39;} = LJ::can_manage($remote, $self-&gt;journal);</td></tr>
<tr><td class="h">1022</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ_cmtinfo{&#39;journal&#39;} = $self-&gt;journal-&gt;{user};</td></tr>
<tr><td class="h">1023</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ_cmtinfo{&#39;remote&#39;} = $remote-&gt;{user};</td></tr>
<tr><td class="h">1024</td><td colspan="7"></td></tr><tr><td class="h">1025</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \%LJ_cmtinfo;</td></tr>
<tr><td class="h">1026</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1027</td><td colspan="7"></td></tr><tr><td class="h">1028</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub indent {</td></tr>
<tr><td class="h">1029</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1029">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::Post::indent(@_);</td></tr>
<tr><td class="h">1030</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1031</td><td colspan="7"></td></tr><tr><td class="h">1032</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub blockquote {</td></tr>
<tr><td class="h">1033</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1033">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::Post::blockquote(@_);</td></tr>
<tr><td class="h">1034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1035</td><td colspan="7"></td></tr><tr><td class="h">1036</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># used for comment email notification headers</td></tr>
<tr><td class="h">1037</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub email_messageid {</td></tr>
<tr><td class="h">1038</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1038">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1039</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;&quot; . join(&quot;-&quot;, &quot;comment&quot;, $self-&gt;journal-&gt;id, $self-&gt;dtalkid) . &quot;\@$LJ::DOMAIN&gt;&quot;;</td></tr>
<tr><td class="h">1040</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1041</td><td colspan="7"></td></tr><tr><td class="h">1042</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">my @_ml_strings_en = (</td></tr>
<tr><td class="h">1043</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.subject&#39;,                                          # &#39;Subject:&#39;,</td></tr>
<tr><td class="h">1044</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.message&#39;,                                          # &#39;Message&#39;,</td></tr>
<tr><td class="h">1045</td><td colspan="7"></td></tr><tr><td class="h">1046</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.screened&#39;,                                                             # &#39;This comment was screened.&#39;,</td></tr>
<tr><td class="h">1047</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.you_must_unscreen&#39;,                                                    # &#39;You must respond to it or unscreen it before others can see it.&#39;,</td></tr>
<tr><td class="h">1048</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.someone_must_unscreen&#39;,                                                # &#39;Someone else must unscreen it before you can reply to it.&#39;,</td></tr>
<tr><td class="h">1049</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.here_you_can&#39;,                                                         # &#39;From here, you can:&#39;,</td></tr>
<tr><td class="h">1050</td><td colspan="7"></td></tr><tr><td class="h">1051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.view_thread&#39;,                                                          # &#39;[[openlink]]View the thread[[closelink]] starting from this comment&#39;,</td></tr>
<tr><td class="h">1052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.view_comments&#39;,                                                        # &#39;[[openlink]]View all comments[[closelink]] to this entry&#39;,</td></tr>
<tr><td class="h">1053</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.reply_at_webpage&#39;,                                                     # &#39;[[openlink]]Reply[[closelink]] at the webpage&#39;,</td></tr>
<tr><td class="h">1054</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.unscreen_comment&#39;,                                                     # &#39;[[openlink]]Unscreen the comment[[closelink]]&#39;,</td></tr>
<tr><td class="h">1055</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.delete_comment&#39;,                                                       # &#39;[[openlink]]Delete the comment[[closelink]]&#39;,</td></tr>
<tr><td class="h">1056</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.edit_comment&#39;,                                                         # &#39;[[openlink]]Edit the comment[[closelink]]&#39;,</td></tr>
<tr><td class="h">1057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.if_suport_form&#39;,                                                       # &#39;If your mail client supports it, you can also reply here:&#39;,</td></tr>
<tr><td class="h">1058</td><td colspan="7"></td></tr><tr><td class="h">1059</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.anonymous.comment&#39;,                                # &#39;Their reply was:&#39;,</td></tr>
<tr><td class="h">1060</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.anonymous.reply_to.anonymous_comment.to_your_post&#39;,# &#39;Somebody replied to another comment somebody left in [[openlink]]your LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.anonymous.reply_to.user_comment.to_your_post&#39;,     # &#39;Somebody replied to another comment [[pwho]] left in [[openlink]]your LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1062</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.anonymous.reply_to.your_comment.to_post&#39;,          # &#39;Somebody replied to another comment you left in [[openlink]]a LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1063</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.anonymous.reply_to.your_comment.to_your_post&#39;,     # &#39;Somebody replied to another comment you left in [[openlink]]your LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.anonymous.reply_to.your_post&#39;,                     # &#39;Somebody replied to [[openlink]]your LiveJournal post[[closelink]] in which you said:&#39;,</td></tr>
<tr><td class="h">1065</td><td colspan="7"></td></tr><tr><td class="h">1066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.comment&#39;,                                     # &#39;Their reply was:&#39;,</td></tr>
<tr><td class="h">1067</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.edit_reply_to.anonymous_comment.to_your_post&#39;,# &#39;[[who]] edited a reply to another comment somebody left in [[openlink]]your LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1068</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.edit_reply_to.user_comment.to_your_post&#39;,     # &#39;[[who]] edited a reply to another comment [[pwho]] left in [[openlink]]your LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1069</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.edit_reply_to.your_comment.to_post&#39;,          # &#39;[[who]] edited a reply to another comment you left in [[openlink]]a LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1070</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.edit_reply_to.your_comment.to_your_post&#39;,     # &#39;[[who]] edited a reply to another comment you left in [[openlink]]your LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1071</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.edit_reply_to.your_post&#39;,                     # &#39;[[who]] edited a reply to [[openlink]]your LiveJournal post[[closelink]] in which you said:&#39;,</td></tr>
<tr><td class="h">1072</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.new_comment&#39;,                                 # &#39;Their new reply was:&#39;,</td></tr>
<tr><td class="h">1073</td><td colspan="7"></td></tr><tr><td class="h">1074</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.reply_to.anonymous_comment.to_your_post&#39;,     # &#39;[[who]] replied to another comment somebody left in [[openlink]]your LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1075</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.reply_to.user_comment.to_your_post&#39;,          # &#39;[[who]] replied to another comment [[pwho]] left in [[openlink]]your LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1076</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.reply_to.your_comment.to_post&#39;,               # &#39;[[who]] replied to another comment you left in [[openlink]]a LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1077</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.reply_to.your_comment.to_your_post&#39;,          # &#39;[[who]] replied to another comment you left in [[openlink]]your LiveJournal post[[closelink]]. The comment they replied to was:&#39;,</td></tr>
<tr><td class="h">1078</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.user.reply_to.your_post&#39;,                          # &#39;[[who]] replied to [[openlink]]your LiveJournal post[[closelink]] in which you said:&#39;,</td></tr>
<tr><td class="h">1079</td><td colspan="7"></td></tr><tr><td class="h">1080</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.edit_reply_to.anonymous_comment.to_post&#39;,      # &#39;You edited a reply to another comment somebody left in [[openlink]]a LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.edit_reply_to.anonymous_comment.to_your_post&#39;, # &#39;You edited a reply to another comment somebody left in [[openlink]]your LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1082</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.edit_reply_to.post&#39;,                           # &#39;You edited a reply to [[openlink]]a LiveJournal post[[closelink]] in which [[pwho]] said:&#39;,</td></tr>
<tr><td class="h">1083</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.edit_reply_to.user_comment.to_post&#39;,           # &#39;You edited a reply to another comment [[pwho]] left in [[openlink]]a LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1084</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.edit_reply_to.user_comment.to_your_post&#39;,      # &#39;You edited a reply to another comment [[pwho]] left in [[openlink]]your LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1085</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.edit_reply_to.your_comment.to_post&#39;,           # &#39;You edited a reply to another comment you left in [[openlink]]a LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1086</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.edit_reply_to.your_comment.to_your_post&#39;,      # &#39;You edited a reply to another comment you left in [[openlink]]your LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1087</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.edit_reply_to.your_post&#39;,                      # &#39;You edited a reply to [[openlink]]your LiveJournal post[[closelink]] in which you said:&#39;,</td></tr>
<tr><td class="h">1088</td><td colspan="7"></td></tr><tr><td class="h">1089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.reply_to.anonymous_comment.to_post&#39;,           # &#39;You replied to another comment somebody left in [[openlink]]a LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1090</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.reply_to.anonymous_comment.to_your_post&#39;,      # &#39;You replied to another comment somebody left in [[openlink]]your LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1091</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.reply_to.post&#39;,                                # &#39;You replied to [[openlink]]a LiveJournal post[[closelink]] in which [[pwho]] said:&#39;,</td></tr>
<tr><td class="h">1092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.reply_to.user_comment.to_post&#39;,                # &#39;You replied to another comment [[pwho]] left in [[openlink]]a LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.reply_to.user_comment.to_your_post&#39;,           # &#39;You replied to another comment [[pwho]] left in [[openlink]]your LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1094</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.reply_to.your_comment.to_post&#39;,                # &#39;You replied to another comment you left in [[openlink]]a LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1095</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.reply_to.your_comment.to_your_post&#39;,           # &#39;You replied to another comment you left in [[openlink]]your LiveJournal post[[closelink]]. The comment you replied to was:&#39;,</td></tr>
<tr><td class="h">1096</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.you.reply_to.your_post&#39;,                           # &#39;You replied to [[openlink]]your LiveJournal post[[closelink]] in which you said:&#39;,</td></tr>
<tr><td class="h">1097</td><td colspan="7"></td></tr><tr><td class="h">1098</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.your.comment&#39;,                                     # &#39;Your reply was:&#39;,</td></tr>
<tr><td class="h">1099</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.journal_new_comment.your.new_comment&#39;,                                 # &#39;Your new reply was:&#39;,</td></tr>
<tr><td class="h">1100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">);</td></tr>
<tr><td class="h">1101</td><td colspan="7"></td></tr><tr><td class="h">1102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Implementation for both format_text_mail and format_html_mail.</td></tr>
<tr><td class="h">1103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _format_mail_both {</td></tr>
<tr><td class="h">1104</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1104">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1105</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $targetu = shift;</td></tr>
<tr><td class="h">1106</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $is_html = shift;</td></tr>
<tr><td class="h">1107</td><td colspan="7"></td></tr><tr><td class="h">1108</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parent  = $self-&gt;parent;</td></tr>
<tr><td class="h">1109</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry   = $self-&gt;entry;</td></tr>
<tr><td class="h">1110</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posteru = $self-&gt;poster;</td></tr>
<tr><td class="h">1111</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $edited  = $self-&gt;is_edited;</td></tr>
<tr><td class="h">1112</td><td colspan="7"></td></tr><tr><td class="h">1113</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $who = &#39;&#39;; # Empty means anonymous</td></tr>
<tr><td class="h">1114</td><td colspan="7"></td></tr><tr><td class="h">1115</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($k_who, $k_what, $k_reply_edit);</td></tr>
<tr><td class="h">1116</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1116">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($posteru) {</td></tr>
<tr><td class="h">1117</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1117">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($posteru-&gt;{name} eq $posteru-&gt;display_username) {</td></tr>
<tr><td class="h">1118</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1118">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($is_html) {</td></tr>
<tr><td class="h">1119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $profile_url = $posteru-&gt;profile_url;</td></tr>
<tr><td class="h">1120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$who = &quot; &lt;a href=\&quot;$profile_url\&quot;&gt;&quot; . $posteru-&gt;display_username . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">1121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1122</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$who = $posteru-&gt;display_username;</td></tr>
<tr><td class="h">1123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1124</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1125</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1125">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($is_html) {</td></tr>
<tr><td class="h">1126</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $profile_url = $posteru-&gt;profile_url;</td></tr>
<tr><td class="h">1127</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$who = LJ::ehtml($posteru-&gt;{name}) .</td></tr>
<tr><td class="h">1128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; (&lt;a href=\&quot;$profile_url\&quot;&gt;&quot; . $posteru-&gt;display_username . &quot;&lt;/a&gt;)&quot;;</td></tr>
<tr><td class="h">1129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1130</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$who = $posteru-&gt;{name} . &quot; (&quot; . $posteru-&gt;display_username . &quot;)&quot;;</td></tr>
<tr><td class="h">1131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1132</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1133</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1133">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::u_equals($targetu, $posteru)) {</td></tr>
<tr><td class="h">1134</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1134">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($edited) {</td></tr>
<tr><td class="h">1135</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;You edit your comment to...&#39;;</td></tr>
<tr><td class="h">1136</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_who = &#39;you.edit_reply_to&#39;;</td></tr>
<tr><td class="h">1137</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_reply_edit = &#39;your.new_comment&#39;;</td></tr>
<tr><td class="h">1138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;You replied to...&#39;</td></tr>
<tr><td class="h">1140</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_who = &#39;you.reply_to&#39;;</td></tr>
<tr><td class="h">1141</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_reply_edit = &#39;your.comment&#39;;</td></tr>
<tr><td class="h">1142</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1143</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1144</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1144">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($edited) {</td></tr>
<tr><td class="h">1145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;LJ-user &#39; . $posteru-&gt;{name} . &#39; edit reply to...&#39;;</td></tr>
<tr><td class="h">1146</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_who = &#39;user.edit_reply_to&#39;;</td></tr>
<tr><td class="h">1147</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_reply_edit = &#39;user.new_comment&#39;;</td></tr>
<tr><td class="h">1148</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;LJ-user &#39; . $posteru-&gt;{name} . &#39; replied to...&#39;;</td></tr>
<tr><td class="h">1150</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_who = &#39;user.reply_to&#39;;</td></tr>
<tr><td class="h">1151</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_reply_edit = &#39;user.comment&#39;;</td></tr>
<tr><td class="h">1152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1155</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;Somebody replied to&#39;;</td></tr>
<tr><td class="h">1156</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_who = &#39;anonymous.reply_to&#39;;</td></tr>
<tr><td class="h">1157</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_reply_edit = &#39;anonymous.comment&#39;;</td></tr>
<tr><td class="h">1158</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1159</td><td colspan="7"></td></tr><tr><td class="h">1160</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Parent post author. Empty string means &#39;You&#39;.</td></tr>
<tr><td class="h">1161</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parentu = $entry-&gt;journal;</td></tr>
<tr><td class="h">1162</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pwho = &#39;&#39;; #author of the commented post/comment. If empty - it&#39;s you or anonymous</td></tr>
<tr><td class="h">1163</td><td colspan="7"></td></tr><tr><td class="h">1164</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1164">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($is_html) {</td></tr>
<tr><td class="h">1165</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1165">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1165">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1165">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! $parent &amp;&amp; ! LJ::u_equals($parentu, $targetu)) {</td></tr>
<tr><td class="h">1166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# comment to a post and e-mail is going to be sent to not-AUTHOR of the journal</td></tr>
<tr><td class="h">1167</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p_profile_url = $entry-&gt;poster-&gt;profile_url;</td></tr>
<tr><td class="h">1168</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# pwho - author of the post</td></tr>
<tr><td class="h">1169</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# If the user&#39;s name hasn&#39;t been set (it&#39;s the same as display_username), then</td></tr>
<tr><td class="h">1170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t display both</td></tr>
<tr><td class="h">1171</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1171">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($entry-&gt;poster-&gt;{name} eq $entry-&gt;poster-&gt;display_username) {</td></tr>
<tr><td class="h">1172</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pwho = &quot;&lt;a href=\&quot;$p_profile_url\&quot;&gt;&quot; . $entry-&gt;poster-&gt;display_username . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">1173</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1174</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pwho = LJ::ehtml($entry-&gt;poster-&gt;{name}) .</td></tr>
<tr><td class="h">1175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; (&lt;a href=\&quot;$p_profile_url\&quot;&gt;&quot; . $entry-&gt;poster-&gt;display_username . &quot;&lt;/a&gt;)&quot;;</td></tr>
<tr><td class="h">1176</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1177</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($parent) {</td></tr>
<tr><td class="h">1178</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $threadu = $parent-&gt;poster;</td></tr>
<tr><td class="h">1179</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1179">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1179">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($threadu &amp;&amp; ! LJ::u_equals($threadu, $targetu)) {</td></tr>
<tr><td class="h">1180</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p_profile_url = $threadu-&gt;profile_url;</td></tr>
<tr><td class="h">1181</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1181">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($threadu-&gt;{name} eq $threadu-&gt;display_username) {</td></tr>
<tr><td class="h">1182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pwho = &quot;&lt;a href=\&quot;$p_profile_url\&quot;&gt;&quot; . $threadu-&gt;display_username . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">1183</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pwho = LJ::ehtml($threadu-&gt;{name}) .</td></tr>
<tr><td class="h">1185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; (&lt;a href=\&quot;$p_profile_url\&quot;&gt;&quot; . $threadu-&gt;display_username . &quot;&lt;/a&gt;)&quot;;</td></tr>
<tr><td class="h">1186</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1188</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1189</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1190</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1190">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1190">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1190">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! $parent &amp;&amp; ! LJ::u_equals($parentu, $targetu)) {</td></tr>
<tr><td class="h">1191</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1191">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($entry-&gt;poster-&gt;{name} eq $entry-&gt;poster-&gt;display_username) {</td></tr>
<tr><td class="h">1192</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pwho = $entry-&gt;poster-&gt;display_username;</td></tr>
<tr><td class="h">1193</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pwho = $entry-&gt;poster-&gt;{name} .</td></tr>
<tr><td class="h">1195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; (&quot; . $entry-&gt;poster-&gt;display_username . &quot;)&quot;;</td></tr>
<tr><td class="h">1196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1197</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($parent) {</td></tr>
<tr><td class="h">1198</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $threadu = $parent-&gt;poster;</td></tr>
<tr><td class="h">1199</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1199">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1199">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($threadu &amp;&amp; ! LJ::u_equals($threadu, $targetu)) {</td></tr>
<tr><td class="h">1200</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1200">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($threadu-&gt;{name} eq $threadu-&gt;display_username) {</td></tr>
<tr><td class="h">1201</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pwho = $threadu-&gt;display_username;</td></tr>
<tr><td class="h">1202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1203</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pwho = $threadu-&gt;{name} .</td></tr>
<tr><td class="h">1204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; (&quot; . $threadu-&gt;display_username . &quot;)&quot;;</td></tr>
<tr><td class="h">1205</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1206</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1208</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1209</td><td colspan="7"></td></tr><tr><td class="h">1210</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# ESN directed to comment poster</td></tr>
<tr><td class="h">1211</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1211">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1211">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::u_equals($targetu, $self-&gt;poster)) {</td></tr>
<tr><td class="h">1212</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# -&gt;parent returns undef/0 if parent is an entry.</td></tr>
<tr><td class="h">1213</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1213">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($parent) {</td></tr>
<tr><td class="h">1214</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1214">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($pwho) {</td></tr>
<tr><td class="h">1215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;... a comment &#39; . $pwho . &#39; left in post.&#39;;</td></tr>
<tr><td class="h">1216</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;user_comment&#39;;</td></tr>
<tr><td class="h">1217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;... a comment you left in post.&#39;;</td></tr>
<tr><td class="h">1219</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1219">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($parent-&gt;poster) {</td></tr>
<tr><td class="h">1220</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;your_comment&#39;;</td></tr>
<tr><td class="h">1221</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1222</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;anonymous_comment&#39;;</td></tr>
<tr><td class="h">1223</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1224</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1225</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1225">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::u_equals($targetu, $entry-&gt;journal)) {</td></tr>
<tr><td class="h">1226</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what .= &#39;.to_your_post&#39;;</td></tr>
<tr><td class="h">1227</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1228</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what .= &#39;.to_post&#39;;</td></tr>
<tr><td class="h">1229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1231</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1231">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($pwho) {</td></tr>
<tr><td class="h">1232</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;post&#39;;</td></tr>
<tr><td class="h">1233</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1234</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;your_post&#39;;</td></tr>
<tr><td class="h">1235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# ESN directed to entry author</td></tr>
<tr><td class="h">1238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif (LJ::u_equals($targetu, $entry-&gt;journal)) {</td></tr>
<tr><td class="h">1239</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1239">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($parent) {</td></tr>
<tr><td class="h">1240</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1240">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($pwho) {</td></tr>
<tr><td class="h">1241</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;... another comment &#39; . $pwho . &#39; left in your post.&#39;;</td></tr>
<tr><td class="h">1242</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;user_comment.to_your_post&#39;;</td></tr>
<tr><td class="h">1243</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1244</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1244">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($parent-&gt;poster) {</td></tr>
<tr><td class="h">1245</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;your_comment.to_your_post&#39;;</td></tr>
<tr><td class="h">1246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;... another comment you left in your post.&#39;;</td></tr>
<tr><td class="h">1248</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;anonymous_comment.to_your_post&#39;;</td></tr>
<tr><td class="h">1249</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1251</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1252</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;your_post&#39;;</td></tr>
<tr><td class="h">1253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# ESN directed to author parent comment or post</td></tr>
<tr><td class="h">1255</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1256</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1256">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($parent) {</td></tr>
<tr><td class="h">1257</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1257">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($parent-&gt;poster) {</td></tr>
<tr><td class="h">1258</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1258">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($pwho) {</td></tr>
<tr><td class="h">1259</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;user_comment.to_post&#39;;</td></tr>
<tr><td class="h">1260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1261</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</td></tr>
<tr><td class="h">1262</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;your_comment.to_post&#39;;</td></tr>
<tr><td class="h">1263</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;... another comment you left in your post.&#39;;</td></tr>
<tr><td class="h">1266</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;anonymous_comment.to_post&#39;;</td></tr>
<tr><td class="h">1267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1269</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1269">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($pwho) {</td></tr>
<tr><td class="h">1270</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;post&#39;;</td></tr>
<tr><td class="h">1271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</td></tr>
<tr><td class="h">1273</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k_what = &#39;your_post&#39;;</td></tr>
<tr><td class="h">1274</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1275</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1276</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1277</td><td colspan="7"></td></tr><tr><td class="h">1278</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $encoding = $targetu-&gt;mailencoding;</td></tr>
<tr><td class="h">1279</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1279">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $charset  = $encoding ? &quot;; charset=$encoding&quot; : &quot;&quot;;</td></tr>
<tr><td class="h">1280</td><td colspan="7"></td></tr><tr><td class="h">1281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Precache text lines</td></tr>
<tr><td class="h">1282</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lang     = $targetu-&gt;prop(&#39;browselang&#39;);</td></tr>
<tr><td class="h">1283</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Lang::get_text_multi($lang, undef, \@_ml_strings_en);</td></tr>
<tr><td class="h">1284</td><td colspan="7"></td></tr><tr><td class="h">1285</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $body = &#39;&#39;;</td></tr>
<tr><td class="h">1286</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1286">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$body = &quot;&lt;head&gt;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html$charset\&quot; /&gt;&lt;/head&gt;&lt;body&gt;&quot;</td></tr>
<tr><td class="h">1287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $is_html;</td></tr>
<tr><td class="h">1288</td><td colspan="7"></td></tr><tr><td class="h">1289</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $vars = {</td></tr>
<tr><td class="h">1290</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;who             =&gt; $who,</td></tr>
<tr><td class="h">1291</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pwho            =&gt; $pwho,</td></tr>
<tr><td class="h">1292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sitenameshort   =&gt; $LJ::SITENAMESHORT</td></tr>
<tr><td class="h">1293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1294</td><td colspan="7"></td></tr><tr><td class="h">1295</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make hyperlinks for post</td></tr>
<tr><td class="h">1296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $talkurl = $entry-&gt;url;</td></tr>
<tr><td class="h">1297</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1297">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($is_html) {</td></tr>
<tr><td class="h">1298</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$vars-&gt;{openlink}  = &quot;&lt;a href=\&quot;$talkurl\&quot;&gt;&quot;;</td></tr>
<tr><td class="h">1299</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$vars-&gt;{closelink} = &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">1300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1301</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$vars-&gt;{openlink}  = &#39;&#39;;</td></tr>
<tr><td class="h">1302</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$vars-&gt;{closelink} = &quot; ($talkurl)&quot;;</td></tr>
<tr><td class="h">1303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1304</td><td colspan="7"></td></tr><tr><td class="h">1305</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ml_prefix = &quot;esn.journal_new_comment.&quot;;</td></tr>
<tr><td class="h">1306</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$k_who = $ml_prefix . $k_who;</td></tr>
<tr><td class="h">1307</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$k_reply_edit = $ml_prefix . $k_reply_edit;</td></tr>
<tr><td class="h">1308</td><td colspan="7"></td></tr><tr><td class="h">1309</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $intro = LJ::Lang::get_text($lang, $k_who . &#39;.&#39; . $k_what, undef, $vars);</td></tr>
<tr><td class="h">1310</td><td colspan="7"></td></tr><tr><td class="h">1311</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1311">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($is_html) {</td></tr>
<tr><td class="h">1312</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pichtml;</td></tr>
<tr><td class="h">1313</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pic_kw = $self-&gt;prop(&#39;picture_keyword&#39;);</td></tr>
<tr><td class="h">1314</td><td colspan="7"></td></tr><tr><td class="h">1315</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1315">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1315">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($posteru &amp;&amp; $posteru-&gt;{defaultpicid} || $pic_kw) {</td></tr>
<tr><td class="h">1316</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1316">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pic = $pic_kw ? LJ::get_pic_from_keyword($posteru, $pic_kw) : undef;</td></tr>
<tr><td class="h">1317</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1317">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $picid = $pic ? $pic-&gt;{picid} : $posteru-&gt;{defaultpicid};</td></tr>
<tr><td class="h">1318</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1318">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($pic) {</td></tr>
<tr><td class="h">1319</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %pics;</td></tr>
<tr><td class="h">1320</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userpics(\%pics, [ $posteru, $posteru-&gt;{defaultpicid} ]);</td></tr>
<tr><td class="h">1321</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pic = $pics{$picid};</td></tr>
<tr><td class="h">1322</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# load_userpics doesn&#39;t return picid, but we rely on it above</td></tr>
<tr><td class="h">1323</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$picid = $picid;</td></tr>
<tr><td class="h">1324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1325</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1325">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($pic) {</td></tr>
<tr><td class="h">1326</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pichtml = &quot;&lt;img src=\&quot;$LJ::USERPIC_ROOT/$picid/$pic-&gt;{userid}\&quot; align=&#39;absmiddle&#39; &quot;.</td></tr>
<tr><td class="h">1327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;width=&#39;$pic-&gt;{width}&#39; height=&#39;$pic-&gt;{height}&#39; &quot;.</td></tr>
<tr><td class="h">1328</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;hspace=&#39;1&#39; vspace=&#39;2&#39; alt=&#39;&#39; /&gt; &quot;;</td></tr>
<tr><td class="h">1329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1331</td><td colspan="7"></td></tr><tr><td class="h">1332</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1332">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($pichtml) {</td></tr>
<tr><td class="h">1333</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;table&gt;&lt;tr valign=&#39;top&#39;&gt;&lt;td&gt;$pichtml&lt;/td&gt;&lt;td width=&#39;100%&#39;&gt;$intro&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;;</td></tr>
<tr><td class="h">1334</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1335</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;table&gt;&lt;tr valign=&#39;top&#39;&gt;&lt;td width=&#39;100%&#39;&gt;$intro&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;;</td></tr>
<tr><td class="h">1336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1337</td><td colspan="7"></td></tr><tr><td class="h">1338</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1338">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= blockquote($parent ? $parent-&gt;body_html : $entry-&gt;event_html);</td></tr>
<tr><td class="h">1339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1340</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1340">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= $intro . &quot;\n\n&quot; . indent($parent ? $parent-&gt;body_raw : $entry-&gt;event_raw, &quot;&gt;&quot;);</td></tr>
<tr><td class="h">1341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1342</td><td colspan="7"></td></tr><tr><td class="h">1343</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;\n\n&quot; . LJ::Lang::get_text($lang, $k_reply_edit, undef, $vars) . &quot;\n\n&quot;;</td></tr>
<tr><td class="h">1344</td><td colspan="7"></td></tr><tr><td class="h">1345</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1345">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($is_html) {</td></tr>
<tr><td class="h">1346</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pics = LJ::Talk::get_subjecticons();</td></tr>
<tr><td class="h">1347</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $icon = LJ::Talk::show_image($pics, $self-&gt;prop(&#39;subjecticon&#39;));</td></tr>
<tr><td class="h">1348</td><td colspan="7"></td></tr><tr><td class="h">1349</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $heading;</td></tr>
<tr><td class="h">1350</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1350">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;subject_raw) {</td></tr>
<tr><td class="h">1351</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$heading = &quot;&lt;b&gt;&quot; . LJ::Lang::get_text($lang, $ml_prefix . &#39;subject&#39;, undef) . &quot;&lt;/b&gt; &quot; . $self-&gt;subject_html;</td></tr>
<tr><td class="h">1352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1353</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$heading .= $icon;</td></tr>
<tr><td class="h">1354</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1354">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$heading .= &quot;&lt;br /&gt;&quot; if $heading;</td></tr>
<tr><td class="h">1355</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# this needs to be one string so blockquote handles it properly.</td></tr>
<tr><td class="h">1356</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= blockquote(&quot;$heading&quot; . $self-&gt;body_html);</td></tr>
<tr><td class="h">1357</td><td colspan="7"></td></tr><tr><td class="h">1358</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;br /&gt;&quot;;</td></tr>
<tr><td class="h">1359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1360</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1360">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $subj = $self-&gt;subject_raw) {</td></tr>
<tr><td class="h">1361</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= Text::Wrap::wrap(&quot; &quot; . LJ::Lang::get_text($lang, $ml_prefix . &#39;subject&#39;, undef) . &quot; &quot;, &quot;&quot;, $subj) . &quot;\n\n&quot;;</td></tr>
<tr><td class="h">1362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1363</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= indent($self-&gt;body_raw) . &quot;\n\n&quot;;</td></tr>
<tr><td class="h">1364</td><td colspan="7"></td></tr><tr><td class="h">1365</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Don&#39;t wrap options, only text.</td></tr>
<tr><td class="h">1366</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body = Text::Wrap::wrap(&quot;&quot;, &quot;&quot;, $body) . &quot;\n&quot;;</td></tr>
<tr><td class="h">1367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1368</td><td colspan="7"></td></tr><tr><td class="h">1369</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1369">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1369">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $can_unscreen = $self-&gt;is_screened &amp;&amp;</td></tr>
<tr><td class="h">1370</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::can_unscreen($targetu, $entry-&gt;journal, $entry-&gt;poster,</td></tr>
<tr><td class="h">1371</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$posteru ? $posteru-&gt;{user} : undef);</td></tr>
<tr><td class="h">1372</td><td colspan="7"></td></tr><tr><td class="h">1373</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1373">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;is_screened) {</td></tr>
<tr><td class="h">1374</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1374">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= LJ::Lang::get_text($lang, &#39;esn.screened&#39;, undef) .</td></tr>
<tr><td class="h">1375</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Lang::get_text($lang, $can_unscreen ? &#39;esn.you_must_unscreen&#39; : &#39;esn.someone_must_unscreen&#39;, undef) .</td></tr>
<tr><td class="h">1376</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\n&quot;;</td></tr>
<tr><td class="h">1377</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1378</td><td colspan="7"></td></tr><tr><td class="h">1379</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$body .= LJ::Lang::get_text($lang, &#39;esn.here_you_can&#39;, undef, $vars);</td></tr>
<tr><td class="h">1380</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1380">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1380">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1380">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$body .= LJ::Event::format_options(undef, $is_html, $lang, $vars,</td></tr>
<tr><td class="h">1381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1382</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.view_thread&#39;       =&gt; [ 1, $self-&gt;thread_url ],</td></tr>
<tr><td class="h">1383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.view_comments&#39;     =&gt; [ 2, $talkurl ],</td></tr>
<tr><td class="h">1384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.reply_at_webpage&#39;  =&gt; [ 3, $self-&gt;reply_url ],</td></tr>
<tr><td class="h">1385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.unscreen_comment&#39;  =&gt; [ $can_unscreen ? 4 : 0, $self-&gt;unscreen_url ],</td></tr>
<tr><td class="h">1386</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.delete_comment&#39;    =&gt; [ $self-&gt;user_can_delete($targetu) ? 5 : 0, $self-&gt;delete_url ],</td></tr>
<tr><td class="h">1387</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.edit_comment&#39;      =&gt; [ $self-&gt;user_can_edit($targetu) ? 6 : 0, $self-&gt;edit_url ],</td></tr>
<tr><td class="h">1388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">1389</td><td colspan="7"></td></tr><tr><td class="h">1390</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1390">0</a></div><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1390">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $want_form = $is_html &amp;&amp; ($self-&gt;is_active || $can_unscreen);  # this should probably be a preference, or maybe just always off.</td></tr>
<tr><td class="h">1391</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1391">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($want_form) {</td></tr>
<tr><td class="h">1392</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= LJ::Lang::get_text($lang, &#39;esn.if_suport_form&#39;, undef) . &quot;\n&quot;;</td></tr>
<tr><td class="h">1393</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;blockquote&gt;&lt;form method=&#39;post&#39; target=&#39;ljreply&#39; action=\&quot;$LJ::SITEROOT/talkpost_do\&quot;&gt;\n&quot;;</td></tr>
<tr><td class="h">1394</td><td colspan="7"></td></tr><tr><td class="h">1395</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= LJ::html_hidden</td></tr>
<tr><td class="h">1396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( usertype     =&gt;  &quot;user&quot;,</td></tr>
<tr><td class="h">1397</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parenttalkid =&gt;  $self-&gt;jtalkid,</td></tr>
<tr><td class="h">1398</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itemid       =&gt;  $entry-&gt;ditemid,</td></tr>
<tr><td class="h">1399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;journal      =&gt;  $entry-&gt;journal-&gt;{user},</td></tr>
<tr><td class="h">1400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userpost     =&gt;  $targetu-&gt;{user},</td></tr>
<tr><td class="h">1401</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecphash      =&gt;  LJ::Talk::ecphash($entry-&gt;jitemid, $self-&gt;jtalkid, $targetu-&gt;password)</td></tr>
<tr><td class="h">1402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1403</td><td colspan="7"></td></tr><tr><td class="h">1404</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1404">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;input type=&#39;hidden&#39; name=&#39;encoding&#39; value=&#39;$encoding&#39; /&gt;&quot; unless $encoding eq &quot;UTF-8&quot;;</td></tr>
<tr><td class="h">1405</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $newsub = $self-&gt;subject_html($targetu);</td></tr>
<tr><td class="h">1406</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1406">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1406">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless (!$newsub || $newsub =~ /^Re:/) { $newsub = &quot;Re: $newsub&quot;; }</td></tr>
<tr><td class="h">1407</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;b&gt;&quot;.LJ::Lang::get_text($lang, $ml_prefix . &#39;subject&#39;, undef).&quot;&lt;/b&gt; &lt;input name=&#39;subject&#39; size=&#39;40&#39; value=\&quot;&quot; . LJ::ehtml($newsub) . &quot;\&quot; /&gt;&quot;;</td></tr>
<tr><td class="h">1408</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;p&gt;&lt;b&gt;&quot;.LJ::Lang::get_text($lang, $ml_prefix . &#39;message&#39;, undef, $vars).&quot;&lt;/b&gt;&lt;br /&gt;&lt;textarea rows=&#39;10&#39; cols=&#39;50&#39; wrap=&#39;soft&#39; name=&#39;body&#39;&gt;&lt;/textarea&gt;&quot;;</td></tr>
<tr><td class="h">1409</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;br /&gt;&lt;input type=&#39;submit&#39; value=&#39;&quot; . LJ::Lang::get_text($lang, $ml_prefix . &#39;post_reply&#39;, undef) . &quot;&#39; /&gt;&quot;;</td></tr>
<tr><td class="h">1410</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;/form&gt;&lt;/blockquote&gt;\n&quot;;</td></tr>
<tr><td class="h">1411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1412</td><td colspan="7"></td></tr><tr><td class="h">1413</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1413">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$body .= &quot;&lt;/body&gt;\n&quot; if $is_html;</td></tr>
<tr><td class="h">1414</td><td colspan="7"></td></tr><tr><td class="h">1415</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $body;</td></tr>
<tr><td class="h">1416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1417</td><td colspan="7"></td></tr><tr><td class="h">1418</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub format_text_mail {</td></tr>
<tr><td class="h">1419</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1419">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1420</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $targetu = shift;</td></tr>
<tr><td class="h">1421</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1421">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid targetu passed to format_text_mail&quot;</td></tr>
<tr><td class="h">1422</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::isu($targetu);</td></tr>
<tr><td class="h">1423</td><td colspan="7"></td></tr><tr><td class="h">1424</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return _format_mail_both($self, $targetu, 0);</td></tr>
<tr><td class="h">1425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1426</td><td colspan="7"></td></tr><tr><td class="h">1427</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub format_html_mail {</td></tr>
<tr><td class="h">1428</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1428">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1429</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $targetu = shift;</td></tr>
<tr><td class="h">1430</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1430">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid targetu passed to format_html_mail&quot;</td></tr>
<tr><td class="h">1431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::isu($targetu);</td></tr>
<tr><td class="h">1432</td><td colspan="7"></td></tr><tr><td class="h">1433</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return _format_mail_both($self, $targetu, 1);</td></tr>
<tr><td class="h">1434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1435</td><td colspan="7"></td></tr><tr><td class="h">1436</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Collects common comment&#39;s props,</td></tr>
<tr><td class="h">1437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># and passes them into the given template</td></tr>
<tr><td class="h">1438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _format_template_mail {</td></tr>
<tr><td class="h">1439</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1439">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self    = shift;           # comment</td></tr>
<tr><td class="h">1440</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $targetu = shift;           # target user, who should be notified about the comment</td></tr>
<tr><td class="h">1441</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $t       = shift;           # LJ::HTML::Template object - template of the notification e-mail</td></tr>
<tr><td class="h">1442</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1442">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid targetu passed to format_template_mail&quot;</td></tr>
<tr><td class="h">1443</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::isu($targetu);</td></tr>
<tr><td class="h">1444</td><td colspan="7"></td></tr><tr><td class="h">1445</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1445">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parent  = $self-&gt;parent || $self-&gt;entry;</td></tr>
<tr><td class="h">1446</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry   = $self-&gt;entry;</td></tr>
<tr><td class="h">1447</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posteru = $self-&gt;poster;</td></tr>
<tr><td class="h">1448</td><td colspan="7"></td></tr><tr><td class="h">1449</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1449">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $encoding     = $targetu-&gt;mailencoding || &#39;UTF-8&#39;;</td></tr>
<tr><td class="h">1450</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1450">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1450">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $can_unscreen = $self-&gt;is_screened &amp;&amp;</td></tr>
<tr><td class="h">1451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::can_unscreen($targetu, $entry-&gt;journal, $entry-&gt;poster, $posteru ? $posteru-&gt;username : undef);</td></tr>
<tr><td class="h">1452</td><td colspan="7"></td></tr><tr><td class="h">1453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set template vars</td></tr>
<tr><td class="h">1454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(encoding =&gt; $encoding);</td></tr>
<tr><td class="h">1455</td><td colspan="7"></td></tr><tr><td class="h">1456</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   comment data</td></tr>
<tr><td class="h">1457</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1457">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(parent_userpic     =&gt; ($parent-&gt;userpic) ? $parent-&gt;userpic-&gt;imgtag : &#39;&#39;);</td></tr>
<tr><td class="h">1458</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(parent_profile_url =&gt; $parent-&gt;poster-&gt;profile_url);</td></tr>
<tr><td class="h">1459</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(parent_username    =&gt; $parent-&gt;poster-&gt;username);</td></tr>
<tr><td class="h">1460</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1460">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(poster_userpic     =&gt; ($self-&gt;userpic) ? $self-&gt;userpic-&gt;imgtag : &#39;&#39; );</td></tr>
<tr><td class="h">1461</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(poster_profile_url =&gt; $self-&gt;poster-&gt;profile_url);</td></tr>
<tr><td class="h">1462</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(poster_username    =&gt; $self-&gt;poster-&gt;username);</td></tr>
<tr><td class="h">1463</td><td colspan="7"></td></tr><tr><td class="h">1464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   manage comment</td></tr>
<tr><td class="h">1465</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(thread_url    =&gt; $self-&gt;thread_url);</td></tr>
<tr><td class="h">1466</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(entry_url     =&gt; $self-&gt;entry-&gt;url);</td></tr>
<tr><td class="h">1467</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(reply_url     =&gt; $self-&gt;reply_url);</td></tr>
<tr><td class="h">1468</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1468">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(unscreen_url  =&gt; $self-&gt;unscreen_url) if $can_unscreen;</td></tr>
<tr><td class="h">1469</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1469">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(delete_url    =&gt; $self-&gt;delete_url) if $self-&gt;user_can_delete($targetu);</td></tr>
<tr><td class="h">1470</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1470">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(want_form     =&gt; ($self-&gt;is_active || $can_unscreen));</td></tr>
<tr><td class="h">1471</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(form_action   =&gt; &quot;$LJ::SITEROOT/talkpost_do&quot;);</td></tr>
<tr><td class="h">1472</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1472">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(hidden_fields =&gt; LJ::html_hidden</td></tr>
<tr><td class="h">1473</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( usertype     =&gt;  &quot;user&quot;,</td></tr>
<tr><td class="h">1474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parenttalkid =&gt;  $self-&gt;jtalkid,</td></tr>
<tr><td class="h">1475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itemid       =&gt;  $entry-&gt;ditemid,</td></tr>
<tr><td class="h">1476</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;journal      =&gt;  $entry-&gt;journal-&gt;username,</td></tr>
<tr><td class="h">1477</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userpost     =&gt;  $targetu-&gt;username,</td></tr>
<tr><td class="h">1478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecphash      =&gt;  LJ::Talk::ecphash($entry-&gt;jitemid, $self-&gt;jtalkid, $targetu-&gt;password)</td></tr>
<tr><td class="h">1479</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) .</td></tr>
<tr><td class="h">1480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($encoding ne &quot;UTF-8&quot; ?</td></tr>
<tr><td class="h">1481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::html_hidden(encoding =&gt; $encoding):</td></tr>
<tr><td class="h">1482</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;&#39;</td></tr>
<tr><td class="h">1483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">1484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1485</td><td colspan="7"></td></tr><tr><td class="h">1486</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(jtalkid           =&gt; $self-&gt;jtalkid);</td></tr>
<tr><td class="h">1487</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(dtalkid           =&gt; $self-&gt;dtalkid);</td></tr>
<tr><td class="h">1488</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(ditemid           =&gt; $entry-&gt;ditemid);</td></tr>
<tr><td class="h">1489</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(journal_username  =&gt; $entry-&gt;journal-&gt;username);</td></tr>
<tr><td class="h">1490</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1490">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;parent) {</td></tr>
<tr><td class="h">1491</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(parent_jtalkid         =&gt; $self-&gt;parent-&gt;jtalkid);</td></tr>
<tr><td class="h">1492</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(parent_dtalkid         =&gt; $self-&gt;parent-&gt;dtalkid);</td></tr>
<tr><td class="h">1493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1494</td><td colspan="7"></td></tr><tr><td class="h">1495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1496</td><td colspan="7"></td></tr><tr><td class="h">1497</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Processes template for HTML e-mail notifications</td></tr>
<tr><td class="h">1498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># and returns the result of template processing.</td></tr>
<tr><td class="h">1499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub format_template_html_mail {</td></tr>
<tr><td class="h">1500</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1500">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self    = shift;           # comment</td></tr>
<tr><td class="h">1501</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $targetu = shift;           # target user, who should be notified about the comment</td></tr>
<tr><td class="h">1502</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $t       = shift;           # LJ::HTML::Template object - template of the notification e-mail</td></tr>
<tr><td class="h">1503</td><td colspan="7"></td></tr><tr><td class="h">1504</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1504">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parent  = $self-&gt;parent || $self-&gt;entry;</td></tr>
<tr><td class="h">1505</td><td colspan="7"></td></tr><tr><td class="h">1506</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_format_template_mail($targetu, $t);</td></tr>
<tr><td class="h">1507</td><td colspan="7"></td></tr><tr><td class="h">1508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# add specific for HTML params</td></tr>
<tr><td class="h">1509</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(parent_text        =&gt; LJ::Talk::Post::blockquote($parent-&gt;body_html));</td></tr>
<tr><td class="h">1510</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(poster_text        =&gt; LJ::Talk::Post::blockquote($self-&gt;body_html));</td></tr>
<tr><td class="h">1511</td><td colspan="7"></td></tr><tr><td class="h">1512</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $email_subject = $self-&gt;subject_html;</td></tr>
<tr><td class="h">1513</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1513">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1513">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$email_subject = &quot;Re: $email_subject&quot; if $email_subject and $email_subject !~ /^Re:/;</td></tr>
<tr><td class="h">1514</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(email_subject =&gt; $email_subject);</td></tr>
<tr><td class="h">1515</td><td colspan="7"></td></tr><tr><td class="h">1516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# parse template and return it</td></tr>
<tr><td class="h">1517</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $t-&gt;output; </td></tr>
<tr><td class="h">1518</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1519</td><td colspan="7"></td></tr><tr><td class="h">1520</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Processes template for PLAIN-TEXT e-mail notifications</td></tr>
<tr><td class="h">1521</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># and returns the result of template processing.</td></tr>
<tr><td class="h">1522</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub format_template_text_mail {</td></tr>
<tr><td class="h">1523</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1523">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self    = shift;           # comment</td></tr>
<tr><td class="h">1524</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $targetu = shift;           # target user, who should be notified about the comment</td></tr>
<tr><td class="h">1525</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $t       = shift;           # LJ::HTML::Template object - template of the notification e-mail</td></tr>
<tr><td class="h">1526</td><td colspan="7"></td></tr><tr><td class="h">1527</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1527">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parent  = $self-&gt;parent || $self-&gt;entry;</td></tr>
<tr><td class="h">1528</td><td colspan="7"></td></tr><tr><td class="h">1529</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_format_template_mail($targetu, $t);</td></tr>
<tr><td class="h">1530</td><td colspan="7"></td></tr><tr><td class="h">1531</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# add specific for PLAIN-TEXT params</td></tr>
<tr><td class="h">1532</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(parent_text        =&gt; $parent-&gt;body_raw);</td></tr>
<tr><td class="h">1533</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(poster_text        =&gt; $self-&gt;body_raw);</td></tr>
<tr><td class="h">1534</td><td colspan="7"></td></tr><tr><td class="h">1535</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $email_subject = $self-&gt;subject_raw;</td></tr>
<tr><td class="h">1536</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1536">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1536">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$email_subject = &quot;Re: $email_subject&quot; if $email_subject and $email_subject !~ /^Re:/;</td></tr>
<tr><td class="h">1537</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;param(email_subject =&gt; $email_subject);</td></tr>
<tr><td class="h">1538</td><td colspan="7"></td></tr><tr><td class="h">1539</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# parse template and return it</td></tr>
<tr><td class="h">1540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $t-&gt;output; </td></tr>
<tr><td class="h">1541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1542</td><td colspan="7"></td></tr><tr><td class="h">1543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete {</td></tr>
<tr><td class="h">1544</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1544">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1545</td><td colspan="7"></td></tr><tr><td class="h">1546</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::delete_comment</td></tr>
<tr><td class="h">1547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $self-&gt;journal,</td></tr>
<tr><td class="h">1548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;nodeid, # jitemid</td></tr>
<tr><td class="h">1549</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;jtalkid, </td></tr>
<tr><td class="h">1550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;state );</td></tr>
<tr><td class="h">1551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1552</td><td colspan="7"></td></tr><tr><td class="h">1553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_thread {</td></tr>
<tr><td class="h">1554</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1554">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1555</td><td colspan="7"></td></tr><tr><td class="h">1556</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::delete_thread</td></tr>
<tr><td class="h">1557</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $self-&gt;journal,</td></tr>
<tr><td class="h">1558</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;nodeid, # jitemid</td></tr>
<tr><td class="h">1559</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;jtalkid );</td></tr>
<tr><td class="h">1560</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1561</td><td colspan="7"></td></tr><tr><td class="h">1562</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Returns true if passed text is a spam.</td></tr>
<tr><td class="h">1564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1565</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Class method.</td></tr>
<tr><td class="h">1566</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   LJ::Comment-&gt;is_text_spam( $some_text );</td></tr>
<tr><td class="h">1567</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_text_spam($\$) {</td></tr>
<tr><td class="h">1569</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1569">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">1570</td><td colspan="7"></td></tr><tr><td class="h">1571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# REF on text</td></tr>
<tr><td class="h">1572</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ref   = shift; </td></tr>
<tr><td class="h">1573</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1573">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ref   = \$ref unless ref ($ref) eq &#39;SCALAR&#39;;</td></tr>
<tr><td class="h">1574</td><td colspan="7"></td></tr><tr><td class="h">1575</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $plain = $$ref; # otherwise we modify the source text</td></tr>
<tr><td class="h">1576</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$plain = LJ::CleanHTML::clean_comment(\$plain);</td></tr>
<tr><td class="h">1577</td><td colspan="7"></td></tr><tr><td class="h">1578</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $re ($LJ::TALK_ABORT_REGEXP, @LJ::TALKSPAM){</td></tr>
<tr><td class="h">1579</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1579">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1579">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 # spam</td></tr>
<tr><td class="h">1580</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $re and ($plain =~ /$re/ or $$ref =~ /$re/);</td></tr>
<tr><td class="h">1581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1582</td><td colspan="7"></td></tr><tr><td class="h">1583</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0; # normal text</td></tr>
<tr><td class="h">1584</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1585</td><td colspan="7"></td></tr><tr><td class="h">1586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a LJ::Userpic object for the poster of the comment, or undef</td></tr>
<tr><td class="h">1587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># it will unify interface between Entry and Comment: $foo-&gt;userpic will</td></tr>
<tr><td class="h">1588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># work correctly for both Entry and Comment objects</td></tr>
<tr><td class="h">1589</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub userpic {</td></tr>
<tr><td class="h">1590</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1590">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1591</td><td colspan="7"></td></tr><tr><td class="h">1592</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $up = $self-&gt;poster;</td></tr>
<tr><td class="h">1593</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1593">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $up;</td></tr>
<tr><td class="h">1594</td><td colspan="7"></td></tr><tr><td class="h">1595</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $key = $self-&gt;prop(&#39;picture_keyword&#39;);</td></tr>
<tr><td class="h">1596</td><td colspan="7"></td></tr><tr><td class="h">1597</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return the picture from keyword, if defined</td></tr>
<tr><td class="h">1598</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $picid = LJ::get_picid_from_keyword($up, $key);</td></tr>
<tr><td class="h">1599</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1599">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Userpic-&gt;new($up, $picid) if $picid;</td></tr>
<tr><td class="h">1600</td><td colspan="7"></td></tr><tr><td class="h">1601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# else return poster&#39;s default userpic</td></tr>
<tr><td class="h">1602</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $up-&gt;userpic;</td></tr>
<tr><td class="h">1603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1604</td><td colspan="7"></td></tr><tr><td class="h">1605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub poster_ip {</td></tr>
<tr><td class="h">1606</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1606">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1607</td><td colspan="7"></td></tr><tr><td class="h">1608</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;prop(&quot;poster_ip&quot;);</td></tr>
<tr><td class="h">1609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1610</td><td colspan="7"></td></tr><tr><td class="h">1611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># sets the new poster IP and returns the value that was set</td></tr>
<tr><td class="h">1612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_poster_ip {</td></tr>
<tr><td class="h">1613</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1613">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1614</td><td colspan="7"></td></tr><tr><td class="h">1615</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1615">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&quot; unless LJ::is_web_context();</td></tr>
<tr><td class="h">1616</td><td colspan="7"></td></tr><tr><td class="h">1617</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $current_ip = $self-&gt;poster_ip;</td></tr>
<tr><td class="h">1618</td><td colspan="7"></td></tr><tr><td class="h">1619</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $new_ip = BML::get_remote_ip();</td></tr>
<tr><td class="h">1620</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $forwarded = BML::get_client_header(&#39;X-Forwarded-For&#39;);</td></tr>
<tr><td class="h">1621</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1621">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1621">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$new_ip = &quot;$forwarded, via $new_ip&quot; if $forwarded &amp;&amp; $forwarded ne $new_ip;</td></tr>
<tr><td class="h">1622</td><td colspan="7"></td></tr><tr><td class="h">1623</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1623">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--condition.html#L1623">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$current_ip || $new_ip eq $current_ip) {</td></tr>
<tr><td class="h">1624</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;set_prop( poster_ip =&gt; $new_ip );</td></tr>
<tr><td class="h">1625</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $new_ip;</td></tr>
<tr><td class="h">1626</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1627</td><td colspan="7"></td></tr><tr><td class="h">1628</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1628">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($current_ip =~ /\(originally ([\w\.]+)\)/) {</td></tr>
<tr><td class="h">1629</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1629">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($new_ip eq $1) {</td></tr>
<tr><td class="h">1630</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;set_prop( poster_ip =&gt; $new_ip );</td></tr>
<tr><td class="h">1631</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $new_ip;</td></tr>
<tr><td class="h">1632</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1633</td><td colspan="7"></td></tr><tr><td class="h">1634</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$new_ip = &quot;$new_ip (originally $1)&quot;;</td></tr>
<tr><td class="h">1635</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1636</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$new_ip = &quot;$new_ip (originally $current_ip)&quot;;</td></tr>
<tr><td class="h">1637</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1638</td><td colspan="7"></td></tr><tr><td class="h">1639</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;set_prop( poster_ip =&gt; $new_ip );</td></tr>
<tr><td class="h">1640</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $new_ip;</td></tr>
<tr><td class="h">1641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1642</td><td colspan="7"></td></tr><tr><td class="h">1643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub edit_time {</td></tr>
<tr><td class="h">1644</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1644">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1645</td><td colspan="7"></td></tr><tr><td class="h">1646</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;prop(&quot;edit_time&quot;);</td></tr>
<tr><td class="h">1647</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1648</td><td colspan="7"></td></tr><tr><td class="h">1649</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_edited {</td></tr>
<tr><td class="h">1650</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Comment-pm--subroutine.html#L1650">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">1651</td><td colspan="7"></td></tr><tr><td class="h">1652</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Comment-pm--branch.html#L1652">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;edit_time ? 1 : 0;</td></tr>
<tr><td class="h">1653</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1654</td><td colspan="7"></td></tr><tr><td class="h">1655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
