<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/talklib.pl</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/talklib.pl</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">20.0%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#!/usr/bin/perl</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">3</td><td colspan="7"></td></tr><tr><td class="h">4</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L4">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ::Talk;</td></tr>
<tr><td class="h">6</td><td colspan="7"></td></tr><tr><td class="h">7</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L7">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Constants;</td></tr>
<tr><td class="h">8</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L8">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Event::JournalNewComment;</td></tr>
<tr><td class="h">9</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L9">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Event::UserNewComment;</td></tr>
<tr><td class="h">10</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L10">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Comment;</td></tr>
<tr><td class="h">11</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L11">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::EventLogRecord::NewComment;</td></tr>
<tr><td class="h">12</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L12">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use Captcha::reCAPTCHA;</td></tr>
<tr><td class="h">13</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L13">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::OpenID;</td></tr>
<tr><td class="h">14</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L14">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use MIME::Words;</td></tr>
<tr><td class="h">15</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L15">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use Carp qw(croak);</td></tr>
<tr><td class="h">16</td><td colspan="7"></td></tr><tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># dataversion for rate limit logging</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">our $RATE_DATAVER = &quot;1&quot;;</td></tr>
<tr><td class="h">19</td><td colspan="7"></td></tr><tr><td class="h">20</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_subjecticons</td></tr>
<tr><td class="h">21</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">22</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L22">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %subjecticon;</td></tr>
<tr><td class="h">23</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$subjecticon{&#39;types&#39;} = [ &#39;sm&#39;, &#39;md&#39; ];</td></tr>
<tr><td class="h">24</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$subjecticon{&#39;lists&#39;}-&gt;{&#39;md&#39;} = [</td></tr>
<tr><td class="h">25</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;md01_alien.gif&quot;,          w =&gt; 32,        h =&gt; 32,         alt =&gt; &quot;Smiling Alien&quot; },</td></tr>
<tr><td class="h">26</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;md02_skull.gif&quot;,          w =&gt; 32,        h =&gt; 32,         alt =&gt; &quot;Skull and Crossbones&quot; },</td></tr>
<tr><td class="h">27</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;md05_sick.gif&quot;,           w =&gt; 25,        h =&gt; 25,         alt =&gt; &quot;Sick Face&quot; },</td></tr>
<tr><td class="h">28</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;md06_radioactive.gif&quot;,    w =&gt; 20,        h =&gt; 20,         alt =&gt; &quot;Radioactive Symbol&quot; },</td></tr>
<tr><td class="h">29</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;md07_cool.gif&quot;,           w =&gt; 20,        h =&gt; 20,         alt =&gt; &quot;Cool Smiley&quot; },</td></tr>
<tr><td class="h">30</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;md08_bulb.gif&quot;,           w =&gt; 17,        h =&gt; 23,         alt =&gt; &quot;Lightbulb&quot; },</td></tr>
<tr><td class="h">31</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;md09_thumbdown.gif&quot;,      w =&gt; 25,        h =&gt; 19,         alt =&gt; &quot;Red Thumbs Down&quot; },</td></tr>
<tr><td class="h">32</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;md10_thumbup.gif&quot;,        w =&gt; 25,        h =&gt; 19,         alt =&gt; &quot;Green Thumbs Up&quot; }</td></tr>
<tr><td class="h">33</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;];</td></tr>
<tr><td class="h">34</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$subjecticon{&#39;lists&#39;}-&gt;{&#39;sm&#39;} = [</td></tr>
<tr><td class="h">35</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm01_smiley.gif&quot;,         w =&gt; 15,        h =&gt; 15,         alt =&gt; &quot;Smiley&quot; },</td></tr>
<tr><td class="h">36</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm02_wink.gif&quot;,           w =&gt; 15,        h =&gt; 15,         alt =&gt; &quot;Winking Smiley&quot; },</td></tr>
<tr><td class="h">37</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm03_blush.gif&quot;,          w =&gt; 15,        h =&gt; 15,         alt =&gt; &quot;Blushing Smiley&quot; },</td></tr>
<tr><td class="h">38</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm04_shock.gif&quot;,          w =&gt; 15,        h =&gt; 15,         alt =&gt; &quot;Shocked Smiley&quot; },</td></tr>
<tr><td class="h">39</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm05_sad.gif&quot;,            w =&gt; 15,        h =&gt; 15,         alt =&gt; &quot;Sad Smiley&quot; },</td></tr>
<tr><td class="h">40</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm06_angry.gif&quot;,          w =&gt; 15,        h =&gt; 15,         alt =&gt; &quot;Angry Smiley&quot; },</td></tr>
<tr><td class="h">41</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm07_check.gif&quot;,          w =&gt; 15,        h =&gt; 15,         alt =&gt; &quot;Checkmark&quot; },</td></tr>
<tr><td class="h">42</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm08_star.gif&quot;,           w =&gt; 20,        h =&gt; 18,         alt =&gt; &quot;Gold Star&quot; },</td></tr>
<tr><td class="h">43</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm09_mail.gif&quot;,           w =&gt; 14,        h =&gt; 10,         alt =&gt; &quot;Envelope&quot; },</td></tr>
<tr><td class="h">44</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ img =&gt; &quot;sm10_eyes.gif&quot;,           w =&gt; 24,        h =&gt; 12,         alt =&gt; &quot;Shifty Eyes&quot; }</td></tr>
<tr><td class="h">45</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;];</td></tr>
<tr><td class="h">46</td><td colspan="7"></td></tr><tr><td class="h">47</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# assemble -&gt;{&#39;id&#39;} portion of hash.  the part of the imagename before the _</td></tr>
<tr><td class="h">48</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %{$subjecticon{&#39;lists&#39;}}) {</td></tr>
<tr><td class="h">49</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $pic (@{$subjecticon{&#39;lists&#39;}-&gt;{$_}}) {</td></tr>
<tr><td class="h">50</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L50">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless ($pic-&gt;{&#39;img&#39;} =~ /^(\D{2}\d{2})\_.+$/);</td></tr>
<tr><td class="h">51</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$subjecticon{&#39;pic&#39;}-&gt;{$1} = $pic;</td></tr>
<tr><td class="h">52</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pic-&gt;{&#39;id&#39;} = $1;</td></tr>
<tr><td class="h">53</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">54</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">55</td><td colspan="7"></td></tr><tr><td class="h">56</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \%subjecticon;</td></tr>
<tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">58</td><td colspan="7"></td></tr><tr><td class="h">59</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># entryid-commentid-emailrecipientpassword hash</td></tr>
<tr><td class="h">60</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub ecphash {</td></tr>
<tr><td class="h">61</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L61">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($itemid, $talkid, $password) = @_;</td></tr>
<tr><td class="h">62</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;ecph-&quot; . Digest::MD5::md5_hex($itemid . $talkid . $password);</td></tr>
<tr><td class="h">63</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">64</td><td colspan="7"></td></tr><tr><td class="h">65</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Returns talkurl with GET args added (don&#39;t pass #anchors to this :-)</td></tr>
<tr><td class="h">66</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub talkargs {</td></tr>
<tr><td class="h">67</td><td><div class="c3">214</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L67">214</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $talkurl = shift;</td></tr>
<tr><td class="h">68</td><td><div class="c3">214</div><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $args = join(&quot;&amp;&quot;, grep {$_} @_);</td></tr>
<tr><td class="h">69</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sep;</td></tr>
<tr><td class="h">70</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L70">50</a></div><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L70">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sep = ($talkurl =~ /\?/ ? &quot;&amp;&quot; : &quot;?&quot;) if $args;</td></tr>
<tr><td class="h">71</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$talkurl$sep$args&quot;;</td></tr>
<tr><td class="h">72</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">73</td><td colspan="7"></td></tr><tr><td class="h">74</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Returns HTML to display an image, given the image id as an argument.</td></tr>
<tr><td class="h">75</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub show_image</td></tr>
<tr><td class="h">76</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">77</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L77">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $pics, $id, $extra ) = @_;</td></tr>
<tr><td class="h">78</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L78">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless defined $pics-&gt;{pic}-&gt;{$id};</td></tr>
<tr><td class="h">79</td><td colspan="7"></td></tr><tr><td class="h">80</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $p = $pics-&gt;{pic}-&gt;{$id};</td></tr>
<tr><td class="h">81</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;img src=&#39;$LJ::IMGPREFIX/talk/$p-&gt;{img}&#39; border=&#39;0&#39; &quot;.</td></tr>
<tr><td class="h">82</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;width=&#39;$p-&gt;{w}&#39; height=&#39;$p-&gt;{h}&#39; alt=&#39;$p-&gt;{alt}&#39; valign=&#39;middle&#39; $extra /&gt;&quot;;</td></tr>
<tr><td class="h">83</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">84</td><td colspan="7"></td></tr><tr><td class="h">85</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Returns &#39;none&#39; icon.</td></tr>
<tr><td class="h">86</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub show_none_image</td></tr>
<tr><td class="h">87</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">88</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L88">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $extra = shift;</td></tr>
<tr><td class="h">89</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $img = &#39;none.gif&#39;;</td></tr>
<tr><td class="h">90</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $w = 15;</td></tr>
<tr><td class="h">91</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $h = 15;</td></tr>
<tr><td class="h">92</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pfx = &quot;$LJ::IMGPREFIX/talk&quot;;</td></tr>
<tr><td class="h">93</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;img src=&#39;$pfx/$img&#39; border=&#39;0&#39; &quot;.</td></tr>
<tr><td class="h">94</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;width=&#39;$w&#39; height=&#39;$h&#39; valign=&#39;middle&#39; $extra /&gt;&quot;;</td></tr>
<tr><td class="h">95</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">96</td><td colspan="7"></td></tr><tr><td class="h">97</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub link_bar</td></tr>
<tr><td class="h">98</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">99</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L99">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = shift;</td></tr>
<tr><td class="h">100</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $up, $remote, $headref, $itemid) =</td></tr>
<tr><td class="h">101</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map { $opts-&gt;{$_} } qw(u up remote headref itemid);</td></tr>
<tr><td class="h">102</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret;</td></tr>
<tr><td class="h">103</td><td colspan="7"></td></tr><tr><td class="h">104</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @linkele;</td></tr>
<tr><td class="h">105</td><td colspan="7"></td></tr><tr><td class="h">106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mlink = sub {</td></tr>
<tr><td class="h">107</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L107">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($url, $piccode) = @_;</td></tr>
<tr><td class="h">108</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (&quot;&lt;a href=\&quot;$url\&quot;&gt;&quot; .</td></tr>
<tr><td class="h">109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::img($piccode, &quot;&quot;, { &#39;align&#39; =&gt; &#39;absmiddle&#39; }) .</td></tr>
<tr><td class="h">110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;/a&gt;&quot;);</td></tr>
<tr><td class="h">111</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">112</td><td colspan="7"></td></tr><tr><td class="h">113</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jarg = &quot;journal=$u-&gt;{&#39;user&#39;}&amp;&quot;;</td></tr>
<tr><td class="h">114</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jargent = &quot;journal=$u-&gt;{&#39;user&#39;}&amp;amp;&quot;;</td></tr>
<tr><td class="h">115</td><td colspan="7"></td></tr><tr><td class="h">116</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new($u, ditemid =&gt; $itemid);</td></tr>
<tr><td class="h">117</td><td colspan="7"></td></tr><tr><td class="h">118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# &lt;&lt; Previous</td></tr>
<tr><td class="h">119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @linkele, $mlink-&gt;(&quot;$LJ::SITEROOT/go?${jargent}itemid=$itemid&amp;amp;dir=prev&quot;, &quot;prev_entry&quot;);</td></tr>
<tr><td class="h">120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$headref .= &quot;&lt;link href=&#39;$LJ::SITEROOT/go?${jargent}itemid=$itemid&amp;amp;dir=prev&#39; rel=&#39;Previous&#39; /&gt;\n&quot;;</td></tr>
<tr><td class="h">121</td><td colspan="7"></td></tr><tr><td class="h">122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# memories</td></tr>
<tr><td class="h">123</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L123">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( LJ::is_enabled(&#39;memories&#39;) ) {</td></tr>
<tr><td class="h">124</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @linkele, $mlink-&gt;(&quot;$LJ::SITEROOT/tools/memadd?${jargent}itemid=$itemid&quot;, &quot;memadd&quot;);</td></tr>
<tr><td class="h">125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">126</td><td colspan="7"></td></tr><tr><td class="h">127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# edit entry - if we have a remote, and that person can manage</td></tr>
<tr><td class="h">128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the account in question, OR, they posted the entry, and have</td></tr>
<tr><td class="h">129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# access to the community in question</td></tr>
<tr><td class="h">130</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L130">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L130">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $remote &amp;&amp; (LJ::can_manage($remote, $u) ||</td></tr>
<tr><td class="h">131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LJ::u_equals($remote, $up) &amp;&amp; LJ::can_use_journal($up-&gt;{userid}, $u-&gt;{user}, {}))))</td></tr>
<tr><td class="h">132</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @linkele, $mlink-&gt;(&quot;$LJ::SITEROOT/editjournal?${jargent}itemid=$itemid&quot;, &quot;editentry&quot;);</td></tr>
<tr><td class="h">134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">135</td><td colspan="7"></td></tr><tr><td class="h">136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# edit tags</td></tr>
<tr><td class="h">137</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L137">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( LJ::is_enabled(&#39;tags&#39;) ) {</td></tr>
<tr><td class="h">138</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L138">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L138">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $remote &amp;&amp; LJ::Tags::can_add_tags($u, $remote)) {</td></tr>
<tr><td class="h">139</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @linkele, $mlink-&gt;(&quot;$LJ::SITEROOT/edittags?${jargent}itemid=$itemid&quot;, &quot;edittags&quot;);</td></tr>
<tr><td class="h">140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">142</td><td colspan="7"></td></tr><tr><td class="h">143</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L143">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( LJ::is_enabled(&#39;tellafriend&#39;) ) {</td></tr>
<tr><td class="h">144</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L144">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @linkele, $mlink-&gt;(&quot;$LJ::SITEROOT/tools/tellafriend?${jargent}itemid=$itemid&quot;, &quot;tellfriend&quot;)</td></tr>
<tr><td class="h">145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($entry-&gt;can_tellafriend($remote));</td></tr>
<tr><td class="h">146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">147</td><td colspan="7"></td></tr><tr><td class="h">148</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L148">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L148">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($remote &amp;&amp; $remote-&gt;can_use_esn) {</td></tr>
<tr><td class="h">149</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L149">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $img_key = $remote-&gt;has_subscription(journal =&gt; $u, event =&gt; &quot;JournalNewComment&quot;, arg1 =&gt; $itemid, require_active =&gt; 1) ?</td></tr>
<tr><td class="h">150</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;track_active&quot; : &quot;track&quot;;</td></tr>
<tr><td class="h">151</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @linkele, $mlink-&gt;(&quot;$LJ::SITEROOT/manage/subscriptions/entry?${jargent}itemid=$itemid&quot;, $img_key);</td></tr>
<tr><td class="h">152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">153</td><td colspan="7"></td></tr><tr><td class="h">154</td><td colspan="7"></td></tr><tr><td class="h">155</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## &gt;&gt;&gt; Next</td></tr>
<tr><td class="h">156</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @linkele, $mlink-&gt;(&quot;$LJ::SITEROOT/go?${jargent}itemid=$itemid&amp;amp;dir=next&quot;, &quot;next_entry&quot;);</td></tr>
<tr><td class="h">157</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$headref .= &quot;&lt;link href=&#39;$LJ::SITEROOT/go?${jargent}itemid=$itemid&amp;amp;dir=next&#39; rel=&#39;Next&#39; /&gt;\n&quot;;</td></tr>
<tr><td class="h">158</td><td colspan="7"></td></tr><tr><td class="h">159</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L159">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@linkele) {</td></tr>
<tr><td class="h">160</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= BML::fill_template(&quot;standout&quot;, {</td></tr>
<tr><td class="h">161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DATA&#39; =&gt; &quot;&lt;table&gt;&lt;tr&gt;&lt;td valign=&#39;middle&#39;&gt;&quot; .</td></tr>
<tr><td class="h">162</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;join(&quot;&amp;nbsp;&amp;nbsp;&quot;, @linkele) .</td></tr>
<tr><td class="h">163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;,</td></tr>
<tr><td class="h">164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">165</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">166</td><td colspan="7"></td></tr><tr><td class="h">167</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">168</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">169</td><td colspan="7"></td></tr><tr><td class="h">170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub init</td></tr>
<tr><td class="h">171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">172</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L172">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($form) = @_;</td></tr>
<tr><td class="h">173</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $init = {};  # structure to return</td></tr>
<tr><td class="h">174</td><td colspan="7"></td></tr><tr><td class="h">175</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journal = $form-&gt;{&#39;journal&#39;};</td></tr>
<tr><td class="h">176</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ju = undef;</td></tr>
<tr><td class="h">177</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $item = undef;        # hashref; journal item conversation is in</td></tr>
<tr><td class="h">178</td><td colspan="7"></td></tr><tr><td class="h">179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# defaults, to be changed later:</td></tr>
<tr><td class="h">180</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;itemid&#39;} = $form-&gt;{&#39;itemid&#39;}+0;</td></tr>
<tr><td class="h">181</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;ditemid&#39;} = $init-&gt;{&#39;itemid&#39;};</td></tr>
<tr><td class="h">182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;thread&#39;} = $form-&gt;{&#39;thread&#39;}+0;</td></tr>
<tr><td class="h">183</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;dthread&#39;} = $init-&gt;{&#39;thread&#39;};</td></tr>
<tr><td class="h">184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;clustered&#39;} = 0;</td></tr>
<tr><td class="h">185</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;replyto&#39;} = $form-&gt;{&#39;replyto&#39;}+0;</td></tr>
<tr><td class="h">186</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L186">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;style&#39;} = $form-&gt;{&#39;style&#39;}</td></tr>
<tr><td class="h">187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $form-&gt;{&#39;style&#39;} =~ /^(?:mine|light)$/;</td></tr>
<tr><td class="h">188</td><td colspan="7"></td></tr><tr><td class="h">189</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L189">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journal) {</td></tr>
<tr><td class="h">190</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# they specified a journal argument, which indicates new style.</td></tr>
<tr><td class="h">191</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ju = LJ::load_user($journal);</td></tr>
<tr><td class="h">192</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L192">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return { &#39;error&#39; =&gt; BML::ml(&#39;talk.error.nosuchjournal&#39;)} unless $ju;</td></tr>
<tr><td class="h">193</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L193">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return { &#39;error&#39; =&gt; BML::ml(&#39;talk.error.purged&#39;)} if $ju-&gt;is_expunged;</td></tr>
<tr><td class="h">194</td><td colspan="7"></td></tr><tr><td class="h">195</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::assert_is($ju-&gt;{user}, lc $journal);</td></tr>
<tr><td class="h">196</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ju-&gt;selfassert;</td></tr>
<tr><td class="h">197</td><td colspan="7"></td></tr><tr><td class="h">198</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;clustered&#39;} = 1;</td></tr>
<tr><td class="h">199</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (qw(itemid replyto)) {</td></tr>
<tr><td class="h">200</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L200">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $init-&gt;{$_};</td></tr>
<tr><td class="h">201</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;anum&#39;} = $init-&gt;{$_} % 256;</td></tr>
<tr><td class="h">202</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{$_} = int($init-&gt;{$_} / 256);</td></tr>
<tr><td class="h">203</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last;</td></tr>
<tr><td class="h">204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">205</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L205">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;thread&#39;} = int($init-&gt;{&#39;thread&#39;} / 256)</td></tr>
<tr><td class="h">206</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $init-&gt;{&#39;thread&#39;};</td></tr>
<tr><td class="h">207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">208</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return { &#39;error&#39; =&gt; BML::ml(&#39;talk.error.noentry&#39;) };</td></tr>
<tr><td class="h">209</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">210</td><td colspan="7"></td></tr><tr><td class="h">211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;journalu&#39;} = $ju;</td></tr>
<tr><td class="h">212</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $init;</td></tr>
<tr><td class="h">213</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">214</td><td colspan="7"></td></tr><tr><td class="h">215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $u, $itemid</td></tr>
<tr><td class="h">216</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_journal_item</td></tr>
<tr><td class="h">217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">218</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L218">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $itemid) = @_;</td></tr>
<tr><td class="h">219</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L219">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L219">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $u &amp;&amp; $itemid;</td></tr>
<tr><td class="h">220</td><td colspan="7"></td></tr><tr><td class="h">221</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $u-&gt;{&#39;userid&#39;}+0;</td></tr>
<tr><td class="h">222</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$itemid += 0;</td></tr>
<tr><td class="h">223</td><td colspan="7"></td></tr><tr><td class="h">224</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $item = LJ::get_log2_row($u, $itemid);</td></tr>
<tr><td class="h">225</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L225">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $item;</td></tr>
<tr><td class="h">226</td><td colspan="7"></td></tr><tr><td class="h">227</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;alldatepart&#39;} = LJ::alldatepart_s2($item-&gt;{&#39;eventtime&#39;});</td></tr>
<tr><td class="h">228</td><td colspan="7"></td></tr><tr><td class="h">229</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;itemid&#39;} = $item-&gt;{&#39;jitemid&#39;};    # support old &amp; new keys</td></tr>
<tr><td class="h">230</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;ownerid&#39;} = $item-&gt;{&#39;journalid&#39;}; # support old &amp; news keys</td></tr>
<tr><td class="h">231</td><td colspan="7"></td></tr><tr><td class="h">232</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lt = LJ::get_logtext2($u, $itemid);</td></tr>
<tr><td class="h">233</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $v = $lt-&gt;{$itemid};</td></tr>
<tr><td class="h">234</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;subject&#39;} = $v-&gt;[0];</td></tr>
<tr><td class="h">235</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;event&#39;} = $v-&gt;[1];</td></tr>
<tr><td class="h">236</td><td colspan="7"></td></tr><tr><td class="h">237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### load the log properties</td></tr>
<tr><td class="h">238</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %logprops = ();</td></tr>
<tr><td class="h">239</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_log_props2($u-&gt;{&#39;userid&#39;}, [ $itemid ], \%logprops);</td></tr>
<tr><td class="h">240</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L240">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;props&#39;} = $logprops{$itemid} || {};</td></tr>
<tr><td class="h">241</td><td colspan="7"></td></tr><tr><td class="h">242</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L242">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L242">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $logprops{$itemid}-&gt;{&#39;unknown8bit&#39;}) {</td></tr>
<tr><td class="h">243</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::item_toutf8($u, \$item-&gt;{&#39;subject&#39;}, \$item-&gt;{&#39;event&#39;},</td></tr>
<tr><td class="h">244</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;logprops&#39;}-&gt;{$itemid});</td></tr>
<tr><td class="h">245</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">246</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $item;</td></tr>
<tr><td class="h">247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">248</td><td colspan="7"></td></tr><tr><td class="h">249</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub check_viewable</td></tr>
<tr><td class="h">250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">251</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L251">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($remote, $item, $form, $errref) = @_;</td></tr>
<tr><td class="h">252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# note $form no longer used</td></tr>
<tr><td class="h">253</td><td colspan="7"></td></tr><tr><td class="h">254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = sub {</td></tr>
<tr><td class="h">255</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L255">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = &quot;&lt;?h1 &lt;?_ml Error _ml?&gt; h1?&gt;&lt;?p $_[0] p?&gt;&quot;;</td></tr>
<tr><td class="h">256</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">257</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">258</td><td colspan="7"></td></tr><tr><td class="h">259</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L259">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (LJ::can_view($remote, $item)) {</td></tr>
<tr><td class="h">260</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $journal = LJ::load_userid( $item-&gt;{ownerid} );</td></tr>
<tr><td class="h">261</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $journalname = $journal-&gt;username;</td></tr>
<tr><td class="h">262</td><td colspan="7"></td></tr><tr><td class="h">263</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L263">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $remote) {</td></tr>
<tr><td class="h">264</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L264">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L264">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L264">0</a></div><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L264">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $journal-&gt;is_community &amp;&amp; ! $journal-&gt;is_closed_membership &amp;&amp; $remote ) {</td></tr>
<tr><td class="h">265</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;( BML::ml( &#39;talk.error.notauthorised.comm.open&#39;, { aopts =&gt; &quot;href=&#39;$LJ::SITEROOT/community/join?comm=$journalname&#39;&quot; } ) );</td></tr>
<tr><td class="h">266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( $journal-&gt;is_community &amp;&amp; $journal-&gt;is_closed_membership ) {</td></tr>
<tr><td class="h">267</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;( BML::ml( &#39;talk.error.notauthorised.comm.closed&#39; ) );</td></tr>
<tr><td class="h">268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">269</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;( BML::ml( &#39;talk.error.notauthorised&#39; ) );</td></tr>
<tr><td class="h">270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">272</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $r = BML::get_request();</td></tr>
<tr><td class="h">273</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $host = $r-&gt;headers_in-&gt;{Host};</td></tr>
<tr><td class="h">274</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $args = scalar $r-&gt;args;</td></tr>
<tr><td class="h">275</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L275">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $querysep = $args ? &quot;?&quot; : &quot;&quot;;</td></tr>
<tr><td class="h">276</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $redir = LJ::eurl(&quot;http://&quot; . $host . $r-&gt;uri . $querysep . $args);</td></tr>
<tr><td class="h">277</td><td colspan="7"></td></tr><tr><td class="h">278</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(BML::redirect(&quot;$LJ::SITEROOT/?returnto=$redir&amp;errmsg=notloggedin&quot;));</td></tr>
<tr><td class="h">279</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">281</td><td colspan="7"></td></tr><tr><td class="h">282</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">284</td><td colspan="7"></td></tr><tr><td class="h">285</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::can_delete</td></tr>
<tr><td class="h">287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Determines if a user can delete a comment or entry: You can</td></tr>
<tr><td class="h">288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       delete anything you&#39;ve posted.  You can delete anything posted in something</td></tr>
<tr><td class="h">289</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       you own (i.e. a comment in your journal, a comment to an entry you made in</td></tr>
<tr><td class="h">290</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       a community).  You can also delete any item in an account you have the</td></tr>
<tr><td class="h">291</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       &quot;A&quot;dministration edge for.</td></tr>
<tr><td class="h">292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: remote, u, up, userpost</td></tr>
<tr><td class="h">293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-remote: User object we&#39;re checking access of.  From [func[LJ::get_remote]].</td></tr>
<tr><td class="h">294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: Username or object of the account the thing is located in.</td></tr>
<tr><td class="h">295</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-up: Username or object of person who owns the parent of the thing.  (I.e. the poster</td></tr>
<tr><td class="h">296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           of the entry a comment is in.)</td></tr>
<tr><td class="h">297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-userpost: Username (&lt;strong&gt;not&lt;/strong&gt; object) of person who posted the item.</td></tr>
<tr><td class="h">298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Boolean indicating whether remote is allowed to delete the thing</td></tr>
<tr><td class="h">299</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           specified by the other options.</td></tr>
<tr><td class="h">300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_delete {</td></tr>
<tr><td class="h">302</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L302">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($remote, $u, $up, $userpost) = @_; # remote, journal, posting user, commenting user</td></tr>
<tr><td class="h">303</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L303">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $remote;</td></tr>
<tr><td class="h">304</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L304">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L304">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L304">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L304">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $remote-&gt;{&#39;user&#39;} eq $userpost ||</td></tr>
<tr><td class="h">305</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote-&gt;{&#39;user&#39;} eq (ref $u ? $u-&gt;{&#39;user&#39;} : $u) ||</td></tr>
<tr><td class="h">306</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote-&gt;{&#39;user&#39;} eq (ref $up ? $up-&gt;{&#39;user&#39;} : $up) ||</td></tr>
<tr><td class="h">307</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::can_manage($remote, $u);</td></tr>
<tr><td class="h">308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">310</td><td colspan="7"></td></tr><tr><td class="h">311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_screen {</td></tr>
<tr><td class="h">312</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L312">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($remote, $u, $up, $userpost) = @_;</td></tr>
<tr><td class="h">313</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L313">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $remote;</td></tr>
<tr><td class="h">314</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L314">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L314">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L314">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $remote-&gt;{&#39;user&#39;} eq (ref $up ? $up-&gt;{&#39;user&#39;} : $up) ||</td></tr>
<tr><td class="h">315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::can_manage($remote, $u);</td></tr>
<tr><td class="h">316</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">318</td><td colspan="7"></td></tr><tr><td class="h">319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_unscreen {</td></tr>
<tr><td class="h">320</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L320">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::can_screen(@_);</td></tr>
<tr><td class="h">321</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">322</td><td colspan="7"></td></tr><tr><td class="h">323</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_view_screened {</td></tr>
<tr><td class="h">324</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L324">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::can_delete(@_);</td></tr>
<tr><td class="h">325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">326</td><td colspan="7"></td></tr><tr><td class="h">327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_freeze {</td></tr>
<tr><td class="h">328</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L328">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::can_screen(@_);</td></tr>
<tr><td class="h">329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">330</td><td colspan="7"></td></tr><tr><td class="h">331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_unfreeze {</td></tr>
<tr><td class="h">332</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L332">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::can_unscreen(@_);</td></tr>
<tr><td class="h">333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">334</td><td colspan="7"></td></tr><tr><td class="h">335</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::screening_level</td></tr>
<tr><td class="h">337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Determines the screening level of a particular post given the relevant information.</td></tr>
<tr><td class="h">338</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: journalu, jitemid</td></tr>
<tr><td class="h">339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-journalu: User object of the journal the post is in.</td></tr>
<tr><td class="h">340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jitemid: Itemid of the post.</td></tr>
<tr><td class="h">341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Single character that indicates the screening level.  Undef means don&#39;t screen</td></tr>
<tr><td class="h">342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          anything, &#39;A&#39; means screen All, &#39;R&#39; means screen Anonymous (no-remotes), &#39;F&#39; means</td></tr>
<tr><td class="h">343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          screen non-friends.</td></tr>
<tr><td class="h">344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub screening_level {</td></tr>
<tr><td class="h">346</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L346">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalu, $jitemid) = @_;</td></tr>
<tr><td class="h">347</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L347">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &#39;LJ::screening_level needs a user object.&#39; unless ref $journalu;</td></tr>
<tr><td class="h">348</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jitemid += 0;</td></tr>
<tr><td class="h">349</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L349">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &#39;LJ::screening_level passed invalid jitemid.&#39; unless $jitemid;</td></tr>
<tr><td class="h">350</td><td colspan="7"></td></tr><tr><td class="h">351</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load the logprops for this entry</td></tr>
<tr><td class="h">352</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %props;</td></tr>
<tr><td class="h">353</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_log_props2($journalu-&gt;{userid}, [ $jitemid ], \%props);</td></tr>
<tr><td class="h">354</td><td colspan="7"></td></tr><tr><td class="h">355</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# determine if userprop was overriden</td></tr>
<tr><td class="h">356</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $val = $props{$jitemid}{opt_screening};</td></tr>
<tr><td class="h">357</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L357">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $val eq &#39;N&#39;; # N means None, so return undef</td></tr>
<tr><td class="h">358</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L358">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $val if $val;</td></tr>
<tr><td class="h">359</td><td colspan="7"></td></tr><tr><td class="h">360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now return userprop, as it&#39;s our last chance</td></tr>
<tr><td class="h">361</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($journalu, &#39;opt_whoscreened&#39;);</td></tr>
<tr><td class="h">362</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L362">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $journalu-&gt;{opt_whoscreened} eq &#39;N&#39;;</td></tr>
<tr><td class="h">363</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $journalu-&gt;{opt_whoscreened};</td></tr>
<tr><td class="h">364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">365</td><td colspan="7"></td></tr><tr><td class="h">366</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub update_commentalter {</td></tr>
<tr><td class="h">367</td><td><div class="c3">218</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L367">218</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $itemid) = @_;</td></tr>
<tr><td class="h">368</td><td><div class="c3">218</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_logprop($u, $itemid, { &#39;commentalter&#39; =&gt; time() });</td></tr>
<tr><td class="h">369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">370</td><td colspan="7"></td></tr><tr><td class="h">371</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">372</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::get_comments_in_thread</td></tr>
<tr><td class="h">373</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">374</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets a list of comment ids that are contained within a thread, including the</td></tr>
<tr><td class="h">375</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      comment at the top of the thread.  You can also limit this to only return comments</td></tr>
<tr><td class="h">376</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      of a certain state.</td></tr>
<tr><td class="h">377</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, jitemid, jtalkid, onlystate, screenedref</td></tr>
<tr><td class="h">378</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: user object of user to get comments from</td></tr>
<tr><td class="h">379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jitemid: journal itemid to get comments from</td></tr>
<tr><td class="h">380</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jtalkid: journal talkid of comment to use as top of tree</td></tr>
<tr><td class="h">381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-onlystate: if specified, return only comments of this state (e.g. A, F, S...)</td></tr>
<tr><td class="h">382</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-screenedref: if provided and an array reference, will push on a list of comment</td></tr>
<tr><td class="h">383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                   ids that are being returned and are screened (mostly for use in deletion so you can</td></tr>
<tr><td class="h">384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                   unscreen the comments)</td></tr>
<tr><td class="h">385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: undef on error, array reference of jtalkids on success</td></tr>
<tr><td class="h">386</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">387</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_comments_in_thread {</td></tr>
<tr><td class="h">388</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L388">3</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $jitemid, $jtalkid, $onlystate, $screened_ref) = @_;</td></tr>
<tr><td class="h">389</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user($u);</td></tr>
<tr><td class="h">390</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jitemid += 0;</td></tr>
<tr><td class="h">391</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jtalkid += 0;</td></tr>
<tr><td class="h">392</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$onlystate = uc $onlystate;</td></tr>
<tr><td class="h">393</td><td><div class="c3">3</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L393">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L393">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u &amp;&amp; $jitemid &amp;&amp; $jtalkid &amp;&amp;</td></tr>
<tr><td class="h">394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(!$onlystate || $onlystate =~ /^\w$/);</td></tr>
<tr><td class="h">395</td><td colspan="7"></td></tr><tr><td class="h">396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get all comments to post</td></tr>
<tr><td class="h">397</td><td><div class="c3">3</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L397">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comments = LJ::Talk::get_talk_data($u, &#39;L&#39;, $jitemid) || {};</td></tr>
<tr><td class="h">398</td><td colspan="7"></td></tr><tr><td class="h">399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# see if our comment exists</td></tr>
<tr><td class="h">400</td><td><div class="c3">3</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L400">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $comments-&gt;{$jtalkid};</td></tr>
<tr><td class="h">401</td><td colspan="7"></td></tr><tr><td class="h">402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# create relationship hashref and count screened comments in post</td></tr>
<tr><td class="h">403</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %parentids;</td></tr>
<tr><td class="h">404</td><td><div class="c3">3</div><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$parentids{$_} = $comments-&gt;{$_}{parenttalkid} foreach keys %$comments;</td></tr>
<tr><td class="h">405</td><td colspan="7"></td></tr><tr><td class="h">406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now walk and find what to update</td></tr>
<tr><td class="h">407</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %to_act;</td></tr>
<tr><td class="h">408</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $id (keys %$comments) {</td></tr>
<tr><td class="h">409</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $act = ($id == $jtalkid);</td></tr>
<tr><td class="h">410</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $walk = $id;</td></tr>
<tr><td class="h">411</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while ($parentids{$walk}) {</td></tr>
<tr><td class="h">412</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L412">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($parentids{$walk} == $jtalkid) {</td></tr>
<tr><td class="h">413</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we hit the one we want to act on</td></tr>
<tr><td class="h">414</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$act = 1;</td></tr>
<tr><td class="h">415</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last;</td></tr>
<tr><td class="h">416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">417</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L417">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $parentids{$walk} == $walk;</td></tr>
<tr><td class="h">418</td><td colspan="7"></td></tr><tr><td class="h">419</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# no match, so move up a level</td></tr>
<tr><td class="h">420</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$walk = $parentids{$walk};</td></tr>
<tr><td class="h">421</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">422</td><td colspan="7"></td></tr><tr><td class="h">423</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# set it as being acted on</td></tr>
<tr><td class="h">424</td><td><div class="c3">5</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L424">100</a></div></td><td><div class="c1"><a href="cgi-bin-talklib-pl--condition.html#L424">75</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$to_act{$id} = 1 if $act &amp;&amp; (!$onlystate || $comments-&gt;{$id}{state} eq $onlystate);</td></tr>
<tr><td class="h">425</td><td colspan="7"></td></tr><tr><td class="h">426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# push it onto the list of screened comments? (if the caller is doing a delete, they need</td></tr>
<tr><td class="h">427</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# a list of screened comments in order to unscreen them)</td></tr>
<tr><td class="h">428</td><td><div class="c3">5</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L428">50</a></div></td><td><div class="c1"><a href="cgi-bin-talklib-pl--condition.html#L428">75</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$screened_ref, $id if ref $screened_ref &amp;&amp;             # if they gave us a ref</td></tr>
<tr><td class="h">429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$to_act{$id} &amp;&amp;                  # and we&#39;re acting on this comment</td></tr>
<tr><td class="h">430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comments-&gt;{$id}{state} eq &#39;S&#39;;  # and this is a screened comment</td></tr>
<tr><td class="h">431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">432</td><td colspan="7"></td></tr><tr><td class="h">433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return list from %to_act</td></tr>
<tr><td class="h">434</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return [ keys %to_act ];</td></tr>
<tr><td class="h">435</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">436</td><td colspan="7"></td></tr><tr><td class="h">437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::delete_thread</td></tr>
<tr><td class="h">439</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Deletes an entire thread of comments.</td></tr>
<tr><td class="h">441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, jitemid, jtalkid</td></tr>
<tr><td class="h">442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: Userid or user object to delete thread from.</td></tr>
<tr><td class="h">443</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jitemid: Journal itemid of item to delete comments from.</td></tr>
<tr><td class="h">444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jtalkid: Journal talkid of comment at top of thread to delete.</td></tr>
<tr><td class="h">445</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 on success; undef on error</td></tr>
<tr><td class="h">446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_thread {</td></tr>
<tr><td class="h">448</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L448">1</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $jitemid, $jtalkid) = @_;</td></tr>
<tr><td class="h">449</td><td colspan="7"></td></tr><tr><td class="h">450</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get comments and delete &#39;em</td></tr>
<tr><td class="h">451</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @screened;</td></tr>
<tr><td class="h">452</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ids = LJ::Talk::get_comments_in_thread($u, $jitemid, $jtalkid, undef, \@screened);</td></tr>
<tr><td class="h">453</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L453">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::unscreen_comment($u, $jitemid, @screened) if @screened; # if needed only!</td></tr>
<tr><td class="h">454</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $num = LJ::delete_comments($u, &quot;L&quot;, $jitemid, @$ids);</td></tr>
<tr><td class="h">455</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::replycount_do($u, $jitemid, &quot;decr&quot;, $num);</td></tr>
<tr><td class="h">456</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::update_commentalter($u, $jitemid);</td></tr>
<tr><td class="h">457</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">458</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">459</td><td colspan="7"></td></tr><tr><td class="h">460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::delete_comment</td></tr>
<tr><td class="h">462</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">463</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Deletes a single comment.</td></tr>
<tr><td class="h">464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, jitemid, jtalkid, state?</td></tr>
<tr><td class="h">465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: Userid or user object to delete comment from.</td></tr>
<tr><td class="h">466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jitemid: Journal itemid of item to delete comment from.</td></tr>
<tr><td class="h">467</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jtalkid: Journal talkid of the comment to delete.</td></tr>
<tr><td class="h">468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-state: Optional. If you know it, provide the state</td></tr>
<tr><td class="h">469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            of the comment being deleted, else we load it.</td></tr>
<tr><td class="h">470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 on success; undef on error</td></tr>
<tr><td class="h">471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_comment {</td></tr>
<tr><td class="h">473</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L473">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $jitemid, $jtalkid, $state) = @_;</td></tr>
<tr><td class="h">474</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L474">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L474">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u &amp;&amp; $jitemid &amp;&amp; $jtalkid;</td></tr>
<tr><td class="h">475</td><td colspan="7"></td></tr><tr><td class="h">476</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L476">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($state) {</td></tr>
<tr><td class="h">477</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $td = LJ::Talk::get_talk_data($u, &#39;L&#39;, $jitemid);</td></tr>
<tr><td class="h">478</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L478">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $td;</td></tr>
<tr><td class="h">479</td><td colspan="7"></td></tr><tr><td class="h">480</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$state = $td-&gt;{$jtalkid}-&gt;{state};</td></tr>
<tr><td class="h">481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">482</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L482">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $state;</td></tr>
<tr><td class="h">483</td><td colspan="7"></td></tr><tr><td class="h">484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it&#39;s screened, unscreen it first to properly adjust logprops</td></tr>
<tr><td class="h">485</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L485">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::unscreen_comment($u, $jitemid, $jtalkid)</td></tr>
<tr><td class="h">486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $state eq &#39;S&#39;;</td></tr>
<tr><td class="h">487</td><td colspan="7"></td></tr><tr><td class="h">488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now do the deletion</td></tr>
<tr><td class="h">489</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $num = LJ::delete_comments($u, &quot;L&quot;, $jitemid, $jtalkid);</td></tr>
<tr><td class="h">490</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::replycount_do($u, $jitemid, &quot;decr&quot;, $num);</td></tr>
<tr><td class="h">491</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::update_commentalter($u, $jitemid);</td></tr>
<tr><td class="h">492</td><td colspan="7"></td></tr><tr><td class="h">493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# done</td></tr>
<tr><td class="h">494</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">496</td><td colspan="7"></td></tr><tr><td class="h">497</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::freeze_thread</td></tr>
<tr><td class="h">499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Freezes an entire thread of comments.</td></tr>
<tr><td class="h">501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, jitemid, jtalkid</td></tr>
<tr><td class="h">502</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: Userid or user object to freeze thread from.</td></tr>
<tr><td class="h">503</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jitemid: Journal itemid of item to freeze comments from.</td></tr>
<tr><td class="h">504</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jtalkid: Journal talkid of comment at top of thread to freeze.</td></tr>
<tr><td class="h">505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 on success; undef on error</td></tr>
<tr><td class="h">506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">507</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub freeze_thread {</td></tr>
<tr><td class="h">508</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L508">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $jitemid, $jtalkid) = @_;</td></tr>
<tr><td class="h">509</td><td colspan="7"></td></tr><tr><td class="h">510</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now we need to update the states</td></tr>
<tr><td class="h">511</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ids = LJ::Talk::get_comments_in_thread($u, $jitemid, $jtalkid, &#39;A&#39;);</td></tr>
<tr><td class="h">512</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::freeze_comments($u, &quot;L&quot;, $jitemid, 0, $ids);</td></tr>
<tr><td class="h">513</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">515</td><td colspan="7"></td></tr><tr><td class="h">516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">517</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::unfreeze_thread</td></tr>
<tr><td class="h">518</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: unfreezes an entire thread of comments.</td></tr>
<tr><td class="h">520</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, jitemid, jtalkid</td></tr>
<tr><td class="h">521</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: Userid or user object to unfreeze thread from.</td></tr>
<tr><td class="h">522</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jitemid: Journal itemid of item to unfreeze comments from.</td></tr>
<tr><td class="h">523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jtalkid: Journal talkid of comment at top of thread to unfreeze.</td></tr>
<tr><td class="h">524</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 on success; undef on error</td></tr>
<tr><td class="h">525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">526</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unfreeze_thread {</td></tr>
<tr><td class="h">527</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L527">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $jitemid, $jtalkid) = @_;</td></tr>
<tr><td class="h">528</td><td colspan="7"></td></tr><tr><td class="h">529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now we need to update the states</td></tr>
<tr><td class="h">530</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ids = LJ::Talk::get_comments_in_thread($u, $jitemid, $jtalkid, &#39;F&#39;);</td></tr>
<tr><td class="h">531</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::freeze_comments($u, &quot;L&quot;, $jitemid, 1, $ids);</td></tr>
<tr><td class="h">532</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">533</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">534</td><td colspan="7"></td></tr><tr><td class="h">535</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::freeze_comments</td></tr>
<tr><td class="h">537</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Freezes comments.  This is the internal helper function called by</td></tr>
<tr><td class="h">539</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      freeze_thread/unfreeze_thread.  Use those if you wish to freeze or</td></tr>
<tr><td class="h">540</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      unfreeze a thread.  This function just freezes specific comments.</td></tr>
<tr><td class="h">541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, nodetype, nodeid, unfreeze, ids</td></tr>
<tr><td class="h">542</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: Userid or object of user to manipulate comments in.</td></tr>
<tr><td class="h">543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-nodetype: Nodetype of the thing containing the specified ids.  Typically &quot;L&quot;.</td></tr>
<tr><td class="h">544</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-nodeid: Id of the node to manipulate comments from.</td></tr>
<tr><td class="h">545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-unfreeze: If 1, unfreeze instead of freeze.</td></tr>
<tr><td class="h">546</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-ids: Array reference containing jtalkids to manipulate.</td></tr>
<tr><td class="h">547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 on success; undef on error</td></tr>
<tr><td class="h">548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">549</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub freeze_comments {</td></tr>
<tr><td class="h">550</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L550">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $nodetype, $nodeid, $unfreeze, $ids) = @_;</td></tr>
<tr><td class="h">551</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user($u);</td></tr>
<tr><td class="h">552</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$nodeid += 0;</td></tr>
<tr><td class="h">553</td><td><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L553">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$unfreeze = $unfreeze ? 1 : 0;</td></tr>
<tr><td class="h">554</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L554">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L554">20</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::isu($u) &amp;&amp; $nodetype =~ /^\w$/ &amp;&amp; $nodeid &amp;&amp; @$ids;</td></tr>
<tr><td class="h">555</td><td colspan="7"></td></tr><tr><td class="h">556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get database and quote things</td></tr>
<tr><td class="h">557</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L557">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u-&gt;writer;</td></tr>
<tr><td class="h">558</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $quserid = $u-&gt;{userid}+0;</td></tr>
<tr><td class="h">559</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qnodetype = $u-&gt;quote($nodetype);</td></tr>
<tr><td class="h">560</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qnodeid = $nodeid+0;</td></tr>
<tr><td class="h">561</td><td colspan="7"></td></tr><tr><td class="h">562</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now perform action</td></tr>
<tr><td class="h">563</td><td><div class="c3">2</div><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&#39;,&#39;, map { $_+0 } @$ids);</td></tr>
<tr><td class="h">564</td><td><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L564">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $newstate = $unfreeze ? &#39;A&#39; : &#39;F&#39;;</td></tr>
<tr><td class="h">565</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = $u-&gt;talk2_do($nodetype, $nodeid, undef,</td></tr>
<tr><td class="h">566</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;UPDATE talk2 SET state = &#39;$newstate&#39; &quot; .</td></tr>
<tr><td class="h">567</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid = $quserid AND nodetype = $qnodetype &quot; .</td></tr>
<tr><td class="h">568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND nodeid = $qnodeid AND jtalkid IN ($in)&quot;);</td></tr>
<tr><td class="h">569</td><td colspan="7"></td></tr><tr><td class="h">570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# invalidate talk2row memcache props</td></tr>
<tr><td class="h">571</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::invalidate_talk2row_memcache($u-&gt;id, @$ids);</td></tr>
<tr><td class="h">572</td><td colspan="7"></td></tr><tr><td class="h">573</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L573">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $res;</td></tr>
<tr><td class="h">574</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">575</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">576</td><td colspan="7"></td></tr><tr><td class="h">577</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub screen_comment {</td></tr>
<tr><td class="h">578</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L578">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">579</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L579">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::isu($u);</td></tr>
<tr><td class="h">580</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemid = shift(@_) + 0;</td></tr>
<tr><td class="h">581</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @jtalkids = @_;</td></tr>
<tr><td class="h">582</td><td colspan="7"></td></tr><tr><td class="h">583</td><td><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $in = join (&#39;,&#39;, map { $_+0 } @jtalkids);</td></tr>
<tr><td class="h">584</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L584">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $in;</td></tr>
<tr><td class="h">585</td><td colspan="7"></td></tr><tr><td class="h">586</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;{&#39;userid&#39;} + 0;</td></tr>
<tr><td class="h">587</td><td colspan="7"></td></tr><tr><td class="h">588</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $updated = $u-&gt;talk2_do(&quot;L&quot;, $itemid, undef,</td></tr>
<tr><td class="h">589</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;UPDATE talk2 SET state=&#39;S&#39; &quot;.</td></tr>
<tr><td class="h">590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$userid AND jtalkid IN ($in) &quot;.</td></tr>
<tr><td class="h">591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND nodetype=&#39;L&#39; AND nodeid=$itemid &quot;.</td></tr>
<tr><td class="h">592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND state NOT IN (&#39;S&#39;,&#39;D&#39;)&quot;);</td></tr>
<tr><td class="h">593</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L593">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $updated;</td></tr>
<tr><td class="h">594</td><td colspan="7"></td></tr><tr><td class="h">595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# invalidate talk2row memcache props</td></tr>
<tr><td class="h">596</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::invalidate_talk2row_memcache($u-&gt;id, @jtalkids);</td></tr>
<tr><td class="h">597</td><td colspan="7"></td></tr><tr><td class="h">598</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L598">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($updated &gt; 0) {</td></tr>
<tr><td class="h">599</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::replycount_do($u, $itemid, &quot;decr&quot;, $updated);</td></tr>
<tr><td class="h">600</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_logprop($u, $itemid, { &#39;hasscreened&#39; =&gt; 1 });</td></tr>
<tr><td class="h">601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">602</td><td colspan="7"></td></tr><tr><td class="h">603</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::update_commentalter($u, $itemid);</td></tr>
<tr><td class="h">604</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">606</td><td colspan="7"></td></tr><tr><td class="h">607</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unscreen_comment {</td></tr>
<tr><td class="h">608</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L608">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">609</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L609">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::isu($u);</td></tr>
<tr><td class="h">610</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemid = shift(@_) + 0;</td></tr>
<tr><td class="h">611</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @jtalkids = @_;</td></tr>
<tr><td class="h">612</td><td colspan="7"></td></tr><tr><td class="h">613</td><td><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $in = join (&#39;,&#39;, map { $_+0 } @jtalkids);</td></tr>
<tr><td class="h">614</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L614">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $in;</td></tr>
<tr><td class="h">615</td><td colspan="7"></td></tr><tr><td class="h">616</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;{&#39;userid&#39;} + 0;</td></tr>
<tr><td class="h">617</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop = LJ::get_prop(&quot;log&quot;, &quot;hasscreened&quot;);</td></tr>
<tr><td class="h">618</td><td colspan="7"></td></tr><tr><td class="h">619</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $updated = $u-&gt;talk2_do(&quot;L&quot;, $itemid, undef,</td></tr>
<tr><td class="h">620</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;UPDATE talk2 SET state=&#39;A&#39; &quot;.</td></tr>
<tr><td class="h">621</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$userid AND jtalkid IN ($in) &quot;.</td></tr>
<tr><td class="h">622</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND nodetype=&#39;L&#39; AND nodeid=$itemid &quot;.</td></tr>
<tr><td class="h">623</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND state=&#39;S&#39;&quot;);</td></tr>
<tr><td class="h">624</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L624">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $updated;</td></tr>
<tr><td class="h">625</td><td colspan="7"></td></tr><tr><td class="h">626</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::invalidate_talk2row_memcache($u-&gt;id, @jtalkids);</td></tr>
<tr><td class="h">627</td><td colspan="7"></td></tr><tr><td class="h">628</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L628">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($updated &gt; 0) {</td></tr>
<tr><td class="h">629</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::replycount_do($u, $itemid, &quot;incr&quot;, $updated);</td></tr>
<tr><td class="h">630</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = LJ::get_cluster_master($u);</td></tr>
<tr><td class="h">631</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $hasscreened = $dbcm-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM talk2 &quot; .</td></tr>
<tr><td class="h">632</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$userid AND nodeid=$itemid AND nodetype=&#39;L&#39; AND state=&#39;S&#39;&quot;);</td></tr>
<tr><td class="h">633</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L633">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_logprop($u, $itemid, { &#39;hasscreened&#39; =&gt; 0 }) unless $hasscreened;</td></tr>
<tr><td class="h">634</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">635</td><td colspan="7"></td></tr><tr><td class="h">636</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::update_commentalter($u, $itemid);</td></tr>
<tr><td class="h">637</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">639</td><td colspan="7"></td></tr><tr><td class="h">640</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># retrieves data from the talk2 table (but preferably memcache)</td></tr>
<tr><td class="h">641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a hashref (key -&gt; { &#39;talkid&#39;, &#39;posterid&#39;, &#39;datepost&#39;, &#39;datepost_unix&#39;,</td></tr>
<tr><td class="h">642</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                             &#39;parenttalkid&#39;, &#39;state&#39; } , or undef on failure</td></tr>
<tr><td class="h">643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_talk_data</td></tr>
<tr><td class="h">644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">645</td><td><div class="c3">12</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L645">12</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $nodetype, $nodeid) = @_;</td></tr>
<tr><td class="h">646</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L646">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::isu($u);</td></tr>
<tr><td class="h">647</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L647">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $nodetype =~ /^\w$/;</td></tr>
<tr><td class="h">648</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L648">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $nodeid =~ /^\d+$/;</td></tr>
<tr><td class="h">649</td><td colspan="7"></td></tr><tr><td class="h">650</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = {};</td></tr>
<tr><td class="h">651</td><td colspan="7"></td></tr><tr><td class="h">652</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check for data in memcache</td></tr>
<tr><td class="h">653</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $DATAVER = &quot;1&quot;;  # single character</td></tr>
<tr><td class="h">654</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;{&#39;userid&#39;}, &quot;talk2:$u-&gt;{&#39;userid&#39;}:$nodetype:$nodeid&quot;];</td></tr>
<tr><td class="h">655</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lockkey = $memkey-&gt;[1];</td></tr>
<tr><td class="h">656</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $packed = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">657</td><td colspan="7"></td></tr><tr><td class="h">658</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we check the replycount in memcache, the value we count, and then fix it up</td></tr>
<tr><td class="h">659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it seems necessary.</td></tr>
<tr><td class="h">660</td><td><div class="c3">12</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L660">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rp_memkey = $nodetype eq &quot;L&quot; ? [$u-&gt;{&#39;userid&#39;}, &quot;rp:$u-&gt;{&#39;userid&#39;}:$nodeid&quot;] : undef;</td></tr>
<tr><td class="h">661</td><td><div class="c3">12</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L661">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rp_count = $rp_memkey ? LJ::MemCache::get($rp_memkey) : 0;</td></tr>
<tr><td class="h">662</td><td><div class="c3">12</div></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--condition.html#L662">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rp_count ||= 0; # avoid warnings, FIXME how can LJ::MemCache::get return undef or sg that is not undef?</td></tr>
<tr><td class="h">663</td><td colspan="7"></td></tr><tr><td class="h">664</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# hook for tests to count memcache gets</td></tr>
<tr><td class="h">665</td><td><div class="c3">12</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L665">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::_T_GET_TALK_DATA_MEMCACHE) {</td></tr>
<tr><td class="h">666</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::_T_GET_TALK_DATA_MEMCACHE-&gt;();</td></tr>
<tr><td class="h">667</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">668</td><td colspan="7"></td></tr><tr><td class="h">669</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rp_ourcount = 0;</td></tr>
<tr><td class="h">670</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $fixup_rp = sub {</td></tr>
<tr><td class="h">671</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L671">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L671">12</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless $nodetype eq &quot;L&quot;;</td></tr>
<tr><td class="h">672</td><td><div class="c3">12</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L672">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return if $rp_count == $rp_ourcount;</td></tr>
<tr><td class="h">673</td><td><div class="c3">5</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L673">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless @LJ::MEMCACHE_SERVERS;</td></tr>
<tr><td class="h">674</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L674">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless $u-&gt;writer;</td></tr>
<tr><td class="h">675</td><td colspan="7"></td></tr><tr><td class="h">676</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $gc = LJ::gearman_client();</td></tr>
<tr><td class="h">677</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L677">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L677">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($gc &amp;&amp; LJ::conf_test($LJ::FIXUP_USING_GEARMAN, $u)) {</td></tr>
<tr><td class="h">678</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$gc-&gt;dispatch_background(&quot;fixup_logitem_replycount&quot;,</td></tr>
<tr><td class="h">679</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Storable::nfreeze([ $u-&gt;id, $nodeid ]), {</td></tr>
<tr><td class="h">680</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uniq =&gt; &quot;-&quot;,</td></tr>
<tr><td class="h">681</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">682</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">683</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::fixup_logitem_replycount($u, $nodeid);</td></tr>
<tr><td class="h">684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">685</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">686</td><td colspan="7"></td></tr><tr><td class="h">687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $make_comment_singleton = sub {</td></tr>
<tr><td class="h">688</td><td><div class="c3">194</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L688">194</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($jtalkid, $row) = @_;</td></tr>
<tr><td class="h">689</td><td><div class="c3">194</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L689">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $nodetype eq &#39;L&#39;;</td></tr>
<tr><td class="h">690</td><td colspan="7"></td></tr><tr><td class="h">691</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# at this point we have data for this comment loaded in memory</td></tr>
<tr><td class="h">692</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# -- instantiate an LJ::Comment object as a singleton and absorb</td></tr>
<tr><td class="h">693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#    that data into the object</td></tr>
<tr><td class="h">694</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $comment = LJ::Comment-&gt;new($u, jtalkid =&gt; $jtalkid);</td></tr>
<tr><td class="h">695</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# add important info to row</td></tr>
<tr><td class="h">696</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row-&gt;{nodetype} = $nodetype;</td></tr>
<tr><td class="h">697</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row-&gt;{nodeid}   = $nodeid;</td></tr>
<tr><td class="h">698</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;absorb_row(%$row);</td></tr>
<tr><td class="h">699</td><td colspan="7"></td></tr><tr><td class="h">700</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">701</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">702</td><td colspan="7"></td></tr><tr><td class="h">703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# This is a bit tricky.  Since we just loaded and instantiated all comment singletons for this</td></tr>
<tr><td class="h">704</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# entry (journalid, jitemid) we&#39;ll instantiate a skeleton LJ::Entry object (probably a singleton</td></tr>
<tr><td class="h">705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# used later in this request anyway) and let it know that its comments are already loaded</td></tr>
<tr><td class="h">706</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $set_entry_cache = sub {</td></tr>
<tr><td class="h">707</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L707">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L707">12</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $nodetype eq &#39;L&#39;;</td></tr>
<tr><td class="h">708</td><td colspan="7"></td></tr><tr><td class="h">709</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new($u, jitemid =&gt; $nodeid);</td></tr>
<tr><td class="h">710</td><td colspan="7"></td></tr><tr><td class="h">711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# find all singletons that LJ::Comment knows about, then grep for the ones we&#39;ve set in</td></tr>
<tr><td class="h">712</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# this get_talk_data call (ones for this userid / nodeid)</td></tr>
<tr><td class="h">713</td><td><div class="c3">428</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L713">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @comments_for_entry = </td></tr>
<tr><td class="h">714</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { $_-&gt;journalid == $u-&gt;{userid} &amp;&amp; $_-&gt;nodeid == $nodeid } LJ::Comment-&gt;all_singletons;</td></tr>
<tr><td class="h">715</td><td colspan="7"></td></tr><tr><td class="h">716</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;set_comment_list(@comments_for_entry);</td></tr>
<tr><td class="h">717</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">718</td><td colspan="7"></td></tr><tr><td class="h">719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memcache_good = sub {</td></tr>
<tr><td class="h">720</td><td><div class="c3">24</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L720">25</a></div></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L720">24</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $packed &amp;&amp; substr($packed,0,1) eq $DATAVER &amp;&amp;</td></tr>
<tr><td class="h">721</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;length($packed) % 16 == 1;</td></tr>
<tr><td class="h">722</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">723</td><td colspan="7"></td></tr><tr><td class="h">724</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memcache_decode = sub {</td></tr>
<tr><td class="h">725</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L725">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $n = (length($packed) - 1) / 16;</td></tr>
<tr><td class="h">726</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (my $i=0; $i&lt;$n; $i++) {</td></tr>
<tr><td class="h">727</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($f1, $par, $poster, $time) = unpack(&quot;NNNN&quot;,substr($packed,$i*16+1,16));</td></tr>
<tr><td class="h">728</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $state = chr($f1 &amp; 255);</td></tr>
<tr><td class="h">729</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $talkid = $f1 &gt;&gt; 8;</td></tr>
<tr><td class="h">730</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{$talkid} = {</td></tr>
<tr><td class="h">731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;talkid =&gt; $talkid,</td></tr>
<tr><td class="h">732</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state =&gt; $state,</td></tr>
<tr><td class="h">733</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;posterid =&gt; $poster,</td></tr>
<tr><td class="h">734</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datepost_unix =&gt; $time,</td></tr>
<tr><td class="h">735</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datepost =&gt; LJ::mysql_time($time),  # timezone surely fucked.  deprecated.</td></tr>
<tr><td class="h">736</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parenttalkid =&gt; $par,</td></tr>
<tr><td class="h">737</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">738</td><td colspan="7"></td></tr><tr><td class="h">739</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# instantiate comment singleton</td></tr>
<tr><td class="h">740</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_comment_singleton-&gt;($talkid, $ret-&gt;{$talkid});</td></tr>
<tr><td class="h">741</td><td colspan="7"></td></tr><tr><td class="h">742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# comments are counted if they&#39;re &#39;A&#39;pproved or &#39;F&#39;rozen</td></tr>
<tr><td class="h">743</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L743">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L743">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rp_ourcount++ if $state eq &quot;A&quot; || $state eq &quot;F&quot;;</td></tr>
<tr><td class="h">744</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">745</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fixup_rp-&gt;();</td></tr>
<tr><td class="h">746</td><td colspan="7"></td></tr><tr><td class="h">747</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# set cache in LJ::Entry object for this set of comments</td></tr>
<tr><td class="h">748</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$set_entry_cache-&gt;();</td></tr>
<tr><td class="h">749</td><td colspan="7"></td></tr><tr><td class="h">750</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">751</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">752</td><td colspan="7"></td></tr><tr><td class="h">753</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L753">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $memcache_decode-&gt;() if $memcache_good-&gt;();</td></tr>
<tr><td class="h">754</td><td colspan="7"></td></tr><tr><td class="h">755</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u);</td></tr>
<tr><td class="h">756</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L756">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $dbcr;</td></tr>
<tr><td class="h">757</td><td colspan="7"></td></tr><tr><td class="h">758</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lock = $dbcr-&gt;selectrow_array(&quot;SELECT GET_LOCK(?,10)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">759</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L759">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $lock;</td></tr>
<tr><td class="h">760</td><td colspan="7"></td></tr><tr><td class="h">761</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# it&#39;s quite likely (for a popular post) that the memcache was</td></tr>
<tr><td class="h">762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# already populated while we were waiting for the lock</td></tr>
<tr><td class="h">763</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$packed = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">764</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L764">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($memcache_good-&gt;()) {</td></tr>
<tr><td class="h">765</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbcr-&gt;selectrow_array(&quot;SELECT RELEASE_LOCK(?)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">766</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$memcache_decode-&gt;();</td></tr>
<tr><td class="h">767</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">768</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">769</td><td colspan="7"></td></tr><tr><td class="h">770</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memval = $DATAVER;</td></tr>
<tr><td class="h">771</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbcr-&gt;prepare(&quot;SELECT t.jtalkid AS &#39;talkid&#39;, t.posterid, &quot;.</td></tr>
<tr><td class="h">772</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;t.datepost, UNIX_TIMESTAMP(t.datepost) as &#39;datepost_unix&#39;, &quot;.</td></tr>
<tr><td class="h">773</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;t.parenttalkid, t.state &quot;.</td></tr>
<tr><td class="h">774</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM talk2 t &quot;.</td></tr>
<tr><td class="h">775</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE t.journalid=? AND t.nodetype=? AND t.nodeid=?&quot;);</td></tr>
<tr><td class="h">776</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($u-&gt;{&#39;userid&#39;}, $nodetype, $nodeid);</td></tr>
<tr><td class="h">777</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L777">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die $dbcr-&gt;errstr if $dbcr-&gt;err;</td></tr>
<tr><td class="h">778</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my $r = $sth-&gt;fetchrow_hashref) {</td></tr>
<tr><td class="h">779</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{$r-&gt;{&#39;talkid&#39;}} = $r;</td></tr>
<tr><td class="h">780</td><td colspan="7"></td></tr><tr><td class="h">781</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">782</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# make a new $r-type hash which also contains nodetype and nodeid</td></tr>
<tr><td class="h">783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# -- they&#39;re not in $r because they were known and specified in the query</td></tr>
<tr><td class="h">784</td><td><div class="c3">194</div><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %row_arg = %$r;</td></tr>
<tr><td class="h">785</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row_arg{nodeid}   = $nodeid;</td></tr>
<tr><td class="h">786</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row_arg{nodetype} = $nodetype;</td></tr>
<tr><td class="h">787</td><td colspan="7"></td></tr><tr><td class="h">788</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# instantiate comment singleton</td></tr>
<tr><td class="h">789</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_comment_singleton-&gt;($r-&gt;{talkid}, \%row_arg);</td></tr>
<tr><td class="h">790</td><td colspan="7"></td></tr><tr><td class="h">791</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# set talk2row memcache key for this bit of data</td></tr>
<tr><td class="h">792</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::add_talk2row_memcache($u-&gt;id, $r-&gt;{talkid}, \%row_arg);</td></tr>
<tr><td class="h">793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">794</td><td colspan="7"></td></tr><tr><td class="h">795</td><td><div class="c3">194</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$memval .= pack(&quot;NNNN&quot;,</td></tr>
<tr><td class="h">796</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($r-&gt;{&#39;talkid&#39;} &lt;&lt; 8) + ord($r-&gt;{&#39;state&#39;}),</td></tr>
<tr><td class="h">797</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;parenttalkid&#39;},</td></tr>
<tr><td class="h">798</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;posterid&#39;},</td></tr>
<tr><td class="h">799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;datepost_unix&#39;});</td></tr>
<tr><td class="h">800</td><td colspan="7"></td></tr><tr><td class="h">801</td><td><div class="c3">194</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L801">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rp_ourcount++ if $r-&gt;{&#39;state&#39;} eq &quot;A&quot;;</td></tr>
<tr><td class="h">802</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">803</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $memval);</td></tr>
<tr><td class="h">804</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbcr-&gt;selectrow_array(&quot;SELECT RELEASE_LOCK(?)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">805</td><td colspan="7"></td></tr><tr><td class="h">806</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$fixup_rp-&gt;();</td></tr>
<tr><td class="h">807</td><td colspan="7"></td></tr><tr><td class="h">808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set cache in LJ::Entry object for this set of comments</td></tr>
<tr><td class="h">809</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$set_entry_cache-&gt;();</td></tr>
<tr><td class="h">810</td><td colspan="7"></td></tr><tr><td class="h">811</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">813</td><td colspan="7"></td></tr><tr><td class="h">814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub fixup_logitem_replycount {</td></tr>
<tr><td class="h">815</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L815">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $jitemid) = @_;</td></tr>
<tr><td class="h">816</td><td colspan="7"></td></tr><tr><td class="h">817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# attempt to get a database lock to make sure that nobody else is in this section</td></tr>
<tr><td class="h">818</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# at the same time we are</td></tr>
<tr><td class="h">819</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $nodetype = &quot;L&quot;;  # this is only for logitem comment counts</td></tr>
<tr><td class="h">820</td><td colspan="7"></td></tr><tr><td class="h">821</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rp_memkey = [$u-&gt;{&#39;userid&#39;}, &quot;rp:$u-&gt;{&#39;userid&#39;}:$jitemid&quot;];</td></tr>
<tr><td class="h">822</td><td><div class="c3">2</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L822">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rp_count = LJ::MemCache::get($rp_memkey) || 0;</td></tr>
<tr><td class="h">823</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $fix_key = &quot;rp_fixed:$u-&gt;{userid}:$nodetype:$jitemid:$rp_count&quot;;</td></tr>
<tr><td class="h">824</td><td colspan="7"></td></tr><tr><td class="h">825</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db_key = &quot;rp:fix:$u-&gt;{userid}:$nodetype:$jitemid&quot;;</td></tr>
<tr><td class="h">826</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $got_lock = $u-&gt;selectrow_array(&quot;SELECT GET_LOCK(?, 1)&quot;, undef, $db_key);</td></tr>
<tr><td class="h">827</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L827">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $got_lock;</td></tr>
<tr><td class="h">828</td><td colspan="7"></td></tr><tr><td class="h">829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# setup an unlock handler</td></tr>
<tr><td class="h">830</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $unlock = sub {</td></tr>
<tr><td class="h">831</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L831">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;SELECT RELEASE_LOCK(?)&quot;, undef, $db_key);</td></tr>
<tr><td class="h">832</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">833</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">834</td><td colspan="7"></td></tr><tr><td class="h">835</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check memcache to see if someone has previously fixed this entry in this journal</td></tr>
<tr><td class="h">836</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# with this reply count</td></tr>
<tr><td class="h">837</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $was_fixed = LJ::MemCache::get($fix_key);</td></tr>
<tr><td class="h">838</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L838">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $unlock-&gt;() if $was_fixed;</td></tr>
<tr><td class="h">839</td><td colspan="7"></td></tr><tr><td class="h">840</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we&#39;re doing innodb, begin a transaction, else lock tables</td></tr>
<tr><td class="h">841</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sharedmode = &quot;&quot;;</td></tr>
<tr><td class="h">842</td><td><div class="c3">2</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L842">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_innodb) {</td></tr>
<tr><td class="h">843</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sharedmode = &quot;LOCK IN SHARE MODE&quot;;</td></tr>
<tr><td class="h">844</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;begin_work;</td></tr>
<tr><td class="h">845</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">846</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;LOCK TABLES log2 WRITE, talk2 READ&quot;);</td></tr>
<tr><td class="h">847</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">848</td><td colspan="7"></td></tr><tr><td class="h">849</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get count and then update.  this should be totally safe because we&#39;ve either</td></tr>
<tr><td class="h">850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# locked the tables or we&#39;re in a transaction.</td></tr>
<tr><td class="h">851</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ct = $u-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM talk2 FORCE INDEX (nodetype) WHERE &quot;.</td></tr>
<tr><td class="h">852</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;journalid=? AND nodetype=&#39;L&#39; AND nodeid=? &quot;.</td></tr>
<tr><td class="h">853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND state IN (&#39;A&#39;,&#39;F&#39;) $sharedmode&quot;,</td></tr>
<tr><td class="h">854</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{&#39;userid&#39;}, $jitemid);</td></tr>
<tr><td class="h">855</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;UPDATE log2 SET replycount=? WHERE journalid=? AND jitemid=?&quot;,</td></tr>
<tr><td class="h">856</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, int($ct), $u-&gt;{&#39;userid&#39;}, $jitemid);</td></tr>
<tr><td class="h">857</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L857">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;Fixing replycount for $u-&gt;{&#39;userid&#39;}/$jitemid from $rp_count to $ct\n&quot;</td></tr>
<tr><td class="h">858</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $LJ::DEBUG{&#39;replycount_fix&#39;};</td></tr>
<tr><td class="h">859</td><td colspan="7"></td></tr><tr><td class="h">860</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now, commit or unlock as appropriate</td></tr>
<tr><td class="h">861</td><td><div class="c3">2</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L861">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_innodb) {</td></tr>
<tr><td class="h">862</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;commit;</td></tr>
<tr><td class="h">863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">864</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;UNLOCK TABLES&quot;);</td></tr>
<tr><td class="h">865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">866</td><td colspan="7"></td></tr><tr><td class="h">867</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# mark it as fixed in memcache, so we don&#39;t do this again</td></tr>
<tr><td class="h">868</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add($fix_key, 1, 60);</td></tr>
<tr><td class="h">869</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$unlock-&gt;();</td></tr>
<tr><td class="h">870</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($rp_memkey, int($ct));</td></tr>
<tr><td class="h">871</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">872</td><td colspan="7"></td></tr><tr><td class="h">873</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># LJ::Talk::load_comments($u, $remote, $nodetype, $nodeid, $opts)</td></tr>
<tr><td class="h">874</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">875</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># nodetype: &quot;L&quot; (for log) ... nothing else has been used</td></tr>
<tr><td class="h">876</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># noteid: the jitemid for log.</td></tr>
<tr><td class="h">877</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># opts keys:</td></tr>
<tr><td class="h">878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   thread -- jtalkid to thread from ($init-&gt;{&#39;thread&#39;} or $GET{&#39;thread&#39;} &gt;&gt; 8)</td></tr>
<tr><td class="h">879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   page -- $GET{&#39;page&#39;}</td></tr>
<tr><td class="h">880</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   view -- $GET{&#39;view&#39;} (picks page containing view&#39;s ditemid)</td></tr>
<tr><td class="h">881</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   flat -- boolean:  if set, threading isn&#39;t done, and it&#39;s just a flat chrono view</td></tr>
<tr><td class="h">882</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   up -- [optional] hashref of user object who posted the thing being replied to</td></tr>
<tr><td class="h">883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#         only used to make things visible which would otherwise be screened?</td></tr>
<tr><td class="h">884</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   out_error -- set by us if there&#39;s an error code:</td></tr>
<tr><td class="h">885</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#        nodb:  database unavailable</td></tr>
<tr><td class="h">886</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#        noposts:  no posts to load</td></tr>
<tr><td class="h">887</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   out_pages:  number of pages</td></tr>
<tr><td class="h">888</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   out_page:  page number being viewed</td></tr>
<tr><td class="h">889</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   out_itemfirst:  first comment number on page (1-based, not db numbers)</td></tr>
<tr><td class="h">890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   out_itemlast:  last comment number on page (1-based, not db numbers)</td></tr>
<tr><td class="h">891</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   out_pagesize:  size of each page</td></tr>
<tr><td class="h">892</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   out_items:  number of total top level items</td></tr>
<tr><td class="h">893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">894</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   userpicref -- hashref to load userpics into, or undef to</td></tr>
<tr><td class="h">895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                 not load them.</td></tr>
<tr><td class="h">896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   userref -- hashref to load users into, keyed by userid</td></tr>
<tr><td class="h">897</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">898</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns:</td></tr>
<tr><td class="h">899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   array of hashrefs containing keys:</td></tr>
<tr><td class="h">900</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - talkid (jtalkid)</td></tr>
<tr><td class="h">901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - posterid (or zero for anon)</td></tr>
<tr><td class="h">902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - userpost (string, or blank if anon)</td></tr>
<tr><td class="h">903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - upost    ($u object, or undef if anon)</td></tr>
<tr><td class="h">904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - datepost (mysql format)</td></tr>
<tr><td class="h">905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - parenttalkid (or zero for top-level)</td></tr>
<tr><td class="h">906</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - parenttalkid_actual (set when the $flat mode is set, in which case parenttalkid is always faked to be 0)</td></tr>
<tr><td class="h">907</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - state (&quot;A&quot;=approved, &quot;S&quot;=screened, &quot;D&quot;=deleted stub)</td></tr>
<tr><td class="h">908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - userpic number</td></tr>
<tr><td class="h">909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - picid   (if userpicref AND userref were given)</td></tr>
<tr><td class="h">910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - subject</td></tr>
<tr><td class="h">911</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - body</td></tr>
<tr><td class="h">912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - props =&gt; { propname =&gt; value, ... }</td></tr>
<tr><td class="h">913</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - children =&gt; [ hashrefs like these ]</td></tr>
<tr><td class="h">914</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - _loaded =&gt; 1 (if fully loaded, subject &amp; body)</td></tr>
<tr><td class="h">915</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#        unknown items will never be _loaded</td></tr>
<tr><td class="h">916</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      - _show =&gt; {0|1}, if item is to be ideally shown (0 if deleted or screened)</td></tr>
<tr><td class="h">917</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_comments</td></tr>
<tr><td class="h">918</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">919</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L919">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $remote, $nodetype, $nodeid, $opts) = @_;</td></tr>
<tr><td class="h">920</td><td colspan="7"></td></tr><tr><td class="h">921</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $n = $u-&gt;{&#39;clusterid&#39;};</td></tr>
<tr><td class="h">922</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $viewall = $opts-&gt;{viewall};</td></tr>
<tr><td class="h">923</td><td colspan="7"></td></tr><tr><td class="h">924</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posts = get_talk_data($u, $nodetype, $nodeid);  # hashref, talkid -&gt; talk2 row, or undef</td></tr>
<tr><td class="h">925</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L925">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($posts) {</td></tr>
<tr><td class="h">926</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;out_error&#39;} = &quot;nodb&quot;;</td></tr>
<tr><td class="h">927</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">929</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %users_to_load;  # userid -&gt; 1</td></tr>
<tr><td class="h">930</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @posts_to_load;  # talkid scalars</td></tr>
<tr><td class="h">931</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %children;       # talkid -&gt; [ childenids+ ]</td></tr>
<tr><td class="h">932</td><td colspan="7"></td></tr><tr><td class="h">933</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L933">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uposterid = $opts-&gt;{&#39;up&#39;} ? $opts-&gt;{&#39;up&#39;}-&gt;{&#39;userid&#39;} : 0;</td></tr>
<tr><td class="h">934</td><td colspan="7"></td></tr><tr><td class="h">935</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $post_count = 0;</td></tr>
<tr><td class="h">936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">937</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %showable_children;  # $id -&gt; $count</td></tr>
<tr><td class="h">938</td><td colspan="7"></td></tr><tr><td class="h">939</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $post (sort { $b-&gt;{&#39;talkid&#39;} &lt;=&gt; $a-&gt;{&#39;talkid&#39;} } values %$posts) {</td></tr>
<tr><td class="h">940</td><td colspan="7"></td></tr><tr><td class="h">941</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# kill the threading in flat mode</td></tr>
<tr><td class="h">942</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L942">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;flat&#39;}) {</td></tr>
<tr><td class="h">943</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post-&gt;{&#39;parenttalkid_actual&#39;} = $post-&gt;{&#39;parenttalkid&#39;};</td></tr>
<tr><td class="h">944</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post-&gt;{&#39;parenttalkid&#39;} = 0;</td></tr>
<tr><td class="h">945</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">946</td><td colspan="7"></td></tr><tr><td class="h">947</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# see if we should ideally show it or not.  even if it&#39;s</td></tr>
<tr><td class="h">948</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# zero, we&#39;ll still show it if it has any children (but we won&#39;t show content)</td></tr>
<tr><td class="h">949</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L949">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $should_show = $post-&gt;{&#39;state&#39;} eq &#39;D&#39; ? 0 : 1;</td></tr>
<tr><td class="h">950</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L950">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($viewall) {</td></tr>
<tr><td class="h">951</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L951">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L951">0</a></div><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L951">0</a></div><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L951">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$should_show = 0 if</td></tr>
<tr><td class="h">952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post-&gt;{&#39;state&#39;} eq &quot;S&quot; &amp;&amp; ! ($remote &amp;&amp; ($remote-&gt;{&#39;userid&#39;} == $uposterid ||</td></tr>
<tr><td class="h">953</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote-&gt;{&#39;userid&#39;} == $post-&gt;{&#39;posterid&#39;} ||</td></tr>
<tr><td class="h">954</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::can_manage($remote, $u) ));</td></tr>
<tr><td class="h">955</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">956</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post-&gt;{&#39;_show&#39;} = $should_show;</td></tr>
<tr><td class="h">957</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post_count += $should_show;</td></tr>
<tr><td class="h">958</td><td colspan="7"></td></tr><tr><td class="h">959</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# make any post top-level if it says it has a parent but it isn&#39;t</td></tr>
<tr><td class="h">960</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# loaded yet which means either a) row in database is gone, or b)</td></tr>
<tr><td class="h">961</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# somebody maliciously/accidentally made their parent be a future</td></tr>
<tr><td class="h">962</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# post, which could result in an infinite loop, which we don&#39;t want.</td></tr>
<tr><td class="h">963</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L963">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L963">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post-&gt;{&#39;parenttalkid&#39;} = 0</td></tr>
<tr><td class="h">964</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $post-&gt;{&#39;parenttalkid&#39;} &amp;&amp; ! $posts-&gt;{$post-&gt;{&#39;parenttalkid&#39;}};</td></tr>
<tr><td class="h">965</td><td colspan="7"></td></tr><tr><td class="h">966</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L966">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post-&gt;{&#39;children&#39;} = [ map { $posts-&gt;{$_} } @{$children{$post-&gt;{&#39;talkid&#39;}} || []} ];</td></tr>
<tr><td class="h">967</td><td colspan="7"></td></tr><tr><td class="h">968</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# increment the parent post&#39;s number of showable children,</td></tr>
<tr><td class="h">969</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# which is our showability plus all those of our children</td></tr>
<tr><td class="h">970</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# which were already computed, since we&#39;re working new to old</td></tr>
<tr><td class="h">971</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# and children are always newer.</td></tr>
<tr><td class="h">972</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# then, if we or our children are showable, add us to the child list</td></tr>
<tr><td class="h">973</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sum = $should_show + $showable_children{$post-&gt;{&#39;talkid&#39;}};</td></tr>
<tr><td class="h">974</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L974">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($sum) {</td></tr>
<tr><td class="h">975</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$showable_children{$post-&gt;{&#39;parenttalkid&#39;}} += $sum;</td></tr>
<tr><td class="h">976</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unshift @{$children{$post-&gt;{&#39;parenttalkid&#39;}}}, $post-&gt;{&#39;talkid&#39;};</td></tr>
<tr><td class="h">977</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">978</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">979</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">980</td><td colspan="7"></td></tr><tr><td class="h">981</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# with a wrong thread number, silently default to the whole page</td></tr>
<tr><td class="h">982</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $thread = $opts-&gt;{&#39;thread&#39;}+0;</td></tr>
<tr><td class="h">983</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L983">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$thread = 0 unless $posts-&gt;{$thread};</td></tr>
<tr><td class="h">984</td><td colspan="7"></td></tr><tr><td class="h">985</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L985">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L985">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($thread || $children{$thread}) {</td></tr>
<tr><td class="h">986</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;out_error&#39;} = &quot;noposts&quot;;</td></tr>
<tr><td class="h">987</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">988</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">989</td><td colspan="7"></td></tr><tr><td class="h">990</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L990">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $page_size = $LJ::TALK_PAGE_SIZE || 25;</td></tr>
<tr><td class="h">991</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L991">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $max_subjects = $LJ::TALK_MAX_SUBJECTS || 200;</td></tr>
<tr><td class="h">992</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L992">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $threading_point = $LJ::TALK_THREAD_POINT || 50;</td></tr>
<tr><td class="h">993</td><td colspan="7"></td></tr><tr><td class="h">994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we let the page size initially get bigger than normal for awhile,</td></tr>
<tr><td class="h">995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# but if it passes threading_point, then everything&#39;s in page_size</td></tr>
<tr><td class="h">996</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# chunks:</td></tr>
<tr><td class="h">997</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L997">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$page_size = $threading_point if $post_count &lt; $threading_point;</td></tr>
<tr><td class="h">998</td><td colspan="7"></td></tr><tr><td class="h">999</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L999">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $top_replies = $thread ? 1 : scalar(@{$children{$thread}});</td></tr>
<tr><td class="h">1000</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pages = int($top_replies / $page_size);</td></tr>
<tr><td class="h">1001</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1001">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($top_replies % $page_size) { $pages++; }</td></tr>
<tr><td class="h">1002</td><td colspan="7"></td></tr><tr><td class="h">1003</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1003">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @top_replies = $thread ? ($thread) : @{$children{$thread}};</td></tr>
<tr><td class="h">1004</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $page_from_view = 0;</td></tr>
<tr><td class="h">1005</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1005">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1005">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;view&#39;} &amp;&amp; !$opts-&gt;{&#39;page&#39;}) {</td></tr>
<tr><td class="h">1006</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# find top-level comment that this comment is under</td></tr>
<tr><td class="h">1007</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $viewid = $opts-&gt;{&#39;view&#39;} &gt;&gt; 8;</td></tr>
<tr><td class="h">1008</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1008">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while ($posts-&gt;{$viewid} &amp;&amp; $posts-&gt;{$viewid}-&gt;{&#39;parenttalkid&#39;}) {</td></tr>
<tr><td class="h">1009</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$viewid = $posts-&gt;{$viewid}-&gt;{&#39;parenttalkid&#39;};</td></tr>
<tr><td class="h">1010</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (my $ti = 0; $ti &lt; @top_replies; ++$ti) {</td></tr>
<tr><td class="h">1012</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1012">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($posts-&gt;{$top_replies[$ti]}-&gt;{&#39;talkid&#39;} == $viewid) {</td></tr>
<tr><td class="h">1013</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$page_from_view = int($ti/$page_size)+1;</td></tr>
<tr><td class="h">1014</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last;</td></tr>
<tr><td class="h">1015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1016</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1017</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1018</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1018">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $page = int($opts-&gt;{&#39;page&#39;}) || $page_from_view || 1;</td></tr>
<tr><td class="h">1019</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1019">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1019">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$page = $page &lt; 1 ? 1 : $page &gt; $pages ? $pages : $page;</td></tr>
<tr><td class="h">1020</td><td colspan="7"></td></tr><tr><td class="h">1021</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemfirst = $page_size * ($page-1) + 1;</td></tr>
<tr><td class="h">1022</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1022">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemlast = $page==$pages ? $top_replies : ($page_size * $page);</td></tr>
<tr><td class="h">1023</td><td colspan="7"></td></tr><tr><td class="h">1024</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;@top_replies = @top_replies[$itemfirst-1 .. $itemlast-1];</td></tr>
<tr><td class="h">1025</td><td colspan="7"></td></tr><tr><td class="h">1026</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @posts_to_load, @top_replies;</td></tr>
<tr><td class="h">1027</td><td colspan="7"></td></tr><tr><td class="h">1028</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# mark child posts of the top-level to load, deeper</td></tr>
<tr><td class="h">1029</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# and deeper until we&#39;ve hit the page size.  if too many loaded,</td></tr>
<tr><td class="h">1030</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# just mark that we&#39;ll load the subjects;</td></tr>
<tr><td class="h">1031</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @check_for_children = @posts_to_load;</td></tr>
<tr><td class="h">1032</td><td colspan="7"></td></tr><tr><td class="h">1033</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## expand first reply to top-level comments</td></tr>
<tr><td class="h">1034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## %expand_children - list of comments, children of which are to expand</td></tr>
<tr><td class="h">1035</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %expand_children = map { $_ =&gt; 1 } @top_replies;</td></tr>
<tr><td class="h">1036</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my (@subjects_to_load, @subjects_ignored);</td></tr>
<tr><td class="h">1037</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (@check_for_children) {</td></tr>
<tr><td class="h">1038</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cfc = shift @check_for_children;</td></tr>
<tr><td class="h">1039</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1039">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless defined $children{$cfc};</td></tr>
<tr><td class="h">1040</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $child (@{$children{$cfc}}) {</td></tr>
<tr><td class="h">1041</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1041">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1041">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1041">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@posts_to_load &lt; $page_size || $expand_children{$cfc} || $opts-&gt;{expand_all}) {</td></tr>
<tr><td class="h">1042</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @posts_to_load, $child;</td></tr>
<tr><td class="h">1043</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## expand only the first child, then clear the flag</td></tr>
<tr><td class="h">1044</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $expand_children{$cfc}; </td></tr>
<tr><td class="h">1045</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1046</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elsif (@posts_to_load &lt; $page_size) {</td></tr>
<tr><td class="h">1047</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @posts_to_load, $child;</td></tr>
<tr><td class="h">1048</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1049</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1049">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@subjects_to_load &lt; $max_subjects) {</td></tr>
<tr><td class="h">1050</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @subjects_to_load, $child;</td></tr>
<tr><td class="h">1051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1052</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @subjects_ignored, $child;</td></tr>
<tr><td class="h">1053</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1054</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1055</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @check_for_children, $child;</td></tr>
<tr><td class="h">1056</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1058</td><td colspan="7"></td></tr><tr><td class="h">1059</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;out_pages&#39;} = $pages;</td></tr>
<tr><td class="h">1060</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;out_page&#39;} = $page;</td></tr>
<tr><td class="h">1061</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;out_itemfirst&#39;} = $itemfirst;</td></tr>
<tr><td class="h">1062</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;out_itemlast&#39;} = $itemlast;</td></tr>
<tr><td class="h">1063</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;out_pagesize&#39;} = $page_size;</td></tr>
<tr><td class="h">1064</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;out_items&#39;} = $top_replies;</td></tr>
<tr><td class="h">1065</td><td colspan="7"></td></tr><tr><td class="h">1066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load text of posts</td></tr>
<tr><td class="h">1067</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($posts_loaded, $subjects_loaded);</td></tr>
<tr><td class="h">1068</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$posts_loaded = LJ::get_talktext2($u, @posts_to_load);</td></tr>
<tr><td class="h">1069</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1069">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$subjects_loaded = LJ::get_talktext2($u, {&#39;onlysubjects&#39;=&gt;1}, @subjects_to_load) if @subjects_to_load;</td></tr>
<tr><td class="h">1070</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $talkid (@posts_to_load) {</td></tr>
<tr><td class="h">1071</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1071">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $posts-&gt;{$talkid}-&gt;{&#39;_show&#39;};</td></tr>
<tr><td class="h">1072</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$posts-&gt;{$talkid}-&gt;{&#39;_loaded&#39;} = 1;</td></tr>
<tr><td class="h">1073</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$posts-&gt;{$talkid}-&gt;{&#39;subject&#39;} = $posts_loaded-&gt;{$talkid}-&gt;[0];</td></tr>
<tr><td class="h">1074</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$posts-&gt;{$talkid}-&gt;{&#39;body&#39;} = $posts_loaded-&gt;{$talkid}-&gt;[1];</td></tr>
<tr><td class="h">1075</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$users_to_load{$posts-&gt;{$talkid}-&gt;{&#39;posterid&#39;}} = 1;</td></tr>
<tr><td class="h">1076</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1077</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $talkid (@subjects_to_load) {</td></tr>
<tr><td class="h">1078</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1078">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $posts-&gt;{$talkid}-&gt;{&#39;_show&#39;};</td></tr>
<tr><td class="h">1079</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$posts-&gt;{$talkid}-&gt;{&#39;subject&#39;} = $subjects_loaded-&gt;{$talkid}-&gt;[0];</td></tr>
<tr><td class="h">1080</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1080">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$users_to_load{$posts-&gt;{$talkid}-&gt;{&#39;posterid&#39;}} ||= 0.5;  # only care about username</td></tr>
<tr><td class="h">1081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1082</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $talkid (@subjects_ignored) {</td></tr>
<tr><td class="h">1083</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1083">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $posts-&gt;{$talkid}-&gt;{&#39;_show&#39;};</td></tr>
<tr><td class="h">1084</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$posts-&gt;{$talkid}-&gt;{&#39;subject&#39;} = &quot;...&quot;;</td></tr>
<tr><td class="h">1085</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1085">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$users_to_load{$posts-&gt;{$talkid}-&gt;{&#39;posterid&#39;}} ||= 0.5;  # only care about username</td></tr>
<tr><td class="h">1086</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1087</td><td colspan="7"></td></tr><tr><td class="h">1088</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load meta-data</td></tr>
<tr><td class="h">1089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1090</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %props;</td></tr>
<tr><td class="h">1091</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_talk_props2($u-&gt;{&#39;userid&#39;}, \@posts_to_load, \%props);</td></tr>
<tr><td class="h">1092</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %props) {</td></tr>
<tr><td class="h">1093</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1093">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $posts-&gt;{$_}-&gt;{&#39;_show&#39;};</td></tr>
<tr><td class="h">1094</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$posts-&gt;{$_}-&gt;{&#39;props&#39;} = $props{$_};</td></tr>
<tr><td class="h">1095</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1096</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1097</td><td colspan="7"></td></tr><tr><td class="h">1098</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1098">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE) {</td></tr>
<tr><td class="h">1099</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@posts_to_load) {</td></tr>
<tr><td class="h">1100</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1100">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($posts-&gt;{$_}-&gt;{&#39;props&#39;}-&gt;{&#39;unknown8bit&#39;}) {</td></tr>
<tr><td class="h">1101</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::item_toutf8($u, \$posts-&gt;{$_}-&gt;{&#39;subject&#39;},</td></tr>
<tr><td class="h">1102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\$posts-&gt;{$_}-&gt;{&#39;body&#39;},</td></tr>
<tr><td class="h">1103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{});</td></tr>
<tr><td class="h">1104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1107</td><td colspan="7"></td></tr><tr><td class="h">1108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load users who posted</td></tr>
<tr><td class="h">1109</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;delete $users_to_load{0};</td></tr>
<tr><td class="h">1110</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %up = ();</td></tr>
<tr><td class="h">1111</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1111">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%users_to_load) {</td></tr>
<tr><td class="h">1112</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userids_multiple([ map { $_, \$up{$_} } keys %users_to_load ]);</td></tr>
<tr><td class="h">1113</td><td colspan="7"></td></tr><tr><td class="h">1114</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fill in the &#39;userpost&#39; member on each post being shown</td></tr>
<tr><td class="h">1115</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($id, $post) = each %$posts) {</td></tr>
<tr><td class="h">1116</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $up = $up{$post-&gt;{&#39;posterid&#39;}};</td></tr>
<tr><td class="h">1117</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1117">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $up;</td></tr>
<tr><td class="h">1118</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post-&gt;{&#39;upost&#39;}    = $up;</td></tr>
<tr><td class="h">1119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post-&gt;{&#39;userpost&#39;} = $up-&gt;{&#39;user&#39;};</td></tr>
<tr><td class="h">1120</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1122</td><td colspan="7"></td></tr><tr><td class="h">1123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# optionally give them back user refs</td></tr>
<tr><td class="h">1124</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1124">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref($opts-&gt;{&#39;userref&#39;}) eq &quot;HASH&quot;) {</td></tr>
<tr><td class="h">1125</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %userpics = ();</td></tr>
<tr><td class="h">1126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# copy into their ref the users we&#39;ve already loaded above.</td></tr>
<tr><td class="h">1127</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %up) {</td></tr>
<tr><td class="h">1128</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;userref&#39;}-&gt;{$k} = $v;</td></tr>
<tr><td class="h">1129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1130</td><td colspan="7"></td></tr><tr><td class="h">1131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# optionally load userpics</td></tr>
<tr><td class="h">1132</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1132">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ref($opts-&gt;{&#39;userpicref&#39;}) eq &quot;HASH&quot;) {</td></tr>
<tr><td class="h">1133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @load_pic;</td></tr>
<tr><td class="h">1134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $talkid (@posts_to_load) {</td></tr>
<tr><td class="h">1135</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $post = $posts-&gt;{$talkid};</td></tr>
<tr><td class="h">1136</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $kw;</td></tr>
<tr><td class="h">1137</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1137">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1137">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($post-&gt;{&#39;props&#39;} &amp;&amp; $post-&gt;{&#39;props&#39;}-&gt;{&#39;picture_keyword&#39;}) {</td></tr>
<tr><td class="h">1138</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$kw = $post-&gt;{&#39;props&#39;}-&gt;{&#39;picture_keyword&#39;};</td></tr>
<tr><td class="h">1139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1140</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pu = $opts-&gt;{&#39;userref&#39;}-&gt;{$post-&gt;{&#39;posterid&#39;}};</td></tr>
<tr><td class="h">1141</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = LJ::get_picid_from_keyword($pu, $kw);</td></tr>
<tr><td class="h">1142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$post-&gt;{&#39;picid&#39;} = $id;</td></tr>
<tr><td class="h">1143</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @load_pic, [ $pu, $id ];</td></tr>
<tr><td class="h">1144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userpics($opts-&gt;{&#39;userpicref&#39;}, \@load_pic);</td></tr>
<tr><td class="h">1146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1147</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1148</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return map { $posts-&gt;{$_} } @top_replies;</td></tr>
<tr><td class="h">1149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1150</td><td colspan="7"></td></tr><tr><td class="h">1151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub talkform {</td></tr>
<tr><td class="h">1152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Takes a hashref with the following keys / values:</td></tr>
<tr><td class="h">1153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remote:      optional remote u object</td></tr>
<tr><td class="h">1154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# journalu:    prequired journal u object</td></tr>
<tr><td class="h">1155</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# parpost:     parent post object</td></tr>
<tr><td class="h">1156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# replyto:     init-&gt;replyto</td></tr>
<tr><td class="h">1157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# ditemid:     init-&gt;ditemid</td></tr>
<tr><td class="h">1158</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# stylemine:   user using style=mine or not</td></tr>
<tr><td class="h">1159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# form:        optional full form hashref</td></tr>
<tr><td class="h">1160</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do_captcha:  optional toggle for creating a captcha challenge</td></tr>
<tr><td class="h">1161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# require_tos: optional toggle to include TOS requirement form</td></tr>
<tr><td class="h">1162</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# errors:      optional error arrayref</td></tr>
<tr><td class="h">1163</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L1163">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = shift;</td></tr>
<tr><td class="h">1164</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1164">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;Invalid talkform values.&quot; unless ref $opts eq &#39;HASH&#39;;</td></tr>
<tr><td class="h">1165</td><td colspan="7"></td></tr><tr><td class="h">1166</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret;</td></tr>
<tr><td class="h">1167</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($remote, $journalu, $parpost, $form) =</td></tr>
<tr><td class="h">1168</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map { $opts-&gt;{$_} } qw(remote journalu parpost form);</td></tr>
<tr><td class="h">1169</td><td colspan="7"></td></tr><tr><td class="h">1170</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1170">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $editid = $form-&gt;{edit} ? $form-&gt;{edit} : 0;</td></tr>
<tr><td class="h">1171</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comment;</td></tr>
<tr><td class="h">1172</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1172">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($editid) {</td></tr>
<tr><td class="h">1173</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comment = LJ::Comment-&gt;new($journalu, dtalkid =&gt; $editid);</td></tr>
<tr><td class="h">1174</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1174">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;Cannot load comment information.&quot; unless $comment;</td></tr>
<tr><td class="h">1175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1176</td><td colspan="7"></td></tr><tr><td class="h">1177</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pics = LJ::Talk::get_subjecticons();</td></tr>
<tr><td class="h">1178</td><td colspan="7"></td></tr><tr><td class="h">1179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# once we clean out talkpost.bml, this will need to be changed.</td></tr>
<tr><td class="h">1180</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;BML::set_language_scope(&#39;/talkpost.bml&#39;);</td></tr>
<tr><td class="h">1181</td><td colspan="7"></td></tr><tr><td class="h">1182</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make sure journal isn&#39;t locked</td></tr>
<tr><td class="h">1183</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1183">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;Sorry, this journal is locked and comments cannot be posted to it or edited at this time.&quot;</td></tr>
<tr><td class="h">1184</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $journalu-&gt;is_locked;</td></tr>
<tr><td class="h">1185</td><td colspan="7"></td></tr><tr><td class="h">1186</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check max comments only if posting a new comment (not when editing)</td></tr>
<tr><td class="h">1187</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1187">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($editid) {</td></tr>
<tr><td class="h">1188</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $jitemid = $opts-&gt;{&#39;ditemid&#39;} &gt;&gt; 8;</td></tr>
<tr><td class="h">1189</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1189">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;Sorry, this entry already has the maximum number of comments allowed.&quot;</td></tr>
<tr><td class="h">1190</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if LJ::Talk::Post::over_maxcomments($journalu, $jitemid);</td></tr>
<tr><td class="h">1191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1192</td><td colspan="7"></td></tr><tr><td class="h">1193</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1193">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1193">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$editid &amp;&amp; $parpost-&gt;{&#39;state&#39;} eq &quot;S&quot;) {</td></tr>
<tr><td class="h">1194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;div class=&#39;ljwarnscreened&#39;&gt;$BML::ML{&#39;.warnscreened&#39;}&lt;/div&gt;&quot;;</td></tr>
<tr><td class="h">1195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1196</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;form method=&#39;post&#39; action=&#39;$LJ::SITEROOT/talkpost_do&#39; id=&#39;postform&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1197</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::form_auth();</td></tr>
<tr><td class="h">1198</td><td colspan="7"></td></tr><tr><td class="h">1199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Login challenge/response</td></tr>
<tr><td class="h">1200</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $authchal = LJ::challenge_generate(900); # 15 minute auth token</td></tr>
<tr><td class="h">1201</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input type=&#39;hidden&#39; name=&#39;chal&#39; id=&#39;login_chal&#39; value=&#39;$authchal&#39; /&gt;&quot;;</td></tr>
<tr><td class="h">1202</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input type=&#39;hidden&#39; name=&#39;response&#39; id=&#39;login_response&#39; value=&#39;&#39; /&gt;&quot;;</td></tr>
<tr><td class="h">1203</td><td colspan="7"></td></tr><tr><td class="h">1204</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1204">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1204">0</a></div></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{errors} &amp;&amp; @{$opts-&gt;{errors}}) {</td></tr>
<tr><td class="h">1205</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &#39;&lt;ul&gt;&#39;;</td></tr>
<tr><td class="h">1206</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;li&gt;&lt;b&gt;$_&lt;/b&gt;&lt;/li&gt;&quot; foreach @{$opts-&gt;{errors}};</td></tr>
<tr><td class="h">1207</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &#39;&lt;/ul&gt;&#39;;</td></tr>
<tr><td class="h">1208</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;hr /&gt;&quot;;</td></tr>
<tr><td class="h">1209</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1210</td><td colspan="7"></td></tr><tr><td class="h">1211</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# hidden values</td></tr>
<tr><td class="h">1212</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parent = $opts-&gt;{replyto}+0;</td></tr>
<tr><td class="h">1213</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::html_hidden(&quot;replyto&quot;, $opts-&gt;{replyto},</td></tr>
<tr><td class="h">1214</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;parenttalkid&quot;, $parent,</td></tr>
<tr><td class="h">1215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;itemid&quot;, $opts-&gt;{ditemid},</td></tr>
<tr><td class="h">1216</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;journal&quot;, $journalu-&gt;{&#39;user&#39;},</td></tr>
<tr><td class="h">1217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stylemine&quot;, $opts-&gt;{stylemine});</td></tr>
<tr><td class="h">1218</td><td colspan="7"></td></tr><tr><td class="h">1219</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# rate limiting challenge</td></tr>
<tr><td class="h">1220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1221</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($time, $secret) = LJ::get_secret();</td></tr>
<tr><td class="h">1222</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rchars = LJ::rand_chars(20);</td></tr>
<tr><td class="h">1223</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $chal = $opts-&gt;{ditemid} . &quot;-$journalu-&gt;{userid}-$time-$rchars&quot;;</td></tr>
<tr><td class="h">1224</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $res = Digest::MD5::md5_hex($secret . $chal);</td></tr>
<tr><td class="h">1225</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::html_hidden(&quot;chrp1&quot;, &quot;$chal-$res&quot;);</td></tr>
<tr><td class="h">1226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1227</td><td colspan="7"></td></tr><tr><td class="h">1228</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we know the user who is posting (error on talkpost_do POST action),</td></tr>
<tr><td class="h">1229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# then see if we</td></tr>
<tr><td class="h">1230</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1230">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{require_tos}) {</td></tr>
<tr><td class="h">1231</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::tosagree_html(&#39;comment&#39;, $form-&gt;{agree_tos}, BML::ml(&#39;tos.error&#39;));</td></tr>
<tr><td class="h">1232</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1233</td><td colspan="7"></td></tr><tr><td class="h">1234</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1234">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $oid_identity = $remote ? $remote-&gt;openid_identity : undef;</td></tr>
<tr><td class="h">1235</td><td colspan="7"></td></tr><tr><td class="h">1236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Default radio button</td></tr>
<tr><td class="h">1237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# 4 possible scenarios:</td></tr>
<tr><td class="h">1238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remote - initial form load, error and redisplay</td></tr>
<tr><td class="h">1239</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# no remote - initial load, error and redisplay</td></tr>
<tr><td class="h">1240</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $whocheck = sub {</td></tr>
<tr><td class="h">1241</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L1241">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $type = shift;</td></tr>
<tr><td class="h">1242</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $default = &quot; checked=&#39;checked&#39;&quot;;</td></tr>
<tr><td class="h">1243</td><td colspan="7"></td></tr><tr><td class="h">1244</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Initial page load (no remote)</td></tr>
<tr><td class="h">1245</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1245">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1245">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $default if $type eq &#39;anonymous&#39; &amp;&amp;</td></tr>
<tr><td class="h">1246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;! $form-&gt;{&#39;usertype&#39;} &amp;&amp; ! $remote &amp;&amp; ! $oid_identity;</td></tr>
<tr><td class="h">1247</td><td colspan="7"></td></tr><tr><td class="h">1248</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Anonymous</td></tr>
<tr><td class="h">1249</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1249">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1249">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $default if $type eq &#39;anonymous&#39; &amp;&amp;</td></tr>
<tr><td class="h">1250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;usertype&#39;} eq &#39;anonymous&#39;;</td></tr>
<tr><td class="h">1251</td><td colspan="7"></td></tr><tr><td class="h">1252</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1252">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::OpenID-&gt;consumer_enabled) {</td></tr>
<tr><td class="h">1253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# OpenID</td></tr>
<tr><td class="h">1254</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1254">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1254">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $default if $type eq &#39;openid&#39; &amp;&amp;</td></tr>
<tr><td class="h">1255</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;usertype&#39;} eq &#39;openid&#39;;</td></tr>
<tr><td class="h">1256</td><td colspan="7"></td></tr><tr><td class="h">1257</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1257">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1257">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $default if $type eq &#39;openid_cookie&#39; &amp;&amp;</td></tr>
<tr><td class="h">1258</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($form-&gt;{&#39;usertype&#39;} eq &#39;openid_cookie&#39; ||</td></tr>
<tr><td class="h">1259</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(defined $oid_identity));</td></tr>
<tr><td class="h">1260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1261</td><td colspan="7"></td></tr><tr><td class="h">1262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Remote user, remote equals userpost</td></tr>
<tr><td class="h">1263</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1263">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1263">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $default if $type eq &#39;remote&#39; &amp;&amp;</td></tr>
<tr><td class="h">1264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($form-&gt;{&#39;usertype&#39;} eq &#39;cookieuser&#39; ||</td></tr>
<tr><td class="h">1265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;userpost&#39;} eq $form-&gt;{&#39;cookieuser&#39;});</td></tr>
<tr><td class="h">1266</td><td colspan="7"></td></tr><tr><td class="h">1267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Possible remote, using ljuser field</td></tr>
<tr><td class="h">1268</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1268">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($type eq &#39;ljuser&#39;) {</td></tr>
<tr><td class="h">1269</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1269">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1269">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $default if</td></tr>
<tr><td class="h">1270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Remote user posting as someone else.</td></tr>
<tr><td class="h">1271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($form-&gt;{&#39;userpost&#39;} &amp;&amp; $form-&gt;{&#39;userpost&#39;} ne $form-&gt;{&#39;cookieuser&#39;} &amp;&amp; $form-&gt;{&#39;usertype&#39;} ne &#39;anonymous&#39;) ||</td></tr>
<tr><td class="h">1272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($form-&gt;{&#39;usertype&#39;} eq &#39;user&#39; &amp;&amp; ! $form-&gt;{&#39;userpost&#39;});</td></tr>
<tr><td class="h">1273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1274</td><td colspan="7"></td></tr><tr><td class="h">1275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">1276</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1277</td><td colspan="7"></td></tr><tr><td class="h">1278</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# special link to create an account</td></tr>
<tr><td class="h">1279</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $create_link;</td></tr>
<tr><td class="h">1280</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1280">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1280">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$remote || defined $oid_identity) {</td></tr>
<tr><td class="h">1281</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$create_link = LJ::run_hook(&quot;override_create_link_on_talkpost_form&quot;, $journalu);</td></tr>
<tr><td class="h">1282</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $create_link;</td></tr>
<tr><td class="h">1283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1284</td><td colspan="7"></td></tr><tr><td class="h">1285</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# from registered user or anonymous?</td></tr>
<tr><td class="h">1286</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;table class=&#39;talkform&#39;&gt;\n&quot;;</td></tr>
<tr><td class="h">1287</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr&gt;&lt;td align=&#39;right&#39; valign=&#39;top&#39;&gt;$BML::ML{&#39;.opt.from&#39;}&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1288</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td&gt;&quot;;</td></tr>
<tr><td class="h">1289</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;table&gt;&quot;; # Internal for &quot;From&quot; options</td></tr>
<tr><td class="h">1290</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $screening = LJ::Talk::screening_level($journalu, $opts-&gt;{ditemid} &gt;&gt; 8);</td></tr>
<tr><td class="h">1291</td><td colspan="7"></td></tr><tr><td class="h">1292</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1292">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($editid) {</td></tr>
<tr><td class="h">1293</td><td colspan="7"></td></tr><tr><td class="h">1294</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1294">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1294">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;You cannot edit this comment.&quot; unless $remote &amp;&amp; !defined $oid_identity;</td></tr>
<tr><td class="h">1295</td><td colspan="7"></td></tr><tr><td class="h">1296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; id=&#39;ljuser_row&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1297</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $logged_in = LJ::ehtml($remote-&gt;display_name);</td></tr>
<tr><td class="h">1298</td><td colspan="7"></td></tr><tr><td class="h">1299</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1299">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::is_banned($remote, $journalu)) {</td></tr>
<tr><td class="h">1300</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/user.png&#39; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1301</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;( )&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1302</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39;&gt;&lt;span class=&#39;ljdeem&#39;&gt;&quot; . BML::ml(&quot;.opt.loggedin&quot;, {&#39;username&#39;=&gt;&quot;&lt;i&gt;$logged_in&lt;/i&gt;&quot;}) . &quot;&lt;/font&gt;&quot; . BML::ml(&quot;.opt.bannedfrom&quot;, {&#39;journal&#39;=&gt;$journalu-&gt;{&#39;user&#39;}}) . &quot;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1304</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/user.png&#39;  onclick=&#39;handleRadios(1);&#39; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1305</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39;&gt;&lt;label for=&#39;talkpostfromremote&#39;&gt;&quot; . BML::ml(&quot;.opt.loggedin&quot;, {&#39;username&#39;=&gt;&quot;&lt;i&gt;$logged_in&lt;/i&gt;&quot;}) . &quot;&lt;/label&gt;\n&quot;;</td></tr>
<tr><td class="h">1306</td><td colspan="7"></td></tr><tr><td class="h">1307</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input type=&#39;hidden&#39; name=&#39;usertype&#39; value=&#39;cookieuser&#39; /&gt;&quot;;</td></tr>
<tr><td class="h">1308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input type=&#39;hidden&#39; name=&#39;cookieuser&#39; value=&#39;$remote-&gt;{&#39;user&#39;}&#39; id=&#39;cookieuser&#39; /&gt;\n&quot;;</td></tr>
<tr><td class="h">1309</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1311</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1312</td><td colspan="7"></td></tr><tr><td class="h">1313</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else { # if not edit</td></tr>
<tr><td class="h">1314</td><td colspan="7"></td></tr><tr><td class="h">1315</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1315">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journalu-&gt;{&#39;opt_whocanreply&#39;} eq &quot;all&quot;) {</td></tr>
<tr><td class="h">1316</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new($journalu, ditemid =&gt; $opts-&gt;{ditemid});</td></tr>
<tr><td class="h">1317</td><td colspan="7"></td></tr><tr><td class="h">1318</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1318">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1318">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($entry &amp;&amp; $entry-&gt;security ne &quot;public&quot;) {</td></tr>
<tr><td class="h">1319</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1320</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39; width=&#39;20&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/anonymous.png&#39; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1321</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;(  )&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1322</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39; colspan=&#39;2&#39;&gt;&lt;font color=&#39;#c0c0c0&#39;&gt;&lt;b&gt;$BML::ML{&#39;.opt.anonymous&#39;}&lt;/b&gt;&lt;/font&gt; $BML::ML{&#39;.opt.noanonpost.nonpublic&#39;}&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1323</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1325</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;center&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1326</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/anonymous.png&#39; onclick=&#39;handleRadios(0);&#39;/&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1327</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;input type=&#39;radio&#39; name=&#39;usertype&#39; value=&#39;anonymous&#39; id=&#39;talkpostfromanon&#39;&quot; .</td></tr>
<tr><td class="h">1328</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whocheck-&gt;(&#39;anonymous&#39;) .</td></tr>
<tr><td class="h">1329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1330</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39;&gt;&lt;b&gt;&lt;label for=&#39;talkpostfromanon&#39;&gt;$BML::ML{&#39;.opt.anonymous&#39;}&lt;/label&gt;&lt;/b&gt;&quot;;</td></tr>
<tr><td class="h">1331</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1331">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot; &quot; . $BML::ML{&#39;.opt.willscreen&#39;} if $screening;</td></tr>
<tr><td class="h">1332</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1334</td><td colspan="7"></td></tr><tr><td class="h">1335</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1335">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::OpenID-&gt;consumer_enabled) {</td></tr>
<tr><td class="h">1336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# OpenID!!</td></tr>
<tr><td class="h">1337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Logged in</td></tr>
<tr><td class="h">1338</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1338">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $oid_identity) {</td></tr>
<tr><td class="h">1339</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; id=&#39;oidli&#39; name=&#39;oidli&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1340</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/openid.png&#39; onclick=&#39;handleRadios(4);&#39; /&gt;&lt;/td&gt;&lt;td align=&#39;center&#39;&gt;&lt;input type=&#39;radio&#39; name=&#39;usertype&#39; value=&#39;openid_cookie&#39; id=&#39;talkpostfromoidli&#39;&quot; .</td></tr>
<tr><td class="h">1341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whocheck-&gt;(&#39;openid_cookie&#39;) . &quot;/&gt;&quot;;</td></tr>
<tr><td class="h">1342</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td align=&#39;left&#39;&gt;&lt;b&gt;&lt;label for=&#39;talkpostfromoid&#39; onclick=&#39;handleRadios(4);return false;&#39;&gt;OpenID identity:&lt;/label&gt;&lt;/b&gt; &quot;;</td></tr>
<tr><td class="h">1343</td><td colspan="7"></td></tr><tr><td class="h">1344</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;i&gt;&quot; . $remote-&gt;display_name . &quot;&lt;/i&gt;&quot;;</td></tr>
<tr><td class="h">1345</td><td colspan="7"></td></tr><tr><td class="h">1346</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1346">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $BML::ML{&#39;.opt.willscreen&#39;} if $screening;</td></tr>
<tr><td class="h">1347</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1349</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# logged out</td></tr>
<tr><td class="h">1350</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; id=&#39;oidlo&#39; name=&#39;oidlo&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1351</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/openid.png&#39; onclick=&#39;handleRadios(3);&#39; /&gt;&lt;/td&gt;&lt;td align=&#39;center&#39;&gt;&lt;input type=&#39;radio&#39; name=&#39;usertype&#39; value=&#39;openid&#39; id=&#39;talkpostfromoidlo&#39;&quot; .</td></tr>
<tr><td class="h">1352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whocheck-&gt;(&#39;openid&#39;) . &quot;/&gt;&quot;;</td></tr>
<tr><td class="h">1353</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td align=&#39;left&#39;&gt;&lt;b&gt;&lt;label for=&#39;talkpostfromoidlo&#39; onclick=&#39;handleRadios(3);return false;&#39;&gt;OpenID&lt;/label&gt;&lt;/b&gt; &quot;;</td></tr>
<tr><td class="h">1354</td><td colspan="7"></td></tr><tr><td class="h">1355</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::help_icon_html(&quot;openid&quot;, &quot; &quot;);</td></tr>
<tr><td class="h">1356</td><td colspan="7"></td></tr><tr><td class="h">1357</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1357">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $BML::ML{&#39;.opt.willscreen&#39;} if $screening;</td></tr>
<tr><td class="h">1358</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1360</td><td colspan="7"></td></tr><tr><td class="h">1361</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# URL: [    ]  Verify? [ ]</td></tr>
<tr><td class="h">1362</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1362">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1362">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $url_def = $form-&gt;{&#39;oidurl&#39;} || $oid_identity if defined $oid_identity;</td></tr>
<tr><td class="h">1363</td><td colspan="7"></td></tr><tr><td class="h">1364</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; align=&#39;left&#39; id=&#39;oid_more&#39;&gt;&lt;td colspan=&#39;2&#39;&gt;&lt;/td&gt;&lt;td&gt;&quot;;</td></tr>
<tr><td class="h">1365</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;Identity URL:&amp;nbsp;&lt;input class=&#39;textbox&#39; name=&#39;oidurl&#39; maxlength=&#39;60&#39; size=&#39;53&#39; id=&#39;oidurl&#39; value=&#39;$url_def&#39; /&gt; &quot;;</td></tr>
<tr><td class="h">1366</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;br /&gt;&lt;label for=&#39;oidlogincheck&#39;&gt;$BML::ML{&#39;.loginq&#39;}&amp;nbsp;&lt;/label&gt;&lt;input type=&#39;checkbox&#39; name=&#39;oiddo_login&#39; id=&#39;oidlogincheck&#39; &quot;;</td></tr>
<tr><td class="h">1367</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1367">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;checked=&#39;checked&#39; &quot; if $form-&gt;{&#39;oiddo_login&#39;};</td></tr>
<tr><td class="h">1368</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;/&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1370</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1371</td><td colspan="7"></td></tr><tr><td class="h">1372</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1372">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journalu-&gt;{&#39;opt_whocanreply&#39;} eq &quot;reg&quot;) {</td></tr>
<tr><td class="h">1373</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1374</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39; width=&#39;20&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/anonymous.png&#39; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1375</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;(  )&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1376</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39; colspan=&#39;2&#39;&gt;&lt;font color=&#39;#c0c0c0&#39;&gt;&lt;b&gt;$BML::ML{&#39;.opt.anonymous&#39;}&lt;/b&gt;&lt;/font&gt;$BML::ML{&#39;.opt.noanonpost&#39;}&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1377</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1378</td><td colspan="7"></td></tr><tr><td class="h">1379</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1379">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::OpenID-&gt;consumer_enabled) {</td></tr>
<tr><td class="h">1380</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# OpenID user can post if the account has validated e-mail address</td></tr>
<tr><td class="h">1381</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1381">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1381">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $oid_identity &amp;&amp; $remote-&gt;is_validated) {</td></tr>
<tr><td class="h">1382</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $logged_in = LJ::ehtml($remote-&gt;display_name);</td></tr>
<tr><td class="h">1383</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; id=&#39;oidli&#39; name=&#39;oidli&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1384</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1384">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::is_banned($remote, $journalu)) {</td></tr>
<tr><td class="h">1385</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/openid.png&#39; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1386</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;( )&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1387</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39;&gt;&lt;span class=&#39;ljdeem&#39;&gt;&quot; . BML::ml(&quot;.opt.loggedin&quot;, {&#39;username&#39;=&gt;&quot;&lt;i&gt;$logged_in&lt;/i&gt;&quot;}) . &quot;&lt;/font&gt;&quot; . BML::ml(&quot;.opt.bannedfrom&quot;, {&#39;journal&#39;=&gt;$journalu-&gt;{&#39;user&#39;}}) . &quot;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1389</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/openid.png&#39; onclick=&#39;handleRadios(4);&#39; /&gt;&lt;/td&gt;&lt;td align=&#39;center&#39;&gt;&lt;input type=&#39;radio&#39; name=&#39;usertype&#39; value=&#39;openid_cookie&#39; id=&#39;talkpostfromoidli&#39;&quot; .</td></tr>
<tr><td class="h">1390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whocheck-&gt;(&#39;openid_cookie&#39;) . &quot;/&gt;&quot;;</td></tr>
<tr><td class="h">1391</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td align=&#39;left&#39;&gt;&lt;b&gt;&lt;label for=&#39;talkpostfromoid&#39; onclick=&#39;handleRadios(4);return false;&#39;&gt;OpenID identity:&lt;/label&gt;&lt;/b&gt; &quot;;</td></tr>
<tr><td class="h">1392</td><td colspan="7"></td></tr><tr><td class="h">1393</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;i&gt;&quot; . $remote-&gt;display_name . &quot;&lt;/i&gt;&quot;;</td></tr>
<tr><td class="h">1394</td><td colspan="7"></td></tr><tr><td class="h">1395</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1395">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $BML::ML{&#39;.opt.willscreen&#39;} if $screening;</td></tr>
<tr><td class="h">1396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1397</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1398</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# logged out or no validated email</td></tr>
<tr><td class="h">1400</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1401</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/openid.png&#39; onclick=&#39;handleRadios(3);&#39; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1402</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;(  )&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1403</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39; colspan=&#39;2&#39;&gt;&lt;font color=&#39;#c0c0c0&#39;&gt;&lt;b&gt;OpenID&lt;/b&gt;&lt;/font&gt;&quot;;</td></tr>
<tr><td class="h">1404</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1404">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= BML::ml(&#39;.opt.noopenidpost&#39;, { aopts1 =&gt; &quot;href=&#39;$LJ::SITEROOT/changeemail&#39;&quot;, aopts2 =&gt; &quot;href=&#39;$LJ::SITEROOT/register&#39;&quot; })</td></tr>
<tr><td class="h">1405</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if defined $oid_identity;</td></tr>
<tr><td class="h">1406</td><td colspan="7"></td></tr><tr><td class="h">1407</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::help_icon_html(&quot;openid&quot;, &quot; &quot;);</td></tr>
<tr><td class="h">1408</td><td colspan="7"></td></tr><tr><td class="h">1409</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1410</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1413</td><td colspan="7"></td></tr><tr><td class="h">1414</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1414">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journalu-&gt;{&#39;opt_whocanreply&#39;} eq &#39;friends&#39;) {</td></tr>
<tr><td class="h">1415</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1416</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39; width=&#39;20&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/anonymous.png&#39; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1417</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;(  )&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1418</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39; colspan=&#39;2&#39;&gt;&lt;font color=&#39;#c0c0c0&#39;&gt;&lt;b&gt;$BML::ML{&#39;.opt.anonymous&#39;}&lt;/b&gt;&lt;/font&gt;&quot;;</td></tr>
<tr><td class="h">1419</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1419">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $stringname = $journalu-&gt;is_person ? &quot;.opt.friendsonly&quot; : &quot;.opt.membersonly&quot;;</td></tr>
<tr><td class="h">1420</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot; &quot; . BML::ml($stringname, {&#39;username&#39;=&gt;&quot;&lt;b&gt;$journalu-&gt;{&#39;user&#39;}&lt;/b&gt;&quot;});</td></tr>
<tr><td class="h">1421</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1422</td><td colspan="7"></td></tr><tr><td class="h">1423</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## the if clause is a copy of code from ($journalu-&gt;{&#39;opt_whocanreply&#39;} eq &#39;all&#39;)`</td></tr>
<tr><td class="h">1424</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1424">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::OpenID-&gt;consumer_enabled) {</td></tr>
<tr><td class="h">1425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# OpenID!!</td></tr>
<tr><td class="h">1426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Logged in</td></tr>
<tr><td class="h">1427</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1427">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $oid_identity) {</td></tr>
<tr><td class="h">1428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; id=&#39;oidli&#39; name=&#39;oidli&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1429</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/openid.png&#39; onclick=&#39;handleRadios(4);&#39; /&gt;&lt;/td&gt;&lt;td align=&#39;center&#39;&gt;&lt;input type=&#39;radio&#39; name=&#39;usertype&#39; value=&#39;openid_cookie&#39; id=&#39;talkpostfromoidli&#39;&quot; .</td></tr>
<tr><td class="h">1430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whocheck-&gt;(&#39;openid_cookie&#39;) . &quot;/&gt;&quot;;</td></tr>
<tr><td class="h">1431</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td align=&#39;left&#39;&gt;&lt;b&gt;&lt;label for=&#39;talkpostfromoid&#39; onclick=&#39;handleRadios(4);return false;&#39;&gt;OpenID identity:&lt;/label&gt;&lt;/b&gt; &quot;;</td></tr>
<tr><td class="h">1432</td><td colspan="7"></td></tr><tr><td class="h">1433</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;i&gt;&quot; . $remote-&gt;display_name . &quot;&lt;/i&gt;&quot;;</td></tr>
<tr><td class="h">1434</td><td colspan="7"></td></tr><tr><td class="h">1435</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1435">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $BML::ML{&#39;.opt.willscreen&#39;} if $screening;</td></tr>
<tr><td class="h">1436</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# logged out</td></tr>
<tr><td class="h">1439</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; id=&#39;oidlo&#39; name=&#39;oidlo&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1440</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/openid.png&#39; onclick=&#39;handleRadios(3);&#39; /&gt;&lt;/td&gt;&lt;td align=&#39;center&#39;&gt;&lt;input type=&#39;radio&#39; name=&#39;usertype&#39; value=&#39;openid&#39; id=&#39;talkpostfromoidlo&#39;&quot; .</td></tr>
<tr><td class="h">1441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whocheck-&gt;(&#39;openid&#39;) . &quot;/&gt;&quot;;</td></tr>
<tr><td class="h">1442</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td align=&#39;left&#39;&gt;&lt;b&gt;&lt;label for=&#39;talkpostfromoidlo&#39; onclick=&#39;handleRadios(3);return false;&#39;&gt;OpenID&lt;/label&gt;&lt;/b&gt; &quot;;</td></tr>
<tr><td class="h">1443</td><td colspan="7"></td></tr><tr><td class="h">1444</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::help_icon_html(&quot;openid&quot;, &quot; &quot;);</td></tr>
<tr><td class="h">1445</td><td colspan="7"></td></tr><tr><td class="h">1446</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1446">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $BML::ML{&#39;.opt.willscreen&#39;} if $screening;</td></tr>
<tr><td class="h">1447</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1449</td><td colspan="7"></td></tr><tr><td class="h">1450</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# URL: [    ]  Verify? [ ]</td></tr>
<tr><td class="h">1451</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1451">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1451">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $url_def = $form-&gt;{&#39;oidurl&#39;} || $oid_identity if defined $oid_identity;</td></tr>
<tr><td class="h">1452</td><td colspan="7"></td></tr><tr><td class="h">1453</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; align=&#39;left&#39; id=&#39;oid_more&#39;&gt;&lt;td colspan=&#39;2&#39;&gt;&lt;/td&gt;&lt;td&gt;&quot;;</td></tr>
<tr><td class="h">1454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;Identity URL:&amp;nbsp;&lt;input class=&#39;textbox&#39; name=&#39;oidurl&#39; maxlength=&#39;60&#39; size=&#39;53&#39; id=&#39;oidurl&#39; value=&#39;$url_def&#39; /&gt; &quot;;</td></tr>
<tr><td class="h">1455</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;br /&gt;&lt;label for=&#39;oidlogincheck&#39;&gt;$BML::ML{&#39;.loginq&#39;}&amp;nbsp;&lt;/label&gt;&lt;input type=&#39;checkbox&#39; name=&#39;oiddo_login&#39; id=&#39;oidlogincheck&#39; &quot;;</td></tr>
<tr><td class="h">1456</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1456">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;checked=&#39;checked&#39; &quot; if $form-&gt;{&#39;oiddo_login&#39;};</td></tr>
<tr><td class="h">1457</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;/&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1458</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1459</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1460</td><td colspan="7"></td></tr><tr><td class="h">1461</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1461">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1461">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($remote &amp;&amp; !defined $oid_identity) {</td></tr>
<tr><td class="h">1462</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; id=&#39;ljuser_row&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1463</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $logged_in = LJ::ehtml($remote-&gt;display_name);</td></tr>
<tr><td class="h">1464</td><td colspan="7"></td></tr><tr><td class="h">1465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Don&#39;t worry about a real href since js hides the row anyway</td></tr>
<tr><td class="h">1466</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $other_user = &quot;&lt;script language=&#39;JavaScript&#39;&gt;if (document.getElementById) {document.write(\&quot;&amp;nbsp;&lt;a href=&#39;#&#39; onClick=&#39;otherLJUser();return false;&#39;&gt;[other]&lt;/a&gt;\&quot;);}&lt;/script&gt;&quot;;</td></tr>
<tr><td class="h">1467</td><td colspan="7"></td></tr><tr><td class="h">1468</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1468">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::is_banned($remote, $journalu)) {</td></tr>
<tr><td class="h">1469</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/user.png&#39; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1470</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;( )&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1471</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39;&gt;&lt;span class=&#39;ljdeem&#39;&gt;&quot; . BML::ml(&quot;.opt.loggedin&quot;, {&#39;username&#39;=&gt;&quot;&lt;i&gt;$logged_in&lt;/i&gt;&quot;}) . &quot;&lt;/font&gt;&quot; . BML::ml(&quot;.opt.bannedfrom&quot;, {&#39;journal&#39;=&gt;$journalu-&gt;{&#39;user&#39;}}) . $other_user . &quot;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1473</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/user.png&#39;  onclick=&#39;handleRadios(1);&#39; /&gt;&lt;/td&gt;&lt;td align=&#39;center&#39;&gt;&lt;input type=&#39;radio&#39; name=&#39;usertype&#39; value=&#39;cookieuser&#39; id=&#39;talkpostfromremote&#39;&quot; .</td></tr>
<tr><td class="h">1474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whocheck-&gt;(&#39;remote&#39;) .</td></tr>
<tr><td class="h">1475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; /&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1476</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;left&#39;&gt;&lt;label for=&#39;talkpostfromremote&#39;&gt;&quot; . BML::ml(&quot;.opt.loggedin&quot;, {&#39;username&#39;=&gt;&quot;&lt;i&gt;$logged_in&lt;/i&gt;&quot;}) . &quot;&lt;/label&gt;\n&quot;;</td></tr>
<tr><td class="h">1477</td><td colspan="7"></td></tr><tr><td class="h">1478</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $other_user;</td></tr>
<tr><td class="h">1479</td><td colspan="7"></td></tr><tr><td class="h">1480</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input type=&#39;hidden&#39; name=&#39;cookieuser&#39; value=&#39;$remote-&gt;{&#39;user&#39;}&#39; id=&#39;cookieuser&#39; /&gt;\n&quot;;</td></tr>
<tr><td class="h">1481</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1481">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1481">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($screening eq &#39;A&#39; ||</td></tr>
<tr><td class="h">1482</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($screening eq &#39;F&#39; &amp;&amp; !$journalu-&gt;trusts_or_has_member( $remote ))) {</td></tr>
<tr><td class="h">1483</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot; &quot; . $BML::ML{&#39;.opt.willscreen&#39;};</td></tr>
<tr><td class="h">1484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1485</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1487</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1489</td><td colspan="7"></td></tr><tr><td class="h">1490</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# ( ) Site user:</td></tr>
<tr><td class="h">1491</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; id=&#39;otherljuser_row&#39; name=&#39;otherljuser_row&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1492</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td align=&#39;center&#39;&gt;&lt;img src=&#39;$LJ::IMGPREFIX/silk/identity/user.png&#39; onclick=&#39;handleRadios(2);&#39; /&gt;&lt;/td&gt;&lt;td align=&#39;center&#39;&gt;&lt;input type=&#39;radio&#39; name=&#39;usertype&#39; value=&#39;user&#39; id=&#39;talkpostfromlj&#39;&quot; .</td></tr>
<tr><td class="h">1493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whocheck-&gt;(&#39;ljuser&#39;) . &quot;/&gt;&quot;;</td></tr>
<tr><td class="h">1494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td align=&#39;left&#39;&gt;&lt;b&gt;&lt;label for=&#39;talkpostfromlj&#39; onclick=&#39;handleRadios(2); return false;&#39;&gt;&quot; . BML::ml( &#39;.opt.siteuser&#39;, { sitename =&gt; $LJ::SITENAMESHORT } ) . &quot;&lt;/label&gt;&lt;/b&gt; &quot;;</td></tr>
<tr><td class="h">1495</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1495">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $BML::ML{&#39;.opt.willscreenfriend&#39;} if $screening eq &#39;F&#39;;</td></tr>
<tr><td class="h">1496</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1496">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $BML::ML{&#39;.opt.willscreen&#39;} if $screening eq &#39;A&#39;;</td></tr>
<tr><td class="h">1497</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1498</td><td colspan="7"></td></tr><tr><td class="h">1499</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1499">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1499">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($remote &amp;&amp; ! defined $oid_identity) {</td></tr>
<tr><td class="h">1500</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;script language=&#39;JavaScript&#39;&gt;\n&quot;;</td></tr>
<tr><td class="h">1501</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;!--\n&quot;;</td></tr>
<tr><td class="h">1502</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;if (document.getElementById) {\n&quot;;</td></tr>
<tr><td class="h">1503</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;var radio_user = document.getElementById(\&quot;talkpostfromlj\&quot;);\n&quot;;</td></tr>
<tr><td class="h">1504</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;if (!radio_user.checked) {\n&quot;;</td></tr>
<tr><td class="h">1505</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;var otherljuser_row = document.getElementById(\&quot;otherljuser_row\&quot;);\n&quot;;</td></tr>
<tr><td class="h">1506</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;otherljuser_row.className = &#39;display_none&#39;;\n&quot;;</td></tr>
<tr><td class="h">1507</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;}\n&quot;;</td></tr>
<tr><td class="h">1508</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;}\n&quot;;</td></tr>
<tr><td class="h">1509</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;//--&gt;\n&quot;;</td></tr>
<tr><td class="h">1510</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/script&gt;&quot;;</td></tr>
<tr><td class="h">1511</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1512</td><td colspan="7"></td></tr><tr><td class="h">1513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Username: [    ] Password: [    ]  Login? [ ]</td></tr>
<tr><td class="h">1514</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; align=&#39;left&#39; id=&#39;lj_more&#39;&gt;&lt;td colspan=&#39;2&#39;&gt;&lt;/td&gt;&lt;td&gt;&quot;;</td></tr>
<tr><td class="h">1515</td><td colspan="7"></td></tr><tr><td class="h">1516</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ljuser_def = &quot;&quot;;</td></tr>
<tr><td class="h">1517</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1517">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1517">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($remote &amp;&amp; !defined $oid_identity) {</td></tr>
<tr><td class="h">1518</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1518">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1518">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{userpost} ne $form-&gt;{cookieuser} &amp;&amp; $form-&gt;{usertype} ne &#39;anonymous&#39;) {</td></tr>
<tr><td class="h">1519</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ljuser_def = BML::eall($form-&gt;{userpost});</td></tr>
<tr><td class="h">1520</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1521</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ljuser_def = $remote-&gt;{user};</td></tr>
<tr><td class="h">1522</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1524</td><td colspan="7"></td></tr><tr><td class="h">1525</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;table&gt;&lt;tr&gt;&lt;td&gt;&quot;;</td></tr>
<tr><td class="h">1526</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;$BML::ML{&#39;Username&#39;}:&lt;/td&gt;&lt;td&gt;&quot;;</td></tr>
<tr><td class="h">1527</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input class=&#39;textbox&#39; name=&#39;userpost&#39; size=&#39;13&#39; maxlength=&#39;25&#39; id=&#39;username&#39; value=&#39;$ljuser_def&#39; onclick=&#39;this.value=\&quot;\&quot;&#39; &quot;;</td></tr>
<tr><td class="h">1528</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;style=&#39;background: url($LJ::IMGPREFIX/silk/identity/user.png) no-repeat; background-color: #fff; background-position: 0px 1px; padding-left: 18px; color: #00C; font-weight: bold;&#39;/&gt;&quot;;</td></tr>
<tr><td class="h">1529</td><td colspan="7"></td></tr><tr><td class="h">1530</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot;;</td></tr>
<tr><td class="h">1531</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;$BML::ML{&#39;Password&#39;}:&lt;/td&gt;&lt;td&gt;&quot;;</td></tr>
<tr><td class="h">1532</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input class=&#39;textbox&#39; name=&#39;password&#39; type=&#39;password&#39; maxlength=&#39;30&#39; size=&#39;18&#39; id=&#39;password&#39; /&gt;&quot;;</td></tr>
<tr><td class="h">1533</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td colspan=&#39;2&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1534</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;label for=&#39;logincheck&#39;&gt;$BML::ML{&#39;.loginq&#39;}&amp;nbsp;&lt;/label&gt;&lt;input type=&#39;checkbox&#39; name=&#39;do_login&#39; id=&#39;logincheck&#39; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;</td></tr>
<tr><td class="h">1535</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1536</td><td colspan="7"></td></tr><tr><td class="h">1537</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Link to create an account</td></tr>
<tr><td class="h">1538</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1538">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1538">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$create_link &amp;&amp; (!$remote || defined $oid_identity)) {</td></tr>
<tr><td class="h">1539</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;middle&#39; align=&#39;left&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td colspan=&#39;2&#39;&gt;&lt;/td&gt;&lt;td&gt;&lt;span style=&#39;font-size: 8pt; font-style: italic;&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1541</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= BML::ml(&#39;.noaccount&#39;, {&#39;aopts&#39; =&gt; &quot;href=&#39;$LJ::SITEROOT/create&#39;&quot;});</td></tr>
<tr><td class="h">1542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/span&gt;&lt;/td&gt;&quot;;</td></tr>
<tr><td class="h">1543</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1544</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1545</td><td colspan="7"></td></tr><tr><td class="h">1546</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} # end edit check</td></tr>
<tr><td class="h">1547</td><td colspan="7"></td></tr><tr><td class="h">1548</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1548">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $basesubject = $form-&gt;{subject} || &quot;&quot;;</td></tr>
<tr><td class="h">1549</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1549">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1549">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{replyto} &amp;&amp; !$basesubject &amp;&amp; $parpost-&gt;{&#39;subject&#39;}) {</td></tr>
<tr><td class="h">1550</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$basesubject = $parpost-&gt;{&#39;subject&#39;};</td></tr>
<tr><td class="h">1551</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$basesubject =~ s/^Re:\s*//i;</td></tr>
<tr><td class="h">1552</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$basesubject = &quot;Re: $basesubject&quot;;</td></tr>
<tr><td class="h">1553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1554</td><td colspan="7"></td></tr><tr><td class="h">1555</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Closing internal &quot;From&quot; table</td></tr>
<tr><td class="h">1556</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;</td></tr>
<tr><td class="h">1557</td><td colspan="7"></td></tr><tr><td class="h">1558</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# subject</td></tr>
<tr><td class="h">1559</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1559">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$basesubject = BML::eall($basesubject) if $basesubject;</td></tr>
<tr><td class="h">1560</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;top&#39;&gt;&lt;td align=&#39;right&#39;&gt;$BML::ML{&#39;.opt.subject&#39;}&lt;/td&gt;&lt;td&gt;&lt;input class=&#39;textbox&#39; type=&#39;text&#39; size=&#39;50&#39; maxlength=&#39;100&#39; name=&#39;subject&#39; id=&#39;subject&#39; value=\&quot;$basesubject\&quot; onKeyPress=&#39;subjectNoHTML(event);&#39;/&gt;\n&quot;;</td></tr>
<tr><td class="h">1561</td><td colspan="7"></td></tr><tr><td class="h">1562</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Subject Icon toggle button</td></tr>
<tr><td class="h">1563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1564</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1564">0</a></div></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $subjicon = $form-&gt;{subjecticon} || &#39;none&#39;;</td></tr>
<tr><td class="h">1565</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $foundicon = 0;</td></tr>
<tr><td class="h">1566</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input type=&#39;hidden&#39; id=&#39;subjectIconField&#39; name=&#39;subjecticon&#39; value=&#39;$subjicon&#39;&gt;\n&quot;;</td></tr>
<tr><td class="h">1567</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;script type=&#39;text/javascript&#39; language=&#39;Javascript&#39;&gt;\n&quot;;</td></tr>
<tr><td class="h">1568</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;!--\n&quot;;</td></tr>
<tr><td class="h">1569</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;if (document.getElementById) {\n&quot;;</td></tr>
<tr><td class="h">1570</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;document.write(\&quot;&quot;;</td></tr>
<tr><td class="h">1571</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1571">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($subjicon eq &#39;none&#39;) {</td></tr>
<tr><td class="h">1572</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::ejs(LJ::Talk::show_none_image(&quot;id=&#39;subjectIconImage&#39; style=&#39;cursor:pointer;cursor:hand&#39; align=&#39;absmiddle&#39; &quot;.</td></tr>
<tr><td class="h">1573</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;onclick=&#39;subjectIconListToggle();&#39; &quot;.</td></tr>
<tr><td class="h">1574</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;title=&#39;Click to change the subject icon&#39;&quot;));</td></tr>
<tr><td class="h">1575</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1576</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $type (@{$pics-&gt;{types}}) {</td></tr>
<tr><td class="h">1577</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@{$pics-&gt;{lists}-&gt;{$type}}) {</td></tr>
<tr><td class="h">1578</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1578">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($_-&gt;{id} eq $subjicon) {</td></tr>
<tr><td class="h">1579</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::Talk::show_image($pics, $subjicon,</td></tr>
<tr><td class="h">1580</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;id=&#39;subjectIconImage&#39; onclick=&#39;subjectIconListToggle();&#39; style=&#39;cursor:pointer;cursor:hand&#39;&quot;);</td></tr>
<tr><td class="h">1581</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$foundicon = 1;</td></tr>
<tr><td class="h">1582</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last;</td></tr>
<tr><td class="h">1583</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1584</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1585</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1585">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $foundicon == 1;</td></tr>
<tr><td class="h">1586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1588</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1588">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1588">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($foundicon == 0 &amp;&amp; $subjicon ne &#39;none&#39;) {</td></tr>
<tr><td class="h">1589</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::ejs(LJ::Talk::show_none_image(&quot;id=&#39;subjectIconImage&#39; style=&#39;cursor:pointer;cursor:hand&#39; align=&#39;absmiddle&#39; &quot;.</td></tr>
<tr><td class="h">1590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;onclick=&#39;subjectIconListToggle();&#39; &quot;.</td></tr>
<tr><td class="h">1591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;title=&#39;Click to change the subject icon&#39;&quot;));</td></tr>
<tr><td class="h">1592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1593</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .=&quot;\&quot;);\n&quot;;</td></tr>
<tr><td class="h">1594</td><td colspan="7"></td></tr><tr><td class="h">1595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# spit out a pretty table of all the possible subjecticons</td></tr>
<tr><td class="h">1596</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;document.write(\&quot;&quot;;</td></tr>
<tr><td class="h">1597</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;blockquote style=&#39;display:none;&#39; id=&#39;subjectIconList&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1598</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;table border=&#39;0&#39; cellspacing=&#39;5&#39; cellpadding=&#39;0&#39; style=&#39;border: 1px solid #AAAAAA&#39;&gt;\&quot;);\n&quot;;</td></tr>
<tr><td class="h">1599</td><td colspan="7"></td></tr><tr><td class="h">1600</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $type (@{$pics-&gt;{&#39;types&#39;}}) {</td></tr>
<tr><td class="h">1601</td><td colspan="7"></td></tr><tr><td class="h">1602</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;document.write(\&quot;&lt;tr&gt;\&quot;);\n&quot;;</td></tr>
<tr><td class="h">1603</td><td colspan="7"></td></tr><tr><td class="h">1604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# make an option if they don&#39;t want an image</td></tr>
<tr><td class="h">1605</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1605">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($type eq $pics-&gt;{&#39;types&#39;}-&gt;[0]) {</td></tr>
<tr><td class="h">1606</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;document.write(\&quot;&quot;;</td></tr>
<tr><td class="h">1607</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td valign=&#39;middle&#39; align=&#39;center&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1608</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::Talk::show_none_image(</td></tr>
<tr><td class="h">1609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;id=&#39;none&#39; onclick=&#39;subjectIconChange(this);&#39; style=&#39;cursor:pointer;cursor:hand&#39; title=&#39;No subject icon&#39; alt=&#39;No subject icon&#39;&quot;);</td></tr>
<tr><td class="h">1610</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;\&quot;);\n&quot;;</td></tr>
<tr><td class="h">1611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1612</td><td colspan="7"></td></tr><tr><td class="h">1613</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# go through and make clickable image rows.</td></tr>
<tr><td class="h">1614</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@{$pics-&gt;{&#39;lists&#39;}-&gt;{$type}}) {</td></tr>
<tr><td class="h">1615</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;document.write(\&quot;&quot;;</td></tr>
<tr><td class="h">1616</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td valign=&#39;middle&#39; align=&#39;center&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1617</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::Talk::show_image($pics, $_-&gt;{&#39;id&#39;},</td></tr>
<tr><td class="h">1618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;id=&#39;$_-&gt;{&#39;id&#39;}&#39; onclick=&#39;subjectIconChange(this);&#39; style=&#39;cursor:pointer;cursor:hand&#39;&quot;);</td></tr>
<tr><td class="h">1619</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;\&quot;);\n&quot;;</td></tr>
<tr><td class="h">1620</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1621</td><td colspan="7"></td></tr><tr><td class="h">1622</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;document.write(\&quot;&lt;/tr&gt;\&quot;);\n&quot;;</td></tr>
<tr><td class="h">1623</td><td colspan="7"></td></tr><tr><td class="h">1624</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# end that table, bar!</td></tr>
<tr><td class="h">1626</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;document.write(\&quot;&lt;/table&gt;&lt;/blockquote&gt;\&quot;);\n&quot;;</td></tr>
<tr><td class="h">1627</td><td colspan="7"></td></tr><tr><td class="h">1628</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;}\n&quot;;</td></tr>
<tr><td class="h">1629</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .=&quot;//--&gt;\n&quot;;</td></tr>
<tr><td class="h">1630</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/script&gt;\n&quot;;</td></tr>
<tr><td class="h">1631</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1632</td><td colspan="7"></td></tr><tr><td class="h">1633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# finish off subject line</td></tr>
<tr><td class="h">1634</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;div id=&#39;ljnohtmlsubj&#39; class=&#39;ljdeem&#39;&gt;&lt;span style=&#39;font-size: 8pt; font-style: italic;&#39;&gt;$BML::ML{&#39;.nosubjecthtml&#39;}&lt;/span&gt;&lt;/div&gt;\n&quot;;</td></tr>
<tr><td class="h">1635</td><td colspan="7"></td></tr><tr><td class="h">1636</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;div id=&#39;userpics&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1637</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %res;</td></tr>
<tr><td class="h">1638</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1638">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($remote) {</td></tr>
<tr><td class="h">1639</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1639">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::do_request({ &quot;mode&quot; =&gt; &quot;login&quot;,</td></tr>
<tr><td class="h">1640</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ver&quot; =&gt; ($LJ::UNICODE ? &quot;1&quot; : &quot;0&quot;),</td></tr>
<tr><td class="h">1641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;user&quot; =&gt; $remote-&gt;{&#39;user&#39;},</td></tr>
<tr><td class="h">1642</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;getpickws&quot; =&gt; 1,</td></tr>
<tr><td class="h">1643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, \%res, { &quot;noauth&quot; =&gt; 1, &quot;userid&quot; =&gt; $remote-&gt;{&#39;userid&#39;} });</td></tr>
<tr><td class="h">1644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1645</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1645">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($res{&#39;pickw_count&#39;}) {</td></tr>
<tr><td class="h">1646</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= BML::ml(&#39;.label.picturetouse2&#39;,</td></tr>
<tr><td class="h">1647</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;aopts&#39;=&gt;&quot;href=&#39;&quot; . $remote-&gt;allpics_base. &quot;&#39;&quot;}) . &quot; &quot;;</td></tr>
<tr><td class="h">1649</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @pics;</td></tr>
<tr><td class="h">1650</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (my $i=1; $i&lt;=$res{&#39;pickw_count&#39;}; $i++) {</td></tr>
<tr><td class="h">1651</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @pics, $res{&quot;pickw_$i&quot;};</td></tr>
<tr><td class="h">1652</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1653</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@pics = sort { lc($a) cmp lc($b) } @pics;</td></tr>
<tr><td class="h">1654</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::html_select({&#39;name&#39; =&gt; &#39;prop_picture_keyword&#39;,</td></tr>
<tr><td class="h">1655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;selected&#39; =&gt; $form-&gt;{&#39;prop_picture_keyword&#39;}, },</td></tr>
<tr><td class="h">1656</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&quot;&quot;, $BML::ML{&#39;.opt.defpic&#39;}, map { ($_, $_) } @pics));</td></tr>
<tr><td class="h">1657</td><td colspan="7"></td></tr><tr><td class="h">1658</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::help_icon_html(&quot;userpics&quot;, &quot; &quot;);</td></tr>
<tr><td class="h">1659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1660</td><td colspan="7"></td></tr><tr><td class="h">1661</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&amp;nbsp;&amp;nbsp;&lt;label for=&#39;prop_opt_preformatted&#39;&gt;$BML::ML{&#39;.opt.noautoformat&#39;}&lt;/label&gt;&quot;;</td></tr>
<tr><td class="h">1662</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::html_check(</td></tr>
<tr><td class="h">1663</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1664</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name  =&gt; &#39;prop_opt_preformatted&#39;,</td></tr>
<tr><td class="h">1665</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id    =&gt; &#39;prop_opt_preformatted&#39;,</td></tr>
<tr><td class="h">1666</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value =&gt; 1,</td></tr>
<tr><td class="h">1667</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selected =&gt; $form-&gt;{&#39;prop_opt_preformatted&#39;}</td></tr>
<tr><td class="h">1668</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1669</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1670</td><td colspan="7"></td></tr><tr><td class="h">1671</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::help_icon_html(&quot;noautoformat&quot;, &quot; &quot;);</td></tr>
<tr><td class="h">1672</td><td colspan="7"></td></tr><tr><td class="h">1673</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1673">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($remote) {</td></tr>
<tr><td class="h">1674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# only show on initial compostion</td></tr>
<tr><td class="h">1675</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $quickquote;</td></tr>
<tr><td class="h">1676</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1676">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1676">0</a></div></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{errors} &amp;&amp; @{$opts-&gt;{errors}}) {</td></tr>
<tr><td class="h">1677</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# quick quote button</td></tr>
<tr><td class="h">1678</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$quickquote = &quot;&amp;nbsp;&amp;nbsp;&quot; . LJ::ejs(&#39;&lt;input type=&quot;button&quot; value=&quot;Quote&quot; onmousedown=&quot;quote();&quot; onclick=&quot;quote();&quot; /&gt;&#39;);</td></tr>
<tr><td class="h">1679</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1680</td><td colspan="7"></td></tr><tr><td class="h">1681</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;script type=&#39;text/javascript&#39; language=&#39;JavaScript&#39;&gt;\n&lt;!--\n&quot;;</td></tr>
<tr><td class="h">1682</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &lt;&lt;&quot;QQ&quot;;</td></tr>
<tr><td class="h">1683</td><td colspan="7"></td></tr><tr><td class="h">1684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var helped = 0; var pasted = 0;</td></tr>
<tr><td class="h">1685</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function quote () {</td></tr>
<tr><td class="h">1686</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var text = &#39;&#39;;</td></tr>
<tr><td class="h">1687</td><td colspan="7"></td></tr><tr><td class="h">1688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (document.getSelection) {</td></tr>
<tr><td class="h">1689</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text = document.getSelection();</td></tr>
<tr><td class="h">1690</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (document.selection) {</td></tr>
<tr><td class="h">1691</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text = document.selection.createRange().text;</td></tr>
<tr><td class="h">1692</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (window.getSelection) {</td></tr>
<tr><td class="h">1693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text = window.getSelection();</td></tr>
<tr><td class="h">1694</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1695</td><td colspan="7"></td></tr><tr><td class="h">1696</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (text == &#39;&#39;) {</td></tr>
<tr><td class="h">1697</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (helped != 1 &amp;&amp; pasted != 1) {</td></tr>
<tr><td class="h">1698</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;helped = 1; alert(&quot;If you&#39;d like to quote a portion of the original message, highlight it then press &#39;Quote&#39;&quot;);</td></tr>
<tr><td class="h">1699</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1700</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</td></tr>
<tr><td class="h">1701</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1702</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pasted = 1;</td></tr>
<tr><td class="h">1703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1704</td><td colspan="7"></td></tr><tr><td class="h">1705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var element = text.search(/\\n/) == -1 ? &#39;q&#39; : &#39;blockquote&#39;;</td></tr>
<tr><td class="h">1706</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var textarea = document.getElementById(&#39;commenttext&#39;);</td></tr>
<tr><td class="h">1707</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textarea.focus();</td></tr>
<tr><td class="h">1708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textarea.value = textarea.value + &quot;&lt;&quot; + element + &quot;&gt;&quot; + text + &quot;&lt;/&quot; + element + &quot;&gt;&quot;;</td></tr>
<tr><td class="h">1709</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textarea.caretPos = textarea.value;</td></tr>
<tr><td class="h">1710</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;textarea.focus();</td></tr>
<tr><td class="h">1711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</td></tr>
<tr><td class="h">1712</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1713</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (document.getElementById &amp;&amp; (document.getSelection || document.selection || window.getSelection)) {</td></tr>
<tr><td class="h">1714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#39;$quickquote&#39;);</td></tr>
<tr><td class="h">1715</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">QQ</td></tr>
<tr><td class="h">1717</td><td colspan="7"></td></tr><tr><td class="h">1718</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;--&gt;\n&lt;/script&gt;\n&quot;;</td></tr>
<tr><td class="h">1719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1720</td><td colspan="7"></td></tr><tr><td class="h">1721</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/div&gt;&quot;;</td></tr>
<tr><td class="h">1722</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;;</td></tr>
<tr><td class="h">1723</td><td colspan="7"></td></tr><tr><td class="h">1724</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# textarea for their message body</td></tr>
<tr><td class="h">1725</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr valign=&#39;top&#39;&gt;&lt;td align=&#39;right&#39;&gt;$BML::ML{&#39;.opt.message&#39;}&quot;;</td></tr>
<tr><td class="h">1726</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td style=&#39;width: 90%&#39;&gt;&quot;;</td></tr>
<tr><td class="h">1727</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;textarea class=&#39;textbox&#39; rows=&#39;10&#39; cols=&#39;75&#39; wrap=&#39;soft&#39; name=&#39;body&#39; id=&#39;commenttext&#39;&gt;&quot; . LJ::ehtml($form-&gt;{body}) . &quot;&lt;/textarea&gt;&quot;;</td></tr>
<tr><td class="h">1728</td><td colspan="7"></td></tr><tr><td class="h">1729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Display captcha challenge if over rate limits.</td></tr>
<tr><td class="h">1730</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1730">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{do_captcha}) {</td></tr>
<tr><td class="h">1731</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1731">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::is_enabled(&quot;recaptcha&quot;)) {</td></tr>
<tr><td class="h">1732</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $c = Captcha::reCAPTCHA-&gt;new;</td></tr>
<tr><td class="h">1733</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $c-&gt;get_options_setter({ theme =&gt; &#39;white&#39; });</td></tr>
<tr><td class="h">1734</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $c-&gt;get_html( LJ::conf_test($LJ::RECAPTCHA{public_key}) );</td></tr>
<tr><td class="h">1735</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;p&gt;&quot; . BML::ml( &#39;captcha.accessibility.contact&#39;, { email =&gt; $LJ::SUPPORT_EMAIL } ) . &quot;&lt;/p&gt;&quot;;</td></tr>
<tr><td class="h">1736</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1737</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($wants_audio, $captcha_sess, $captcha_chal);</td></tr>
<tr><td class="h">1738</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1738">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$wants_audio = 1 if lc($form-&gt;{answer}) eq &#39;audio&#39;;</td></tr>
<tr><td class="h">1739</td><td colspan="7"></td></tr><tr><td class="h">1740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Captcha sessions</td></tr>
<tr><td class="h">1741</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cid = $journalu-&gt;{clusterid};</td></tr>
<tr><td class="h">1742</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1742">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$captcha_chal = $form-&gt;{captcha_chal} || LJ::challenge_generate(900);</td></tr>
<tr><td class="h">1743</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$captcha_sess = LJ::get_challenge_attributes($captcha_chal);</td></tr>
<tr><td class="h">1744</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_reader($journalu);</td></tr>
<tr><td class="h">1745</td><td colspan="7"></td></tr><tr><td class="h">1746</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $try = 0;</td></tr>
<tr><td class="h">1747</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1747">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{captcha_chal}) {</td></tr>
<tr><td class="h">1748</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$try = $dbcr-&gt;selectrow_array(&#39;SELECT trynum FROM captcha_session &#39; .</td></tr>
<tr><td class="h">1749</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;WHERE sess=?&#39;, undef, $captcha_sess);</td></tr>
<tr><td class="h">1750</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1751</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &#39;&lt;br /&gt;&lt;br /&gt;&#39;;</td></tr>
<tr><td class="h">1752</td><td colspan="7"></td></tr><tr><td class="h">1753</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Visual challenge</td></tr>
<tr><td class="h">1754</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1754">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1754">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! $wants_audio &amp;&amp; ! $form-&gt;{audio_chal}) {</td></tr>
<tr><td class="h">1755</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;div class=&#39;formitemDesc&#39;&gt;$BML::ML{&#39;/create.bml.captcha.desc&#39;}&lt;/div&gt;&quot;;</td></tr>
<tr><td class="h">1756</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;img src=&#39;/captcha/image.bml?chal=$captcha_chal&amp;amp;cid=$cid&amp;amp;try=$try&#39; width=&#39;175&#39; height=&#39;35&#39; /&gt;&quot;;</td></tr>
<tr><td class="h">1757</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;br /&gt;&lt;br /&gt;$BML::ML{&#39;/create.bml.captcha.answer&#39;}&quot;;</td></tr>
<tr><td class="h">1758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1759</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Audio challenge</td></tr>
<tr><td class="h">1760</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</td></tr>
<tr><td class="h">1761</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;div class=&#39;formitemDesc&#39;&gt;$BML::ML{&#39;/create.bml.captcha.audiodesc&#39;}&lt;/div&gt;&quot;;</td></tr>
<tr><td class="h">1762</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;a href=&#39;/captcha/audio.bml?chal=$captcha_chal&amp;amp;cid=$cid&amp;amp;try=$try&#39;&gt;$BML::ML{&#39;/create.bml.captcha.play&#39;}&lt;/a&gt; &amp;nbsp; &quot;;</td></tr>
<tr><td class="h">1763</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::html_hidden(audio_chal =&gt; 1);</td></tr>
<tr><td class="h">1764</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1765</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::html_text({ name =&gt;&#39;answer&#39;, size =&gt;15 });</td></tr>
<tr><td class="h">1766</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::html_hidden(captcha_chal =&gt; $captcha_chal);</td></tr>
<tr><td class="h">1767</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1768</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &#39;&lt;br /&gt;&#39;;</td></tr>
<tr><td class="h">1769</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1770</td><td colspan="7"></td></tr><tr><td class="h">1771</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1771">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $submit_btn = $editid ? LJ::Lang::ml(&#39;.opt.edit&#39;) : LJ::Lang::ml(&#39;.opt.submit&#39;);</td></tr>
<tr><td class="h">1772</td><td colspan="7"></td></tr><tr><td class="h">1773</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# post and preview buttons</td></tr>
<tr><td class="h">1774</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $limit = LJ::CMAX_COMMENT; # javascript String.length uses characters</td></tr>
<tr><td class="h">1775</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &lt;&lt;LOGIN;</td></tr>
<tr><td class="h">1776</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&lt;br /&gt;</td></tr>
<tr><td class="h">1777</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&lt;script language=&quot;JavaScript&quot; type=&#39;text/javascript&#39;&gt;</td></tr>
<tr><td class="h">1778</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;!--</td></tr>
<tr><td class="h">1779</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function checkLength() {</td></tr>
<tr><td class="h">1780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!document.getElementById) return true;</td></tr>
<tr><td class="h">1781</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var textbox = document.getElementById(&#39;commenttext&#39;);</td></tr>
<tr><td class="h">1782</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!textbox) return true;</td></tr>
<tr><td class="h">1783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (textbox.value.length &gt; $limit) {</td></tr>
<tr><td class="h">1784</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alert(&#39;Sorry, but your comment of &#39; + textbox.value.length + &#39; characters exceeds the maximum character length of $limit.  Please try shortening it and then post again.&#39;);</td></tr>
<tr><td class="h">1785</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</td></tr>
<tr><td class="h">1786</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1787</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</td></tr>
<tr><td class="h">1788</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1789</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// --&gt;</td></tr>
<tr><td class="h">1790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/script&gt;</td></tr>
<tr><td class="h">1791</td><td colspan="7"></td></tr><tr><td class="h">1792</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&#39;submit&#39; name=&#39;submitpost&#39; onclick=&#39;return checkLength() &amp;&amp; sendForm(&quot;postform&quot;, &quot;username&quot;)&#39; value=&quot;$submit_btn&quot; /&gt;</td></tr>
<tr><td class="h">1793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nbsp;</td></tr>
<tr><td class="h">1794</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&#39;submit&#39; name=&#39;submitpreview&#39; onclick=&#39;return checkLength() &amp;&amp; sendForm(&quot;postform&quot;, &quot;username&quot;)&#39; value=&quot;$BML::ML{&#39;talk.btn.preview&#39;}&quot; /&gt;</td></tr>
<tr><td class="h">1795</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">LOGIN</td></tr>
<tr><td class="h">1796</td><td colspan="7"></td></tr><tr><td class="h">1797</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1797">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::SPELLER) {</td></tr>
<tr><td class="h">1798</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input type=&#39;checkbox&#39; name=&#39;do_spellcheck&#39; value=&#39;1&#39; id=&#39;spellcheck&#39; /&gt; &lt;label for=&#39;spellcheck&#39;&gt;$BML::ML{&#39;talk.spellcheck&#39;}&lt;/label&gt;&quot;;</td></tr>
<tr><td class="h">1799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1800</td><td colspan="7"></td></tr><tr><td class="h">1801</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1801">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journalu-&gt;opt_logcommentips eq &quot;A&quot;) {</td></tr>
<tr><td class="h">1802</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;br /&gt;$BML::ML{&#39;.logyourip&#39;}&quot;;</td></tr>
<tr><td class="h">1803</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::help_icon_html(&quot;iplogging&quot;, &quot; &quot;);</td></tr>
<tr><td class="h">1804</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1805</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1805">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journalu-&gt;opt_logcommentips eq &quot;S&quot;) {</td></tr>
<tr><td class="h">1806</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;br /&gt;$BML::ML{&#39;.loganonip&#39;}&quot;;</td></tr>
<tr><td class="h">1807</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::help_icon_html(&quot;iplogging&quot;, &quot; &quot;);</td></tr>
<tr><td class="h">1808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1809</td><td colspan="7"></td></tr><tr><td class="h">1810</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::html_hidden( editid =&gt; $editid );</td></tr>
<tr><td class="h">1811</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;;</td></tr>
<tr><td class="h">1812</td><td colspan="7"></td></tr><tr><td class="h">1813</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Some JavaScript to help the UI out</td></tr>
<tr><td class="h">1814</td><td colspan="7"></td></tr><tr><td class="h">1815</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;script type=&#39;text/javascript&#39; language=&#39;JavaScript&#39;&gt;\n&quot;;</td></tr>
<tr><td class="h">1816</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;var usermismatchtext = \&quot;&quot; . LJ::ejs($BML::ML{&#39;.usermismatch&#39;}) . &quot;\&quot;;\n&quot;;</td></tr>
<tr><td class="h">1817</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/script&gt;&lt;script type=&#39;text/javascript&#39; language=&#39;JavaScript&#39; src=&#39;$LJ::JSPREFIX/talkpost.js&#39;&gt;&lt;/script&gt;&quot;;</td></tr>
<tr><td class="h">1818</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/form&gt;\n&quot;;</td></tr>
<tr><td class="h">1819</td><td colspan="7"></td></tr><tr><td class="h">1820</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">1821</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1822</td><td colspan="7"></td></tr><tr><td class="h">1823</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::record_anon_comment_ip</td></tr>
<tr><td class="h">1825</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">1826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Records the IP address of an anonymous comment.</td></tr>
<tr><td class="h">1827</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: journalu, jtalkid, ip</td></tr>
<tr><td class="h">1828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-journalu: User object of journal comment was posted in.</td></tr>
<tr><td class="h">1829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jtalkid: ID of this comment.</td></tr>
<tr><td class="h">1830</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-ip: IP address of the poster.</td></tr>
<tr><td class="h">1831</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 for success, 0 for failure</td></tr>
<tr><td class="h">1832</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1833</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub record_anon_comment_ip {</td></tr>
<tr><td class="h">1834</td><td><div class="c3">210</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L1834">210</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalu, $jtalkid, $ip) = @_;</td></tr>
<tr><td class="h">1835</td><td><div class="c3">210</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu = LJ::want_user($journalu);</td></tr>
<tr><td class="h">1836</td><td><div class="c3">210</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jtalkid += 0;</td></tr>
<tr><td class="h">1837</td><td><div class="c3">210</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L1837">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1837">25</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::isu($journalu) &amp;&amp; $jtalkid &amp;&amp; $ip;</td></tr>
<tr><td class="h">1838</td><td colspan="7"></td></tr><tr><td class="h">1839</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;do(&quot;INSERT INTO tempanonips (reporttime, journalid, jtalkid, ip) VALUES (UNIX_TIMESTAMP(),?,?,?)&quot;,</td></tr>
<tr><td class="h">1840</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $journalu-&gt;{userid}, $jtalkid, $ip);</td></tr>
<tr><td class="h">1841</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1841">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $journalu-&gt;err;</td></tr>
<tr><td class="h">1842</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1843</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1844</td><td colspan="7"></td></tr><tr><td class="h">1845</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1846</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::mark_comment_as_spam</td></tr>
<tr><td class="h">1847</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">1848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Copies a comment into the global [dbtable[spamreports]] table.</td></tr>
<tr><td class="h">1849</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: journalu, jtalkid</td></tr>
<tr><td class="h">1850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-journalu: User object of journal comment was posted in.</td></tr>
<tr><td class="h">1851</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jtalkid: ID of this comment.</td></tr>
<tr><td class="h">1852</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 for success, 0 for failure</td></tr>
<tr><td class="h">1853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1854</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mark_comment_as_spam {</td></tr>
<tr><td class="h">1855</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L1855">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalu, $jtalkid) = @_;</td></tr>
<tr><td class="h">1856</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu = LJ::want_user($journalu);</td></tr>
<tr><td class="h">1857</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jtalkid += 0;</td></tr>
<tr><td class="h">1858</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1858">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1858">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $journalu &amp;&amp; $jtalkid;</td></tr>
<tr><td class="h">1859</td><td colspan="7"></td></tr><tr><td class="h">1860</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($journalu);</td></tr>
<tr><td class="h">1861</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">1862</td><td colspan="7"></td></tr><tr><td class="h">1863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 1: get info we need</td></tr>
<tr><td class="h">1864</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $row = LJ::Talk::get_talk2_row($dbcr, $journalu-&gt;{userid}, $jtalkid);</td></tr>
<tr><td class="h">1865</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $temp = LJ::get_talktext2($journalu, $jtalkid);</td></tr>
<tr><td class="h">1866</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($subject, $body, $posterid) = ($temp-&gt;{$jtalkid}[0], $temp-&gt;{$jtalkid}[1], $row-&gt;{posterid});</td></tr>
<tr><td class="h">1867</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1867">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1867">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless ($body &amp;&amp; $body ne &#39;&#39;);</td></tr>
<tr><td class="h">1868</td><td colspan="7"></td></tr><tr><td class="h">1869</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t mark your own comments as spam.</td></tr>
<tr><td class="h">1870</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1870">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1870">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $posterid &amp;&amp; $posterid == $journalu-&gt;id;</td></tr>
<tr><td class="h">1871</td><td colspan="7"></td></tr><tr><td class="h">1872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 2a: if it&#39;s a suspended user, don&#39;t add, but pretend that we were successful</td></tr>
<tr><td class="h">1873</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1873">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($posterid) {</td></tr>
<tr><td class="h">1874</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $posteru = LJ::want_user($posterid);</td></tr>
<tr><td class="h">1875</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1875">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $posteru-&gt;is_suspended;</td></tr>
<tr><td class="h">1876</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1877</td><td colspan="7"></td></tr><tr><td class="h">1878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 2b: if it was an anonymous comment, attempt to get comment IP to make some use of the report</td></tr>
<tr><td class="h">1879</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ip;</td></tr>
<tr><td class="h">1880</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1880">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($posterid) {</td></tr>
<tr><td class="h">1881</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ip = $dbcr-&gt;selectrow_array(&#39;SELECT ip FROM tempanonips WHERE journalid=? AND jtalkid=?&#39;,</td></tr>
<tr><td class="h">1882</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $journalu-&gt;{userid}, $jtalkid);</td></tr>
<tr><td class="h">1883</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1883">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbcr-&gt;err;</td></tr>
<tr><td class="h">1884</td><td colspan="7"></td></tr><tr><td class="h">1885</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we want to fail out if we have no IP address and this is anonymous, because otherwise</td></tr>
<tr><td class="h">1886</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we have a completely useless spam report.  pretend we were successful, too.</td></tr>
<tr><td class="h">1887</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1887">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $ip;</td></tr>
<tr><td class="h">1888</td><td colspan="7"></td></tr><tr><td class="h">1889</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we also want to log this attempt so that we can do some throttling</td></tr>
<tr><td class="h">1890</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L1890">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rates = LJ::MemCache::get(&quot;spamreports:anon:$ip&quot;) || $RATE_DATAVER;</td></tr>
<tr><td class="h">1891</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rates .= pack(&quot;N&quot;, time);</td></tr>
<tr><td class="h">1892</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set(&quot;spamreports:anon:$ip&quot;, $rates);</td></tr>
<tr><td class="h">1893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1894</td><td colspan="7"></td></tr><tr><td class="h">1895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 3: insert into spamreports</td></tr>
<tr><td class="h">1896</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&#39;INSERT INTO spamreports (reporttime, posttime, ip, journalid, posterid, subject, body) &#39; .</td></tr>
<tr><td class="h">1897</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;VALUES (UNIX_TIMESTAMP(), UNIX_TIMESTAMP(?), ?, ?, ?, ?, ?)&#39;,</td></tr>
<tr><td class="h">1898</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $row-&gt;{datepost}, $ip, $journalu-&gt;{userid}, $posterid, $subject, $body);</td></tr>
<tr><td class="h">1899</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L1899">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">1900</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1902</td><td colspan="7"></td></tr><tr><td class="h">1903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::get_talk2_row</td></tr>
<tr><td class="h">1905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">1906</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets a row of data from [dbtable[talk2]].</td></tr>
<tr><td class="h">1907</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbcr, journalid, jtalkid</td></tr>
<tr><td class="h">1908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-dbcr: Database handle to read from.</td></tr>
<tr><td class="h">1909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-journalid: Journal id that comment is posted in.</td></tr>
<tr><td class="h">1910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jtalkid: Journal talkid of comment.</td></tr>
<tr><td class="h">1911</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Hashref of row data, or undef on error.</td></tr>
<tr><td class="h">1912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1913</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_talk2_row {</td></tr>
<tr><td class="h">1914</td><td><div class="c3">136</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L1914">136</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($dbcr, $journalid, $jtalkid) = @_;</td></tr>
<tr><td class="h">1915</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $dbcr-&gt;selectrow_hashref(&#39;SELECT journalid, jtalkid, nodetype, nodeid, parenttalkid, &#39; .</td></tr>
<tr><td class="h">1916</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;       posterid, datepost, state &#39; .</td></tr>
<tr><td class="h">1917</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;FROM talk2 WHERE journalid = ? AND jtalkid = ?&#39;,</td></tr>
<tr><td class="h">1918</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $journalid+0, $jtalkid+0);</td></tr>
<tr><td class="h">1919</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1920</td><td colspan="7"></td></tr><tr><td class="h">1921</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1922</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::get_talk2_row_multi</td></tr>
<tr><td class="h">1923</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">1924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets multiple rows of data from [dbtable[talk2]].</td></tr>
<tr><td class="h">1925</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: items</td></tr>
<tr><td class="h">1926</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-items: Array of arrayrefs; each arrayref: [ journalu, jtalkid ].</td></tr>
<tr><td class="h">1927</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Array of hashrefs of row data, or undef on error.</td></tr>
<tr><td class="h">1928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1929</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_talk2_row_multi {</td></tr>
<tr><td class="h">1930</td><td><div class="c3">233</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L1930">233</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my (@items) = @_; # [ journalu, jtalkid ], ...</td></tr>
<tr><td class="h">1931</td><td><div class="c3">236</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L1931">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;invalid items for get_talk2_row_multi&quot;)</td></tr>
<tr><td class="h">1932</td><td><div class="c3">233</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L1932">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if grep { ! LJ::isu($_-&gt;[0]) || @$_ != 2 } @items;</td></tr>
<tr><td class="h">1933</td><td colspan="7"></td></tr><tr><td class="h">1934</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# what do we need to load per-journalid</td></tr>
<tr><td class="h">1935</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %need    = (); # journalid =&gt; { jtalkid =&gt; 1, ... }</td></tr>
<tr><td class="h">1936</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %have    = (); # journalid =&gt; { jtalkid =&gt; $row_ref, ... }</td></tr>
<tr><td class="h">1937</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %cluster = (); # cid =&gt; { jid =&gt; journalu, jid =&gt; journalu }</td></tr>
<tr><td class="h">1938</td><td colspan="7"></td></tr><tr><td class="h">1939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# first, what is in memcache?</td></tr>
<tr><td class="h">1940</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @keys = ();</td></tr>
<tr><td class="h">1941</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $it (@items) {</td></tr>
<tr><td class="h">1942</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($journalu, $jtalkid) = @$it;</td></tr>
<tr><td class="h">1943</td><td colspan="7"></td></tr><tr><td class="h">1944</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t load comments in purged users&#39; journals</td></tr>
<tr><td class="h">1945</td><td><div class="c3">236</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L1945">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $journalu-&gt;is_expunged;</td></tr>
<tr><td class="h">1946</td><td colspan="7"></td></tr><tr><td class="h">1947</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cid = $journalu-&gt;clusterid;</td></tr>
<tr><td class="h">1948</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $jid = $journalu-&gt;id;</td></tr>
<tr><td class="h">1949</td><td colspan="7"></td></tr><tr><td class="h">1950</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we need this for now</td></tr>
<tr><td class="h">1951</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$need{$jid}-&gt;{$jtalkid} = 1;</td></tr>
<tr><td class="h">1952</td><td colspan="7"></td></tr><tr><td class="h">1953</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# which cluster is this user on?</td></tr>
<tr><td class="h">1954</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cluster{$cid}-&gt;{$jid} = $journalu;</td></tr>
<tr><td class="h">1955</td><td colspan="7"></td></tr><tr><td class="h">1956</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @keys, LJ::Talk::make_talk2row_memkey($jid, $jtalkid);</td></tr>
<tr><td class="h">1957</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1958</td><td colspan="7"></td></tr><tr><td class="h">1959</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return an array of rows preserving order in which they were requested</td></tr>
<tr><td class="h">1960</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = sub {</td></tr>
<tr><td class="h">1961</td><td><div class="c3">233</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L1961">233</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @ret = ();</td></tr>
<tr><td class="h">1962</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $it (@items) {</td></tr>
<tr><td class="h">1963</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($journalu, $jtalkid) = @$it;</td></tr>
<tr><td class="h">1964</td><td><div class="c3">236</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @ret, $have{$journalu-&gt;id}-&gt;{$jtalkid};</td></tr>
<tr><td class="h">1965</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1966</td><td colspan="7"></td></tr><tr><td class="h">1967</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return @ret;</td></tr>
<tr><td class="h">1968</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1969</td><td colspan="7"></td></tr><tr><td class="h">1970</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mem = LJ::MemCache::get_multi(@keys);</td></tr>
<tr><td class="h">1971</td><td><div class="c3">233</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L1971">50</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($mem) {</td></tr>
<tr><td class="h">1972</td><td><div class="c3">233</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($key, $array) = each %$mem) {</td></tr>
<tr><td class="h">1973</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my (undef, $jid, $jtalkid) = split(&quot;:&quot;, $key);</td></tr>
<tr><td class="h">1974</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $row = LJ::MemCache::array_to_hash(&quot;talk2row&quot;, $array);</td></tr>
<tr><td class="h">1975</td><td><div class="c3">6</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L1975">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $row;</td></tr>
<tr><td class="h">1976</td><td colspan="7"></td></tr><tr><td class="h">1977</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# add in implicit keys:</td></tr>
<tr><td class="h">1978</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row-&gt;{journalid} = $jid;</td></tr>
<tr><td class="h">1979</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row-&gt;{jtalkid}   = $jtalkid;</td></tr>
<tr><td class="h">1980</td><td colspan="7"></td></tr><tr><td class="h">1981</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# update our needs</td></tr>
<tr><td class="h">1982</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$have{$jid}-&gt;{$jtalkid} = $row;</td></tr>
<tr><td class="h">1983</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $need{$jid}-&gt;{$jtalkid};</td></tr>
<tr><td class="h">1984</td><td><div class="c3">6</div><div class="c3">6</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L1984">100</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $need{$jid} unless %{$need{$jid}}</td></tr>
<tr><td class="h">1985</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1986</td><td colspan="7"></td></tr><tr><td class="h">1987</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# was everything in memcache?</td></tr>
<tr><td class="h">1988</td><td><div class="c3">233</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L1988">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $ret-&gt;() unless %need;</td></tr>
<tr><td class="h">1989</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1990</td><td colspan="7"></td></tr><tr><td class="h">1991</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# uh oh, we have things to retrieve from the db!</td></tr>
<tr><td class="h">1992</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;CLUSTER:</td></tr>
<tr><td class="h">1993</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $cid (keys %cluster) {</td></tr>
<tr><td class="h">1994</td><td colspan="7"></td></tr><tr><td class="h">1995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# build up a valid where clause for this cluster&#39;s select</td></tr>
<tr><td class="h">1996</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @vals = ();</td></tr>
<tr><td class="h">1997</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @where = ();</td></tr>
<tr><td class="h">1998</td><td><div class="c3">229</div><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $journalu (values %{$cluster{$cid}}) {</td></tr>
<tr><td class="h">1999</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $jid = $journalu-&gt;id;</td></tr>
<tr><td class="h">2000</td><td><div class="c3">229</div><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @jtalkids = keys %{$need{$jid}};</td></tr>
<tr><td class="h">2001</td><td><div class="c3">229</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2001">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless @jtalkids;</td></tr>
<tr><td class="h">2002</td><td colspan="7"></td></tr><tr><td class="h">2003</td><td><div class="c3">229</div><div class="c3">230</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $bind = join(&quot;,&quot;, map { &quot;?&quot; } @jtalkids);</td></tr>
<tr><td class="h">2004</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @where, &quot;(journalid=? AND jtalkid IN ($bind))&quot;;</td></tr>
<tr><td class="h">2005</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @vals, $jid =&gt; @jtalkids;</td></tr>
<tr><td class="h">2006</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2007</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# is there anything to actually query for this cluster?</td></tr>
<tr><td class="h">2008</td><td><div class="c3">229</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2008">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next CLUSTER unless @vals;</td></tr>
<tr><td class="h">2009</td><td colspan="7"></td></tr><tr><td class="h">2010</td><td><div class="c3">229</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2010">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_reader($cid)</td></tr>
<tr><td class="h">2011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;unable to get cluster reader: $cid&quot;;</td></tr>
<tr><td class="h">2012</td><td colspan="7"></td></tr><tr><td class="h">2013</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $where = join(&quot; OR &quot;, @where);</td></tr>
<tr><td class="h">2014</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbcr-&gt;prepare</td></tr>
<tr><td class="h">2015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&quot;SELECT journalid, jtalkid, nodetype, nodeid, parenttalkid, &quot; .</td></tr>
<tr><td class="h">2016</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;       posterid, datepost, state &quot; .</td></tr>
<tr><td class="h">2017</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM talk2 WHERE $where&quot;);</td></tr>
<tr><td class="h">2018</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>136004</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute(@vals);</td></tr>
<tr><td class="h">2019</td><td colspan="7"></td></tr><tr><td class="h">2020</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my $row = $sth-&gt;fetchrow_hashref) {</td></tr>
<tr><td class="h">2021</td><td><div class="c3">230</div></td><td></td><td></td><td></td><td></td><td><div>20000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $jid = $row-&gt;{journalid};</td></tr>
<tr><td class="h">2022</td><td><div class="c3">230</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $jtalkid = $row-&gt;{jtalkid};</td></tr>
<tr><td class="h">2023</td><td colspan="7"></td></tr><tr><td class="h">2024</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# update our needs</td></tr>
<tr><td class="h">2025</td><td><div class="c3">230</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$have{$jid}-&gt;{$jtalkid} = $row;</td></tr>
<tr><td class="h">2026</td><td><div class="c3">230</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $need{$jid}-&gt;{$jtalkid};</td></tr>
<tr><td class="h">2027</td><td><div class="c3">230</div><div class="c3">230</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L2027">100</a></div></td><td></td><td></td><td></td><td><div>0</div><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $need{$jid} unless %{$need{$jid}};</td></tr>
<tr><td class="h">2028</td><td colspan="7"></td></tr><tr><td class="h">2029</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# update memcache</td></tr>
<tr><td class="h">2030</td><td><div class="c3">230</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::add_talk2row_memcache($jid, $jtalkid, $row);</td></tr>
<tr><td class="h">2031</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2032</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2033</td><td colspan="7"></td></tr><tr><td class="h">2034</td><td><div class="c3">229</div></td><td></td><td></td><td></td><td></td><td><div>24002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret-&gt;();</td></tr>
<tr><td class="h">2035</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2036</td><td colspan="7"></td></tr><tr><td class="h">2037</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub make_talk2row_memkey {</td></tr>
<tr><td class="h">2038</td><td><div class="c3">660</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L2038">660</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($jid, $jtalkid) = @_;</td></tr>
<tr><td class="h">2039</td><td><div class="c3">660</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return [ $jid, join(&quot;:&quot;, &quot;talk2row&quot;, $jid, $jtalkid) ];</td></tr>
<tr><td class="h">2040</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2041</td><td colspan="7"></td></tr><tr><td class="h">2042</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub add_talk2row_memcache {</td></tr>
<tr><td class="h">2043</td><td><div class="c3">424</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L2043">424</a></div></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($jid, $jtalkid, $row) = @_;</td></tr>
<tr><td class="h">2044</td><td colspan="7"></td></tr><tr><td class="h">2045</td><td><div class="c3">424</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = LJ::Talk::make_talk2row_memkey($jid, $jtalkid);</td></tr>
<tr><td class="h">2046</td><td><div class="c3">424</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $exptime = 60*30;</td></tr>
<tr><td class="h">2047</td><td><div class="c3">424</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $array = LJ::MemCache::hash_to_array(&quot;talk2row&quot;, $row);</td></tr>
<tr><td class="h">2048</td><td colspan="7"></td></tr><tr><td class="h">2049</td><td><div class="c3">424</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::MemCache::add($memkey, $array, $exptime);</td></tr>
<tr><td class="h">2050</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2051</td><td colspan="7"></td></tr><tr><td class="h">2052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub invalidate_talk2row_memcache {</td></tr>
<tr><td class="h">2053</td><td><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L2053">6</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($jid, @jtalkids) = @_;</td></tr>
<tr><td class="h">2054</td><td colspan="7"></td></tr><tr><td class="h">2055</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $jtalkid (@jtalkids) {</td></tr>
<tr><td class="h">2056</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [ $jid, &quot;talk2row:$jid:$jtalkid&quot; ];</td></tr>
<tr><td class="h">2057</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete($memkey);</td></tr>
<tr><td class="h">2058</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2059</td><td colspan="7"></td></tr><tr><td class="h">2060</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2062</td><td colspan="7"></td></tr><tr><td class="h">2063</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># get a comment count for a journal entry.</td></tr>
<tr><td class="h">2064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_replycount {</td></tr>
<tr><td class="h">2065</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2065">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($ju, $jitemid) = @_;</td></tr>
<tr><td class="h">2066</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jitemid += 0;</td></tr>
<tr><td class="h">2067</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2067">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2067">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $ju &amp;&amp; $jitemid;</td></tr>
<tr><td class="h">2068</td><td colspan="7"></td></tr><tr><td class="h">2069</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$ju-&gt;{&#39;userid&#39;}, &quot;rp:$ju-&gt;{&#39;userid&#39;}:$jitemid&quot;];</td></tr>
<tr><td class="h">2070</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">2071</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2071">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $count if $count;</td></tr>
<tr><td class="h">2072</td><td colspan="7"></td></tr><tr><td class="h">2073</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($ju);</td></tr>
<tr><td class="h">2074</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2074">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $dbcr;</td></tr>
<tr><td class="h">2075</td><td colspan="7"></td></tr><tr><td class="h">2076</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$count = $dbcr-&gt;selectrow_array(&quot;SELECT replycount FROM log2 WHERE &quot; .</td></tr>
<tr><td class="h">2077</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;journalid=? AND jitemid=?&quot;, undef,</td></tr>
<tr><td class="h">2078</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ju-&gt;{&#39;userid&#39;}, $jitemid);</td></tr>
<tr><td class="h">2079</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add($memkey, $count);</td></tr>
<tr><td class="h">2080</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $count;</td></tr>
<tr><td class="h">2081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2082</td><td colspan="7"></td></tr><tr><td class="h">2083</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub comment_htmlid {</td></tr>
<tr><td class="h">2084</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2084">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2084">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $id = shift or return &#39;&#39;;</td></tr>
<tr><td class="h">2085</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;cmt$id&quot;;</td></tr>
<tr><td class="h">2086</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2087</td><td colspan="7"></td></tr><tr><td class="h">2088</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub comment_anchor {</td></tr>
<tr><td class="h">2089</td><td><div class="c3">3</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2089">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L2089">3</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $id = shift or return &#39;&#39;;</td></tr>
<tr><td class="h">2090</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;#cmt$id&quot;;</td></tr>
<tr><td class="h">2091</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2092</td><td colspan="7"></td></tr><tr><td class="h">2093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ::Talk::Post;</td></tr>
<tr><td class="h">2094</td><td colspan="7"></td></tr><tr><td class="h">2095</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L2095">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use Text::Wrap;</td></tr>
<tr><td class="h">2096</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L2096">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::EventLogRecord::NewComment;</td></tr>
<tr><td class="h">2097</td><td colspan="7"></td></tr><tr><td class="h">2098</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub indent {</td></tr>
<tr><td class="h">2099</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2099">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $a = shift;</td></tr>
<tr><td class="h">2100</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2100">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $leadchar = shift || &quot; &quot;;</td></tr>
<tr><td class="h">2101</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$Text::Wrap::columns = 76;</td></tr>
<tr><td class="h">2102</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return Text::Wrap::wrap(&quot;$leadchar &quot;, &quot;$leadchar &quot;, $a);</td></tr>
<tr><td class="h">2103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2104</td><td colspan="7"></td></tr><tr><td class="h">2105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub blockquote {</td></tr>
<tr><td class="h">2106</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2106">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $a = shift;</td></tr>
<tr><td class="h">2107</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;blockquote style=&#39;border-left: #000040 2px solid; margin-left: 0px; margin-right: 0px; padding-left: 15px; padding-right: 0px&#39;&gt;$a&lt;/blockquote&gt;&quot;;</td></tr>
<tr><td class="h">2108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2109</td><td colspan="7"></td></tr><tr><td class="h">2110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub generate_messageid {</td></tr>
<tr><td class="h">2111</td><td><div class="c3">564</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L2111">564</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($type, $journalu, $did) = @_;</td></tr>
<tr><td class="h">2112</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# $type = {&quot;entry&quot; | &quot;comment&quot;}</td></tr>
<tr><td class="h">2113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# $journalu = $u of journal</td></tr>
<tr><td class="h">2114</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# $did = display id of comment/entry</td></tr>
<tr><td class="h">2115</td><td colspan="7"></td></tr><tr><td class="h">2116</td><td><div class="c3">564</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jid = $journalu-&gt;{userid};</td></tr>
<tr><td class="h">2117</td><td><div class="c3">564</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;$type-$jid-$did\@$LJ::DOMAIN&gt;&quot;;</td></tr>
<tr><td class="h">2118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2119</td><td colspan="7"></td></tr><tr><td class="h">2120</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">my @_ml_strings_en = (</td></tr>
<tr><td class="h">2121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.fromname.user&#39;,                      # &quot;[[user]] - [[sitenameabbrev]] Comment&quot;,</td></tr>
<tr><td class="h">2122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.fromname.anonymous&#39;,                 # &quot;[[sitenameshort]] Comment&quot;,</td></tr>
<tr><td class="h">2123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.subject.edit_reply_to_your_comment&#39;, # &quot;Edited reply to your comment...&quot;,</td></tr>
<tr><td class="h">2124</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.subject.reply_to_your_comment&#39;,      # &quot;Reply to your comment...&quot;,</td></tr>
<tr><td class="h">2125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.subject.edit_reply_to_your_entry&#39;,   # &quot;Edited reply to your entry...&quot;,</td></tr>
<tr><td class="h">2126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.subject.reply_to_your_entry&#39;,        # &quot;Reply to your entry...&quot;,</td></tr>
<tr><td class="h">2127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.subject.edit_reply_to_a_comment&#39;,    # &quot;Edited reply to a comment...&quot;,</td></tr>
<tr><td class="h">2128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.subject.reply_to_a_comment&#39;,         # &quot;Reply to a comment...&quot;,</td></tr>
<tr><td class="h">2129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.subject.comment_you_posted&#39;,         # &quot;Comment you posted...&quot;,</td></tr>
<tr><td class="h">2130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.mail_comments.subject.comment_you_edited&#39;,         # &quot;Comment you edited...&quot;,</td></tr>
<tr><td class="h">2131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">);</td></tr>
<tr><td class="h">2132</td><td colspan="7"></td></tr><tr><td class="h">2133</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _format_headers {</td></tr>
<tr><td class="h">2134</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2134">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $lang, $encoding, $comment, $u, $edited, $parent, $paru, $entry ) = @_;</td></tr>
<tr><td class="h">2135</td><td colspan="7"></td></tr><tr><td class="h">2136</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2136">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $vars = {</td></tr>
<tr><td class="h">2137</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user            =&gt; $comment-&gt;{u} ? $comment-&gt;{u}-&gt;display_username : &#39;&#39;,</td></tr>
<tr><td class="h">2138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sitenameabbrev  =&gt; $LJ::SITENAMEABBREV,</td></tr>
<tr><td class="h">2139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sitenameshort   =&gt; $LJ::SITENAMESHORT,</td></tr>
<tr><td class="h">2140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2141</td><td colspan="7"></td></tr><tr><td class="h">2142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry_obj = LJ::Entry-&gt;new( $entry-&gt;{journalid}, ditemid =&gt; $entry-&gt;{ditemid} );</td></tr>
<tr><td class="h">2143</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry_details = &#39;&#39;;</td></tr>
<tr><td class="h">2144</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2144">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2144">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $entry_obj &amp;&amp; $entry_obj-&gt;journal ) {</td></tr>
<tr><td class="h">2145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_details = &#39; [ &#39; . $entry_obj-&gt;journal-&gt;display_name . &#39; - &#39; . $entry_obj-&gt;ditemid . &#39; ]&#39;;</td></tr>
<tr><td class="h">2146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2147</td><td colspan="7"></td></tr><tr><td class="h">2148</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($headersubject, $fromname);</td></tr>
<tr><td class="h">2149</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2149">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($headersubject = $comment-&gt;{subject}) {</td></tr>
<tr><td class="h">2150</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $key = &#39;esn.mail_comments.subject.&#39;;</td></tr>
<tr><td class="h">2151</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2151">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::u_equals($comment-&gt;{u}, $u)) {</td></tr>
<tr><td class="h">2152</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2152">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key .= &#39;comment_you_&#39;. ($edited ? &#39;edited&#39; : &#39;posted&#39;);</td></tr>
<tr><td class="h">2153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2154</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2154">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($parent-&gt;{talkid}) {</td></tr>
<tr><td class="h">2155</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2155">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(LJ::u_equals($paru, $u)) {</td></tr>
<tr><td class="h">2156</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2156">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key .= ($edited ? &#39;edit_&#39; : &#39;&#39;) . &#39;reply_to_your_comment&#39;;</td></tr>
<tr><td class="h">2157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2158</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2158">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key .= ($edited ? &#39;edit_&#39; : &#39;&#39;) . &#39;reply_to_a_comment&#39;;</td></tr>
<tr><td class="h">2159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2160</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2161</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2161">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key .= ($edited ? &#39;edit_&#39; : &#39;&#39;) . &#39;reply_to_your_entry&#39;;</td></tr>
<tr><td class="h">2162</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2164</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headersubject = LJ::Lang::get_text($lang, $key, undef, $vars);</td></tr>
<tr><td class="h">2165</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2166</td><td colspan="7"></td></tr><tr><td class="h">2167</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$headersubject .= $entry_details;</td></tr>
<tr><td class="h">2168</td><td colspan="7"></td></tr><tr><td class="h">2169</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2169">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($comment-&gt;{u}) {</td></tr>
<tr><td class="h">2170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# external users has lj-logins as &#39;ext_*&#39;, so</td></tr>
<tr><td class="h">2171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we call external user by name, our user - by login.</td></tr>
<tr><td class="h">2172</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$vars-&gt;{user} = $comment-&gt;{u}-&gt;display_username;</td></tr>
<tr><td class="h">2173</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fromname = LJ::Lang::get_text($lang, &#39;esn.mail_comments.fromname.user&#39;, undef, $vars);</td></tr>
<tr><td class="h">2174</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2175</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fromname = LJ::Lang::get_text($lang, &#39;esn.mail_comments.fromname.anonymous&#39;, undef, $vars);</td></tr>
<tr><td class="h">2176</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2177</td><td colspan="7"></td></tr><tr><td class="h">2178</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2178">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2178">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $encoding ne &quot;UTF-8&quot;) {</td></tr>
<tr><td class="h">2179</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fromname = Unicode::MapUTF8::from_utf8({-string=&gt;$fromname, -charset=&gt;$encoding});</td></tr>
<tr><td class="h">2180</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headersubject = Unicode::MapUTF8::from_utf8({-string=&gt;$headersubject, -charset=&gt;$encoding});</td></tr>
<tr><td class="h">2181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2182</td><td colspan="7"></td></tr><tr><td class="h">2183</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2183">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!LJ::is_ascii($fromname)) {</td></tr>
<tr><td class="h">2184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fromname = MIME::Words::encode_mimeword($fromname, &#39;B&#39;, $encoding);</td></tr>
<tr><td class="h">2185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2186</td><td colspan="7"></td></tr><tr><td class="h">2187</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2187">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!LJ::is_ascii($headersubject)) {</td></tr>
<tr><td class="h">2188</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headersubject = MIME::Words::encode_mimeword($headersubject, &#39;B&#39;, $encoding);</td></tr>
<tr><td class="h">2189</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2190</td><td colspan="7"></td></tr><tr><td class="h">2191</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ( $headersubject, $fromname );</td></tr>
<tr><td class="h">2192</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2193</td><td colspan="7"></td></tr><tr><td class="h">2194</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># entryu     : user who posted the entry this comment is under.</td></tr>
<tr><td class="h">2195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># journalu   : journal this entry is in.</td></tr>
<tr><td class="h">2196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># parent     : comment/entry this post is in response to.</td></tr>
<tr><td class="h">2197</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># comment    : the comment itself.</td></tr>
<tr><td class="h">2198</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># item       : entry this comment falls under.</td></tr>
<tr><td class="h">2199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mail_comments {</td></tr>
<tr><td class="h">2200</td><td><div class="c3">214</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L2200">214</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($entryu, $journalu, $parent, $comment, $item) = @_;</td></tr>
<tr><td class="h">2201</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemid = $item-&gt;{itemid};</td></tr>
<tr><td class="h">2202</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $itemid*256 + $item-&gt;{anum};</td></tr>
<tr><td class="h">2203</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dtalkid = $comment-&gt;{talkid}*256 + $item-&gt;{anum};</td></tr>
<tr><td class="h">2204</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $talkurl = LJ::journal_base($journalu) . &quot;/$ditemid.html&quot;;</td></tr>
<tr><td class="h">2205</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $threadurl = LJ::Talk::talkargs($talkurl, &quot;thread=$dtalkid&quot;);</td></tr>
<tr><td class="h">2206</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2206">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $edited = $comment-&gt;{editid} ? 1 : 0;</td></tr>
<tr><td class="h">2207</td><td colspan="7"></td></tr><tr><td class="h">2208</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: here we have to use existent comment object, not try to create temporary one.</td></tr>
<tr><td class="h">2209</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comment_obj = LJ::Comment-&gt;new($journalu, dtalkid =&gt; $dtalkid);</td></tr>
<tr><td class="h">2210</td><td colspan="7"></td></tr><tr><td class="h">2211</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check to see if parent post is from a registered livejournal user, and</td></tr>
<tr><td class="h">2212</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# mail them the response</td></tr>
<tr><td class="h">2213</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parentcomment = &quot;&quot;;</td></tr>
<tr><td class="h">2214</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parentmailed = &quot;&quot;;  # who if anybody was just mailed</td></tr>
<tr><td class="h">2215</td><td colspan="7"></td></tr><tr><td class="h">2216</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# message ID of the mythical top-level journal entry (which</td></tr>
<tr><td class="h">2217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# currently is never emailed) so mail clients can group things</td></tr>
<tr><td class="h">2218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# together with a comment ancestor if parents are missing</td></tr>
<tr><td class="h">2219</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $top_msgid = generate_messageid(&quot;entry&quot;, $journalu, $ditemid);</td></tr>
<tr><td class="h">2220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# find first parent</td></tr>
<tr><td class="h">2221</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $par_msgid;</td></tr>
<tr><td class="h">2222</td><td><div class="c3">214</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L2222">100</a></div></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $ptid = $parent-&gt;{talkid}) {</td></tr>
<tr><td class="h">2223</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$par_msgid = generate_messageid(&quot;comment&quot;, $journalu,</td></tr>
<tr><td class="h">2224</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ptid * 256 + $item-&gt;{anum});</td></tr>
<tr><td class="h">2225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# is a reply to the top-level</td></tr>
<tr><td class="h">2227</td><td><div class="c3">78</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$par_msgid = $top_msgid;</td></tr>
<tr><td class="h">2228</td><td><div class="c3">78</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$top_msgid = &quot;&quot;;  # so it&#39;s not duplicated</td></tr>
<tr><td class="h">2229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# and this message ID</td></tr>
<tr><td class="h">2231</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $this_msgid = generate_messageid(&quot;comment&quot;, $journalu, $dtalkid);</td></tr>
<tr><td class="h">2232</td><td colspan="7"></td></tr><tr><td class="h">2233</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($lang, $encoding);</td></tr>
<tr><td class="h">2234</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($headersubject, $fromname);</td></tr>
<tr><td class="h">2235</td><td colspan="7"></td></tr><tr><td class="h">2236</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $paru;</td></tr>
<tr><td class="h">2237</td><td colspan="7"></td></tr><tr><td class="h">2238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if a response to another comment, send a mail to the parent commenter.</td></tr>
<tr><td class="h">2239</td><td><div class="c3">214</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L2239">100</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($parent-&gt;{talkid}) {</td></tr>
<tr><td class="h">2240</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($journalu);</td></tr>
<tr><td class="h">2241</td><td colspan="7"></td></tr><tr><td class="h">2242</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get row of data</td></tr>
<tr><td class="h">2243</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $row = LJ::Talk::get_talk2_row($dbcr, $journalu-&gt;{userid}, $parent-&gt;{talkid});</td></tr>
<tr><td class="h">2244</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $paruserid = $row-&gt;{posterid};</td></tr>
<tr><td class="h">2245</td><td colspan="7"></td></tr><tr><td class="h">2246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# now get body of comment</td></tr>
<tr><td class="h">2247</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $temp = LJ::get_talktext2($journalu, $parent-&gt;{talkid});</td></tr>
<tr><td class="h">2248</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $parbody = $temp-&gt;{$parent-&gt;{talkid}}[1];</td></tr>
<tr><td class="h">2249</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_uncompress(\$parbody);</td></tr>
<tr><td class="h">2250</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parentcomment = $parbody;</td></tr>
<tr><td class="h">2251</td><td colspan="7"></td></tr><tr><td class="h">2252</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %props = ($parent-&gt;{talkid} =&gt; {});</td></tr>
<tr><td class="h">2253</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_talk_props2($dbcr, $journalu-&gt;{&#39;userid&#39;}, [$parent-&gt;{talkid}], \%props);</td></tr>
<tr><td class="h">2254</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{preformat} = $props{$parent-&gt;{talkid}}-&gt;{&#39;opt_preformatted&#39;};</td></tr>
<tr><td class="h">2255</td><td colspan="7"></td></tr><tr><td class="h">2256</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# convert to UTF-8 if necessary</td></tr>
<tr><td class="h">2257</td><td><div class="c3">136</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $parentsubject = $parent-&gt;{subject};</td></tr>
<tr><td class="h">2258</td><td><div class="c3">136</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2258">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2258">33</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $props{$parent-&gt;{talkid}}-&gt;{&#39;unknown8bit&#39;}) {</td></tr>
<tr><td class="h">2259</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::item_toutf8($journalu, \$parentsubject, \$parentcomment, {});</td></tr>
<tr><td class="h">2260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2261</td><td colspan="7"></td></tr><tr><td class="h">2262</td><td><div class="c3">136</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L2262">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($paruserid) {</td></tr>
<tr><td class="h">2263</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$paru = LJ::load_userid($paruserid);</td></tr>
<tr><td class="h">2264</td><td colspan="7"></td></tr><tr><td class="h">2265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we don&#39;t want to send email to a parent if the email address on the</td></tr>
<tr><td class="h">2266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# parent&#39;s user is the same as the email address on this comment&#39;s user</td></tr>
<tr><td class="h">2267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# is_diff_email: also so we don&#39;t auto-vivify $comment-&gt;{u}</td></tr>
<tr><td class="h">2268</td><td><div class="c3">1</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2268">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $is_diff_email = !$comment-&gt;{u} ||</td></tr>
<tr><td class="h">2269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$paru-&gt;email_raw ne $comment-&gt;{u}-&gt;email_raw;</td></tr>
<tr><td class="h">2270</td><td colspan="7"></td></tr><tr><td class="h">2271</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2271">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2271">14</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($paru-&gt;{&#39;opt_gettalkemail&#39;} eq &quot;Y&quot; &amp;&amp;</td></tr>
<tr><td class="h">2272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$paru-&gt;is_visible &amp;&amp;</td></tr>
<tr><td class="h">2273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_diff_email &amp;&amp;</td></tr>
<tr><td class="h">2274</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$paru-&gt;{&#39;status&#39;} eq &quot;A&quot; &amp;&amp;</td></tr>
<tr><td class="h">2275</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$paru-&gt;gets_notified(journal =&gt; $journalu, arg1 =&gt; $ditemid, arg2 =&gt; $comment-&gt;{talkid}) </td></tr>
<tr><td class="h">2276</td><td colspan="7"></td></tr><tr><td class="h">2277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# it is possible to register a hook which will intercept this entire conditional block</td></tr>
<tr><td class="h">2278</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# and do its own logic... if that&#39;s the case and the hook returns true, then we&#39;ll</td></tr>
<tr><td class="h">2279</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# skip creating the email notification</td></tr>
<tr><td class="h">2280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; ! LJ::run_hook(&quot;talklib_email_parent_comment_poster&quot;, </td></tr>
<tr><td class="h">2281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user =&gt; $paru, journal =&gt; $journalu, talkid =&gt; $comment-&gt;{talkid}</td></tr>
<tr><td class="h">2282</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">2283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">2284</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2285</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parentmailed = $paru-&gt;email_raw;</td></tr>
<tr><td class="h">2286</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2286">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$encoding = $paru-&gt;mailencoding || &quot;UTF-8&quot;;</td></tr>
<tr><td class="h">2287</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $part;</td></tr>
<tr><td class="h">2288</td><td colspan="7"></td></tr><tr><td class="h">2289</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Now we going to send email to &#39;$paru&#39;.</td></tr>
<tr><td class="h">2290</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lang = $paru-&gt;prop(&#39;browselang&#39;);</td></tr>
<tr><td class="h">2291</td><td colspan="7"></td></tr><tr><td class="h">2292</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($headersubject, $fromname) = _format_headers( $lang, $encoding, $comment, $paru, $edited, $parent, $paru, $item );</td></tr>
<tr><td class="h">2293</td><td colspan="7"></td></tr><tr><td class="h">2294</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg =  new MIME::Lite (&#39;From&#39; =&gt; &quot;\&quot;$fromname\&quot; &lt;$LJ::BOGUS_EMAIL&gt;&quot;,</td></tr>
<tr><td class="h">2295</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;To&#39; =&gt; $paru-&gt;email_raw,</td></tr>
<tr><td class="h">2296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Subject&#39; =&gt; $headersubject,</td></tr>
<tr><td class="h">2297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Type&#39; =&gt; &#39;multipart/alternative&#39;,</td></tr>
<tr><td class="h">2298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Message-Id&#39; =&gt; $this_msgid,</td></tr>
<tr><td class="h">2299</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;In-Reply-To:&#39; =&gt; $par_msgid,</td></tr>
<tr><td class="h">2300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;References&#39; =&gt; &quot;$top_msgid $par_msgid&quot;,</td></tr>
<tr><td class="h">2301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2302</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$msg-&gt;add(&#39;X-LJ-JOURNAL&#39; =&gt; $journalu-&gt;{&#39;user&#39;}); # for mail filters</td></tr>
<tr><td class="h">2303</td><td colspan="7"></td></tr><tr><td class="h">2304</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{u} = $paru;</td></tr>
<tr><td class="h">2305</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{body} = $parentcomment;</td></tr>
<tr><td class="h">2306</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{ispost} = 0;</td></tr>
<tr><td class="h">2307</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{entryu} = $entryu;</td></tr>
<tr><td class="h">2308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{journalu} = $journalu;</td></tr>
<tr><td class="h">2309</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $text = $comment_obj-&gt;format_text_mail($paru);</td></tr>
<tr><td class="h">2310</td><td colspan="7"></td></tr><tr><td class="h">2311</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2311">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2311">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $encoding ne &quot;UTF-8&quot;) {</td></tr>
<tr><td class="h">2312</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = Unicode::MapUTF8::from_utf8({-string=&gt;$text, -charset=&gt;$encoding});</td></tr>
<tr><td class="h">2313</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2314</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part = $msg-&gt;attach(&#39;Type&#39; =&gt; &#39;TEXT&#39;,</td></tr>
<tr><td class="h">2315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Data&#39; =&gt; $text,</td></tr>
<tr><td class="h">2316</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Encoding&#39; =&gt; &#39;quoted-printable&#39;,</td></tr>
<tr><td class="h">2317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2318</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2318">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part-&gt;attr(&quot;content-type.charset&quot; =&gt; $encoding)</td></tr>
<tr><td class="h">2319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $LJ::UNICODE;</td></tr>
<tr><td class="h">2320</td><td colspan="7"></td></tr><tr><td class="h">2321</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2321">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($paru-&gt;{&#39;opt_htmlemail&#39;} eq &quot;Y&quot;) {</td></tr>
<tr><td class="h">2322</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $html = $comment_obj-&gt;format_html_mail($paru);</td></tr>
<tr><td class="h">2323</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2323">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2323">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $encoding ne &quot;UTF-8&quot;) {</td></tr>
<tr><td class="h">2324</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$html = Unicode::MapUTF8::from_utf8({-string=&gt;$html, -charset=&gt;$encoding});</td></tr>
<tr><td class="h">2325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2326</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part = $msg-&gt;attach(&#39;Type&#39; =&gt; &#39;text/html&#39;,</td></tr>
<tr><td class="h">2327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Data&#39; =&gt; $html,</td></tr>
<tr><td class="h">2328</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Encoding&#39; =&gt; &#39;quoted-printable&#39;,</td></tr>
<tr><td class="h">2329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2330</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2330">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part-&gt;attr(&quot;content-type.charset&quot; =&gt; $encoding)</td></tr>
<tr><td class="h">2331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $LJ::UNICODE;</td></tr>
<tr><td class="h">2332</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2333</td><td colspan="7"></td></tr><tr><td class="h">2334</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::send_mail($msg);</td></tr>
<tr><td class="h">2335</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2338</td><td colspan="7"></td></tr><tr><td class="h">2339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# send mail to the poster of the entry</td></tr>
<tr><td class="h">2340</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2340">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2340">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($entryu-&gt;{&#39;opt_gettalkemail&#39;} eq &quot;Y&quot; &amp;&amp;</td></tr>
<tr><td class="h">2341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entryu-&gt;is_visible &amp;&amp;</td></tr>
<tr><td class="h">2342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$item-&gt;{props}-&gt;{&#39;opt_noemail&#39;} &amp;&amp;</td></tr>
<tr><td class="h">2343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!LJ::u_equals($comment-&gt;{u}, $entryu) &amp;&amp;</td></tr>
<tr><td class="h">2344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entryu-&gt;email_raw ne $parentmailed &amp;&amp;</td></tr>
<tr><td class="h">2345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entryu-&gt;{&#39;status&#39;} eq &quot;A&quot; &amp;&amp;</td></tr>
<tr><td class="h">2346</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$entryu-&gt;gets_notified(journal =&gt; $journalu, arg1 =&gt; $ditemid, arg2 =&gt; $comment-&gt;{talkid})</td></tr>
<tr><td class="h">2347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">2348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2349</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($entryu, &#39;mailencoding&#39;);</td></tr>
<tr><td class="h">2350</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $part;</td></tr>
<tr><td class="h">2351</td><td colspan="7"></td></tr><tr><td class="h">2352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Now we going to send email to &#39;$entryu&#39;.</td></tr>
<tr><td class="h">2353</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lang = $entryu-&gt;prop(&#39;browselang&#39;);</td></tr>
<tr><td class="h">2354</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2354">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$encoding = $entryu-&gt;mailencoding || &quot;UTF-8&quot;;</td></tr>
<tr><td class="h">2355</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($headersubject, $fromname) = _format_headers( $lang, $encoding, $comment, $entryu, $edited, $parent, $paru, $item );</td></tr>
<tr><td class="h">2356</td><td colspan="7"></td></tr><tr><td class="h">2357</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg =  new MIME::Lite (&#39;From&#39; =&gt; &quot;\&quot;$fromname\&quot; &lt;$LJ::BOGUS_EMAIL&gt;&quot;,</td></tr>
<tr><td class="h">2358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;To&#39; =&gt; $entryu-&gt;email_raw,</td></tr>
<tr><td class="h">2359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Subject&#39; =&gt; $headersubject,</td></tr>
<tr><td class="h">2360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Type&#39; =&gt; &#39;multipart/alternative&#39;,</td></tr>
<tr><td class="h">2361</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Message-Id&#39; =&gt; $this_msgid,</td></tr>
<tr><td class="h">2362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;In-Reply-To:&#39; =&gt; $par_msgid,</td></tr>
<tr><td class="h">2363</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;References&#39; =&gt; &quot;$top_msgid $par_msgid&quot;,</td></tr>
<tr><td class="h">2364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2365</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$msg-&gt;add(&#39;X-LJ-JOURNAL&#39; =&gt; $journalu-&gt;{&#39;user&#39;}); # for mail filters</td></tr>
<tr><td class="h">2366</td><td colspan="7"></td></tr><tr><td class="h">2367</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2367">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $quote = $parentcomment ? $parentcomment : $item-&gt;{&#39;event&#39;};</td></tr>
<tr><td class="h">2368</td><td colspan="7"></td></tr><tr><td class="h">2369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if this is a response to a comment inside our journal,</td></tr>
<tr><td class="h">2370</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we don&#39;t know who made the parent comment</td></tr>
<tr><td class="h">2371</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# (and it&#39;s potentially anonymous).</td></tr>
<tr><td class="h">2372</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2372">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($parentcomment) {</td></tr>
<tr><td class="h">2373</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{u} = undef;</td></tr>
<tr><td class="h">2374</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{body} = $parentcomment;</td></tr>
<tr><td class="h">2375</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{ispost} = 0;</td></tr>
<tr><td class="h">2376</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2377</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{u} = $entryu;</td></tr>
<tr><td class="h">2378</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{body} = $item-&gt;{&#39;event&#39;},</td></tr>
<tr><td class="h">2379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{ispost} = 1;</td></tr>
<tr><td class="h">2380</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{preformat} = $item-&gt;{&#39;props&#39;}-&gt;{&#39;opt_preformatted&#39;};</td></tr>
<tr><td class="h">2381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2382</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{entryu} = $entryu;</td></tr>
<tr><td class="h">2383</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{journalu} = $journalu;</td></tr>
<tr><td class="h">2384</td><td colspan="7"></td></tr><tr><td class="h">2385</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $text = $comment_obj-&gt;format_text_mail($entryu);</td></tr>
<tr><td class="h">2386</td><td colspan="7"></td></tr><tr><td class="h">2387</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2387">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2387">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $encoding ne &quot;UTF-8&quot;) {</td></tr>
<tr><td class="h">2388</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = Unicode::MapUTF8::from_utf8({-string=&gt;$text, -charset=&gt;$encoding});</td></tr>
<tr><td class="h">2389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2390</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part = $msg-&gt;attach(&#39;Type&#39; =&gt; &#39;TEXT&#39;,</td></tr>
<tr><td class="h">2391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Data&#39; =&gt; $text,</td></tr>
<tr><td class="h">2392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Encoding&#39; =&gt; &#39;quoted-printable&#39;,</td></tr>
<tr><td class="h">2393</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2394</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2394">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part-&gt;attr(&quot;content-type.charset&quot; =&gt; $encoding)</td></tr>
<tr><td class="h">2395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $LJ::UNICODE;</td></tr>
<tr><td class="h">2396</td><td colspan="7"></td></tr><tr><td class="h">2397</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2397">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($entryu-&gt;{&#39;opt_htmlemail&#39;} eq &quot;Y&quot;) {</td></tr>
<tr><td class="h">2398</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $html = $comment_obj-&gt;format_html_mail($entryu);</td></tr>
<tr><td class="h">2399</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2399">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2399">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $encoding ne &quot;UTF-8&quot;) {</td></tr>
<tr><td class="h">2400</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$html = Unicode::MapUTF8::from_utf8({-string=&gt;$html, -charset=&gt;$encoding});</td></tr>
<tr><td class="h">2401</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2402</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part = $msg-&gt;attach(&#39;Type&#39; =&gt; &#39;text/html&#39;,</td></tr>
<tr><td class="h">2403</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Data&#39; =&gt; $html,</td></tr>
<tr><td class="h">2404</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Encoding&#39; =&gt; &#39;quoted-printable&#39;,</td></tr>
<tr><td class="h">2405</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2406</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2406">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part-&gt;attr(&quot;content-type.charset&quot; =&gt; $encoding)</td></tr>
<tr><td class="h">2407</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $LJ::UNICODE;</td></tr>
<tr><td class="h">2408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2409</td><td colspan="7"></td></tr><tr><td class="h">2410</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::send_mail($msg);</td></tr>
<tr><td class="h">2411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2412</td><td colspan="7"></td></tr><tr><td class="h">2413</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now send email to the person who posted the comment we&#39;re using?  only if userprop</td></tr>
<tr><td class="h">2414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# opt_getselfemail is turned on.  no need to check for active/suspended accounts, as</td></tr>
<tr><td class="h">2415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# they couldn&#39;t have posted if they were.  (and if they did somehow, we&#39;re just emailing</td></tr>
<tr><td class="h">2416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# them, so it shouldn&#39;t matter.)</td></tr>
<tr><td class="h">2417</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $comment-&gt;{u};</td></tr>
<tr><td class="h">2418</td><td><div class="c3">214</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L2418">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($u, &#39;opt_getselfemail&#39;) if $u;</td></tr>
<tr><td class="h">2419</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2419">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2419">40</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u &amp;&amp; $u-&gt;{&#39;opt_getselfemail&#39;} &amp;&amp; LJ::get_cap($u, &#39;getselfemail&#39;)</td></tr>
<tr><td class="h">2420</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; !$u-&gt;gets_notified(journal =&gt; $journalu, arg1 =&gt; $ditemid, arg2 =&gt; $comment-&gt;{talkid})) {</td></tr>
<tr><td class="h">2421</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $part;</td></tr>
<tr><td class="h">2422</td><td colspan="7"></td></tr><tr><td class="h">2423</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Now we going to send email to &#39;$u&#39;.</td></tr>
<tr><td class="h">2424</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lang = $u-&gt;prop(&#39;browselang&#39;);</td></tr>
<tr><td class="h">2425</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2425">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$encoding = $u-&gt;mailencoding || &quot;UTF-8&quot;;</td></tr>
<tr><td class="h">2426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($headersubject, $fromname) = _format_headers( $lang, $encoding, $comment, $u, $edited, $parent, $paru, $item );</td></tr>
<tr><td class="h">2427</td><td colspan="7"></td></tr><tr><td class="h">2428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg = new MIME::Lite (&#39;From&#39; =&gt; &quot;\&quot;$fromname\&quot; &lt;$LJ::BOGUS_EMAIL&gt;&quot;,</td></tr>
<tr><td class="h">2429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;To&#39; =&gt; $u-&gt;email_raw,</td></tr>
<tr><td class="h">2430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Subject&#39; =&gt; $headersubject,</td></tr>
<tr><td class="h">2431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Type&#39; =&gt; &#39;multipart/alternative&#39;,</td></tr>
<tr><td class="h">2432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Message-Id&#39; =&gt; $this_msgid,</td></tr>
<tr><td class="h">2433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;In-Reply-To:&#39; =&gt; $par_msgid,</td></tr>
<tr><td class="h">2434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;References&#39; =&gt; &quot;$top_msgid $par_msgid&quot;,</td></tr>
<tr><td class="h">2435</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2436</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$msg-&gt;add(&#39;X-LJ-JOURNAL&#39; =&gt; $journalu-&gt;{&#39;user&#39;}); # for mail filters</td></tr>
<tr><td class="h">2437</td><td colspan="7"></td></tr><tr><td class="h">2438</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2438">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $quote = $parentcomment ? $parentcomment : $item-&gt;{&#39;event&#39;};</td></tr>
<tr><td class="h">2439</td><td colspan="7"></td></tr><tr><td class="h">2440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if this is a response to a comment inside our journal,</td></tr>
<tr><td class="h">2441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we don&#39;t know who made the parent comment</td></tr>
<tr><td class="h">2442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# (and it&#39;s potentially anonymous).</td></tr>
<tr><td class="h">2443</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2443">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($parentcomment) {</td></tr>
<tr><td class="h">2444</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{u} = undef;</td></tr>
<tr><td class="h">2445</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{body} = $parentcomment;</td></tr>
<tr><td class="h">2446</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{ispost} = 0;</td></tr>
<tr><td class="h">2447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2448</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{u} = $entryu;</td></tr>
<tr><td class="h">2449</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{body} = $item-&gt;{&#39;event&#39;},</td></tr>
<tr><td class="h">2450</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{ispost} = 1;</td></tr>
<tr><td class="h">2451</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{preformat} = $item-&gt;{&#39;props&#39;}-&gt;{&#39;opt_preformatted&#39;};</td></tr>
<tr><td class="h">2452</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2453</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{entryu} = $entryu;</td></tr>
<tr><td class="h">2454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{journalu} = $journalu;</td></tr>
<tr><td class="h">2455</td><td colspan="7"></td></tr><tr><td class="h">2456</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $text = $comment_obj-&gt;format_text_mail($u);</td></tr>
<tr><td class="h">2457</td><td colspan="7"></td></tr><tr><td class="h">2458</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2458">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2458">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $encoding ne &quot;UTF-8&quot;) {</td></tr>
<tr><td class="h">2459</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$text = Unicode::MapUTF8::from_utf8({-string=&gt;$text, -charset=&gt;$encoding});</td></tr>
<tr><td class="h">2460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2461</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part = $msg-&gt;attach(&#39;Type&#39; =&gt; &#39;TEXT&#39;,</td></tr>
<tr><td class="h">2462</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Data&#39; =&gt; $text,</td></tr>
<tr><td class="h">2463</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Encoding&#39; =&gt; &#39;quoted-printable&#39;,</td></tr>
<tr><td class="h">2464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2465</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2465">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part-&gt;attr(&quot;content-type.charset&quot; =&gt; $encoding)</td></tr>
<tr><td class="h">2466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $LJ::UNICODE;</td></tr>
<tr><td class="h">2467</td><td colspan="7"></td></tr><tr><td class="h">2468</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2468">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;opt_htmlemail&#39;} eq &quot;Y&quot;) {</td></tr>
<tr><td class="h">2469</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $html = $comment_obj-&gt;format_html_mail($u);</td></tr>
<tr><td class="h">2470</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2470">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2470">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $encoding ne &quot;UTF-8&quot;) {</td></tr>
<tr><td class="h">2471</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$html = Unicode::MapUTF8::from_utf8({-string=&gt;$html, -charset=&gt;$encoding});</td></tr>
<tr><td class="h">2472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2473</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part = $msg-&gt;attach(&#39;Type&#39; =&gt; &#39;text/html&#39;,</td></tr>
<tr><td class="h">2474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Data&#39; =&gt; $html,</td></tr>
<tr><td class="h">2475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Encoding&#39; =&gt; &#39;quoted-printable&#39;,</td></tr>
<tr><td class="h">2476</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2477</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2477">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$part-&gt;attr(&quot;content-type.charset&quot; =&gt; $encoding)</td></tr>
<tr><td class="h">2478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $LJ::UNICODE;</td></tr>
<tr><td class="h">2479</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2480</td><td colspan="7"></td></tr><tr><td class="h">2481</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::send_mail($msg);</td></tr>
<tr><td class="h">2482</td><td colspan="7"></td></tr><tr><td class="h">2483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2485</td><td colspan="7"></td></tr><tr><td class="h">2486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub enter_comment {</td></tr>
<tr><td class="h">2487</td><td><div class="c3">214</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L2487">214</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalu, $parent, $item, $comment, $errref) = @_;</td></tr>
<tr><td class="h">2488</td><td colspan="7"></td></tr><tr><td class="h">2489</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $partid = $parent-&gt;{talkid};</td></tr>
<tr><td class="h">2490</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemid = $item-&gt;{itemid};</td></tr>
<tr><td class="h">2491</td><td colspan="7"></td></tr><tr><td class="h">2492</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = sub {</td></tr>
<tr><td class="h">2493</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2493">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = join(&quot;: &quot;, @_);</td></tr>
<tr><td class="h">2494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">2495</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>20002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2496</td><td colspan="7"></td></tr><tr><td class="h">2497</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2497">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;Invalid user object passed.&quot;)</td></tr>
<tr><td class="h">2498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::isu($journalu);</td></tr>
<tr><td class="h">2499</td><td colspan="7"></td></tr><tr><td class="h">2500</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jtalkid = LJ::alloc_user_counter($journalu, &quot;T&quot;);</td></tr>
<tr><td class="h">2501</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2501">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;Database Error&quot;, &quot;Could not generate a talkid necessary to post this comment.&quot;)</td></tr>
<tr><td class="h">2502</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $jtalkid;</td></tr>
<tr><td class="h">2503</td><td colspan="7"></td></tr><tr><td class="h">2504</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# insert the comment</td></tr>
<tr><td class="h">2505</td><td><div class="c3">214</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L2505">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posterid = $comment-&gt;{u} ? $comment-&gt;{u}{userid} : 0;</td></tr>
<tr><td class="h">2506</td><td colspan="7"></td></tr><tr><td class="h">2507</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $errstr;</td></tr>
<tr><td class="h">2508</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;talk2_do(&quot;L&quot;, $itemid, \$errstr,</td></tr>
<tr><td class="h">2509</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;INSERT INTO talk2 &quot;.</td></tr>
<tr><td class="h">2510</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;(journalid, jtalkid, nodetype, nodeid, parenttalkid, posterid, datepost, state) &quot;.</td></tr>
<tr><td class="h">2511</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES (?,?,&#39;L&#39;,?,?,?,NOW(),?)&quot;,</td></tr>
<tr><td class="h">2512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;{userid}, $jtalkid, $itemid, $partid, $posterid, $comment-&gt;{state});</td></tr>
<tr><td class="h">2513</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2513">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($errstr) {</td></tr>
<tr><td class="h">2514</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;Database Error&quot;,</td></tr>
<tr><td class="h">2515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;There was an error posting your comment to the database.  &quot; .</td></tr>
<tr><td class="h">2516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Please report this.  The error is: &lt;b&gt;$errstr&lt;/b&gt;&quot;);</td></tr>
<tr><td class="h">2517</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2518</td><td colspan="7"></td></tr><tr><td class="h">2519</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::incr([$journalu-&gt;{&#39;userid&#39;}, &quot;talk2ct:$journalu-&gt;{&#39;userid&#39;}&quot;]);</td></tr>
<tr><td class="h">2520</td><td colspan="7"></td></tr><tr><td class="h">2521</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;{talkid} = $jtalkid;</td></tr>
<tr><td class="h">2522</td><td colspan="7"></td></tr><tr><td class="h">2523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# record IP if anonymous</td></tr>
<tr><td class="h">2524</td><td><div class="c3">214</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L2524">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::record_anon_comment_ip($journalu, $comment-&gt;{talkid}, LJ::get_remote_ip())</td></tr>
<tr><td class="h">2525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $posterid;</td></tr>
<tr><td class="h">2526</td><td colspan="7"></td></tr><tr><td class="h">2527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# add to poster&#39;s talkleft table, or the xfer place</td></tr>
<tr><td class="h">2528</td><td><div class="c3">214</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L2528">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($posterid) {</td></tr>
<tr><td class="h">2529</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $table;</td></tr>
<tr><td class="h">2530</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = LJ::get_cluster_master($comment-&gt;{u});</td></tr>
<tr><td class="h">2531</td><td colspan="7"></td></tr><tr><td class="h">2532</td><td><div class="c3">4</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L2532">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($db) {</td></tr>
<tr><td class="h">2533</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# remote&#39;s cluster is writable</td></tr>
<tr><td class="h">2534</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$table = &quot;talkleft&quot;;</td></tr>
<tr><td class="h">2535</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# log to global cluster, another job will move it later.</td></tr>
<tr><td class="h">2537</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db = LJ::get_db_writer();</td></tr>
<tr><td class="h">2538</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$table = &quot;talkleft_xfp&quot;;</td></tr>
<tr><td class="h">2539</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2540</td><td><div class="c3">4</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2540">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pub  = $item-&gt;{&#39;security&#39;} eq &quot;public&quot; ? 1 : 0;</td></tr>
<tr><td class="h">2541</td><td><div class="c3">4</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L2541">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($db) {</td></tr>
<tr><td class="h">2542</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>12000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;do(&quot;INSERT INTO $table (userid, posttime, journalid, nodetype, &quot;.</td></tr>
<tr><td class="h">2543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;nodeid, jtalkid, publicitem) VALUES (?, UNIX_TIMESTAMP(), &quot;.</td></tr>
<tr><td class="h">2544</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;?, &#39;L&#39;, ?, ?, ?)&quot;, undef,</td></tr>
<tr><td class="h">2545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$posterid, $journalu-&gt;{userid}, $itemid, $jtalkid, $pub);</td></tr>
<tr><td class="h">2546</td><td colspan="7"></td></tr><tr><td class="h">2547</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::incr([$posterid, &quot;talkleftct:$posterid&quot;]);</td></tr>
<tr><td class="h">2548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2549</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# both primary and backup talkleft hosts down.  can&#39;t do much now.</td></tr>
<tr><td class="h">2550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2552</td><td colspan="7"></td></tr><tr><td class="h">2553</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;do(&quot;INSERT INTO talktext2 (journalid, jtalkid, subject, body) &quot;.</td></tr>
<tr><td class="h">2554</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES (?, ?, ?, ?)&quot;, undef,</td></tr>
<tr><td class="h">2555</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;{userid}, $jtalkid, $comment-&gt;{subject},</td></tr>
<tr><td class="h">2556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_compress($comment-&gt;{body}));</td></tr>
<tr><td class="h">2557</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2557">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die $journalu-&gt;errstr if $journalu-&gt;err;</td></tr>
<tr><td class="h">2558</td><td colspan="7"></td></tr><tr><td class="h">2559</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = &quot;$journalu-&gt;{&#39;clusterid&#39;}:$journalu-&gt;{&#39;userid&#39;}:$jtalkid&quot;;</td></tr>
<tr><td class="h">2560</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$journalu-&gt;{&#39;userid&#39;},&quot;talksubject:$memkey&quot;], $comment-&gt;{subject});</td></tr>
<tr><td class="h">2561</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$journalu-&gt;{&#39;userid&#39;},&quot;talkbody:$memkey&quot;], $comment-&gt;{body});</td></tr>
<tr><td class="h">2562</td><td colspan="7"></td></tr><tr><td class="h">2563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# dudata</td></tr>
<tr><td class="h">2564</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bytes = length($comment-&gt;{subject}) + length($comment-&gt;{body});</td></tr>
<tr><td class="h">2565</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we used to do a LJ::dudata_set(..) on &#39;T&#39; here, but decided</td></tr>
<tr><td class="h">2566</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we could defer that.  to find size of a journal, summing</td></tr>
<tr><td class="h">2567</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# bytes in dudata is too slow (too many seeks)</td></tr>
<tr><td class="h">2568</td><td colspan="7"></td></tr><tr><td class="h">2569</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %talkprop;   # propname -&gt; value</td></tr>
<tr><td class="h">2570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# meta-data</td></tr>
<tr><td class="h">2571</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2571">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{&#39;unknown8bit&#39;} = 1 if $comment-&gt;{unknown8bit};</td></tr>
<tr><td class="h">2572</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{&#39;subjecticon&#39;} = $comment-&gt;{subjecticon};</td></tr>
<tr><td class="h">2573</td><td colspan="7"></td></tr><tr><td class="h">2574</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{&#39;picture_keyword&#39;} = $comment-&gt;{picture_keyword};</td></tr>
<tr><td class="h">2575</td><td colspan="7"></td></tr><tr><td class="h">2576</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2576">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{&#39;opt_preformatted&#39;} = $comment-&gt;{preformat} ? 1 : 0;</td></tr>
<tr><td class="h">2577</td><td><div class="c3">214</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L2577">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2577">25</a></div></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journalu-&gt;opt_logcommentips eq &quot;A&quot; ||</td></tr>
<tr><td class="h">2578</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($journalu-&gt;opt_logcommentips eq &quot;S&quot; &amp;&amp; $comment-&gt;{usertype} ne &quot;user&quot;))</td></tr>
<tr><td class="h">2579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2580</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2580">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::is_web_context()) {</td></tr>
<tr><td class="h">2581</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ip = BML::get_remote_ip();</td></tr>
<tr><td class="h">2582</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $forwarded = BML::get_client_header(&#39;X-Forwarded-For&#39;);</td></tr>
<tr><td class="h">2583</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2583">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2583">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ip = &quot;$forwarded, via $ip&quot; if $forwarded &amp;&amp; $forwarded ne $ip;</td></tr>
<tr><td class="h">2584</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{&#39;poster_ip&#39;} = $ip;</td></tr>
<tr><td class="h">2585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2587</td><td colspan="7"></td></tr><tr><td class="h">2588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove blank/0 values (defaults)</td></tr>
<tr><td class="h">2589</td><td><div class="c3">214</div><div class="c3">642</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L2589">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %talkprop) { delete $talkprop{$_} unless $talkprop{$_}; }</td></tr>
<tr><td class="h">2590</td><td colspan="7"></td></tr><tr><td class="h">2591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the talkprops</td></tr>
<tr><td class="h">2592</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_props(&quot;talk&quot;);</td></tr>
<tr><td class="h">2593</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2593">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%talkprop) {</td></tr>
<tr><td class="h">2594</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $values;</td></tr>
<tr><td class="h">2595</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $hash = {};</td></tr>
<tr><td class="h">2596</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %talkprop) {</td></tr>
<tr><td class="h">2597</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;talk&quot;, $_);</td></tr>
<tr><td class="h">2598</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2598">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $p;</td></tr>
<tr><td class="h">2599</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hash-&gt;{$_} = $talkprop{$_};</td></tr>
<tr><td class="h">2600</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tpropid = $p-&gt;{&#39;tpropid&#39;};</td></tr>
<tr><td class="h">2601</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $qv = $journalu-&gt;quote($talkprop{$_});</td></tr>
<tr><td class="h">2602</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$values .= &quot;($journalu-&gt;{&#39;userid&#39;}, $jtalkid, $tpropid, $qv),&quot;;</td></tr>
<tr><td class="h">2603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2604</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2604">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($values) {</td></tr>
<tr><td class="h">2605</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chop $values;</td></tr>
<tr><td class="h">2606</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;do(&quot;INSERT INTO talkprop2 (journalid, jtalkid, tpropid, value) &quot;.</td></tr>
<tr><td class="h">2607</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES $values&quot;);</td></tr>
<tr><td class="h">2608</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2608">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die $journalu-&gt;errstr if $journalu-&gt;err;</td></tr>
<tr><td class="h">2609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2610</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$journalu-&gt;{&#39;userid&#39;}, &quot;talkprop:$journalu-&gt;{&#39;userid&#39;}:$jtalkid&quot;], $hash);</td></tr>
<tr><td class="h">2611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2612</td><td colspan="7"></td></tr><tr><td class="h">2613</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# record up to 25 (or $LJ::TALK_MAX_URLS) urls from a comment</td></tr>
<tr><td class="h">2614</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my (%urls, $dbh);</td></tr>
<tr><td class="h">2615</td><td><div class="c3">214</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2615">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2615">25</a></div></td><td></td><td></td><td><div>4000</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::TALK_MAX_URLS &amp;&amp;</td></tr>
<tr><td class="h">2616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( %urls = map { $_ =&gt; 1 } LJ::get_urls($comment-&gt;{body}) ) &amp;&amp;</td></tr>
<tr><td class="h">2617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $dbh = LJ::get_db_writer() )) # don&#39;t log if no db available</td></tr>
<tr><td class="h">2618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2619</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my (@bind, @vals);</td></tr>
<tr><td class="h">2620</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ip = LJ::get_remote_ip();</td></tr>
<tr><td class="h">2621</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($url, undef) = each %urls) {</td></tr>
<tr><td class="h">2622</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @bind, &#39;(?,?,?,?,UNIX_TIMESTAMP(),?)&#39;;</td></tr>
<tr><td class="h">2623</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @vals, $posterid, $journalu-&gt;{userid}, $ip, $jtalkid, $url;</td></tr>
<tr><td class="h">2624</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2624">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if @bind &gt;= $LJ::TALK_MAX_URLS;</td></tr>
<tr><td class="h">2625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2626</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $bind = join(&#39;,&#39;, @bind);</td></tr>
<tr><td class="h">2627</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sql = qq{</td></tr>
<tr><td class="h">2628</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT INTO commenturls</td></tr>
<tr><td class="h">2629</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(posterid, journalid, ip, jtalkid, timecreate, url)</td></tr>
<tr><td class="h">2630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VALUES $bind</td></tr>
<tr><td class="h">2631</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2632</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do($sql, undef, @vals);</td></tr>
<tr><td class="h">2633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2634</td><td colspan="7"></td></tr><tr><td class="h">2635</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the &quot;replycount&quot; summary field of the log table</td></tr>
<tr><td class="h">2636</td><td><div class="c3">214</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L2636">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($comment-&gt;{state} eq &#39;A&#39;) {</td></tr>
<tr><td class="h">2637</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::replycount_do($journalu, $itemid, &quot;incr&quot;);</td></tr>
<tr><td class="h">2638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2639</td><td colspan="7"></td></tr><tr><td class="h">2640</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the &quot;hasscreened&quot; property of the log item if needed</td></tr>
<tr><td class="h">2641</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L2641">50</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($comment-&gt;{state} eq &#39;S&#39;) {</td></tr>
<tr><td class="h">2642</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_logprop($journalu, $itemid, { &#39;hasscreened&#39; =&gt; 1 });</td></tr>
<tr><td class="h">2643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2644</td><td colspan="7"></td></tr><tr><td class="h">2645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the comment alter property</td></tr>
<tr><td class="h">2646</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::update_commentalter($journalu, $itemid);</td></tr>
<tr><td class="h">2647</td><td colspan="7"></td></tr><tr><td class="h">2648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# fire events</td></tr>
<tr><td class="h">2649</td><td><div class="c3">214</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L2649">50</a></div></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( LJ::is_enabled(&#39;esn&#39;) ) {</td></tr>
<tr><td class="h">2650</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cmtobj = LJ::Comment-&gt;new($journalu, jtalkid =&gt; $jtalkid);</td></tr>
<tr><td class="h">2651</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @jobs;</td></tr>
<tr><td class="h">2652</td><td colspan="7"></td></tr><tr><td class="h">2653</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::Event::JournalNewComment-&gt;new($cmtobj)-&gt;fire_job;</td></tr>
<tr><td class="h">2654</td><td><div class="c3">214</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L2654">100</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2654">67</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::Event::UserNewComment-&gt;new($cmtobj)-&gt;fire_job</td></tr>
<tr><td class="h">2655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $cmtobj-&gt;poster &amp;&amp; LJ::is_enabled(&#39;esn-userevents&#39;);</td></tr>
<tr><td class="h">2656</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::EventLogRecord::NewComment-&gt;new($cmtobj)-&gt;fire_job;</td></tr>
<tr><td class="h">2657</td><td colspan="7"></td></tr><tr><td class="h">2658</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sclient = LJ::theschwartz();</td></tr>
<tr><td class="h">2659</td><td><div class="c3">214</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L2659">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2659">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($sclient &amp;&amp; @jobs) {</td></tr>
<tr><td class="h">2660</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @handles = $sclient-&gt;insert_jobs(@jobs);</td></tr>
<tr><td class="h">2661</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2662</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2663</td><td colspan="7"></td></tr><tr><td class="h">2664</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $jtalkid;</td></tr>
<tr><td class="h">2665</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2666</td><td colspan="7"></td></tr><tr><td class="h">2667</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># this is used by the journal import code, but is kept here so as to be kept</td></tr>
<tr><td class="h">2668</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># local to the rest of the comment code</td></tr>
<tr><td class="h">2669</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub enter_imported_comment {</td></tr>
<tr><td class="h">2670</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2670">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $journalu, $parent, $item, $comment, $date, $errref ) = @_;</td></tr>
<tr><td class="h">2671</td><td colspan="7"></td></tr><tr><td class="h">2672</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $partid = $parent-&gt;{talkid};</td></tr>
<tr><td class="h">2673</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemid = $item-&gt;{itemid};</td></tr>
<tr><td class="h">2674</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2674">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posterid = $comment-&gt;{u} ? $comment-&gt;{u}-&gt;{userid} : 0;</td></tr>
<tr><td class="h">2675</td><td colspan="7"></td></tr><tr><td class="h">2676</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = sub {</td></tr>
<tr><td class="h">2677</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2677">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = join(&quot;: &quot;, @_);</td></tr>
<tr><td class="h">2678</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">2679</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2680</td><td colspan="7"></td></tr><tr><td class="h">2681</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2681">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;( &quot;Invalid user object passed.&quot; )</td></tr>
<tr><td class="h">2682</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::isu( $journalu );</td></tr>
<tr><td class="h">2683</td><td colspan="7"></td></tr><tr><td class="h">2684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# prealloc counter before insert</td></tr>
<tr><td class="h">2685</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jtalkid = LJ::alloc_user_counter( $journalu, &quot;T&quot; );</td></tr>
<tr><td class="h">2686</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2686">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;( &quot;Database Error&quot;, &quot;Could not generate a talkid necessary to post this comment.&quot; )</td></tr>
<tr><td class="h">2687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $jtalkid;</td></tr>
<tr><td class="h">2688</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;{talkid} = $jtalkid;</td></tr>
<tr><td class="h">2689</td><td colspan="7"></td></tr><tr><td class="h">2690</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# insert the comment</td></tr>
<tr><td class="h">2691</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $errstr;</td></tr>
<tr><td class="h">2692</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;talk2_do(</td></tr>
<tr><td class="h">2693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;L&quot;, $itemid, \$errstr,</td></tr>
<tr><td class="h">2694</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q{</td></tr>
<tr><td class="h">2695</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT INTO talk2 (journalid, jtalkid, nodetype, nodeid, parenttalkid, posterid, datepost, state)</td></tr>
<tr><td class="h">2696</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VALUES (?,?,&#39;L&#39;,?,?,?,?,?)</td></tr>
<tr><td class="h">2697</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</td></tr>
<tr><td class="h">2698</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;{userid}, $jtalkid, $itemid, $partid, $posterid, $date, $comment-&gt;{state}</td></tr>
<tr><td class="h">2699</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2700</td><td colspan="7"></td></tr><tr><td class="h">2701</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2701">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;( &quot;Database Error&quot;,</td></tr>
<tr><td class="h">2702</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;There was an error posting your comment to the database.  &quot; .</td></tr>
<tr><td class="h">2703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Please report this.  The error is: &lt;b&gt;$errstr&lt;/b&gt;&quot;</td></tr>
<tr><td class="h">2704</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;) if $errstr;</td></tr>
<tr><td class="h">2705</td><td colspan="7"></td></tr><tr><td class="h">2706</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete( [$journalu-&gt;{userid}, &quot;talk2ct:$journalu-&gt;{userid}&quot;] );</td></tr>
<tr><td class="h">2707</td><td colspan="7"></td></tr><tr><td class="h">2708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# add to poster&#39;s talkleft table, or the xfer place</td></tr>
<tr><td class="h">2709</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2709">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $posterid ) {</td></tr>
<tr><td class="h">2710</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $table;</td></tr>
<tr><td class="h">2711</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = LJ::get_cluster_master( $comment-&gt;{u} );</td></tr>
<tr><td class="h">2712</td><td colspan="7"></td></tr><tr><td class="h">2713</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2713">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($db) {</td></tr>
<tr><td class="h">2714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# remote&#39;s cluster is writable</td></tr>
<tr><td class="h">2715</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$table = &quot;talkleft&quot;;</td></tr>
<tr><td class="h">2716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2717</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# log to global cluster, another job will move it later.</td></tr>
<tr><td class="h">2718</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db = LJ::get_db_writer();</td></tr>
<tr><td class="h">2719</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$table = &quot;talkleft_xfp&quot;;</td></tr>
<tr><td class="h">2720</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2721</td><td colspan="7"></td></tr><tr><td class="h">2722</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2722">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pub  = $item-&gt;{&#39;security&#39;} eq &quot;public&quot; ? 1 : 0;</td></tr>
<tr><td class="h">2723</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2723">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($db) {</td></tr>
<tr><td class="h">2724</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;do(</td></tr>
<tr><td class="h">2725</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qq{</td></tr>
<tr><td class="h">2726</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT INTO $table (userid, posttime, journalid, nodetype, nodeid, jtalkid, publicitem)</td></tr>
<tr><td class="h">2727</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VALUES (?, UNIX_TIMESTAMP(?), ?, &#39;L&#39;, ?, ?, ?)</td></tr>
<tr><td class="h">2728</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, undef, $posterid, $date, $journalu-&gt;{userid}, $itemid, $jtalkid, $pub</td></tr>
<tr><td class="h">2729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2730</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete( [$posterid, &quot;talkleftct:$posterid&quot;] );</td></tr>
<tr><td class="h">2731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2732</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# both primary and backup talkleft hosts down.  can&#39;t do much now.</td></tr>
<tr><td class="h">2733</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;warn &quot;Unable to insert comment into talkleft, cluster+master down?&quot;;</td></tr>
<tr><td class="h">2734</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2735</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2736</td><td colspan="7"></td></tr><tr><td class="h">2737</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2737">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $comment-&gt;{state} ne &quot;D&quot; ) {</td></tr>
<tr><td class="h">2738</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;do(</td></tr>
<tr><td class="h">2739</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q{</td></tr>
<tr><td class="h">2740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT INTO talktext2 (journalid, jtalkid, subject, body)</td></tr>
<tr><td class="h">2741</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VALUES (?, ?, ?, ?)</td></tr>
<tr><td class="h">2742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, undef, $journalu-&gt;{userid}, $jtalkid, $comment-&gt;{subject},</td></tr>
<tr><td class="h">2743</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_compress( $comment-&gt;{body} )</td></tr>
<tr><td class="h">2744</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2745</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2745">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die $journalu-&gt;errstr if $journalu-&gt;err;</td></tr>
<tr><td class="h">2746</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2747</td><td colspan="7"></td></tr><tr><td class="h">2748</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %talkprop;   # propname -&gt; value</td></tr>
<tr><td class="h">2749</td><td colspan="7"></td></tr><tr><td class="h">2750</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2750">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $key ( keys %{ $comment-&gt;{props} || {} } ) {</td></tr>
<tr><td class="h">2751</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{$key} = $comment-&gt;{props}-&gt;{$key};</td></tr>
<tr><td class="h">2752</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2753</td><td colspan="7"></td></tr><tr><td class="h">2754</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2754">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{&#39;unknown8bit&#39;}      = 1 if $comment-&gt;{unknown8bit};</td></tr>
<tr><td class="h">2755</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{&#39;subjecticon&#39;}      = $comment-&gt;{subjecticon};</td></tr>
<tr><td class="h">2756</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{&#39;picture_keyword&#39;}  = $comment-&gt;{picture_keyword};</td></tr>
<tr><td class="h">2757</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2757">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$talkprop{&#39;opt_preformatted&#39;} = $comment-&gt;{preformat} ? 1 : 0;</td></tr>
<tr><td class="h">2758</td><td colspan="7"></td></tr><tr><td class="h">2759</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove blank/0 values (defaults)</td></tr>
<tr><td class="h">2760</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach ( keys %talkprop ) {</td></tr>
<tr><td class="h">2761</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2761">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $talkprop{$_} unless $talkprop{$_};</td></tr>
<tr><td class="h">2762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2763</td><td colspan="7"></td></tr><tr><td class="h">2764</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the talkprops</td></tr>
<tr><td class="h">2765</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_props(&quot;talk&quot;);</td></tr>
<tr><td class="h">2766</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2766">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%talkprop) {</td></tr>
<tr><td class="h">2767</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $values;</td></tr>
<tr><td class="h">2768</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $hash = {};</td></tr>
<tr><td class="h">2769</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %talkprop) {</td></tr>
<tr><td class="h">2770</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;talk&quot;, $_);</td></tr>
<tr><td class="h">2771</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2771">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $p;</td></tr>
<tr><td class="h">2772</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hash-&gt;{$_} = $talkprop{$_};</td></tr>
<tr><td class="h">2773</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tpropid = $p-&gt;{&#39;tpropid&#39;};</td></tr>
<tr><td class="h">2774</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $qv = $journalu-&gt;quote($talkprop{$_});</td></tr>
<tr><td class="h">2775</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$values .= &quot;($journalu-&gt;{&#39;userid&#39;}, $jtalkid, $tpropid, $qv),&quot;;</td></tr>
<tr><td class="h">2776</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2777</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2777">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($values) {</td></tr>
<tr><td class="h">2778</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chop $values;</td></tr>
<tr><td class="h">2779</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;do(&quot;INSERT INTO talkprop2 (journalid, jtalkid, tpropid, value) &quot;.</td></tr>
<tr><td class="h">2780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES $values&quot;);</td></tr>
<tr><td class="h">2781</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2781">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die $journalu-&gt;errstr if $journalu-&gt;err;</td></tr>
<tr><td class="h">2782</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2784</td><td colspan="7"></td></tr><tr><td class="h">2785</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the &quot;replycount&quot; summary field of the log table</td></tr>
<tr><td class="h">2786</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2786">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2786">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $comment-&gt;{state} eq &#39;A&#39; || $comment-&gt;{state} eq &#39;F&#39; ) {</td></tr>
<tr><td class="h">2787</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::replycount_do( $journalu, $itemid, &quot;incr&quot; );</td></tr>
<tr><td class="h">2788</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2789</td><td colspan="7"></td></tr><tr><td class="h">2790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the &quot;hasscreened&quot; property of the log item if needed</td></tr>
<tr><td class="h">2791</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2791">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $comment-&gt;{state} eq &#39;S&#39; ) {</td></tr>
<tr><td class="h">2792</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_logprop( $journalu, $itemid, { &#39;hasscreened&#39; =&gt; 1 } );</td></tr>
<tr><td class="h">2793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2794</td><td colspan="7"></td></tr><tr><td class="h">2795</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the comment alter property</td></tr>
<tr><td class="h">2796</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::update_commentalter( $journalu, $itemid );</td></tr>
<tr><td class="h">2797</td><td colspan="7"></td></tr><tr><td class="h">2798</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $jtalkid;</td></tr>
<tr><td class="h">2799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2800</td><td colspan="7"></td></tr><tr><td class="h">2801</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># XXX these strings should be in talk, but moving them means we have</td></tr>
<tr><td class="h">2802</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># to retranslate.  so for now we&#39;re just gonna put it off.</td></tr>
<tr><td class="h">2803</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">my $SC = &#39;/talkpost_do.bml&#39;;</td></tr>
<tr><td class="h">2804</td><td colspan="7"></td></tr><tr><td class="h">2805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub init {</td></tr>
<tr><td class="h">2806</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2806">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($form, $remote, $need_captcha, $errret) = @_;</td></tr>
<tr><td class="h">2807</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth;</td></tr>
<tr><td class="h">2808</td><td colspan="7"></td></tr><tr><td class="h">2809</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = sub {</td></tr>
<tr><td class="h">2810</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2810">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $error = shift;</td></tr>
<tr><td class="h">2811</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$errret, $error;</td></tr>
<tr><td class="h">2812</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">2813</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bmlerr = sub {</td></tr>
<tr><td class="h">2815</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L2815">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;($BML::ML{$_[0]});</td></tr>
<tr><td class="h">2816</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2817</td><td colspan="7"></td></tr><tr><td class="h">2818</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $init = LJ::Talk::init($form);</td></tr>
<tr><td class="h">2819</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2819">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;($init-&gt;{error}) if $init-&gt;{error};</td></tr>
<tr><td class="h">2820</td><td colspan="7"></td></tr><tr><td class="h">2821</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalu = $init-&gt;{&#39;journalu&#39;};</td></tr>
<tr><td class="h">2822</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2822">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $bmlerr-&gt;(&#39;talk.error.nojournal&#39;) unless $journalu;</td></tr>
<tr><td class="h">2823</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2823">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;($LJ::MSG_READONLY_USER) if LJ::get_cap($journalu, &quot;readonly&quot;);</td></tr>
<tr><td class="h">2824</td><td colspan="7"></td></tr><tr><td class="h">2825</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2825">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;Account is locked, unable to post or edit a comment.&quot;) if $journalu-&gt;is_locked;</td></tr>
<tr><td class="h">2826</td><td colspan="7"></td></tr><tr><td class="h">2827</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $r = BML::get_request();</td></tr>
<tr><td class="h">2828</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2828">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;notes-&gt;{journalid} = $journalu-&gt;{&#39;userid&#39;}</td></tr>
<tr><td class="h">2829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $r;</td></tr>
<tr><td class="h">2830</td><td colspan="7"></td></tr><tr><td class="h">2831</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($journalu);</td></tr>
<tr><td class="h">2832</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2832">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $bmlerr-&gt;(&#39;error.nodb&#39;) unless $dbcr;</td></tr>
<tr><td class="h">2833</td><td colspan="7"></td></tr><tr><td class="h">2834</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemid = $init-&gt;{&#39;itemid&#39;}+0;</td></tr>
<tr><td class="h">2835</td><td colspan="7"></td></tr><tr><td class="h">2836</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $item = LJ::Talk::get_journal_item($journalu, $itemid);</td></tr>
<tr><td class="h">2837</td><td colspan="7"></td></tr><tr><td class="h">2838</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2838">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2838">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($init-&gt;{&#39;oldurl&#39;} &amp;&amp; $item) {</td></tr>
<tr><td class="h">2839</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;anum&#39;} = $item-&gt;{&#39;anum&#39;};</td></tr>
<tr><td class="h">2840</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{&#39;ditemid&#39;} = $init-&gt;{&#39;itemid&#39;}*256 + $item-&gt;{&#39;anum&#39;};</td></tr>
<tr><td class="h">2841</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2842</td><td colspan="7"></td></tr><tr><td class="h">2843</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2843">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2843">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($item &amp;&amp; $item-&gt;{&#39;anum&#39;} == $init-&gt;{&#39;anum&#39;}) {</td></tr>
<tr><td class="h">2844</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $bmlerr-&gt;(&#39;talk.error.noentry&#39;);</td></tr>
<tr><td class="h">2845</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2846</td><td colspan="7"></td></tr><tr><td class="h">2847</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $iprops = $item-&gt;{&#39;props&#39;};</td></tr>
<tr><td class="h">2848</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $init-&gt;{&#39;ditemid&#39;}+0;</td></tr>
<tr><td class="h">2849</td><td colspan="7"></td></tr><tr><td class="h">2850</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $talkurl = LJ::journal_base($journalu) . &quot;/$ditemid.html&quot;;</td></tr>
<tr><td class="h">2851</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{talkurl} = $talkurl;</td></tr>
<tr><td class="h">2852</td><td colspan="7"></td></tr><tr><td class="h">2853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### load users</td></tr>
<tr><td class="h">2854</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userids_multiple([</td></tr>
<tr><td class="h">2855</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;posterid&#39;} =&gt; \$init-&gt;{entryu},</td></tr>
<tr><td class="h">2856</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;], [ $journalu ]);</td></tr>
<tr><td class="h">2857</td><td colspan="7"></td></tr><tr><td class="h">2858</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2858">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2858">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;userpost&#39;} &amp;&amp; $form-&gt;{&#39;usertype&#39;} ne &quot;user&quot;) {</td></tr>
<tr><td class="h">2859</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2859">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2859">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($form-&gt;{&#39;usertype&#39;} eq &quot;cookieuser&quot; &amp;&amp;</td></tr>
<tr><td class="h">2860</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;userpost&#39;} eq $form-&gt;{&#39;cookieuser&#39;}) {</td></tr>
<tr><td class="h">2861</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.confused_identity&quot;);</td></tr>
<tr><td class="h">2862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2864</td><td colspan="7"></td></tr><tr><td class="h">2865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# anonymous/cookie users cannot authenticate with ecphash</td></tr>
<tr><td class="h">2866</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2866">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2866">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;ecphash&#39;} &amp;&amp; $form-&gt;{&#39;usertype&#39;} ne &quot;user&quot;) {</td></tr>
<tr><td class="h">2867</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.badusername2&quot;, {&#39;sitename&#39; =&gt; $LJ::SITENAMESHORT, &#39;aopts&#39; =&gt; &quot;href=&#39;$LJ::SITEROOT/lostinfo&#39;&quot;}));</td></tr>
<tr><td class="h">2868</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">2869</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2870</td><td colspan="7"></td></tr><tr><td class="h">2871</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cookie_auth;</td></tr>
<tr><td class="h">2872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# either we are posting from the comment email notification form </td></tr>
<tr><td class="h">2873</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# or we are posting from talkpost, as currently logged-in user</td></tr>
<tr><td class="h">2874</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2874">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2874">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( ( $form-&gt;{usertype} eq &quot;user&quot; &amp;&amp; exists $form-&gt;{ecphash} ) || </td></tr>
<tr><td class="h">2875</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($form-&gt;{&#39;usertype&#39;} eq &quot;cookieuser&quot;)) {</td></tr>
<tr><td class="h">2876</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2876">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $userpost = $form-&gt;{&#39;userpost&#39;} || $form-&gt;{&#39;cookieuser&#39;};</td></tr>
<tr><td class="h">2877</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2877">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2877">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.lostcookie&quot;)</td></tr>
<tr><td class="h">2878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $remote &amp;&amp; $remote-&gt;{&#39;user&#39;} eq $userpost;</td></tr>
<tr><td class="h">2879</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2879">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef if @$errret;</td></tr>
<tr><td class="h">2880</td><td colspan="7"></td></tr><tr><td class="h">2881</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2881">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cookie_auth = 1 unless exists $form-&gt;{ecphash};</td></tr>
<tr><td class="h">2882</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;userpost&#39;} = $remote-&gt;{&#39;user&#39;};</td></tr>
<tr><td class="h">2883</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;usertype&#39;} = &quot;user&quot;;</td></tr>
<tr><td class="h">2884</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2885</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# XXXevan hack:  remove me when we fix preview.</td></tr>
<tr><td class="h">2886</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{cookie_auth} = $cookie_auth;</td></tr>
<tr><td class="h">2887</td><td colspan="7"></td></tr><tr><td class="h">2888</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# test accounts may only comment on other test accounts.</td></tr>
<tr><td class="h">2889</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2889">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2889">0</a></div></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ((grep { $form-&gt;{&#39;userpost&#39;} eq $_ } @LJ::TESTACCTS) &amp;&amp;</td></tr>
<tr><td class="h">2890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!(grep { $journalu-&gt;{&#39;user&#39;} eq $_ } @LJ::TESTACCTS) &amp;&amp; !$LJ::IS_DEV_SERVER)</td></tr>
<tr><td class="h">2891</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2892</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.testacct&quot;);</td></tr>
<tr><td class="h">2893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2894</td><td colspan="7"></td></tr><tr><td class="h">2895</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userpost = lc($form-&gt;{&#39;userpost&#39;});</td></tr>
<tr><td class="h">2896</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $up;             # user posting</td></tr>
<tr><td class="h">2897</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $exptype;        # set to long if ! after username</td></tr>
<tr><td class="h">2898</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ipfixed;        # set to remote  ip if &lt; after username</td></tr>
<tr><td class="h">2899</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $used_ecp;       # ecphash was validated and used</td></tr>
<tr><td class="h">2900</td><td colspan="7"></td></tr><tr><td class="h">2901</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2901">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;usertype&#39;} eq &quot;user&quot;) {</td></tr>
<tr><td class="h">2902</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2902">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2902">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;userpost&#39;}) {</td></tr>
<tr><td class="h">2903</td><td colspan="7"></td></tr><tr><td class="h">2904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# parse inline login opts</td></tr>
<tr><td class="h">2905</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2905">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;userpost&#39;} =~ s/[!&lt;]{1,2}$//) {</td></tr>
<tr><td class="h">2906</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2906">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$exptype = &#39;long&#39; if index($&amp;, &quot;!&quot;) &gt;= 0;</td></tr>
<tr><td class="h">2907</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2907">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ipfixed = LJ::get_remote_ip() if index($&amp;, &quot;&lt;&quot;) &gt;= 0;</td></tr>
<tr><td class="h">2908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2909</td><td colspan="7"></td></tr><tr><td class="h">2910</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$up = LJ::load_user($form-&gt;{&#39;userpost&#39;});</td></tr>
<tr><td class="h">2911</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2911">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($up) {</td></tr>
<tr><td class="h">2912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;### see if the user is banned from posting here</td></tr>
<tr><td class="h">2913</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2913">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::is_banned($up, $journalu)) {</td></tr>
<tr><td class="h">2914</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.banned&quot;);</td></tr>
<tr><td class="h">2915</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2916</td><td colspan="7"></td></tr><tr><td class="h">2917</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# TEMP until we have better openid support</td></tr>
<tr><td class="h">2918</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2918">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2918">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($up-&gt;is_identity &amp;&amp; $journalu-&gt;{&#39;opt_whocanreply&#39;} eq &quot;reg&quot;) {</td></tr>
<tr><td class="h">2919</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.noopenid&quot;);</td></tr>
<tr><td class="h">2920</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2921</td><td colspan="7"></td></tr><tr><td class="h">2922</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2922">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2922">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ( $up-&gt;is_person || ( $up-&gt;is_identity &amp;&amp; $cookie_auth ) ) {</td></tr>
<tr><td class="h">2923</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.postshared&quot;);</td></tr>
<tr><td class="h">2924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2925</td><td colspan="7"></td></tr><tr><td class="h">2926</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if we&#39;re already authenticated via cookie, then userpost was set</td></tr>
<tr><td class="h">2927</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# to the authenticated username, so we got into this block, but we</td></tr>
<tr><td class="h">2928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t want to re-authenticate, so just skip this</td></tr>
<tr><td class="h">2929</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2929">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($cookie_auth) {</td></tr>
<tr><td class="h">2930</td><td colspan="7"></td></tr><tr><td class="h">2931</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if ecphash present, authenticate on that</td></tr>
<tr><td class="h">2932</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2932">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;ecphash&#39;}) {</td></tr>
<tr><td class="h">2933</td><td colspan="7"></td></tr><tr><td class="h">2934</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2934">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;ecphash&#39;} eq</td></tr>
<tr><td class="h">2935</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::ecphash($itemid, $form-&gt;{&#39;parenttalkid&#39;}, $up-&gt;password))</td></tr>
<tr><td class="h">2936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2937</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$used_ecp = 1;</td></tr>
<tr><td class="h">2938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2939</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.badpassword2&quot;, {&#39;aopts&#39; =&gt; &quot;href=&#39;$LJ::SITEROOT/lostinfo&#39;&quot;}));</td></tr>
<tr><td class="h">2940</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2941</td><td colspan="7"></td></tr><tr><td class="h">2942</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# otherwise authenticate on username/password</td></tr>
<tr><td class="h">2943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2944</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ok;</td></tr>
<tr><td class="h">2945</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2945">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{response}) {</td></tr>
<tr><td class="h">2946</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ok = LJ::challenge_check_login($up, $form-&gt;{chal}, $form-&gt;{response});</td></tr>
<tr><td class="h">2947</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2948</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ok = LJ::auth_okay($up, $form-&gt;{&#39;password&#39;}, $form-&gt;{&#39;hpassword&#39;});</td></tr>
<tr><td class="h">2949</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2950</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2950">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.badpassword2&quot;, {&#39;aopts&#39; =&gt; &quot;href=&#39;$LJ::SITEROOT/lostinfo&#39;&quot;})) unless $ok;</td></tr>
<tr><td class="h">2951</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2953</td><td colspan="7"></td></tr><tr><td class="h">2954</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if the user chooses to log in, do so</td></tr>
<tr><td class="h">2955</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2955">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2955">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;do_login&#39;} &amp;&amp; ! @$errret) {</td></tr>
<tr><td class="h">2956</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{didlogin} = $up-&gt;make_login_session($exptype, $ipfixed);</td></tr>
<tr><td class="h">2957</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2958</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2959</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.badusername2&quot;, {&#39;sitename&#39; =&gt; $LJ::SITENAMESHORT, &#39;aopts&#39; =&gt; &quot;href=&#39;$LJ::SITEROOT/lostinfo&#39;&quot;}));</td></tr>
<tr><td class="h">2960</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2961</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($journalu-&gt;{&#39;opt_whocanreply&#39;} eq &quot;all&quot;) {</td></tr>
<tr><td class="h">2962</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.nousername&quot;, {&#39;sitename&#39; =&gt; $LJ::SITENAMESHORT}));</td></tr>
<tr><td class="h">2963</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2964</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.nousername.noanon&quot;, {&#39;sitename&#39; =&gt; $LJ::SITENAMESHORT}));</td></tr>
<tr><td class="h">2965</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2966</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2967</td><td colspan="7"></td></tr><tr><td class="h">2968</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# OpenID</td></tr>
<tr><td class="h">2969</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2969">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2969">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::OpenID-&gt;consumer_enabled &amp;&amp; ($form-&gt;{&#39;usertype&#39;} eq &#39;openid&#39; ||  $form-&gt;{&#39;usertype&#39;} eq &#39;openid_cookie&#39;)) {</td></tr>
<tr><td class="h">2970</td><td colspan="7"></td></tr><tr><td class="h">2971</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2971">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L2971">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($remote &amp;&amp; defined $remote-&gt;openid_identity) {</td></tr>
<tr><td class="h">2972</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$up = $remote;</td></tr>
<tr><td class="h">2973</td><td colspan="7"></td></tr><tr><td class="h">2974</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;### see if the user is banned from posting here</td></tr>
<tr><td class="h">2975</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2975">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.banned&quot;) if (LJ::is_banned($up, $journalu));</td></tr>
<tr><td class="h">2976</td><td colspan="7"></td></tr><tr><td class="h">2977</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2977">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;oiddo_login&#39;}) {</td></tr>
<tr><td class="h">2978</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$up-&gt;make_login_session($form-&gt;{&#39;exptype&#39;}, $form-&gt;{&#39;ipfixed&#39;});</td></tr>
<tr><td class="h">2979</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2980</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else { # First time through</td></tr>
<tr><td class="h">2981</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $csr = LJ::OpenID::consumer();</td></tr>
<tr><td class="h">2982</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $exptype = &#39;short&#39;;</td></tr>
<tr><td class="h">2983</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ipfixed = 0;</td></tr>
<tr><td class="h">2984</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $etime = 0;</td></tr>
<tr><td class="h">2985</td><td colspan="7"></td></tr><tr><td class="h">2986</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# parse inline login opts</td></tr>
<tr><td class="h">2987</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2987">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;No OpenID identity URL entered&quot;) unless $form-&gt;{&#39;oidurl&#39;};</td></tr>
<tr><td class="h">2988</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2988">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;oidurl&#39;} =~ s/[!&lt;]{1,2}$//) {</td></tr>
<tr><td class="h">2989</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2989">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (index($&amp;, &quot;!&quot;) &gt;= 0) {</td></tr>
<tr><td class="h">2990</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$exptype = &#39;long&#39;;</td></tr>
<tr><td class="h">2991</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$etime = time()+60*60*24*60;</td></tr>
<tr><td class="h">2992</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2993</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L2993">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ipfixed = LJ::get_remote_ip() if index($&amp;, &quot;&lt;&quot;) &gt;= 0;</td></tr>
<tr><td class="h">2994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2995</td><td colspan="7"></td></tr><tr><td class="h">2996</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tried_local_ref = LJ::OpenID::blocked_hosts($csr);</td></tr>
<tr><td class="h">2997</td><td colspan="7"></td></tr><tr><td class="h">2998</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $claimed_id = $csr-&gt;claimed_identity($form-&gt;{&#39;oidurl&#39;});</td></tr>
<tr><td class="h">2999</td><td colspan="7"></td></tr><tr><td class="h">3000</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3000">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($claimed_id) {</td></tr>
<tr><td class="h">3001</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3001">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;You can&#39;t use a $LJ::SITENAMESHORT OpenID account on $LJ::SITENAME &amp;mdash; &quot;.</td></tr>
<tr><td class="h">3002</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;just &lt;a href=&#39;/login&#39;&gt;go login&lt;/a&gt; with your actual $LJ::SITENAMESHORT account.&quot;) if $$tried_local_ref;</td></tr>
<tr><td class="h">3003</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;No claimed id: &quot;.$csr-&gt;err);</td></tr>
<tr><td class="h">3004</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3005</td><td colspan="7"></td></tr><tr><td class="h">3006</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Store their cleaned up identity url vs what they</td></tr>
<tr><td class="h">3007</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# actually typed in</td></tr>
<tr><td class="h">3008</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;oidurl&#39;} = $claimed_id-&gt;claimed_url();</td></tr>
<tr><td class="h">3009</td><td colspan="7"></td></tr><tr><td class="h">3010</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Store the entry</td></tr>
<tr><td class="h">3011</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pendcid = LJ::alloc_user_counter($journalu, &quot;C&quot;);</td></tr>
<tr><td class="h">3012</td><td colspan="7"></td></tr><tr><td class="h">3013</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3013">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(&quot;Unable to allocate pending id&quot;) unless $pendcid;</td></tr>
<tr><td class="h">3014</td><td colspan="7"></td></tr><tr><td class="h">3015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Since these were gotten from the oidurl and won&#39;t</td></tr>
<tr><td class="h">3016</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# persist in the form data</td></tr>
<tr><td class="h">3017</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;exptype&#39;} = $exptype;</td></tr>
<tr><td class="h">3018</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;etime&#39;} = $etime;</td></tr>
<tr><td class="h">3019</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;ipfixed&#39;} = $ipfixed;</td></tr>
<tr><td class="h">3020</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $penddata = Storable::freeze($form);</td></tr>
<tr><td class="h">3021</td><td colspan="7"></td></tr><tr><td class="h">3022</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3022">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(&quot;Unable to get database handle to store pending comment&quot;) unless $journalu-&gt;writer;</td></tr>
<tr><td class="h">3023</td><td colspan="7"></td></tr><tr><td class="h">3024</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;do(&quot;INSERT INTO pendcomments (jid, pendcid, data, datesubmit) VALUES (?, ?, ?, UNIX_TIMESTAMP())&quot;, undef, $journalu-&gt;{&#39;userid&#39;}, $pendcid, $penddata);</td></tr>
<tr><td class="h">3025</td><td colspan="7"></td></tr><tr><td class="h">3026</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3026">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;($journalu-&gt;errstr) if $journalu-&gt;err;</td></tr>
<tr><td class="h">3027</td><td colspan="7"></td></tr><tr><td class="h">3028</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $check_url = $claimed_id-&gt;check_url(</td></tr>
<tr><td class="h">3029</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return_to      =&gt; &quot;$LJ::SITEROOT/talkpost_do?jid=$journalu-&gt;{&#39;userid&#39;}&amp;pendcid=$pendcid&quot;,</td></tr>
<tr><td class="h">3030</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trust_root     =&gt; &quot;$LJ::SITEROOT&quot;,</td></tr>
<tr><td class="h">3031</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delayed_return =&gt; 1,</td></tr>
<tr><td class="h">3032</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">3033</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Don&#39;t redirect them if errors</td></tr>
<tr><td class="h">3034</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3034">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef if @$errret;</td></tr>
<tr><td class="h">3035</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return BML::redirect($check_url);</td></tr>
<tr><td class="h">3036</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3037</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3038</td><td colspan="7"></td></tr><tr><td class="h">3039</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# validate the challenge/response value (anti-spammer)</td></tr>
<tr><td class="h">3040</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3040">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($used_ecp) {</td></tr>
<tr><td class="h">3041</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $chrp_err;</td></tr>
<tr><td class="h">3042</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3042">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $chrp = $form-&gt;{&#39;chrp1&#39;}) {</td></tr>
<tr><td class="h">3043</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($c_ditemid, $c_uid, $c_time, $c_chars, $c_res) =</td></tr>
<tr><td class="h">3044</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;split(/\-/, $chrp);</td></tr>
<tr><td class="h">3045</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $chal = &quot;$c_ditemid-$c_uid-$c_time-$c_chars&quot;;</td></tr>
<tr><td class="h">3046</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $secret = LJ::get_secret($c_time);</td></tr>
<tr><td class="h">3047</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $res = Digest::MD5::md5_hex($secret . $chal);</td></tr>
<tr><td class="h">3048</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3048">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3048">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($res ne $c_res) {</td></tr>
<tr><td class="h">3049</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$chrp_err = &quot;invalid&quot;;</td></tr>
<tr><td class="h">3050</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($c_time &lt; time() - 2*60*60) {</td></tr>
<tr><td class="h">3051</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3051">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$chrp_err = &quot;too_old&quot; if $LJ::REQUIRE_TALKHASH_NOTOLD;</td></tr>
<tr><td class="h">3052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3053</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3054</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$chrp_err = &quot;missing&quot;;</td></tr>
<tr><td class="h">3055</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3056</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3056">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($chrp_err) {</td></tr>
<tr><td class="h">3057</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ip = LJ::get_remote_ip();</td></tr>
<tr><td class="h">3058</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3058">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::DEBUG{&#39;talkspam&#39;}) {</td></tr>
<tr><td class="h">3059</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3059">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ruser = $remote ? $remote-&gt;{user} : &quot;[nonuser]&quot;;</td></tr>
<tr><td class="h">3060</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print STDERR &quot;talkhash error: from $ruser \@ $ip - $chrp_err - $talkurl\n&quot;;</td></tr>
<tr><td class="h">3061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3062</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3062">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::REQUIRE_TALKHASH) {</td></tr>
<tr><td class="h">3063</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3063">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;Sorry, form expired.  Press back, copy text, reload form, paste into new form, and re-submit.&quot;)</td></tr>
<tr><td class="h">3064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $chrp_err eq &quot;too_old&quot;;</td></tr>
<tr><td class="h">3065</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;Missing parameters&quot;);</td></tr>
<tr><td class="h">3066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3067</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3068</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3069</td><td colspan="7"></td></tr><tr><td class="h">3070</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check that user can even view this post, which is required</td></tr>
<tr><td class="h">3071</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# to reply to it</td></tr>
<tr><td class="h">3072</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;####  Check security before viewing this post</td></tr>
<tr><td class="h">3073</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3073">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (LJ::can_view($up, $item)) {</td></tr>
<tr><td class="h">3074</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3074">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.mustlogin&quot;) unless (defined $up);</td></tr>
<tr><td class="h">3075</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.noauth&quot;);</td></tr>
<tr><td class="h">3076</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">3077</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3078</td><td colspan="7"></td></tr><tr><td class="h">3079</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# If the reply is to a comment, check that it exists.</td></tr>
<tr><td class="h">3080</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it&#39;s screened, check that the user has permission to</td></tr>
<tr><td class="h">3081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# reply and unscreen it</td></tr>
<tr><td class="h">3082</td><td colspan="7"></td></tr><tr><td class="h">3083</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parpost;</td></tr>
<tr><td class="h">3084</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $partid = $form-&gt;{&#39;parenttalkid&#39;}+0;</td></tr>
<tr><td class="h">3085</td><td colspan="7"></td></tr><tr><td class="h">3086</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3086">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($partid) {</td></tr>
<tr><td class="h">3087</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parpost = LJ::Talk::get_talk2_row($dbcr, $journalu-&gt;{userid}, $partid);</td></tr>
<tr><td class="h">3088</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3088">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($parpost) {</td></tr>
<tr><td class="h">3089</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.noparent&quot;);</td></tr>
<tr><td class="h">3090</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3091</td><td colspan="7"></td></tr><tr><td class="h">3092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t use $remote because we may get here</td></tr>
<tr><td class="h">3093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# with a reply from email. so use $up instead of $remote</td></tr>
<tr><td class="h">3094</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# in the call below.</td></tr>
<tr><td class="h">3095</td><td colspan="7"></td></tr><tr><td class="h">3096</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3096">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3096">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($parpost &amp;&amp; $parpost-&gt;{&#39;state&#39;} eq &quot;S&quot; &amp;&amp;</td></tr>
<tr><td class="h">3097</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!LJ::Talk::can_unscreen($up, $journalu, $init-&gt;{entryu}, $init-&gt;{entryu}{&#39;user&#39;})) {</td></tr>
<tr><td class="h">3098</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.screened&quot;);</td></tr>
<tr><td class="h">3099</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3101</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{parpost} = $parpost;</td></tr>
<tr><td class="h">3102</td><td colspan="7"></td></tr><tr><td class="h">3103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t allow anonymous comments on syndicated items</td></tr>
<tr><td class="h">3104</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3104">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3104">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $journalu-&gt;is_syndicated &amp;&amp; $journalu-&gt;{&#39;opt_whocanreply&#39;} eq &quot;all&quot; ) {</td></tr>
<tr><td class="h">3105</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$journalu-&gt;{&#39;opt_whocanreply&#39;} = &quot;reg&quot;;</td></tr>
<tr><td class="h">3106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3107</td><td colspan="7"></td></tr><tr><td class="h">3108</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3108">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3108">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (($form-&gt;{&#39;usertype&#39;} ne &quot;user&quot; &amp;&amp; $form-&gt;{&#39;usertype&#39;} ne &#39;openid&#39; &amp;&amp; $form-&gt;{&#39;usertype&#39;} ne &#39;openid_cookie&#39;)</td></tr>
<tr><td class="h">3109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; $journalu-&gt;{&#39;opt_whocanreply&#39;} ne &quot;all&quot;) </td></tr>
<tr><td class="h">3110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">3111</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.noanon&quot;);</td></tr>
<tr><td class="h">3112</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3113</td><td colspan="7"></td></tr><tr><td class="h">3114</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3114">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($iprops-&gt;{&#39;opt_nocomments&#39;}) {</td></tr>
<tr><td class="h">3115</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.nocomments&quot;);</td></tr>
<tr><td class="h">3116</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3117</td><td colspan="7"></td></tr><tr><td class="h">3118</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3118">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($up) {</td></tr>
<tr><td class="h">3119</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3119">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3119">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($up-&gt;{&#39;status&#39;} eq &quot;N&quot; &amp;&amp; !$up-&gt;is_identity &amp;&amp; !LJ::run_hook(&quot;journal_allows_unvalidated_commenting&quot;, $journalu)) {</td></tr>
<tr><td class="h">3120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.noverify2&quot;, {&#39;aopts&#39; =&gt; &quot;href=&#39;$LJ::SITEROOT/register&#39;&quot;}));</td></tr>
<tr><td class="h">3121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3122</td><td colspan="7"></td></tr><tr><td class="h">3123</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3123">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.purged&quot;)    if $up-&gt;is_expunged;</td></tr>
<tr><td class="h">3124</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3124">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.deleted&quot;)   if $up-&gt;is_deleted;</td></tr>
<tr><td class="h">3125</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3125">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.suspended&quot;) if $up-&gt;is_suspended;</td></tr>
<tr><td class="h">3126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3127</td><td colspan="7"></td></tr><tr><td class="h">3128</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3128">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($journalu-&gt;{&#39;opt_whocanreply&#39;} eq &quot;friends&quot;) {</td></tr>
<tr><td class="h">3129</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3129">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($up) {</td></tr>
<tr><td class="h">3130</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3130">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($up-&gt;{&#39;userid&#39;} != $journalu-&gt;{&#39;userid&#39;}) {</td></tr>
<tr><td class="h">3131</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3131">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ( $journalu-&gt;trusts_or_has_member( $up ) ) {</td></tr>
<tr><td class="h">3132</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3132">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg = $journalu-&gt;is_comm ? &quot;notamember&quot; : &quot;notafriend&quot;;</td></tr>
<tr><td class="h">3133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.$msg&quot;, {&#39;user&#39;=&gt;$journalu-&gt;{&#39;user&#39;}}));</td></tr>
<tr><td class="h">3134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3135</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3137</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3137">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg = $journalu-&gt;is_comm ? &quot;membersonly&quot; : &quot;friendsonly&quot;;</td></tr>
<tr><td class="h">3138</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.$msg&quot;, {&#39;user&#39;=&gt;$journalu-&gt;{&#39;user&#39;}}));</td></tr>
<tr><td class="h">3139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3141</td><td colspan="7"></td></tr><tr><td class="h">3142</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3142">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$bmlerr-&gt;(&quot;$SC.error.blankmessage&quot;) unless $form-&gt;{&#39;body&#39;} =~ /\S/;</td></tr>
<tr><td class="h">3143</td><td colspan="7"></td></tr><tr><td class="h">3144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# in case this post comes directly from the user&#39;s mail client, it</td></tr>
<tr><td class="h">3145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# may have an encoding field for us.</td></tr>
<tr><td class="h">3146</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3146">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;encoding&#39;}) {</td></tr>
<tr><td class="h">3147</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;body&#39;} = Unicode::MapUTF8::to_utf8({-string=&gt;$form-&gt;{&#39;body&#39;}, -charset=&gt;$form-&gt;{&#39;encoding&#39;}});</td></tr>
<tr><td class="h">3148</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;subject&#39;} = Unicode::MapUTF8::to_utf8({-string=&gt;$form-&gt;{&#39;subject&#39;}, -charset=&gt;$form-&gt;{&#39;encoding&#39;}});</td></tr>
<tr><td class="h">3149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3150</td><td colspan="7"></td></tr><tr><td class="h">3151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# unixify line-endings</td></tr>
<tr><td class="h">3152</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;body&#39;} =~ s/\r\n/\n/g;</td></tr>
<tr><td class="h">3153</td><td colspan="7"></td></tr><tr><td class="h">3154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now check for UTF-8 correctness, it must hold</td></tr>
<tr><td class="h">3155</td><td colspan="7"></td></tr><tr><td class="h">3156</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3156">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;&lt;?badinput?&gt;&quot;) unless LJ::text_in($form);</td></tr>
<tr><td class="h">3157</td><td colspan="7"></td></tr><tr><td class="h">3158</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{unknown8bit} = 0;</td></tr>
<tr><td class="h">3159</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3159">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3159">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (LJ::is_ascii($form-&gt;{&#39;body&#39;}) &amp;&amp; LJ::is_ascii($form-&gt;{&#39;subject&#39;})) {</td></tr>
<tr><td class="h">3160</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3160">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE) {</td></tr>
<tr><td class="h">3161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# no need to check if they&#39;re well-formed, we did that above</td></tr>
<tr><td class="h">3162</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# so rest of site can change chars to ? marks until</td></tr>
<tr><td class="h">3164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# default user&#39;s encoding is set.  (legacy support)</td></tr>
<tr><td class="h">3165</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{unknown8bit} = 1;</td></tr>
<tr><td class="h">3166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3167</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3168</td><td colspan="7"></td></tr><tr><td class="h">3169</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($bl, $cl) = LJ::text_length($form-&gt;{&#39;body&#39;});</td></tr>
<tr><td class="h">3170</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3170">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3170">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($cl &gt; LJ::CMAX_COMMENT) {</td></tr>
<tr><td class="h">3171</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.manychars&quot;, {&#39;current&#39;=&gt;$cl, &#39;limit&#39;=&gt;LJ::CMAX_COMMENT}));</td></tr>
<tr><td class="h">3172</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($bl &gt; LJ::BMAX_COMMENT) {</td></tr>
<tr><td class="h">3173</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$err-&gt;(BML::ml(&quot;$SC.error.manybytes&quot;, {&#39;current&#39;=&gt;$bl, &#39;limit&#39;=&gt;LJ::BMAX_COMMENT}));</td></tr>
<tr><td class="h">3174</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the Subject can be silently shortened, no need to reject the whole comment</td></tr>
<tr><td class="h">3176</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;subject&#39;} = LJ::text_trim($form-&gt;{&#39;subject&#39;}, 100, 100);</td></tr>
<tr><td class="h">3177</td><td colspan="7"></td></tr><tr><td class="h">3178</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $subjecticon = &quot;&quot;;</td></tr>
<tr><td class="h">3179</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3179">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3179">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($form-&gt;{&#39;subjecticon&#39;} ne &quot;none&quot; &amp;&amp; $form-&gt;{&#39;subjecticon&#39;} ne &quot;&quot;) {</td></tr>
<tr><td class="h">3180</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$subjecticon = LJ::trim(lc($form-&gt;{&#39;subjecticon&#39;}));</td></tr>
<tr><td class="h">3181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3182</td><td colspan="7"></td></tr><tr><td class="h">3183</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# figure out whether to post this comment screened</td></tr>
<tr><td class="h">3184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $state = &#39;A&#39;;</td></tr>
<tr><td class="h">3185</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $screening = LJ::Talk::screening_level($journalu, $ditemid &gt;&gt; 8);</td></tr>
<tr><td class="h">3186</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3186">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3186">0</a></div><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3186">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$form-&gt;{editid} &amp;&amp; ($screening eq &#39;A&#39; ||</td></tr>
<tr><td class="h">3187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($screening eq &#39;R&#39; &amp;&amp; ! $up) ||</td></tr>
<tr><td class="h">3188</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($screening eq &#39;F&#39; &amp;&amp; !($up &amp;&amp; $journalu-&gt;trusts_or_has_member( $up ))))) {</td></tr>
<tr><td class="h">3189</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$state = &#39;S&#39;;</td></tr>
<tr><td class="h">3190</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3191</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3191">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$state = &#39;A&#39; if LJ::Talk::can_unscreen($up, $journalu, $init-&gt;{entryu}, $init-&gt;{entryu}{user});</td></tr>
<tr><td class="h">3192</td><td colspan="7"></td></tr><tr><td class="h">3193</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $parent = {</td></tr>
<tr><td class="h">3194</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state     =&gt; $parpost-&gt;{state},</td></tr>
<tr><td class="h">3195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;talkid    =&gt; $partid,</td></tr>
<tr><td class="h">3196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">3197</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comment = {</td></tr>
<tr><td class="h">3198</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u               =&gt; $up,</td></tr>
<tr><td class="h">3199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;usertype        =&gt; $form-&gt;{&#39;usertype&#39;},</td></tr>
<tr><td class="h">3200</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject         =&gt; $form-&gt;{&#39;subject&#39;},</td></tr>
<tr><td class="h">3201</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;body            =&gt; $form-&gt;{&#39;body&#39;},</td></tr>
<tr><td class="h">3202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unknown8bit     =&gt; $init-&gt;{unknown8bit},</td></tr>
<tr><td class="h">3203</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subjecticon     =&gt; $subjecticon,</td></tr>
<tr><td class="h">3204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preformat       =&gt; $form-&gt;{&#39;prop_opt_preformatted&#39;},</td></tr>
<tr><td class="h">3205</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;picture_keyword =&gt; $form-&gt;{&#39;prop_picture_keyword&#39;},</td></tr>
<tr><td class="h">3206</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state           =&gt; $state,</td></tr>
<tr><td class="h">3207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;editid          =&gt; $form-&gt;{editid},</td></tr>
<tr><td class="h">3208</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">3209</td><td colspan="7"></td></tr><tr><td class="h">3210</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{item} = $item;</td></tr>
<tr><td class="h">3211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{parent} = $parent;</td></tr>
<tr><td class="h">3212</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$init-&gt;{comment} = $comment;</td></tr>
<tr><td class="h">3213</td><td colspan="7"></td></tr><tr><td class="h">3214</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# anti-spam captcha check</td></tr>
<tr><td class="h">3215</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3215">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref $need_captcha eq &#39;SCALAR&#39;) {</td></tr>
<tr><td class="h">3216</td><td colspan="7"></td></tr><tr><td class="h">3217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# see if they&#39;re in the second+ phases of a captcha check.</td></tr>
<tr><td class="h">3218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# are they sending us a response?</td></tr>
<tr><td class="h">3219</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3219">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3219">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3219">0</a></div><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3219">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::is_enabled(&quot;recaptcha&quot;) &amp;&amp; $form-&gt;{recaptcha_response_field}) {</td></tr>
<tr><td class="h">3220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# assume they won&#39;t pass and re-set the flag</td></tr>
<tr><td class="h">3221</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$need_captcha = 1;</td></tr>
<tr><td class="h">3222</td><td colspan="7"></td></tr><tr><td class="h">3223</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $c = Captcha::reCAPTCHA-&gt;new;</td></tr>
<tr><td class="h">3224</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $result = $c-&gt;check_answer(</td></tr>
<tr><td class="h">3225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::conf_test($LJ::RECAPTCHA{private_key}), $ENV{&#39;REMOTE_ADDR&#39;},</td></tr>
<tr><td class="h">3226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;recaptcha_challenge_field&#39;}, $form-&gt;{&#39;recaptcha_response_field&#39;}</td></tr>
<tr><td class="h">3227</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">3228</td><td colspan="7"></td></tr><tr><td class="h">3229</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3229">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;Incorrect response to spam robot challenge.&quot;) unless $result-&gt;{is_valid} eq &#39;1&#39;;</td></tr>
<tr><td class="h">3230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif (!LJ::is_enabled(&quot;recaptcha&quot;) &amp;&amp; $form-&gt;{captcha_chal}) {</td></tr>
<tr><td class="h">3231</td><td colspan="7"></td></tr><tr><td class="h">3232</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# assume they won&#39;t pass and re-set the flag</td></tr>
<tr><td class="h">3233</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$need_captcha = 1;</td></tr>
<tr><td class="h">3234</td><td colspan="7"></td></tr><tr><td class="h">3235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if they typed &quot;audio&quot;, we don&#39;t double-check if they still need</td></tr>
<tr><td class="h">3236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# a captcha (they still do), they just want an audio version.</td></tr>
<tr><td class="h">3237</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3237">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (lc($form-&gt;{answer}) eq &#39;audio&#39;) {</td></tr>
<tr><td class="h">3238</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">3239</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3240</td><td colspan="7"></td></tr><tr><td class="h">3241</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($capid, $anum) = LJ::Captcha::session_check_code($form-&gt;{captcha_chal},</td></tr>
<tr><td class="h">3242</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{answer}, $journalu);</td></tr>
<tr><td class="h">3243</td><td colspan="7"></td></tr><tr><td class="h">3244</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3244">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3244">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;Incorrect response to spam robot challenge.&quot;) unless $capid &amp;&amp; $anum;</td></tr>
<tr><td class="h">3245</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3245">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $expire_u = $comment-&gt;{&#39;u&#39;} || LJ::load_user(&#39;system&#39;);</td></tr>
<tr><td class="h">3246</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Captcha::expire($capid, $anum, $expire_u-&gt;{userid});</td></tr>
<tr><td class="h">3247</td><td colspan="7"></td></tr><tr><td class="h">3248</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3249</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$need_captcha = LJ::Talk::Post::require_captcha_test($comment-&gt;{&#39;u&#39;}, $journalu, $form-&gt;{body}, $ditemid);</td></tr>
<tr><td class="h">3250</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3250">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($$need_captcha) {</td></tr>
<tr><td class="h">3251</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $err-&gt;(&quot;Please confirm you are a human below.&quot;);</td></tr>
<tr><td class="h">3252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3255</td><td colspan="7"></td></tr><tr><td class="h">3256</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3256">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef if @$errret;</td></tr>
<tr><td class="h">3257</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $init;</td></tr>
<tr><td class="h">3258</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3259</td><td colspan="7"></td></tr><tr><td class="h">3260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">3261</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Talk::Post::require_captcha_test</td></tr>
<tr><td class="h">3262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: returns true if user must answer CAPTCHA (human test) before posting a comment</td></tr>
<tr><td class="h">3263</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: commenter, journal, body, ditemid</td></tr>
<tr><td class="h">3264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-commenter: User object of author of comment, undef for anonymous commenter</td></tr>
<tr><td class="h">3265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-journal: User object of journal where to post comment</td></tr>
<tr><td class="h">3266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-body: Text of the comment (may be checked for spam, may be empty)</td></tr>
<tr><td class="h">3267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-ditemid: identifier of post, need for checking reply-count</td></tr>
<tr><td class="h">3268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">3269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub require_captcha_test {</td></tr>
<tr><td class="h">3270</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L3270">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($commenter, $journal, $body, $ditemid) = @_;</td></tr>
<tr><td class="h">3271</td><td colspan="7"></td></tr><tr><td class="h">3272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## anonymous commenter user = </td></tr>
<tr><td class="h">3273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## not logged-in user, or OpenID without validated e-mail</td></tr>
<tr><td class="h">3274</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3274">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $anon_commenter = !LJ::isu($commenter) || </td></tr>
<tr><td class="h">3275</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($commenter-&gt;identity &amp;&amp; !$commenter-&gt;is_validated);</td></tr>
<tr><td class="h">3276</td><td colspan="7"></td></tr><tr><td class="h">3277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3278</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## 1. Check rate by remote user and by IP (for anonymous user)</td></tr>
<tr><td class="h">3279</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3280</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3280">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3280">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::HUMAN_CHECK{anonpost} || $LJ::HUMAN_CHECK{authpost}) {</td></tr>
<tr><td class="h">3281</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3281">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if !LJ::Talk::Post::check_rate($commenter, $journal);</td></tr>
<tr><td class="h">3282</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3283</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3283">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3283">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::HUMAN_CHECK{anonpost} &amp;&amp; $anon_commenter) {</td></tr>
<tr><td class="h">3284</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3284">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if LJ::sysban_check(&#39;talk_ip_test&#39;, LJ::get_remote_ip());</td></tr>
<tr><td class="h">3285</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3286</td><td colspan="7"></td></tr><tr><td class="h">3287</td><td colspan="7"></td></tr><tr><td class="h">3288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3289</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## 4. Test preliminary limit on comment.</td></tr>
<tr><td class="h">3290</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## We must check it before we will allow owner to pass.</td></tr>
<tr><td class="h">3291</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3292</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3292">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::Talk::get_replycount($journal, $ditemid &gt;&gt; 8) &gt;= LJ::get_cap($journal, &#39;maxcomments-before-captcha&#39;)) {</td></tr>
<tr><td class="h">3293</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3295</td><td colspan="7"></td></tr><tr><td class="h">3296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## 2. Don&#39;t show captcha to the owner of the journal, no more checks</td></tr>
<tr><td class="h">3298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3299</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3299">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3299">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$anon_commenter &amp;&amp; $commenter-&gt;{userid}==$journal-&gt;{userid}) {</td></tr>
<tr><td class="h">3300</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">3301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3302</td><td colspan="7"></td></tr><tr><td class="h">3303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3304</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## 3. Custom (journal) settings</td></tr>
<tr><td class="h">3305</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3306</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $show_captcha_to = $journal-&gt;prop(&#39;opt_show_captcha_to&#39;);</td></tr>
<tr><td class="h">3307</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3307">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3307">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3307">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3307">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3307">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$show_captcha_to || $show_captcha_to eq &#39;N&#39;) {</td></tr>
<tr><td class="h">3308</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## no one</td></tr>
<tr><td class="h">3309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($show_captcha_to eq &#39;R&#39;) {</td></tr>
<tr><td class="h">3310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## anonymous</td></tr>
<tr><td class="h">3311</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3311">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $anon_commenter;</td></tr>
<tr><td class="h">3312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($show_captcha_to eq &#39;F&#39;) {</td></tr>
<tr><td class="h">3313</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## not friends</td></tr>
<tr><td class="h">3314</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3314">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if !$journal-&gt;trusts_or_has_member( $commenter );</td></tr>
<tr><td class="h">3315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($show_captcha_to eq &#39;A&#39;) {</td></tr>
<tr><td class="h">3316</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## all</td></tr>
<tr><td class="h">3317</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3319</td><td colspan="7"></td></tr><tr><td class="h">3320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3321</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## 4. Global (site) settings</td></tr>
<tr><td class="h">3322</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## See if they have any tags or URLs in the comment&#39;s body</td></tr>
<tr><td class="h">3323</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">3324</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3324">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3324">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::HUMAN_CHECK{&#39;comment_html_auth&#39;} </td></tr>
<tr><td class="h">3325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| ($LJ::HUMAN_CHECK{&#39;comment_html_anon&#39;} &amp;&amp; $anon_commenter))</td></tr>
<tr><td class="h">3326</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">3327</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3327">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($body =~ /&lt;[a-z]/i) {</td></tr>
<tr><td class="h">3328</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# strip white-listed bare tags w/o attributes,</td></tr>
<tr><td class="h">3329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# then see if they still have HTML.  if so, it&#39;s</td></tr>
<tr><td class="h">3330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# questionable.  (can do evil spammy-like stuff w/</td></tr>
<tr><td class="h">3331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# attributes and other elements)</td></tr>
<tr><td class="h">3332</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $body_copy = $body;</td></tr>
<tr><td class="h">3333</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body_copy =~ s/&lt;(?:q|blockquote|b|strong|i|em|cite|sub|sup|var|del|tt|code|pre|p)&gt;//ig;</td></tr>
<tr><td class="h">3334</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3334">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $body_copy =~ /&lt;[a-z]/i;</td></tr>
<tr><td class="h">3335</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# multiple URLs is questionable too</td></tr>
<tr><td class="h">3337</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3337">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $body =~ /\b(?:http|ftp|www)\b.+\b(?:http|ftp|www)\b/s;</td></tr>
<tr><td class="h">3338</td><td colspan="7"></td></tr><tr><td class="h">3339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# or if they&#39;re not even using HTML</td></tr>
<tr><td class="h">3340</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3340">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $body =~ /\[url/is;</td></tr>
<tr><td class="h">3341</td><td colspan="7"></td></tr><tr><td class="h">3342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# or if it&#39;s obviously spam</td></tr>
<tr><td class="h">3343</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3343">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $body =~ /\s*message\s*/is;</td></tr>
<tr><td class="h">3344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3346</td><td colspan="7"></td></tr><tr><td class="h">3347</td><td colspan="7"></td></tr><tr><td class="h">3348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1 on success.  0 on fail (with $$errref set)</td></tr>
<tr><td class="h">3349</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub post_comment {</td></tr>
<tr><td class="h">3350</td><td><div class="c3">214</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-talklib-pl--subroutine.html#L3350">214</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($entryu, $journalu, $comment, $parent, $item, $errref) = @_;</td></tr>
<tr><td class="h">3351</td><td colspan="7"></td></tr><tr><td class="h">3352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# unscreen the parent comment if needed</td></tr>
<tr><td class="h">3353</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L3353">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($parent-&gt;{state} eq &#39;S&#39;) {</td></tr>
<tr><td class="h">3354</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Talk::unscreen_comment($journalu, $item-&gt;{itemid}, $parent-&gt;{talkid});</td></tr>
<tr><td class="h">3355</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parent-&gt;{state} = &#39;A&#39;;</td></tr>
<tr><td class="h">3356</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3357</td><td colspan="7"></td></tr><tr><td class="h">3358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check for duplicate entry (double submission)</td></tr>
<tr><td class="h">3359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Note:  we don&#39;t do it inside a locked section like ljprotocol.pl&#39;s postevent,</td></tr>
<tr><td class="h">3360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so it&#39;s not perfect, but it works pretty well.</td></tr>
<tr><td class="h">3361</td><td><div class="c3">214</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L3361">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posterid = $comment-&gt;{u} ? $comment-&gt;{u}{userid} : 0;</td></tr>
<tr><td class="h">3362</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jtalkid;</td></tr>
<tr><td class="h">3363</td><td colspan="7"></td></tr><tr><td class="h">3364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check for dup ID in memcache.</td></tr>
<tr><td class="h">3365</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey;</td></tr>
<tr><td class="h">3366</td><td><div class="c3">214</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L3366">100</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@LJ::MEMCACHE_SERVERS) {</td></tr>
<tr><td class="h">3367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# avoid warnings FIXME this should be done elsewhere</td></tr>
<tr><td class="h">3368</td><td><div class="c3">144</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $field (qw(body subject subjecticon preformat picture_keyword)) {</td></tr>
<tr><td class="h">3369</td><td><div class="c3">720</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-talklib-pl--branch.html#L3369">100</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;{$field} = &#39;&#39; if not defined $comment-&gt;{$field};</td></tr>
<tr><td class="h">3370</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3371</td><td><div class="c3">144</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $md5_b64 = Digest::MD5::md5_base64(</td></tr>
<tr><td class="h">3372</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;join(&quot;:&quot;, ($comment-&gt;{body}, $comment-&gt;{subject},</td></tr>
<tr><td class="h">3373</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;{subjecticon}, $comment-&gt;{preformat},</td></tr>
<tr><td class="h">3374</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;{picture_keyword})));</td></tr>
<tr><td class="h">3375</td><td><div class="c3">144</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$memkey = [$journalu-&gt;{userid}, &quot;tdup:$journalu-&gt;{userid}:$item-&gt;{itemid}-$parent-&gt;{talkid}-$posterid-$md5_b64&quot; ];</td></tr>
<tr><td class="h">3376</td><td><div class="c3">144</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$jtalkid = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">3377</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3378</td><td colspan="7"></td></tr><tr><td class="h">3379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# they don&#39;t have a duplicate...</td></tr>
<tr><td class="h">3380</td><td><div class="c3">214</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L3380">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($jtalkid) {</td></tr>
<tr><td class="h">3381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# XXX do select and delete $talkprop{&#39;picture_keyword&#39;} if they&#39;re lying</td></tr>
<tr><td class="h">3382</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pic = LJ::get_pic_from_keyword($comment-&gt;{u}, $comment-&gt;{picture_keyword});</td></tr>
<tr><td class="h">3383</td><td><div class="c3">214</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-talklib-pl--branch.html#L3383">50</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3383">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $comment-&gt;{picture_keyword} unless $pic &amp;&amp; $pic-&gt;{&#39;state&#39;} eq &#39;N&#39;;</td></tr>
<tr><td class="h">3384</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;{pic} = $pic;</td></tr>
<tr><td class="h">3385</td><td colspan="7"></td></tr><tr><td class="h">3386</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# put the post in the database</td></tr>
<tr><td class="h">3387</td><td><div class="c3">214</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3387">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{anum} ||= 0; # avoid warning FIXME this should be done elsewhere</td></tr>
<tr><td class="h">3388</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $item-&gt;{itemid}*256 + $item-&gt;{anum};</td></tr>
<tr><td class="h">3389</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$jtalkid = enter_comment($journalu, $parent, $item, $comment, $errref);</td></tr>
<tr><td class="h">3390</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-talklib-pl--branch.html#L3390">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $jtalkid;</td></tr>
<tr><td class="h">3391</td><td colspan="7"></td></tr><tr><td class="h">3392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# save its identifying characteristics to protect against duplicates.</td></tr>
<tr><td class="h">3393</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $jtalkid+0, time()+60*10);</td></tr>
<tr><td class="h">3394</td><td colspan="7"></td></tr><tr><td class="h">3395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# send some emails</td></tr>
<tr><td class="h">3396</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mail_comments($entryu, $journalu, $parent, $comment, $item);</td></tr>
<tr><td class="h">3397</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3398</td><td colspan="7"></td></tr><tr><td class="h">3399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the caller wants to know the comment&#39;s talkid.</td></tr>
<tr><td class="h">3400</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;{talkid} = $jtalkid;</td></tr>
<tr><td class="h">3401</td><td colspan="7"></td></tr><tr><td class="h">3402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# cluster tracking</td></tr>
<tr><td class="h">3403</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::mark_user_active($comment-&gt;{u}, &#39;comment&#39;);</td></tr>
<tr><td class="h">3404</td><td colspan="7"></td></tr><tr><td class="h">3405</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&#39;new_comment&#39;, $journalu-&gt;{userid}, $item-&gt;{itemid}, $jtalkid);</td></tr>
<tr><td class="h">3406</td><td colspan="7"></td></tr><tr><td class="h">3407</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3409</td><td colspan="7"></td></tr><tr><td class="h">3410</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1 on success.  0 on fail (with $$errref set)</td></tr>
<tr><td class="h">3411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub edit_comment {</td></tr>
<tr><td class="h">3412</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L3412">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($entryu, $journalu, $comment, $parent, $item, $errref) = @_;</td></tr>
<tr><td class="h">3413</td><td colspan="7"></td></tr><tr><td class="h">3414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = sub {</td></tr>
<tr><td class="h">3415</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L3415">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = join(&quot;: &quot;, @_);</td></tr>
<tr><td class="h">3416</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3417</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">3418</td><td colspan="7"></td></tr><tr><td class="h">3419</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comment_obj = LJ::Comment-&gt;new($journalu, dtalkid =&gt; $comment-&gt;{editid});</td></tr>
<tr><td class="h">3420</td><td colspan="7"></td></tr><tr><td class="h">3421</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">3422</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3422">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $comment_obj-&gt;remote_can_edit($errref);</td></tr>
<tr><td class="h">3423</td><td colspan="7"></td></tr><tr><td class="h">3424</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3424">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %props = (</td></tr>
<tr><td class="h">3425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subjecticon =&gt; $comment-&gt;{subjecticon},</td></tr>
<tr><td class="h">3426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;picture_keyword =&gt; $comment-&gt;{picture_keyword},</td></tr>
<tr><td class="h">3427</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opt_preformatted =&gt; $comment-&gt;{preformat} ? 1 : 0,</td></tr>
<tr><td class="h">3428</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">3429</td><td colspan="7"></td></tr><tr><td class="h">3430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set most of the props together</td></tr>
<tr><td class="h">3431</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$comment_obj-&gt;set_props(%props);</td></tr>
<tr><td class="h">3432</td><td colspan="7"></td></tr><tr><td class="h">3433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set edit time separately since it needs to be a raw value</td></tr>
<tr><td class="h">3434</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$comment_obj-&gt;set_prop_raw( edit_time =&gt; &quot;UNIX_TIMESTAMP()&quot; );</td></tr>
<tr><td class="h">3435</td><td colspan="7"></td></tr><tr><td class="h">3436</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set poster IP separately since it has special conditions</td></tr>
<tr><td class="h">3437</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opt_logcommentips = $comment_obj-&gt;journal-&gt;opt_logcommentips;</td></tr>
<tr><td class="h">3438</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3438">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3438">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opt_logcommentips eq &quot;A&quot; || ($opt_logcommentips eq &quot;S&quot; &amp;&amp; $comment-&gt;{usertype} ne &quot;user&quot;)) {</td></tr>
<tr><td class="h">3439</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comment_obj-&gt;set_poster_ip;</td></tr>
<tr><td class="h">3440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3441</td><td colspan="7"></td></tr><tr><td class="h">3442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set subject and body text</td></tr>
<tr><td class="h">3443</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$comment_obj-&gt;set_subject_and_body($comment-&gt;{subject}, $comment-&gt;{body});</td></tr>
<tr><td class="h">3444</td><td colspan="7"></td></tr><tr><td class="h">3445</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the caller wants to know the comment&#39;s talkid.</td></tr>
<tr><td class="h">3446</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;{talkid} = $comment_obj-&gt;jtalkid;</td></tr>
<tr><td class="h">3447</td><td colspan="7"></td></tr><tr><td class="h">3448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# cluster tracking</td></tr>
<tr><td class="h">3449</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::mark_user_active($comment_obj-&gt;poster, &#39;comment&#39;);</td></tr>
<tr><td class="h">3450</td><td colspan="7"></td></tr><tr><td class="h">3451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# fire events</td></tr>
<tr><td class="h">3452</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3452">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( LJ::is_enabled(&#39;esn&#39;) ) {</td></tr>
<tr><td class="h">3453</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @jobs;</td></tr>
<tr><td class="h">3454</td><td colspan="7"></td></tr><tr><td class="h">3455</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::Event::JournalNewComment-&gt;new($comment_obj)-&gt;fire_job;</td></tr>
<tr><td class="h">3456</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3456">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3456">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::Event::UserNewComment-&gt;new($comment_obj)-&gt;fire_job</td></tr>
<tr><td class="h">3457</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $comment_obj-&gt;poster &amp;&amp; LJ::is_enabled(&#39;esn-userevents&#39;);</td></tr>
<tr><td class="h">3458</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::EventLogRecord::NewComment-&gt;new($comment_obj)-&gt;fire_job;</td></tr>
<tr><td class="h">3459</td><td colspan="7"></td></tr><tr><td class="h">3460</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sclient = LJ::theschwartz();</td></tr>
<tr><td class="h">3461</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3461">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3461">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($sclient &amp;&amp; @jobs) {</td></tr>
<tr><td class="h">3462</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @handles = $sclient-&gt;insert_jobs(@jobs);</td></tr>
<tr><td class="h">3463</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3465</td><td colspan="7"></td></tr><tr><td class="h">3466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# send some emails</td></tr>
<tr><td class="h">3467</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;mail_comments($entryu, $journalu, $parent, $comment, $item);</td></tr>
<tr><td class="h">3468</td><td colspan="7"></td></tr><tr><td class="h">3469</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&#39;edit_comment&#39;, $journalu-&gt;{userid}, $item-&gt;{itemid}, $comment-&gt;{talkid});</td></tr>
<tr><td class="h">3470</td><td colspan="7"></td></tr><tr><td class="h">3471</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3473</td><td colspan="7"></td></tr><tr><td class="h">3474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># XXXevan:  this function should have its functionality migrated to talkpost.</td></tr>
<tr><td class="h">3475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># because of that, it&#39;s probably not worth the effort to make it not mangle $form...</td></tr>
<tr><td class="h">3476</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub make_preview {</td></tr>
<tr><td class="h">3477</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L3477">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($talkurl, $cookie_auth, $form) = @_;</td></tr>
<tr><td class="h">3478</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = &quot;&quot;;</td></tr>
<tr><td class="h">3479</td><td colspan="7"></td></tr><tr><td class="h">3480</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cleansubject = $form-&gt;{&#39;subject&#39;};</td></tr>
<tr><td class="h">3481</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_subject(\$cleansubject);</td></tr>
<tr><td class="h">3482</td><td colspan="7"></td></tr><tr><td class="h">3483</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;?h1 $BML::ML{&#39;/talkpost_do.bml.preview.title&#39;} h1?&gt;&lt;?p $BML::ML{&#39;/talkpost_do.bml.preview&#39;} p?&gt;&lt;?hr?&gt;&quot;;</td></tr>
<tr><td class="h">3484</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;div align=\&quot;center\&quot;&gt;&lt;b&gt;(&lt;a href=\&quot;$talkurl\&quot;&gt;$BML::ML{&#39;talk.commentsread&#39;}&lt;/a&gt;)&lt;/b&gt;&lt;/div&gt;&quot;;</td></tr>
<tr><td class="h">3485</td><td colspan="7"></td></tr><tr><td class="h">3486</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $event = $form-&gt;{&#39;body&#39;};</td></tr>
<tr><td class="h">3487</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $spellcheck_html;</td></tr>
<tr><td class="h">3488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# clean first; if the cleaner finds it invalid, don&#39;t spellcheck, so that we</td></tr>
<tr><td class="h">3489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can show the user the error.</td></tr>
<tr><td class="h">3490</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cleanok = LJ::CleanHTML::clean_comment(\$event, $form-&gt;{&#39;prop_opt_preformatted&#39;});</td></tr>
<tr><td class="h">3491</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3491">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3491">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined($cleanok) &amp;&amp; $LJ::SPELLER &amp;&amp; $form-&gt;{&#39;do_spellcheck&#39;}) {</td></tr>
<tr><td class="h">3492</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $s = new LJ::SpellCheck { &#39;spellcommand&#39; =&gt; $LJ::SPELLER,</td></tr>
<tr><td class="h">3493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;color&#39; =&gt; &#39;&lt;?hotcolor?&gt;&#39;, };</td></tr>
<tr><td class="h">3494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$spellcheck_html = $s-&gt;check_html(\$event);</td></tr>
<tr><td class="h">3495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# unescape the &lt;br /&gt;s for readability. All other HTML remains untouched.</td></tr>
<tr><td class="h">3496</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$spellcheck_html =~ s/&amp;lt;br \/&amp;gt;/&lt;br \/&gt;/g;</td></tr>
<tr><td class="h">3497</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3498</td><td colspan="7"></td></tr><tr><td class="h">3499</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;$BML::ML{&#39;/talkpost_do.bml.preview.subject&#39;} &quot; . LJ::ehtml($cleansubject) . &quot;&lt;hr /&gt;\n&quot;;</td></tr>
<tr><td class="h">3500</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3500">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($spellcheck_html) {</td></tr>
<tr><td class="h">3501</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $spellcheck_html;</td></tr>
<tr><td class="h">3502</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;p&gt;&quot;;</td></tr>
<tr><td class="h">3503</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3504</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $event;</td></tr>
<tr><td class="h">3505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3506</td><td colspan="7"></td></tr><tr><td class="h">3507</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;hr /&gt;&quot;;</td></tr>
<tr><td class="h">3508</td><td colspan="7"></td></tr><tr><td class="h">3509</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# While it may seem like we need form auth for this form, the form for</td></tr>
<tr><td class="h">3510</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# actually composing a comment includes it.  It is then put into this</td></tr>
<tr><td class="h">3511</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# form about 20 lines below: foreach (keys %$form).</td></tr>
<tr><td class="h">3512</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;div style=&#39;width: 90%&#39;&gt;&lt;form method=&#39;post&#39;&gt;&lt;p&gt;\n&quot;;</td></tr>
<tr><td class="h">3513</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input name=&#39;subject&#39; size=&#39;50&#39; maxlength=&#39;100&#39; value=&#39;&quot; . LJ::ehtml($form-&gt;{&#39;subject&#39;}) . &quot;&#39; /&gt;&lt;br /&gt;&quot;;</td></tr>
<tr><td class="h">3514</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;textarea class=&#39;textbox&#39; rows=&#39;10&#39; cols=&#39;50&#39; wrap=&#39;soft&#39; name=&#39;body&#39; style=&#39;width: 100%&#39;&gt;&quot;;</td></tr>
<tr><td class="h">3515</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::ehtml($form-&gt;{&#39;body&#39;});</td></tr>
<tr><td class="h">3516</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/textarea&gt;&lt;/p&gt;&quot;;</td></tr>
<tr><td class="h">3517</td><td colspan="7"></td></tr><tr><td class="h">3518</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# change mode:</td></tr>
<tr><td class="h">3519</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;delete $form-&gt;{&#39;submitpreview&#39;}; $form-&gt;{&#39;submitpost&#39;} = 1;</td></tr>
<tr><td class="h">3520</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3520">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($cookie_auth) {</td></tr>
<tr><td class="h">3521</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$form-&gt;{&#39;usertype&#39;} = &quot;cookieuser&quot;;</td></tr>
<tr><td class="h">3522</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $form-&gt;{&#39;userpost&#39;};</td></tr>
<tr><td class="h">3523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3524</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;delete $form-&gt;{&#39;do_spellcheck&#39;};</td></tr>
<tr><td class="h">3525</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %$form) {</td></tr>
<tr><td class="h">3526</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3526">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3526">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::html_hidden($_, $form-&gt;{$_})</td></tr>
<tr><td class="h">3527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $_ eq &#39;body&#39; || $_ eq &#39;subject&#39; || $_ eq &#39;prop_opt_preformatted&#39;;</td></tr>
<tr><td class="h">3528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3529</td><td colspan="7"></td></tr><tr><td class="h">3530</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;br /&gt;&lt;input type=&#39;submit&#39; value=&#39;$BML::ML{&#39;/talkpost_do.bml.preview.submit&#39;}&#39; /&gt;\n&quot;;</td></tr>
<tr><td class="h">3531</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input type=&#39;submit&#39; name=&#39;submitpreview&#39; value=&#39;$BML::ML{&#39;talk.btn.preview&#39;}&#39; /&gt;\n&quot;;</td></tr>
<tr><td class="h">3532</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3532">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::SPELLER) {</td></tr>
<tr><td class="h">3533</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;input type=&#39;checkbox&#39; name=&#39;do_spellcheck&#39; value=&#39;1&#39; id=&#39;spellcheck&#39; /&gt; &lt;label for=&#39;spellcheck&#39;&gt;$BML::ML{&#39;talk.spellcheck&#39;}&lt;/label&gt;&quot;;</td></tr>
<tr><td class="h">3534</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3535</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;p&gt;&quot;;</td></tr>
<tr><td class="h">3536</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;$BML::ML{&#39;/talkpost.bml.opt.noautoformat&#39;} &quot;.</td></tr>
<tr><td class="h">3537</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::html_check({ &#39;name&#39; =&gt; &#39;prop_opt_preformatted&#39;,</td></tr>
<tr><td class="h">3538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selected =&gt; $form-&gt;{&#39;prop_opt_preformatted&#39;} });</td></tr>
<tr><td class="h">3539</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::help_icon_html(&quot;noautoformat&quot;, &quot; &quot;);</td></tr>
<tr><td class="h">3540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/p&gt;&quot;;</td></tr>
<tr><td class="h">3541</td><td colspan="7"></td></tr><tr><td class="h">3542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;p&gt; &lt;?de $BML::ML{&#39;/talkpost.bml.allowedhtml&#39;}: &quot;;</td></tr>
<tr><td class="h">3543</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (sort &amp;LJ::CleanHTML::get_okay_comment_tags()) {</td></tr>
<tr><td class="h">3544</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&amp;lt;$_&amp;gt; &quot;;</td></tr>
<tr><td class="h">3545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3546</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;de?&gt; &lt;/p&gt;&quot;;</td></tr>
<tr><td class="h">3547</td><td colspan="7"></td></tr><tr><td class="h">3548</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/form&gt;&lt;/div&gt;&quot;;</td></tr>
<tr><td class="h">3549</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">3550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3551</td><td colspan="7"></td></tr><tr><td class="h">3552</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># given a journalu and jitemid, return 1 if the entry</td></tr>
<tr><td class="h">3553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># is over the maximum comments allowed.</td></tr>
<tr><td class="h">3554</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub over_maxcomments {</td></tr>
<tr><td class="h">3555</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L3555">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalu, $jitemid) = @_;</td></tr>
<tr><td class="h">3556</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu = LJ::want_user($journalu);</td></tr>
<tr><td class="h">3557</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jitemid += 0;</td></tr>
<tr><td class="h">3558</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3558">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3558">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $journalu &amp;&amp; $jitemid;</td></tr>
<tr><td class="h">3559</td><td colspan="7"></td></tr><tr><td class="h">3560</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = LJ::Talk::get_replycount($journalu, $jitemid);</td></tr>
<tr><td class="h">3561</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3561">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ($count &gt;= LJ::get_cap($journalu, &#39;maxcomments&#39;)) ? 1 : 0;</td></tr>
<tr><td class="h">3562</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3563</td><td colspan="7"></td></tr><tr><td class="h">3564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># more anti-spammer rate limiting.  returns 1 if rate is okay, 0 if too fast.</td></tr>
<tr><td class="h">3565</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub check_rate {</td></tr>
<tr><td class="h">3566</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--subroutine.html#L3566">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($remote, $journalu) = @_;</td></tr>
<tr><td class="h">3567</td><td colspan="7"></td></tr><tr><td class="h">3568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we require memcache to do rate limiting efficiently</td></tr>
<tr><td class="h">3569</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3569">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless @LJ::MEMCACHE_SERVERS;</td></tr>
<tr><td class="h">3570</td><td colspan="7"></td></tr><tr><td class="h">3571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return right away if the account is suspended</td></tr>
<tr><td class="h">3572</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3572">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3572">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $remote &amp;&amp; ( $remote-&gt;is_suspended || $remote-&gt;is_deleted );</td></tr>
<tr><td class="h">3573</td><td colspan="7"></td></tr><tr><td class="h">3574</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# allow some users to be very aggressive commenters and authors. i.e. our bots.</td></tr>
<tr><td class="h">3575</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $remote </td></tr>
<tr><td class="h">3576</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3576">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3576">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and grep { $remote-&gt;username eq $_ } @LJ::NO_RATE_CHECK_USERS;</td></tr>
<tr><td class="h">3577</td><td colspan="7"></td></tr><tr><td class="h">3578</td><td colspan="7"></td></tr><tr><td class="h">3579</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ip = LJ::get_remote_ip();</td></tr>
<tr><td class="h">3580</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now = time();</td></tr>
<tr><td class="h">3581</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @watch;</td></tr>
<tr><td class="h">3582</td><td colspan="7"></td></tr><tr><td class="h">3583</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3583">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($remote) {</td></tr>
<tr><td class="h">3584</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# registered human (or human-impersonating robot)</td></tr>
<tr><td class="h">3585</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3585">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @watch,</td></tr>
<tr><td class="h">3586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</td></tr>
<tr><td class="h">3587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;talklog:$remote-&gt;{userid}&quot;,</td></tr>
<tr><td class="h">3588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::RATE_COMMENT_AUTH || [ [ 200, 3600 ], [ 20, 60 ] ],</td></tr>
<tr><td class="h">3589</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];</td></tr>
<tr><td class="h">3590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# anonymous, per IP address (robot or human)</td></tr>
<tr><td class="h">3592</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3592">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @watch,</td></tr>
<tr><td class="h">3593</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</td></tr>
<tr><td class="h">3594</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;talklog:$ip&quot;,</td></tr>
<tr><td class="h">3595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::RATE_COMMENT_ANON ||</td></tr>
<tr><td class="h">3596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ [ 300, 3600 ], [ 200, 1800 ], [ 150, 900 ], [ 15, 60 ] ]</td></tr>
<tr><td class="h">3597</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];</td></tr>
<tr><td class="h">3598</td><td colspan="7"></td></tr><tr><td class="h">3599</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# anonymous, per journal.</td></tr>
<tr><td class="h">3600</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# this particular limit is intended to combat flooders, instead</td></tr>
<tr><td class="h">3601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# of the other &#39;spammer-centric&#39; limits.</td></tr>
<tr><td class="h">3602</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3602">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @watch,</td></tr>
<tr><td class="h">3603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</td></tr>
<tr><td class="h">3604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;talklog:anonin:$journalu-&gt;{userid}&quot;,</td></tr>
<tr><td class="h">3605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::RATE_COMMENT_ANON ||</td></tr>
<tr><td class="h">3606</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ [ 300, 3600 ], [ 200, 1800 ], [ 150, 900 ], [ 15, 60 ] ]</td></tr>
<tr><td class="h">3607</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];</td></tr>
<tr><td class="h">3608</td><td colspan="7"></td></tr><tr><td class="h">3609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# throttle based on reports of spam</td></tr>
<tr><td class="h">3610</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3610">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @watch,</td></tr>
<tr><td class="h">3611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</td></tr>
<tr><td class="h">3612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;spamreports:anon:$ip&quot;,</td></tr>
<tr><td class="h">3613</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::SPAM_COMMENT_RATE ||</td></tr>
<tr><td class="h">3614</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ [ 50, 86400], [ 10, 3600 ] ]</td></tr>
<tr><td class="h">3615</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];</td></tr>
<tr><td class="h">3616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3617</td><td colspan="7"></td></tr><tr><td class="h">3618</td><td colspan="7"></td></tr><tr><td class="h">3619</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;WATCH:</td></tr>
<tr><td class="h">3620</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $watch (@watch) {</td></tr>
<tr><td class="h">3621</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($key, $rates) = ($watch-&gt;[0], $watch-&gt;[1]);</td></tr>
<tr><td class="h">3622</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $max_period = $rates-&gt;[0]-&gt;[1];</td></tr>
<tr><td class="h">3623</td><td colspan="7"></td></tr><tr><td class="h">3624</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $log = LJ::MemCache::get($key);</td></tr>
<tr><td class="h">3625</td><td colspan="7"></td></tr><tr><td class="h">3626</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# parse the old log</td></tr>
<tr><td class="h">3627</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @times;</td></tr>
<tr><td class="h">3628</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3628">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3628">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (length($log) % 4 == 1 &amp;&amp; substr($log,0,1) eq $RATE_DATAVER) {</td></tr>
<tr><td class="h">3629</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ct = (length($log)-1) / 4;</td></tr>
<tr><td class="h">3630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (my $i=0; $i&lt;$ct; $i++) {</td></tr>
<tr><td class="h">3631</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $time = unpack(&quot;N&quot;, substr($log,$i*4+1,4));</td></tr>
<tr><td class="h">3632</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3632">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @times, $time if $time &gt; $now - $max_period;</td></tr>
<tr><td class="h">3633</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3634</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3635</td><td colspan="7"></td></tr><tr><td class="h">3636</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# add this event unless we&#39;re throttling based on spamreports</td></tr>
<tr><td class="h">3637</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3637">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @times, $now unless $key =~ /^spamreports/;</td></tr>
<tr><td class="h">3638</td><td colspan="7"></td></tr><tr><td class="h">3639</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# check rates</td></tr>
<tr><td class="h">3640</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $rate (@$rates) {</td></tr>
<tr><td class="h">3641</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($allowed, $period) = ($rate-&gt;[0], $rate-&gt;[1]);</td></tr>
<tr><td class="h">3642</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $events = scalar grep { $_ &gt; $now-$period } @times;</td></tr>
<tr><td class="h">3643</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3643">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($events &gt; $allowed) {</td></tr>
<tr><td class="h">3644</td><td colspan="7"></td></tr><tr><td class="h">3645</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3645">0</a></div></td><td><div class="c0"><a href="cgi-bin-talklib-pl--condition.html#L3645">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::DEBUG{&#39;talkrate&#39;} &amp;&amp;</td></tr>
<tr><td class="h">3646</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add(&quot;warn:$key&quot;, 1, 600)) {</td></tr>
<tr><td class="h">3647</td><td colspan="7"></td></tr><tr><td class="h">3648</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3648">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ruser = (exists $remote-&gt;{&#39;user&#39;}) ? $remote-&gt;{&#39;user&#39;} : &#39;Not logged in&#39;;</td></tr>
<tr><td class="h">3649</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $nowtime = localtime($now);</td></tr>
<tr><td class="h">3650</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $body = &lt;&lt;EOM;</td></tr>
<tr><td class="h">3651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">Talk spam from $key:</td></tr>
<tr><td class="h">3652</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">$events comments &gt; $allowed allowed / $period secs</td></tr>
<tr><td class="h">3653</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remote user: $ruser</td></tr>
<tr><td class="h">3654</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remote IP:   $ip</td></tr>
<tr><td class="h">3655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Time caught: $nowtime</td></tr>
<tr><td class="h">3656</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Posting to:  $journalu-&gt;{&#39;user&#39;}</td></tr>
<tr><td class="h">3657</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">EOM</td></tr>
<tr><td class="h">3658</td><td colspan="7"></td></tr><tr><td class="h">3659</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::send_mail({</td></tr>
<tr><td class="h">3660</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;to&#39; =&gt; $LJ::DEBUG{&#39;talkrate&#39;},</td></tr>
<tr><td class="h">3661</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;from&#39; =&gt; $LJ::ADMIN_EMAIL,</td></tr>
<tr><td class="h">3662</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fromname&#39; =&gt; $LJ::SITENAME,</td></tr>
<tr><td class="h">3663</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;charset&#39; =&gt; &#39;utf-8&#39;,</td></tr>
<tr><td class="h">3664</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;subject&#39; =&gt; &quot;talk spam: $key&quot;,</td></tr>
<tr><td class="h">3665</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;body&#39; =&gt; $body,</td></tr>
<tr><td class="h">3666</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">3667</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} # end sending email</td></tr>
<tr><td class="h">3668</td><td colspan="7"></td></tr><tr><td class="h">3669</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-talklib-pl--branch.html#L3669">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $LJ::ANTI_TALKSPAM;</td></tr>
<tr><td class="h">3670</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last WATCH;</td></tr>
<tr><td class="h">3671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3672</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3673</td><td colspan="7"></td></tr><tr><td class="h">3674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# build the new log</td></tr>
<tr><td class="h">3675</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $newlog = $RATE_DATAVER;</td></tr>
<tr><td class="h">3676</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@times) {</td></tr>
<tr><td class="h">3677</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newlog .= pack(&quot;N&quot;, $_);</td></tr>
<tr><td class="h">3678</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3679</td><td colspan="7"></td></tr><tr><td class="h">3680</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($key, $newlog, $max_period);</td></tr>
<tr><td class="h">3681</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3682</td><td colspan="7"></td></tr><tr><td class="h">3683</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3685</td><td colspan="7"></td></tr><tr><td class="h">3686</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
<tr><td class="h">3687</td><td colspan="7"></td></tr></table>
</body>
</html>
