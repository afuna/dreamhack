<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/DW/InviteCodes.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/DW/InviteCodes.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">17.6%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#!/usr/bin/perl</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># DW::InviteCodes - Invite code management backend for Dreamwidth</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Authors:</td></tr>
<tr><td class="h">6</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      Afuna &lt;coder.dw@afunamatata.com&gt;</td></tr>
<tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      Pau Amma &lt;pauamma@cpan.org&gt;</td></tr>
<tr><td class="h">8</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">9</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Copyright (c) 2009 by Dreamwidth Studios, LLC.</td></tr>
<tr><td class="h">10</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is free software; you may redistribute it and/or modify it under</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># the same terms as Perl itself. For a copy of the license, please reference</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &#39;perldoc perlartistic&#39; or &#39;perldoc perlgpl&#39;.</td></tr>
<tr><td class="h">14</td><td colspan="7"></td></tr><tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package DW::InviteCodes;</td></tr>
<tr><td class="h">16</td><td colspan="7"></td></tr><tr><td class="h">17 - 59</td><td colspan="6"></td><td class="s"><pre>=head1 NAME

DW::InviteCodes - Invite code management backend for Dreamwidth

=head1 SYNOPSIS

  use DW::InviteCodes;

  # Reward the module authors
  my @ic = DW::InviteCodes-&gt;generate( owner =&gt; LJ::load_user(&quot;system&quot;),
                                      count =&gt; 2,
                                      reason =&gt; &quot;For DW::InviteCodes authors&quot; );

  # Check whether a code is valid
  my $valid = DW::InviteCodes-&gt;check_code( code =&gt; $code [, userid =&gt; $recipient] );

  # Retrieve DW::InviteCodes object(s) by code, owner (all or just unused), or recipient
  # (note: these return objects, not strings)
  my $object = DW::InviteCodes-&gt;new( code =&gt; $invite );
  my @owned = DW::InviteCodes-&gt;by_owner( userid =&gt; $userid );
  my @unused = DW::InviteCodes-&gt;by_owner_unused( userid =&gt; $userid);
  my @used = DW::InviteCodes-&gt;by_recipient( userid =&gt; $userid );

  # Retrieve a count of all invite codes
  my $count = DW::InviteCodes-&gt;unused_count( userid =&gt; $userid );

  # Access object data
  my $invite = $object-&gt;code;
  my $owner = $object-&gt;owner; # userid, not LJ::User object
  my $recipient = $object-&gt;recipient; # userid or 0
  my $reason = $object-&gt;reason;
  my $email = $object-&gt;email;
  my $timegenerate = $object-&gt;timegenerate; # unix timestamp
  my $timesent = $object-&gt;timesent; #unix timestamp
  my $is_used = $object-&gt;is_used; # true if used to create an account

  # Mark the invite code as sent
  $code-&gt;send_code( email =&gt; $email );

  # Mark the invite code as used
  $code-&gt;use_code( user =&gt; LJ::load_user(&#39;new&#39;) );

=cut</pre></td></tr>
<tr><td class="h">60</td><td colspan="7"></td></tr><tr><td class="h">61</td><td><div class="c3">32</div><div class="c3">32</div><div class="c3">32</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L61">32</a></div></td><td></td><td><div>4001</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">62</td><td><div class="c3">32</div><div class="c3">32</div><div class="c3">32</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L62">32</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use warnings;</td></tr>
<tr><td class="h">63</td><td colspan="7"></td></tr><tr><td class="h">64</td><td><div class="c3">32</div><div class="c3">32</div><div class="c3">32</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L64">32</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use fields qw(acid userid rcptid auth reason timegenerate timesent email);</td></tr>
<tr><td class="h">65</td><td colspan="7"></td></tr><tr><td class="h">66</td><td><div class="c3">32</div><div class="c3">32</div><div class="c3">32</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L66">32</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use constant { AUTH_LEN =&gt; 13, ACID_LEN =&gt; 7 };</td></tr>
<tr><td class="h">67</td><td><div class="c3">32</div><div class="c3">32</div><div class="c3">32</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L67">32</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use constant DIGITS =&gt; qw(A B C D E F G H J K L M N P Q R S T U V W X Y Z 2 3 4 5 6 7 8 9);</td></tr>
<tr><td class="h">68</td><td><div class="c3">32</div><div class="c3">32</div><div class="c3">32</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L68">32</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use constant { CODE_LEN =&gt; AUTH_LEN + ACID_LEN, DIGITS_LEN =&gt; scalar(DIGITS) };</td></tr>
<tr><td class="h">69</td><td colspan="7"></td></tr><tr><td class="h">70 - 79</td><td colspan="6"></td><td class="s"><pre>=head1 API

=head2 C&lt;&lt; $class-&gt;generate( [ count =&gt; $howmany, ] owner =&gt; $forwho, reason =&gt; $why &gt;&gt;

Generates $howmany invite codes (default 1) and sets their reason to $why and
owner to $forwho.

If owner is undef, the codes will be &#39;system codes&#39; and have no source.

=cut</pre></td></tr>
<tr><td class="h">80</td><td colspan="7"></td></tr><tr><td class="h">81</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub generate {</td></tr>
<tr><td class="h">82</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L82">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">83</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--condition.html#L83">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts{count} ||= 1;</td></tr>
<tr><td class="h">84</td><td colspan="7"></td></tr><tr><td class="h">85</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L85">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer()</td></tr>
<tr><td class="h">86</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;Unable to connect to database.\n&quot;;</td></tr>
<tr><td class="h">87</td><td colspan="7"></td></tr><tr><td class="h">88</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L88">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbh-&gt;prepare(</td></tr>
<tr><td class="h">89</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q{INSERT INTO acctcode (acid, userid, rcptid, auth, reason, timegenerate)</td></tr>
<tr><td class="h">90</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VALUES (NULL, ?, 0, ?, ?, UNIX_TIMESTAMP())}</td></tr>
<tr><td class="h">91</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">92</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;Unable to allocate statement handle.\n&quot;;</td></tr>
<tr><td class="h">93</td><td colspan="7"></td></tr><tr><td class="h">94</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @invitecodes;</td></tr>
<tr><td class="h">95</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @authcodes = map { LJ::make_auth_code( AUTH_LEN ) } 1..$opts{count};</td></tr>
<tr><td class="h">96</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L96">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $opts{owner} ? $opts{owner}-&gt;id : 0;</td></tr>
<tr><td class="h">97</td><td colspan="7"></td></tr><tr><td class="h">98</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $auth ( @authcodes ) {</td></tr>
<tr><td class="h">99</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute( $uid, $auth, $opts{reason} );</td></tr>
<tr><td class="h">100</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L100">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Unable to generate invite codes: &quot; . $dbh-&gt;errstr . &quot;\n&quot;</td></tr>
<tr><td class="h">101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $dbh-&gt;err;</td></tr>
<tr><td class="h">102</td><td colspan="7"></td></tr><tr><td class="h">103</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $acid = $dbh-&gt;{mysql_insertid};</td></tr>
<tr><td class="h">104</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @invitecodes, $class-&gt;encode( $acid, $auth );</td></tr>
<tr><td class="h">105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">106</td><td colspan="7"></td></tr><tr><td class="h">107</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @invitecodes;</td></tr>
<tr><td class="h">108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">109</td><td colspan="7"></td></tr><tr><td class="h">110 - 115</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;could_be_code( string =&gt; $string ) &gt;&gt;

Checks whether $string could possibly be a code. It makes sure that it only
contains DIGITS and is CODE_LEN long.

=cut</pre></td></tr>
<tr><td class="h">116</td><td colspan="7"></td></tr><tr><td class="h">117</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub could_be_code {</td></tr>
<tr><td class="h">118</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L118">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $class, %opts ) = @_;</td></tr>
<tr><td class="h">119</td><td colspan="7"></td></tr><tr><td class="h">120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $string = uc $opts{string};</td></tr>
<tr><td class="h">121</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L121">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless length $string == CODE_LEN;</td></tr>
<tr><td class="h">122</td><td colspan="7"></td></tr><tr><td class="h">123</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %valid_digits = map { $_ =&gt; 1 } DIGITS;</td></tr>
<tr><td class="h">124</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @string_array = split( //, $string );</td></tr>
<tr><td class="h">125</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $char ( @string_array ) {</td></tr>
<tr><td class="h">126</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L126">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $valid_digits{$char};</td></tr>
<tr><td class="h">127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">128</td><td colspan="7"></td></tr><tr><td class="h">129</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">131</td><td colspan="7"></td></tr><tr><td class="h">132 - 136</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;is_promo_code( code =&gt; $code ) &gt;&gt;

Returns if the given code is a promo code or not.

=cut</pre></td></tr>
<tr><td class="h">137</td><td colspan="7"></td></tr><tr><td class="h">138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_promo_code {</td></tr>
<tr><td class="h">139</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L139">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $class, %opts ) = @_;</td></tr>
<tr><td class="h">140</td><td colspan="7"></td></tr><tr><td class="h">141</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $promo_code_info = $class-&gt;get_promo_code_info( code =&gt; $opts{code} );</td></tr>
<tr><td class="h">142</td><td colspan="7"></td></tr><tr><td class="h">143</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L143">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ref $promo_code_info ? 1 : 0;</td></tr>
<tr><td class="h">144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">145</td><td colspan="7"></td></tr><tr><td class="h">146 - 150</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;get_promo_code_info( code =&gt; $code ) &gt;&gt;

Return the info for this promo code in a hashref.

=cut</pre></td></tr>
<tr><td class="h">151</td><td colspan="7"></td></tr><tr><td class="h">152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_promo_code_info {</td></tr>
<tr><td class="h">153</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L153">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $class, %opts ) = @_;</td></tr>
<tr><td class="h">154</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">155</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $code = $opts{code};</td></tr>
<tr><td class="h">156</td><td colspan="7"></td></tr><tr><td class="h">157</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L157">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--condition.html#L157">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $code &amp;&amp; $code =~ /^[a-z0-9]+$/i; # make sure the code is valid first</td></tr>
<tr><td class="h">158</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $dbh-&gt;selectrow_hashref( &quot;SELECT * FROM acctcode_promo WHERE code = ?&quot;, undef, $code );</td></tr>
<tr><td class="h">159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">160</td><td colspan="7"></td></tr><tr><td class="h">161 - 167</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;check_code( code =&gt; $invite [, userid =&gt; $recipient] ) &gt;&gt;

Checks whether code $invite is valid before trying to create an account. Takes
an optional $recipient userid, to protect the code from accidentally being used
if the form is double-submitted.

=cut</pre></td></tr>
<tr><td class="h">168</td><td colspan="7"></td></tr><tr><td class="h">169</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub check_code {</td></tr>
<tr><td class="h">170</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L170">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">171</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">172</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $code = $opts{code};</td></tr>
<tr><td class="h">173</td><td colspan="7"></td></tr><tr><td class="h">174</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check if this code is a promo code first</td></tr>
<tr><td class="h">175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it is, make sure it&#39;s active and we&#39;re not over the creation limit for the code</td></tr>
<tr><td class="h">176</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $promo_code_info = $class-&gt;get_promo_code_info( code =&gt; $code );</td></tr>
<tr><td class="h">177</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L177">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( ref $promo_code_info ) {</td></tr>
<tr><td class="h">178</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L178">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--condition.html#L178">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $promo_code_info-&gt;{active} &amp;&amp; ( $promo_code_info-&gt;{current_count} &lt; $promo_code_info-&gt;{max_count} );</td></tr>
<tr><td class="h">179</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">181</td><td colspan="7"></td></tr><tr><td class="h">182</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L182">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $class-&gt;could_be_code( string =&gt; $code );</td></tr>
<tr><td class="h">183</td><td colspan="7"></td></tr><tr><td class="h">184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($acid, $auth) = $class-&gt;decode( $code );</td></tr>
<tr><td class="h">185</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ac = $dbh-&gt;selectrow_hashref( &quot;SELECT userid, rcptid, auth &quot; .</td></tr>
<tr><td class="h">186</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM acctcode WHERE acid=?&quot;,</td></tr>
<tr><td class="h">187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $acid);</td></tr>
<tr><td class="h">188</td><td colspan="7"></td></tr><tr><td class="h">189</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# invalid account code</td></tr>
<tr><td class="h">190</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L190">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--condition.html#L190">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless ( $ac &amp;&amp; uc($ac-&gt;{auth}) eq $auth );</td></tr>
<tr><td class="h">191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# code has already been used</td></tr>
<tr><td class="h">192</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--condition.html#L192">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $opts{userid} || 0;</td></tr>
<tr><td class="h">193</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L193">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--condition.html#L193">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if ( $ac-&gt;{rcptid} &amp;&amp; $ac-&gt;{rcptid} != $userid );</td></tr>
<tr><td class="h">194</td><td colspan="7"></td></tr><tr><td class="h">195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# is the inviter suspended?</td></tr>
<tr><td class="h">196</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::load_userid( $ac-&gt;{userid} );</td></tr>
<tr><td class="h">197</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L197">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--condition.html#L197">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if ( $u &amp;&amp; $u-&gt;is_suspended );</td></tr>
<tr><td class="h">198</td><td colspan="7"></td></tr><tr><td class="h">199</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">200</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">201</td><td colspan="7"></td></tr><tr><td class="h">202 - 207</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;paid_status( code =&gt; $code ) &gt;&gt;

Checks whether this code comes loaded with a paid account. Returns a DW::Shop::Item::Account 
if yes; undef if not

=cut</pre></td></tr>
<tr><td class="h">208</td><td colspan="7"></td></tr><tr><td class="h">209</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub paid_status {</td></tr>
<tr><td class="h">210</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L210">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;    </td></tr>
<tr><td class="h">211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $code = $opts{code};</td></tr>
<tr><td class="h">212</td><td colspan="7"></td></tr><tr><td class="h">213</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L213">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless DW::InviteCodes-&gt;check_code( code =&gt; $code );</td></tr>
<tr><td class="h">214</td><td colspan="7"></td></tr><tr><td class="h">215</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemidref;</td></tr>
<tr><td class="h">216</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L216">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( my $cart = DW::Shop::Cart-&gt;get_from_invite( $code, itemidref =&gt; \$itemidref ) ) {</td></tr>
<tr><td class="h">217</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $item = $cart-&gt;get_item( $itemidref );</td></tr>
<tr><td class="h">218</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L218">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--condition.html#L218">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $item if $item &amp;&amp; $item-&gt;isa( &#39;DW::Shop::Item::Account&#39; );</td></tr>
<tr><td class="h">219</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">220</td><td colspan="7"></td></tr><tr><td class="h">221</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">222</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">223</td><td colspan="7"></td></tr><tr><td class="h">224 - 228</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;use_code( user =&gt; $recipient ) &gt;&gt;

Marks an invite code as having been used to create the $recipient account.

=cut</pre></td></tr>
<tr><td class="h">229</td><td colspan="7"></td></tr><tr><td class="h">230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub use_code {</td></tr>
<tr><td class="h">231</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L231">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, %opts) = @_;</td></tr>
<tr><td class="h">232</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">233</td><td colspan="7"></td></tr><tr><td class="h">234</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{rcptid} = $opts{user}-&gt;{userid};</td></tr>
<tr><td class="h">235</td><td colspan="7"></td></tr><tr><td class="h">236</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do( &quot;UPDATE acctcode SET email=NULL, rcptid=? WHERE acid=?&quot;,</td></tr>
<tr><td class="h">237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $opts{user}-&gt;{userid}, $self-&gt;{acid} );</td></tr>
<tr><td class="h">238</td><td colspan="7"></td></tr><tr><td class="h">239</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1; # 1 means success? Needs error return in that case.</td></tr>
<tr><td class="h">240</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">241</td><td colspan="7"></td></tr><tr><td class="h">242 - 246</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;use_promo_code

Increments the current_count on the given promo code.

=cut</pre></td></tr>
<tr><td class="h">247</td><td colspan="7"></td></tr><tr><td class="h">248</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub use_promo_code {</td></tr>
<tr><td class="h">249</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L249">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $class, %opts ) = @_;</td></tr>
<tr><td class="h">250</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">251</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $code = $opts{code};</td></tr>
<tr><td class="h">252</td><td colspan="7"></td></tr><tr><td class="h">253</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L253">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $class-&gt;is_promo_code( code =&gt; $code );</td></tr>
<tr><td class="h">254</td><td colspan="7"></td></tr><tr><td class="h">255</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do( &quot;UPDATE acctcode_promo SET current_count = current_count + 1 WHERE code = ?&quot;, undef, $code );</td></tr>
<tr><td class="h">256</td><td colspan="7"></td></tr><tr><td class="h">257</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">258</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">259</td><td colspan="7"></td></tr><tr><td class="h">260 - 265</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;send_code ( [ email =&gt; $email ] ) &gt;&gt;

Marks an invite code as having been sent. The code may or may not have been used to create a new account.
Make sure if passing email to validate first!

=cut</pre></td></tr>
<tr><td class="h">266</td><td colspan="7"></td></tr><tr><td class="h">267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub send_code {</td></tr>
<tr><td class="h">268</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L268">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, %opts) = @_;</td></tr>
<tr><td class="h">269</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">270</td><td colspan="7"></td></tr><tr><td class="h">271</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do( &quot;UPDATE acctcode SET timesent=UNIX_TIMESTAMP(), email=? WHERE acid=?&quot;,</td></tr>
<tr><td class="h">272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $opts{email}, $self-&gt;{acid} );</td></tr>
<tr><td class="h">273</td><td colspan="7"></td></tr><tr><td class="h">274</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1; # 1 means success? Needs error return in that case.</td></tr>
<tr><td class="h">275</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">276</td><td colspan="7"></td></tr><tr><td class="h">277 - 281</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;new( code =&gt; $invite ) &gt;&gt;

Returns object for invite, or undef if none exists.

=cut</pre></td></tr>
<tr><td class="h">282</td><td colspan="7"></td></tr><tr><td class="h">283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new {</td></tr>
<tr><td class="h">284</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L284">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">285</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">286</td><td colspan="7"></td></tr><tr><td class="h">287</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L287">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless length( $opts{code} ) == CODE_LEN;</td></tr>
<tr><td class="h">288</td><td colspan="7"></td></tr><tr><td class="h">289</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($acid, $auth) = $class-&gt;decode( $opts{code} );</td></tr>
<tr><td class="h">290</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ac = $dbr-&gt;selectrow_hashref( &quot;SELECT acid, userid, rcptid, auth, reason, timegenerate, timesent, email FROM acctcode &quot;.</td></tr>
<tr><td class="h">291</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE acid=? AND auth=?&quot;,</td></tr>
<tr><td class="h">292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $acid, $auth);</td></tr>
<tr><td class="h">293</td><td colspan="7"></td></tr><tr><td class="h">294</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L294">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless defined $ac;</td></tr>
<tr><td class="h">295</td><td colspan="7"></td></tr><tr><td class="h">296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = fields::new($class);</td></tr>
<tr><td class="h">297</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %$ac) {</td></tr>
<tr><td class="h">298</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{$k} = $v;</td></tr>
<tr><td class="h">299</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">300</td><td colspan="7"></td></tr><tr><td class="h">301</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">302</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">303</td><td colspan="7"></td></tr><tr><td class="h">304 - 320</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;by_owner( userid =&gt; $userid ) &gt;&gt;

Returns (as objects) the list of all invite codes generated by (or on behalf
of) $userid.

=head2 C&lt;&lt; $class-&gt;by_owner_unused( userid =&gt; $userid ) &gt;&gt;

Returns (as objects) the list of all unused invite codes generated by
(or on behalf of) $userid.

=head2 C&lt;&lt; $class-&gt;by_recipient( userid =&gt; $userid ) &gt;&gt;

Returns (as objects) the list of all invite codes used by $userid. (This will
normally be a singleton, but the table declaration doesn&#39;t make that key
unique, so going for safety.)

=cut</pre></td></tr>
<tr><td class="h">321</td><td colspan="7"></td></tr><tr><td class="h">322</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub by_owner {</td></tr>
<tr><td class="h">323</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L323">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">324</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $class-&gt;load_by( &#39;userid&#39;, $opts{userid} );</td></tr>
<tr><td class="h">325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">326</td><td colspan="7"></td></tr><tr><td class="h">327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub by_owner_unused {</td></tr>
<tr><td class="h">328</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L328">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">329</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $class-&gt;load_by( &#39;userid&#39;, $opts{userid}, 1 );</td></tr>
<tr><td class="h">330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">331</td><td colspan="7"></td></tr><tr><td class="h">332</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub by_recipient {</td></tr>
<tr><td class="h">333</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L333">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">334</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $class-&gt;load_by( &#39;rcptid&#39;, $opts{userid} );</td></tr>
<tr><td class="h">335</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">336</td><td colspan="7"></td></tr><tr><td class="h">337 - 341</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;unused_count( user =&gt; $userid ) &gt;&gt;

Returns a count of unused invite codes owned by $userid.

=cut</pre></td></tr>
<tr><td class="h">342</td><td colspan="7"></td></tr><tr><td class="h">343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unused_count {</td></tr>
<tr><td class="h">344</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L344">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">345</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $opts{userid};</td></tr>
<tr><td class="h">346</td><td colspan="7"></td></tr><tr><td class="h">347</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">348</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = $dbr-&gt;selectrow_array( &quot;SELECT COUNT(*) FROM acctcode WHERE userid = ? AND rcptid = 0&quot;, undef, $userid );</td></tr>
<tr><td class="h">349</td><td colspan="7"></td></tr><tr><td class="h">350</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $count;</td></tr>
<tr><td class="h">351</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">352</td><td colspan="7"></td></tr><tr><td class="h">353</td><td colspan="7"></td></tr><tr><td class="h">354 - 361</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;load_by( $field, $userid ) &gt;&gt;

Internal. Loads all invite codes with $field (that should be one of the userid
fields) set to $userid. Note: this has protection against most SQL injection
attempts, but is not guaranteed to be 100% safe. Caller should take care not
to pass externally generated values in $field.

=cut</pre></td></tr>
<tr><td class="h">362</td><td colspan="7"></td></tr><tr><td class="h">363</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_by {</td></tr>
<tr><td class="h">364</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L364">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $field, $userid, $only_load_unused) = @_;</td></tr>
<tr><td class="h">365</td><td colspan="7"></td></tr><tr><td class="h">366</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L366">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;SQL injection attempt? &#39;$field&#39;&quot; unless $field =~ /^\w+$/;</td></tr>
<tr><td class="h">367</td><td colspan="7"></td></tr><tr><td class="h">368</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">369</td><td colspan="7"></td></tr><tr><td class="h">370</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L370">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $unused_sql = $only_load_unused ? &quot;AND rcptid=0&quot; : &quot;&quot;;</td></tr>
<tr><td class="h">371</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L371">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbr-&gt;prepare( &quot;SELECT acid, userid, rcptid, auth, reason, timegenerate, timesent, email FROM acctcode WHERE $field = ? $unused_sql&quot; )</td></tr>
<tr><td class="h">372</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;Unable to retrieve invite codes by $field: &quot; . $dbr-&gt;errstr;</td></tr>
<tr><td class="h">373</td><td colspan="7"></td></tr><tr><td class="h">374</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L374">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($userid + 0)</td></tr>
<tr><td class="h">375</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;Unable to retrieve invite codes by $field: &quot; . $sth-&gt;errstr;</td></tr>
<tr><td class="h">376</td><td colspan="7"></td></tr><tr><td class="h">377</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @ics;</td></tr>
<tr><td class="h">378</td><td colspan="7"></td></tr><tr><td class="h">379</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my $ac = $sth-&gt;fetchrow_hashref) {</td></tr>
<tr><td class="h">380</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ret = fields::new($class);</td></tr>
<tr><td class="h">381</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %$ac) {</td></tr>
<tr><td class="h">382</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{$k} = $v;</td></tr>
<tr><td class="h">383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">384</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @ics, $ret;</td></tr>
<tr><td class="h">385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">386</td><td colspan="7"></td></tr><tr><td class="h">387</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @ics;</td></tr>
<tr><td class="h">388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">389</td><td colspan="7"></td></tr><tr><td class="h">390 - 394</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;code &gt;&gt;

Returns the object&#39;s invite code.

=cut</pre></td></tr>
<tr><td class="h">395</td><td colspan="7"></td></tr><tr><td class="h">396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub code {</td></tr>
<tr><td class="h">397</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L397">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self) = @_;</td></tr>
<tr><td class="h">398</td><td colspan="7"></td></tr><tr><td class="h">399</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return (ref $self)-&gt;encode($self-&gt;{acid}, $self-&gt;{auth});</td></tr>
<tr><td class="h">400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">401</td><td colspan="7"></td></tr><tr><td class="h">402 - 406</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;owner &gt;&gt;

Returns the object&#39;s owner (userid, not LJ::User object).

=cut</pre></td></tr>
<tr><td class="h">407</td><td colspan="7"></td></tr><tr><td class="h">408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub owner {</td></tr>
<tr><td class="h">409</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L409">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self) = @_;</td></tr>
<tr><td class="h">410</td><td colspan="7"></td></tr><tr><td class="h">411</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{userid};</td></tr>
<tr><td class="h">412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">413</td><td colspan="7"></td></tr><tr><td class="h">414 - 418</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;recipient &gt;&gt;

Returns the object&#39;s recipient (userid or 0).

=cut</pre></td></tr>
<tr><td class="h">419</td><td colspan="7"></td></tr><tr><td class="h">420</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub recipient {</td></tr>
<tr><td class="h">421</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L421">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self) = @_;</td></tr>
<tr><td class="h">422</td><td colspan="7"></td></tr><tr><td class="h">423</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{rcptid};</td></tr>
<tr><td class="h">424</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">425</td><td colspan="7"></td></tr><tr><td class="h">426 - 430</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;reason &gt;&gt;

Returns the object&#39;s reason for creation.

=cut</pre></td></tr>
<tr><td class="h">431</td><td colspan="7"></td></tr><tr><td class="h">432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub reason {</td></tr>
<tr><td class="h">433</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L433">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self) = @_;</td></tr>
<tr><td class="h">434</td><td colspan="7"></td></tr><tr><td class="h">435</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{reason};</td></tr>
<tr><td class="h">436</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">437</td><td colspan="7"></td></tr><tr><td class="h">438 - 442</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;timegenerate &gt;&gt;

Returns the object&#39;s  generated date and time as a unix timestamp.

=cut</pre></td></tr>
<tr><td class="h">443</td><td colspan="7"></td></tr><tr><td class="h">444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub timegenerate {</td></tr>
<tr><td class="h">445</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L445">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self) = @_;</td></tr>
<tr><td class="h">446</td><td colspan="7"></td></tr><tr><td class="h">447</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{timegenerate};</td></tr>
<tr><td class="h">448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">449</td><td colspan="7"></td></tr><tr><td class="h">450 - 454</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;timesent &gt;&gt;

Returns the date and time the invite code was sent through the interface, as a unix timestamp. The code may or may not have been used since.

=cut</pre></td></tr>
<tr><td class="h">455</td><td colspan="7"></td></tr><tr><td class="h">456</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub timesent {</td></tr>
<tr><td class="h">457</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L457">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self) = @_;</td></tr>
<tr><td class="h">458</td><td colspan="7"></td></tr><tr><td class="h">459</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{timesent};</td></tr>
<tr><td class="h">460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">461</td><td colspan="7"></td></tr><tr><td class="h">462 - 466</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;email &gt;&gt;

Returns the email address the invite code was sent to through the interface. The code may or may not have been used since.

=cut</pre></td></tr>
<tr><td class="h">467</td><td colspan="7"></td></tr><tr><td class="h">468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub email {</td></tr>
<tr><td class="h">469</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L469">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self) = @_;</td></tr>
<tr><td class="h">470</td><td colspan="7"></td></tr><tr><td class="h">471</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{email};</td></tr>
<tr><td class="h">472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">473</td><td colspan="7"></td></tr><tr><td class="h">474 - 478</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $object-&gt;is_used &gt;&gt;

Returns true if the object was used to create an account, false otherwise.

=cut</pre></td></tr>
<tr><td class="h">479</td><td colspan="7"></td></tr><tr><td class="h">480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_used {</td></tr>
<tr><td class="h">481</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L481">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self) = @_;</td></tr>
<tr><td class="h">482</td><td colspan="7"></td></tr><tr><td class="h">483</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{rcptid} + 0 != 0;</td></tr>
<tr><td class="h">484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">485</td><td colspan="7"></td></tr><tr><td class="h">486 - 491</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;encode( $acid, $auth ) &gt;&gt;

Internal. Given an invite code id and a 13-digit auth code, returns a 20-digit
all-uppercase invite code.

=cut</pre></td></tr>
<tr><td class="h">492</td><td colspan="7"></td></tr><tr><td class="h">493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub encode {</td></tr>
<tr><td class="h">494</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L494">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $acid, $auth) = @_;</td></tr>
<tr><td class="h">495</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return uc( $auth ) . $class-&gt;acid_encode( $acid );</td></tr>
<tr><td class="h">496</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">497</td><td colspan="7"></td></tr><tr><td class="h">498 - 503</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;decode( $invite ) &gt;&gt;

Internal. Given an invite code, break it down into its component parts: an
invite code id and a 13-character auth code.

=cut</pre></td></tr>
<tr><td class="h">504</td><td colspan="7"></td></tr><tr><td class="h">505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub decode {</td></tr>
<tr><td class="h">506</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L506">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $code) = @_;</td></tr>
<tr><td class="h">507</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ( $class-&gt;acid_decode( substr( $code, AUTH_LEN, ACID_LEN ) ), uc( substr( $code, 0, AUTH_LEN ) ) );</td></tr>
<tr><td class="h">508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">509</td><td colspan="7"></td></tr><tr><td class="h">510 - 516</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;acid_encode( $num ) &gt;&gt;

Internal. Converts a 32-bit unsigned integer into a fixed-width string
representation in base DIGITS_LEN, based on an alphabet of letters and numbers
that are not easily mistaken for each other.

=cut</pre></td></tr>
<tr><td class="h">517</td><td colspan="7"></td></tr><tr><td class="h">518</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub acid_encode {</td></tr>
<tr><td class="h">519</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L519">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $num) = @_;</td></tr>
<tr><td class="h">520</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $acid = &quot;&quot;;</td></tr>
<tr><td class="h">521</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while ( $num ) {</td></tr>
<tr><td class="h">522</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dig = $num % DIGITS_LEN;</td></tr>
<tr><td class="h">523</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$acid = (DIGITS)[$dig] . $acid;</td></tr>
<tr><td class="h">524</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$num = ($num - $dig) / DIGITS_LEN;</td></tr>
<tr><td class="h">525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">526</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ( (DIGITS)[0] x ( ACID_LEN - length( $acid ) ) . $acid );</td></tr>
<tr><td class="h">527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">528</td><td colspan="7"></td></tr><tr><td class="h">529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">my %val;</td></tr>
<tr><td class="h">530</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">@val{(DIGITS)} = 0..DIGITS_LEN;</td></tr>
<tr><td class="h">531</td><td colspan="7"></td></tr><tr><td class="h">532 - 537</td><td colspan="6"></td><td class="s"><pre>=head2 C&lt;&lt; $class-&gt;acid_decode( $acid ) &gt;&gt;

Internal. Given an acid encoding from C&lt;DW::InviteCodes::acid_encode&gt;, returns
the original decimal number.

=cut</pre></td></tr>
<tr><td class="h">538</td><td colspan="7"></td></tr><tr><td class="h">539</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub acid_decode {</td></tr>
<tr><td class="h">540</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-InviteCodes-pm--subroutine.html#L540">0</a></div></td><td><div class="c3">1</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $acid) = @_;</td></tr>
<tr><td class="h">541</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$acid = uc( $acid );</td></tr>
<tr><td class="h">542</td><td colspan="7"></td></tr><tr><td class="h">543</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $num = 0;</td></tr>
<tr><td class="h">544</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $place = 0;</td></tr>
<tr><td class="h">545</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $d ( split //, $acid ) {</td></tr>
<tr><td class="h">546</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-InviteCodes-pm--branch.html#L546">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless exists $val{$d};</td></tr>
<tr><td class="h">547</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$num = $num * DIGITS_LEN + $val{$d};</td></tr>
<tr><td class="h">548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">549</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $num;</td></tr>
<tr><td class="h">550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">551</td><td colspan="7"></td></tr><tr><td class="h">552 - 570</td><td colspan="6"></td><td class="s"><pre>=head1 BUGS

Bound to be some.

=head1 AUTHORS

Afuna &lt;coder.dw@afunamatata.com&gt;

Pau Amma &lt;pauamma@cpan.org&gt;

=head1 COPYRIGHT AND LICENSE

Copyright (c) 2009 by Dreamwidth Studios, LLC.

This program is free software; you may redistribute it and/or modify it under
the same terms as Perl itself. For a copy of the license, please reference
&#39;perldoc perlartistic&#39; or &#39;perldoc perlgpl&#39;.

=cut</pre></td></tr>
<tr><td class="h">571</td><td colspan="7"></td></tr><tr><td class="h">572</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
