<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/ljfeed.pl</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/ljfeed.pl</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">2.8%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#!/usr/bin/perl</td></tr>
<tr><td class="h">2</td><td colspan="7"></td></tr><tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ::Feed;</td></tr>
<tr><td class="h">4</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljfeed-pl--subroutine.html#L4">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">5</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljfeed-pl--subroutine.html#L5">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">no warnings &#39;uninitialized&#39;;</td></tr>
<tr><td class="h">6</td><td colspan="7"></td></tr><tr><td class="h">7</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljfeed-pl--subroutine.html#L7">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Entry;</td></tr>
<tr><td class="h">8</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljfeed-pl--subroutine.html#L8">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use XML::Atom::Person;</td></tr>
<tr><td class="h">9</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljfeed-pl--subroutine.html#L9">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use XML::Atom::Feed;</td></tr>
<tr><td class="h">10</td><td colspan="7"></td></tr><tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">my %feedtypes = (</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;rss         =&gt; { handler =&gt; \&amp;create_view_rss,  need_items =&gt; 1 },</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;atom        =&gt; { handler =&gt; \&amp;create_view_atom, need_items =&gt; 1 },</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foaf        =&gt; { handler =&gt; \&amp;create_view_foaf,                 },</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;yadis       =&gt; { handler =&gt; \&amp;create_view_yadis,                },</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;userpics    =&gt; { handler =&gt; \&amp;create_view_userpics,             },</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;comments    =&gt; { handler =&gt; \&amp;create_view_comments,             },</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">);</td></tr>
<tr><td class="h">19</td><td colspan="7"></td></tr><tr><td class="h">20</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub make_feed</td></tr>
<tr><td class="h">21</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">22</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L22">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($r, $u, $remote, $opts) = @_;</td></tr>
<tr><td class="h">23</td><td colspan="7"></td></tr><tr><td class="h">24</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{pathextra} =~ s!^/(\w+)!!;</td></tr>
<tr><td class="h">25</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $feedtype = $1;</td></tr>
<tr><td class="h">26</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $viewfunc = $feedtypes{$feedtype};</td></tr>
<tr><td class="h">27</td><td colspan="7"></td></tr><tr><td class="h">28</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L28">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($viewfunc) {</td></tr>
<tr><td class="h">29</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;handler_return&#39;} = 404;</td></tr>
<tr><td class="h">30</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">31</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">32</td><td colspan="7"></td></tr><tr><td class="h">33</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L33">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;note(&#39;codepath&#39; =&gt; &quot;feed.$feedtype&quot;) if $r;</td></tr>
<tr><td class="h">34</td><td colspan="7"></td></tr><tr><td class="h">35</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">36</td><td colspan="7"></td></tr><tr><td class="h">37</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = $u-&gt;{&#39;user&#39;};</td></tr>
<tr><td class="h">38</td><td colspan="7"></td></tr><tr><td class="h">39</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($u, qw/ journaltitle journalsubtitle opt_synlevel /);</td></tr>
<tr><td class="h">40</td><td colspan="7"></td></tr><tr><td class="h">41</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$u-&gt;{$_})</td></tr>
<tr><td class="h">42</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (&quot;name&quot;, &quot;url&quot;, &quot;urlname&quot;);</td></tr>
<tr><td class="h">43</td><td colspan="7"></td></tr><tr><td class="h">44</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# opt_synlevel will default to &#39;cut&#39;</td></tr>
<tr><td class="h">45</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L45">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{&#39;opt_synlevel&#39;} = &#39;cut&#39;</td></tr>
<tr><td class="h">46</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $u-&gt;{&#39;opt_synlevel&#39;} =~ /^(?:full|cut|summary|title)$/;</td></tr>
<tr><td class="h">47</td><td colspan="7"></td></tr><tr><td class="h">48</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# some data used throughout the channel</td></tr>
<tr><td class="h">49</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L49">0</a></div><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L49">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalinfo = {</td></tr>
<tr><td class="h">50</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u         =&gt; $u,</td></tr>
<tr><td class="h">51</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;link      =&gt; LJ::journal_base($u) . &quot;/&quot;,</td></tr>
<tr><td class="h">52</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title     =&gt; $u-&gt;{journaltitle} || $u-&gt;{name} || $u-&gt;{user},</td></tr>
<tr><td class="h">53</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subtitle  =&gt; $u-&gt;{journalsubtitle} || $u-&gt;{name},</td></tr>
<tr><td class="h">54</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builddate =&gt; LJ::time_to_http(time()),</td></tr>
<tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">56</td><td colspan="7"></td></tr><tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we do not want items for this view, just call out</td></tr>
<tr><td class="h">58</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;contenttype&#39;} = &#39;text/xml; charset=&#39;.$opts-&gt;{&#39;saycharset&#39;};</td></tr>
<tr><td class="h">59</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L59">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $viewfunc-&gt;{handler}-&gt;($journalinfo, $u, $opts)</td></tr>
<tr><td class="h">60</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($viewfunc-&gt;{need_items});</td></tr>
<tr><td class="h">61</td><td colspan="7"></td></tr><tr><td class="h">62</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# for syndicated accounts, redirect to the syndication URL</td></tr>
<tr><td class="h">63</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# However, we only want to do this if the data we&#39;re returning</td></tr>
<tr><td class="h">64</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# is similar. (Not FOAF, for example)</td></tr>
<tr><td class="h">65</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L65">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;is_syndicated ) {</td></tr>
<tr><td class="h">66</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $synurl = $dbr-&gt;selectrow_array(&quot;SELECT synurl FROM syndicated WHERE userid=$u-&gt;{&#39;userid&#39;}&quot;);</td></tr>
<tr><td class="h">67</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L67">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($synurl) {</td></tr>
<tr><td class="h">68</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;No syndication URL available.&#39;;</td></tr>
<tr><td class="h">69</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">70</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;redir&#39;} = $synurl;</td></tr>
<tr><td class="h">71</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">72</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">73</td><td colspan="7"></td></tr><tr><td class="h">74</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %FORM = $r-&gt;query_string;</td></tr>
<tr><td class="h">75</td><td colspan="7"></td></tr><tr><td class="h">76</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## load the itemids</td></tr>
<tr><td class="h">77</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my (@itemids, @items);</td></tr>
<tr><td class="h">78</td><td colspan="7"></td></tr><tr><td class="h">79</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# for consistency, we call ditemids &quot;itemid&quot; in user-facing settings</td></tr>
<tr><td class="h">80</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $FORM{itemid}+0;</td></tr>
<tr><td class="h">81</td><td colspan="7"></td></tr><tr><td class="h">82</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L82">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($ditemid) {</td></tr>
<tr><td class="h">83</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new($u, ditemid =&gt; $ditemid);</td></tr>
<tr><td class="h">84</td><td colspan="7"></td></tr><tr><td class="h">85</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L85">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L85">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! $entry || ! $entry-&gt;valid || ! $entry-&gt;visible_to($remote)) {</td></tr>
<tr><td class="h">86</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;handler_return&#39;} = 404;</td></tr>
<tr><td class="h">87</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">88</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">89</td><td colspan="7"></td></tr><tr><td class="h">90</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@itemids = $entry-&gt;jitemid;</td></tr>
<tr><td class="h">91</td><td colspan="7"></td></tr><tr><td class="h">92</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @items, {</td></tr>
<tr><td class="h">93</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itemid =&gt; $entry-&gt;jitemid,</td></tr>
<tr><td class="h">94</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anum =&gt; $entry-&gt;anum,</td></tr>
<tr><td class="h">95</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;posterid =&gt; $entry-&gt;poster-&gt;id,</td></tr>
<tr><td class="h">96</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;security =&gt; $entry-&gt;security,</td></tr>
<tr><td class="h">97</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alldatepart =&gt; LJ::alldatepart_s2($entry-&gt;eventtime_mysql),</td></tr>
<tr><td class="h">98</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">99</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">100</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@items = $u-&gt;recent_items(</td></tr>
<tr><td class="h">101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clusterid =&gt; $u-&gt;{clusterid},</td></tr>
<tr><td class="h">102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clustersource =&gt; &#39;slave&#39;,</td></tr>
<tr><td class="h">103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote =&gt; $remote,</td></tr>
<tr><td class="h">104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itemshow =&gt; 25,</td></tr>
<tr><td class="h">105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order =&gt; &#39;logtime&#39;,</td></tr>
<tr><td class="h">106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tagids =&gt; $opts-&gt;{tagids},</td></tr>
<tr><td class="h">107</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itemids =&gt; \@itemids,</td></tr>
<tr><td class="h">108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;friendsview =&gt; 1,           # this returns rlogtimes</td></tr>
<tr><td class="h">109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dateformat =&gt; &#39;S2&#39;,         # S2 format time format is easier</td></tr>
<tr><td class="h">110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">112</td><td colspan="7"></td></tr><tr><td class="h">113</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;contenttype&#39;} = &#39;text/xml; charset=&#39;.$opts-&gt;{&#39;saycharset&#39;};</td></tr>
<tr><td class="h">114</td><td colspan="7"></td></tr><tr><td class="h">115</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### load the log properties</td></tr>
<tr><td class="h">116</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %logprops = ();</td></tr>
<tr><td class="h">117</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $logtext;</td></tr>
<tr><td class="h">118</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $logdb = LJ::get_cluster_reader($u);</td></tr>
<tr><td class="h">119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_log_props2($logdb, $u-&gt;{&#39;userid&#39;}, \@itemids, \%logprops);</td></tr>
<tr><td class="h">120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$logtext = LJ::get_logtext2($u, @itemids);</td></tr>
<tr><td class="h">121</td><td colspan="7"></td></tr><tr><td class="h">122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set last-modified header, then let apache figure out</td></tr>
<tr><td class="h">123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# whether we actually need to send the feed.</td></tr>
<tr><td class="h">124</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lastmod = 0;</td></tr>
<tr><td class="h">125</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $item (@items) {</td></tr>
<tr><td class="h">126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# revtime of the item.</td></tr>
<tr><td class="h">127</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $revtime = $logprops{$item-&gt;{itemid}}-&gt;{revtime};</td></tr>
<tr><td class="h">128</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L128">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lastmod = $revtime if $revtime &gt; $lastmod;</td></tr>
<tr><td class="h">129</td><td colspan="7"></td></tr><tr><td class="h">130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if we don&#39;t have a revtime, use the logtime of the item.</td></tr>
<tr><td class="h">131</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L131">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($revtime) {</td></tr>
<tr><td class="h">132</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $itime = $LJ::EndOfTime - $item-&gt;{rlogtime};</td></tr>
<tr><td class="h">133</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L133">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lastmod = $itime if $itime &gt; $lastmod;</td></tr>
<tr><td class="h">134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">135</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">136</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L136">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;set_last_modified($lastmod) if $lastmod;</td></tr>
<tr><td class="h">137</td><td colspan="7"></td></tr><tr><td class="h">138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# use this $lastmod as the feed&#39;s last-modified time</td></tr>
<tr><td class="h">139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we would&#39;ve liked to use something like</td></tr>
<tr><td class="h">140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# LJ::get_timeupdate_multi instead, but that only changes</td></tr>
<tr><td class="h">141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# with new updates and doesn&#39;t change on edits.</td></tr>
<tr><td class="h">142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalinfo-&gt;{&#39;modtime&#39;} = $lastmod;</td></tr>
<tr><td class="h">143</td><td colspan="7"></td></tr><tr><td class="h">144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# regarding $r-&gt;set_etag:</td></tr>
<tr><td class="h">145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# http://perl.apache.org/docs/general/correct_headers/correct_headers.html#Entity_Tags</td></tr>
<tr><td class="h">146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# It is strongly recommended that you do not use this method unless you</td></tr>
<tr><td class="h">147</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# know what you are doing. set_etag() is expecting to be used in</td></tr>
<tr><td class="h">148</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# conjunction with a static request for a file on disk that has been</td></tr>
<tr><td class="h">149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# stat()ed in the course of the current request. It is inappropriate and</td></tr>
<tr><td class="h">150</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# &quot;dangerous&quot; to use it for dynamic content.</td></tr>
<tr><td class="h">151</td><td colspan="7"></td></tr><tr><td class="h">152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# verify that our headers are good; especially check to see if we should</td></tr>
<tr><td class="h">153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return a 304 (Not Modified) response.</td></tr>
<tr><td class="h">154</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L154">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ((my $status = $r-&gt;meets_conditions) != $r-&gt;OK) {</td></tr>
<tr><td class="h">155</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{handler_return} = $status;</td></tr>
<tr><td class="h">156</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">158</td><td colspan="7"></td></tr><tr><td class="h">159</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L159">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L159">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalinfo-&gt;{email} = $u-&gt;email_for_feeds if $u &amp;&amp; $u-&gt;email_for_feeds;</td></tr>
<tr><td class="h">160</td><td colspan="7"></td></tr><tr><td class="h">161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load tags now that we have no chance of jumping out early</td></tr>
<tr><td class="h">162</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $logtags = LJ::Tags::get_logtags($u, \@itemids);</td></tr>
<tr><td class="h">163</td><td colspan="7"></td></tr><tr><td class="h">164</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %posteru = ();  # map posterids to u objects</td></tr>
<tr><td class="h">165</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userids_multiple([map { $_-&gt;{&#39;posterid&#39;}, \$posteru{$_-&gt;{&#39;posterid&#39;}} } @items], [$u]);</td></tr>
<tr><td class="h">166</td><td colspan="7"></td></tr><tr><td class="h">167</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @cleanitems;</td></tr>
<tr><td class="h">168</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @entries;     # LJ::Entry objects</td></tr>
<tr><td class="h">169</td><td colspan="7"></td></tr><tr><td class="h">170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;ENTRY:</td></tr>
<tr><td class="h">171</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $it (@items)</td></tr>
<tr><td class="h">172</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">173</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# load required data</td></tr>
<tr><td class="h">174</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $itemid  = $it-&gt;{&#39;itemid&#39;};</td></tr>
<tr><td class="h">175</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $itemid*256 + $it-&gt;{&#39;anum&#39;};</td></tr>
<tr><td class="h">176</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry_obj = LJ::Entry-&gt;new($u, ditemid =&gt; $ditemid);</td></tr>
<tr><td class="h">177</td><td colspan="7"></td></tr><tr><td class="h">178</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L178">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L178">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next ENTRY if $posteru{$it-&gt;{&#39;posterid&#39;}} &amp;&amp; $posteru{$it-&gt;{&#39;posterid&#39;}}-&gt;is_suspended;</td></tr>
<tr><td class="h">179</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L179">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L179">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next ENTRY if $entry_obj &amp;&amp; $entry_obj-&gt;is_suspended_for($remote);</td></tr>
<tr><td class="h">180</td><td colspan="7"></td></tr><tr><td class="h">181</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L181">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L181">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $logprops{$itemid}-&gt;{&#39;unknown8bit&#39;}) {</td></tr>
<tr><td class="h">182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::item_toutf8($u, \$logtext-&gt;{$itemid}-&gt;[0],</td></tr>
<tr><td class="h">183</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\$logtext-&gt;{$itemid}-&gt;[1], $logprops{$itemid});</td></tr>
<tr><td class="h">184</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">185</td><td colspan="7"></td></tr><tr><td class="h">186</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# see if we have a subject and clean it</td></tr>
<tr><td class="h">187</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $subject = $logtext-&gt;{$itemid}-&gt;[0];</td></tr>
<tr><td class="h">188</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L188">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($subject) {</td></tr>
<tr><td class="h">189</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$subject =~ s/[\r\n]/ /g;</td></tr>
<tr><td class="h">190</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_subject_all(\$subject);</td></tr>
<tr><td class="h">191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">192</td><td colspan="7"></td></tr><tr><td class="h">193</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# an HTML link to the entry. used if we truncate or summarize</td></tr>
<tr><td class="h">194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $readmore = &quot;&lt;b&gt;(&lt;a href=\&quot;$journalinfo-&gt;{link}$ditemid.html\&quot;&gt;Read more ...&lt;/a&gt;)&lt;/b&gt;&quot;;</td></tr>
<tr><td class="h">195</td><td colspan="7"></td></tr><tr><td class="h">196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# empty string so we don&#39;t waste time cleaning an entry that won&#39;t be used</td></tr>
<tr><td class="h">197</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L197">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $event = $u-&gt;{&#39;opt_synlevel&#39;} eq &#39;title&#39; ? &#39;&#39; : $logtext-&gt;{$itemid}-&gt;[1];</td></tr>
<tr><td class="h">198</td><td colspan="7"></td></tr><tr><td class="h">199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# clean the event, if non-empty</td></tr>
<tr><td class="h">200</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ppid = 0;</td></tr>
<tr><td class="h">201</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L201">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($event) {</td></tr>
<tr><td class="h">202</td><td colspan="7"></td></tr><tr><td class="h">203</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# users without &#39;full_rss&#39; get their logtext bodies truncated</td></tr>
<tr><td class="h">204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# do this now so that the html cleaner will hopefully fix html we break</td></tr>
<tr><td class="h">205</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L205">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless (LJ::get_cap($u, &#39;full_rss&#39;)) {</td></tr>
<tr><td class="h">206</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $trunc = LJ::text_trim($event, 0, 80);</td></tr>
<tr><td class="h">207</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L207">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event = &quot;$trunc $readmore&quot; if $trunc ne $event;</td></tr>
<tr><td class="h">208</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">209</td><td colspan="7"></td></tr><tr><td class="h">210</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L210">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_event(\$event,</td></tr>
<tr><td class="h">211</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">212</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wordlength =&gt; 0,</td></tr>
<tr><td class="h">213</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preformatted =&gt; $logprops{$itemid}-&gt;{opt_preformatted},</td></tr>
<tr><td class="h">214</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cuturl =&gt; $u-&gt;{opt_synlevel} eq &#39;cut&#39; ? &quot;$journalinfo-&gt;{link}$ditemid.html&quot; : &quot;&quot;,</td></tr>
<tr><td class="h">215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_external_site =&gt; 1,</td></tr>
<tr><td class="h">216</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# do this after clean so we don&#39;t have to about know whether or not</td></tr>
<tr><td class="h">218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the event is preformatted</td></tr>
<tr><td class="h">219</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L219">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;opt_synlevel&#39;} eq &#39;summary&#39;) {</td></tr>
<tr><td class="h">220</td><td colspan="7"></td></tr><tr><td class="h">221</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# assume the first paragraph is terminated by two &lt;br&gt; or a &lt;/p&gt;</td></tr>
<tr><td class="h">222</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# valid XML tags should be handled, even though it makes an uglier regex</td></tr>
<tr><td class="h">223</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L223">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($event =~ m!((&lt;br\s*/?\&gt;(&lt;/br\s*&gt;)?\s*){2})|(&lt;/p\s*&gt;)!i) {</td></tr>
<tr><td class="h">224</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# everything before the matched tag + the tag itself</td></tr>
<tr><td class="h">225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# + a link to read more</td></tr>
<tr><td class="h">226</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event = $` . $&amp; . $readmore;</td></tr>
<tr><td class="h">227</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">228</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">229</td><td colspan="7"></td></tr><tr><td class="h">230</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while ($event =~ /&lt;(?:lj-)?poll-(\d+)&gt;/g) {</td></tr>
<tr><td class="h">231</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pollid = $1;</td></tr>
<tr><td class="h">232</td><td colspan="7"></td></tr><tr><td class="h">233</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $name = LJ::Poll-&gt;new($pollid)-&gt;name;</td></tr>
<tr><td class="h">234</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L234">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($name) {</td></tr>
<tr><td class="h">235</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Poll-&gt;clean_poll(\$name);</td></tr>
<tr><td class="h">236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">237</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name = &quot;#$pollid&quot;;</td></tr>
<tr><td class="h">238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">239</td><td colspan="7"></td></tr><tr><td class="h">240</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event =~ s!&lt;(lj-)?poll-$pollid&gt;!&lt;div&gt;&lt;a href=&quot;$LJ::SITEROOT/poll/?id=$pollid&quot;&gt;View Poll: $name&lt;/a&gt;&lt;/div&gt;!g;</td></tr>
<tr><td class="h">241</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">242</td><td colspan="7"></td></tr><tr><td class="h">243</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %args = $r-&gt;query_string;</td></tr>
<tr><td class="h">244</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L244">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L244">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::EmbedModule-&gt;expand_entry($u, \$event, expand_full =&gt; 1)</td></tr>
<tr><td class="h">245</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if %args &amp;&amp; $args{&#39;unfold_embed&#39;};</td></tr>
<tr><td class="h">246</td><td colspan="7"></td></tr><tr><td class="h">247</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L247">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ppid = $1</td></tr>
<tr><td class="h">248</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $event =~ m!&lt;lj-phonepost journalid=[\&#39;\&quot;]\d+[\&#39;\&quot;] dpid=[\&#39;\&quot;](\d+)[\&#39;\&quot;]( /)?&gt;!;</td></tr>
<tr><td class="h">249</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">250</td><td colspan="7"></td></tr><tr><td class="h">251</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mood;</td></tr>
<tr><td class="h">252</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L252">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L252">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($logprops{$itemid}-&gt;{&#39;current_mood&#39;}) {</td></tr>
<tr><td class="h">253</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mood = $logprops{$itemid}-&gt;{&#39;current_mood&#39;};</td></tr>
<tr><td class="h">254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($logprops{$itemid}-&gt;{&#39;current_moodid&#39;}) {</td></tr>
<tr><td class="h">255</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mood = LJ::mood_name($logprops{$itemid}-&gt;{&#39;current_moodid&#39;}+0);</td></tr>
<tr><td class="h">256</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">257</td><td colspan="7"></td></tr><tr><td class="h">258</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $createtime = $LJ::EndOfTime - $it-&gt;{rlogtime};</td></tr>
<tr><td class="h">259</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L259">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cleanitem = {</td></tr>
<tr><td class="h">260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itemid     =&gt; $itemid,</td></tr>
<tr><td class="h">261</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ditemid    =&gt; $ditemid,</td></tr>
<tr><td class="h">262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject    =&gt; $subject,</td></tr>
<tr><td class="h">263</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event      =&gt; $event,</td></tr>
<tr><td class="h">264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;createtime =&gt; $createtime,</td></tr>
<tr><td class="h">265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eventtime  =&gt; $it-&gt;{alldatepart},  # ugly: this is of a different format than the other two times.</td></tr>
<tr><td class="h">266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modtime    =&gt; $logprops{$itemid}-&gt;{revtime} || $createtime,</td></tr>
<tr><td class="h">267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comments   =&gt; ($logprops{$itemid}-&gt;{&#39;opt_nocomments&#39;} == 0),</td></tr>
<tr><td class="h">268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;music      =&gt; $logprops{$itemid}-&gt;{&#39;current_music&#39;},</td></tr>
<tr><td class="h">269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mood       =&gt; $mood,</td></tr>
<tr><td class="h">270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ppid       =&gt; $ppid,</td></tr>
<tr><td class="h">271</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L271">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tags       =&gt; [ values %{$logtags-&gt;{$itemid} || {}} ],</td></tr>
<tr><td class="h">272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;security   =&gt; $it-&gt;{security},</td></tr>
<tr><td class="h">273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;posterid   =&gt; $it-&gt;{posterid},</td></tr>
<tr><td class="h">274</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replycount =&gt; $logprops{$itemid}-&gt;{&#39;replycount&#39;},</td></tr>
<tr><td class="h">275</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">276</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @cleanitems, $cleanitem;</td></tr>
<tr><td class="h">277</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @entries,    $entry_obj;</td></tr>
<tr><td class="h">278</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">279</td><td colspan="7"></td></tr><tr><td class="h">280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# fix up the build date to use entry-time</td></tr>
<tr><td class="h">281</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalinfo-&gt;{&#39;builddate&#39;} = LJ::time_to_http($LJ::EndOfTime - $items[0]-&gt;{&#39;rlogtime&#39;}),</td></tr>
<tr><td class="h">282</td><td colspan="7"></td></tr><tr><td class="h">283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $viewfunc-&gt;{handler}-&gt;($journalinfo, $u, $opts, \@cleanitems, \@entries);</td></tr>
<tr><td class="h">284</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">285</td><td colspan="7"></td></tr><tr><td class="h">286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># the creator for the RSS XML syndication view</td></tr>
<tr><td class="h">287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_view_rss</td></tr>
<tr><td class="h">288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">289</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L289">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalinfo, $u, $opts, $cleanitems) = @_;</td></tr>
<tr><td class="h">290</td><td colspan="7"></td></tr><tr><td class="h">291</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret;</td></tr>
<tr><td class="h">292</td><td colspan="7"></td></tr><tr><td class="h">293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# header</td></tr>
<tr><td class="h">294</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;?xml version=&#39;1.0&#39; encoding=&#39;$opts-&gt;{&#39;saycharset&#39;}&#39; ?&gt;\n&quot;;</td></tr>
<tr><td class="h">295</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::run_hook(&quot;bot_director&quot;, &quot;&lt;!-- &quot;, &quot; --&gt;&quot;) . &quot;\n&quot;;</td></tr>
<tr><td class="h">296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;rss version=&#39;2.0&#39; xmlns:lj=&#39;http://www.livejournal.org/rss/lj/1.0/&#39; &quot; .</td></tr>
<tr><td class="h">297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;xmlns:atom10=&#39;http://www.w3.org/2005/Atom&#39;&gt;\n&quot;;</td></tr>
<tr><td class="h">298</td><td colspan="7"></td></tr><tr><td class="h">299</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# channel attributes</td></tr>
<tr><td class="h">300</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;channel&gt;\n&quot;;</td></tr>
<tr><td class="h">301</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;title&gt;&quot; . LJ::exml($journalinfo-&gt;{title}) . &quot;&lt;/title&gt;\n&quot;;</td></tr>
<tr><td class="h">302</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;link&gt;$journalinfo-&gt;{link}&lt;/link&gt;\n&quot;;</td></tr>
<tr><td class="h">303</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;description&gt;&quot; . LJ::exml(&quot;$journalinfo-&gt;{title} - $LJ::SITENAME&quot;) . &quot;&lt;/description&gt;\n&quot;;</td></tr>
<tr><td class="h">304</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L304">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;managingEditor&gt;&quot; . LJ::exml($journalinfo-&gt;{email}) . &quot;&lt;/managingEditor&gt;\n&quot; if $journalinfo-&gt;{email};</td></tr>
<tr><td class="h">305</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lastBuildDate&gt;$journalinfo-&gt;{builddate}&lt;/lastBuildDate&gt;\n&quot;;</td></tr>
<tr><td class="h">306</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;generator&gt;LiveJournal / $LJ::SITENAME&lt;/generator&gt;\n&quot;;</td></tr>
<tr><td class="h">307</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lj:journal&gt;&quot; . $u-&gt;user . &quot;&lt;/lj:journal&gt;\n&quot;;</td></tr>
<tr><td class="h">308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lj:journaltype&gt;&quot; . $u-&gt;journaltype_readable . &quot;&lt;/lj:journaltype&gt;\n&quot;;</td></tr>
<tr><td class="h">309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO: add &#39;language&#39; field when user.lang has more useful information</td></tr>
<tr><td class="h">310</td><td colspan="7"></td></tr><tr><td class="h">311</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L311">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( LJ::is_enabled( &#39;hubbub&#39; ) ) {</td></tr>
<tr><td class="h">312</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;atom10:link rel=&#39;self&#39; href=&#39;&quot; . $u-&gt;journal_base . &quot;/data/rss&#39; /&gt;\n&quot;;</td></tr>
<tr><td class="h">313</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $hub (@LJ::HUBBUB_HUBS) {</td></tr>
<tr><td class="h">314</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;atom10:link rel=&#39;hub&#39; href=&#39;&quot; . LJ::exml($hub) . &quot;&#39; /&gt;\n&quot;;</td></tr>
<tr><td class="h">315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">316</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">317</td><td colspan="7"></td></tr><tr><td class="h">318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### image block, returns info for their current userpic</td></tr>
<tr><td class="h">319</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L319">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;defaultpicid&#39;}) {</td></tr>
<tr><td class="h">320</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pic = {};</td></tr>
<tr><td class="h">321</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userpics($pic, [ $u, $u-&gt;{&#39;defaultpicid&#39;} ]);</td></tr>
<tr><td class="h">322</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pic = $pic-&gt;{$u-&gt;{&#39;defaultpicid&#39;}}; # flatten</td></tr>
<tr><td class="h">323</td><td colspan="7"></td></tr><tr><td class="h">324</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;image&gt;\n&quot;;</td></tr>
<tr><td class="h">325</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;url&gt;$LJ::USERPIC_ROOT/$u-&gt;{&#39;defaultpicid&#39;}/$u-&gt;{&#39;userid&#39;}&lt;/url&gt;\n&quot;;</td></tr>
<tr><td class="h">326</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;title&gt;&quot; . LJ::exml($journalinfo-&gt;{title}) . &quot;&lt;/title&gt;\n&quot;;</td></tr>
<tr><td class="h">327</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;link&gt;$journalinfo-&gt;{link}&lt;/link&gt;\n&quot;;</td></tr>
<tr><td class="h">328</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;width&gt;$pic-&gt;{&#39;width&#39;}&lt;/width&gt;\n&quot;;</td></tr>
<tr><td class="h">329</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;height&gt;$pic-&gt;{&#39;height&#39;}&lt;/height&gt;\n&quot;;</td></tr>
<tr><td class="h">330</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;/image&gt;\n\n&quot;;</td></tr>
<tr><td class="h">331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">332</td><td colspan="7"></td></tr><tr><td class="h">333</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %posteru = ();  # map posterids to u objects</td></tr>
<tr><td class="h">334</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userids_multiple([map { $_-&gt;{&#39;posterid&#39;}, \$posteru{$_-&gt;{&#39;posterid&#39;}} } @$cleanitems], [$u]);</td></tr>
<tr><td class="h">335</td><td colspan="7"></td></tr><tr><td class="h">336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# output individual item blocks</td></tr>
<tr><td class="h">337</td><td colspan="7"></td></tr><tr><td class="h">338</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $it (@$cleanitems)</td></tr>
<tr><td class="h">339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">340</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $itemid = $it-&gt;{itemid};</td></tr>
<tr><td class="h">341</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $it-&gt;{ditemid};</td></tr>
<tr><td class="h">342</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $poster = $posteru{$it-&gt;{posterid}};</td></tr>
<tr><td class="h">343</td><td colspan="7"></td></tr><tr><td class="h">344</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;item&gt;\n&quot;;</td></tr>
<tr><td class="h">345</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;guid isPermaLink=&#39;true&#39;&gt;$journalinfo-&gt;{link}$ditemid.html&lt;/guid&gt;\n&quot;;</td></tr>
<tr><td class="h">346</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;pubDate&gt;&quot; . LJ::time_to_http($it-&gt;{createtime}) . &quot;&lt;/pubDate&gt;\n&quot;;</td></tr>
<tr><td class="h">347</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L347">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;title&gt;&quot; . LJ::exml($it-&gt;{subject}) . &quot;&lt;/title&gt;\n&quot; if $it-&gt;{subject};</td></tr>
<tr><td class="h">348</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L348">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;author&gt;&quot; . LJ::exml($journalinfo-&gt;{email}) . &quot;&lt;/author&gt;&quot; if $journalinfo-&gt;{email};</td></tr>
<tr><td class="h">349</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;link&gt;$journalinfo-&gt;{link}$ditemid.html&lt;/link&gt;\n&quot;;</td></tr>
<tr><td class="h">350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# omit the description tag if we&#39;re only syndicating titles</td></tr>
<tr><td class="h">351</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#   note: the $event was also emptied earlier, in make_feed</td></tr>
<tr><td class="h">352</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L352">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($u-&gt;{&#39;opt_synlevel&#39;} eq &#39;title&#39;) {</td></tr>
<tr><td class="h">353</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;description&gt;&quot; . LJ::exml($it-&gt;{event}) . &quot;&lt;/description&gt;\n&quot;;</td></tr>
<tr><td class="h">354</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">355</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L355">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($it-&gt;{comments}) {</td></tr>
<tr><td class="h">356</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;comments&gt;$journalinfo-&gt;{link}$ditemid.html&lt;/comments&gt;\n&quot;;</td></tr>
<tr><td class="h">357</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">358</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L358">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;category&gt;$_&lt;/category&gt;\n&quot; foreach map { LJ::exml($_) } @{$it-&gt;{tags} || []};</td></tr>
<tr><td class="h">359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# support &#39;podcasting&#39; enclosures</td></tr>
<tr><td class="h">360</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L360">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::run_hook( &quot;pp_rss_enclosure&quot;,</td></tr>
<tr><td class="h">361</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ userid =&gt; $u-&gt;{userid}, ppid =&gt; $it-&gt;{ppid} }) if $it-&gt;{ppid};</td></tr>
<tr><td class="h">362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# TODO: add author field with posterid&#39;s email address, respect communities</td></tr>
<tr><td class="h">363</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L363">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lj:music&gt;&quot; . LJ::exml($it-&gt;{music}) . &quot;&lt;/lj:music&gt;\n&quot; if $it-&gt;{music};</td></tr>
<tr><td class="h">364</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L364">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lj:mood&gt;&quot; . LJ::exml($it-&gt;{mood}) . &quot;&lt;/lj:mood&gt;\n&quot; if $it-&gt;{mood};</td></tr>
<tr><td class="h">365</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L365">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lj:security&gt;&quot; . LJ::exml($it-&gt;{security}) . &quot;&lt;/lj:security&gt;\n&quot; if $it-&gt;{security};</td></tr>
<tr><td class="h">366</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L366">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lj:poster&gt;&quot; . LJ::exml($poster-&gt;user) . &quot;&lt;/lj:poster&gt;\n&quot; unless LJ::u_equals($u, $poster);</td></tr>
<tr><td class="h">367</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lj:reply-count&gt;$it-&gt;{replycount}&lt;/lj:reply-count&gt;\n&quot;;</td></tr>
<tr><td class="h">368</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/item&gt;\n&quot;;</td></tr>
<tr><td class="h">369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">370</td><td colspan="7"></td></tr><tr><td class="h">371</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/channel&gt;\n&quot;;</td></tr>
<tr><td class="h">372</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/rss&gt;\n&quot;;</td></tr>
<tr><td class="h">373</td><td colspan="7"></td></tr><tr><td class="h">374</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">375</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">376</td><td colspan="7"></td></tr><tr><td class="h">377</td><td colspan="7"></td></tr><tr><td class="h">378</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># the creator for the Atom view</td></tr>
<tr><td class="h">379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># keys of $opts:</td></tr>
<tr><td class="h">380</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># single_entry - only output an &lt;entry&gt;..&lt;/entry&gt; block. off by default</td></tr>
<tr><td class="h">381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># apilinks - output AtomAPI links for posting a new entry or</td></tr>
<tr><td class="h">382</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            getting/editing/deleting an existing one. off by default</td></tr>
<tr><td class="h">383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># TODO: define and use an &#39;lj:&#39; namespace</td></tr>
<tr><td class="h">384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># TODO: Remove lines marked with &#39;COMPAT&#39; - they are only present</td></tr>
<tr><td class="h">386</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># to allow backwards compatibility with atom parsers that are pre 0.6-draft.</td></tr>
<tr><td class="h">387</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># We create tags valid for 1.1-draft, but we want to be nice during</td></tr>
<tr><td class="h">388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># atom&#39;s (and atom users) continuing transition.  1.0 parsers, according</td></tr>
<tr><td class="h">389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># to spec, should NOT barf on unknown tags.</td></tr>
<tr><td class="h">390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># * Where we can&#39;t be compatible, we use Atom 1.0. *</td></tr>
<tr><td class="h">391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># http://www.ietf.org/internet-drafts/draft-ietf-atompub-format-11.txt</td></tr>
<tr><td class="h">392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">393</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_view_atom</td></tr>
<tr><td class="h">394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">395</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L395">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $j, $u, $opts, $cleanitems, $entrylist ) = @_;</td></tr>
<tr><td class="h">396</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $feed, $xml, $ns );</td></tr>
<tr><td class="h">397</td><td colspan="7"></td></tr><tr><td class="h">398</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ns = &quot;http://www.w3.org/2005/Atom&quot;;</td></tr>
<tr><td class="h">399</td><td colspan="7"></td></tr><tr><td class="h">400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Strip namespace from child tags. Set default namespace, let</td></tr>
<tr><td class="h">401</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# child tags inherit from it.  So ghetto that we even have to do this</td></tr>
<tr><td class="h">402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# and LibXML can&#39;t on its own.</td></tr>
<tr><td class="h">403</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $normalize_ns = sub {</td></tr>
<tr><td class="h">404</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L404">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $str = shift;</td></tr>
<tr><td class="h">405</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str =~ s/(&lt;\w+)\s+xmlns=&quot;\Q$ns\E&quot;/$1/og;</td></tr>
<tr><td class="h">406</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str =~ s/&lt;feed\b/&lt;feed xmlns=&quot;$ns&quot; xmlns:lj=&quot;$LJ::SITEROOT&quot;/;</td></tr>
<tr><td class="h">407</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L407">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str =~ s/&lt;entry&gt;/&lt;entry xmlns=&quot;$ns&quot; xmlns:lj=&quot;$LJ::SITEROOT&quot;&gt;/ if $opts-&gt;{&#39;single_entry&#39;};</td></tr>
<tr><td class="h">408</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $str;</td></tr>
<tr><td class="h">409</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">410</td><td colspan="7"></td></tr><tr><td class="h">411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# AtomAPI interface path</td></tr>
<tr><td class="h">412</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L412">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $api = $opts-&gt;{&#39;apilinks&#39;} ? &quot;$LJ::SITEROOT/interface/atom&quot; :</td></tr>
<tr><td class="h">413</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;journal_base . &quot;/data/atom&quot;;</td></tr>
<tr><td class="h">414</td><td colspan="7"></td></tr><tr><td class="h">415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $make_link = sub {</td></tr>
<tr><td class="h">416</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L416">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $rel, $type, $href, $title ) = @_;</td></tr>
<tr><td class="h">417</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $link = XML::Atom::Link-&gt;new( Version =&gt; 1 );</td></tr>
<tr><td class="h">418</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;rel($rel);</td></tr>
<tr><td class="h">419</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L419">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;type($type) if $type;</td></tr>
<tr><td class="h">420</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;href($href);</td></tr>
<tr><td class="h">421</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L421">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;title( $title ) if $title;</td></tr>
<tr><td class="h">422</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $link;</td></tr>
<tr><td class="h">423</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">424</td><td colspan="7"></td></tr><tr><td class="h">425</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $author = XML::Atom::Person-&gt;new( Version =&gt; 1 );</td></tr>
<tr><td class="h">426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalu = $j-&gt;{u};</td></tr>
<tr><td class="h">427</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L427">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L427">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$author-&gt;email( $journalu-&gt;email_for_feeds ) if $journalu &amp;&amp; $journalu-&gt;email_for_feeds;</td></tr>
<tr><td class="h">428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$author-&gt;name(  $u-&gt;{&#39;name&#39;} );</td></tr>
<tr><td class="h">429</td><td colspan="7"></td></tr><tr><td class="h">430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# feed information</td></tr>
<tr><td class="h">431</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L431">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{&#39;single_entry&#39;}) {</td></tr>
<tr><td class="h">432</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed = XML::Atom::Feed-&gt;new( Version =&gt; 1 );</td></tr>
<tr><td class="h">433</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$xml  = $feed-&gt;{doc};</td></tr>
<tr><td class="h">434</td><td colspan="7"></td></tr><tr><td class="h">435</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L435">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;should_block_robots) {</td></tr>
<tr><td class="h">436</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$xml-&gt;getDocumentElement-&gt;setAttribute( &quot;xmlns:idx&quot;, &quot;urn:atom-extension:indexing&quot; );</td></tr>
<tr><td class="h">437</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$xml-&gt;getDocumentElement-&gt;setAttribute( &quot;idx:index&quot;, &quot;no&quot; );</td></tr>
<tr><td class="h">438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">439</td><td colspan="7"></td></tr><tr><td class="h">440</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$xml-&gt;insertBefore( $xml-&gt;createComment( LJ::run_hook(&quot;bot_director&quot;) ), $xml-&gt;documentElement());</td></tr>
<tr><td class="h">441</td><td colspan="7"></td></tr><tr><td class="h">442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# attributes</td></tr>
<tr><td class="h">443</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;id( &quot;urn:lj:$LJ::DOMAIN:atom1:$u-&gt;{user}&quot; );</td></tr>
<tr><td class="h">444</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L444">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;title( $j-&gt;{&#39;title&#39;} || $u-&gt;{user} );</td></tr>
<tr><td class="h">445</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L445">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $j-&gt;{&#39;subtitle&#39;} ) {</td></tr>
<tr><td class="h">446</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;subtitle( $j-&gt;{&#39;subtitle&#39;} );</td></tr>
<tr><td class="h">447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">448</td><td colspan="7"></td></tr><tr><td class="h">449</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;author( $author );</td></tr>
<tr><td class="h">450</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;add_link( $make_link-&gt;( &#39;alternate&#39;, &#39;text/html&#39;, $j-&gt;{&#39;link&#39;} ) );</td></tr>
<tr><td class="h">451</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L451">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;add_link(</td></tr>
<tr><td class="h">452</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_link-&gt;(</td></tr>
<tr><td class="h">453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;self&#39;,</td></tr>
<tr><td class="h">454</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;apilinks&#39;}</td></tr>
<tr><td class="h">455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? ( &#39;application/x.atom+xml&#39;, &quot;$api/feed&quot; )</td></tr>
<tr><td class="h">456</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: ( &#39;text/xml&#39;, $api )</td></tr>
<tr><td class="h">457</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">458</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">459</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;updated( LJ::time_to_w3c($j-&gt;{&#39;modtime&#39;}, &#39;Z&#39;) );</td></tr>
<tr><td class="h">460</td><td colspan="7"></td></tr><tr><td class="h">461</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ljinfo = $xml-&gt;createElement( &#39;lj:journal&#39; );</td></tr>
<tr><td class="h">462</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ljinfo-&gt;setAttribute( &#39;username&#39;, LJ::exml($u-&gt;user) );</td></tr>
<tr><td class="h">463</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ljinfo-&gt;setAttribute( &#39;type&#39;, LJ::exml($u-&gt;journaltype_readable) );</td></tr>
<tr><td class="h">464</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$xml-&gt;getDocumentElement-&gt;appendChild( $ljinfo );</td></tr>
<tr><td class="h">465</td><td colspan="7"></td></tr><tr><td class="h">466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# link to the AtomAPI version of this feed</td></tr>
<tr><td class="h">467</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L467">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;add_link(</td></tr>
<tr><td class="h">468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_link-&gt;(</td></tr>
<tr><td class="h">469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;service.feed&#39;,</td></tr>
<tr><td class="h">470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;application/x.atom+xml&#39;,</td></tr>
<tr><td class="h">471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $opts-&gt;{&#39;apilinks&#39;} ? &quot;$api/feed&quot; : $api ),</td></tr>
<tr><td class="h">472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$j-&gt;{&#39;title&#39;}</td></tr>
<tr><td class="h">473</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">475</td><td colspan="7"></td></tr><tr><td class="h">476</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L476">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;add_link(</td></tr>
<tr><td class="h">477</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_link-&gt;(</td></tr>
<tr><td class="h">478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;service.post&#39;,</td></tr>
<tr><td class="h">479</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;application/x.atom+xml&#39;,</td></tr>
<tr><td class="h">480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;$api/post&quot;,</td></tr>
<tr><td class="h">481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Create a new entry&#39;</td></tr>
<tr><td class="h">482</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) if $opts-&gt;{&#39;apilinks&#39;};</td></tr>
<tr><td class="h">484</td><td colspan="7"></td></tr><tr><td class="h">485</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L485">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( LJ::is_enabled( &#39;hubbub&#39; ) ) {</td></tr>
<tr><td class="h">486</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $hub (@LJ::HUBBUB_HUBS) {</td></tr>
<tr><td class="h">487</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;add_link($make_link-&gt;(&#39;hub&#39;, undef, $hub));</td></tr>
<tr><td class="h">488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">490</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">491</td><td colspan="7"></td></tr><tr><td class="h">492</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posteru = LJ::load_userids( map { $_-&gt;{posterid} } @$cleanitems);</td></tr>
<tr><td class="h">493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# output individual item blocks</td></tr>
<tr><td class="h">494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $it (@$cleanitems)</td></tr>
<tr><td class="h">495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">496</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $itemid = $it-&gt;{itemid};</td></tr>
<tr><td class="h">497</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $it-&gt;{ditemid};</td></tr>
<tr><td class="h">498</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $poster = $posteru-&gt;{$it-&gt;{posterid}};</td></tr>
<tr><td class="h">499</td><td colspan="7"></td></tr><tr><td class="h">500</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = XML::Atom::Entry-&gt;new( Version =&gt; 1 );</td></tr>
<tr><td class="h">501</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry_xml = $entry-&gt;{doc};</td></tr>
<tr><td class="h">502</td><td colspan="7"></td></tr><tr><td class="h">503</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;id(&quot;urn:lj:$LJ::DOMAIN:atom1:$u-&gt;{user}:$ditemid&quot;);</td></tr>
<tr><td class="h">504</td><td colspan="7"></td></tr><tr><td class="h">505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# author isn&#39;t required if it is in the main &lt;feed&gt;</td></tr>
<tr><td class="h">506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# only add author if we are in a single entry view, or</td></tr>
<tr><td class="h">507</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the journal entry isn&#39;t owned by the journal owner. (communities)</td></tr>
<tr><td class="h">508</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L508">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L508">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $opts-&gt;{&#39;single_entry&#39;} || $journalu-&gt;email_raw ne $poster-&gt;email_raw ) {</td></tr>
<tr><td class="h">509</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $author = XML::Atom::Person-&gt;new( Version =&gt; 1 );</td></tr>
<tr><td class="h">510</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L510">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$author-&gt;email( $poster-&gt;email_visible ) if $poster-&gt;email_visible;</td></tr>
<tr><td class="h">511</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$author-&gt;name(  $poster-&gt;{name} );</td></tr>
<tr><td class="h">512</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;author( $author );</td></tr>
<tr><td class="h">513</td><td colspan="7"></td></tr><tr><td class="h">514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# and the lj-specific stuff</td></tr>
<tr><td class="h">515</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $postauthor = $entry_xml-&gt;createElement( &#39;lj:poster&#39; );</td></tr>
<tr><td class="h">516</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$postauthor-&gt;setAttribute( &#39;user&#39;, LJ::exml($poster-&gt;user));</td></tr>
<tr><td class="h">517</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $postauthor );</td></tr>
<tr><td class="h">518</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">519</td><td colspan="7"></td></tr><tr><td class="h">520</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;add_link(</td></tr>
<tr><td class="h">521</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_link-&gt;( &#39;alternate&#39;, &#39;text/html&#39;, &quot;$j-&gt;{&#39;link&#39;}$ditemid.html&quot; )</td></tr>
<tr><td class="h">522</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">523</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;add_link(</td></tr>
<tr><td class="h">524</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_link-&gt;( &#39;self&#39;, &#39;text/xml&#39;, &quot;$api/?itemid=$ditemid&quot; )</td></tr>
<tr><td class="h">525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">526</td><td colspan="7"></td></tr><tr><td class="h">527</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L527">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;add_link(</td></tr>
<tr><td class="h">528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_link-&gt;(</td></tr>
<tr><td class="h">529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;service.edit&#39;,      &#39;application/x.atom+xml&#39;,</td></tr>
<tr><td class="h">530</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;$api/edit/$itemid&quot;, &#39;Edit this post&#39;</td></tr>
<tr><td class="h">531</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">532</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) if $opts-&gt;{&#39;apilinks&#39;};</td></tr>
<tr><td class="h">533</td><td colspan="7"></td></tr><tr><td class="h">534</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# NOTE: Atom 0.3 allowed for &quot;issued&quot;, where we put the time the</td></tr>
<tr><td class="h">535</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# user says it was. There&#39;s no equivalent in later versions of</td></tr>
<tr><td class="h">536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Atom, though. And Atom 0.3 is deprecated. Oh well.</td></tr>
<tr><td class="h">537</td><td colspan="7"></td></tr><tr><td class="h">538</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($year, $mon, $mday, $hour, $min, $sec) = split(/ /, $it-&gt;{eventtime});</td></tr>
<tr><td class="h">539</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $event_date = sprintf(&quot;%04d-%02d-%02dT%02d:%02d:%02d&quot;,</td></tr>
<tr><td class="h">540</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$year, $mon, $mday, $hour, $min, $sec);</td></tr>
<tr><td class="h">541</td><td colspan="7"></td></tr><tr><td class="h">542</td><td colspan="7"></td></tr><tr><td class="h">543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# title can&#39;t be blank and can&#39;t be absent, so we have to fake some subject</td></tr>
<tr><td class="h">544</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L544">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;title( $it-&gt;{&#39;subject&#39;} ||</td></tr>
<tr><td class="h">545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;$journalu-&gt;{user} \@ $event_date&quot;</td></tr>
<tr><td class="h">546</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">547</td><td colspan="7"></td></tr><tr><td class="h">548</td><td colspan="7"></td></tr><tr><td class="h">549</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;published( LJ::time_to_w3c($it-&gt;{createtime}, &quot;Z&quot;) );</td></tr>
<tr><td class="h">550</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;updated(   LJ::time_to_w3c($it-&gt;{modtime},    &quot;Z&quot;) );</td></tr>
<tr><td class="h">551</td><td colspan="7"></td></tr><tr><td class="h">552</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# XML::Atom 0.13 doesn&#39;t support categories.   Maybe later?</td></tr>
<tr><td class="h">553</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L553">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $tag ( @{$it-&gt;{tags} || []} ) {</td></tr>
<tr><td class="h">554</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tag = LJ::exml( $tag );</td></tr>
<tr><td class="h">555</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $category = $entry_xml-&gt;createElement( &#39;category&#39; );</td></tr>
<tr><td class="h">556</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$category-&gt;setAttribute( &#39;term&#39;, $tag );</td></tr>
<tr><td class="h">557</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$category-&gt;setNamespace( $ns );</td></tr>
<tr><td class="h">558</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $category );</td></tr>
<tr><td class="h">559</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">560</td><td colspan="7"></td></tr><tr><td class="h">561</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L561">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($it-&gt;{&#39;music&#39;}) {</td></tr>
<tr><td class="h">562</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $music = $entry_xml-&gt;createElement( &#39;lj:music&#39; );</td></tr>
<tr><td class="h">563</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$music-&gt;appendTextNode( $it-&gt;{&#39;music&#39;} );</td></tr>
<tr><td class="h">564</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $music );</td></tr>
<tr><td class="h">565</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">566</td><td colspan="7"></td></tr><tr><td class="h">567</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if syndicating the complete entry</td></tr>
<tr><td class="h">568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#   -print a content tag</td></tr>
<tr><td class="h">569</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# elsif syndicating summaries</td></tr>
<tr><td class="h">570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#   -print a summary tag</td></tr>
<tr><td class="h">571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# else (code omitted), we&#39;re syndicating title only</td></tr>
<tr><td class="h">572</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#   -print neither (the title has already been printed)</td></tr>
<tr><td class="h">573</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#   note: the $event was also emptied earlier, in make_feed</td></tr>
<tr><td class="h">574</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</td></tr>
<tr><td class="h">575</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# a lack of a content element is allowed,  as long</td></tr>
<tr><td class="h">576</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# as we maintain a proper &#39;alternate&#39; link (above)</td></tr>
<tr><td class="h">577</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $make_content = sub {</td></tr>
<tr><td class="h">578</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L578">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $content = $entry_xml-&gt;createElement( $_[0] );</td></tr>
<tr><td class="h">579</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;setAttribute( &#39;type&#39;, &#39;html&#39; );</td></tr>
<tr><td class="h">580</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;setNamespace( $ns );</td></tr>
<tr><td class="h">581</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;appendTextNode( $it-&gt;{&#39;event&#39;} );</td></tr>
<tr><td class="h">582</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $content );</td></tr>
<tr><td class="h">583</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">584</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L584">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L584">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L584">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;{&#39;opt_synlevel&#39;} eq &#39;full&#39; || $u-&gt;{&#39;opt_synlevel&#39;} eq &#39;cut&#39; ) {</td></tr>
<tr><td class="h">585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Do this manually for now, until XML::Atom supports new</td></tr>
<tr><td class="h">586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# content type classifications.</td></tr>
<tr><td class="h">587</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_content-&gt;(&#39;content&#39;);</td></tr>
<tr><td class="h">588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($u-&gt;{&#39;opt_synlevel&#39;} eq &#39;summary&#39;) {</td></tr>
<tr><td class="h">589</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$make_content-&gt;(&#39;summary&#39;);</td></tr>
<tr><td class="h">590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">591</td><td colspan="7"></td></tr><tr><td class="h">592</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L592">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $opts-&gt;{&#39;single_entry&#39;} ) {</td></tr>
<tr><td class="h">593</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $normalize_ns-&gt;( $entry-&gt;as_xml() );</td></tr>
<tr><td class="h">594</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</td></tr>
<tr><td class="h">596</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;add_entry( $entry );</td></tr>
<tr><td class="h">597</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">598</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">599</td><td colspan="7"></td></tr><tr><td class="h">600</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $normalize_ns-&gt;( $feed-&gt;as_xml() );</td></tr>
<tr><td class="h">601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">602</td><td colspan="7"></td></tr><tr><td class="h">603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># create a FOAF page for a user</td></tr>
<tr><td class="h">604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_view_foaf {</td></tr>
<tr><td class="h">605</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L605">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalinfo, $u, $opts) = @_;</td></tr>
<tr><td class="h">606</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comm = $u-&gt;is_community;</td></tr>
<tr><td class="h">607</td><td colspan="7"></td></tr><tr><td class="h">608</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret;</td></tr>
<tr><td class="h">609</td><td colspan="7"></td></tr><tr><td class="h">610</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return nothing if we&#39;re not a user</td></tr>
<tr><td class="h">611</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L611">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L611">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $u-&gt;is_person || $comm ) {</td></tr>
<tr><td class="h">612</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{handler_return} = 404;</td></tr>
<tr><td class="h">613</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">614</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">615</td><td colspan="7"></td></tr><tr><td class="h">616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set our content type</td></tr>
<tr><td class="h">617</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{contenttype} = &#39;application/rdf+xml; charset=&#39; . $opts-&gt;{saycharset};</td></tr>
<tr><td class="h">618</td><td colspan="7"></td></tr><tr><td class="h">619</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# setup userprops we will need</td></tr>
<tr><td class="h">620</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($u, qw{</td></tr>
<tr><td class="h">621</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aolim icq yahoo jabber msn icbm url urlname external_foaf_url country city journaltitle</td></tr>
<tr><td class="h">622</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">623</td><td colspan="7"></td></tr><tr><td class="h">624</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# create bare foaf document, for now</td></tr>
<tr><td class="h">625</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret = &quot;&lt;?xml version=&#39;1.0&#39;?&gt;\n&quot;;</td></tr>
<tr><td class="h">626</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::run_hook(&quot;bot_director&quot;, &quot;&lt;!-- &quot;, &quot; --&gt;&quot;);</td></tr>
<tr><td class="h">627</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;rdf:RDF\n&quot;;</td></tr>
<tr><td class="h">628</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;   xml:lang=\&quot;en\&quot;\n&quot;;</td></tr>
<tr><td class="h">629</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;   xmlns:rdf=\&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#\&quot;\n&quot;;</td></tr>
<tr><td class="h">630</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;   xmlns:rdfs=\&quot;http://www.w3.org/2000/01/rdf-schema#\&quot;\n&quot;;</td></tr>
<tr><td class="h">631</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;   xmlns:foaf=\&quot;http://xmlns.com/foaf/0.1/\&quot;\n&quot;;</td></tr>
<tr><td class="h">632</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;   xmlns:ya=\&quot;http://blogs.yandex.ru/schema/foaf/\&quot;\n&quot;;</td></tr>
<tr><td class="h">633</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;   xmlns:geo=\&quot;http://www.w3.org/2003/01/geo/wgs84_pos#\&quot;\n&quot;;</td></tr>
<tr><td class="h">634</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;   xmlns:dc=\&quot;http://purl.org/dc/elements/1.1/\&quot;&gt;\n&quot;;</td></tr>
<tr><td class="h">635</td><td colspan="7"></td></tr><tr><td class="h">636</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# precompute some values</td></tr>
<tr><td class="h">637</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $digest = &quot;&quot;;</td></tr>
<tr><td class="h">638</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">639</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L639">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_validated) {</td></tr>
<tr><td class="h">640</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $email_visible = $u-&gt;email_visible($remote);</td></tr>
<tr><td class="h">641</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L641">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$digest = Digest::SHA1::sha1_hex(&quot;mailto:$email_visible&quot;) if $email_visible;</td></tr>
<tr><td class="h">642</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">643</td><td colspan="7"></td></tr><tr><td class="h">644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# channel attributes</td></tr>
<tr><td class="h">645</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L645">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= ($comm ? &quot;  &lt;foaf:Group&gt;\n&quot; : &quot;  &lt;foaf:Person&gt;\n&quot;);</td></tr>
<tr><td class="h">646</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:nick&gt;$u-&gt;{user}&lt;/foaf:nick&gt;\n&quot;;</td></tr>
<tr><td class="h">647</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:name&gt;&quot;. LJ::exml($u-&gt;{name}) .&quot;&lt;/foaf:name&gt;\n&quot;;</td></tr>
<tr><td class="h">648</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L648">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:openid rdf:resource=\&quot;&quot; . $u-&gt;journal_base . &quot;/\&quot; /&gt;\n&quot;</td></tr>
<tr><td class="h">649</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $comm;</td></tr>
<tr><td class="h">650</td><td colspan="7"></td></tr><tr><td class="h">651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user location</td></tr>
<tr><td class="h">652</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L652">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;country&#39;}) {</td></tr>
<tr><td class="h">653</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ecountry = LJ::eurl($u-&gt;{&#39;country&#39;});</td></tr>
<tr><td class="h">654</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L654">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;ya:country dc:title=\&quot;$ecountry\&quot; rdf:resource=\&quot;$LJ::SITEROOT/directory.bml?opt_sort=ut&amp;amp;s_loc=1&amp;amp;loc_cn=$ecountry\&quot;/&gt;\n&quot; if $u-&gt;can_show_location($remote);</td></tr>
<tr><td class="h">655</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L655">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;city&#39;}) {</td></tr>
<tr><td class="h">656</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $estate = &#39;&#39;;  # FIXME: add state.  Yandex didn&#39;t need it.</td></tr>
<tr><td class="h">657</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ecity = LJ::eurl($u-&gt;{&#39;city&#39;});</td></tr>
<tr><td class="h">658</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L658">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;ya:city dc:title=\&quot;$ecity\&quot; rdf:resource=\&quot;$LJ::SITEROOT/directory.bml?opt_sort=ut&amp;amp;s_loc=1&amp;amp;loc_cn=$ecountry&amp;amp;loc_st=$estate&amp;amp;loc_ci=$ecity\&quot;/&gt;\n&quot; if $u-&gt;can_show_location($remote);</td></tr>
<tr><td class="h">659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">660</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">661</td><td colspan="7"></td></tr><tr><td class="h">662</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L662">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L662">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{bdate} &amp;&amp; $u-&gt;{bdate} ne &quot;0000-00-00&quot; &amp;&amp; !$comm &amp;&amp; $u-&gt;can_show_full_bday) {</td></tr>
<tr><td class="h">663</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:dateOfBirth&gt;&quot;.$u-&gt;bday_string.&quot;&lt;/foaf:dateOfBirth&gt;\n&quot;;</td></tr>
<tr><td class="h">664</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">665</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L665">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:mbox_sha1sum&gt;$digest&lt;/foaf:mbox_sha1sum&gt;\n&quot; if $digest;</td></tr>
<tr><td class="h">666</td><td colspan="7"></td></tr><tr><td class="h">667</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# userpic</td></tr>
<tr><td class="h">668</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L668">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $picid = $u-&gt;{&#39;defaultpicid&#39;}) {</td></tr>
<tr><td class="h">669</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:img rdf:resource=\&quot;$LJ::USERPIC_ROOT/$picid/$u-&gt;{userid}\&quot; /&gt;\n&quot;;</td></tr>
<tr><td class="h">670</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">671</td><td colspan="7"></td></tr><tr><td class="h">672</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:page&gt;\n&quot;;</td></tr>
<tr><td class="h">673</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;      &lt;foaf:Document rdf:about=\&quot;&quot; . $u-&gt;profile_url . &quot;\&quot;&gt;\n&quot;;</td></tr>
<tr><td class="h">674</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;dc:title&gt;$LJ::SITENAME Profile&lt;/dc:title&gt;\n&quot;;</td></tr>
<tr><td class="h">675</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;dc:description&gt;Full $LJ::SITENAME profile, including information such as interests and bio.&lt;/dc:description&gt;\n&quot;;</td></tr>
<tr><td class="h">676</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;      &lt;/foaf:Document&gt;\n&quot;;</td></tr>
<tr><td class="h">677</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;/foaf:page&gt;\n&quot;;</td></tr>
<tr><td class="h">678</td><td colspan="7"></td></tr><tr><td class="h">679</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we want to bail out if they have an external foaf file, because</td></tr>
<tr><td class="h">680</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we want them to be able to provide their own information.</td></tr>
<tr><td class="h">681</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L681">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{external_foaf_url}) {</td></tr>
<tr><td class="h">682</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;rdfs:seeAlso rdf:resource=\&quot;&quot; . LJ::eurl($u-&gt;{external_foaf_url}) . &quot;\&quot; /&gt;\n&quot;;</td></tr>
<tr><td class="h">683</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L683">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= ($comm ? &quot;  &lt;/foaf:Group&gt;\n&quot; : &quot;  &lt;/foaf:Person&gt;\n&quot;);</td></tr>
<tr><td class="h">684</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/rdf:RDF&gt;\n&quot;;</td></tr>
<tr><td class="h">685</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">686</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">687</td><td colspan="7"></td></tr><tr><td class="h">688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# contact type information</td></tr>
<tr><td class="h">689</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %types = (</td></tr>
<tr><td class="h">690</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aolim =&gt; &#39;aimChatID&#39;,</td></tr>
<tr><td class="h">691</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icq =&gt; &#39;icqChatID&#39;,</td></tr>
<tr><td class="h">692</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yahoo =&gt; &#39;yahooChatID&#39;,</td></tr>
<tr><td class="h">693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msn =&gt; &#39;msnChatID&#39;,</td></tr>
<tr><td class="h">694</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jabber =&gt; &#39;jabberID&#39;,</td></tr>
<tr><td class="h">695</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">696</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L696">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{allow_contactshow} eq &#39;Y&#39;) {</td></tr>
<tr><td class="h">697</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $type (keys %types) {</td></tr>
<tr><td class="h">698</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L698">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless defined $u-&gt;{$type};</td></tr>
<tr><td class="h">699</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:$types{$type}&gt;&quot; . LJ::exml($u-&gt;{$type}) . &quot;&lt;/foaf:$types{$type}&gt;\n&quot;;</td></tr>
<tr><td class="h">700</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">701</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">702</td><td colspan="7"></td></tr><tr><td class="h">703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# blog activity</td></tr>
<tr><td class="h">704</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">705</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $count = $u-&gt;number_of_posts;</td></tr>
<tr><td class="h">706</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;ya:blogActivity&gt;\n&quot;;</td></tr>
<tr><td class="h">707</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;      &lt;ya:Posts&gt;\n&quot;;</td></tr>
<tr><td class="h">708</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;ya:feed rdf:resource=\&quot;&quot; . LJ::journal_base($u) .&quot;/data/foaf\&quot; dc:type=\&quot;application/rss+xml\&quot; /&gt;\n&quot;;</td></tr>
<tr><td class="h">709</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;ya:posted&gt;$count&lt;/ya:posted&gt;\n&quot;;</td></tr>
<tr><td class="h">710</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;      &lt;/ya:Posts&gt;\n&quot;;</td></tr>
<tr><td class="h">711</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;/ya:blogActivity&gt;\n&quot;;</td></tr>
<tr><td class="h">712</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">713</td><td colspan="7"></td></tr><tr><td class="h">714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# include a user&#39;s journal page and web site info</td></tr>
<tr><td class="h">715</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:weblog rdf:resource=\&quot;&quot; . LJ::journal_base($u) . &quot;/\&quot;/&gt;\n&quot;;</td></tr>
<tr><td class="h">716</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L716">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{url}) {</td></tr>
<tr><td class="h">717</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:homepage rdf:resource=\&quot;&quot; . LJ::eurl($u-&gt;{url});</td></tr>
<tr><td class="h">718</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;\&quot; dc:title=\&quot;&quot; . LJ::exml($u-&gt;{urlname}) . &quot;\&quot; /&gt;\n&quot;;</td></tr>
<tr><td class="h">719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">720</td><td colspan="7"></td></tr><tr><td class="h">721</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user bio</td></tr>
<tr><td class="h">722</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L722">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;has_bio&#39;} eq &quot;Y&quot;) {</td></tr>
<tr><td class="h">723</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{&#39;bio&#39;} = LJ::get_bio($u);</td></tr>
<tr><td class="h">724</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$u-&gt;{&#39;bio&#39;});</td></tr>
<tr><td class="h">725</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_userbio(\$u-&gt;{&#39;bio&#39;});</td></tr>
<tr><td class="h">726</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;ya:bio&gt;&quot; . LJ::exml($u-&gt;{&#39;bio&#39;}) . &quot;&lt;/ya:bio&gt;\n&quot;;</td></tr>
<tr><td class="h">727</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">728</td><td colspan="7"></td></tr><tr><td class="h">729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user schools</td></tr>
<tr><td class="h">730</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L730">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L730">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$u-&gt;is_syndicated &amp;&amp;</td></tr>
<tr><td class="h">731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::is_enabled(&#39;schools&#39;)  &amp;&amp;</td></tr>
<tr><td class="h">732</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($u-&gt;{&#39;opt_showschools&#39;} eq &#39;&#39; || $u-&gt;{&#39;opt_showschools&#39;} eq &#39;Y&#39;)) {</td></tr>
<tr><td class="h">733</td><td colspan="7"></td></tr><tr><td class="h">734</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $schools = LJ::Schools::get_attended($u);</td></tr>
<tr><td class="h">735</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L735">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L735">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( ! $u-&gt;is_community &amp;&amp; $schools &amp;&amp; %$schools ) {</td></tr>
<tr><td class="h">736</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @links;</td></tr>
<tr><td class="h">737</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $sid (sort { $schools-&gt;{$a}-&gt;{year_start} &lt;=&gt; $schools-&gt;{$b}-&gt;{year_start} } keys %$schools) {</td></tr>
<tr><td class="h">738</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $link = &quot;$LJ::SITEROOT/schools/&quot; .</td></tr>
<tr><td class="h">739</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;?ctc=&quot; . LJ::eurl($schools-&gt;{$sid}-&gt;{country}) .</td></tr>
<tr><td class="h">740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&amp;sc=&quot; . LJ::eurl($schools-&gt;{$sid}-&gt;{state}) .</td></tr>
<tr><td class="h">741</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&amp;cc=&quot; . LJ::eurl($schools-&gt;{$sid}-&gt;{city}) .</td></tr>
<tr><td class="h">742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&amp;sid=&quot; . $sid ;</td></tr>
<tr><td class="h">743</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ename = LJ::ehtml($schools-&gt;{$sid}-&gt;{name});</td></tr>
<tr><td class="h">744</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;ya:school\n&quot;;</td></tr>
<tr><td class="h">745</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;       rdf:resource=\&quot;&quot; . LJ::exml($link) . &quot;\&quot;\n&quot;;</td></tr>
<tr><td class="h">746</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L746">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $schools-&gt;{$sid}-&gt;{year_start}) {</td></tr>
<tr><td class="h">747</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;       ya:dateStart=\&quot;$schools-&gt;{$sid}-&gt;{year_start}\&quot;\n&quot;;</td></tr>
<tr><td class="h">748</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">749</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L749">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $schools-&gt;{$sid}-&gt;{year_end}) {</td></tr>
<tr><td class="h">750</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;       ya:dateFinish=\&quot;$schools-&gt;{$sid}-&gt;{year_end}\&quot;\n&quot;;</td></tr>
<tr><td class="h">751</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">752</td><td colspan="7"></td></tr><tr><td class="h">753</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;       dc:title=\&quot;$ename\&quot;/&gt;\n&quot;;</td></tr>
<tr><td class="h">754</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">756</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">757</td><td colspan="7"></td></tr><tr><td class="h">758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# icbm/location info</td></tr>
<tr><td class="h">759</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L759">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{icbm}) {</td></tr>
<tr><td class="h">760</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @loc = split(&quot;,&quot;, $u-&gt;{icbm});</td></tr>
<tr><td class="h">761</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:based_near&gt;&lt;geo:Point geo:lat=&#39;&quot; . $loc[0] . &quot;&#39;&quot; .</td></tr>
<tr><td class="h">762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; geo:long=&#39;&quot; . $loc[1] . &quot;&#39; /&gt;&lt;/foaf:based_near&gt;\n&quot;;</td></tr>
<tr><td class="h">763</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">764</td><td colspan="7"></td></tr><tr><td class="h">765</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# interests, please!</td></tr>
<tr><td class="h">766</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# arrayref of interests rows: [ intid, intname, intcount ]</td></tr>
<tr><td class="h">767</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $intu = LJ::get_interests($u);</td></tr>
<tr><td class="h">768</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $int (@$intu) {</td></tr>
<tr><td class="h">769</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$int-&gt;[1]); # 1==interest</td></tr>
<tr><td class="h">770</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;foaf:interest dc:title=\&quot;&quot;. LJ::exml($int-&gt;[1]) . &quot;\&quot; &quot; .</td></tr>
<tr><td class="h">771</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;rdf:resource=\&quot;$LJ::SITEROOT/interests.bml?int=&quot; . LJ::eurl($int-&gt;[1]) . &quot;\&quot; /&gt;\n&quot;;</td></tr>
<tr><td class="h">772</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">773</td><td colspan="7"></td></tr><tr><td class="h">774</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check if the user has a &quot;FOAF-knows&quot; group</td></tr>
<tr><td class="h">775</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L775">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $has_foaf_group = $u-&gt;trust_groups( name =&gt; &#39;FOAF-knows&#39; ) ? 1 : 0;</td></tr>
<tr><td class="h">776</td><td colspan="7"></td></tr><tr><td class="h">777</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now information on who you know, limited to a certain maximum number of users</td></tr>
<tr><td class="h">778</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @ids;</td></tr>
<tr><td class="h">779</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L779">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $has_foaf_group ) {</td></tr>
<tr><td class="h">780</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@ids = keys %{ $u-&gt;trust_group_members( name =&gt; &#39;FOAF-knows&#39; ) };</td></tr>
<tr><td class="h">781</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">782</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@ids = $u-&gt;trusted_userids;</td></tr>
<tr><td class="h">783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">784</td><td colspan="7"></td></tr><tr><td class="h">785</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L785">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;@ids = splice(@ids, 0, $LJ::MAX_FOAF_FRIENDS) if @ids &gt; $LJ::MAX_FOAF_FRIENDS;</td></tr>
<tr><td class="h">786</td><td colspan="7"></td></tr><tr><td class="h">787</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now load</td></tr>
<tr><td class="h">788</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $users = LJ::load_userids( @ids );</td></tr>
<tr><td class="h">789</td><td colspan="7"></td></tr><tr><td class="h">790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# iterate to create data structure</td></tr>
<tr><td class="h">791</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $trustid ( @ids ) {</td></tr>
<tr><td class="h">792</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L792">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $trustid == $u-&gt;id;</td></tr>
<tr><td class="h">793</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fu = $users-&gt;{$trustid};</td></tr>
<tr><td class="h">794</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L794">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L794">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $fu-&gt;is_inactive || ! $fu-&gt;is_person;</td></tr>
<tr><td class="h">795</td><td colspan="7"></td></tr><tr><td class="h">796</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $name = LJ::exml($fu-&gt;name_raw);</td></tr>
<tr><td class="h">797</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L797">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tagline = LJ::exml($fu-&gt;prop(&#39;journaltitle&#39;) || &#39;&#39;);</td></tr>
<tr><td class="h">798</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L798">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $upicurl = $fu-&gt;userpic ? $fu-&gt;userpic-&gt;url : &#39;&#39;;</td></tr>
<tr><td class="h">799</td><td colspan="7"></td></tr><tr><td class="h">800</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L800">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $comm ? &quot;    &lt;foaf:member&gt;\n&quot; : &quot;    &lt;foaf:knows&gt;\n&quot;;</td></tr>
<tr><td class="h">801</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;      &lt;foaf:Person&gt;\n&quot;;</td></tr>
<tr><td class="h">802</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;foaf:nick&gt;$fu-&gt;{&#39;user&#39;}&lt;/foaf:nick&gt;\n&quot;;</td></tr>
<tr><td class="h">803</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;foaf:member_name&gt;$name&lt;/foaf:member_name&gt;\n&quot;;</td></tr>
<tr><td class="h">804</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;foaf:tagLine&gt;$tagline&lt;/foaf:tagLine&gt;\n&quot;;</td></tr>
<tr><td class="h">805</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L805">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;foaf:image&gt;$upicurl&lt;/foaf:image&gt;\n&quot; if $upicurl;</td></tr>
<tr><td class="h">806</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;rdfs:seeAlso rdf:resource=\&quot;&quot; . LJ::journal_base($fu) .&quot;/data/foaf\&quot; /&gt;\n&quot;;</td></tr>
<tr><td class="h">807</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;        &lt;foaf:weblog rdf:resource=\&quot;&quot; . LJ::journal_base($fu) . &quot;/\&quot;/&gt;\n&quot;;</td></tr>
<tr><td class="h">808</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;      &lt;/foaf:Person&gt;\n&quot;;</td></tr>
<tr><td class="h">809</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L809">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $comm ? &quot;    &lt;/foaf:member&gt;\n&quot; : &quot;    &lt;/foaf:knows&gt;\n&quot;;</td></tr>
<tr><td class="h">810</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">811</td><td colspan="7"></td></tr><tr><td class="h">812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# finish off the document</td></tr>
<tr><td class="h">813</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L813">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $comm ? &quot;    &lt;/foaf:Group&gt;\n&quot; : &quot;  &lt;/foaf:Person&gt;\n&quot;;</td></tr>
<tr><td class="h">814</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/rdf:RDF&gt;\n&quot;;</td></tr>
<tr><td class="h">815</td><td colspan="7"></td></tr><tr><td class="h">816</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">818</td><td colspan="7"></td></tr><tr><td class="h">819</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># YADIS capability discovery</td></tr>
<tr><td class="h">820</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_view_yadis {</td></tr>
<tr><td class="h">821</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L821">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalinfo, $u, $opts) = @_;</td></tr>
<tr><td class="h">822</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $person = $u-&gt;is_person;</td></tr>
<tr><td class="h">823</td><td colspan="7"></td></tr><tr><td class="h">824</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = &quot;&quot;;</td></tr>
<tr><td class="h">825</td><td colspan="7"></td></tr><tr><td class="h">826</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L826">0</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $println = sub { $ret .= $_[0].&quot;\n&quot;; };</td></tr>
<tr><td class="h">827</td><td colspan="7"></td></tr><tr><td class="h">828</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&#39;);</td></tr>
<tr><td class="h">829</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;&lt;xrds:XRDS xmlns:xrds=&quot;xri://$xrds&quot; xmlns=&quot;xri://$xrd*($v*2.0)&quot;&gt;&lt;XRD&gt;&#39;);</td></tr>
<tr><td class="h">830</td><td colspan="7"></td></tr><tr><td class="h">831</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;local $1;</td></tr>
<tr><td class="h">832</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{pathextra} =~ m!^(/.*)?$!;</td></tr>
<tr><td class="h">833</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $viewchunk = $1;</td></tr>
<tr><td class="h">834</td><td colspan="7"></td></tr><tr><td class="h">835</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $view;</td></tr>
<tr><td class="h">836</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L836">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L836">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($viewchunk eq &#39;&#39;) {</td></tr>
<tr><td class="h">837</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$view = &quot;recent&quot;;</td></tr>
<tr><td class="h">838</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">839</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;elsif ($viewchunk eq &#39;/read&#39;) {</td></tr>
<tr><td class="h">840</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$view = &quot;read&quot;;</td></tr>
<tr><td class="h">841</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">842</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;else {</td></tr>
<tr><td class="h">843</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$view = undef;</td></tr>
<tr><td class="h">844</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">845</td><td colspan="7"></td></tr><tr><td class="h">846</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L846">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L846">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($view eq &#39;recent&#39;) {</td></tr>
<tr><td class="h">847</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Only people (not communities, etc) can be OpenID authenticated</td></tr>
<tr><td class="h">848</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L848">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--condition.html#L848">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($person &amp;&amp; LJ::OpenID-&gt;server_enabled) {</td></tr>
<tr><td class="h">849</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;    &lt;Service&gt;&#39;);</td></tr>
<tr><td class="h">850</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;        &lt;Type&gt;http://openid.net/signon/1.0&lt;/Type&gt;&#39;);</td></tr>
<tr><td class="h">851</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;        &lt;URI&gt;&#39;.LJ::ehtml($LJ::OPENID_SERVER).&#39;&lt;/URI&gt;&#39;);</td></tr>
<tr><td class="h">852</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;    &lt;/Service&gt;&#39;);</td></tr>
<tr><td class="h">853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">854</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">855</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;elsif ($view eq &#39;read&#39;) {</td></tr>
<tr><td class="h">856</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;    &lt;Service xmlns:gm=&quot;http://openid.net/xmlns/groupmembership/xrds&quot;&gt;&#39;);</td></tr>
<tr><td class="h">857</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;        &lt;Type&gt;http://openid.net/xmlns/groupmembership&lt;/Type&gt;&#39;);</td></tr>
<tr><td class="h">858</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;        &lt;URI&gt;&#39;.LJ::exml($LJ::SITEROOT).&#39;/openid/groupmembership.bml&lt;/URI&gt;&#39;);</td></tr>
<tr><td class="h">859</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;        &lt;LocalID&gt;&#39;.LJ::exml($u-&gt;journal_base.&#39;/read&#39;).&#39;&lt;/LocalID&gt;&#39;);</td></tr>
<tr><td class="h">860</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;        &lt;gm:CanEnumerate /&gt;&lt;gm:CanQuery /&gt;&#39;);</td></tr>
<tr><td class="h">861</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;    &lt;/Service&gt;&#39;);</td></tr>
<tr><td class="h">862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">863</td><td colspan="7"></td></tr><tr><td class="h">864</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Local site-specific content</td></tr>
<tr><td class="h">865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO: Give these hooks access to $view somehow?</td></tr>
<tr><td class="h">866</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hook(&quot;yadis_service_descriptors&quot;, \$ret);</td></tr>
<tr><td class="h">867</td><td colspan="7"></td></tr><tr><td class="h">868</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$println-&gt;(&#39;&lt;/XRD&gt;&lt;/xrds:XRDS&gt;&#39;);</td></tr>
<tr><td class="h">869</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">870</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">871</td><td colspan="7"></td></tr><tr><td class="h">872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># create a userpic page for a user</td></tr>
<tr><td class="h">873</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_view_userpics {</td></tr>
<tr><td class="h">874</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L874">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalinfo, $u, $opts) = @_;</td></tr>
<tr><td class="h">875</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $feed, $xml, $ns );</td></tr>
<tr><td class="h">876</td><td colspan="7"></td></tr><tr><td class="h">877</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ns = &quot;http://www.w3.org/2005/Atom&quot;;</td></tr>
<tr><td class="h">878</td><td colspan="7"></td></tr><tr><td class="h">879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $normalize_ns = sub {</td></tr>
<tr><td class="h">880</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L880">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $str = shift;</td></tr>
<tr><td class="h">881</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str =~ s/(&lt;\w+)\s+xmlns=&quot;\Q$ns\E&quot;/$1/og;</td></tr>
<tr><td class="h">882</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str =~ s/&lt;feed\b/&lt;feed xmlns=&quot;$ns&quot;/;</td></tr>
<tr><td class="h">883</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $str;</td></tr>
<tr><td class="h">884</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">885</td><td colspan="7"></td></tr><tr><td class="h">886</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $make_link = sub {</td></tr>
<tr><td class="h">887</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L887">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $rel, $type, $href, $title ) = @_;</td></tr>
<tr><td class="h">888</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $link = XML::Atom::Link-&gt;new( Version =&gt; 1 );</td></tr>
<tr><td class="h">889</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;rel($rel);</td></tr>
<tr><td class="h">890</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;type($type);</td></tr>
<tr><td class="h">891</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;href($href);</td></tr>
<tr><td class="h">892</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L892">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;title( $title ) if $title;</td></tr>
<tr><td class="h">893</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $link;</td></tr>
<tr><td class="h">894</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">895</td><td colspan="7"></td></tr><tr><td class="h">896</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $author = XML::Atom::Person-&gt;new( Version =&gt; 1 );</td></tr>
<tr><td class="h">897</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$author-&gt;name(  $u-&gt;{name} );</td></tr>
<tr><td class="h">898</td><td colspan="7"></td></tr><tr><td class="h">899</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$feed = XML::Atom::Feed-&gt;new( Version =&gt; 1 );</td></tr>
<tr><td class="h">900</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$xml  = $feed-&gt;{doc};</td></tr>
<tr><td class="h">901</td><td colspan="7"></td></tr><tr><td class="h">902</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L902">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;should_block_robots) {</td></tr>
<tr><td class="h">903</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$xml-&gt;getDocumentElement-&gt;setAttribute( &quot;xmlns:idx&quot;, &quot;urn:atom-extension:indexing&quot; );</td></tr>
<tr><td class="h">904</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$xml-&gt;getDocumentElement-&gt;setAttribute( &quot;idx:index&quot;, &quot;no&quot; );</td></tr>
<tr><td class="h">905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">906</td><td colspan="7"></td></tr><tr><td class="h">907</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bot = LJ::run_hook(&quot;bot_director&quot;);</td></tr>
<tr><td class="h">908</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L908">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$xml-&gt;insertBefore( $xml-&gt;createComment( $bot ), $xml-&gt;documentElement())</td></tr>
<tr><td class="h">909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $bot;</td></tr>
<tr><td class="h">910</td><td colspan="7"></td></tr><tr><td class="h">911</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;id( &quot;urn:lj:$LJ::DOMAIN:atom1:$u-&gt;{user}:userpics&quot; );</td></tr>
<tr><td class="h">912</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;title( &quot;$u-&gt;{user}&#39;s userpics&quot; );</td></tr>
<tr><td class="h">913</td><td colspan="7"></td></tr><tr><td class="h">914</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;author( $author );</td></tr>
<tr><td class="h">915</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;add_link( $make_link-&gt;( &#39;alternate&#39;, &#39;text/html&#39;, $u-&gt;allpics_base ) );</td></tr>
<tr><td class="h">916</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;add_link( $make_link-&gt;( &#39;self&#39;, &#39;text/xml&#39;, $u-&gt;journal_base() . &quot;/data/userpics&quot; ) );</td></tr>
<tr><td class="h">917</td><td colspan="7"></td></tr><tr><td class="h">918</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now start building all the userpic data</td></tr>
<tr><td class="h">919</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# start up by loading all of our userpic information and creating that part of the feed</td></tr>
<tr><td class="h">920</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $info = LJ::get_userpic_info( $u, { load_comments =&gt; 1, load_urls =&gt; 1, load_descriptions =&gt; 1 } );</td></tr>
<tr><td class="h">921</td><td colspan="7"></td></tr><tr><td class="h">922</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %keywords = ();</td></tr>
<tr><td class="h">923</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($kw, $pic) = each %{$info-&gt;{kw}}) {</td></tr>
<tr><td class="h">924</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$kw);</td></tr>
<tr><td class="h">925</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$keywords{$pic-&gt;{picid}}}, LJ::exml($kw);</td></tr>
<tr><td class="h">926</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">927</td><td colspan="7"></td></tr><tr><td class="h">928</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %comments = ();</td></tr>
<tr><td class="h">929</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($pic, $comment) = each %{$info-&gt;{comment}}) {</td></tr>
<tr><td class="h">930</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$comment);</td></tr>
<tr><td class="h">931</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comments{$pic} = LJ::strip_html($comment);</td></tr>
<tr><td class="h">932</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">933</td><td colspan="7"></td></tr><tr><td class="h">934</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %descriptions = ();</td></tr>
<tr><td class="h">935</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while ( my( $pic, $description ) = each %{$info-&gt;{description}} ) {</td></tr>
<tr><td class="h">936</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$description);</td></tr>
<tr><td class="h">937</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$descriptions{$pic} = LJ::strip_html($description);</td></tr>
<tr><td class="h">938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">939</td><td colspan="7"></td></tr><tr><td class="h">940</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @pics;</td></tr>
<tr><td class="h">941</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @pics, map { $info-&gt;{pic}-&gt;{$_} } sort { $a &lt;=&gt; $b }</td></tr>
<tr><td class="h">942</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { $info-&gt;{pic}-&gt;{$_}-&gt;{state} eq &#39;N&#39; } keys %{$info-&gt;{pic}};</td></tr>
<tr><td class="h">943</td><td colspan="7"></td></tr><tr><td class="h">944</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry;</td></tr>
<tr><td class="h">945</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %picdata;</td></tr>
<tr><td class="h">946</td><td colspan="7"></td></tr><tr><td class="h">947</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# this is lame, but we have to do this iteration twice; we load the userpic data first, so that</td></tr>
<tr><td class="h">948</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we can figure out what the most recently-uploaded userpic is. we need to put that into the feed</td></tr>
<tr><td class="h">949</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# before any of the &lt;entry&gt; values.</td></tr>
<tr><td class="h">950</td><td colspan="7"></td></tr><tr><td class="h">951</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $latest = 0;</td></tr>
<tr><td class="h">952</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $pic (@pics) {</td></tr>
<tr><td class="h">953</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userpics(\%picdata, [$u, $pic-&gt;{picid}] );</td></tr>
<tr><td class="h">954</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L954">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$latest = ($latest &lt; $picdata{$pic-&gt;{picid}}-&gt;{picdate}) ? $picdata{$pic-&gt;{picid}}-&gt;{picdate} : $latest;</td></tr>
<tr><td class="h">955</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">956</td><td colspan="7"></td></tr><tr><td class="h">957</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;updated( LJ::time_to_w3c($latest, &#39;Z&#39;) );</td></tr>
<tr><td class="h">958</td><td colspan="7"></td></tr><tr><td class="h">959</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $pic (@pics) {</td></tr>
<tr><td class="h">960</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = XML::Atom::Entry-&gt;new( Version =&gt; 1 );</td></tr>
<tr><td class="h">961</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry_xml = $entry-&gt;{doc};</td></tr>
<tr><td class="h">962</td><td colspan="7"></td></tr><tr><td class="h">963</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;id(&quot;urn:lj:$LJ::DOMAIN:atom1:$u-&gt;{user}:userpics:$pic-&gt;{picid}&quot;);</td></tr>
<tr><td class="h">964</td><td colspan="7"></td></tr><tr><td class="h">965</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L965">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $title = ($pic-&gt;{picid} == $u-&gt;{defaultpicid}) ? &quot;default userpic&quot; : &quot;userpic&quot;;</td></tr>
<tr><td class="h">966</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;title( $title );</td></tr>
<tr><td class="h">967</td><td colspan="7"></td></tr><tr><td class="h">968</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;updated( LJ::time_to_w3c($picdata{$pic-&gt;{picid}}-&gt;{picdate}, &#39;Z&#39;) );</td></tr>
<tr><td class="h">969</td><td colspan="7"></td></tr><tr><td class="h">970</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $content;</td></tr>
<tr><td class="h">971</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = $entry_xml-&gt;createElement( &quot;content&quot; );</td></tr>
<tr><td class="h">972</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;setAttribute( &#39;src&#39;, &quot;$LJ::USERPIC_ROOT/$pic-&gt;{picid}/$u-&gt;{userid}&quot; );</td></tr>
<tr><td class="h">973</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;setNamespace( $ns );</td></tr>
<tr><td class="h">974</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $content );</td></tr>
<tr><td class="h">975</td><td colspan="7"></td></tr><tr><td class="h">976</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $kw (@{$keywords{$pic-&gt;{picid}}}) {</td></tr>
<tr><td class="h">977</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $category = $entry_xml-&gt;createElement( &#39;category&#39; );</td></tr>
<tr><td class="h">978</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$category-&gt;setAttribute( &#39;term&#39;, $kw );</td></tr>
<tr><td class="h">979</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$category-&gt;setNamespace( $ns );</td></tr>
<tr><td class="h">980</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $category );</td></tr>
<tr><td class="h">981</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">982</td><td colspan="7"></td></tr><tr><td class="h">983</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L983">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $descriptions{$pic-&gt;{picid}} ) {</td></tr>
<tr><td class="h">984</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $content = $entry_xml-&gt;createElement( &#39;title&#39; );</td></tr>
<tr><td class="h">985</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;setNamespace( $ns );</td></tr>
<tr><td class="h">986</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;appendTextNode( $descriptions{$pic-&gt;{picid}} );</td></tr>
<tr><td class="h">987</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $content );</td></tr>
<tr><td class="h">988</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">989</td><td colspan="7"></td></tr><tr><td class="h">990</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L990">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($comments{$pic-&gt;{picid}}) {</td></tr>
<tr><td class="h">991</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $content = $entry_xml-&gt;createElement( &quot;summary&quot; );</td></tr>
<tr><td class="h">992</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;setNamespace( $ns );</td></tr>
<tr><td class="h">993</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;appendTextNode( $comments{$pic-&gt;{picid}} );</td></tr>
<tr><td class="h">994</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $content );</td></tr>
<tr><td class="h">995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">996</td><td colspan="7"></td></tr><tr><td class="h">997</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$feed-&gt;add_entry( $entry );</td></tr>
<tr><td class="h">998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">999</td><td colspan="7"></td></tr><tr><td class="h">1000</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $normalize_ns-&gt;( $feed-&gt;as_xml() );</td></tr>
<tr><td class="h">1001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1002</td><td colspan="7"></td></tr><tr><td class="h">1003</td><td colspan="7"></td></tr><tr><td class="h">1004</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_view_comments</td></tr>
<tr><td class="h">1005</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1006</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L1006">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalinfo, $u, $opts) = @_;</td></tr>
<tr><td class="h">1007</td><td colspan="7"></td></tr><tr><td class="h">1008</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L1008">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( LJ::is_enabled(&#39;latest_comments_rss&#39;, $u) ) {</td></tr>
<tr><td class="h">1009</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{handler_return} = 404;</td></tr>
<tr><td class="h">1010</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 404;</td></tr>
<tr><td class="h">1011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1012</td><td colspan="7"></td></tr><tr><td class="h">1013</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L1013">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($u-&gt;get_cap(&#39;latest_comments_rss&#39;)) {</td></tr>
<tr><td class="h">1014</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{handler_return} = 403;</td></tr>
<tr><td class="h">1015</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">1016</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1017</td><td colspan="7"></td></tr><tr><td class="h">1018</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret;</td></tr>
<tr><td class="h">1019</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;?xml version=&#39;1.0&#39; encoding=&#39;$opts-&gt;{&#39;saycharset&#39;}&#39; ?&gt;\n&quot;;</td></tr>
<tr><td class="h">1020</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::run_hook(&quot;bot_director&quot;, &quot;&lt;!-- &quot;, &quot; --&gt;&quot;) . &quot;\n&quot;;</td></tr>
<tr><td class="h">1021</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;rss version=&#39;2.0&#39; xmlns:lj=&#39;http://www.livejournal.org/rss/lj/1.0/&#39;&gt;\n&quot;;</td></tr>
<tr><td class="h">1022</td><td colspan="7"></td></tr><tr><td class="h">1023</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# channel attributes</td></tr>
<tr><td class="h">1024</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;channel&gt;\n&quot;;</td></tr>
<tr><td class="h">1025</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;title&gt;&quot; . LJ::exml($journalinfo-&gt;{title}) . &quot;&lt;/title&gt;\n&quot;;</td></tr>
<tr><td class="h">1026</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;link&gt;$journalinfo-&gt;{link}&lt;/link&gt;\n&quot;;</td></tr>
<tr><td class="h">1027</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;description&gt;Latest comments in &quot; . LJ::exml($journalinfo-&gt;{title}) . &quot;&lt;/description&gt;\n&quot;;</td></tr>
<tr><td class="h">1028</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L1028">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;managingEditor&gt;&quot; . LJ::exml($journalinfo-&gt;{email}) . &quot;&lt;/managingEditor&gt;\n&quot; if $journalinfo-&gt;{email};</td></tr>
<tr><td class="h">1029</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lastBuildDate&gt;$journalinfo-&gt;{builddate}&lt;/lastBuildDate&gt;\n&quot;;</td></tr>
<tr><td class="h">1030</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;generator&gt;LiveJournal / $LJ::SITENAME&lt;/generator&gt;\n&quot;;</td></tr>
<tr><td class="h">1031</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lj:journal&gt;&quot; . $u-&gt;user . &quot;&lt;/lj:journal&gt;\n&quot;;</td></tr>
<tr><td class="h">1032</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;lj:journaltype&gt;&quot; . $u-&gt;journaltype_readable . &quot;&lt;/lj:journaltype&gt;\n&quot;;</td></tr>
<tr><td class="h">1033</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO: add &#39;language&#39; field when user.lang has more useful information</td></tr>
<tr><td class="h">1034</td><td colspan="7"></td></tr><tr><td class="h">1035</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### image block, returns info for their current userpic</td></tr>
<tr><td class="h">1036</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L1036">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;defaultpicid&#39;}) {</td></tr>
<tr><td class="h">1037</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pic = {};</td></tr>
<tr><td class="h">1038</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userpics($pic, [ $u, $u-&gt;{&#39;defaultpicid&#39;} ]);</td></tr>
<tr><td class="h">1039</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pic = $pic-&gt;{$u-&gt;{&#39;defaultpicid&#39;}}; # flatten</td></tr>
<tr><td class="h">1040</td><td colspan="7"></td></tr><tr><td class="h">1041</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;image&gt;\n&quot;;</td></tr>
<tr><td class="h">1042</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;url&gt;$LJ::USERPIC_ROOT/$u-&gt;{&#39;defaultpicid&#39;}/$u-&gt;{&#39;userid&#39;}&lt;/url&gt;\n&quot;;</td></tr>
<tr><td class="h">1043</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;title&gt;&quot; . LJ::exml($journalinfo-&gt;{title}) . &quot;&lt;/title&gt;\n&quot;;</td></tr>
<tr><td class="h">1044</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;link&gt;$journalinfo-&gt;{link}&lt;/link&gt;\n&quot;;</td></tr>
<tr><td class="h">1045</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;width&gt;$pic-&gt;{&#39;width&#39;}&lt;/width&gt;\n&quot;;</td></tr>
<tr><td class="h">1046</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;    &lt;height&gt;$pic-&gt;{&#39;height&#39;}&lt;/height&gt;\n&quot;;</td></tr>
<tr><td class="h">1047</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;/image&gt;\n\n&quot;;</td></tr>
<tr><td class="h">1048</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1049</td><td colspan="7"></td></tr><tr><td class="h">1050</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @comments = $u-&gt;get_recent_talkitems(25);</td></tr>
<tr><td class="h">1051</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $r (@comments)</td></tr>
<tr><td class="h">1052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1053</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $c = LJ::Comment-&gt;new($u, jtalkid =&gt; $r-&gt;{jtalkid});</td></tr>
<tr><td class="h">1054</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $thread_url = $c-&gt;thread_url;</td></tr>
<tr><td class="h">1055</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $subject = $c-&gt;subject_raw;</td></tr>
<tr><td class="h">1056</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_subject_all(\$subject);</td></tr>
<tr><td class="h">1057</td><td colspan="7"></td></tr><tr><td class="h">1058</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;item&gt;\n&quot;;</td></tr>
<tr><td class="h">1059</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;guid isPermaLink=&#39;true&#39;&gt;$thread_url&lt;/guid&gt;\n&quot;;</td></tr>
<tr><td class="h">1060</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;pubDate&gt;&quot; . LJ::time_to_http($r-&gt;{datepostunix}) . &quot;&lt;/pubDate&gt;\n&quot;;</td></tr>
<tr><td class="h">1061</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L1061">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;title&gt;&quot; . LJ::exml($subject) . &quot;&lt;/title&gt;\n&quot; if $subject;</td></tr>
<tr><td class="h">1062</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;link&gt;$thread_url&lt;/link&gt;\n&quot;;</td></tr>
<tr><td class="h">1063</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# omit the description tag if we&#39;re only syndicating titles</td></tr>
<tr><td class="h">1064</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljfeed-pl--branch.html#L1064">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($u-&gt;{&#39;opt_synlevel&#39;} eq &#39;title&#39;) {</td></tr>
<tr><td class="h">1065</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $body = $c-&gt;body_raw;</td></tr>
<tr><td class="h">1066</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_subject_all(\$body);</td></tr>
<tr><td class="h">1067</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;  &lt;description&gt;&quot; . LJ::exml($body) . &quot;&lt;/description&gt;\n&quot;;</td></tr>
<tr><td class="h">1068</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1069</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/item&gt;\n&quot;;</td></tr>
<tr><td class="h">1070</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1071</td><td colspan="7"></td></tr><tr><td class="h">1072</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/channel&gt;\n&quot;;</td></tr>
<tr><td class="h">1073</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/rss&gt;\n&quot;;</td></tr>
<tr><td class="h">1074</td><td colspan="7"></td></tr><tr><td class="h">1075</td><td colspan="7"></td></tr><tr><td class="h">1076</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">1077</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1078</td><td colspan="7"></td></tr><tr><td class="h">1079</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub generate_hubbub_jobs {</td></tr>
<tr><td class="h">1080</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljfeed-pl--subroutine.html#L1080">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $joblist ) = @_;</td></tr>
<tr><td class="h">1081</td><td colspan="7"></td></tr><tr><td class="h">1082</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljfeed-pl--branch.html#L1082">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless LJ::is_enabled( &#39;hubbub&#39; );</td></tr>
<tr><td class="h">1083</td><td colspan="7"></td></tr><tr><td class="h">1084</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $hub ( @LJ::HUBBUB_HUBS ) {</td></tr>
<tr><td class="h">1085</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $make_hubbub_job = sub {</td></tr>
<tr><td class="h">1086</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljfeed-pl--subroutine.html#L1086">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $type = shift;</td></tr>
<tr><td class="h">1087</td><td colspan="7"></td></tr><tr><td class="h">1088</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $topic_url = $u-&gt;journal_base . &quot;/data/$type&quot;;</td></tr>
<tr><td class="h">1089</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return TheSchwartz::Job-&gt;new(</td></tr>
<tr><td class="h">1090</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;funcname =&gt; &#39;TheSchwartz::Worker::PubSubHubbubPublish&#39;,</td></tr>
<tr><td class="h">1091</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arg =&gt; {</td></tr>
<tr><td class="h">1092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hub =&gt; $hub,</td></tr>
<tr><td class="h">1093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topic_url =&gt; $topic_url,</td></tr>
<tr><td class="h">1094</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</td></tr>
<tr><td class="h">1095</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;coalesce =&gt; $hub,</td></tr>
<tr><td class="h">1096</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1097</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1098</td><td colspan="7"></td></tr><tr><td class="h">1099</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$joblist, $make_hubbub_job-&gt;(&quot;rss&quot;);</td></tr>
<tr><td class="h">1100</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$joblist, $make_hubbub_job-&gt;(&quot;atom&quot;);</td></tr>
<tr><td class="h">1101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1103</td><td colspan="7"></td></tr><tr><td class="h">1104</td><td colspan="7"></td></tr><tr><td class="h">1105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
