<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/communitylib.pl</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/communitylib.pl</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">3.9%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#!/usr/bin/perl</td></tr>
<tr><td class="h">2</td><td colspan="7"></td></tr><tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ;</td></tr>
<tr><td class="h">4</td><td colspan="7"></td></tr><tr><td class="h">5</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-communitylib-pl--subroutine.html#L5">1</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">6</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-communitylib-pl--subroutine.html#L6">1</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Event::CommunityInvite;</td></tr>
<tr><td class="h">7</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-communitylib-pl--subroutine.html#L7">1</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Event::CommunityJoinRequest;</td></tr>
<tr><td class="h">8</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-communitylib-pl--subroutine.html#L8">1</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Event::CommunityJoinApprove;</td></tr>
<tr><td class="h">9</td><td><div class="c3">1</div><div class="c3">1</div><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-communitylib-pl--subroutine.html#L9">1</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Event::CommunityJoinReject;</td></tr>
<tr><td class="h">10</td><td colspan="7"></td></tr><tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_sent_invites</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Get a list of sent invitations from the past 30 days.</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: cuserid</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-cuserid: a userid or u object of the community to get sent invitations for</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: hashref of arrayrefs with keys userid, maintid, recvtime, status, args (itself</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          a hashref of what abilities the user would be given)</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">19</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_sent_invites {</td></tr>
<tr><td class="h">20</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L20">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = shift;</td></tr>
<tr><td class="h">21</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu = LJ::want_user($cu);</td></tr>
<tr><td class="h">22</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L22">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $cu;</td></tr>
<tr><td class="h">23</td><td colspan="7"></td></tr><tr><td class="h">24</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now hit the database for their recent invites</td></tr>
<tr><td class="h">25</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($cu);</td></tr>
<tr><td class="h">26</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L26">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $dbcr;</td></tr>
<tr><td class="h">27</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $data = $dbcr-&gt;selectall_arrayref(&#39;SELECT userid, maintid, recvtime, status, args FROM invitesent &#39; .</td></tr>
<tr><td class="h">28</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;WHERE commid = ? AND recvtime &gt; UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY))&#39;,</td></tr>
<tr><td class="h">29</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid});</td></tr>
<tr><td class="h">30</td><td colspan="7"></td></tr><tr><td class="h">31</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now break data down into usable format for caller</td></tr>
<tr><td class="h">32</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @res;</td></tr>
<tr><td class="h">33</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L33">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $row (@{$data || []}) {</td></tr>
<tr><td class="h">34</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $temp = {};</td></tr>
<tr><td class="h">35</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::decode_url_string($row-&gt;[4], $temp);</td></tr>
<tr><td class="h">36</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @res, {</td></tr>
<tr><td class="h">37</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userid =&gt; $row-&gt;[0]+0,</td></tr>
<tr><td class="h">38</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;maintid =&gt; $row-&gt;[1]+0,</td></tr>
<tr><td class="h">39</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recvtime =&gt; $row-&gt;[2],</td></tr>
<tr><td class="h">40</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status =&gt; $row-&gt;[3],</td></tr>
<tr><td class="h">41</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args =&gt; $temp,</td></tr>
<tr><td class="h">42</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">43</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">44</td><td colspan="7"></td></tr><tr><td class="h">45</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# all done</td></tr>
<tr><td class="h">46</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \@res;    </td></tr>
<tr><td class="h">47</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">48</td><td colspan="7"></td></tr><tr><td class="h">49</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">50</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::send_comm_invite</td></tr>
<tr><td class="h">51</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Sends an invitation to a user to join a community with the passed abilities.</td></tr>
<tr><td class="h">52</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuserid, cuserid, muserid, attrs</td></tr>
<tr><td class="h">53</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: a userid or u object of the user to invite.</td></tr>
<tr><td class="h">54</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-cuserid: a userid or u object of the community to invite the user to.</td></tr>
<tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-muserid: a userid or u object of the maintainer doing the inviting.</td></tr>
<tr><td class="h">56</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-attrs: a hashref of abilities this user should have (e.g. member, post, unmoderated, ...)</td></tr>
<tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 for success, undef if failure</td></tr>
<tr><td class="h">58</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">59</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub send_comm_invite {</td></tr>
<tr><td class="h">60</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L60">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $cu, $mu, $attrs) = @_;</td></tr>
<tr><td class="h">61</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user($u);</td></tr>
<tr><td class="h">62</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu = LJ::want_user($cu);</td></tr>
<tr><td class="h">63</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$mu = LJ::want_user($mu);</td></tr>
<tr><td class="h">64</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L64">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L64">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u &amp;&amp; $cu &amp;&amp; $mu;</td></tr>
<tr><td class="h">65</td><td colspan="7"></td></tr><tr><td class="h">66</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 1: if the user has banned the community, don&#39;t accept the invite</td></tr>
<tr><td class="h">67</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L67">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;comm_user_has_banned&#39;) if LJ::is_banned($cu, $u);</td></tr>
<tr><td class="h">68</td><td colspan="7"></td></tr><tr><td class="h">69</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 2: lazily clean out old community invites.</td></tr>
<tr><td class="h">70</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L70">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $u-&gt;writer;</td></tr>
<tr><td class="h">71</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&#39;DELETE FROM inviterecv WHERE userid = ? AND &#39; .</td></tr>
<tr><td class="h">72</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;recvtime &lt; UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY))&#39;,</td></tr>
<tr><td class="h">73</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{userid});</td></tr>
<tr><td class="h">74</td><td colspan="7"></td></tr><tr><td class="h">75</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L75">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $cu-&gt;writer;</td></tr>
<tr><td class="h">76</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;do(&#39;DELETE FROM invitesent WHERE commid = ? AND &#39; .</td></tr>
<tr><td class="h">77</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;recvtime &lt; UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY))&#39;,</td></tr>
<tr><td class="h">78</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid});</td></tr>
<tr><td class="h">79</td><td colspan="7"></td></tr><tr><td class="h">80</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u);</td></tr>
<tr><td class="h">81</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L81">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $dbcr;</td></tr>
<tr><td class="h">82</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $argstr = $dbcr-&gt;selectrow_array(&#39;SELECT args FROM inviterecv WHERE userid = ? AND commid = ?&#39;,</td></tr>
<tr><td class="h">83</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{userid}, $cu-&gt;{userid});</td></tr>
<tr><td class="h">84</td><td colspan="7"></td></tr><tr><td class="h">85</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 4: exceeded outstanding invitation limit?  only if no outstanding invite</td></tr>
<tr><td class="h">86</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L86">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($argstr) {</td></tr>
<tr><td class="h">87</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cdbcr = LJ::get_cluster_def_reader($cu);</td></tr>
<tr><td class="h">88</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L88">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $cdbcr;</td></tr>
<tr><td class="h">89</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $count = $cdbcr-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM invitesent WHERE commid = ? &quot; .</td></tr>
<tr><td class="h">90</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND userid &lt;&gt; ? AND status = &#39;outstanding&#39;&quot;,</td></tr>
<tr><td class="h">91</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid}, $u-&gt;{userid});</td></tr>
<tr><td class="h">92</td><td colspan="7"></td></tr><tr><td class="h">93</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# for now, limit to 500 outstanding invitations per community.  if this is not enough</td></tr>
<tr><td class="h">94</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# it can be raised or put back to the old system of using community size as an indicator</td></tr>
<tr><td class="h">95</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# of how many people to allow.</td></tr>
<tr><td class="h">96</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L96">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;comm_invite_limit&#39;) if $count &gt; 500;</td></tr>
<tr><td class="h">97</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">98</td><td colspan="7"></td></tr><tr><td class="h">99</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 5: setup arg string as url-encoded string</td></tr>
<tr><td class="h">100</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $newargstr = join(&#39;=1&amp;&#39;, map { LJ::eurl($_) } @$attrs) . &#39;=1&#39;;</td></tr>
<tr><td class="h">101</td><td colspan="7"></td></tr><tr><td class="h">102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 6: branch here to update or insert</td></tr>
<tr><td class="h">103</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L103">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($argstr) {</td></tr>
<tr><td class="h">104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# merely an update, so just do it quietly</td></tr>
<tr><td class="h">105</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;UPDATE inviterecv SET args = ? WHERE userid = ? AND commid = ?&quot;,</td></tr>
<tr><td class="h">106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $newargstr, $u-&gt;{userid}, $cu-&gt;{userid});</td></tr>
<tr><td class="h">107</td><td colspan="7"></td></tr><tr><td class="h">108</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;do(&quot;UPDATE invitesent SET args = ?, status = &#39;outstanding&#39; WHERE userid = ? AND commid = ?&quot;,</td></tr>
<tr><td class="h">109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $newargstr, $cu-&gt;{userid}, $u-&gt;{userid});</td></tr>
<tr><td class="h">110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# insert new data, as this is a new invite</td></tr>
<tr><td class="h">112</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;INSERT INTO inviterecv VALUES (?, ?, ?, UNIX_TIMESTAMP(), ?)&quot;,</td></tr>
<tr><td class="h">113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{userid}, $cu-&gt;{userid}, $mu-&gt;{userid}, $newargstr);</td></tr>
<tr><td class="h">114</td><td colspan="7"></td></tr><tr><td class="h">115</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;do(&quot;REPLACE INTO invitesent VALUES (?, ?, ?, UNIX_TIMESTAMP(), &#39;outstanding&#39;, ?)&quot;,</td></tr>
<tr><td class="h">116</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid}, $u-&gt;{userid}, $mu-&gt;{userid}, $newargstr);</td></tr>
<tr><td class="h">117</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">118</td><td colspan="7"></td></tr><tr><td class="h">119</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Fire community invite event</td></tr>
<tr><td class="h">120</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L120">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Event::CommunityInvite-&gt;new($u, $mu, $cu)-&gt;fire if LJ::is_enabled(&#39;esn&#39;);</td></tr>
<tr><td class="h">121</td><td colspan="7"></td></tr><tr><td class="h">122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 7: error check database work</td></tr>
<tr><td class="h">123</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L123">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L123">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) if $u-&gt;err || $cu-&gt;err;</td></tr>
<tr><td class="h">124</td><td colspan="7"></td></tr><tr><td class="h">125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# success</td></tr>
<tr><td class="h">126</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">128</td><td colspan="7"></td></tr><tr><td class="h">129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::accept_comm_invite</td></tr>
<tr><td class="h">131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Accepts an invitation a user has received.  This does all the work to make the</td></tr>
<tr><td class="h">132</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      user join the community as well as sets up privileges.</td></tr>
<tr><td class="h">133</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuserid, cuserid</td></tr>
<tr><td class="h">134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: a userid or u object of the user to get pending invites for</td></tr>
<tr><td class="h">135</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-cuserid: a userid or u object of the community to reject the invitation from</td></tr>
<tr><td class="h">136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 for success, undef if failure</td></tr>
<tr><td class="h">137</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub accept_comm_invite {</td></tr>
<tr><td class="h">139</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L139">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $cu) = @_;</td></tr>
<tr><td class="h">140</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user($u);</td></tr>
<tr><td class="h">141</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu = LJ::want_user($cu);</td></tr>
<tr><td class="h">142</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L142">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L142">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u &amp;&amp; $cu;</td></tr>
<tr><td class="h">143</td><td colspan="7"></td></tr><tr><td class="h">144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get their invite to make sure they have one</td></tr>
<tr><td class="h">145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u);</td></tr>
<tr><td class="h">146</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L146">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $dbcr;</td></tr>
<tr><td class="h">147</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $argstr = $dbcr-&gt;selectrow_array(&#39;SELECT args FROM inviterecv WHERE userid = ? AND commid = ? &#39; .</td></tr>
<tr><td class="h">148</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;AND recvtime &gt; UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY))&#39;,</td></tr>
<tr><td class="h">149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{userid}, $cu-&gt;{userid});</td></tr>
<tr><td class="h">150</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L150">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $argstr;</td></tr>
<tr><td class="h">151</td><td colspan="7"></td></tr><tr><td class="h">152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# decode to find out what they get</td></tr>
<tr><td class="h">153</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $args = {};</td></tr>
<tr><td class="h">154</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::decode_url_string($argstr, $args);</td></tr>
<tr><td class="h">155</td><td colspan="7"></td></tr><tr><td class="h">156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# valid invite.  let&#39;s accept it as far as the community listing us goes.</td></tr>
<tr><td class="h">157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# 1, 0 means add comm to user&#39;s friends list, but don&#39;t auto-add P edge.</td></tr>
<tr><td class="h">158</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L158">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L158">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::join_community( $u, $cu, 1, 0, moderated_add =&gt; 1 ) or return undef</td></tr>
<tr><td class="h">159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $args-&gt;{member};</td></tr>
<tr><td class="h">160</td><td colspan="7"></td></tr><tr><td class="h">161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now grant necessary abilities</td></tr>
<tr><td class="h">162</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %edgelist = (</td></tr>
<tr><td class="h">163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post =&gt; &#39;P&#39;,</td></tr>
<tr><td class="h">164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preapprove =&gt; &#39;N&#39;,</td></tr>
<tr><td class="h">165</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moderate =&gt; &#39;M&#39;,</td></tr>
<tr><td class="h">166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;admin =&gt; &#39;A&#39;,</td></tr>
<tr><td class="h">167</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">168</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %edgelist) {</td></tr>
<tr><td class="h">169</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L169">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_rel($cu-&gt;{userid}, $u-&gt;{userid}, $edgelist{$_}) if $args-&gt;{$_};</td></tr>
<tr><td class="h">170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">171</td><td colspan="7"></td></tr><tr><td class="h">172</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now we can delete the invite and update the status on the other side</td></tr>
<tr><td class="h">173</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L173">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $u-&gt;writer;</td></tr>
<tr><td class="h">174</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM inviterecv WHERE userid = ? AND commid = ?&quot;,</td></tr>
<tr><td class="h">175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{userid}, $cu-&gt;{userid});</td></tr>
<tr><td class="h">176</td><td colspan="7"></td></tr><tr><td class="h">177</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L177">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $cu-&gt;writer;</td></tr>
<tr><td class="h">178</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;do(&quot;UPDATE invitesent SET status = &#39;accepted&#39; WHERE commid = ? AND userid = ?&quot;,</td></tr>
<tr><td class="h">179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid}, $u-&gt;{userid});</td></tr>
<tr><td class="h">180</td><td colspan="7"></td></tr><tr><td class="h">181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# done</td></tr>
<tr><td class="h">182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">183</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">184</td><td colspan="7"></td></tr><tr><td class="h">185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">186</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::reject_comm_invite</td></tr>
<tr><td class="h">187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Rejects an invitation a user has received.</td></tr>
<tr><td class="h">188</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuserid, cuserid</td></tr>
<tr><td class="h">189</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: a userid or u object of the user to get pending invites for.</td></tr>
<tr><td class="h">190</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-cuserid: a userid or u object of the community to reject the invitation from</td></tr>
<tr><td class="h">191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 for success, undef if failure</td></tr>
<tr><td class="h">192</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">193</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub reject_comm_invite {</td></tr>
<tr><td class="h">194</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L194">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $cu) = @_;</td></tr>
<tr><td class="h">195</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user($u);</td></tr>
<tr><td class="h">196</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu = LJ::want_user($cu);</td></tr>
<tr><td class="h">197</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L197">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L197">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u &amp;&amp; $cu;</td></tr>
<tr><td class="h">198</td><td colspan="7"></td></tr><tr><td class="h">199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get their invite to make sure they have one</td></tr>
<tr><td class="h">200</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u);</td></tr>
<tr><td class="h">201</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L201">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $dbcr;</td></tr>
<tr><td class="h">202</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $test = $dbcr-&gt;selectrow_array(&#39;SELECT userid FROM inviterecv WHERE userid = ? AND commid = ? &#39; .</td></tr>
<tr><td class="h">203</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;AND recvtime &gt; UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY))&#39;,</td></tr>
<tr><td class="h">204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{userid}, $cu-&gt;{userid});</td></tr>
<tr><td class="h">205</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L205">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $test;</td></tr>
<tr><td class="h">206</td><td colspan="7"></td></tr><tr><td class="h">207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now just reject it</td></tr>
<tr><td class="h">208</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L208">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $u-&gt;writer;</td></tr>
<tr><td class="h">209</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM inviterecv WHERE userid = ? AND commid = ?&quot;,</td></tr>
<tr><td class="h">210</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{userid}, $cu-&gt;{userid});</td></tr>
<tr><td class="h">211</td><td colspan="7"></td></tr><tr><td class="h">212</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L212">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $cu-&gt;writer;</td></tr>
<tr><td class="h">213</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;do(&quot;UPDATE invitesent SET status = &#39;rejected&#39; WHERE commid = ? AND userid = ?&quot;,</td></tr>
<tr><td class="h">214</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid}, $u-&gt;{userid});</td></tr>
<tr><td class="h">215</td><td colspan="7"></td></tr><tr><td class="h">216</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# done</td></tr>
<tr><td class="h">217</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">219</td><td colspan="7"></td></tr><tr><td class="h">220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">221</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_pending_invites</td></tr>
<tr><td class="h">222</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets a list of pending invitations for a user to join a community.</td></tr>
<tr><td class="h">223</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuserid</td></tr>
<tr><td class="h">224</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: a userid or u object of the user to get pending invites for.</td></tr>
<tr><td class="h">225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: [ [ commid, maintainerid, time, args(url encoded) ], [ ... ], ... ] or</td></tr>
<tr><td class="h">226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          undef if failure</td></tr>
<tr><td class="h">227</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">228</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_pending_invites {</td></tr>
<tr><td class="h">229</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L229">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">230</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user($u);</td></tr>
<tr><td class="h">231</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L231">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u;</td></tr>
<tr><td class="h">232</td><td colspan="7"></td></tr><tr><td class="h">233</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# hit up database for invites and return them</td></tr>
<tr><td class="h">234</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u);</td></tr>
<tr><td class="h">235</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L235">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $dbcr;</td></tr>
<tr><td class="h">236</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pending = $dbcr-&gt;selectall_arrayref(&#39;SELECT commid, maintid, recvtime, args FROM inviterecv WHERE userid = ? &#39; .</td></tr>
<tr><td class="h">237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;AND recvtime &gt; UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 30 DAY))&#39;, </td></tr>
<tr><td class="h">238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{userid});</td></tr>
<tr><td class="h">239</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L239">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef if $dbcr-&gt;err;</td></tr>
<tr><td class="h">240</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $pending;</td></tr>
<tr><td class="h">241</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">242</td><td colspan="7"></td></tr><tr><td class="h">243</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">244</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::revoke_invites</td></tr>
<tr><td class="h">245</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Revokes a list of outstanding invitations to a community.</td></tr>
<tr><td class="h">246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: cuserid, userids</td></tr>
<tr><td class="h">247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-cuserid: a userid or u object of the community.</td></tr>
<tr><td class="h">248</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-ruserids: userids to revoke invitations from.</td></tr>
<tr><td class="h">249</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 if success, undef if error</td></tr>
<tr><td class="h">250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">251</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub revoke_invites {</td></tr>
<tr><td class="h">252</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L252">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = shift;</td></tr>
<tr><td class="h">253</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @uids = @_;</td></tr>
<tr><td class="h">254</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu = LJ::want_user($cu);</td></tr>
<tr><td class="h">255</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L255">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L255">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless ($cu &amp;&amp; @uids);</td></tr>
<tr><td class="h">256</td><td colspan="7"></td></tr><tr><td class="h">257</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $uid (@uids) {</td></tr>
<tr><td class="h">258</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L258">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless int($uid) &gt; 0;</td></tr>
<tr><td class="h">259</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">260</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&#39;,&#39;, @uids);</td></tr>
<tr><td class="h">261</td><td colspan="7"></td></tr><tr><td class="h">262</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L262">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) unless $cu-&gt;writer;</td></tr>
<tr><td class="h">263</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;do(&quot;DELETE FROM invitesent WHERE commid = ? AND &quot; .</td></tr>
<tr><td class="h">264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;userid IN ($in)&quot;, undef, $cu-&gt;{userid});</td></tr>
<tr><td class="h">265</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L265">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error(&#39;db&#39;) if $cu-&gt;err;</td></tr>
<tr><td class="h">266</td><td colspan="7"></td></tr><tr><td class="h">267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove from inviterecv also,</td></tr>
<tr><td class="h">268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# otherwise invite cannot be resent for over 30 days</td></tr>
<tr><td class="h">269</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $uid (@uids) {</td></tr>
<tr><td class="h">270</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u =  LJ::want_user($uid);</td></tr>
<tr><td class="h">271</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM inviterecv WHERE userid = ? AND &quot; .</td></tr>
<tr><td class="h">272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;commid = ?&quot;, undef, $uid, $cu-&gt;{userid});</td></tr>
<tr><td class="h">273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">274</td><td colspan="7"></td></tr><tr><td class="h">275</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# success</td></tr>
<tr><td class="h">276</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">278</td><td colspan="7"></td></tr><tr><td class="h">279</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::leave_community</td></tr>
<tr><td class="h">281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Makes a user leave a community.  Takes care of all [special[reluserdefs]] and friend stuff.</td></tr>
<tr><td class="h">282</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuserid, ucommid, defriend</td></tr>
<tr><td class="h">283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: a userid or u object of the user doing the leaving.</td></tr>
<tr><td class="h">284</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-ucommid: a userid or u object of the community being left.</td></tr>
<tr><td class="h">285</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-defriend: remove comm from user&#39;s friends list.</td></tr>
<tr><td class="h">286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 if success, undef if error of some sort (ucommid not a comm, uuserid not in</td></tr>
<tr><td class="h">287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          comm, db error, etc)</td></tr>
<tr><td class="h">288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">289</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub leave_community {</td></tr>
<tr><td class="h">290</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L290">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($uuid, $ucid, $defriend) = @_;</td></tr>
<tr><td class="h">291</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::want_user($uuid);</td></tr>
<tr><td class="h">292</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = LJ::want_user($ucid);</td></tr>
<tr><td class="h">293</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L293">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$defriend = $defriend ? 1 : 0;</td></tr>
<tr><td class="h">294</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L294">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L294">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error( &#39;comm_not_found&#39; ) unless $u &amp;&amp; $cu;</td></tr>
<tr><td class="h">295</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L295">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error( &#39;comm_not_comm&#39; ) unless $cu-&gt;is_community;</td></tr>
<tr><td class="h">296</td><td colspan="7"></td></tr><tr><td class="h">297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove community membership</td></tr>
<tr><td class="h">298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef</td></tr>
<tr><td class="h">299</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L299">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $u-&gt;remove_edge( $cu, member =&gt; {} );</td></tr>
<tr><td class="h">300</td><td colspan="7"></td></tr><tr><td class="h">301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# clear edges that effect this relationship</td></tr>
<tr><td class="h">302</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $edge (qw(P N A M)) {</td></tr>
<tr><td class="h">303</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::clear_rel($cu-&gt;{userid}, $u-&gt;{userid}, $edge);</td></tr>
<tr><td class="h">304</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">305</td><td colspan="7"></td></tr><tr><td class="h">306</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# defriend user -&gt; comm?</td></tr>
<tr><td class="h">307</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L307">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $defriend;</td></tr>
<tr><td class="h">308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;remove_edge( $cu, watch =&gt; {} );</td></tr>
<tr><td class="h">309</td><td colspan="7"></td></tr><tr><td class="h">310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t care if we failed the removal of comm from user&#39;s friends list...</td></tr>
<tr><td class="h">311</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">313</td><td colspan="7"></td></tr><tr><td class="h">314</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::join_community</td></tr>
<tr><td class="h">316</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Makes a user join a community.  Takes care of all [special[reluserdefs]] and watch stuff.</td></tr>
<tr><td class="h">317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuserid, ucommid, watch?, noauto?</td></tr>
<tr><td class="h">318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: a userid or u object of the user doing the joining</td></tr>
<tr><td class="h">319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-ucommid: a userid or u object of the community being joined</td></tr>
<tr><td class="h">320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-watch: 1 to add this comm to user&#39;s watch list, else not</td></tr>
<tr><td class="h">321</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-noauto: if defined, 1 adds P edge, 0 does not; else, base on community postlevel</td></tr>
<tr><td class="h">322</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 if success, undef if error of some sort (ucommid not a comm, uuserid already in</td></tr>
<tr><td class="h">323</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          comm, db error, etc)</td></tr>
<tr><td class="h">324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub join_community {</td></tr>
<tr><td class="h">326</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L326">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $uuid, $ucid, $watch, $canpost, %opts ) = @_;</td></tr>
<tr><td class="h">327</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::want_user($uuid);</td></tr>
<tr><td class="h">328</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = LJ::want_user($ucid);</td></tr>
<tr><td class="h">329</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L329">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$watch = $watch ? 1 : 0;</td></tr>
<tr><td class="h">330</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L330">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L330">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error( &#39;comm_not_found&#39; ) unless $u &amp;&amp; $cu;</td></tr>
<tr><td class="h">331</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L331">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::error( &#39;comm_not_comm&#39; ) unless $cu-&gt;is_community;</td></tr>
<tr><td class="h">332</td><td colspan="7"></td></tr><tr><td class="h">333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# try to join the community, and return if it didn&#39;t work</td></tr>
<tr><td class="h">334</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L334">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L334">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;add_edge( $cu, member =&gt; {</td></tr>
<tr><td class="h">335</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moderated_add =&gt; $opts{moderated_add} ? 1 : 0,</td></tr>
<tr><td class="h">336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} ) or return LJ::error(&#39;db&#39;);</td></tr>
<tr><td class="h">337</td><td colspan="7"></td></tr><tr><td class="h">338</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# add edges that effect this relationship... if the user sent a fourth</td></tr>
<tr><td class="h">339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# argument, use that as a bool.  else, load commrow and use the postlevel.</td></tr>
<tr><td class="h">340</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $addpostacc = 0;</td></tr>
<tr><td class="h">341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# only person users can post</td></tr>
<tr><td class="h">342</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L342">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;is_personal ) {</td></tr>
<tr><td class="h">343</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L343">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( defined $canpost ) {</td></tr>
<tr><td class="h">344</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L344">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addpostacc = $canpost ? 1 : 0;</td></tr>
<tr><td class="h">345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">346</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $crow = LJ::get_community_row( $cu );</td></tr>
<tr><td class="h">347</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L347">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addpostacc = $crow-&gt;{postlevel} eq &#39;members&#39; ? 1 : 0;</td></tr>
<tr><td class="h">348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">349</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">350</td><td colspan="7"></td></tr><tr><td class="h">351</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L351">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_rel( $cu-&gt;{userid}, $u-&gt;{userid}, &#39;P&#39; ) if $addpostacc;</td></tr>
<tr><td class="h">352</td><td colspan="7"></td></tr><tr><td class="h">353</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user should watch comm?</td></tr>
<tr><td class="h">354</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L354">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $watch;</td></tr>
<tr><td class="h">355</td><td colspan="7"></td></tr><tr><td class="h">356</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t do the work if they already watch the comm</td></tr>
<tr><td class="h">357</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L357">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;watches( $cu );</td></tr>
<tr><td class="h">358</td><td colspan="7"></td></tr><tr><td class="h">359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# watch the comm</td></tr>
<tr><td class="h">360</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;add_edge( $cu, watch =&gt; {} );</td></tr>
<tr><td class="h">361</td><td colspan="7"></td></tr><tr><td class="h">362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# done</td></tr>
<tr><td class="h">363</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">365</td><td colspan="7"></td></tr><tr><td class="h">366</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_community_row</td></tr>
<tr><td class="h">368</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets data relevant to a community such as their membership level and posting access.</td></tr>
<tr><td class="h">369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: ucommid</td></tr>
<tr><td class="h">370</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-ucommid: a userid or u object of the community</td></tr>
<tr><td class="h">371</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: a hashref with user, userid, name, membership, and postlevel data from the</td></tr>
<tr><td class="h">372</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          user and community tables; undef if error.</td></tr>
<tr><td class="h">373</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">374</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_community_row {</td></tr>
<tr><td class="h">375</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L375">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ucid = shift;</td></tr>
<tr><td class="h">376</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = LJ::want_user($ucid);</td></tr>
<tr><td class="h">377</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L377">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $cu;</td></tr>
<tr><td class="h">378</td><td colspan="7"></td></tr><tr><td class="h">379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# hit up database</td></tr>
<tr><td class="h">380</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">381</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($membership, $postlevel) = </td></tr>
<tr><td class="h">382</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbr-&gt;selectrow_array(&#39;SELECT membership, postlevel FROM community WHERE userid=?&#39;,</td></tr>
<tr><td class="h">383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid});</td></tr>
<tr><td class="h">384</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L384">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $dbr-&gt;err;</td></tr>
<tr><td class="h">385</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L385">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L385">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $membership &amp;&amp; $postlevel;</td></tr>
<tr><td class="h">386</td><td colspan="7"></td></tr><tr><td class="h">387</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return result hashref</td></tr>
<tr><td class="h">388</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $row = {</td></tr>
<tr><td class="h">389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user =&gt; $cu-&gt;{user},</td></tr>
<tr><td class="h">390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userid =&gt; $cu-&gt;{userid},</td></tr>
<tr><td class="h">391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name =&gt; $cu-&gt;{name},</td></tr>
<tr><td class="h">392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;membership =&gt; $membership,</td></tr>
<tr><td class="h">393</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;postlevel =&gt; $postlevel,</td></tr>
<tr><td class="h">394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">395</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $row;</td></tr>
<tr><td class="h">396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">397</td><td colspan="7"></td></tr><tr><td class="h">398</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_pending_members</td></tr>
<tr><td class="h">400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets a list of userids for people that have requested to be added to a community</td></tr>
<tr><td class="h">401</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      but have not yet actually been approved or rejected.</td></tr>
<tr><td class="h">402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: comm</td></tr>
<tr><td class="h">403</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-comm: a userid or u object of the community to get pending members of</td></tr>
<tr><td class="h">404</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: an arrayref of userids of people with pending membership requests</td></tr>
<tr><td class="h">405</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_pending_members {</td></tr>
<tr><td class="h">407</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L407">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comm = shift;</td></tr>
<tr><td class="h">408</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = LJ::want_user($comm);</td></tr>
<tr><td class="h">409</td><td colspan="7"></td></tr><tr><td class="h">410</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# database request</td></tr>
<tr><td class="h">411</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">412</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L412">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $args = $dbr-&gt;selectcol_arrayref(&#39;SELECT arg1 FROM authactions WHERE userid = ? &#39; .</td></tr>
<tr><td class="h">413</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND action = &#39;comm_join_request&#39; AND used = &#39;N&#39;&quot;,</td></tr>
<tr><td class="h">414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid}) || [];</td></tr>
<tr><td class="h">415</td><td colspan="7"></td></tr><tr><td class="h">416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# parse out the args</td></tr>
<tr><td class="h">417</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @list;</td></tr>
<tr><td class="h">418</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (@$args) {</td></tr>
<tr><td class="h">419</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L419">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @list, $1+0 if $_ =~ /^targetid=(\d+)$/;</td></tr>
<tr><td class="h">420</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">421</td><td colspan="7"></td></tr><tr><td class="h">422</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \@list;</td></tr>
<tr><td class="h">423</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">424</td><td colspan="7"></td></tr><tr><td class="h">425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::approve_pending_member</td></tr>
<tr><td class="h">427</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Approves someone&#39;s request to join a community.  This updates the [dbtable[authactions]] table</td></tr>
<tr><td class="h">428</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      as appropriate as well as does the regular join logic.  This also generates an e-mail to</td></tr>
<tr><td class="h">429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      be sent to the user notifying them of the acceptance.</td></tr>
<tr><td class="h">430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: commid, userid</td></tr>
<tr><td class="h">431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-commid: userid of the community</td></tr>
<tr><td class="h">432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-userid: userid of the user doing the join</td></tr>
<tr><td class="h">433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 on success, 0/undef on error</td></tr>
<tr><td class="h">434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">435</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub approve_pending_member {</td></tr>
<tr><td class="h">436</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L436">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($commid, $userid) = @_;</td></tr>
<tr><td class="h">437</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = LJ::want_user($commid);</td></tr>
<tr><td class="h">438</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::want_user($userid);</td></tr>
<tr><td class="h">439</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L439">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L439">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $cu &amp;&amp; $u;</td></tr>
<tr><td class="h">440</td><td colspan="7"></td></tr><tr><td class="h">441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 1, update authactions table</td></tr>
<tr><td class="h">442</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">443</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = $dbh-&gt;do(&quot;UPDATE authactions SET used = &#39;Y&#39; WHERE userid = ? AND arg1 = ?&quot;,</td></tr>
<tr><td class="h">444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid}, &quot;targetid=$u-&gt;{userid}&quot;);</td></tr>
<tr><td class="h">445</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L445">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $count;</td></tr>
<tr><td class="h">446</td><td colspan="7"></td></tr><tr><td class="h">447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 2, make user join the community</td></tr>
<tr><td class="h">448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# 1 means &quot;add community to user&#39;s friends list&quot;</td></tr>
<tr><td class="h">449</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L449">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless LJ::join_community( $u, $cu, 1, undef, moderated_add =&gt; 1 );</td></tr>
<tr><td class="h">450</td><td colspan="7"></td></tr><tr><td class="h">451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 3, email the user</td></tr>
<tr><td class="h">452</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %params = (event =&gt; &#39;CommunityJoinApprove&#39;, journal =&gt; $u);</td></tr>
<tr><td class="h">453</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L453">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($u-&gt;has_subscription(%params)) {</td></tr>
<tr><td class="h">454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe(%params, method =&gt; &#39;Email&#39;);</td></tr>
<tr><td class="h">455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">456</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L456">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Event::CommunityJoinApprove-&gt;new($u, $cu)-&gt;fire if LJ::is_enabled(&#39;esn&#39;);</td></tr>
<tr><td class="h">457</td><td colspan="7"></td></tr><tr><td class="h">458</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;memc_delete( &quot;pendingmemct&quot; );</td></tr>
<tr><td class="h">459</td><td colspan="7"></td></tr><tr><td class="h">460</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">462</td><td colspan="7"></td></tr><tr><td class="h">463</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::reject_pending_member</td></tr>
<tr><td class="h">465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Rejects someone&#39;s request to join a community.</td></tr>
<tr><td class="h">466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      Updates [dbtable[authactions]] and generates an e-mail to the user.</td></tr>
<tr><td class="h">467</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: commid, userid</td></tr>
<tr><td class="h">468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-commid: userid of the community</td></tr>
<tr><td class="h">469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-userid: userid of the user doing the join</td></tr>
<tr><td class="h">470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 on success, 0/undef on error</td></tr>
<tr><td class="h">471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub reject_pending_member {</td></tr>
<tr><td class="h">473</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L473">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($commid, $userid) = @_;</td></tr>
<tr><td class="h">474</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = LJ::want_user($commid);</td></tr>
<tr><td class="h">475</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::want_user($userid);</td></tr>
<tr><td class="h">476</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L476">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L476">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $cu &amp;&amp; $u;</td></tr>
<tr><td class="h">477</td><td colspan="7"></td></tr><tr><td class="h">478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 1, update authactions table</td></tr>
<tr><td class="h">479</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">480</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = $dbh-&gt;do(&quot;UPDATE authactions SET used = &#39;Y&#39; WHERE userid = ? AND arg1 = ?&quot;,</td></tr>
<tr><td class="h">481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $cu-&gt;{userid}, &quot;targetid=$u-&gt;{userid}&quot;);</td></tr>
<tr><td class="h">482</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L482">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $count;</td></tr>
<tr><td class="h">483</td><td colspan="7"></td></tr><tr><td class="h">484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 2, email the user</td></tr>
<tr><td class="h">485</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %params = (event =&gt; &#39;CommunityJoinReject&#39;, journal =&gt; $u);</td></tr>
<tr><td class="h">486</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L486">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($u-&gt;has_subscription(%params)) {</td></tr>
<tr><td class="h">487</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe(%params, method =&gt; &#39;Email&#39;);</td></tr>
<tr><td class="h">488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">489</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L489">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Event::CommunityJoinReject-&gt;new($u, $cu)-&gt;fire if LJ::is_enabled(&#39;esn&#39;);</td></tr>
<tr><td class="h">490</td><td colspan="7"></td></tr><tr><td class="h">491</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;memc_delete( &quot;pendingmemct&quot; );</td></tr>
<tr><td class="h">492</td><td colspan="7"></td></tr><tr><td class="h">493</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">494</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">495</td><td colspan="7"></td></tr><tr><td class="h">496</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">497</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::comm_join_request</td></tr>
<tr><td class="h">498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Registers an authaction to add a user to a</td></tr>
<tr><td class="h">499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      community and sends an approval email to the maintainers</td></tr>
<tr><td class="h">500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Hashref; output of LJ::register_authaction()</td></tr>
<tr><td class="h">501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          includes datecreate of old row if no new row was created</td></tr>
<tr><td class="h">502</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: comm, u</td></tr>
<tr><td class="h">503</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-comm: Community user object</td></tr>
<tr><td class="h">504</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: User object to add to community</td></tr>
<tr><td class="h">505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub comm_join_request {</td></tr>
<tr><td class="h">507</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L507">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($comm, $u) = @_;</td></tr>
<tr><td class="h">508</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L508">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L508">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless ref $comm &amp;&amp; ref $u;</td></tr>
<tr><td class="h">509</td><td colspan="7"></td></tr><tr><td class="h">510</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $arg = &quot;targetid=&quot; . $u-&gt;id;</td></tr>
<tr><td class="h">511</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">512</td><td colspan="7"></td></tr><tr><td class="h">513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check for duplicates within the same hour (to prevent spamming)</td></tr>
<tr><td class="h">514</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $oldaa = $dbh-&gt;selectrow_hashref(&quot;SELECT aaid, authcode, datecreate FROM authactions &quot; .</td></tr>
<tr><td class="h">515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid=? AND arg1=? &quot; .</td></tr>
<tr><td class="h">516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND action=&#39;comm_join_request&#39; AND used=&#39;N&#39; &quot; .</td></tr>
<tr><td class="h">517</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND NOW() &lt; datecreate + INTERVAL 1 HOUR &quot; .</td></tr>
<tr><td class="h">518</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ORDER BY 1 DESC LIMIT 1&quot;,</td></tr>
<tr><td class="h">519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $comm-&gt;id, $arg);</td></tr>
<tr><td class="h">520</td><td colspan="7"></td></tr><tr><td class="h">521</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L521">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $oldaa if $oldaa;</td></tr>
<tr><td class="h">522</td><td colspan="7"></td></tr><tr><td class="h">523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# insert authactions row</td></tr>
<tr><td class="h">524</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $aa = LJ::register_authaction($comm-&gt;id, &#39;comm_join_request&#39;, $arg);</td></tr>
<tr><td class="h">525</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L525">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $aa;</td></tr>
<tr><td class="h">526</td><td colspan="7"></td></tr><tr><td class="h">527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if there are older duplicates, invalidate any existing unused authactions of this type</td></tr>
<tr><td class="h">528</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE authactions SET used=&#39;Y&#39; WHERE userid=? AND aaid&lt;&gt;? AND arg1=? &quot; .</td></tr>
<tr><td class="h">529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND action=&#39;comm_invite&#39; AND used=&#39;N&#39;&quot;,</td></tr>
<tr><td class="h">530</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $comm-&gt;id, $aa-&gt;{&#39;aaid&#39;}, $arg);</td></tr>
<tr><td class="h">531</td><td colspan="7"></td></tr><tr><td class="h">532</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get maintainers of community</td></tr>
<tr><td class="h">533</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L533">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $adminids = LJ::load_rel_user($comm-&gt;{userid}, &#39;A&#39;) || [];</td></tr>
<tr><td class="h">534</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $admins = LJ::load_userids(@$adminids);</td></tr>
<tr><td class="h">535</td><td colspan="7"></td></tr><tr><td class="h">536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now prepare the emails</td></tr>
<tr><td class="h">537</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $au (values %$admins) {</td></tr>
<tr><td class="h">538</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L538">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L538">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $au &amp;&amp; !$au-&gt;is_expunged;</td></tr>
<tr><td class="h">539</td><td colspan="7"></td></tr><tr><td class="h">540</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# unless it&#39;s a hyphen, we need to migrate</td></tr>
<tr><td class="h">541</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $prop = $au-&gt;prop(&quot;opt_communityjoinemail&quot;);</td></tr>
<tr><td class="h">542</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L542">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($prop ne &quot;-&quot;) {</td></tr>
<tr><td class="h">543</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L543">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($prop ne &quot;N&quot;) {</td></tr>
<tr><td class="h">544</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %params = (event =&gt; &#39;CommunityJoinRequest&#39;, journal =&gt; $au);</td></tr>
<tr><td class="h">545</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L545">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($au-&gt;has_subscription(%params)) {</td></tr>
<tr><td class="h">546</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$au-&gt;subscribe(%params, method =&gt; $_) foreach qw(Inbox Email);</td></tr>
<tr><td class="h">547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">549</td><td colspan="7"></td></tr><tr><td class="h">550</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$au-&gt;set_prop(&quot;opt_communityjoinemail&quot;, &quot;-&quot;);</td></tr>
<tr><td class="h">551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">552</td><td colspan="7"></td></tr><tr><td class="h">553</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Event::CommunityJoinRequest-&gt;new($au, $u, $comm)-&gt;fire;</td></tr>
<tr><td class="h">554</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">555</td><td colspan="7"></td></tr><tr><td class="h">556</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$comm-&gt;memc_delete( &#39;pendingmemct&#39; );</td></tr>
<tr><td class="h">557</td><td colspan="7"></td></tr><tr><td class="h">558</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $aa;</td></tr>
<tr><td class="h">559</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">560</td><td colspan="7"></td></tr><tr><td class="h">561</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub maintainer_linkbar {</td></tr>
<tr><td class="h">562</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L562">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comm = shift;</td></tr>
<tr><td class="h">563</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $page = shift;</td></tr>
<tr><td class="h">564</td><td colspan="7"></td></tr><tr><td class="h">565</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $username = $comm-&gt;user;</td></tr>
<tr><td class="h">566</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @links;</td></tr>
<tr><td class="h">567</td><td colspan="7"></td></tr><tr><td class="h">568</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %manage_link_info = LJ::run_hook(&#39;community_manage_link_info&#39;, $username);</td></tr>
<tr><td class="h">569</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L569">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (keys %manage_link_info) {</td></tr>
<tr><td class="h">570</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L570">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @links, $page eq &quot;account&quot; ?</td></tr>
<tr><td class="h">571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;strong&gt;$manage_link_info{text}&lt;/strong&gt;&quot; :</td></tr>
<tr><td class="h">572</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$manage_link_info{url}&#39;&gt;$manage_link_info{text}&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">573</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">574</td><td colspan="7"></td></tr><tr><td class="h">575</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L575">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L575">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L575">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L575">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L575">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L575">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @links, (</td></tr>
<tr><td class="h">576</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$page eq &quot;profile&quot; ?</td></tr>
<tr><td class="h">577</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;strong&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.actinfo2&#39;) . &quot;&lt;/strong&gt;&quot; :</td></tr>
<tr><td class="h">578</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$LJ::SITEROOT/manage/profile/?authas=$username&#39;&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.actinfo2&#39;) . &quot;&lt;/a&gt;&quot;,</td></tr>
<tr><td class="h">579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$page eq &quot;customize&quot; ?</td></tr>
<tr><td class="h">580</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;strong&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.customize2&#39;) . &quot;&lt;/strong&gt;&quot; :</td></tr>
<tr><td class="h">581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$LJ::SITEROOT/customize/?authas=$username&#39;&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.customize2&#39;) . &quot;&lt;/a&gt;&quot;,</td></tr>
<tr><td class="h">582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$page eq &quot;settings&quot; ?</td></tr>
<tr><td class="h">583</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;strong&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.actsettings2&#39;) . &quot;&lt;/strong&gt;&quot; :</td></tr>
<tr><td class="h">584</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$LJ::SITEROOT/community/settings?authas=$username&#39;&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.actsettings2&#39;) . &quot;&lt;/a&gt;&quot;,</td></tr>
<tr><td class="h">585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$page eq &quot;invites&quot; ?</td></tr>
<tr><td class="h">586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;strong&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.actinvites&#39;) . &quot;&lt;/strong&gt;&quot; :</td></tr>
<tr><td class="h">587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$LJ::SITEROOT/community/sentinvites?authas=$username&#39;&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.actinvites&#39;) . &quot;&lt;/a&gt;&quot;,</td></tr>
<tr><td class="h">588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$page eq &quot;members&quot; ?</td></tr>
<tr><td class="h">589</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;strong&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.actmembers2&#39;) . &quot;&lt;/strong&gt;&quot; :</td></tr>
<tr><td class="h">590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$LJ::SITEROOT/community/members?authas=$username&#39;&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.actmembers2&#39;) . &quot;&lt;/a&gt;&quot;,</td></tr>
<tr><td class="h">591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$page eq &quot;queue&quot; ?</td></tr>
<tr><td class="h">592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;strong&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.queue&#39;) . &quot;&lt;/strong&gt;&quot; :</td></tr>
<tr><td class="h">593</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$LJ::SITEROOT/community/moderate?authas=$username&#39;&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.commlist.queue&#39; ) . &quot;&lt;/a&gt;&quot;,</td></tr>
<tr><td class="h">594</td><td colspan="7"></td></tr><tr><td class="h">595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">596</td><td colspan="7"></td></tr><tr><td class="h">597</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret .= &quot;&lt;strong&gt;&quot; . LJ::Lang::ml(&#39;/community/manage.bml.managelinks&#39;, { user =&gt; $comm-&gt;ljuser_display }) . &quot;&lt;/strong&gt; &quot;;</td></tr>
<tr><td class="h">598</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret .= join(&quot; | &quot;, @links);</td></tr>
<tr><td class="h">599</td><td colspan="7"></td></tr><tr><td class="h">600</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;p style=&#39;margin-bottom: 20px;&#39;&gt;$ret&lt;/p&gt;&quot;;</td></tr>
<tr><td class="h">601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">602</td><td colspan="7"></td></tr><tr><td class="h">603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Get membership and posting level settings for a community</td></tr>
<tr><td class="h">604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_comm_settings {</td></tr>
<tr><td class="h">605</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L605">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $c = shift;</td></tr>
<tr><td class="h">606</td><td colspan="7"></td></tr><tr><td class="h">607</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cid = $c-&gt;{userid};</td></tr>
<tr><td class="h">608</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($membership, $postlevel);</td></tr>
<tr><td class="h">609</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [ $cid, &quot;commsettings:$cid&quot; ];</td></tr>
<tr><td class="h">610</td><td colspan="7"></td></tr><tr><td class="h">611</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memval = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">612</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L612">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;($membership, $postlevel) = @$memval if ($memval);</td></tr>
<tr><td class="h">613</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L613">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L613">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ($membership, $postlevel)</td></tr>
<tr><td class="h">614</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $membership &amp;&amp; $postlevel );</td></tr>
<tr><td class="h">615</td><td colspan="7"></td></tr><tr><td class="h">616</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">617</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;($membership, $postlevel) =</td></tr>
<tr><td class="h">618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbr-&gt;selectrow_array(&quot;SELECT membership, postlevel FROM community WHERE userid=?&quot;, undef, $cid);</td></tr>
<tr><td class="h">619</td><td colspan="7"></td></tr><tr><td class="h">620</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L620">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L620">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, [$membership,$postlevel] ) if ( $membership &amp;&amp; $postlevel );</td></tr>
<tr><td class="h">621</td><td colspan="7"></td></tr><tr><td class="h">622</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ($membership, $postlevel);</td></tr>
<tr><td class="h">623</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">624</td><td colspan="7"></td></tr><tr><td class="h">625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Set membership and posting level settings for a community</td></tr>
<tr><td class="h">626</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_comm_settings {</td></tr>
<tr><td class="h">627</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L627">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($c, $u, $opts) = @_;</td></tr>
<tr><td class="h">628</td><td colspan="7"></td></tr><tr><td class="h">629</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L629">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;User cannot modify this community&quot;</td></tr>
<tr><td class="h">630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless (LJ::can_manage_other($u, $c));</td></tr>
<tr><td class="h">631</td><td colspan="7"></td></tr><tr><td class="h">632</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L632">0</a></div></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L632">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Membership and posting levels are not available&quot;</td></tr>
<tr><td class="h">633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{membership} &amp;&amp; $opts-&gt;{postlevel});</td></tr>
<tr><td class="h">634</td><td colspan="7"></td></tr><tr><td class="h">635</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cid = $c-&gt;{userid};</td></tr>
<tr><td class="h">636</td><td colspan="7"></td></tr><tr><td class="h">637</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">638</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;REPLACE INTO community (userid, membership, postlevel) VALUES (?,?,?)&quot; , undef, $cid, $opts-&gt;{membership}, $opts-&gt;{postlevel});</td></tr>
<tr><td class="h">639</td><td colspan="7"></td></tr><tr><td class="h">640</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [ $cid, &quot;commsettings:$cid&quot; ];</td></tr>
<tr><td class="h">641</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete($memkey);</td></tr>
<tr><td class="h">642</td><td colspan="7"></td></tr><tr><td class="h">643</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">645</td><td colspan="7"></td></tr><tr><td class="h">646</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_mod_queue_count {</td></tr>
<tr><td class="h">647</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L647">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = LJ::want_user( shift );</td></tr>
<tr><td class="h">648</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L648">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $cu-&gt;is_community;</td></tr>
<tr><td class="h">649</td><td colspan="7"></td></tr><tr><td class="h">650</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mqcount = $cu-&gt;memc_get( &#39;mqcount&#39; );</td></tr>
<tr><td class="h">651</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L651">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $mqcount if defined $mqcount;</td></tr>
<tr><td class="h">652</td><td colspan="7"></td></tr><tr><td class="h">653</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it&#39;s not in memcache, hit the db</td></tr>
<tr><td class="h">654</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_cluster_reader( $cu );</td></tr>
<tr><td class="h">655</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sql = &quot;SELECT COUNT(*) FROM modlog WHERE journalid=&quot; . $cu-&gt;id;</td></tr>
<tr><td class="h">656</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--condition.html#L656">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$mqcount = $dbr-&gt;selectrow_array( $sql ) || 0;</td></tr>
<tr><td class="h">657</td><td colspan="7"></td></tr><tr><td class="h">658</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# store in memcache for 10 minutes</td></tr>
<tr><td class="h">659</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;memc_set( &#39;mqcount&#39; =&gt; $mqcount, 600 );</td></tr>
<tr><td class="h">660</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $mqcount;</td></tr>
<tr><td class="h">661</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">662</td><td colspan="7"></td></tr><tr><td class="h">663</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_pending_members_count {</td></tr>
<tr><td class="h">664</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-communitylib-pl--subroutine.html#L664">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cu = LJ::want_user( shift );</td></tr>
<tr><td class="h">665</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L665">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $cu-&gt;is_community;</td></tr>
<tr><td class="h">666</td><td colspan="7"></td></tr><tr><td class="h">667</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pending_count = $cu-&gt;memc_get( &#39;pendingmemct&#39; );</td></tr>
<tr><td class="h">668</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-communitylib-pl--branch.html#L668">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $pending_count if defined $pending_count;</td></tr>
<tr><td class="h">669</td><td colspan="7"></td></tr><tr><td class="h">670</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# seems to be doing some additional parsing, which would make this</td></tr>
<tr><td class="h">671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# number potentially incorrect if you just do SELECT COUNT</td></tr>
<tr><td class="h">672</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so grab the parsed list and count it</td></tr>
<tr><td class="h">673</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$pending_count = scalar @{ LJ::get_pending_members( $cu ) };</td></tr>
<tr><td class="h">674</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cu-&gt;memc_set( &#39;pendingmemct&#39; =&gt; $pending_count, 600 );</td></tr>
<tr><td class="h">675</td><td colspan="7"></td></tr><tr><td class="h">676</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $pending_count;</td></tr>
<tr><td class="h">677</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">678</td><td colspan="7"></td></tr><tr><td class="h">679</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
