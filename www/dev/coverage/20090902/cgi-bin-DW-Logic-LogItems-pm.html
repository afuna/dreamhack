<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/DW/Logic/LogItems.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/DW/Logic/LogItems.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">1.6%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#!/usr/bin/perl</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># DW::Logic::LogItems</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Contains logic used to calculate what items should be showed on the reading page</td></tr>
<tr><td class="h">6</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># and other related functions.  Functions related to loading large numbers of entries</td></tr>
<tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># in a complicated fashion should be in here.  General purpose entry functionality</td></tr>
<tr><td class="h">8</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># should be in LJ::Entry, etc.</td></tr>
<tr><td class="h">9</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">10</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Authors:</td></tr>
<tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      Mark Smith &lt;mark@dreamwidth.org&gt;</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Copyright (c) 2009 by Dreamwidth Studios, LLC.</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is free software; you may redistribute it and/or modify it under</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># the same terms as Perl itself.  For a copy of the license, please reference</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &#39;perldoc perlartistic&#39; or &#39;perldoc perlgpl&#39;.</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">19</td><td colspan="7"></td></tr><tr><td class="h">20</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package DW::Logic::LogItems;</td></tr>
<tr><td class="h">21</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-Logic-LogItems-pm--subroutine.html#L21">80</a></div></td><td></td><td><div>0</div><div>4000</div><div>4000</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">22</td><td colspan="7"></td></tr><tr><td class="h">23</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-Logic-LogItems-pm--subroutine.html#L23">80</a></div></td><td></td><td><div>4000</div><div>0</div><div>0</div></td><td class="s">use Carp qw/ confess /;</td></tr>
<tr><td class="h">24</td><td colspan="7"></td></tr><tr><td class="h">25</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: $u-&gt;watch_items</td></tr>
<tr><td class="h">26</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Return watch list items for a given user, filter, and period.</td></tr>
<tr><td class="h">27</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: hash of items, key/values:</td></tr>
<tr><td class="h">28</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - remote</td></tr>
<tr><td class="h">29</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - itemshow</td></tr>
<tr><td class="h">30</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - skip</td></tr>
<tr><td class="h">31</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - filter  (opt) defaults to all</td></tr>
<tr><td class="h">32</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - friends (opt) friends rows loaded via [func[LJ::get_friends]]</td></tr>
<tr><td class="h">33</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - friends_u (opt) u objects of all friends loaded</td></tr>
<tr><td class="h">34</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - idsbycluster (opt) hashref to set clusterid key to [ [ journalid, itemid ]+ ]</td></tr>
<tr><td class="h">35</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - dateformat:  either &quot;S2&quot; for S2 code, or anything else for S1</td></tr>
<tr><td class="h">36</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - common_filter:  set true if this is the default view</td></tr>
<tr><td class="h">37</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - friendsoffriends: load friends of friends, not just friends</td></tr>
<tr><td class="h">38</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - showtypes: /[PICNYF]/</td></tr>
<tr><td class="h">39</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - events_date: date to load events for ($u must have friendspage_per_day)</td></tr>
<tr><td class="h">40</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Array of item hashrefs containing the same elements</td></tr>
<tr><td class="h">41</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub watch_items</td></tr>
<tr><td class="h">42</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">43</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--subroutine.html#L43">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">44</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L44">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">45</td><td colspan="7"></td></tr><tr><td class="h">46</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;id;</td></tr>
<tr><td class="h">47</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L47">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () if $LJ::FORCE_EMPTY_FRIENDS{$userid};</td></tr>
<tr><td class="h">48</td><td colspan="7"></td></tr><tr><td class="h">49</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L49">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader()</td></tr>
<tr><td class="h">50</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return ();</td></tr>
<tr><td class="h">51</td><td colspan="7"></td></tr><tr><td class="h">52</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::want_user( delete $args{remote} );</td></tr>
<tr><td class="h">53</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L53">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remoteid = $remote ? $remote-&gt;id : 0;</td></tr>
<tr><td class="h">54</td><td colspan="7"></td></tr><tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if ONLY_USER_VHOSTS is on (where each user gets his/her own domain),</td></tr>
<tr><td class="h">56</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# then assume we&#39;re also using domain-session cookies, and assume</td></tr>
<tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# domain session cookies should be as most useless as possible,</td></tr>
<tr><td class="h">58</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so don&#39;t let friends pages on other domains have protected content</td></tr>
<tr><td class="h">59</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# because really, nobody reads other people&#39;s friends pages anyway</td></tr>
<tr><td class="h">60</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L60">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L60">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::ONLY_USER_VHOSTS &amp;&amp; $remote &amp;&amp; $remoteid != $userid) {</td></tr>
<tr><td class="h">61</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote = undef;</td></tr>
<tr><td class="h">62</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remoteid = 0;</td></tr>
<tr><td class="h">63</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">64</td><td colspan="7"></td></tr><tr><td class="h">65</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @items = ();</td></tr>
<tr><td class="h">66</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemshow = $args{itemshow}+0;</td></tr>
<tr><td class="h">67</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $skip = $args{skip}+0;</td></tr>
<tr><td class="h">68</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $getitems = $itemshow + $skip;</td></tr>
<tr><td class="h">69</td><td colspan="7"></td></tr><tr><td class="h">70</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# friendspage per day is allowed only for journals with</td></tr>
<tr><td class="h">71</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# special cap &#39;friendspage_per_day&#39;</td></tr>
<tr><td class="h">72</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L72">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L72">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $events_date = ( ( $remoteid == $userid ) &amp;&amp; $u-&gt;get_cap(&#39;friendspage_per_day&#39;) )</td></tr>
<tr><td class="h">73</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? $args{events_date}</td></tr>
<tr><td class="h">74</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: &#39;&#39;;</td></tr>
<tr><td class="h">75</td><td colspan="7"></td></tr><tr><td class="h">76</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $filter  = int $args{filter};</td></tr>
<tr><td class="h">77</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L77">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $max_age = $LJ::MAX_FRIENDS_VIEW_AGE || 3600*24*14;  # 2 week default.</td></tr>
<tr><td class="h">78</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L78">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lastmax = $LJ::EndOfTime - ($events_date || (time() - $max_age));</td></tr>
<tr><td class="h">79</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lastmax_cutoff = 0; # if nonzero, never search for entries with rlogtime higher than this (set when cache in use)</td></tr>
<tr><td class="h">80</td><td colspan="7"></td></tr><tr><td class="h">81</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# sanity check:</td></tr>
<tr><td class="h">82</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L82">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$skip = 0 if $skip &lt; 0;</td></tr>
<tr><td class="h">83</td><td colspan="7"></td></tr><tr><td class="h">84</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# given a hash of friends rows, strip out rows with invalid journaltype</td></tr>
<tr><td class="h">85</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $filter_journaltypes = sub {</td></tr>
<tr><td class="h">86</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L86">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--subroutine.html#L86">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $friends, $friends_u, $memcache_only, $valid_types ) = @_;</td></tr>
<tr><td class="h">87</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L87">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L87">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless $friends &amp;&amp; $friends_u;</td></tr>
<tr><td class="h">88</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L88">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid_types ||= uc $args{showtypes};</td></tr>
<tr><td class="h">89</td><td colspan="7"></td></tr><tr><td class="h">90</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# make (F)eeds an alias for s(Y)ndicated</td></tr>
<tr><td class="h">91</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid_types =~ s/F/Y/g;</td></tr>
<tr><td class="h">92</td><td colspan="7"></td></tr><tr><td class="h">93</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# load u objects for all the given</td></tr>
<tr><td class="h">94</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userids_multiple([ map { $_, \$friends_u-&gt;{$_} } keys %$friends ], [$remote],</td></tr>
<tr><td class="h">95</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$memcache_only);</td></tr>
<tr><td class="h">96</td><td colspan="7"></td></tr><tr><td class="h">97</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# delete u objects based on &#39;showtypes&#39;</td></tr>
<tr><td class="h">98</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $fid ( keys %$friends_u ) {</td></tr>
<tr><td class="h">99</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fu = $friends_u-&gt;{$fid};</td></tr>
<tr><td class="h">100</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L100">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L100">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( ! $fu || ! $fu-&gt;is_visible ||</td></tr>
<tr><td class="h">101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid_types &amp;&amp; index(uc($valid_types), $fu-&gt;{journaltype}) == -1 )</td></tr>
<tr><td class="h">102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">103</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $friends_u-&gt;{$fid};</td></tr>
<tr><td class="h">104</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $friends-&gt;{$fid};</td></tr>
<tr><td class="h">105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">107</td><td colspan="7"></td></tr><tr><td class="h">108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# all args passed by reference</td></tr>
<tr><td class="h">109</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">110</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">111</td><td colspan="7"></td></tr><tr><td class="h">112</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @friends_buffer = ();</td></tr>
<tr><td class="h">113</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $fr_loaded = 0;  # flag:  have we loaded friends?</td></tr>
<tr><td class="h">114</td><td colspan="7"></td></tr><tr><td class="h">115</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# normal friends mode</td></tr>
<tr><td class="h">116</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $get_next_friend = sub {</td></tr>
<tr><td class="h">117</td><td colspan="7"></td></tr><tr><td class="h">118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# return one if we already have some loaded.</td></tr>
<tr><td class="h">119</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L119">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--subroutine.html#L119">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $friends_buffer[0] if @friends_buffer;</td></tr>
<tr><td class="h">120</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L120">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef if $fr_loaded;</td></tr>
<tr><td class="h">121</td><td colspan="7"></td></tr><tr><td class="h">122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get all friends for this user and groupmask</td></tr>
<tr><td class="h">123</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $friends = $u-&gt;watch_list( community_okay =&gt; 1 );</td></tr>
<tr><td class="h">124</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %friends_u;</td></tr>
<tr><td class="h">125</td><td colspan="7"></td></tr><tr><td class="h">126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# strip out rows with invalid journal types</td></tr>
<tr><td class="h">127</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filter_journaltypes-&gt;($friends, \%friends_u);</td></tr>
<tr><td class="h">128</td><td colspan="7"></td></tr><tr><td class="h">129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get update times for all the friendids</td></tr>
<tr><td class="h">130</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tu_opts = {};</td></tr>
<tr><td class="h">131</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fcount = scalar keys %$friends;</td></tr>
<tr><td class="h">132</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L132">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L132">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::SLOPPY_FRIENDS_THRESHOLD &amp;&amp; $fcount &gt; $LJ::SLOPPY_FRIENDS_THRESHOLD) {</td></tr>
<tr><td class="h">133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tu_opts-&gt;{memcache_only} = 1;</td></tr>
<tr><td class="h">134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">135</td><td colspan="7"></td></tr><tr><td class="h">136</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L136">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $times = $events_date</td></tr>
<tr><td class="h">137</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? LJ::get_times_multi($tu_opts, keys %$friends)</td></tr>
<tr><td class="h">138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: {updated =&gt; LJ::get_timeupdate_multi($tu_opts, keys %$friends)};</td></tr>
<tr><td class="h">139</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $timeupdate = $times-&gt;{updated};</td></tr>
<tr><td class="h">140</td><td colspan="7"></td></tr><tr><td class="h">141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# now push a properly formatted @friends_buffer row</td></tr>
<tr><td class="h">142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $fid (keys %$timeupdate) {</td></tr>
<tr><td class="h">143</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fu = $friends_u{$fid};</td></tr>
<tr><td class="h">144</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rupdate = $LJ::EndOfTime - $timeupdate-&gt;{$fid};</td></tr>
<tr><td class="h">145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $clusterid = $fu-&gt;{&#39;clusterid&#39;};</td></tr>
<tr><td class="h">146</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @friends_buffer, [ $fid, $rupdate, $clusterid, $friends-&gt;{$fid}, $fu ];</td></tr>
<tr><td class="h">147</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">148</td><td colspan="7"></td></tr><tr><td class="h">149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@friends_buffer =</td></tr>
<tr><td class="h">150</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L150">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L150">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort { $a-&gt;[1] &lt;=&gt; $b-&gt;[1] }</td></tr>
<tr><td class="h">151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep {</td></tr>
<tr><td class="h">152</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$timeupdate-&gt;{$_-&gt;[0]} &gt;= $lastmax and # reverse index</td></tr>
<tr><td class="h">153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($events_date</td></tr>
<tr><td class="h">154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? $times-&gt;{created}-&gt;{$_-&gt;[0]} &lt; $events_date</td></tr>
<tr><td class="h">155</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: 1</td></tr>
<tr><td class="h">156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">158</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@friends_buffer;</td></tr>
<tr><td class="h">159</td><td colspan="7"></td></tr><tr><td class="h">160</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# note that we&#39;ve already loaded the friends</td></tr>
<tr><td class="h">161</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fr_loaded = 1;</td></tr>
<tr><td class="h">162</td><td colspan="7"></td></tr><tr><td class="h">163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# return one if we just found some, else we&#39;re all</td></tr>
<tr><td class="h">164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# out and there&#39;s nobody else to load.</td></tr>
<tr><td class="h">165</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L165">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return @friends_buffer ? $friends_buffer[0] : undef;</td></tr>
<tr><td class="h">166</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">167</td><td colspan="7"></td></tr><tr><td class="h">168</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# memcached friends of friends mode</td></tr>
<tr><td class="h">169</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$get_next_friend = sub {</td></tr>
<tr><td class="h">170</td><td colspan="7"></td></tr><tr><td class="h">171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# return one if we already have some loaded.</td></tr>
<tr><td class="h">172</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L172">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--subroutine.html#L172">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $friends_buffer[0] if @friends_buffer;</td></tr>
<tr><td class="h">173</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L173">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef if $fr_loaded;</td></tr>
<tr><td class="h">174</td><td colspan="7"></td></tr><tr><td class="h">175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get journal&#39;s friends</td></tr>
<tr><td class="h">176</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L176">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $friends = $u-&gt;watch_list or return undef;</td></tr>
<tr><td class="h">177</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %friends_u;</td></tr>
<tr><td class="h">178</td><td colspan="7"></td></tr><tr><td class="h">179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fill %allfriends with all friendids and cut $friends</td></tr>
<tr><td class="h">180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# down to only include those that match $filter</td></tr>
<tr><td class="h">181</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %allfriends = ();</td></tr>
<tr><td class="h">182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $fid (keys %$friends) {</td></tr>
<tr><td class="h">183</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$allfriends{$fid}++;</td></tr>
<tr><td class="h">184</td><td colspan="7"></td></tr><tr><td class="h">185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# delete from friends if it doesn&#39;t match the filter</td></tr>
<tr><td class="h">186</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L186">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L186">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $filter &amp;&amp; ! ($friends-&gt;{$fid}-&gt;{&#39;groupmask&#39;}+0 &amp; $filter+0);</td></tr>
<tr><td class="h">187</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $friends-&gt;{$fid};</td></tr>
<tr><td class="h">188</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">189</td><td colspan="7"></td></tr><tr><td class="h">190</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# strip out invalid friend journaltypes</td></tr>
<tr><td class="h">191</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filter_journaltypes-&gt;($friends, \%friends_u, &quot;memcache_only&quot;, &quot;P&quot;);</td></tr>
<tr><td class="h">192</td><td colspan="7"></td></tr><tr><td class="h">193</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get update times for all the friendids</td></tr>
<tr><td class="h">194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $f_tu = LJ::get_timeupdate_multi({&#39;memcache_only&#39; =&gt; 1}, keys %$friends);</td></tr>
<tr><td class="h">195</td><td colspan="7"></td></tr><tr><td class="h">196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get friends of friends</td></tr>
<tr><td class="h">197</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ffct = 0;</td></tr>
<tr><td class="h">198</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %ffriends = ();</td></tr>
<tr><td class="h">199</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $fid (sort { $f_tu-&gt;{$b} &lt;=&gt; $f_tu-&gt;{$a} } keys %$friends) {</td></tr>
<tr><td class="h">200</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L200">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $ffct &gt; 50;</td></tr>
<tr><td class="h">201</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fu = $friends_u{$fid};</td></tr>
<tr><td class="h">202</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ff = $fu-&gt;watch_list( community_okay =&gt; 1, memcache_only =&gt; 1 );</td></tr>
<tr><td class="h">203</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ct = 0;</td></tr>
<tr><td class="h">204</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my $ffid = each %$ff) {</td></tr>
<tr><td class="h">205</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L205">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $ct &gt; 100;</td></tr>
<tr><td class="h">206</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L206">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L206">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $allfriends{$ffid} || $ffid == $userid;</td></tr>
<tr><td class="h">207</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ffriends{$ffid} = $ff-&gt;{$ffid};</td></tr>
<tr><td class="h">208</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ct++;</td></tr>
<tr><td class="h">209</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">210</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ffct++;</td></tr>
<tr><td class="h">211</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">212</td><td colspan="7"></td></tr><tr><td class="h">213</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# strip out invalid friendsfriends journaltypes</td></tr>
<tr><td class="h">214</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %ffriends_u;</td></tr>
<tr><td class="h">215</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filter_journaltypes-&gt;(\%ffriends, \%ffriends_u, &quot;memcache_only&quot;);</td></tr>
<tr><td class="h">216</td><td colspan="7"></td></tr><tr><td class="h">217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get update times for all the friendids</td></tr>
<tr><td class="h">218</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ff_tu = LJ::get_timeupdate_multi({&#39;memcache_only&#39; =&gt; 1}, keys %ffriends);</td></tr>
<tr><td class="h">219</td><td colspan="7"></td></tr><tr><td class="h">220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# build friends buffer</td></tr>
<tr><td class="h">221</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $ffid (sort { $ff_tu-&gt;{$b} &lt;=&gt; $ff_tu-&gt;{$a} } keys %$ff_tu) {</td></tr>
<tr><td class="h">222</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rupdate = $LJ::EndOfTime - $ff_tu-&gt;{$ffid};</td></tr>
<tr><td class="h">223</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $clusterid = $ffriends_u{$ffid}-&gt;{&#39;clusterid&#39;};</td></tr>
<tr><td class="h">224</td><td colspan="7"></td></tr><tr><td class="h">225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# since this is ff mode, we&#39;ll force colors to ffffff on 000000</td></tr>
<tr><td class="h">226</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ffriends{$ffid}-&gt;{&#39;fgcolor&#39;} = &quot;#000000&quot;;</td></tr>
<tr><td class="h">227</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ffriends{$ffid}-&gt;{&#39;bgcolor&#39;} = &quot;#ffffff&quot;;</td></tr>
<tr><td class="h">228</td><td colspan="7"></td></tr><tr><td class="h">229</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @friends_buffer, [ $ffid, $rupdate, $clusterid, $ffriends{$ffid}, $ffriends_u{$ffid} ];</td></tr>
<tr><td class="h">230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">231</td><td colspan="7"></td></tr><tr><td class="h">232</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@friends_buffer = sort { $a-&gt;[1] &lt;=&gt; $b-&gt;[1] } @friends_buffer;</td></tr>
<tr><td class="h">233</td><td colspan="7"></td></tr><tr><td class="h">234</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# note that we&#39;ve already loaded the friends</td></tr>
<tr><td class="h">235</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fr_loaded = 1;</td></tr>
<tr><td class="h">236</td><td colspan="7"></td></tr><tr><td class="h">237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# return one if we just found some fine, else we&#39;re all</td></tr>
<tr><td class="h">238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# out and there&#39;s nobody else to load.</td></tr>
<tr><td class="h">239</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L239">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return @friends_buffer ? $friends_buffer[0] : undef;</td></tr>
<tr><td class="h">240</td><td colspan="7"></td></tr><tr><td class="h">241</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L241">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L241">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} if $args{friendsoffriends} &amp;&amp; @LJ::MEMCACHE_SERVERS;</td></tr>
<tr><td class="h">242</td><td colspan="7"></td></tr><tr><td class="h">243</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# friends of friends disabled w/o memcache</td></tr>
<tr><td class="h">244</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L244">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L244">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;friends of friends mode requires memcache&#39;</td></tr>
<tr><td class="h">245</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $args{friendsoffriends} &amp;&amp; ! @LJ::MEMCACHE_SERVERS;</td></tr>
<tr><td class="h">246</td><td colspan="7"></td></tr><tr><td class="h">247</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $loop = 1;</td></tr>
<tr><td class="h">248</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemsleft = $getitems;  # even though we got a bunch, potentially, they could be old</td></tr>
<tr><td class="h">249</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $fr;</td></tr>
<tr><td class="h">250</td><td colspan="7"></td></tr><tr><td class="h">251</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L251">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while ($loop &amp;&amp; ($fr = $get_next_friend-&gt;()))</td></tr>
<tr><td class="h">252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">253</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shift @friends_buffer;</td></tr>
<tr><td class="h">254</td><td colspan="7"></td></tr><tr><td class="h">255</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# load the next recent updating friend&#39;s recent items</td></tr>
<tr><td class="h">256</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $friendid = $fr-&gt;[0];</td></tr>
<tr><td class="h">257</td><td colspan="7"></td></tr><tr><td class="h">258</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$args{friends}-&gt;{$friendid} = $fr-&gt;[3];  # friends row</td></tr>
<tr><td class="h">259</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$args{friends_u}-&gt;{$friendid} = $fr-&gt;[4]; # friend u object</td></tr>
<tr><td class="h">260</td><td colspan="7"></td></tr><tr><td class="h">261</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @newitems = LJ::get_log2_recent_user({</td></tr>
<tr><td class="h">262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;clusterid&#39;   =&gt; $fr-&gt;[2],</td></tr>
<tr><td class="h">263</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;userid&#39;      =&gt; $friendid,</td></tr>
<tr><td class="h">264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;remote&#39;      =&gt; $remote,</td></tr>
<tr><td class="h">265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;itemshow&#39;    =&gt; $itemsleft,</td></tr>
<tr><td class="h">266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;notafter&#39;    =&gt; $lastmax,</td></tr>
<tr><td class="h">267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;dateformat&#39;  =&gt; $args{dateformat},</td></tr>
<tr><td class="h">268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;update&#39;      =&gt; $LJ::EndOfTime - $fr-&gt;[1], # reverse back to normal</td></tr>
<tr><td class="h">269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;events_date&#39; =&gt; $events_date,</td></tr>
<tr><td class="h">270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">271</td><td colspan="7"></td></tr><tr><td class="h">272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# stamp each with clusterid if from cluster, so ljviews and other</td></tr>
<tr><td class="h">273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# callers will know which items are old (no/0 clusterid) and which</td></tr>
<tr><td class="h">274</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# are new</td></tr>
<tr><td class="h">275</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L275">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($fr-&gt;[2]) {</td></tr>
<tr><td class="h">276</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@newitems) { $_-&gt;{&#39;clusterid&#39;} = $fr-&gt;[2]; }</td></tr>
<tr><td class="h">277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">278</td><td colspan="7"></td></tr><tr><td class="h">279</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L279">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@newitems)</td></tr>
<tr><td class="h">280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">281</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @items, @newitems;</td></tr>
<tr><td class="h">282</td><td colspan="7"></td></tr><tr><td class="h">283</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$itemsleft--;</td></tr>
<tr><td class="h">284</td><td colspan="7"></td></tr><tr><td class="h">285</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# sort all the total items by rlogtime (recent at beginning).</td></tr>
<tr><td class="h">286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if there&#39;s an in-second tie, the &quot;newer&quot; post is determined by</td></tr>
<tr><td class="h">287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the higher jitemid, which means nothing if the posts aren&#39;t in</td></tr>
<tr><td class="h">288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the same journal, but means everything if they are (which happens</td></tr>
<tr><td class="h">289</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# almost never for a human, but all the time for RSS feeds, once we</td></tr>
<tr><td class="h">290</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# remove the synsucker&#39;s 1-second delay between postevents)</td></tr>
<tr><td class="h">291</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L291">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@items = sort { $a-&gt;{&#39;rlogtime&#39;} &lt;=&gt; $b-&gt;{&#39;rlogtime&#39;} ||</td></tr>
<tr><td class="h">292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$b-&gt;{&#39;jitemid&#39;}  &lt;=&gt; $a-&gt;{&#39;jitemid&#39;}     } @items;</td></tr>
<tr><td class="h">293</td><td colspan="7"></td></tr><tr><td class="h">294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# cut the list down to what we need.</td></tr>
<tr><td class="h">295</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L295">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@items = splice(@items, 0, $getitems) if (@items &gt; $getitems);</td></tr>
<tr><td class="h">296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">297</td><td colspan="7"></td></tr><tr><td class="h">298</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L298">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@items == $getitems)</td></tr>
<tr><td class="h">299</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">300</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lastmax = $items[-1]-&gt;{&#39;rlogtime&#39;};</td></tr>
<tr><td class="h">301</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L301">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L301">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lastmax = $lastmax_cutoff if $lastmax_cutoff &amp;&amp; $lastmax &gt; $lastmax_cutoff;</td></tr>
<tr><td class="h">302</td><td colspan="7"></td></tr><tr><td class="h">303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# stop looping if we know the next friend&#39;s newest entry</td></tr>
<tr><td class="h">304</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# is greater (older) than the oldest one we&#39;ve already</td></tr>
<tr><td class="h">305</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# loaded.</td></tr>
<tr><td class="h">306</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $nextfr = $get_next_friend-&gt;();</td></tr>
<tr><td class="h">307</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L307">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L307">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$loop = 0 if ($nextfr &amp;&amp; $nextfr-&gt;[1] &gt; $lastmax);</td></tr>
<tr><td class="h">308</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">310</td><td colspan="7"></td></tr><tr><td class="h">311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove skipped ones</td></tr>
<tr><td class="h">312</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L312">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;splice(@items, 0, $skip) if $skip;</td></tr>
<tr><td class="h">313</td><td colspan="7"></td></tr><tr><td class="h">314</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get items</td></tr>
<tr><td class="h">315</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (@items) {</td></tr>
<tr><td class="h">316</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$args{owners}-&gt;{$_-&gt;{&#39;ownerid&#39;}} = 1;</td></tr>
<tr><td class="h">317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">318</td><td colspan="7"></td></tr><tr><td class="h">319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return the itemids grouped by clusters, if callers wants it.</td></tr>
<tr><td class="h">320</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L320">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref $args{idsbycluster} eq &quot;HASH&quot;) {</td></tr>
<tr><td class="h">321</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@items) {</td></tr>
<tr><td class="h">322</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$args{idsbycluster}-&gt;{$_-&gt;{&#39;clusterid&#39;}}},</td></tr>
<tr><td class="h">323</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ $_-&gt;{&#39;ownerid&#39;}, $_-&gt;{&#39;itemid&#39;} ];</td></tr>
<tr><td class="h">324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">326</td><td colspan="7"></td></tr><tr><td class="h">327</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @items;</td></tr>
<tr><td class="h">328</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::watch_items = \&amp;watch_items;</td></tr>
<tr><td class="h">330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*DW::User::watch_items = \&amp;watch_items;</td></tr>
<tr><td class="h">331</td><td colspan="7"></td></tr><tr><td class="h">332</td><td colspan="7"></td></tr><tr><td class="h">333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: $u-&gt;recent_items</td></tr>
<tr><td class="h">334</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Returns journal entries for a given account.</td></tr>
<tr><td class="h">335</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># takes hash of options as arguments</td></tr>
<tr><td class="h">336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- err: scalar ref to return error code/msg in</td></tr>
<tr><td class="h">337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- remote: remote user&#39;s $u</td></tr>
<tr><td class="h">338</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- clusterid: clusterid of userid</td></tr>
<tr><td class="h">339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- tagids: arrayref of tagids to return entries with</td></tr>
<tr><td class="h">340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- security: (public|friends|private) or a group number</td></tr>
<tr><td class="h">341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- clustersource: if value &#39;slave&#39;, uses replicated databases</td></tr>
<tr><td class="h">342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- order: if &#39;logtime&#39;, sorts by logtime, not eventtime</td></tr>
<tr><td class="h">343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- friendsview: if true, sorts by logtime, not eventtime</td></tr>
<tr><td class="h">344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- notafter: upper bound inclusive for rlogtime/revttime (depending on sort mode),</td></tr>
<tr><td class="h">345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           defaults to no limit</td></tr>
<tr><td class="h">346</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- skip: items to skip</td></tr>
<tr><td class="h">347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- itemshow: items to show</td></tr>
<tr><td class="h">348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- viewall: if set, no security is used.</td></tr>
<tr><td class="h">349</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- dateformat: if &quot;S2&quot;, uses S2&#39;s &#39;alldatepart&#39; format.</td></tr>
<tr><td class="h">350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           -- itemids: optional arrayref onto which itemids should be pushed</td></tr>
<tr><td class="h">351</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: array of hashrefs containing keys:</td></tr>
<tr><td class="h">352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          -- itemid (the jitemid)</td></tr>
<tr><td class="h">353</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          -- posterid</td></tr>
<tr><td class="h">354</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          -- security</td></tr>
<tr><td class="h">355</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          -- alldatepart (in S1 or S2 fmt, depending on &#39;dateformat&#39; req key)</td></tr>
<tr><td class="h">356</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          -- system_alldatepart (same as above, but for the system time)</td></tr>
<tr><td class="h">357</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          -- ownerid (if in &#39;friendsview&#39; mode)</td></tr>
<tr><td class="h">358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          -- rlogtime (if in &#39;friendsview&#39; mode)</td></tr>
<tr><td class="h">359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub recent_items</td></tr>
<tr><td class="h">360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">361</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--subroutine.html#L361">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">362</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L362">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">363</td><td colspan="7"></td></tr><tr><td class="h">364</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;id;</td></tr>
<tr><td class="h">365</td><td colspan="7"></td></tr><tr><td class="h">366</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @items = ();             # what we&#39;ll return</td></tr>
<tr><td class="h">367</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = $args{err};</td></tr>
<tr><td class="h">368</td><td colspan="7"></td></tr><tr><td class="h">369</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::want_user( delete $args{remote} );</td></tr>
<tr><td class="h">370</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L370">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remoteid = $remote ? $remote-&gt;id : 0;</td></tr>
<tr><td class="h">371</td><td colspan="7"></td></tr><tr><td class="h">372</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $max_hints = $LJ::MAX_SCROLLBACK_LASTN;  # temporary</td></tr>
<tr><td class="h">373</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sort_key = &quot;revttime&quot;;</td></tr>
<tr><td class="h">374</td><td colspan="7"></td></tr><tr><td class="h">375</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $clusterid = $args{&#39;clusterid&#39;}+0;</td></tr>
<tr><td class="h">376</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @sources = (&quot;cluster$clusterid&quot;);</td></tr>
<tr><td class="h">377</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L377">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $ab = $LJ::CLUSTER_PAIR_ACTIVE{$clusterid}) {</td></tr>
<tr><td class="h">378</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@sources = (&quot;cluster${clusterid}${ab}&quot;);</td></tr>
<tr><td class="h">379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">380</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L380">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unshift @sources, (&quot;cluster${clusterid}lite&quot;, &quot;cluster${clusterid}slave&quot;)</td></tr>
<tr><td class="h">381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $args{&#39;clustersource&#39;} eq &quot;slave&quot;;</td></tr>
<tr><td class="h">382</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $logdb = LJ::get_dbh(@sources);</td></tr>
<tr><td class="h">383</td><td colspan="7"></td></tr><tr><td class="h">384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# community/friend views need to post by log time, not event time</td></tr>
<tr><td class="h">385</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L385">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L385">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sort_key = &quot;rlogtime&quot; if ($args{&#39;order&#39;} eq &quot;logtime&quot; ||</td></tr>
<tr><td class="h">386</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$args{&#39;friendsview&#39;});</td></tr>
<tr><td class="h">387</td><td colspan="7"></td></tr><tr><td class="h">388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# &#39;notafter&#39;:</td></tr>
<tr><td class="h">389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   the friends view doesn&#39;t want to load things that it knows it</td></tr>
<tr><td class="h">390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   won&#39;t be able to use.  if this argument is zero or undefined,</td></tr>
<tr><td class="h">391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   then we&#39;ll load everything less than or equal to 1 second from</td></tr>
<tr><td class="h">392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   the end of time.  we don&#39;t include the last end of time second</td></tr>
<tr><td class="h">393</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   because that&#39;s what backdated entries are set to.  (so for one</td></tr>
<tr><td class="h">394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   second at the end of time we&#39;ll have a flashback of all those</td></tr>
<tr><td class="h">395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   backdated entries... but then the world explodes and everybody</td></tr>
<tr><td class="h">396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   with 32 bit time_t structs dies)</td></tr>
<tr><td class="h">397</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L397">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $notafter = $args{&#39;notafter&#39;} + 0 || $LJ::EndOfTime - 1;</td></tr>
<tr><td class="h">398</td><td colspan="7"></td></tr><tr><td class="h">399</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $skip = $args{&#39;skip&#39;}+0;</td></tr>
<tr><td class="h">400</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemshow = $args{&#39;itemshow&#39;}+0;</td></tr>
<tr><td class="h">401</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L401">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($itemshow &gt; $max_hints) { $itemshow = $max_hints; }</td></tr>
<tr><td class="h">402</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $maxskip = $max_hints - $itemshow;</td></tr>
<tr><td class="h">403</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L403">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($skip &lt; 0) { $skip = 0; }</td></tr>
<tr><td class="h">404</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L404">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($skip &gt; $maxskip) { $skip = $maxskip; }</td></tr>
<tr><td class="h">405</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemload = $itemshow + $skip;</td></tr>
<tr><td class="h">406</td><td colspan="7"></td></tr><tr><td class="h">407</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mask = 0;</td></tr>
<tr><td class="h">408</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L408">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L408">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $remote &amp;&amp; ( $remote-&gt;is_person || $remote-&gt;is_identity ) &amp;&amp; $remoteid != $userid ) {</td></tr>
<tr><td class="h">409</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if this is a community we&#39;re viewing, fake the mask to select on, as communities</td></tr>
<tr><td class="h">410</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# no longer have masks to users</td></tr>
<tr><td class="h">411</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L411">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;is_community ) {</td></tr>
<tr><td class="h">412</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L412">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mask = $remote-&gt;member_of( $u ) ? 1 : 0;</td></tr>
<tr><td class="h">413</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">414</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mask = $u-&gt;trustmask( $remote );</td></tr>
<tr><td class="h">415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">417</td><td colspan="7"></td></tr><tr><td class="h">418</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# decide what level of security the remote user can see</td></tr>
<tr><td class="h">419</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $secwhere = &quot;&quot;;</td></tr>
<tr><td class="h">420</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L420">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L420">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L420">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($userid == $remoteid || $args{&#39;viewall&#39;}) {</td></tr>
<tr><td class="h">421</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# no extra where restrictions... user can see all their own stuff</td></tr>
<tr><td class="h">422</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# alternatively, if &#39;viewall&#39; opt flag is set, security is off.</td></tr>
<tr><td class="h">423</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($mask) {</td></tr>
<tr><td class="h">424</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# can see public or things with them in the mask</td></tr>
<tr><td class="h">425</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$secwhere = &quot;AND (security=&#39;public&#39; OR (security=&#39;usemask&#39; AND allowmask &amp; $mask != 0))&quot;;</td></tr>
<tr><td class="h">426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">427</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# not a friend?  only see public.</td></tr>
<tr><td class="h">428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$secwhere = &quot;AND security=&#39;public&#39; &quot;;</td></tr>
<tr><td class="h">429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">430</td><td colspan="7"></td></tr><tr><td class="h">431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# because LJ::get_friend_items needs rlogtime for sorting.</td></tr>
<tr><td class="h">432</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $extra_sql;</td></tr>
<tr><td class="h">433</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L433">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($args{&#39;friendsview&#39;}) {</td></tr>
<tr><td class="h">434</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extra_sql .= &quot;journalid AS &#39;ownerid&#39;, rlogtime, &quot;;</td></tr>
<tr><td class="h">435</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">436</td><td colspan="7"></td></tr><tr><td class="h">437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we need to get by tag, get an itemid list now</td></tr>
<tr><td class="h">438</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jitemidwhere;</td></tr>
<tr><td class="h">439</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L439">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L439">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref $args{tagids} eq &#39;ARRAY&#39; &amp;&amp; @{$args{tagids}}) {</td></tr>
<tr><td class="h">440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# select jitemids uniquely</td></tr>
<tr><td class="h">441</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&#39;,&#39;, map { $_+0 } @{$args{tagids}});</td></tr>
<tr><td class="h">442</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $jitemids = $logdb-&gt;selectcol_arrayref(qq{</td></tr>
<tr><td class="h">443</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT DISTINCT jitemid FROM logtagsrecent WHERE journalid = ? AND kwid IN ($in)</td></tr>
<tr><td class="h">444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, undef, $userid);</td></tr>
<tr><td class="h">445</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L445">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die $logdb-&gt;errstr if $logdb-&gt;err;</td></tr>
<tr><td class="h">446</td><td colspan="7"></td></tr><tr><td class="h">447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# set $jitemidwhere iff we have jitemids</td></tr>
<tr><td class="h">448</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L448">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@$jitemids) {</td></tr>
<tr><td class="h">449</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$jitemidwhere = &quot; AND jitemid IN (&quot; .</td></tr>
<tr><td class="h">450</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;join(&#39;,&#39;, map { $_+0 } @$jitemids) .</td></tr>
<tr><td class="h">451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;)&quot;;</td></tr>
<tr><td class="h">452</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# no items, so show no entries</td></tr>
<tr><td class="h">454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ();</td></tr>
<tr><td class="h">455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">456</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">457</td><td colspan="7"></td></tr><tr><td class="h">458</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we need to filter by security, build up the where clause for that too</td></tr>
<tr><td class="h">459</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $securitywhere;</td></tr>
<tr><td class="h">460</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L460">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($args{&#39;security&#39;}) {</td></tr>
<tr><td class="h">461</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $security = $args{&#39;security&#39;};</td></tr>
<tr><td class="h">462</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L462">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L462">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L462">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L462">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (($security eq &quot;public&quot;) || ($security eq &quot;private&quot;)) {</td></tr>
<tr><td class="h">463</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$securitywhere = &quot; AND security = \&quot;$security\&quot;&quot;;</td></tr>
<tr><td class="h">464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elsif ($security eq &quot;friends&quot;) {</td></tr>
<tr><td class="h">466</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$securitywhere = &quot; AND security = \&quot;usemask\&quot; AND allowmask = 1&quot;;</td></tr>
<tr><td class="h">467</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elsif ($security=~/^\d+$/) {</td></tr>
<tr><td class="h">469</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$securitywhere = &quot; AND security = \&quot;usemask\&quot; AND (allowmask &amp; &quot; . (1 &lt;&lt; $security) . &quot;)&quot;;</td></tr>
<tr><td class="h">470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">472</td><td colspan="7"></td></tr><tr><td class="h">473</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sql;</td></tr>
<tr><td class="h">474</td><td colspan="7"></td></tr><tr><td class="h">475</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dateformat = &quot;%a %W %b %M %y %Y %c %m %e %d %D %p %i %l %h %k %H&quot;;</td></tr>
<tr><td class="h">476</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L476">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($args{&#39;dateformat&#39;} eq &quot;S2&quot;) {</td></tr>
<tr><td class="h">477</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dateformat = &quot;%Y %m %d %H %i %s %w&quot;; # yyyy mm dd hh mm ss day_of_week</td></tr>
<tr><td class="h">478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">479</td><td colspan="7"></td></tr><tr><td class="h">480</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($sql_limit, $sql_select) = (&#39;&#39;, &#39;&#39;);</td></tr>
<tr><td class="h">481</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L481">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($args{&#39;ymd&#39;}) {</td></tr>
<tr><td class="h">482</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($year, $month, $day);</td></tr>
<tr><td class="h">483</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L483">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($args{&#39;ymd&#39;} =~ m!^(\d\d\d\d)/(\d\d)/(\d\d)\b!) {</td></tr>
<tr><td class="h">484</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($year, $month, $day) = ($1, $2, $3);</td></tr>
<tr><td class="h">485</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# check</td></tr>
<tr><td class="h">486</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L486">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($year !~ /^\d+$/) { $$err = &quot;Corrupt or non-existant year.&quot;; return (); }</td></tr>
<tr><td class="h">487</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L487">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($month !~ /^\d+$/) { $$err = &quot;Corrupt or non-existant month.&quot; ; return (); }</td></tr>
<tr><td class="h">488</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L488">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($day !~ /^\d+$/) { $$err = &quot;Corrupt or non-existant day.&quot; ; return (); }</td></tr>
<tr><td class="h">489</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L489">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L489">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($month &lt; 1 || $month &gt; 12 || int($month) != $month) { $$err = &quot;Invalid month.&quot; ; return (); }</td></tr>
<tr><td class="h">490</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L490">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L490">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($year &lt; 1970 || $year &gt; 2038 || int($year) != $year) { $$err = &quot;Invalid year: $year&quot;; return (); }</td></tr>
<tr><td class="h">491</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L491">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--condition.html#L491">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($day &lt; 1 || $day &gt; 31 || int($day) != $day) { $$err = &quot;Invalid day.&quot;; return (); }</td></tr>
<tr><td class="h">492</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L492">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($day &gt; LJ::days_in_month($month, $year)) { $$err = &quot;That month doesn&#39;t have that many days.&quot;; return (); }</td></tr>
<tr><td class="h">493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$err = &quot;wrong date: &quot; . $args{&#39;ymd&#39;};</td></tr>
<tr><td class="h">495</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ();</td></tr>
<tr><td class="h">496</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">497</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_limit  = &quot;LIMIT 200&quot;;</td></tr>
<tr><td class="h">498</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_select = &quot;AND year=$year AND month=$month AND day=$day&quot;;</td></tr>
<tr><td class="h">499</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extra_sql .= &quot;allowmask, &quot;;</td></tr>
<tr><td class="h">500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">501</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_limit  = &quot;LIMIT $skip,$itemshow&quot;;</td></tr>
<tr><td class="h">502</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_select = &quot;AND $sort_key &lt;= $notafter&quot;;</td></tr>
<tr><td class="h">503</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">504</td><td colspan="7"></td></tr><tr><td class="h">505</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sql = qq{</td></tr>
<tr><td class="h">506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT jitemid AS &#39;itemid&#39;, posterid, security, $extra_sql</td></tr>
<tr><td class="h">507</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATE_FORMAT(eventtime, &quot;$dateformat&quot;) AS &#39;alldatepart&#39;, anum,</td></tr>
<tr><td class="h">508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATE_FORMAT(logtime, &quot;$dateformat&quot;) AS &#39;system_alldatepart&#39;,</td></tr>
<tr><td class="h">509</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowmask, eventtime, logtime</td></tr>
<tr><td class="h">510</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM log2 USE INDEX ($sort_key)</td></tr>
<tr><td class="h">511</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE journalid=$userid $sql_select $secwhere $jitemidwhere $securitywhere</td></tr>
<tr><td class="h">512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ORDER BY journalid, $sort_key</td></tr>
<tr><td class="h">513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_limit</td></tr>
<tr><td class="h">514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">515</td><td colspan="7"></td></tr><tr><td class="h">516</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L516">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($logdb) {</td></tr>
<tr><td class="h">517</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L517">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$err = &quot;nodb&quot; if ref $err eq &quot;SCALAR&quot;;</td></tr>
<tr><td class="h">518</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ();</td></tr>
<tr><td class="h">519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">520</td><td colspan="7"></td></tr><tr><td class="h">521</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $logdb-&gt;prepare($sql);</td></tr>
<tr><td class="h">522</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">523</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L523">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($logdb-&gt;err) { die $logdb-&gt;errstr; }</td></tr>
<tr><td class="h">524</td><td colspan="7"></td></tr><tr><td class="h">525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# keep track of the last alldatepart, and a per-minute buffer</td></tr>
<tr><td class="h">526</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $last_time;</td></tr>
<tr><td class="h">527</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @buf;</td></tr>
<tr><td class="h">528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $flush = sub {</td></tr>
<tr><td class="h">529</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L529">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-Logic-LogItems-pm--subroutine.html#L529">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless @buf;</td></tr>
<tr><td class="h">530</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @items, sort { $b-&gt;{itemid} &lt;=&gt; $a-&gt;{itemid} } @buf;</td></tr>
<tr><td class="h">531</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@buf = ();</td></tr>
<tr><td class="h">532</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">533</td><td colspan="7"></td></tr><tr><td class="h">534</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my $li = $sth-&gt;fetchrow_hashref) {</td></tr>
<tr><td class="h">535</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$args{&#39;itemids&#39;}}, $li-&gt;{&#39;itemid&#39;};</td></tr>
<tr><td class="h">536</td><td colspan="7"></td></tr><tr><td class="h">537</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-Logic-LogItems-pm--branch.html#L537">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flush-&gt;() if $li-&gt;{alldatepart} ne $last_time;</td></tr>
<tr><td class="h">538</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @buf, $li;</td></tr>
<tr><td class="h">539</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last_time = $li-&gt;{alldatepart};</td></tr>
<tr><td class="h">540</td><td colspan="7"></td></tr><tr><td class="h">541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# construct an LJ::Entry singleton</td></tr>
<tr><td class="h">542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new($userid, jitemid =&gt; $li-&gt;{itemid});</td></tr>
<tr><td class="h">543</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;absorb_row(%$li);</td></tr>
<tr><td class="h">544</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">545</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flush-&gt;();</td></tr>
<tr><td class="h">546</td><td colspan="7"></td></tr><tr><td class="h">547</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @items;</td></tr>
<tr><td class="h">548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">549</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::recent_items = \&amp;recent_items;</td></tr>
<tr><td class="h">550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*DW::User::recent_items = \&amp;recent_items;</td></tr>
<tr><td class="h">551</td><td colspan="7"></td></tr><tr><td class="h">552</td><td colspan="7"></td></tr><tr><td class="h">553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
