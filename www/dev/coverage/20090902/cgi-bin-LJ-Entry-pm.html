<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/LJ/Entry.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/LJ/Entry.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">22.8%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># LiveJournal entry object.</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Just framing right now, not much to see here!</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">6</td><td colspan="7"></td></tr><tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ::Entry;</td></tr>
<tr><td class="h">8</td><td><div class="c3">72</div><div class="c3">72</div><div class="c3">72</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L8">72</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">9</td><td><div class="c3">72</div><div class="c3">72</div><div class="c3">72</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L9">72</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use vars qw/ $AUTOLOAD /;</td></tr>
<tr><td class="h">10</td><td><div class="c3">72</div><div class="c3">72</div><div class="c3">72</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L10">72</a></div></td><td></td><td><div>0</div><div>4000</div><div>0</div></td><td class="s">use Carp qw/ croak confess /;</td></tr>
<tr><td class="h">11</td><td colspan="7"></td></tr><tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># internal fields:</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    u: object, always present</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    anum:    lazily loaded, either by ctor or _loaded_row</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    ditemid: lazily loaded</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    jitemid: always present</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    props:   hashref of props,  loaded if _loaded_props</td></tr>
<tr><td class="h">19</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    subject: text of subject,   loaded if _loaded_text</td></tr>
<tr><td class="h">20</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    event:   text of log event, loaded if _loaded_text</td></tr>
<tr><td class="h">21</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    subject_orig: text of subject without transcoding,   present if unknown8bit</td></tr>
<tr><td class="h">22</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    event_orig:   text of log event without transcoding, present if unknown8bit</td></tr>
<tr><td class="h">23</td><td colspan="7"></td></tr><tr><td class="h">24</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    eventtime:  mysql datetime of event, loaded if _loaded_row</td></tr>
<tr><td class="h">25</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    logtime:    mysql datetime of event, loaded if _loaded_row</td></tr>
<tr><td class="h">26</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    security:   &quot;public&quot;, &quot;private&quot;, &quot;usemask&quot;, loaded if _loaded_row</td></tr>
<tr><td class="h">27</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    allowmask:  if _loaded_row</td></tr>
<tr><td class="h">28</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    posterid:   if _loaded_row</td></tr>
<tr><td class="h">29</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    comments:   arrayref of comment objects on this entry</td></tr>
<tr><td class="h">30</td><td colspan="7"></td></tr><tr><td class="h">31</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    userpic</td></tr>
<tr><td class="h">32</td><td colspan="7"></td></tr><tr><td class="h">33</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    _loaded_text:     loaded subject/text</td></tr>
<tr><td class="h">34</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    _loaded_row:      loaded log2 row</td></tr>
<tr><td class="h">35</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    _loaded_props:    loaded props</td></tr>
<tr><td class="h">36</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    _loaded_comments: loaded comments</td></tr>
<tr><td class="h">37</td><td colspan="7"></td></tr><tr><td class="h">38</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">my %singletons = (); # journalid-&gt;jitemid-&gt;singleton</td></tr>
<tr><td class="h">39</td><td colspan="7"></td></tr><tr><td class="h">40</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub reset_singletons {</td></tr>
<tr><td class="h">41</td><td><div class="c3">9</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L41">9</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;%singletons = ();</td></tr>
<tr><td class="h">42</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">43</td><td colspan="7"></td></tr><tr><td class="h">44</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">45</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::Entry::new</td></tr>
<tr><td class="h">46</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: entry</td></tr>
<tr><td class="h">47</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets a journal entry.</td></tr>
<tr><td class="h">48</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuserid, opts</td></tr>
<tr><td class="h">49</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: A user id or user object ($u ) to load the entry for.</td></tr>
<tr><td class="h">50</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: Hash of optional keypairs.</td></tr>
<tr><td class="h">51</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           &#39;jitemid&#39; =&gt; a journal itemid (no anum)</td></tr>
<tr><td class="h">52</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           &#39;ditemid&#39; =&gt; display itemid (a jitemid &lt;&lt; 8 + anum)</td></tr>
<tr><td class="h">53</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           &#39;anum&#39;    =&gt; the id passed was an ditemid, use the anum</td></tr>
<tr><td class="h">54</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                        to create a proper jitemid.</td></tr>
<tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: A new LJ::Entry object.  undef on failure.</td></tr>
<tr><td class="h">56</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new</td></tr>
<tr><td class="h">58</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">59</td><td><div class="c3">775</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L59">775</a></div></td><td><div class="c0">0</div></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">60</td><td><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self  = bless {};</td></tr>
<tr><td class="h">61</td><td colspan="7"></td></tr><tr><td class="h">62</td><td><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uuserid = shift;</td></tr>
<tr><td class="h">63</td><td><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $n_arg   = scalar @_;</td></tr>
<tr><td class="h">64</td><td><div class="c3">775</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L64">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L64">33</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;wrong number of arguments&quot;)</td></tr>
<tr><td class="h">65</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $n_arg &amp;&amp; ($n_arg % 2 == 0);</td></tr>
<tr><td class="h">66</td><td colspan="7"></td></tr><tr><td class="h">67</td><td><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %opts = @_;</td></tr>
<tr><td class="h">68</td><td colspan="7"></td></tr><tr><td class="h">69</td><td><div class="c3">775</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L69">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L69">67</a></div></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;can&#39;t supply both anum and ditemid&quot;)</td></tr>
<tr><td class="h">70</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if defined $opts{anum} &amp;&amp; defined $opts{ditemid};</td></tr>
<tr><td class="h">71</td><td colspan="7"></td></tr><tr><td class="h">72</td><td><div class="c3">775</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L72">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L72">67</a></div></td><td></td><td></td><td><div>20000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;can&#39;t supply both itemid and ditemid&quot;)</td></tr>
<tr><td class="h">73</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if defined $opts{ditemid} &amp;&amp; defined $opts{jitemid};</td></tr>
<tr><td class="h">74</td><td colspan="7"></td></tr><tr><td class="h">75</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: don&#39;t store $u in here, or at least call LJ::load_userids() on all singletons</td></tr>
<tr><td class="h">76</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#        if LJ::want_user() would have been called</td></tr>
<tr><td class="h">77</td><td><div class="c3">775</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L77">50</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{u}       = LJ::want_user($uuserid) or croak(&quot;invalid user/userid parameter: $uuserid&quot;);</td></tr>
<tr><td class="h">78</td><td colspan="7"></td></tr><tr><td class="h">79</td><td><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{anum}    = delete $opts{anum};</td></tr>
<tr><td class="h">80</td><td><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{ditemid} = delete $opts{ditemid};</td></tr>
<tr><td class="h">81</td><td><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{jitemid} = delete $opts{jitemid};</td></tr>
<tr><td class="h">82</td><td colspan="7"></td></tr><tr><td class="h">83</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make arguments numeric</td></tr>
<tr><td class="h">84</td><td><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;for my $f (qw(ditemid jitemid anum)) {</td></tr>
<tr><td class="h">85</td><td><div class="c3">2325</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L85">100</a></div></td><td></td><td></td><td></td><td><div>32002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{$f} = int($self-&gt;{$f}) if defined $self-&gt;{$f};</td></tr>
<tr><td class="h">86</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">87</td><td colspan="7"></td></tr><tr><td class="h">88</td><td><div class="c3">775</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L88">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L88">67</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;need to supply either a jitemid or ditemid&quot;)</td></tr>
<tr><td class="h">89</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless defined $self-&gt;{ditemid} || defined $self-&gt;{jitemid};</td></tr>
<tr><td class="h">90</td><td colspan="7"></td></tr><tr><td class="h">91</td><td><div class="c3">775</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L91">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;Unknown parameters: &quot; . join(&quot;, &quot;, keys %opts))</td></tr>
<tr><td class="h">92</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if %opts;</td></tr>
<tr><td class="h">93</td><td colspan="7"></td></tr><tr><td class="h">94</td><td><div class="c3">775</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L94">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;{ditemid}) {</td></tr>
<tr><td class="h">95</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{anum}    = $self-&gt;{ditemid} &amp; 255;</td></tr>
<tr><td class="h">96</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{jitemid} = $self-&gt;{ditemid} &gt;&gt; 8;</td></tr>
<tr><td class="h">97</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">98</td><td colspan="7"></td></tr><tr><td class="h">99</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do we have a singleton for this entry?</td></tr>
<tr><td class="h">100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">101</td><td><div class="c3">775</div><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>8001</div><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $journalid = $self-&gt;{u}-&gt;{userid};</td></tr>
<tr><td class="h">102</td><td><div class="c3">775</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $jitemid   = $self-&gt;{jitemid};</td></tr>
<tr><td class="h">103</td><td colspan="7"></td></tr><tr><td class="h">104</td><td><div class="c3">775</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--condition.html#L104">100</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$singletons{$journalid} ||= {};</td></tr>
<tr><td class="h">105</td><td><div class="c3">775</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L105">100</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $singletons{$journalid}-&gt;{$jitemid}</td></tr>
<tr><td class="h">106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $singletons{$journalid}-&gt;{$jitemid};</td></tr>
<tr><td class="h">107</td><td colspan="7"></td></tr><tr><td class="h">108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# save the singleton if it doesn&#39;t exist</td></tr>
<tr><td class="h">109</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$singletons{$journalid}-&gt;{$jitemid} = $self;</td></tr>
<tr><td class="h">110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">111</td><td colspan="7"></td></tr><tr><td class="h">112</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self;</td></tr>
<tr><td class="h">113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">114</td><td colspan="7"></td></tr><tr><td class="h">115</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># sometimes item hashes don&#39;t have a journalid arg.</td></tr>
<tr><td class="h">116</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># in those cases call as ($u, $item) and the $u will</td></tr>
<tr><td class="h">117</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># be used</td></tr>
<tr><td class="h">118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new_from_item_hash {</td></tr>
<tr><td class="h">119</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L119">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $arg1 = shift;</td></tr>
<tr><td class="h">121</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $item = shift;</td></tr>
<tr><td class="h">122</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L122">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::isu($arg1)) {</td></tr>
<tr><td class="h">123</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L123">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{journalid} ||= $arg1-&gt;id;</td></tr>
<tr><td class="h">124</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">125</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item = $arg1;</td></tr>
<tr><td class="h">126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">127</td><td colspan="7"></td></tr><tr><td class="h">128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# some item hashes have &#39;jitemid&#39;, others have &#39;itemid&#39;</td></tr>
<tr><td class="h">129</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L129">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{jitemid} ||= $item-&gt;{itemid};</td></tr>
<tr><td class="h">130</td><td colspan="7"></td></tr><tr><td class="h">131</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L131">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L131">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid item hash&quot;</td></tr>
<tr><td class="h">132</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $item &amp;&amp; ref $item;</td></tr>
<tr><td class="h">133</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L133">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;no journalid in item hash&quot;</td></tr>
<tr><td class="h">134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $item-&gt;{journalid};</td></tr>
<tr><td class="h">135</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L135">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L135">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;no entry information in item hash&quot;</td></tr>
<tr><td class="h">136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $item-&gt;{ditemid} || ($item-&gt;{jitemid} &amp;&amp; defined($item-&gt;{anum}));</td></tr>
<tr><td class="h">137</td><td colspan="7"></td></tr><tr><td class="h">138</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry;</td></tr>
<tr><td class="h">139</td><td colspan="7"></td></tr><tr><td class="h">140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# have a ditemid only?  no problem.</td></tr>
<tr><td class="h">141</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L141">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L141">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L141">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($item-&gt;{ditemid}) {</td></tr>
<tr><td class="h">142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry = LJ::Entry-&gt;new($item-&gt;{journalid},</td></tr>
<tr><td class="h">143</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ditemid =&gt; $item-&gt;{ditemid});</td></tr>
<tr><td class="h">144</td><td colspan="7"></td></tr><tr><td class="h">145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# jitemid/anum is okay too</td></tr>
<tr><td class="h">146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($item-&gt;{jitemid} &amp;&amp; defined($item-&gt;{anum})) {</td></tr>
<tr><td class="h">147</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry = LJ::Entry-&gt;new($item-&gt;{journalid},</td></tr>
<tr><td class="h">148</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jitemid =&gt; $item-&gt;{jitemid},</td></tr>
<tr><td class="h">149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anum    =&gt; $item-&gt;{anum});</td></tr>
<tr><td class="h">150</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">151</td><td colspan="7"></td></tr><tr><td class="h">152</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $entry;</td></tr>
<tr><td class="h">153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">154</td><td colspan="7"></td></tr><tr><td class="h">155</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new_from_url {</td></tr>
<tr><td class="h">156</td><td><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L156">15</a></div></td><td><div class="c0">0</div></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $url) = @_;</td></tr>
<tr><td class="h">157</td><td colspan="7"></td></tr><tr><td class="h">158</td><td><div class="c3">15</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L158">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($url =~ m!(.+)/(\d+)\.html!) {</td></tr>
<tr><td class="h">159</td><td><div class="c3">15</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L159">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::User-&gt;new_from_url($1) or return undef;</td></tr>
<tr><td class="h">160</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Entry-&gt;new($u, ditemid =&gt; $2);</td></tr>
<tr><td class="h">161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">162</td><td colspan="7"></td></tr><tr><td class="h">163</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">165</td><td colspan="7"></td></tr><tr><td class="h">166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new_from_row {</td></tr>
<tr><td class="h">167</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L167">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">168</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %row   = @_;</td></tr>
<tr><td class="h">169</td><td colspan="7"></td></tr><tr><td class="h">170</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalu = LJ::load_userid($row{journalid});</td></tr>
<tr><td class="h">171</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = $class-&gt;new($journalu, jitemid =&gt; $row{jitemid});</td></tr>
<tr><td class="h">172</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;absorb_row(%row);</td></tr>
<tr><td class="h">173</td><td colspan="7"></td></tr><tr><td class="h">174</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self;</td></tr>
<tr><td class="h">175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">176</td><td colspan="7"></td></tr><tr><td class="h">177</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns true if entry currently exists.  (it&#39;s possible for a given</td></tr>
<tr><td class="h">178</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $u, to make a fake jitemid and that&#39;d be a valid skeleton LJ::Entry</td></tr>
<tr><td class="h">179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># object, even though that jitemid hasn&#39;t been created yet, or was</td></tr>
<tr><td class="h">180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># previously deleted)</td></tr>
<tr><td class="h">181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub valid {</td></tr>
<tr><td class="h">182</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L182">3</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">183</td><td><div class="c3">3</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L183">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self ]) unless $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">184</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">186</td><td colspan="7"></td></tr><tr><td class="h">187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub jitemid {</td></tr>
<tr><td class="h">188</td><td><div class="c3">234</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L188">234</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">189</td><td><div class="c3">234</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{jitemid};</td></tr>
<tr><td class="h">190</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">191</td><td colspan="7"></td></tr><tr><td class="h">192</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub ditemid {</td></tr>
<tr><td class="h">193</td><td><div class="c3">366</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L193">366</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">194</td><td><div class="c3">366</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L194">67</a></div></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{ditemid} ||= (($self-&gt;{jitemid} &lt;&lt; 8) + $self-&gt;anum);</td></tr>
<tr><td class="h">195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">196</td><td colspan="7"></td></tr><tr><td class="h">197</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub reply_url {</td></tr>
<tr><td class="h">198</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L198">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">199</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;url(mode =&gt; &#39;reply&#39;);</td></tr>
<tr><td class="h">200</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">201</td><td colspan="7"></td></tr><tr><td class="h">202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns permalink url</td></tr>
<tr><td class="h">203</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub url {</td></tr>
<tr><td class="h">204</td><td><div class="c3">39</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L204">39</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">205</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %opts = @_;</td></tr>
<tr><td class="h">206</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %args = %opts; # used later</td></tr>
<tr><td class="h">207</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $self-&gt;{u};</td></tr>
<tr><td class="h">208</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $view = delete $opts{view};</td></tr>
<tr><td class="h">209</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $anchor = delete $opts{anchor};</td></tr>
<tr><td class="h">210</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mode = delete $opts{mode};</td></tr>
<tr><td class="h">211</td><td colspan="7"></td></tr><tr><td class="h">212</td><td><div class="c3">39</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L212">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;Unknown args passed to url: &quot; . join(&quot;,&quot;, keys %opts)</td></tr>
<tr><td class="h">213</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if %opts;</td></tr>
<tr><td class="h">214</td><td colspan="7"></td></tr><tr><td class="h">215</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $override = LJ::run_hook(&quot;entry_permalink_override&quot;, $self, %opts);</td></tr>
<tr><td class="h">216</td><td><div class="c3">39</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L216">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $override if $override;</td></tr>
<tr><td class="h">217</td><td colspan="7"></td></tr><tr><td class="h">218</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $url = $u-&gt;journal_base . &quot;/&quot; . $self-&gt;ditemid . &quot;.html&quot;;</td></tr>
<tr><td class="h">219</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;delete $args{anchor};</td></tr>
<tr><td class="h">220</td><td><div class="c3">39</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L220">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%args) {</td></tr>
<tr><td class="h">221</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url .= &quot;?&quot;;</td></tr>
<tr><td class="h">222</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url .= LJ::encode_url_string(\%args);</td></tr>
<tr><td class="h">223</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">224</td><td><div class="c3">39</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L224">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$url .= &quot;#$anchor&quot; if $anchor;</td></tr>
<tr><td class="h">225</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $url;</td></tr>
<tr><td class="h">226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">227</td><td colspan="7"></td></tr><tr><td class="h">228</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a url that will display the number of comments on the entry</td></tr>
<tr><td class="h">229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># as an image</td></tr>
<tr><td class="h">230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub comment_image_url {</td></tr>
<tr><td class="h">231</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L231">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">232</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $self-&gt;{u};</td></tr>
<tr><td class="h">233</td><td colspan="7"></td></tr><tr><td class="h">234</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$LJ::SITEROOT/tools/commentcount?user=&quot; . $self-&gt;journal-&gt;user . &quot;&amp;ditemid=&quot; .  $self-&gt;ditemid;</td></tr>
<tr><td class="h">235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">236</td><td colspan="7"></td></tr><tr><td class="h">237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a pre-generated comment img tag using the comment_image_url</td></tr>
<tr><td class="h">238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub comment_imgtag {</td></tr>
<tr><td class="h">239</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L239">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">240</td><td colspan="7"></td></tr><tr><td class="h">241</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $alttext = LJ::Lang::ml(&#39;setting.xpost.option.footer.vars.comment_image.alttext&#39;);</td></tr>
<tr><td class="h">242</td><td colspan="7"></td></tr><tr><td class="h">243</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&lt;img src=&quot;&#39; . $self-&gt;comment_image_url . &#39;&quot; alt=&quot;&#39; . $alttext . &#39;&quot; style=&quot;vertical-align: middle;&quot;/&gt;&#39;;</td></tr>
<tr><td class="h">244</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">245</td><td colspan="7"></td></tr><tr><td class="h">246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub anum {</td></tr>
<tr><td class="h">247</td><td><div class="c3">50</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L247">50</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">248</td><td><div class="c3">50</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L248">50</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{anum} if defined $self-&gt;{anum};</td></tr>
<tr><td class="h">249</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L249">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self ]) unless $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">250</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L250">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{anum} if defined $self-&gt;{anum};</td></tr>
<tr><td class="h">251</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak(&quot;couldn&#39;t retrieve anum for entry&quot;);</td></tr>
<tr><td class="h">252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">253</td><td colspan="7"></td></tr><tr><td class="h">254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># method:</td></tr>
<tr><td class="h">255</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   $entry-&gt;correct_anum</td></tr>
<tr><td class="h">256</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   $entry-&gt;correct_anum($given_anum)</td></tr>
<tr><td class="h">257</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># if no given anum, gets it from the provided ditemid to constructor</td></tr>
<tr><td class="h">258</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub correct_anum {</td></tr>
<tr><td class="h">259</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L259">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">260</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L260">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $given = defined $_[0] ? int(shift) : $self-&gt;{anum};</td></tr>
<tr><td class="h">261</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L261">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $self-&gt;valid;</td></tr>
<tr><td class="h">262</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L262">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L262">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless defined $self-&gt;{anum} &amp;&amp; defined $given;</td></tr>
<tr><td class="h">263</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{anum} == $given;</td></tr>
<tr><td class="h">264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">265</td><td colspan="7"></td></tr><tr><td class="h">266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns LJ::User object for the poster of this entry</td></tr>
<tr><td class="h">267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub poster {</td></tr>
<tr><td class="h">268</td><td><div class="c3">316</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L268">316</a></div></td><td><div class="c0">0</div></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">269</td><td><div class="c3">316</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::load_userid($self-&gt;posterid);</td></tr>
<tr><td class="h">270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">271</td><td colspan="7"></td></tr><tr><td class="h">272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub posterid {</td></tr>
<tr><td class="h">273</td><td><div class="c3">316</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L273">316</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">274</td><td><div class="c3">316</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L274">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self ]) unless $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">275</td><td><div class="c3">316</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{posterid};</td></tr>
<tr><td class="h">276</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">277</td><td colspan="7"></td></tr><tr><td class="h">278</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub journalid {</td></tr>
<tr><td class="h">279</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L279">34</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">280</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{u}{userid};</td></tr>
<tr><td class="h">281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">282</td><td colspan="7"></td></tr><tr><td class="h">283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub journal {</td></tr>
<tr><td class="h">284</td><td><div class="c3">769</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L284">769</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">285</td><td><div class="c3">769</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{u};</td></tr>
<tr><td class="h">286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">287</td><td colspan="7"></td></tr><tr><td class="h">288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub eventtime_mysql {</td></tr>
<tr><td class="h">289</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L289">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">290</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L290">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self ]) unless $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">291</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{eventtime};</td></tr>
<tr><td class="h">292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">293</td><td colspan="7"></td></tr><tr><td class="h">294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub logtime_mysql {</td></tr>
<tr><td class="h">295</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L295">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">296</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L296">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self ]) unless $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">297</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{logtime};</td></tr>
<tr><td class="h">298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">299</td><td colspan="7"></td></tr><tr><td class="h">300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub logtime_unix {</td></tr>
<tr><td class="h">301</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L301">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">302</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L302">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self ]) unless $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">303</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::mysqldate_to_time($self-&gt;{logtime}, 1);</td></tr>
<tr><td class="h">304</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">305</td><td colspan="7"></td></tr><tr><td class="h">306</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub modtime_unix {</td></tr>
<tr><td class="h">307</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L307">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">308</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L308">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows ([ $self ]) unless $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">309</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L309">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_props([ $self ]) unless $self-&gt;{_loaded_props};</td></tr>
<tr><td class="h">310</td><td colspan="7"></td></tr><tr><td class="h">311</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::mysqldate_to_time($self-&gt;{logtime}, 1);</td></tr>
<tr><td class="h">312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">313</td><td colspan="7"></td></tr><tr><td class="h">314</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub security {</td></tr>
<tr><td class="h">315</td><td><div class="c3">248</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L315">248</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">316</td><td><div class="c3">248</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L316">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self ]) unless $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">317</td><td><div class="c3">248</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{security};</td></tr>
<tr><td class="h">318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">319</td><td colspan="7"></td></tr><tr><td class="h">320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub allowmask {</td></tr>
<tr><td class="h">321</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L321">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">322</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L322">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;__PACKAGE__-&gt;preload_rows([ $self ]) unless $self-&gt;{_loaded_row};</td></tr>
<tr><td class="h">323</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{allowmask};</td></tr>
<tr><td class="h">324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">325</td><td colspan="7"></td></tr><tr><td class="h">326</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub preload {</td></tr>
<tr><td class="h">327</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L327">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $entlist) = @_;</td></tr>
<tr><td class="h">328</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$class-&gt;preload_rows($entlist);</td></tr>
<tr><td class="h">329</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$class-&gt;preload_props($entlist);</td></tr>
<tr><td class="h">330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO: $class-&gt;preload_text($entlist);</td></tr>
<tr><td class="h">331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">332</td><td colspan="7"></td></tr><tr><td class="h">333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method:</td></tr>
<tr><td class="h">334</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub preload_rows {</td></tr>
<tr><td class="h">335</td><td><div class="c3">35</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L335">35</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $entlist) = @_;</td></tr>
<tr><td class="h">336</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $en (@$entlist) {</td></tr>
<tr><td class="h">337</td><td><div class="c3">35</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L337">50</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $en-&gt;{_loaded_row};</td></tr>
<tr><td class="h">338</td><td colspan="7"></td></tr><tr><td class="h">339</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $lg = LJ::get_log2_row($en-&gt;{u}, $en-&gt;{jitemid});</td></tr>
<tr><td class="h">340</td><td><div class="c3">35</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L340">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $lg;</td></tr>
<tr><td class="h">341</td><td colspan="7"></td></tr><tr><td class="h">342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# absorb row into given LJ::Entry object</td></tr>
<tr><td class="h">343</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$en-&gt;absorb_row(%$lg);</td></tr>
<tr><td class="h">344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">346</td><td colspan="7"></td></tr><tr><td class="h">347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub absorb_row {</td></tr>
<tr><td class="h">348</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L348">34</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, %row) = @_;</td></tr>
<tr><td class="h">349</td><td colspan="7"></td></tr><tr><td class="h">350</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{$_} = $row{$_} foreach (qw(allowmask posterid eventtime logtime security anum));</td></tr>
<tr><td class="h">351</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{_loaded_row} = 1;</td></tr>
<tr><td class="h">352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">353</td><td colspan="7"></td></tr><tr><td class="h">354</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method:</td></tr>
<tr><td class="h">355</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub preload_props {</td></tr>
<tr><td class="h">356</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L356">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $entlist) = @_;</td></tr>
<tr><td class="h">357</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $en (@$entlist) {</td></tr>
<tr><td class="h">358</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L358">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $en-&gt;{_loaded_props};</td></tr>
<tr><td class="h">359</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$en-&gt;_load_props;</td></tr>
<tr><td class="h">360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">361</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">362</td><td colspan="7"></td></tr><tr><td class="h">363</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns array of tags for this post</td></tr>
<tr><td class="h">364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub tags {</td></tr>
<tr><td class="h">365</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L365">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">366</td><td colspan="7"></td></tr><tr><td class="h">367</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $taginfo = LJ::Tags::get_logtags($self-&gt;journal, $self-&gt;jitemid);</td></tr>
<tr><td class="h">368</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L368">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () unless $taginfo;</td></tr>
<tr><td class="h">369</td><td colspan="7"></td></tr><tr><td class="h">370</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry_taginfo = $taginfo-&gt;{$self-&gt;jitemid};</td></tr>
<tr><td class="h">371</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L371">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () unless $entry_taginfo;</td></tr>
<tr><td class="h">372</td><td colspan="7"></td></tr><tr><td class="h">373</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return values %$entry_taginfo;</td></tr>
<tr><td class="h">374</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">375</td><td colspan="7"></td></tr><tr><td class="h">376</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns true if loaded, zero if not.</td></tr>
<tr><td class="h">377</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># also sets _loaded_text and subject and event.</td></tr>
<tr><td class="h">378</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _load_text {</td></tr>
<tr><td class="h">379</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L379">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">380</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L380">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">381</td><td colspan="7"></td></tr><tr><td class="h">382</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = LJ::get_logtext2($self-&gt;{&#39;u&#39;}, $self-&gt;{&#39;jitemid&#39;});</td></tr>
<tr><td class="h">383</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lt = $ret-&gt;{$self-&gt;{jitemid}};</td></tr>
<tr><td class="h">384</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L384">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $lt;</td></tr>
<tr><td class="h">385</td><td colspan="7"></td></tr><tr><td class="h">386</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{subject}      = $lt-&gt;[0];</td></tr>
<tr><td class="h">387</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{event}        = $lt-&gt;[1];</td></tr>
<tr><td class="h">388</td><td colspan="7"></td></tr><tr><td class="h">389</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L389">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($self-&gt;prop(&quot;unknown8bit&quot;)) {</td></tr>
<tr><td class="h">390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# save the old ones away, so we can get back at them if we really need to</td></tr>
<tr><td class="h">391</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{subject_orig}  = $self-&gt;{subject};</td></tr>
<tr><td class="h">392</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{event_orig}    = $self-&gt;{event};</td></tr>
<tr><td class="h">393</td><td colspan="7"></td></tr><tr><td class="h">394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: really convert all the props?  what if we binary-pack some in the future?</td></tr>
<tr><td class="h">395</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::item_toutf8($self-&gt;{u}, \$self-&gt;{&#39;subject&#39;}, \$self-&gt;{&#39;event&#39;}, $self-&gt;{props});</td></tr>
<tr><td class="h">396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">397</td><td colspan="7"></td></tr><tr><td class="h">398</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{_loaded_text} = 1;</td></tr>
<tr><td class="h">399</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">401</td><td colspan="7"></td></tr><tr><td class="h">402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub prop {</td></tr>
<tr><td class="h">403</td><td><div class="c3">35</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L403">35</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $prop) = @_;</td></tr>
<tr><td class="h">404</td><td><div class="c3">35</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L404">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_props unless $self-&gt;{_loaded_props};</td></tr>
<tr><td class="h">405</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{props}{$prop};</td></tr>
<tr><td class="h">406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">407</td><td colspan="7"></td></tr><tr><td class="h">408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub props {</td></tr>
<tr><td class="h">409</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L409">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $prop) = @_;</td></tr>
<tr><td class="h">410</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L410">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_props unless $self-&gt;{_loaded_props};</td></tr>
<tr><td class="h">411</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L411">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{props} || {};</td></tr>
<tr><td class="h">412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">413</td><td colspan="7"></td></tr><tr><td class="h">414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _load_props {</td></tr>
<tr><td class="h">415</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L415">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">416</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L416">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $self-&gt;{_loaded_props};</td></tr>
<tr><td class="h">417</td><td colspan="7"></td></tr><tr><td class="h">418</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $props = {};</td></tr>
<tr><td class="h">419</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_log_props2($self-&gt;{u}, [ $self-&gt;{jitemid} ], $props);</td></tr>
<tr><td class="h">420</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{props} = $props-&gt;{ $self-&gt;{jitemid} };</td></tr>
<tr><td class="h">421</td><td colspan="7"></td></tr><tr><td class="h">422</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{_loaded_props} = 1;</td></tr>
<tr><td class="h">423</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">424</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">425</td><td colspan="7"></td></tr><tr><td class="h">426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_prop {</td></tr>
<tr><td class="h">427</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L427">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop = shift;</td></tr>
<tr><td class="h">429</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $val = shift;</td></tr>
<tr><td class="h">430</td><td colspan="7"></td></tr><tr><td class="h">431</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_logprop($self-&gt;journal, $self-&gt;jitemid, { $prop =&gt; $val });</td></tr>
<tr><td class="h">432</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{props}{$prop} = $val;</td></tr>
<tr><td class="h">433</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">435</td><td colspan="7"></td></tr><tr><td class="h">436</td><td colspan="7"></td></tr><tr><td class="h">437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># called automatically on $event-&gt;comments</td></tr>
<tr><td class="h">438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the same data as LJ::get_talk_data, with the addition</td></tr>
<tr><td class="h">439</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># of &#39;subject&#39; and &#39;event&#39; keys.</td></tr>
<tr><td class="h">440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _load_comments</td></tr>
<tr><td class="h">441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">442</td><td><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L442">6</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">443</td><td><div class="c3">6</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L443">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $self-&gt;{_loaded_comments};</td></tr>
<tr><td class="h">444</td><td colspan="7"></td></tr><tr><td class="h">445</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# need to load using talklib API</td></tr>
<tr><td class="h">446</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comment_ref = LJ::Talk::get_talk_data($self-&gt;journal, &#39;L&#39;, $self-&gt;jitemid);</td></tr>
<tr><td class="h">447</td><td><div class="c3">6</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L447">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;unable to load comment data for entry&quot;</td></tr>
<tr><td class="h">448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ref $comment_ref;</td></tr>
<tr><td class="h">449</td><td colspan="7"></td></tr><tr><td class="h">450</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# instantiate LJ::Comment singletons and set them on our $self</td></tr>
<tr><td class="h">451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# -- members were filled in to the LJ::Comment singleton during the talklib call,</td></tr>
<tr><td class="h">452</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#    so we&#39;ll just re-instantiate here and rely on the fact that the singletons</td></tr>
<tr><td class="h">453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#    already exist and have db rows absorbed into them</td></tr>
<tr><td class="h">454</td><td><div class="c3">126</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;set_comment_list</td></tr>
<tr><td class="h">455</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( map { LJ::Comment-&gt;new( $self-&gt;journal, jtalkid =&gt; $_-&gt;{talkid}) }</td></tr>
<tr><td class="h">456</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values %$comment_ref );</td></tr>
<tr><td class="h">457</td><td colspan="7"></td></tr><tr><td class="h">458</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self;</td></tr>
<tr><td class="h">459</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">460</td><td colspan="7"></td></tr><tr><td class="h">461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub comment_list {</td></tr>
<tr><td class="h">462</td><td><div class="c3">57</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L462">57</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">463</td><td><div class="c3">57</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L463">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_comments unless $self-&gt;{_loaded_comments};</td></tr>
<tr><td class="h">464</td><td><div class="c3">57</div><div class="c3">57</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L464">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @{$self-&gt;{comments} || []};</td></tr>
<tr><td class="h">465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">466</td><td colspan="7"></td></tr><tr><td class="h">467</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_comment_list {</td></tr>
<tr><td class="h">468</td><td><div class="c3">18</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L468">18</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">469</td><td colspan="7"></td></tr><tr><td class="h">470</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{comments} = \@_;</td></tr>
<tr><td class="h">471</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;{_loaded_comments} = 1;</td></tr>
<tr><td class="h">472</td><td colspan="7"></td></tr><tr><td class="h">473</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">475</td><td colspan="7"></td></tr><tr><td class="h">476</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub reply_count {</td></tr>
<tr><td class="h">477</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L477">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">478</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rc = $self-&gt;prop(&#39;replycount&#39;);</td></tr>
<tr><td class="h">479</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L479">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rc if defined $rc;</td></tr>
<tr><td class="h">480</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Talk::get_replycount($self-&gt;journal, $self-&gt;jitemid);</td></tr>
<tr><td class="h">481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">482</td><td colspan="7"></td></tr><tr><td class="h">483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns &quot;Leave a comment&quot;, &quot;1 comment&quot;, &quot;2 comments&quot; etc</td></tr>
<tr><td class="h">484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub comment_text {</td></tr>
<tr><td class="h">485</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L485">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">486</td><td colspan="7"></td></tr><tr><td class="h">487</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comments;</td></tr>
<tr><td class="h">488</td><td colspan="7"></td></tr><tr><td class="h">489</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comment_count = $self-&gt;reply_count;</td></tr>
<tr><td class="h">490</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L490">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($comment_count) {</td></tr>
<tr><td class="h">491</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L491">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comments = $comment_count == 1 ? &quot;1 Comment&quot; : &quot;$comment_count Comments&quot;;</td></tr>
<tr><td class="h">492</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">493</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comments = &quot;Leave a comment&quot;;</td></tr>
<tr><td class="h">494</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">495</td><td colspan="7"></td></tr><tr><td class="h">496</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $comments;</td></tr>
<tr><td class="h">497</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">498</td><td colspan="7"></td></tr><tr><td class="h">499</td><td colspan="7"></td></tr><tr><td class="h">500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># used in comment notification email headers</td></tr>
<tr><td class="h">501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub email_messageid {</td></tr>
<tr><td class="h">502</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L502">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">503</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;&quot; . join(&quot;-&quot;, &quot;entry&quot;, $self-&gt;journal-&gt;id, $self-&gt;ditemid) . &quot;\@$LJ::DOMAIN&gt;&quot;;</td></tr>
<tr><td class="h">504</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">505</td><td colspan="7"></td></tr><tr><td class="h">506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub atom_id {</td></tr>
<tr><td class="h">507</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L507">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">508</td><td colspan="7"></td></tr><tr><td class="h">509</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u       = $self-&gt;{u};</td></tr>
<tr><td class="h">510</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $self-&gt;ditemid;</td></tr>
<tr><td class="h">511</td><td colspan="7"></td></tr><tr><td class="h">512</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;urn:lj:$LJ::DOMAIN:atom1:$u-&gt;{user}:$ditemid&quot;;</td></tr>
<tr><td class="h">513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">514</td><td colspan="7"></td></tr><tr><td class="h">515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns an XML::Atom::Entry object for a feed</td></tr>
<tr><td class="h">516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub atom_entry {</td></tr>
<tr><td class="h">517</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L517">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">518</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L518">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = shift || {};  # synlevel (&quot;full&quot;), apilinks (bool)</td></tr>
<tr><td class="h">519</td><td colspan="7"></td></tr><tr><td class="h">520</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry     = XML::Atom::Entry-&gt;new();</td></tr>
<tr><td class="h">521</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry_xml = $entry-&gt;{doc};</td></tr>
<tr><td class="h">522</td><td colspan="7"></td></tr><tr><td class="h">523</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u       = $self-&gt;{u};</td></tr>
<tr><td class="h">524</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $self-&gt;ditemid;</td></tr>
<tr><td class="h">525</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jitemid = $self-&gt;{jitemid};</td></tr>
<tr><td class="h">526</td><td colspan="7"></td></tr><tr><td class="h">527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# AtomAPI interface path</td></tr>
<tr><td class="h">528</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L528">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $api = $opts-&gt;{&#39;apilinks&#39;} ? &quot;$LJ::SITEROOT/interface/atom&quot; :</td></tr>
<tr><td class="h">529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;$LJ::SITEROOT/users/$u-&gt;{user}/data/atom&quot;;</td></tr>
<tr><td class="h">530</td><td colspan="7"></td></tr><tr><td class="h">531</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;title($self-&gt;subject_text);</td></tr>
<tr><td class="h">532</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;id($self-&gt;atom_id);</td></tr>
<tr><td class="h">533</td><td colspan="7"></td></tr><tr><td class="h">534</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $author = XML::Atom::Person-&gt;new();</td></tr>
<tr><td class="h">535</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$author-&gt;name($self-&gt;poster-&gt;{name});</td></tr>
<tr><td class="h">536</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;author($author);</td></tr>
<tr><td class="h">537</td><td colspan="7"></td></tr><tr><td class="h">538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $make_link = sub {</td></tr>
<tr><td class="h">539</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L539">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $rel, $type, $href, $title ) = @_;</td></tr>
<tr><td class="h">540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $link = XML::Atom::Link-&gt;new;</td></tr>
<tr><td class="h">541</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;rel($rel);</td></tr>
<tr><td class="h">542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;type($type);</td></tr>
<tr><td class="h">543</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;href($href);</td></tr>
<tr><td class="h">544</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L544">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link-&gt;title($title) if $title;</td></tr>
<tr><td class="h">545</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $link;</td></tr>
<tr><td class="h">546</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">547</td><td colspan="7"></td></tr><tr><td class="h">548</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;add_link($make_link-&gt;( &#39;alternate&#39;, &#39;text/html&#39;, $self-&gt;url));</td></tr>
<tr><td class="h">549</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L549">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;add_link($make_link-&gt;(</td></tr>
<tr><td class="h">550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;service.edit&#39;,      &#39;application/x.atom+xml&#39;,</td></tr>
<tr><td class="h">551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;$api/edit/$jitemid&quot;, &#39;Edit this post&#39;</td></tr>
<tr><td class="h">552</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) if $opts-&gt;{&#39;apilinks&#39;};</td></tr>
<tr><td class="h">554</td><td colspan="7"></td></tr><tr><td class="h">555</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $event_date = LJ::time_to_w3c($self-&gt;logtime_unix, &quot;&quot;);</td></tr>
<tr><td class="h">556</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $modtime    = LJ::time_to_w3c($self-&gt;modtime_unix, &#39;Z&#39;);</td></tr>
<tr><td class="h">557</td><td colspan="7"></td></tr><tr><td class="h">558</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;published($event_date);</td></tr>
<tr><td class="h">559</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;issued   ($event_date);   # COMPAT</td></tr>
<tr><td class="h">560</td><td colspan="7"></td></tr><tr><td class="h">561</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;updated ($modtime);</td></tr>
<tr><td class="h">562</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$entry-&gt;modified($modtime);</td></tr>
<tr><td class="h">563</td><td colspan="7"></td></tr><tr><td class="h">564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# XML::Atom 0.9 doesn&#39;t support categories.   Maybe later?</td></tr>
<tr><td class="h">565</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $tag ($self-&gt;tags) {</td></tr>
<tr><td class="h">566</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tag = LJ::exml($tag);</td></tr>
<tr><td class="h">567</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $category = $entry_xml-&gt;createElement( &#39;category&#39; );</td></tr>
<tr><td class="h">568</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$category-&gt;setAttribute( &#39;term&#39;, $tag );</td></tr>
<tr><td class="h">569</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $category );</td></tr>
<tr><td class="h">570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">571</td><td colspan="7"></td></tr><tr><td class="h">572</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L572">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $syn_level = $opts-&gt;{synlevel} || $u-&gt;prop(&quot;opt_synlevel&quot;) || &quot;full&quot;;</td></tr>
<tr><td class="h">573</td><td colspan="7"></td></tr><tr><td class="h">574</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if syndicating the complete entry</td></tr>
<tr><td class="h">575</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   -print a content tag</td></tr>
<tr><td class="h">576</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# elsif syndicating summaries</td></tr>
<tr><td class="h">577</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   -print a summary tag</td></tr>
<tr><td class="h">578</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# else (code omitted), we&#39;re syndicating title only</td></tr>
<tr><td class="h">579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   -print neither (the title has already been printed)</td></tr>
<tr><td class="h">580</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   note: the $event was also emptied earlier, in make_feed</td></tr>
<tr><td class="h">581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#</td></tr>
<tr><td class="h">582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# a lack of a content element is allowed,  as long</td></tr>
<tr><td class="h">583</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# as we maintain a proper &#39;alternate&#39; link (above)</td></tr>
<tr><td class="h">584</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L584">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L584">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($syn_level eq &#39;full&#39;) {</td></tr>
<tr><td class="h">585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Do this manually for now, until XML::Atom supports new</td></tr>
<tr><td class="h">586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# content type classifications.</td></tr>
<tr><td class="h">587</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $content = $entry_xml-&gt;createElement( &#39;content&#39; );</td></tr>
<tr><td class="h">588</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;setAttribute( &#39;type&#39;, &#39;html&#39; );</td></tr>
<tr><td class="h">589</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content-&gt;appendTextNode( $self-&gt;event_html );</td></tr>
<tr><td class="h">590</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $content );</td></tr>
<tr><td class="h">591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($syn_level eq &#39;summary&#39;) {</td></tr>
<tr><td class="h">592</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $summary = $entry_xml-&gt;createElement( &#39;summary&#39; );</td></tr>
<tr><td class="h">593</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$summary-&gt;setAttribute( &#39;type&#39;, &#39;html&#39; );</td></tr>
<tr><td class="h">594</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$summary-&gt;appendTextNode( $self-&gt;event_summary );</td></tr>
<tr><td class="h">595</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$entry_xml-&gt;getDocumentElement-&gt;appendChild( $summary );</td></tr>
<tr><td class="h">596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">597</td><td colspan="7"></td></tr><tr><td class="h">598</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $entry;</td></tr>
<tr><td class="h">599</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">600</td><td colspan="7"></td></tr><tr><td class="h">601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the entry as an XML Atom string, without the XML prologue</td></tr>
<tr><td class="h">602</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub as_atom</td></tr>
<tr><td class="h">603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">604</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L604">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self  = shift;</td></tr>
<tr><td class="h">605</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry = $self-&gt;atom_entry;</td></tr>
<tr><td class="h">606</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $xml   = $entry-&gt;as_xml;</td></tr>
<tr><td class="h">607</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$xml =~ s!^&lt;\?xml.+?&gt;\s*!!s;</td></tr>
<tr><td class="h">608</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $xml;</td></tr>
<tr><td class="h">609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">610</td><td colspan="7"></td></tr><tr><td class="h">611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># raw utf8 text, with no HTML cleaning</td></tr>
<tr><td class="h">612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subject_raw {</td></tr>
<tr><td class="h">613</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L613">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">614</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L614">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text  unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">615</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{subject};</td></tr>
<tr><td class="h">616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">617</td><td colspan="7"></td></tr><tr><td class="h">618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># raw text as user sent us, without transcoding while correcting for unknown8bit</td></tr>
<tr><td class="h">619</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subject_orig {</td></tr>
<tr><td class="h">620</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L620">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">621</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L621">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text  unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">622</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L622">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{subject_orig} || $self-&gt;{subject};</td></tr>
<tr><td class="h">623</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">624</td><td colspan="7"></td></tr><tr><td class="h">625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># raw utf8 text, with no HTML cleaning</td></tr>
<tr><td class="h">626</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub event_raw {</td></tr>
<tr><td class="h">627</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L627">1</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">628</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L628">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">629</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{event};</td></tr>
<tr><td class="h">630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">631</td><td colspan="7"></td></tr><tr><td class="h">632</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># raw text as user sent us, without transcoding while correcting for unknown8bit</td></tr>
<tr><td class="h">633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub event_orig {</td></tr>
<tr><td class="h">634</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L634">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">635</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L635">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">636</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L636">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;{event_orig} || $self-&gt;{event};</td></tr>
<tr><td class="h">637</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">638</td><td colspan="7"></td></tr><tr><td class="h">639</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subject_html</td></tr>
<tr><td class="h">640</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">641</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L641">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">642</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L642">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">643</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $subject = $self-&gt;{subject};</td></tr>
<tr><td class="h">644</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L644">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_subject( \$subject ) if $subject;</td></tr>
<tr><td class="h">645</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $subject;</td></tr>
<tr><td class="h">646</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">647</td><td colspan="7"></td></tr><tr><td class="h">648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subject_text</td></tr>
<tr><td class="h">649</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">650</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L650">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">651</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L651">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">652</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $subject = $self-&gt;{subject};</td></tr>
<tr><td class="h">653</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L653">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_subject_all( \$subject ) if $subject;</td></tr>
<tr><td class="h">654</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $subject;</td></tr>
<tr><td class="h">655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">656</td><td colspan="7"></td></tr><tr><td class="h">657</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># instance method.  returns HTML-cleaned/formatted version of the event</td></tr>
<tr><td class="h">658</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># optional $opt may be:</td></tr>
<tr><td class="h">659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    undef:   loads the opt_preformatted key and uses that for formatting options</td></tr>
<tr><td class="h">660</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    1:       treats entry as preformatted (no breaks applied)</td></tr>
<tr><td class="h">661</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    0:       treats entry as normal (newlines convert to HTML breaks)</td></tr>
<tr><td class="h">662</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    hashref: passed to LJ::CleanHTML::clean_event verbatim</td></tr>
<tr><td class="h">663</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub event_html</td></tr>
<tr><td class="h">664</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">665</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L665">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $opts) = @_;</td></tr>
<tr><td class="h">666</td><td colspan="7"></td></tr><tr><td class="h">667</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L667">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L667">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (! defined $opts) {</td></tr>
<tr><td class="h">668</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L668">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_props unless $self-&gt;{_loaded_props};</td></tr>
<tr><td class="h">669</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts = { preformatted =&gt; $self-&gt;{props}{opt_preformatted} };</td></tr>
<tr><td class="h">670</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif (! ref $opts) {</td></tr>
<tr><td class="h">671</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts = { preformatted =&gt; $opts };</td></tr>
<tr><td class="h">672</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">673</td><td colspan="7"></td></tr><tr><td class="h">674</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">675</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L675">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $suspend_msg = $self-&gt;should_show_suspend_msg_to($remote) ? 1 : 0;</td></tr>
<tr><td class="h">676</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{suspend_msg} = $suspend_msg;</td></tr>
<tr><td class="h">677</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L677">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{unsuspend_supportid} = $suspend_msg ? $self-&gt;prop(&quot;unsuspend_supportid&quot;) : 0;</td></tr>
<tr><td class="h">678</td><td colspan="7"></td></tr><tr><td class="h">679</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L679">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;_load_text unless $self-&gt;{_loaded_text};</td></tr>
<tr><td class="h">680</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $event = $self-&gt;{event};</td></tr>
<tr><td class="h">681</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_event(\$event, $opts);</td></tr>
<tr><td class="h">682</td><td colspan="7"></td></tr><tr><td class="h">683</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::expand_embedded($self-&gt;{u}, $self-&gt;ditemid, LJ::User-&gt;remote, \$event);</td></tr>
<tr><td class="h">684</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $event;</td></tr>
<tr><td class="h">685</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">686</td><td colspan="7"></td></tr><tr><td class="h">687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># like event_html, but trimmed to $char_max</td></tr>
<tr><td class="h">688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub event_html_summary {</td></tr>
<tr><td class="h">689</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L689">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $char_max, $opts) = @_;</td></tr>
<tr><td class="h">690</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::html_trim($self-&gt;event_html($opts), $char_max);</td></tr>
<tr><td class="h">691</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">692</td><td colspan="7"></td></tr><tr><td class="h">693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub event_text</td></tr>
<tr><td class="h">694</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">695</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L695">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">696</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $event = $self-&gt;event_raw;</td></tr>
<tr><td class="h">697</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L697">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::CleanHTML::clean_event( \$event, { textonly =&gt; 1} ) if $event;</td></tr>
<tr><td class="h">698</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $event;</td></tr>
<tr><td class="h">699</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">700</td><td colspan="7"></td></tr><tr><td class="h">701</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># like event_html, but truncated for summary mode in rss/atom</td></tr>
<tr><td class="h">702</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub event_summary {</td></tr>
<tr><td class="h">703</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L703">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">704</td><td colspan="7"></td></tr><tr><td class="h">705</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $url = $self-&gt;url;</td></tr>
<tr><td class="h">706</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $readmore = &quot;&lt;b&gt;(&lt;a href=\&quot;$url\&quot;&gt;Read more ...&lt;/a&gt;)&lt;/b&gt;&quot;;</td></tr>
<tr><td class="h">707</td><td colspan="7"></td></tr><tr><td class="h">708</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $event = $self-&gt;event_html;</td></tr>
<tr><td class="h">709</td><td colspan="7"></td></tr><tr><td class="h">710</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# assume the first paragraph is terminated by two &lt;br&gt; or a &lt;/p&gt;</td></tr>
<tr><td class="h">711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# valid XML tags should be handled, even though it makes an uglier regex</td></tr>
<tr><td class="h">712</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L712">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($event =~ m!((&lt;br\s*/?\&gt;(&lt;/br\s*&gt;)?\s*){2})|(&lt;/p\s*&gt;)!i) {</td></tr>
<tr><td class="h">713</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# everything before the matched tag + the tag itself</td></tr>
<tr><td class="h">714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# + a link to read more</td></tr>
<tr><td class="h">715</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event = $` . $&amp; . $readmore;</td></tr>
<tr><td class="h">716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">717</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $event;</td></tr>
<tr><td class="h">718</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">719</td><td colspan="7"></td></tr><tr><td class="h">720</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub comments_manageable_by {</td></tr>
<tr><td class="h">721</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L721">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $remote) = @_;</td></tr>
<tr><td class="h">722</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L722">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $self-&gt;valid;</td></tr>
<tr><td class="h">723</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L723">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $remote;</td></tr>
<tr><td class="h">724</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $self-&gt;{u};</td></tr>
<tr><td class="h">725</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L725">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $remote-&gt;{userid} == $self-&gt;posterid || LJ::can_manage($remote, $u);</td></tr>
<tr><td class="h">726</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">727</td><td colspan="7"></td></tr><tr><td class="h">728</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># instance method:  returns bool, if remote user can view this entry</td></tr>
<tr><td class="h">729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub visible_to</td></tr>
<tr><td class="h">730</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">731</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L731">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $remote, $canview) = @_;</td></tr>
<tr><td class="h">732</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L732">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $self-&gt;valid;</td></tr>
<tr><td class="h">733</td><td colspan="7"></td></tr><tr><td class="h">734</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($viewall, $viewsome) = (0, 0);</td></tr>
<tr><td class="h">735</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L735">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L735">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( LJ::isu( $remote ) &amp;&amp; $canview ) {</td></tr>
<tr><td class="h">736</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$viewall = $remote-&gt;has_priv( &#39;canview&#39;, &#39;*&#39; );</td></tr>
<tr><td class="h">737</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L737">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$viewsome = $viewall || $remote-&gt;has_priv( &#39;canview&#39;, &#39;suspended&#39; );</td></tr>
<tr><td class="h">738</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">739</td><td colspan="7"></td></tr><tr><td class="h">740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can see anything with viewall</td></tr>
<tr><td class="h">741</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L741">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $viewall;</td></tr>
<tr><td class="h">742</td><td colspan="7"></td></tr><tr><td class="h">743</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t see anything unless the journal is visible</td></tr>
<tr><td class="h">744</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# unless you have viewsome. then, other restrictions apply</td></tr>
<tr><td class="h">745</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L745">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $viewsome ) {</td></tr>
<tr><td class="h">746</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L746">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $self-&gt;journal-&gt;is_inactive;</td></tr>
<tr><td class="h">747</td><td colspan="7"></td></tr><tr><td class="h">748</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t see anything by suspended users</td></tr>
<tr><td class="h">749</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L749">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $self-&gt;poster-&gt;is_suspended;</td></tr>
<tr><td class="h">750</td><td colspan="7"></td></tr><tr><td class="h">751</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t see suspended entries</td></tr>
<tr><td class="h">752</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L752">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $self-&gt;is_suspended_for($remote);</td></tr>
<tr><td class="h">753</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">754</td><td colspan="7"></td></tr><tr><td class="h">755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# public is okay</td></tr>
<tr><td class="h">756</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L756">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $self-&gt;{&#39;security&#39;} eq &quot;public&quot;;</td></tr>
<tr><td class="h">757</td><td colspan="7"></td></tr><tr><td class="h">758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# must be logged in otherwise</td></tr>
<tr><td class="h">759</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L759">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $remote;</td></tr>
<tr><td class="h">760</td><td colspan="7"></td></tr><tr><td class="h">761</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid   = int($self-&gt;{u}{userid});</td></tr>
<tr><td class="h">762</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remoteid = int($remote-&gt;{userid});</td></tr>
<tr><td class="h">763</td><td colspan="7"></td></tr><tr><td class="h">764</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# owners can always see their own.</td></tr>
<tr><td class="h">765</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L765">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $userid == $remoteid;</td></tr>
<tr><td class="h">766</td><td colspan="7"></td></tr><tr><td class="h">767</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# other people can&#39;t read private</td></tr>
<tr><td class="h">768</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L768">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $self-&gt;{&#39;security&#39;} eq &quot;private&quot;;</td></tr>
<tr><td class="h">769</td><td colspan="7"></td></tr><tr><td class="h">770</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# should be &#39;usemask&#39; security from here out, otherwise</td></tr>
<tr><td class="h">771</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# assume it&#39;s something new and return 0</td></tr>
<tr><td class="h">772</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L772">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $self-&gt;{&#39;security&#39;} eq &quot;usemask&quot;;</td></tr>
<tr><td class="h">773</td><td colspan="7"></td></tr><tr><td class="h">774</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it&#39;s usemask, we have to refuse non-personal journals,</td></tr>
<tr><td class="h">775</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so we have to load the user</td></tr>
<tr><td class="h">776</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L776">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $remote-&gt;is_individual;</td></tr>
<tr><td class="h">777</td><td colspan="7"></td></tr><tr><td class="h">778</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check if it&#39;s a community and they&#39;re a member</td></tr>
<tr><td class="h">779</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L779">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L779">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $self-&gt;journal-&gt;is_community &amp;&amp;</td></tr>
<tr><td class="h">780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote-&gt;member_of( $self-&gt;journal );</td></tr>
<tr><td class="h">781</td><td colspan="7"></td></tr><tr><td class="h">782</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $gmask = $self-&gt;journal-&gt;trustmask( $remote );</td></tr>
<tr><td class="h">783</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $allowed = (int($gmask) &amp; int($self-&gt;{&#39;allowmask&#39;}));</td></tr>
<tr><td class="h">784</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L784">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $allowed ? 1 : 0;  # no need to return matching mask</td></tr>
<tr><td class="h">785</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">786</td><td colspan="7"></td></tr><tr><td class="h">787</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns hashref of (kwid =&gt; tag) for tags on the entry</td></tr>
<tr><td class="h">788</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub tag_map {</td></tr>
<tr><td class="h">789</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L789">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">790</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $tags = LJ::Tags::get_logtags($self-&gt;{u}, $self-&gt;jitemid);</td></tr>
<tr><td class="h">791</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L791">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {} unless $tags;</td></tr>
<tr><td class="h">792</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L792">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $tags-&gt;{$self-&gt;jitemid} || {};</td></tr>
<tr><td class="h">793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">794</td><td colspan="7"></td></tr><tr><td class="h">795</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a LJ::Userpic object for this post, or undef</td></tr>
<tr><td class="h">796</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># currently this is for the permalink view, not for the friends view</td></tr>
<tr><td class="h">797</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># context.  TODO: add a context option for friends page, and perhaps</td></tr>
<tr><td class="h">798</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># respect $remote&#39;s userpic viewing preferences (community shows poster</td></tr>
<tr><td class="h">799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># vs community&#39;s picture)</td></tr>
<tr><td class="h">800</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub userpic {</td></tr>
<tr><td class="h">801</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L801">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">802</td><td colspan="7"></td></tr><tr><td class="h">803</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $up = $self-&gt;poster;</td></tr>
<tr><td class="h">804</td><td colspan="7"></td></tr><tr><td class="h">805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# try their entry-defined userpic keyword, then their custom</td></tr>
<tr><td class="h">806</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# mood, then their standard mood</td></tr>
<tr><td class="h">807</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L807">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $key = $self-&gt;prop(&#39;picture_keyword&#39;) ||</td></tr>
<tr><td class="h">808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$self-&gt;prop(&#39;current_mood&#39;) ||</td></tr>
<tr><td class="h">809</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::mood_name($self-&gt;prop(&#39;current_moodid&#39;));</td></tr>
<tr><td class="h">810</td><td colspan="7"></td></tr><tr><td class="h">811</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return the picture from keyword, if defined</td></tr>
<tr><td class="h">812</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $picid = LJ::get_picid_from_keyword($up, $key);</td></tr>
<tr><td class="h">813</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L813">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Userpic-&gt;new($up, $picid) if $picid;</td></tr>
<tr><td class="h">814</td><td colspan="7"></td></tr><tr><td class="h">815</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# else return poster&#39;s default userpic</td></tr>
<tr><td class="h">816</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $up-&gt;userpic;</td></tr>
<tr><td class="h">817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">818</td><td colspan="7"></td></tr><tr><td class="h">819</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub userpic_kw_from_props {</td></tr>
<tr><td class="h">820</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L820">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $props) = @_;</td></tr>
<tr><td class="h">821</td><td colspan="7"></td></tr><tr><td class="h">822</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L822">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $props-&gt;{&#39;picture_keyword&#39;} ||</td></tr>
<tr><td class="h">823</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$props-&gt;{&#39;current_mood&#39;} ||</td></tr>
<tr><td class="h">824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::mood_name($props-&gt;{&#39;current_moodid&#39;});</td></tr>
<tr><td class="h">825</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">826</td><td colspan="7"></td></tr><tr><td class="h">827</td><td colspan="7"></td></tr><tr><td class="h">828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns true if the user is allowed to share an entry via Tell a Friend</td></tr>
<tr><td class="h">829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $u is the logged-in user</td></tr>
<tr><td class="h">830</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $item is a hash containing Entry info</td></tr>
<tr><td class="h">831</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_tellafriend {</td></tr>
<tr><td class="h">832</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L832">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($entry, $u) = @_;</td></tr>
<tr><td class="h">833</td><td colspan="7"></td></tr><tr><td class="h">834</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L834">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $entry-&gt;security eq &#39;public&#39;;</td></tr>
<tr><td class="h">835</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L835">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $entry-&gt;security eq &#39;private&#39;;</td></tr>
<tr><td class="h">836</td><td colspan="7"></td></tr><tr><td class="h">837</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# friends only</td></tr>
<tr><td class="h">838</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L838">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $entry-&gt;journal-&gt;is_person;</td></tr>
<tr><td class="h">839</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L839">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::u_equals($u, $entry-&gt;poster);</td></tr>
<tr><td class="h">840</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">841</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">842</td><td colspan="7"></td></tr><tr><td class="h">843</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># defined by the entry poster</td></tr>
<tr><td class="h">844</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content {</td></tr>
<tr><td class="h">845</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L845">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">846</td><td colspan="7"></td></tr><tr><td class="h">847</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;prop(&#39;adult_content&#39;);</td></tr>
<tr><td class="h">848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">849</td><td colspan="7"></td></tr><tr><td class="h">850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># defined by a community maintainer</td></tr>
<tr><td class="h">851</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content_maintainer {</td></tr>
<tr><td class="h">852</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L852">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">853</td><td colspan="7"></td></tr><tr><td class="h">854</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userLevel = $self-&gt;adult_content;</td></tr>
<tr><td class="h">855</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $maintLevel = $self-&gt;prop( &#39;adult_content_maintainer&#39; );</td></tr>
<tr><td class="h">856</td><td colspan="7"></td></tr><tr><td class="h">857</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L857">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $maintLevel;</td></tr>
<tr><td class="h">858</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L858">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $maintLevel if $userLevel eq $maintLevel;</td></tr>
<tr><td class="h">859</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L859">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L859">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $maintLevel if !$userLevel || $userLevel eq &quot;none&quot;;</td></tr>
<tr><td class="h">860</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L860">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L860">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $maintLevel if $userLevel eq &quot;concepts&quot; &amp;&amp; $maintLevel eq &quot;explicit&quot;;</td></tr>
<tr><td class="h">861</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">863</td><td colspan="7"></td></tr><tr><td class="h">864</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># defined by a community maintainer</td></tr>
<tr><td class="h">865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content_maintainer_reason {</td></tr>
<tr><td class="h">866</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L866">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">867</td><td colspan="7"></td></tr><tr><td class="h">868</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;prop(&#39;adult_content_maintainer_reason&#39;);</td></tr>
<tr><td class="h">869</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">870</td><td colspan="7"></td></tr><tr><td class="h">871</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># defined by the entry poster</td></tr>
<tr><td class="h">872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content_reason {</td></tr>
<tr><td class="h">873</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L873">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">874</td><td colspan="7"></td></tr><tr><td class="h">875</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;prop(&#39;adult_content_reason&#39;);</td></tr>
<tr><td class="h">876</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">877</td><td colspan="7"></td></tr><tr><td class="h">878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># uses both poster- and maintainer-defined props to figure out the adult content level</td></tr>
<tr><td class="h">879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content_calculated {</td></tr>
<tr><td class="h">880</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L880">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">881</td><td colspan="7"></td></tr><tr><td class="h">882</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L882">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;adult_content_maintainer if $self-&gt;adult_content_maintainer;</td></tr>
<tr><td class="h">883</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;adult_content;</td></tr>
<tr><td class="h">884</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">885</td><td colspan="7"></td></tr><tr><td class="h">886</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns who marked the entry as the &#39;adult_content_calculated&#39; adult content level</td></tr>
<tr><td class="h">887</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content_marker {</td></tr>
<tr><td class="h">888</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L888">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">889</td><td colspan="7"></td></tr><tr><td class="h">890</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L890">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;community&quot; if $self-&gt;adult_content_maintainer;</td></tr>
<tr><td class="h">891</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L891">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;poster&quot; if $self-&gt;adult_content;</td></tr>
<tr><td class="h">892</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;journal-&gt;adult_content_marker;</td></tr>
<tr><td class="h">893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">894</td><td colspan="7"></td></tr><tr><td class="h">895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub qotdid {</td></tr>
<tr><td class="h">896</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L896">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">897</td><td colspan="7"></td></tr><tr><td class="h">898</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;prop(&#39;qotdid&#39;);</td></tr>
<tr><td class="h">899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">900</td><td colspan="7"></td></tr><tr><td class="h">901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># don&#39;t use this anymore, instead check for is_special flag on question</td></tr>
<tr><td class="h">902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_special_qotd_entry {</td></tr>
<tr><td class="h">903</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L903">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">904</td><td colspan="7"></td></tr><tr><td class="h">905</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qotdid = $self-&gt;qotdid;</td></tr>
<tr><td class="h">906</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $poster = $self-&gt;poster;</td></tr>
<tr><td class="h">907</td><td colspan="7"></td></tr><tr><td class="h">908</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L908">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L908">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($qotdid &amp;&amp; $poster &amp;&amp; LJ::run_hook(&quot;show_qotd_title_change&quot;, $poster)) {</td></tr>
<tr><td class="h">909</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">911</td><td colspan="7"></td></tr><tr><td class="h">912</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">913</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">914</td><td colspan="7"></td></tr><tr><td class="h">915</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub should_block_robots {</td></tr>
<tr><td class="h">916</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L916">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">917</td><td colspan="7"></td></tr><tr><td class="h">918</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L918">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $self-&gt;journal-&gt;prop(&#39;opt_blockrobots&#39;);</td></tr>
<tr><td class="h">919</td><td colspan="7"></td></tr><tr><td class="h">920</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L920">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::is_enabled( &#39;adult_content&#39; );</td></tr>
<tr><td class="h">921</td><td colspan="7"></td></tr><tr><td class="h">922</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $adult_content = $self-&gt;adult_content_calculated;</td></tr>
<tr><td class="h">923</td><td colspan="7"></td></tr><tr><td class="h">924</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L924">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L924">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $LJ::CONTENT_FLAGS{$adult_content} &amp;&amp; $LJ::CONTENT_FLAGS{$adult_content}-&gt;{block_robots};</td></tr>
<tr><td class="h">925</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">926</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">927</td><td colspan="7"></td></tr><tr><td class="h">928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub syn_link {</td></tr>
<tr><td class="h">929</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L929">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">930</td><td colspan="7"></td></tr><tr><td class="h">931</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;prop(&#39;syn_link&#39;);</td></tr>
<tr><td class="h">932</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">933</td><td colspan="7"></td></tr><tr><td class="h">934</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># group names to be displayed with this entry</td></tr>
<tr><td class="h">935</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns nothing if remote is not the poster of the entry</td></tr>
<tr><td class="h">936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns names as links to the /security/ URLs if the user can use those URLs</td></tr>
<tr><td class="h">937</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns names as plaintext otherwise</td></tr>
<tr><td class="h">938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub group_names {</td></tr>
<tr><td class="h">939</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L939">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">940</td><td colspan="7"></td></tr><tr><td class="h">941</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">942</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $poster = $self-&gt;poster;</td></tr>
<tr><td class="h">943</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L943">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L943">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&quot; unless $remote &amp;&amp; $poster &amp;&amp; $poster-&gt;equals( $remote );</td></tr>
<tr><td class="h">944</td><td colspan="7"></td></tr><tr><td class="h">945</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $poster-&gt;security_group_display( $self-&gt;allowmask );</td></tr>
<tr><td class="h">946</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">947</td><td colspan="7"></td></tr><tr><td class="h">948</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub statusvis {</td></tr>
<tr><td class="h">949</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L949">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">950</td><td colspan="7"></td></tr><tr><td class="h">951</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L951">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;prop(&quot;statusvis&quot;) eq &quot;S&quot; ? &quot;S&quot; : &quot;V&quot;;</td></tr>
<tr><td class="h">952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">953</td><td colspan="7"></td></tr><tr><td class="h">954</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_visible {</td></tr>
<tr><td class="h">955</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L955">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">956</td><td colspan="7"></td></tr><tr><td class="h">957</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L957">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;statusvis eq &quot;V&quot; ? 1 : 0;</td></tr>
<tr><td class="h">958</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">959</td><td colspan="7"></td></tr><tr><td class="h">960</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_suspended {</td></tr>
<tr><td class="h">961</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L961">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">962</td><td colspan="7"></td></tr><tr><td class="h">963</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L963">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;statusvis eq &quot;S&quot; ? 1 : 0;</td></tr>
<tr><td class="h">964</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">965</td><td colspan="7"></td></tr><tr><td class="h">966</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># same as is_suspended, except that it returns 0 if the given user can see the suspended entry</td></tr>
<tr><td class="h">967</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_suspended_for {</td></tr>
<tr><td class="h">968</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L968">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">969</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">970</td><td colspan="7"></td></tr><tr><td class="h">971</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L971">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $self-&gt;is_suspended;</td></tr>
<tr><td class="h">972</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L972">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L972">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if LJ::isu($u) &amp;&amp; $u-&gt;has_priv( &#39;canview&#39;, &#39;suspended&#39; );</td></tr>
<tr><td class="h">973</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L973">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L973">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if LJ::isu($u) &amp;&amp; $u-&gt;equals($self-&gt;poster);</td></tr>
<tr><td class="h">974</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">975</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">976</td><td colspan="7"></td></tr><tr><td class="h">977</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub should_show_suspend_msg_to {</td></tr>
<tr><td class="h">978</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L978">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">979</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">980</td><td colspan="7"></td></tr><tr><td class="h">981</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L981">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L981">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $self-&gt;is_suspended &amp;&amp; !$self-&gt;is_suspended_for($u) ? 1 : 0;</td></tr>
<tr><td class="h">982</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">983</td><td colspan="7"></td></tr><tr><td class="h">984</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># some entry props must keep all their history</td></tr>
<tr><td class="h">985</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub put_logprop_in_history {</td></tr>
<tr><td class="h">986</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L986">0</a></div></td><td><div class="c0">0</div></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, $prop, $old_value, $new_value, $note) = @_;</td></tr>
<tr><td class="h">987</td><td colspan="7"></td></tr><tr><td class="h">988</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;log&quot;, $prop);</td></tr>
<tr><td class="h">989</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L989">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $p;</td></tr>
<tr><td class="h">990</td><td colspan="7"></td></tr><tr><td class="h">991</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $propid = $p-&gt;{id};</td></tr>
<tr><td class="h">992</td><td colspan="7"></td></tr><tr><td class="h">993</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $self-&gt;journal;</td></tr>
<tr><td class="h">994</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;INSERT INTO logprop_history (journalid, jitemid, propid, change_time, old_value, new_value, note) VALUES (?, ?, ?, unix_timestamp(), ?, ?, ?)&quot;,</td></tr>
<tr><td class="h">995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $self-&gt;journalid, $self-&gt;jitemid, $propid, $old_value, $new_value, $note);</td></tr>
<tr><td class="h">996</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L996">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef if $u-&gt;err;</td></tr>
<tr><td class="h">997</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">999</td><td colspan="7"></td></tr><tr><td class="h">1000</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ;</td></tr>
<tr><td class="h">1001</td><td colspan="7"></td></tr><tr><td class="h">1002</td><td><div class="c3">72</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">use Class::Autouse qw (</td></tr>
<tr><td class="h">1003</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Poll</td></tr>
<tr><td class="h">1004</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::EmbedModule</td></tr>
<tr><td class="h">1005</td><td><div class="c3">72</div><div class="c3">72</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1005">72</a></div></td><td></td><td><div>4001</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1006</td><td colspan="7"></td></tr><tr><td class="h">1007</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1008</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_logtext2multi</td></tr>
<tr><td class="h">1009</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets log text from clusters.</td></tr>
<tr><td class="h">1010</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: Fetches log text from clusters. Trying slaves first if available.</td></tr>
<tr><td class="h">1011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: hashref with keys being &quot;jid jitemid&quot;, values being [ $subject, $body ]</td></tr>
<tr><td class="h">1012</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: idsbyc</td></tr>
<tr><td class="h">1013</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-idsbyc: A hashref where the key is the clusterid, and the data</td></tr>
<tr><td class="h">1014</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             is an arrayref of [ ownerid, itemid ] array references.</td></tr>
<tr><td class="h">1015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1016</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_logtext2multi</td></tr>
<tr><td class="h">1017</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1018</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1018">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">1019</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return _get_posts_raw_wrapper(shift, &quot;text&quot;);</td></tr>
<tr><td class="h">1020</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1021</td><td colspan="7"></td></tr><tr><td class="h">1022</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># this function is used to translate the old get_logtext2multi and load_log_props2multi</td></tr>
<tr><td class="h">1023</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># functions into using the new get_posts_raw.  eventually, the above functions should</td></tr>
<tr><td class="h">1024</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># be taken out of the rest of the code, at which point this function can also die.</td></tr>
<tr><td class="h">1025</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _get_posts_raw_wrapper {</td></tr>
<tr><td class="h">1026</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# args:</td></tr>
<tr><td class="h">1027</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   { cid =&gt; [ [jid, jitemid]+ ] }</td></tr>
<tr><td class="h">1028</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   &quot;text&quot; or &quot;props&quot;</td></tr>
<tr><td class="h">1029</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   optional hashref to put return value in.  (see get_logtext2multi docs)</td></tr>
<tr><td class="h">1030</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# returns: that hashref.</td></tr>
<tr><td class="h">1031</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1031">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($idsbyc, $type, $ret) = @_;</td></tr>
<tr><td class="h">1032</td><td colspan="7"></td></tr><tr><td class="h">1033</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = {};</td></tr>
<tr><td class="h">1034</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1034">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1034">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($type eq &#39;text&#39;) {</td></tr>
<tr><td class="h">1035</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{text_only} = 1;</td></tr>
<tr><td class="h">1036</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($type eq &#39;prop&#39;) {</td></tr>
<tr><td class="h">1037</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{prop_only} = 1;</td></tr>
<tr><td class="h">1038</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1039</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">1040</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1041</td><td colspan="7"></td></tr><tr><td class="h">1042</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @postids;</td></tr>
<tr><td class="h">1043</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($cid, $ids) = each %$idsbyc) {</td></tr>
<tr><td class="h">1044</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $pair (@$ids) {</td></tr>
<tr><td class="h">1045</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @postids, [ $cid, $pair-&gt;[0], $pair-&gt;[1] ];</td></tr>
<tr><td class="h">1046</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1047</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1048</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rawposts = LJ::get_posts_raw($opts, @postids);</td></tr>
<tr><td class="h">1049</td><td colspan="7"></td></tr><tr><td class="h">1050</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# add replycounts fields to props</td></tr>
<tr><td class="h">1051</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1051">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($type eq &quot;prop&quot;) {</td></tr>
<tr><td class="h">1052</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1052">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %{$rawposts-&gt;{&quot;replycount&quot;}||{}}) {</td></tr>
<tr><td class="h">1053</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rawposts-&gt;{prop}{$k}{replycount} = $rawposts-&gt;{replycount}{$k};</td></tr>
<tr><td class="h">1054</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1055</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1056</td><td colspan="7"></td></tr><tr><td class="h">1057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# translate colon-separated (new) to space-separated (old) keys.</td></tr>
<tr><td class="h">1058</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1058">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret ||= {};</td></tr>
<tr><td class="h">1059</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($id, $data) = each %{$rawposts-&gt;{$type}}) {</td></tr>
<tr><td class="h">1060</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$id =~ s/:/ /;</td></tr>
<tr><td class="h">1061</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{$id} = $data;</td></tr>
<tr><td class="h">1062</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1063</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">1064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1065</td><td colspan="7"></td></tr><tr><td class="h">1066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1067</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_posts_raw</td></tr>
<tr><td class="h">1068</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets raw post data (text and props) efficiently from clusters.</td></tr>
<tr><td class="h">1069</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: Fetches posts from clusters, trying memcache and slaves first if available.</td></tr>
<tr><td class="h">1070</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: hashref with keys &#39;text&#39;, &#39;prop&#39;, or &#39;replycount&#39;, and values being</td></tr>
<tr><td class="h">1071</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          hashrefs with keys &quot;jid:jitemid&quot;.  values of that are as follows:</td></tr>
<tr><td class="h">1072</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          text: [ $subject, $body ], props: { ... }, and replycount: scalar</td></tr>
<tr><td class="h">1073</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: opts?, id</td></tr>
<tr><td class="h">1074</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: An optional hashref of options:</td></tr>
<tr><td class="h">1075</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            - memcache_only:  Don&#39;t fall back on the database.</td></tr>
<tr><td class="h">1076</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            - text_only:  Retrieve only text, no props (used to support old API).</td></tr>
<tr><td class="h">1077</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            - prop_only:  Retrieve only props, no text (used to support old API).</td></tr>
<tr><td class="h">1078</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-id: An arrayref of [ clusterid, ownerid, itemid ].</td></tr>
<tr><td class="h">1079</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1080</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_posts_raw</td></tr>
<tr><td class="h">1081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1082</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1082">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1082">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = ref $_[0] eq &quot;HASH&quot; ? shift : {};</td></tr>
<tr><td class="h">1083</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = {};</td></tr>
<tr><td class="h">1084</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth;</td></tr>
<tr><td class="h">1085</td><td colspan="7"></td></tr><tr><td class="h">1086</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1086">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_props(&#39;log&#39;) unless $opts-&gt;{text_only};</td></tr>
<tr><td class="h">1087</td><td colspan="7"></td></tr><tr><td class="h">1088</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# throughout this function, the concept of an &quot;id&quot;</td></tr>
<tr><td class="h">1089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# is the key to identify a single post.</td></tr>
<tr><td class="h">1090</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# it is of the form &quot;$jid:$jitemid&quot;.</td></tr>
<tr><td class="h">1091</td><td colspan="7"></td></tr><tr><td class="h">1092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# build up a list for each cluster of what we want to get,</td></tr>
<tr><td class="h">1093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# as well as a list of all the keys we want from memcache.</td></tr>
<tr><td class="h">1094</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %cids;      # cid =&gt; 1</td></tr>
<tr><td class="h">1095</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $needtext;  # text needed:  $cid =&gt; $id =&gt; 1</td></tr>
<tr><td class="h">1096</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $needprop;  # props needed: $cid =&gt; $id =&gt; 1</td></tr>
<tr><td class="h">1097</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $needrc;    # replycounts needed: $cid =&gt; $id =&gt; 1</td></tr>
<tr><td class="h">1098</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @mem_keys;</td></tr>
<tr><td class="h">1099</td><td colspan="7"></td></tr><tr><td class="h">1100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we&#39;re loading entries for a friends page,</td></tr>
<tr><td class="h">1101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# silently failing to load a cluster is acceptable.</td></tr>
<tr><td class="h">1102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# but for a single user, we want to die loudly so they don&#39;t think</td></tr>
<tr><td class="h">1103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we just lost their journal.</td></tr>
<tr><td class="h">1104</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $single_user;</td></tr>
<tr><td class="h">1105</td><td colspan="7"></td></tr><tr><td class="h">1106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# because the memcache keys for logprop don&#39;t contain</td></tr>
<tr><td class="h">1107</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# which cluster they&#39;re in, we also need a map to get the</td></tr>
<tr><td class="h">1108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# cid back from the jid so we can insert into the needfoo hashes.</td></tr>
<tr><td class="h">1109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the alternative is to not key the needfoo hashes on cluster,</td></tr>
<tr><td class="h">1110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# but that means we need to grep out each cluster&#39;s jids when</td></tr>
<tr><td class="h">1111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we do per-cluster queries on the databases.</td></tr>
<tr><td class="h">1112</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %cidsbyjid;</td></tr>
<tr><td class="h">1113</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $post (@_) {</td></tr>
<tr><td class="h">1114</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($cid, $jid, $jitemid) = @{$post};</td></tr>
<tr><td class="h">1115</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = &quot;$jid:$jitemid&quot;;</td></tr>
<tr><td class="h">1116</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1116">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1116">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1116">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (not defined $single_user) {</td></tr>
<tr><td class="h">1117</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$single_user = $jid;</td></tr>
<tr><td class="h">1118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($single_user and $jid != $single_user) {</td></tr>
<tr><td class="h">1119</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# multiple users</td></tr>
<tr><td class="h">1120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$single_user = 0;</td></tr>
<tr><td class="h">1121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1122</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cids{$cid} = 1;</td></tr>
<tr><td class="h">1123</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cidsbyjid{$jid} = $cid;</td></tr>
<tr><td class="h">1124</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1124">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{prop_only}) {</td></tr>
<tr><td class="h">1125</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$needtext-&gt;{$cid}{$id} = 1;</td></tr>
<tr><td class="h">1126</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @mem_keys, [$jid,&quot;logtext:$cid:$id&quot;];</td></tr>
<tr><td class="h">1127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1128</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1128">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{text_only}) {</td></tr>
<tr><td class="h">1129</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$needprop-&gt;{$cid}{$id} = 1;</td></tr>
<tr><td class="h">1130</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @mem_keys, [$jid,&quot;logprop:$id&quot;];</td></tr>
<tr><td class="h">1131</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$needrc-&gt;{$cid}{$id} = 1;</td></tr>
<tr><td class="h">1132</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @mem_keys, [$jid,&quot;rp:$id&quot;];</td></tr>
<tr><td class="h">1133</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1135</td><td colspan="7"></td></tr><tr><td class="h">1136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# first, check memcache.</td></tr>
<tr><td class="h">1137</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1137">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mem = LJ::MemCache::get_multi(@mem_keys) || {};</td></tr>
<tr><td class="h">1138</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %$mem) {</td></tr>
<tr><td class="h">1139</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1139">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless defined $v;</td></tr>
<tr><td class="h">1140</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1140">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $k =~ /(\w+):(?:\d+:)?(\d+):(\d+)/;</td></tr>
<tr><td class="h">1141</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($type, $jid, $jitemid) = ($1, $2, $3);</td></tr>
<tr><td class="h">1142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cid = $cidsbyjid{$jid};</td></tr>
<tr><td class="h">1143</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = &quot;$jid:$jitemid&quot;;</td></tr>
<tr><td class="h">1144</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1144">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1144">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1144">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1144">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($type eq &quot;logtext&quot;) {</td></tr>
<tr><td class="h">1145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $needtext-&gt;{$cid}{$id};</td></tr>
<tr><td class="h">1146</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{text}{$id} = $v;</td></tr>
<tr><td class="h">1147</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($type eq &quot;logprop&quot; &amp;&amp; ref $v eq &quot;HASH&quot;) {</td></tr>
<tr><td class="h">1148</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $needprop-&gt;{$cid}{$id};</td></tr>
<tr><td class="h">1149</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{prop}{$id} = $v;</td></tr>
<tr><td class="h">1150</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($type eq &quot;rp&quot;) {</td></tr>
<tr><td class="h">1151</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $needrc-&gt;{$cid}{$id};</td></tr>
<tr><td class="h">1152</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{replycount}{$id} = int($v); # remove possible spaces</td></tr>
<tr><td class="h">1153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1155</td><td colspan="7"></td></tr><tr><td class="h">1156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we may be done already.</td></tr>
<tr><td class="h">1157</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1157">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret if $opts-&gt;{memcache_only};</td></tr>
<tr><td class="h">1158</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1158">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1158">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret unless values %$needtext or values %$needprop</td></tr>
<tr><td class="h">1159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or values %$needrc;</td></tr>
<tr><td class="h">1160</td><td colspan="7"></td></tr><tr><td class="h">1161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# otherwise, hit the database.</td></tr>
<tr><td class="h">1162</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $cid (keys %cids) {</td></tr>
<tr><td class="h">1163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# for each cluster, get the text/props we need from it.</td></tr>
<tr><td class="h">1164</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1164">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cneedtext = $needtext-&gt;{$cid} || {};</td></tr>
<tr><td class="h">1165</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1165">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cneedprop = $needprop-&gt;{$cid} || {};</td></tr>
<tr><td class="h">1166</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1166">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cneedrc   = $needrc-&gt;{$cid} || {};</td></tr>
<tr><td class="h">1167</td><td colspan="7"></td></tr><tr><td class="h">1168</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1168">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1168">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless %$cneedtext or %$cneedprop or %$cneedrc;</td></tr>
<tr><td class="h">1169</td><td colspan="7"></td></tr><tr><td class="h">1170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $make_in = sub {</td></tr>
<tr><td class="h">1171</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1171">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @in;</td></tr>
<tr><td class="h">1172</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $id (@_) {</td></tr>
<tr><td class="h">1173</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($jid, $jitemid) = map { $_ + 0 } split(/:/, $id);</td></tr>
<tr><td class="h">1174</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @in, &quot;(journalid=$jid AND jitemid=$jitemid)&quot;;</td></tr>
<tr><td class="h">1175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1176</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return join(&quot; OR &quot;, @in);</td></tr>
<tr><td class="h">1177</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1178</td><td colspan="7"></td></tr><tr><td class="h">1179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# now load from each cluster.</td></tr>
<tr><td class="h">1180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fetchtext = sub {</td></tr>
<tr><td class="h">1181</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1181">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = shift;</td></tr>
<tr><td class="h">1182</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1182">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless %$cneedtext;</td></tr>
<tr><td class="h">1183</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = $make_in-&gt;(keys %$cneedtext);</td></tr>
<tr><td class="h">1184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $db-&gt;prepare(&quot;SELECT journalid, jitemid, subject, event &quot;.</td></tr>
<tr><td class="h">1185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM logtext2 WHERE $in&quot;);</td></tr>
<tr><td class="h">1186</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">1187</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($jid, $jitemid, $subject, $event) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">1188</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_uncompress(\$event);</td></tr>
<tr><td class="h">1189</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = &quot;$jid:$jitemid&quot;;</td></tr>
<tr><td class="h">1190</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $val = [ $subject, $event ];</td></tr>
<tr><td class="h">1191</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{text}{$id} = $val;</td></tr>
<tr><td class="h">1192</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add([$jid,&quot;logtext:$cid:$id&quot;], $val);</td></tr>
<tr><td class="h">1193</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $cneedtext-&gt;{$id};</td></tr>
<tr><td class="h">1194</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1195</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1196</td><td colspan="7"></td></tr><tr><td class="h">1197</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fetchprop = sub {</td></tr>
<tr><td class="h">1198</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1198">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = shift;</td></tr>
<tr><td class="h">1199</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1199">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless %$cneedprop;</td></tr>
<tr><td class="h">1200</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = $make_in-&gt;(keys %$cneedprop);</td></tr>
<tr><td class="h">1201</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $db-&gt;prepare(&quot;SELECT journalid, jitemid, propid, value &quot;.</td></tr>
<tr><td class="h">1202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM logprop2 WHERE $in&quot;);</td></tr>
<tr><td class="h">1203</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">1204</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %gotid;</td></tr>
<tr><td class="h">1205</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($jid, $jitemid, $propid, $value) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">1206</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = &quot;$jid:$jitemid&quot;;</td></tr>
<tr><td class="h">1207</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $propname = $LJ::CACHE_PROPID{&#39;log&#39;}-&gt;{$propid}{name};</td></tr>
<tr><td class="h">1208</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{prop}{$id}{$propname} = $value;</td></tr>
<tr><td class="h">1209</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$gotid{$id} = 1;</td></tr>
<tr><td class="h">1210</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $id (keys %gotid) {</td></tr>
<tr><td class="h">1212</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($jid, $jitemid) = map { $_ + 0 } split(/:/, $id);</td></tr>
<tr><td class="h">1213</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add([$jid, &quot;logprop:$id&quot;], $ret-&gt;{prop}{$id});</td></tr>
<tr><td class="h">1214</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $cneedprop-&gt;{$id};</td></tr>
<tr><td class="h">1215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1216</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1217</td><td colspan="7"></td></tr><tr><td class="h">1218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fetchrc = sub {</td></tr>
<tr><td class="h">1219</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1219">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = shift;</td></tr>
<tr><td class="h">1220</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1220">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless %$cneedrc;</td></tr>
<tr><td class="h">1221</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = $make_in-&gt;(keys %$cneedrc);</td></tr>
<tr><td class="h">1222</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $db-&gt;prepare(&quot;SELECT journalid, jitemid, replycount FROM log2 WHERE $in&quot;);</td></tr>
<tr><td class="h">1223</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">1224</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($jid, $jitemid, $rc) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">1225</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = &quot;$jid:$jitemid&quot;;</td></tr>
<tr><td class="h">1226</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{replycount}{$id} = $rc;</td></tr>
<tr><td class="h">1227</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add([$jid, &quot;rp:$id&quot;], $rc);</td></tr>
<tr><td class="h">1228</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $cneedrc-&gt;{$id};</td></tr>
<tr><td class="h">1229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1230</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1231</td><td colspan="7"></td></tr><tr><td class="h">1232</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dberr = sub {</td></tr>
<tr><td class="h">1233</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1233">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1233">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Couldn&#39;t connect to database&quot; if $single_user;</td></tr>
<tr><td class="h">1234</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next;</td></tr>
<tr><td class="h">1235</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1236</td><td colspan="7"></td></tr><tr><td class="h">1237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# run the fetch functions on the proper databases, with fallbacks if necessary.</td></tr>
<tr><td class="h">1238</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($dbcm, $dbcr);</td></tr>
<tr><td class="h">1239</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1239">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1239">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@LJ::MEMCACHE_SERVERS or $opts-&gt;{use_master}) {</td></tr>
<tr><td class="h">1240</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1240">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1240">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbcm ||= LJ::get_cluster_master($cid) or $dberr-&gt;();</td></tr>
<tr><td class="h">1241</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1241">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fetchtext-&gt;($dbcm) if %$cneedtext;</td></tr>
<tr><td class="h">1242</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1242">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fetchprop-&gt;($dbcm) if %$cneedprop;</td></tr>
<tr><td class="h">1243</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1243">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fetchrc-&gt;($dbcm) if %$cneedrc;</td></tr>
<tr><td class="h">1244</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1245</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1245">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbcr ||= LJ::get_cluster_reader($cid);</td></tr>
<tr><td class="h">1246</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1246">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($dbcr) {</td></tr>
<tr><td class="h">1247</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1247">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fetchtext-&gt;($dbcr) if %$cneedtext;</td></tr>
<tr><td class="h">1248</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1248">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fetchprop-&gt;($dbcr) if %$cneedprop;</td></tr>
<tr><td class="h">1249</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1249">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fetchrc-&gt;($dbcr) if %$cneedrc;</td></tr>
<tr><td class="h">1250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1251</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if we still need some data, switch to the master.</td></tr>
<tr><td class="h">1252</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1252">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1252">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (%$cneedtext or %$cneedprop) {</td></tr>
<tr><td class="h">1253</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1253">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1253">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbcm ||= LJ::get_cluster_master($cid) or $dberr-&gt;();</td></tr>
<tr><td class="h">1254</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fetchtext-&gt;($dbcm);</td></tr>
<tr><td class="h">1255</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fetchprop-&gt;($dbcm);</td></tr>
<tr><td class="h">1256</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fetchrc-&gt;($dbcm);</td></tr>
<tr><td class="h">1257</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1258</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1259</td><td colspan="7"></td></tr><tr><td class="h">1260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# and finally, if there were no errors,</td></tr>
<tr><td class="h">1261</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# insert into memcache the absence of props</td></tr>
<tr><td class="h">1262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# for all posts that didn&#39;t have any props.</td></tr>
<tr><td class="h">1263</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $id (keys %$cneedprop) {</td></tr>
<tr><td class="h">1264</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($jid, $jitemid) = map { $_ + 0 } split(/:/, $id);</td></tr>
<tr><td class="h">1265</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$jid, &quot;logprop:$id&quot;], {});</td></tr>
<tr><td class="h">1266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1268</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">1269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1270</td><td colspan="7"></td></tr><tr><td class="h">1271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_posts</td></tr>
<tr><td class="h">1272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1273</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1273">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1273">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = ref $_[0] eq &quot;HASH&quot; ? shift : {};</td></tr>
<tr><td class="h">1274</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rawposts = get_posts_raw($opts, @_);</td></tr>
<tr><td class="h">1275</td><td colspan="7"></td></tr><tr><td class="h">1276</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# fix up posts as needed for display, following directions given in opts.</td></tr>
<tr><td class="h">1277</td><td colspan="7"></td></tr><tr><td class="h">1278</td><td colspan="7"></td></tr><tr><td class="h">1279</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# XXX this function is incomplete.  it should also HTML clean, etc.</td></tr>
<tr><td class="h">1280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# XXX we need to load users when we have unknown8bit data, but that</td></tr>
<tr><td class="h">1281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# XXX means we have to load users.</td></tr>
<tr><td class="h">1282</td><td colspan="7"></td></tr><tr><td class="h">1283</td><td colspan="7"></td></tr><tr><td class="h">1284</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($id, $rp) = each %$rawposts) {</td></tr>
<tr><td class="h">1285</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1285">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1285">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $rp-&gt;{props}{unknown8bit}) {</td></tr>
<tr><td class="h">1286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#LJ::item_toutf8($u, \$rp-&gt;{text}[0], \$rp-&gt;{text}[1], $rp-&gt;{props});</td></tr>
<tr><td class="h">1287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1289</td><td colspan="7"></td></tr><tr><td class="h">1290</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rawposts;</td></tr>
<tr><td class="h">1291</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1292</td><td colspan="7"></td></tr><tr><td class="h">1293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a row from log2, trying memcache</td></tr>
<tr><td class="h">1295</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># accepts $u + $jitemid</td></tr>
<tr><td class="h">1296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns hash with: posterid, eventtime, logtime,</td></tr>
<tr><td class="h">1297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># security, allowmask, journalid, jitemid, anum.</td></tr>
<tr><td class="h">1298</td><td colspan="7"></td></tr><tr><td class="h">1299</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_log2_row</td></tr>
<tr><td class="h">1300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1301</td><td><div class="c3">35</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1301">35</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $jitemid) = @_;</td></tr>
<tr><td class="h">1302</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jid = $u-&gt;{&#39;userid&#39;};</td></tr>
<tr><td class="h">1303</td><td colspan="7"></td></tr><tr><td class="h">1304</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$jid, &quot;log2:$jid:$jitemid&quot;];</td></tr>
<tr><td class="h">1305</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($row, $item);</td></tr>
<tr><td class="h">1306</td><td colspan="7"></td></tr><tr><td class="h">1307</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$row = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">1308</td><td colspan="7"></td></tr><tr><td class="h">1309</td><td><div class="c3">35</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1309">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($row) {</td></tr>
<tr><td class="h">1310</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@$item{&#39;posterid&#39;, &#39;eventtime&#39;, &#39;logtime&#39;, &#39;allowmask&#39;, &#39;ditemid&#39;} = unpack(&quot;NNNQN&quot;, $row);</td></tr>
<tr><td class="h">1311</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1311">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1311">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;security&#39;} = ($item-&gt;{&#39;allowmask&#39;} == 0 ? &#39;private&#39; :</td></tr>
<tr><td class="h">1312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($item-&gt;{&#39;allowmask&#39;} == 2**63 ? &#39;public&#39; : &#39;usemask&#39;));</td></tr>
<tr><td class="h">1313</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;journalid&#39;} = $jid;</td></tr>
<tr><td class="h">1314</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@$item{&#39;jitemid&#39;, &#39;anum&#39;} = ($item-&gt;{&#39;ditemid&#39;} &gt;&gt; 8, $item-&gt;{&#39;ditemid&#39;} % 256);</td></tr>
<tr><td class="h">1315</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;eventtime&#39;} = LJ::mysql_time($item-&gt;{&#39;eventtime&#39;}, 1);</td></tr>
<tr><td class="h">1316</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;logtime&#39;} = LJ::mysql_time($item-&gt;{&#39;logtime&#39;}, 1);</td></tr>
<tr><td class="h">1317</td><td colspan="7"></td></tr><tr><td class="h">1318</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $item;</td></tr>
<tr><td class="h">1319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1320</td><td colspan="7"></td></tr><tr><td class="h">1321</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db = LJ::get_cluster_def_reader($u);</td></tr>
<tr><td class="h">1322</td><td><div class="c3">35</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1322">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $db;</td></tr>
<tr><td class="h">1323</td><td colspan="7"></td></tr><tr><td class="h">1324</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sql = &quot;SELECT posterid, eventtime, logtime, security, allowmask, &quot; .</td></tr>
<tr><td class="h">1325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;anum FROM log2 WHERE journalid=? AND jitemid=?&quot;;</td></tr>
<tr><td class="h">1326</td><td colspan="7"></td></tr><tr><td class="h">1327</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item = $db-&gt;selectrow_hashref($sql, undef, $jid, $jitemid);</td></tr>
<tr><td class="h">1328</td><td><div class="c3">35</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1328">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $item;</td></tr>
<tr><td class="h">1329</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;journalid&#39;} = $jid;</td></tr>
<tr><td class="h">1330</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;jitemid&#39;} = $jitemid;</td></tr>
<tr><td class="h">1331</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;ditemid&#39;} = $jitemid*256 + $item-&gt;{&#39;anum&#39;};</td></tr>
<tr><td class="h">1332</td><td colspan="7"></td></tr><tr><td class="h">1333</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($sec, $eventtime, $logtime);</td></tr>
<tr><td class="h">1334</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sec = $item-&gt;{&#39;allowmask&#39;};</td></tr>
<tr><td class="h">1335</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1335">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sec = 0 if $item-&gt;{&#39;security&#39;} eq &#39;private&#39;;</td></tr>
<tr><td class="h">1336</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1336">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sec = 2**63 if $item-&gt;{&#39;security&#39;} eq &#39;public&#39;;</td></tr>
<tr><td class="h">1337</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$eventtime = LJ::mysqldate_to_time($item-&gt;{&#39;eventtime&#39;}, 1);</td></tr>
<tr><td class="h">1338</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$logtime = LJ::mysqldate_to_time($item-&gt;{&#39;logtime&#39;}, 1);</td></tr>
<tr><td class="h">1339</td><td colspan="7"></td></tr><tr><td class="h">1340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# note: this cannot distinguish between security == private and security == usemask with allowmask == 0 (no groups)</td></tr>
<tr><td class="h">1341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# both should have the same display behavior, but we don&#39;t store the security value in memcache</td></tr>
<tr><td class="h">1342</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$row = pack(&quot;NNNQN&quot;, $item-&gt;{&#39;posterid&#39;}, $eventtime, $logtime, $sec,</td></tr>
<tr><td class="h">1343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;ditemid&#39;});</td></tr>
<tr><td class="h">1344</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $row);</td></tr>
<tr><td class="h">1345</td><td colspan="7"></td></tr><tr><td class="h">1346</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $item;</td></tr>
<tr><td class="h">1347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1348</td><td colspan="7"></td></tr><tr><td class="h">1349</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># get 2 weeks worth of recent items, in rlogtime order,</td></tr>
<tr><td class="h">1350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># using memcache</td></tr>
<tr><td class="h">1351</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># accepts $u or ($jid, $clusterid) + $notafter - max value for rlogtime</td></tr>
<tr><td class="h">1352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $update is the timeupdate for this user, as far as the caller knows,</td></tr>
<tr><td class="h">1353</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># in UNIX time.</td></tr>
<tr><td class="h">1354</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns hash keyed by $jitemid, fields:</td></tr>
<tr><td class="h">1355</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># posterid, eventtime, rlogtime,</td></tr>
<tr><td class="h">1356</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># security, allowmask, journalid, jitemid, anum.</td></tr>
<tr><td class="h">1357</td><td colspan="7"></td></tr><tr><td class="h">1358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_log2_recent_log</td></tr>
<tr><td class="h">1359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1360</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1360">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $cid, $update, $notafter, $events_date) = @_;</td></tr>
<tr><td class="h">1361</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jid = LJ::want_userid($u);</td></tr>
<tr><td class="h">1362</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1362">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1362">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cid ||= $u-&gt;{&#39;clusterid&#39;} if ref $u;</td></tr>
<tr><td class="h">1363</td><td colspan="7"></td></tr><tr><td class="h">1364</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $DATAVER = &quot;4&quot;; # 1 char</td></tr>
<tr><td class="h">1365</td><td colspan="7"></td></tr><tr><td class="h">1366</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $use_cache = 1;</td></tr>
<tr><td class="h">1367</td><td colspan="7"></td></tr><tr><td class="h">1368</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# timestamp</td></tr>
<tr><td class="h">1369</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$events_date = int $events_date;</td></tr>
<tr><td class="h">1370</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1370">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$use_cache = 0 if $events_date; # do not use memcache for dayly friends log</td></tr>
<tr><td class="h">1371</td><td colspan="7"></td></tr><tr><td class="h">1372</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey  = [$jid, &quot;log2lt:$jid&quot;];</td></tr>
<tr><td class="h">1373</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lockkey = $memkey-&gt;[1];</td></tr>
<tr><td class="h">1374</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($rows, $ret);</td></tr>
<tr><td class="h">1375</td><td colspan="7"></td></tr><tr><td class="h">1376</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1376">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rows = LJ::MemCache::get($memkey) if $use_cache;</td></tr>
<tr><td class="h">1377</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret = [];</td></tr>
<tr><td class="h">1378</td><td colspan="7"></td></tr><tr><td class="h">1379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $construct_singleton = sub {</td></tr>
<tr><td class="h">1380</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1380">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $row (@$ret) {</td></tr>
<tr><td class="h">1381</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row-&gt;{journalid} = $jid;</td></tr>
<tr><td class="h">1382</td><td colspan="7"></td></tr><tr><td class="h">1383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# FIX:</td></tr>
<tr><td class="h">1384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# logtime param should be datetime, not unixtimestamp.</td></tr>
<tr><td class="h">1385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</td></tr>
<tr><td class="h">1386</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row-&gt;{logtime} = LJ::mysql_time($LJ::EndOfTime - $row-&gt;{rlogtime}, 1);</td></tr>
<tr><td class="h">1387</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# construct singleton for later</td></tr>
<tr><td class="h">1388</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Entry-&gt;new_from_row(%$row);</td></tr>
<tr><td class="h">1389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1390</td><td colspan="7"></td></tr><tr><td class="h">1391</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">1392</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1393</td><td colspan="7"></td></tr><tr><td class="h">1394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rows_decode = sub {</td></tr>
<tr><td class="h">1395</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1395">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1395">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1395">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0</td></tr>
<tr><td class="h">1396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $rows &amp;&amp; substr($rows, 0, 1) eq $DATAVER;</td></tr>
<tr><td class="h">1397</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tu = unpack(&quot;N&quot;, substr($rows, 1, 4));</td></tr>
<tr><td class="h">1398</td><td colspan="7"></td></tr><tr><td class="h">1399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if update time we got from upstream is newer than recorded</td></tr>
<tr><td class="h">1400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# here, this data is unreliable</td></tr>
<tr><td class="h">1401</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1401">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $update &gt; $tu;</td></tr>
<tr><td class="h">1402</td><td colspan="7"></td></tr><tr><td class="h">1403</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $n = (length($rows) - 5)/24;</td></tr>
<tr><td class="h">1404</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (my $i=0; $i&lt;$n; $i++) {</td></tr>
<tr><td class="h">1405</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($posterid, $eventtime, $rlogtime, $allowmask, $ditemid) =</td></tr>
<tr><td class="h">1406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unpack(&quot;NNNQN&quot;, substr($rows, $i*24+5, 24));</td></tr>
<tr><td class="h">1407</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1407">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1407">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $notafter and $rlogtime &gt; $notafter;</td></tr>
<tr><td class="h">1408</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$eventtime = LJ::mysql_time($eventtime, 1);</td></tr>
<tr><td class="h">1409</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1409">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1409">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $security = $allowmask == 0 ? &#39;private&#39; :</td></tr>
<tr><td class="h">1410</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($allowmask == 2**63 ? &#39;public&#39; : &#39;usemask&#39;);</td></tr>
<tr><td class="h">1411</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($jitemid, $anum) = ($ditemid &gt;&gt; 8, $ditemid % 256);</td></tr>
<tr><td class="h">1412</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $item = {};</td></tr>
<tr><td class="h">1413</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@$item{&#39;posterid&#39;,&#39;eventtime&#39;,&#39;rlogtime&#39;,&#39;allowmask&#39;,&#39;ditemid&#39;,</td></tr>
<tr><td class="h">1414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;security&#39;,&#39;journalid&#39;, &#39;jitemid&#39;, &#39;anum&#39;} =</td></tr>
<tr><td class="h">1415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($posterid, $eventtime, $rlogtime, $allowmask,</td></tr>
<tr><td class="h">1416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ditemid, $security, $jid, $jitemid, $anum);</td></tr>
<tr><td class="h">1417</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;ownerid&#39;} = $jid;</td></tr>
<tr><td class="h">1418</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;itemid&#39;} = $jitemid;</td></tr>
<tr><td class="h">1419</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$ret, $item;</td></tr>
<tr><td class="h">1420</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1421</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1422</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1423</td><td colspan="7"></td></tr><tr><td class="h">1424</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1424">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $construct_singleton-&gt;()</td></tr>
<tr><td class="h">1425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $rows_decode-&gt;();</td></tr>
<tr><td class="h">1426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rows = &quot;&quot;;</td></tr>
<tr><td class="h">1427</td><td colspan="7"></td></tr><tr><td class="h">1428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db = LJ::get_cluster_def_reader($cid);</td></tr>
<tr><td class="h">1429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we use slave or didn&#39;t get some data, don&#39;t store in memcache</td></tr>
<tr><td class="h">1430</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dont_store = 0;</td></tr>
<tr><td class="h">1431</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1431">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($db) {</td></tr>
<tr><td class="h">1432</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db = LJ::get_cluster_reader($cid);</td></tr>
<tr><td class="h">1433</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dont_store = 1;</td></tr>
<tr><td class="h">1434</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1434">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $db;</td></tr>
<tr><td class="h">1435</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1436</td><td colspan="7"></td></tr><tr><td class="h">1437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#</td></tr>
<tr><td class="h">1438</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lock = $db-&gt;selectrow_array(&quot;SELECT GET_LOCK(?,10)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">1439</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1439">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $lock;</td></tr>
<tr><td class="h">1440</td><td colspan="7"></td></tr><tr><td class="h">1441</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1441">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($use_cache){</td></tr>
<tr><td class="h">1442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# try to get cached data in exclusive context</td></tr>
<tr><td class="h">1443</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rows = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">1444</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1444">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($rows_decode-&gt;()) {</td></tr>
<tr><td class="h">1445</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;selectrow_array(&quot;SELECT RELEASE_LOCK(?)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">1446</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $construct_singleton-&gt;();</td></tr>
<tr><td class="h">1447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1449</td><td colspan="7"></td></tr><tr><td class="h">1450</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# ok. fetch data directly from DB.</td></tr>
<tr><td class="h">1451</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rows = &quot;&quot;;</td></tr>
<tr><td class="h">1452</td><td colspan="7"></td></tr><tr><td class="h">1453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get reliable update time from the db</td></tr>
<tr><td class="h">1454</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO: check userprop first</td></tr>
<tr><td class="h">1455</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $tu;</td></tr>
<tr><td class="h">1456</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">1457</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1457">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($dbh) {</td></tr>
<tr><td class="h">1458</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tu = $dbh-&gt;selectrow_array(&quot;SELECT UNIX_TIMESTAMP(timeupdate) &quot; .</td></tr>
<tr><td class="h">1459</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM userusage WHERE userid=?&quot;,</td></tr>
<tr><td class="h">1460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $jid);</td></tr>
<tr><td class="h">1461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if no mistake, treat absence of row as tu==0 (new user)</td></tr>
<tr><td class="h">1462</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1462">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1462">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tu = 0 unless $tu || $dbh-&gt;err;</td></tr>
<tr><td class="h">1463</td><td colspan="7"></td></tr><tr><td class="h">1464</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1464">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$jid, &quot;tu:$jid&quot;], pack(&quot;N&quot;, $tu), 30*60)</td></tr>
<tr><td class="h">1465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if defined $tu;</td></tr>
<tr><td class="h">1466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# TODO: update userprop if necessary</td></tr>
<tr><td class="h">1467</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1468</td><td colspan="7"></td></tr><tr><td class="h">1469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we didn&#39;t get tu, don&#39;t bother to memcache</td></tr>
<tr><td class="h">1470</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1470">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dont_store = 1 unless defined $tu;</td></tr>
<tr><td class="h">1471</td><td colspan="7"></td></tr><tr><td class="h">1472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get reliable log2lt data from the db</td></tr>
<tr><td class="h">1473</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1473">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $max_age = $LJ::MAX_FRIENDS_VIEW_AGE || 3600*24*14; # 2 weeks default</td></tr>
<tr><td class="h">1474</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1474">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sql = &quot;</td></tr>
<tr><td class="h">1475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT</td></tr>
<tr><td class="h">1476</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jitemid, posterid, eventtime, rlogtime,</td></tr>
<tr><td class="h">1477</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;security, allowmask, anum, replycount</td></tr>
<tr><td class="h">1478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM log2</td></tr>
<tr><td class="h">1479</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;USE INDEX (rlogtime)</td></tr>
<tr><td class="h">1480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE</td></tr>
<tr><td class="h">1481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;journalid=?</td></tr>
<tr><td class="h">1482</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; .</td></tr>
<tr><td class="h">1483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($events_date</td></tr>
<tr><td class="h">1484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?</td></tr>
<tr><td class="h">1485</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND rlogtime &lt;= ($LJ::EndOfTime - $events_date)</td></tr>
<tr><td class="h">1486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND rlogtime &gt;= ($LJ::EndOfTime - &quot; . ($events_date + 24*3600) . &quot;)&quot;</td></tr>
<tr><td class="h">1487</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:</td></tr>
<tr><td class="h">1488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND rlogtime &lt;= ($LJ::EndOfTime - UNIX_TIMESTAMP()) + $max_age&quot;</td></tr>
<tr><td class="h">1489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">1490</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;</td></tr>
<tr><td class="h">1491</td><td colspan="7"></td></tr><tr><td class="h">1492</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $db-&gt;prepare($sql);</td></tr>
<tr><td class="h">1493</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($jid);</td></tr>
<tr><td class="h">1494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @row = ();</td></tr>
<tr><td class="h">1495</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @row, $_ while $_ = $sth-&gt;fetchrow_hashref;</td></tr>
<tr><td class="h">1496</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;@row = sort { $a-&gt;{&#39;rlogtime&#39;} &lt;=&gt; $b-&gt;{&#39;rlogtime&#39;} } @row;</td></tr>
<tr><td class="h">1497</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemnum = 0;</td></tr>
<tr><td class="h">1498</td><td colspan="7"></td></tr><tr><td class="h">1499</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $item (@row) {</td></tr>
<tr><td class="h">1500</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;ownerid&#39;} = $item-&gt;{&#39;journalid&#39;} = $jid;</td></tr>
<tr><td class="h">1501</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;itemid&#39;} = $item-&gt;{&#39;jitemid&#39;};</td></tr>
<tr><td class="h">1502</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$ret, $item;</td></tr>
<tr><td class="h">1503</td><td colspan="7"></td></tr><tr><td class="h">1504</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($sec, $ditemid, $eventtime, $logtime);</td></tr>
<tr><td class="h">1505</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sec = $item-&gt;{&#39;allowmask&#39;};</td></tr>
<tr><td class="h">1506</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1506">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sec = 0 if $item-&gt;{&#39;security&#39;} eq &#39;private&#39;;</td></tr>
<tr><td class="h">1507</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1507">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sec = 2**63 if $item-&gt;{&#39;security&#39;} eq &#39;public&#39;;</td></tr>
<tr><td class="h">1508</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ditemid = $item-&gt;{&#39;jitemid&#39;}*256 + $item-&gt;{&#39;anum&#39;};</td></tr>
<tr><td class="h">1509</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$eventtime = LJ::mysqldate_to_time($item-&gt;{&#39;eventtime&#39;}, 1);</td></tr>
<tr><td class="h">1510</td><td colspan="7"></td></tr><tr><td class="h">1511</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rows .= pack(&quot;NNNQN&quot;,</td></tr>
<tr><td class="h">1512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;posterid&#39;},</td></tr>
<tr><td class="h">1513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$eventtime,</td></tr>
<tr><td class="h">1514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;rlogtime&#39;},</td></tr>
<tr><td class="h">1515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sec,</td></tr>
<tr><td class="h">1516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ditemid);</td></tr>
<tr><td class="h">1517</td><td colspan="7"></td></tr><tr><td class="h">1518</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1518">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1518">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($use_cache &amp;&amp; $itemnum++ &lt; 50) {</td></tr>
<tr><td class="h">1519</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add([$jid, &quot;rp:$jid:$item-&gt;{&#39;jitemid&#39;}&quot;], $item-&gt;{&#39;replycount&#39;});</td></tr>
<tr><td class="h">1520</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1521</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1522</td><td colspan="7"></td></tr><tr><td class="h">1523</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rows = $DATAVER . pack(&quot;N&quot;, $tu) . $rows;</td></tr>
<tr><td class="h">1524</td><td colspan="7"></td></tr><tr><td class="h">1525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# store journal log in cache</td></tr>
<tr><td class="h">1526</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1526">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1526">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $rows)</td></tr>
<tr><td class="h">1527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $use_cache and not $dont_store;</td></tr>
<tr><td class="h">1528</td><td colspan="7"></td></tr><tr><td class="h">1529</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;selectrow_array(&quot;SELECT RELEASE_LOCK(?)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">1530</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $construct_singleton-&gt;();</td></tr>
<tr><td class="h">1531</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1532</td><td colspan="7"></td></tr><tr><td class="h">1533</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_log2_recent_user</td></tr>
<tr><td class="h">1534</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1535</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1535">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = shift;</td></tr>
<tr><td class="h">1536</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = [];</td></tr>
<tr><td class="h">1537</td><td colspan="7"></td></tr><tr><td class="h">1538</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $log = LJ::get_log2_recent_log($opts-&gt;{&#39;userid&#39;}, $opts-&gt;{&#39;clusterid&#39;},</td></tr>
<tr><td class="h">1539</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;update&#39;}, $opts-&gt;{&#39;notafter&#39;}, $opts-&gt;{events_date});</td></tr>
<tr><td class="h">1540</td><td colspan="7"></td></tr><tr><td class="h">1541</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $left     = $opts-&gt;{&#39;itemshow&#39;};</td></tr>
<tr><td class="h">1542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $notafter = $opts-&gt;{&#39;notafter&#39;};</td></tr>
<tr><td class="h">1543</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote   = $opts-&gt;{&#39;remote&#39;};</td></tr>
<tr><td class="h">1544</td><td colspan="7"></td></tr><tr><td class="h">1545</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %mask_for_remote = (); # jid =&gt; mask for $remote</td></tr>
<tr><td class="h">1546</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $item (@$log) {</td></tr>
<tr><td class="h">1547</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1547">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last unless $left;</td></tr>
<tr><td class="h">1548</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1548">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1548">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $notafter and $item-&gt;{&#39;rlogtime&#39;} &gt; $notafter;</td></tr>
<tr><td class="h">1549</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1549">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1549">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $remote || $item-&gt;{&#39;security&#39;} eq &#39;public&#39;;</td></tr>
<tr><td class="h">1550</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1550">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1550">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $item-&gt;{&#39;security&#39;} eq &#39;private&#39;</td></tr>
<tr><td class="h">1551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and $item-&gt;{&#39;journalid&#39;} != $remote-&gt;{&#39;userid&#39;};</td></tr>
<tr><td class="h">1552</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1552">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($item-&gt;{&#39;security&#39;} eq &#39;usemask&#39;) {</td></tr>
<tr><td class="h">1553</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1553">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $remote-&gt;is_individual;</td></tr>
<tr><td class="h">1554</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $permit = ($item-&gt;{&#39;journalid&#39;} == $remote-&gt;{&#39;userid&#39;});</td></tr>
<tr><td class="h">1555</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1555">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($permit) {</td></tr>
<tr><td class="h">1556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# $mask for $item{journalid} should always be the same since get_log2_recent_log</td></tr>
<tr><td class="h">1557</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# selects based on the $u we pass in; $u-&gt;id == $item-&gt;{journalid} from what I can see</td></tr>
<tr><td class="h">1558</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# -- we&#39;ll store in a per-journalid hash to be safe, but still avoid</td></tr>
<tr><td class="h">1559</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#    extra memcache calls</td></tr>
<tr><td class="h">1560</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mask = $mask_for_remote{$item-&gt;{journalid}};</td></tr>
<tr><td class="h">1561</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1561">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless (defined $mask) {</td></tr>
<tr><td class="h">1562</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ju = LJ::load_userid( $item-&gt;{journalid} );</td></tr>
<tr><td class="h">1563</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1563">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $ju-&gt;is_community ) {</td></tr>
<tr><td class="h">1564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# communities don&#39;t have masks towards users, so fake it</td></tr>
<tr><td class="h">1565</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1565">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mask = $remote-&gt;member_of( $ju ) ? 1 : 0;</td></tr>
<tr><td class="h">1566</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1567</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mask = $ju-&gt;trustmask( $remote );</td></tr>
<tr><td class="h">1568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1569</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mask_for_remote{$item-&gt;{journalid}} = $mask;</td></tr>
<tr><td class="h">1570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1571</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$permit = $item-&gt;{&#39;allowmask&#39;}+0 &amp; $mask+0;</td></tr>
<tr><td class="h">1572</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1573</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1573">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $permit;</td></tr>
<tr><td class="h">1574</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1575</td><td colspan="7"></td></tr><tr><td class="h">1576</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# date conversion</td></tr>
<tr><td class="h">1577</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1577">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1577">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( ! $opts-&gt;{&#39;dateformat&#39;} || $opts-&gt;{&#39;dateformat&#39;} eq &quot;S2&quot; ) {</td></tr>
<tr><td class="h">1578</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;alldatepart&#39;} = LJ::alldatepart_s2($item-&gt;{&#39;eventtime&#39;});</td></tr>
<tr><td class="h">1579</td><td colspan="7"></td></tr><tr><td class="h">1580</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# conversion to get the system time of this entry</td></tr>
<tr><td class="h">1581</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $logtime = LJ::mysql_time($LJ::EndOfTime - $item-&gt;{rlogtime}, 1);</td></tr>
<tr><td class="h">1582</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;{&#39;system_alldatepart&#39;} = LJ::alldatepart_s2($logtime);</td></tr>
<tr><td class="h">1583</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1584</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;confess &quot;We removed S1 support, sorry.&quot;;</td></tr>
<tr><td class="h">1585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1586</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$ret, $item;</td></tr>
<tr><td class="h">1587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1588</td><td colspan="7"></td></tr><tr><td class="h">1589</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @$ret;</td></tr>
<tr><td class="h">1590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1591</td><td colspan="7"></td></tr><tr><td class="h">1592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">##</td></tr>
<tr><td class="h">1593</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## see subs &#39;get_itemid_after2&#39; and &#39;get_itemid_before2&#39;</td></tr>
<tr><td class="h">1594</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">##</td></tr>
<tr><td class="h">1595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_itemid_near2</td></tr>
<tr><td class="h">1596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1597</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1597">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1598</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jitemid = shift;</td></tr>
<tr><td class="h">1599</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $after_before = shift;</td></tr>
<tr><td class="h">1600</td><td colspan="7"></td></tr><tr><td class="h">1601</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jitemid += 0;</td></tr>
<tr><td class="h">1602</td><td colspan="7"></td></tr><tr><td class="h">1603</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($order, $cmp1, $cmp2, $cmp3);</td></tr>
<tr><td class="h">1604</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1604">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1604">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($after_before eq &quot;after&quot;) {</td></tr>
<tr><td class="h">1605</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1605">0</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($order, $cmp1, $cmp2, $cmp3) = (&quot;DESC&quot;, &quot;&lt;=&quot;, &quot;&gt;&quot;, sub {$a-&gt;[0] &lt;=&gt; $b-&gt;[0]} );</td></tr>
<tr><td class="h">1606</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($after_before eq &quot;before&quot;) {</td></tr>
<tr><td class="h">1607</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1607">0</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($order, $cmp1, $cmp2, $cmp3) = (&quot;ASC&quot;,  &quot;&gt;=&quot;, &quot;&lt;&quot;, sub {$b-&gt;[0] &lt;=&gt; $a-&gt;[0]} );</td></tr>
<tr><td class="h">1608</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1609</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1610</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1611</td><td colspan="7"></td></tr><tr><td class="h">1612</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_cluster_reader($u);</td></tr>
<tr><td class="h">1613</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jid = $u-&gt;{&#39;userid&#39;}+0;</td></tr>
<tr><td class="h">1614</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1614">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $field = $u-&gt;is_person ? &quot;revttime&quot; : &quot;rlogtime&quot;;</td></tr>
<tr><td class="h">1615</td><td colspan="7"></td></tr><tr><td class="h">1616</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $stime = $dbr-&gt;selectrow_array(&quot;SELECT $field FROM log2 WHERE &quot;.</td></tr>
<tr><td class="h">1617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;journalid=$jid AND jitemid=$jitemid&quot;);</td></tr>
<tr><td class="h">1618</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1618">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $stime;</td></tr>
<tr><td class="h">1619</td><td colspan="7"></td></tr><tr><td class="h">1620</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $secwhere = &quot;AND security=&#39;public&#39;&quot;;</td></tr>
<tr><td class="h">1621</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">1622</td><td colspan="7"></td></tr><tr><td class="h">1623</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1623">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($remote) {</td></tr>
<tr><td class="h">1624</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1624">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1624">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($remote-&gt;{&#39;userid&#39;} == $u-&gt;{&#39;userid&#39;}) {</td></tr>
<tr><td class="h">1625</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$secwhere = &quot;&quot;;   # see everything</td></tr>
<tr><td class="h">1626</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( $remote-&gt;is_individual ) {</td></tr>
<tr><td class="h">1627</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1627">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $gmask = $u-&gt;is_community ? $remote-&gt;member_of( $u ) : $u-&gt;trustmask( $remote );</td></tr>
<tr><td class="h">1628</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1628">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$secwhere = &quot;AND (security=&#39;public&#39; OR (security=&#39;usemask&#39; AND allowmask &amp; $gmask))&quot;</td></tr>
<tr><td class="h">1629</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $gmask;</td></tr>
<tr><td class="h">1630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1631</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1632</td><td colspan="7"></td></tr><tr><td class="h">1633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">1634</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## We need a next/prev record in journal before/after a given time</td></tr>
<tr><td class="h">1635</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## Since several records may have the same time (time is rounded to 1 minute),</td></tr>
<tr><td class="h">1636</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## we&#39;re ordering them by jitemid. So, the SQL we need is</td></tr>
<tr><td class="h">1637</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##      SELECT * FROM log2</td></tr>
<tr><td class="h">1638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##      WHERE journalid=? AND rlogtime&gt;? AND jitmemid&lt;?</td></tr>
<tr><td class="h">1639</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##      ORDER BY rlogtime, jitemid DESC</td></tr>
<tr><td class="h">1640</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##      LIMIT 1</td></tr>
<tr><td class="h">1641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## Alas, MySQL tries to do filesort for the query.</td></tr>
<tr><td class="h">1642</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## So, we sort by rlogtime only and fetch all (2, 10, 50) records</td></tr>
<tr><td class="h">1643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## with the same rlogtime (we skip records if rlogtime is different from the first one).</td></tr>
<tr><td class="h">1644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## If rlogtime of all fetched records is the same, increase the LIMIT and retry.</td></tr>
<tr><td class="h">1645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## Then we sort them in Perl by jitemid and takes just one.</td></tr>
<tr><td class="h">1646</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">1647</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $result_ref;</td></tr>
<tr><td class="h">1648</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $limit (2, 10, 50, 100) {</td></tr>
<tr><td class="h">1649</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result_ref = $dbr-&gt;selectall_arrayref(</td></tr>
<tr><td class="h">1650</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SELECT jitemid, anum, $field FROM log2 use index (rlogtime,revttime) &quot;.</td></tr>
<tr><td class="h">1651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=? AND $field $cmp1 ? AND jitemid $cmp2 ? &quot;.</td></tr>
<tr><td class="h">1652</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$secwhere. &quot; &quot;.</td></tr>
<tr><td class="h">1653</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ORDER BY $field $order LIMIT $limit&quot;,</td></tr>
<tr><td class="h">1654</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $jid, $stime, $jitemid</td></tr>
<tr><td class="h">1655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1656</td><td colspan="7"></td></tr><tr><td class="h">1657</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %hash_times = ();</td></tr>
<tr><td class="h">1658</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map {$hash_times{$_-&gt;[2]} = 1} @$result_ref;</td></tr>
<tr><td class="h">1659</td><td colspan="7"></td></tr><tr><td class="h">1660</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# If we has one the only &#39;time&#39; in $limit fetched rows,</td></tr>
<tr><td class="h">1661</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# may be $limit cuts off our record. Increase the limit and repeat.</td></tr>
<tr><td class="h">1662</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1662">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1662">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (((scalar keys %hash_times) &gt; 1) || (scalar @$result_ref) &lt; $limit) {</td></tr>
<tr><td class="h">1663</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Sort result by jitemid and get our id from a top.</td></tr>
<tr><td class="h">1664</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @result =  sort $cmp3 @$result_ref;</td></tr>
<tr><td class="h">1665</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($id, $anum) = ($result[0]-&gt;[0], $result[0]-&gt;[1]);</td></tr>
<tr><td class="h">1666</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1666">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $id;</td></tr>
<tr><td class="h">1667</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1667">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return wantarray() ? ($id, $anum) : ($id*256 + $anum);</td></tr>
<tr><td class="h">1668</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1669</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1670</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1672</td><td colspan="7"></td></tr><tr><td class="h">1673</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">##</td></tr>
<tr><td class="h">1674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## Returns ID (a pair &lt;jitemid, anum&gt; in list context, ditmeid in scalar context)</td></tr>
<tr><td class="h">1675</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## of a journal record that follows/preceeds the given record.</td></tr>
<tr><td class="h">1676</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## Input: $u, $jitemid</td></tr>
<tr><td class="h">1677</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">##</td></tr>
<tr><td class="h">1678</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1678">0</a></div></td><td></td><td><div>0</div></td><td class="s">sub get_itemid_after2  { return get_itemid_near2(@_, &quot;after&quot;);  }</td></tr>
<tr><td class="h">1679</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1679">0</a></div></td><td></td><td><div>0</div></td><td class="s">sub get_itemid_before2 { return get_itemid_near2(@_, &quot;before&quot;); }</td></tr>
<tr><td class="h">1680</td><td colspan="7"></td></tr><tr><td class="h">1681</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_logprop</td></tr>
<tr><td class="h">1682</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1683</td><td><div class="c3">220</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1683">220</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $jitemid, $hashref, $logprops) = @_;  # hashref to set, hashref of what was done</td></tr>
<tr><td class="h">1684</td><td colspan="7"></td></tr><tr><td class="h">1685</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jitemid += 0;</td></tr>
<tr><td class="h">1686</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $u-&gt;{&#39;userid&#39;} + 0;</td></tr>
<tr><td class="h">1687</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $kill_mem = 0;</td></tr>
<tr><td class="h">1688</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $del_ids;</td></tr>
<tr><td class="h">1689</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ins_values;</td></tr>
<tr><td class="h">1690</td><td><div class="c3">220</div><div class="c3">440</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1690">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %{$hashref||{}}) {</td></tr>
<tr><td class="h">1691</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $prop = LJ::get_prop(&quot;log&quot;, $k);</td></tr>
<tr><td class="h">1692</td><td><div class="c3">220</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1692">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $prop;</td></tr>
<tr><td class="h">1693</td><td><div class="c3">220</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1693">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$kill_mem = 1 unless $prop eq &quot;commentalter&quot;;</td></tr>
<tr><td class="h">1694</td><td><div class="c3">220</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1694">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($v) {</td></tr>
<tr><td class="h">1695</td><td><div class="c3">219</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1695">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ins_values .= &quot;,&quot; if $ins_values;</td></tr>
<tr><td class="h">1696</td><td><div class="c3">219</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ins_values .= &quot;($uid, $jitemid, $prop-&gt;{&#39;id&#39;}, &quot; . $u-&gt;quote($v) . &quot;)&quot;;</td></tr>
<tr><td class="h">1697</td><td><div class="c3">219</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logprops-&gt;{$k} = $v;</td></tr>
<tr><td class="h">1698</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1699</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1699">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$del_ids .= &quot;,&quot; if $del_ids;</td></tr>
<tr><td class="h">1700</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$del_ids .= $prop-&gt;{&#39;id&#39;};</td></tr>
<tr><td class="h">1701</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1702</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1703</td><td colspan="7"></td></tr><tr><td class="h">1704</td><td><div class="c3">220</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1704">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;REPLACE INTO logprop2 (journalid, jitemid, propid, value) &quot;.</td></tr>
<tr><td class="h">1705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES $ins_values&quot;) if $ins_values;</td></tr>
<tr><td class="h">1706</td><td><div class="c3">220</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1706">100</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM logprop2 WHERE journalid=? AND jitemid=? &quot;.</td></tr>
<tr><td class="h">1707</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND propid IN ($del_ids)&quot;, undef, $u-&gt;{&#39;userid&#39;}, $jitemid) if $del_ids;</td></tr>
<tr><td class="h">1708</td><td colspan="7"></td></tr><tr><td class="h">1709</td><td><div class="c3">220</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1709">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete([$uid,&quot;logprop:$uid:$jitemid&quot;]) if $kill_mem;</td></tr>
<tr><td class="h">1710</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1711</td><td colspan="7"></td></tr><tr><td class="h">1712</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1713</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::load_log_props2</td></tr>
<tr><td class="h">1714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class:</td></tr>
<tr><td class="h">1715</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des:</td></tr>
<tr><td class="h">1716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info:</td></tr>
<tr><td class="h">1717</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: db?, uuserid, listref, hashref</td></tr>
<tr><td class="h">1718</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-:</td></tr>
<tr><td class="h">1719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns:</td></tr>
<tr><td class="h">1720</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1721</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_log_props2</td></tr>
<tr><td class="h">1722</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1723</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1723">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1723">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db = isdb($_[0]) ? shift @_ : undef;</td></tr>
<tr><td class="h">1724</td><td colspan="7"></td></tr><tr><td class="h">1725</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($uuserid, $listref, $hashref) = @_;</td></tr>
<tr><td class="h">1726</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = want_userid($uuserid);</td></tr>
<tr><td class="h">1727</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1727">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless ref $hashref eq &quot;HASH&quot;;</td></tr>
<tr><td class="h">1728</td><td colspan="7"></td></tr><tr><td class="h">1729</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %needprops;</td></tr>
<tr><td class="h">1730</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %needrc;</td></tr>
<tr><td class="h">1731</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %rc;</td></tr>
<tr><td class="h">1732</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @memkeys;</td></tr>
<tr><td class="h">1733</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (@$listref) {</td></tr>
<tr><td class="h">1734</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = $_+0;</td></tr>
<tr><td class="h">1735</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$needprops{$id} = 1;</td></tr>
<tr><td class="h">1736</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$needrc{$id} = 1;</td></tr>
<tr><td class="h">1737</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @memkeys, [$userid, &quot;logprop:$userid:$id&quot;];</td></tr>
<tr><td class="h">1738</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @memkeys, [$userid, &quot;rp:$userid:$id&quot;];</td></tr>
<tr><td class="h">1739</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1740</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1740">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1740">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless %needprops || %needrc;</td></tr>
<tr><td class="h">1741</td><td colspan="7"></td></tr><tr><td class="h">1742</td><td><div class="c3">34</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1742">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mem = LJ::MemCache::get_multi(@memkeys) || {};</td></tr>
<tr><td class="h">1743</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %$mem) {</td></tr>
<tr><td class="h">1744</td><td><div class="c3">20</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1744">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $k =~ /(\w+):(\d+):(\d+)/;</td></tr>
<tr><td class="h">1745</td><td><div class="c3">20</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1745">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($1 eq &#39;logprop&#39;) {</td></tr>
<tr><td class="h">1746</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1746">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless ref $v eq &quot;HASH&quot;;</td></tr>
<tr><td class="h">1747</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $needprops{$3};</td></tr>
<tr><td class="h">1748</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hashref-&gt;{$3} = $v;</td></tr>
<tr><td class="h">1749</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1750</td><td><div class="c3">20</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1750">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($1 eq &#39;rp&#39;) {</td></tr>
<tr><td class="h">1751</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $needrc{$3};</td></tr>
<tr><td class="h">1752</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rc{$3} = int($v);  # change possible &quot;0   &quot; (true) to &quot;0&quot; (false)</td></tr>
<tr><td class="h">1753</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1754</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1755</td><td colspan="7"></td></tr><tr><td class="h">1756</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %rc) {</td></tr>
<tr><td class="h">1757</td><td><div class="c3">20</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hashref-&gt;{$_}{&#39;replycount&#39;} = $rc{$_};</td></tr>
<tr><td class="h">1758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1759</td><td colspan="7"></td></tr><tr><td class="h">1760</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1760">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1760">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless %needprops || %needrc;</td></tr>
<tr><td class="h">1761</td><td colspan="7"></td></tr><tr><td class="h">1762</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1762">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($db) {</td></tr>
<tr><td class="h">1763</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::load_userid($userid);</td></tr>
<tr><td class="h">1764</td><td><div class="c3">34</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1764">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db = @LJ::MEMCACHE_SERVERS ? LJ::get_cluster_def_reader($u) :  LJ::get_cluster_reader($u);</td></tr>
<tr><td class="h">1765</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1765">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless $db;</td></tr>
<tr><td class="h">1766</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1767</td><td colspan="7"></td></tr><tr><td class="h">1768</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1768">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%needprops) {</td></tr>
<tr><td class="h">1769</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_props(&quot;log&quot;);</td></tr>
<tr><td class="h">1770</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&quot;,&quot;, keys %needprops);</td></tr>
<tr><td class="h">1771</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $db-&gt;prepare(&quot;SELECT jitemid, propid, value FROM logprop2 &quot;.</td></tr>
<tr><td class="h">1772</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=? AND jitemid IN ($in)&quot;);</td></tr>
<tr><td class="h">1773</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>44002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($userid);</td></tr>
<tr><td class="h">1774</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($jitemid, $propid, $value) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">1775</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hashref-&gt;{$jitemid}-&gt;{$LJ::CACHE_PROPID{&#39;log&#39;}-&gt;{$propid}-&gt;{&#39;name&#39;}} = $value;</td></tr>
<tr><td class="h">1776</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1777</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $id (keys %needprops) {</td></tr>
<tr><td class="h">1778</td><td><div class="c3">34</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1778">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$userid,&quot;logprop:$userid:$id&quot;], $hashref-&gt;{$id} || {});</td></tr>
<tr><td class="h">1779</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1781</td><td colspan="7"></td></tr><tr><td class="h">1782</td><td><div class="c3">34</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1782">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%needrc) {</td></tr>
<tr><td class="h">1783</td><td><div class="c3">14</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&quot;,&quot;, keys %needrc);</td></tr>
<tr><td class="h">1784</td><td><div class="c3">14</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $db-&gt;prepare(&quot;SELECT jitemid, replycount FROM log2 WHERE journalid=? AND jitemid IN ($in)&quot;);</td></tr>
<tr><td class="h">1785</td><td><div class="c3">14</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($userid);</td></tr>
<tr><td class="h">1786</td><td><div class="c3">14</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($jitemid, $rc) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">1787</td><td><div class="c3">14</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hashref-&gt;{$jitemid}-&gt;{&#39;replycount&#39;} = $rc;</td></tr>
<tr><td class="h">1788</td><td><div class="c3">14</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add([$userid, &quot;rp:$userid:$jitemid&quot;], $rc);</td></tr>
<tr><td class="h">1789</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1791</td><td colspan="7"></td></tr><tr><td class="h">1792</td><td colspan="7"></td></tr><tr><td class="h">1793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1794</td><td colspan="7"></td></tr><tr><td class="h">1795</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1796</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::load_log_props2multi</td></tr>
<tr><td class="h">1797</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class:</td></tr>
<tr><td class="h">1798</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des:</td></tr>
<tr><td class="h">1799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info:</td></tr>
<tr><td class="h">1800</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args:</td></tr>
<tr><td class="h">1801</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-:</td></tr>
<tr><td class="h">1802</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns:</td></tr>
<tr><td class="h">1803</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1804</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_log_props2multi</td></tr>
<tr><td class="h">1805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1806</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1806">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">1807</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($ids, $props) = @_;</td></tr>
<tr><td class="h">1808</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;_get_posts_raw_wrapper($ids, &quot;prop&quot;, $props);</td></tr>
<tr><td class="h">1809</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1810</td><td colspan="7"></td></tr><tr><td class="h">1811</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::delete_entry</td></tr>
<tr><td class="h">1813</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Deletes a user&#39;s journal entry</td></tr>
<tr><td class="h">1814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuserid, jitemid, quick?, anum?</td></tr>
<tr><td class="h">1815</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: Journal itemid or $u object of journal to delete entry from</td></tr>
<tr><td class="h">1816</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jitemid: Journal itemid of item to delete.</td></tr>
<tr><td class="h">1817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-quick: Optional boolean.  If set, only [dbtable[log2]] table</td></tr>
<tr><td class="h">1818</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            is deleted from and the rest of the content is deleted</td></tr>
<tr><td class="h">1819</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            later using [func[LJ::cmd_buffer_add]].</td></tr>
<tr><td class="h">1820</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-anum: The log item&#39;s anum, which&#39;ll be needed to delete lazily</td></tr>
<tr><td class="h">1821</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           some data in tables which includes the anum, but the</td></tr>
<tr><td class="h">1822</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           log row will already be gone so we&#39;ll need to store it for later.</td></tr>
<tr><td class="h">1823</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: boolean; 1 on success, 0 on failure.</td></tr>
<tr><td class="h">1824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1825</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_entry</td></tr>
<tr><td class="h">1826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1827</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1827">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($uuserid, $jitemid, $quick, $anum) = @_;</td></tr>
<tr><td class="h">1828</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jid = LJ::want_userid($uuserid);</td></tr>
<tr><td class="h">1829</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1829">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = ref $uuserid ? $uuserid : LJ::load_userid($jid);</td></tr>
<tr><td class="h">1830</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jitemid += 0;</td></tr>
<tr><td class="h">1831</td><td colspan="7"></td></tr><tr><td class="h">1832</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $and;</td></tr>
<tr><td class="h">1833</td><td><div class="c3">1</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1833">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $anum) { $and = &quot;AND anum=&quot; . ($anum+0); }</td></tr>
<tr><td class="h">1834</td><td colspan="7"></td></tr><tr><td class="h">1835</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# delete tags</td></tr>
<tr><td class="h">1836</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Tags::delete_logtags($u, $jitemid);</td></tr>
<tr><td class="h">1837</td><td colspan="7"></td></tr><tr><td class="h">1838</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dc = $u-&gt;log2_do(undef, &quot;DELETE FROM log2 WHERE journalid=$jid AND jitemid=$jitemid $and&quot;);</td></tr>
<tr><td class="h">1839</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete([$jid, &quot;log2:$jid:$jitemid&quot;]);</td></tr>
<tr><td class="h">1840</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1840">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::decr([$jid, &quot;log2ct:$jid&quot;]) if $dc &gt; 0;</td></tr>
<tr><td class="h">1841</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($jid, &quot;dayct2&quot;);</td></tr>
<tr><td class="h">1842</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;deletepost&quot;, $jid, $jitemid, $anum);</td></tr>
<tr><td class="h">1843</td><td colspan="7"></td></tr><tr><td class="h">1844</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if this is running the second time (started by the cmd buffer),</td></tr>
<tr><td class="h">1845</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the log2 row will already be gone and we shouldn&#39;t check for it.</td></tr>
<tr><td class="h">1846</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1846">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sclient = $quick ? LJ::theschwartz() : undef;</td></tr>
<tr><td class="h">1847</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1847">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1847">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($quick &amp;&amp; $sclient) {</td></tr>
<tr><td class="h">1848</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1848">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $dc &lt; 1;  # already deleted?</td></tr>
<tr><td class="h">1849</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1849">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $sclient-&gt;insert(&quot;LJ::Worker::DeleteEntry&quot;, {</td></tr>
<tr><td class="h">1850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uid     =&gt; $jid,</td></tr>
<tr><td class="h">1851</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jitemid =&gt; $jitemid,</td></tr>
<tr><td class="h">1852</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anum    =&gt; $anum,</td></tr>
<tr><td class="h">1853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">1854</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1855</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1856</td><td colspan="7"></td></tr><tr><td class="h">1857</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# delete from clusters</td></tr>
<tr><td class="h">1858</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $t (qw(logtext2 logprop2 logsec2)) {</td></tr>
<tr><td class="h">1859</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM $t WHERE journalid=$jid AND jitemid=$jitemid&quot;);</td></tr>
<tr><td class="h">1860</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1861</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;dudata_set(&#39;L&#39;, $jitemid, 0);</td></tr>
<tr><td class="h">1862</td><td colspan="7"></td></tr><tr><td class="h">1863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# delete all comments</td></tr>
<tr><td class="h">1864</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::delete_all_comments($u, &#39;L&#39;, $jitemid);</td></tr>
<tr><td class="h">1865</td><td colspan="7"></td></tr><tr><td class="h">1866</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# fired to delete the post from the Sphinx search database</td></tr>
<tr><td class="h">1867</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1867">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1867">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( @LJ::SPHINX_SEARCHD &amp;&amp; ( my $sclient = LJ::theschwartz() ) ) {</td></tr>
<tr><td class="h">1868</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sclient-&gt;insert_jobs( TheSchwartz::Job-&gt;new_from_array( &#39;DW::Worker::Sphinx::Copier&#39;, { userid =&gt; $u-&gt;id } ) );</td></tr>
<tr><td class="h">1869</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1870</td><td colspan="7"></td></tr><tr><td class="h">1871</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1873</td><td colspan="7"></td></tr><tr><td class="h">1874</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1875</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::mark_entry_as_spam</td></tr>
<tr><td class="h">1876</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: web</td></tr>
<tr><td class="h">1877</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Copies an entry in a community into the global [dbtable[spamreports]] table.</td></tr>
<tr><td class="h">1878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: journalu_uid, jitemid</td></tr>
<tr><td class="h">1879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-journalu_uid: User object of journal (community) entry was posted in, or the userid of it.</td></tr>
<tr><td class="h">1880</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jitemid: ID of this entry.</td></tr>
<tr><td class="h">1881</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 for success, 0 for failure</td></tr>
<tr><td class="h">1882</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mark_entry_as_spam {</td></tr>
<tr><td class="h">1884</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1884">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalu, $jitemid) = @_;</td></tr>
<tr><td class="h">1885</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu = LJ::want_user($journalu);</td></tr>
<tr><td class="h">1886</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$jitemid += 0;</td></tr>
<tr><td class="h">1887</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1887">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1887">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $journalu &amp;&amp; $jitemid;</td></tr>
<tr><td class="h">1888</td><td colspan="7"></td></tr><tr><td class="h">1889</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($journalu);</td></tr>
<tr><td class="h">1890</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">1891</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1891">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1891">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $dbcr &amp;&amp; $dbh;</td></tr>
<tr><td class="h">1892</td><td colspan="7"></td></tr><tr><td class="h">1893</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $item = LJ::get_log2_row($journalu, $jitemid);</td></tr>
<tr><td class="h">1894</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1894">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $item;</td></tr>
<tr><td class="h">1895</td><td colspan="7"></td></tr><tr><td class="h">1896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 1: get info we need</td></tr>
<tr><td class="h">1897</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $logtext = LJ::get_logtext2($journalu, $jitemid);</td></tr>
<tr><td class="h">1898</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($subject, $body, $posterid) = ($logtext-&gt;{$jitemid}[0], $logtext-&gt;{$jitemid}[1], $item-&gt;{posterid});</td></tr>
<tr><td class="h">1899</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1899">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $body;</td></tr>
<tr><td class="h">1900</td><td colspan="7"></td></tr><tr><td class="h">1901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 2: insert into spamreports</td></tr>
<tr><td class="h">1902</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&#39;INSERT INTO spamreports (reporttime, posttime, journalid, posterid, subject, body, report_type) &#39; .</td></tr>
<tr><td class="h">1903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;VALUES (UNIX_TIMESTAMP(), UNIX_TIMESTAMP(?), ?, ?, ?, ?, \&#39;entry\&#39;)&#39;,</td></tr>
<tr><td class="h">1904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $item-&gt;{logtime}, $journalu-&gt;{userid}, $posterid, $subject, $body);</td></tr>
<tr><td class="h">1905</td><td colspan="7"></td></tr><tr><td class="h">1906</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1906">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">1907</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1909</td><td colspan="7"></td></tr><tr><td class="h">1910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Same as previous, but mark as spam moderated event selected by modid.</td></tr>
<tr><td class="h">1911</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub reject_entry_as_spam {</td></tr>
<tr><td class="h">1912</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1912">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($journalu, $modid) = @_;</td></tr>
<tr><td class="h">1913</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$journalu = LJ::want_user($journalu);</td></tr>
<tr><td class="h">1914</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$modid += 0;</td></tr>
<tr><td class="h">1915</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1915">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1915">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $journalu &amp;&amp; $modid;</td></tr>
<tr><td class="h">1916</td><td colspan="7"></td></tr><tr><td class="h">1917</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($journalu);</td></tr>
<tr><td class="h">1918</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">1919</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1919">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1919">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $dbcr &amp;&amp; $dbh;</td></tr>
<tr><td class="h">1920</td><td colspan="7"></td></tr><tr><td class="h">1921</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 1: get info we need</td></tr>
<tr><td class="h">1922</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($posterid, $logtime) = $dbcr-&gt;selectrow_array(</td></tr>
<tr><td class="h">1923</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SELECT posterid, logtime FROM modlog WHERE journalid=? AND modid=?&quot;,</td></tr>
<tr><td class="h">1924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $journalu-&gt;{&#39;userid&#39;}, $modid);</td></tr>
<tr><td class="h">1925</td><td colspan="7"></td></tr><tr><td class="h">1926</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $frozen = $dbcr-&gt;selectrow_array(</td></tr>
<tr><td class="h">1927</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SELECT request_stor FROM modblob WHERE journalid=? AND modid=?&quot;,</td></tr>
<tr><td class="h">1928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $journalu-&gt;{&#39;userid&#39;}, $modid);</td></tr>
<tr><td class="h">1929</td><td colspan="7"></td></tr><tr><td class="h">1930</td><td><div class="c3">72</div><div class="c3">72</div><div class="c3">72</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1930">72</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;use Storable;</td></tr>
<tr><td class="h">1931</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1931">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $req = Storable::thaw($frozen) if $frozen;</td></tr>
<tr><td class="h">1932</td><td colspan="7"></td></tr><tr><td class="h">1933</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($subject, $body) = ($req-&gt;{subject}, $req-&gt;{event});</td></tr>
<tr><td class="h">1934</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1934">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $body;</td></tr>
<tr><td class="h">1935</td><td colspan="7"></td></tr><tr><td class="h">1936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# step 2: insert into spamreports</td></tr>
<tr><td class="h">1937</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&#39;INSERT INTO spamreports (reporttime, posttime, journalid, posterid, subject, body, report_type) &#39; .</td></tr>
<tr><td class="h">1938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;VALUES (UNIX_TIMESTAMP(), UNIX_TIMESTAMP(?), ?, ?, ?, ?, \&#39;entry\&#39;)&#39;,</td></tr>
<tr><td class="h">1939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $logtime, $journalu-&gt;{userid}, $posterid, $subject, $body);</td></tr>
<tr><td class="h">1940</td><td colspan="7"></td></tr><tr><td class="h">1941</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1941">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">1942</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1944</td><td colspan="7"></td></tr><tr><td class="h">1945</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># replycount_do</td></tr>
<tr><td class="h">1946</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># input: $u, $jitemid, $action, $value</td></tr>
<tr><td class="h">1947</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># action is one of: &quot;init&quot;, &quot;incr&quot;, &quot;decr&quot;</td></tr>
<tr><td class="h">1948</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $value is amount to incr/decr, 1 by default</td></tr>
<tr><td class="h">1949</td><td colspan="7"></td></tr><tr><td class="h">1950</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub replycount_do {</td></tr>
<tr><td class="h">1951</td><td><div class="c3">252</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L1951">252</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $jitemid, $action, $value) = @_;</td></tr>
<tr><td class="h">1952</td><td><div class="c3">252</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1952">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$value = 1 unless defined $value;</td></tr>
<tr><td class="h">1953</td><td><div class="c3">252</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $u-&gt;{&#39;userid&#39;};</td></tr>
<tr><td class="h">1954</td><td><div class="c3">252</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$uid, &quot;rp:$uid:$jitemid&quot;];</td></tr>
<tr><td class="h">1955</td><td colspan="7"></td></tr><tr><td class="h">1956</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# &quot;init&quot; is easiest and needs no lock (called before the entry is live)</td></tr>
<tr><td class="h">1957</td><td><div class="c3">252</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1957">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($action eq &#39;init&#39;) {</td></tr>
<tr><td class="h">1958</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, &quot;0   &quot;);</td></tr>
<tr><td class="h">1959</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1960</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1961</td><td colspan="7"></td></tr><tr><td class="h">1962</td><td><div class="c3">218</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1962">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;writer;</td></tr>
<tr><td class="h">1963</td><td colspan="7"></td></tr><tr><td class="h">1964</td><td><div class="c3">218</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lockkey = $memkey-&gt;[1];</td></tr>
<tr><td class="h">1965</td><td><div class="c3">218</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;selectrow_array(&quot;SELECT GET_LOCK(?,10)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">1966</td><td colspan="7"></td></tr><tr><td class="h">1967</td><td><div class="c3">218</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret;</td></tr>
<tr><td class="h">1968</td><td colspan="7"></td></tr><tr><td class="h">1969</td><td><div class="c3">218</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1969">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($action eq &#39;decr&#39;) {</td></tr>
<tr><td class="h">1970</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret = LJ::MemCache::decr($memkey, $value);</td></tr>
<tr><td class="h">1971</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;UPDATE log2 SET replycount=replycount-$value WHERE journalid=$uid AND jitemid=$jitemid&quot;);</td></tr>
<tr><td class="h">1972</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1973</td><td colspan="7"></td></tr><tr><td class="h">1974</td><td><div class="c3">218</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1974">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($action eq &#39;incr&#39;) {</td></tr>
<tr><td class="h">1975</td><td><div class="c3">215</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret = LJ::MemCache::incr($memkey, $value);</td></tr>
<tr><td class="h">1976</td><td><div class="c3">215</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;UPDATE log2 SET replycount=replycount+$value WHERE journalid=$uid AND jitemid=$jitemid&quot;);</td></tr>
<tr><td class="h">1977</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1978</td><td colspan="7"></td></tr><tr><td class="h">1979</td><td><div class="c3">218</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1979">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--condition.html#L1979">100</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@LJ::MEMCACHE_SERVERS &amp;&amp; ! defined $ret) {</td></tr>
<tr><td class="h">1980</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rc = $u-&gt;selectrow_array(&quot;SELECT replycount FROM log2 WHERE journalid=$uid AND jitemid=$jitemid&quot;);</td></tr>
<tr><td class="h">1981</td><td><div class="c3">8</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L1981">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $rc) {</td></tr>
<tr><td class="h">1982</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rc = sprintf(&quot;%-4d&quot;, $rc);</td></tr>
<tr><td class="h">1983</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $rc);</td></tr>
<tr><td class="h">1984</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1985</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1986</td><td colspan="7"></td></tr><tr><td class="h">1987</td><td><div class="c3">218</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;selectrow_array(&quot;SELECT RELEASE_LOCK(?)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">1988</td><td colspan="7"></td></tr><tr><td class="h">1989</td><td><div class="c3">218</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1991</td><td colspan="7"></td></tr><tr><td class="h">1992</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1993</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_logtext2</td></tr>
<tr><td class="h">1994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Efficiently retrieves a large number of journal entry text, trying first</td></tr>
<tr><td class="h">1995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      slave database servers for recent items, then the master in</td></tr>
<tr><td class="h">1996</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      cases of old items the slaves have already disposed of.  See also:</td></tr>
<tr><td class="h">1997</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      [func[LJ::get_talktext2]].</td></tr>
<tr><td class="h">1998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, opts?, jitemid*</td></tr>
<tr><td class="h">1999</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: hashref with keys being jitemids, values being [ $subject, $body ]</td></tr>
<tr><td class="h">2000</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: Optional hashref of special options.  NOW IGNORED (2005-09-14)</td></tr>
<tr><td class="h">2001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-jitemid: List of jitemids to retrieve the subject &amp; text for.</td></tr>
<tr><td class="h">2002</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">2003</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_logtext2</td></tr>
<tr><td class="h">2004</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2005</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L2005">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2006</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $clusterid = $u-&gt;{&#39;clusterid&#39;};</td></tr>
<tr><td class="h">2007</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journalid = $u-&gt;{&#39;userid&#39;}+0;</td></tr>
<tr><td class="h">2008</td><td colspan="7"></td></tr><tr><td class="h">2009</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L2009">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = ref $_[0] ? shift : {};  # this is now ignored</td></tr>
<tr><td class="h">2010</td><td colspan="7"></td></tr><tr><td class="h">2011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return structure.</td></tr>
<tr><td class="h">2012</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lt = {};</td></tr>
<tr><td class="h">2013</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L2013">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $lt unless $clusterid;</td></tr>
<tr><td class="h">2014</td><td colspan="7"></td></tr><tr><td class="h">2015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# keep track of itemids we still need to load.</td></tr>
<tr><td class="h">2016</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %need;</td></tr>
<tr><td class="h">2017</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @mem_keys;</td></tr>
<tr><td class="h">2018</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (@_) {</td></tr>
<tr><td class="h">2019</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = $_+0;</td></tr>
<tr><td class="h">2020</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$need{$id} = 1;</td></tr>
<tr><td class="h">2021</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @mem_keys, [$journalid,&quot;logtext:$clusterid:$journalid:$id&quot;];</td></tr>
<tr><td class="h">2022</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2023</td><td colspan="7"></td></tr><tr><td class="h">2024</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# pass 1: memcache</td></tr>
<tr><td class="h">2025</td><td><div class="c3">1</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L2025">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mem = LJ::MemCache::get_multi(@mem_keys) || {};</td></tr>
<tr><td class="h">2026</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %$mem) {</td></tr>
<tr><td class="h">2027</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L2027">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $v;</td></tr>
<tr><td class="h">2028</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$k =~ /:(\d+):(\d+):(\d+)/;</td></tr>
<tr><td class="h">2029</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $need{$3};</td></tr>
<tr><td class="h">2030</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lt-&gt;{$3} = $v;</td></tr>
<tr><td class="h">2031</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2032</td><td colspan="7"></td></tr><tr><td class="h">2033</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L2033">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $lt unless %need;</td></tr>
<tr><td class="h">2034</td><td colspan="7"></td></tr><tr><td class="h">2035</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# pass 2: databases</td></tr>
<tr><td class="h">2036</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db = LJ::get_cluster_def_reader($clusterid);</td></tr>
<tr><td class="h">2037</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-Entry-pm--branch.html#L2037">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Can&#39;t get database handle loading entry text&quot; unless $db;</td></tr>
<tr><td class="h">2038</td><td colspan="7"></td></tr><tr><td class="h">2039</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jitemid_in = join(&quot;, &quot;, keys %need);</td></tr>
<tr><td class="h">2040</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $db-&gt;prepare(&quot;SELECT jitemid, subject, event FROM logtext2 &quot;.</td></tr>
<tr><td class="h">2041</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$journalid AND jitemid IN ($jitemid_in)&quot;);</td></tr>
<tr><td class="h">2042</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">2043</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($id, $subject, $event) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">2044</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_uncompress(\$event);</td></tr>
<tr><td class="h">2045</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $val = [ $subject, $event ];</td></tr>
<tr><td class="h">2046</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lt-&gt;{$id} = $val;</td></tr>
<tr><td class="h">2047</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add([$journalid,&quot;logtext:$clusterid:$journalid:$id&quot;], $val);</td></tr>
<tr><td class="h">2048</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $need{$id};</td></tr>
<tr><td class="h">2049</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2050</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $lt;</td></tr>
<tr><td class="h">2051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2052</td><td colspan="7"></td></tr><tr><td class="h">2053</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">2054</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::item_link</td></tr>
<tr><td class="h">2055</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: component</td></tr>
<tr><td class="h">2056</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Returns URL to view an individual journal item.</td></tr>
<tr><td class="h">2057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: The returned URL may have an ampersand in it.  In an HTML/XML attribute,</td></tr>
<tr><td class="h">2058</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       these must first be escaped by, say, [func[LJ::ehtml]].  This</td></tr>
<tr><td class="h">2059</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       function doesn&#39;t return it pre-escaped because the caller may</td></tr>
<tr><td class="h">2060</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       use it in, say, a plain-text e-mail message.</td></tr>
<tr><td class="h">2061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, itemid, anum?</td></tr>
<tr><td class="h">2062</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-itemid: Itemid of entry to link to.</td></tr>
<tr><td class="h">2063</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-anum: If present, $u is assumed to be on a cluster and itemid is assumed</td></tr>
<tr><td class="h">2064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           to not be a $ditemid already, and the $itemid will be turned into one</td></tr>
<tr><td class="h">2065</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           by multiplying by 256 and adding $anum.</td></tr>
<tr><td class="h">2066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: scalar; unescaped URL string</td></tr>
<tr><td class="h">2067</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">2068</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub item_link</td></tr>
<tr><td class="h">2069</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2070</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L2070">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $itemid, $anum, @args) = @_;</td></tr>
<tr><td class="h">2071</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $itemid*256 + $anum;</td></tr>
<tr><td class="h">2072</td><td colspan="7"></td></tr><tr><td class="h">2073</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# XXX: should have an option of returning a url with escaped (&amp;amp;)</td></tr>
<tr><td class="h">2074</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#      or non-escaped (&amp;) arguments.  a new link object would be best.</td></tr>
<tr><td class="h">2075</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L2075">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $args = @args ? &quot;?&quot; . join(&quot;&amp;amp;&quot;, @args) : &quot;&quot;;</td></tr>
<tr><td class="h">2076</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::journal_base($u) . &quot;/$ditemid.html$args&quot;;</td></tr>
<tr><td class="h">2077</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2078</td><td colspan="7"></td></tr><tr><td class="h">2079</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">2080</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::expand_embedded</td></tr>
<tr><td class="h">2081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class:</td></tr>
<tr><td class="h">2082</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Used for expanding embedded content like polls, for entries.</td></tr>
<tr><td class="h">2083</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: The u-object of the journal in question transmits to the function</td></tr>
<tr><td class="h">2084</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       and its hooks.</td></tr>
<tr><td class="h">2085</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, ditemid, remote, eventref, opts?</td></tr>
<tr><td class="h">2086</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-eventref:</td></tr>
<tr><td class="h">2087</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts:</td></tr>
<tr><td class="h">2088</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns:</td></tr>
<tr><td class="h">2089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">2090</td><td colspan="7"></td></tr><tr><td class="h">2091</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub expand_embedded</td></tr>
<tr><td class="h">2092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2093</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L2093">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">2094</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $ditemid, $remote, $eventref, %opts) = @_;</td></tr>
<tr><td class="h">2095</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L2095">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Poll-&gt;expand_entry($eventref) unless $opts{preview};</td></tr>
<tr><td class="h">2096</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::EmbedModule-&gt;expand_entry($u, $eventref, %opts);</td></tr>
<tr><td class="h">2097</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;expand_embedded&quot;, $u, $ditemid, $remote, $eventref, %opts);</td></tr>
<tr><td class="h">2098</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2099</td><td colspan="7"></td></tr><tr><td class="h">2100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">2101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::item_toutf8</td></tr>
<tr><td class="h">2102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: convert one item&#39;s subject, text and props to UTF-8.</td></tr>
<tr><td class="h">2103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      item can be an entry or a comment (in which cases props can be</td></tr>
<tr><td class="h">2104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      left empty, since there are no 8bit talkprops).</td></tr>
<tr><td class="h">2105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, subject, text, props</td></tr>
<tr><td class="h">2106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: user hashref of the journal&#39;s owner</td></tr>
<tr><td class="h">2107</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-subject: ref to the item&#39;s subject</td></tr>
<tr><td class="h">2108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-text: ref to the item&#39;s text</td></tr>
<tr><td class="h">2109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-props: hashref of the item&#39;s props</td></tr>
<tr><td class="h">2110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: nothing.</td></tr>
<tr><td class="h">2111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">2112</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub item_toutf8</td></tr>
<tr><td class="h">2113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2114</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L2114">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $subject, $text, $props) = @_;</td></tr>
<tr><td class="h">2115</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L2115">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $LJ::UNICODE;</td></tr>
<tr><td class="h">2116</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--condition.html#L2116">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$props ||= {};</td></tr>
<tr><td class="h">2117</td><td colspan="7"></td></tr><tr><td class="h">2118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $convert = sub {</td></tr>
<tr><td class="h">2119</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-Entry-pm--subroutine.html#L2119">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rtext = shift;</td></tr>
<tr><td class="h">2120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $error = 0;</td></tr>
<tr><td class="h">2121</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $res = LJ::text_convert($$rtext, $u, \$error);</td></tr>
<tr><td class="h">2122</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-Entry-pm--branch.html#L2122">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($error) {</td></tr>
<tr><td class="h">2123</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out($rtext);</td></tr>
<tr><td class="h">2124</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2125</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$rtext = $res;</td></tr>
<tr><td class="h">2126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2127</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">2128</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2129</td><td colspan="7"></td></tr><tr><td class="h">2130</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$convert-&gt;($subject);</td></tr>
<tr><td class="h">2131</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$convert-&gt;($text);</td></tr>
<tr><td class="h">2132</td><td colspan="7"></td></tr><tr><td class="h">2133</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: really convert all the props?  what if we binary-pack some in the future?</td></tr>
<tr><td class="h">2134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach(keys %$props) {</td></tr>
<tr><td class="h">2135</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$convert-&gt;(\$props-&gt;{$_});</td></tr>
<tr><td class="h">2136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2137</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">2138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2139</td><td colspan="7"></td></tr><tr><td class="h">2140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
