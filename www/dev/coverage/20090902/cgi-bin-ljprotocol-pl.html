<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/ljprotocol.pl</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/ljprotocol.pl</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">15.0%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#!/usr/bin/perl</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">3</td><td colspan="7"></td></tr><tr><td class="h">4</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L4">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">5</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L5">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">no warnings &#39;uninitialized&#39;;</td></tr>
<tr><td class="h">6</td><td colspan="7"></td></tr><tr><td class="h">7</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L7">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::Constants;</td></tr>
<tr><td class="h">8</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">use Class::Autouse qw(</td></tr>
<tr><td class="h">9</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Console</td></tr>
<tr><td class="h">10</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Event::JournalNewEntry</td></tr>
<tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Event::UserNewEntry</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Event::AddedToCircle</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Entry</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Poll</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::EventLogRecord::NewEntry</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::EventLogRecord::EditEntry</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Config</td></tr>
<tr><td class="h">18</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Comment</td></tr>
<tr><td class="h">19</td><td><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L19">8</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">20</td><td colspan="7"></td></tr><tr><td class="h">21</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">LJ::Config-&gt;load;</td></tr>
<tr><td class="h">22</td><td colspan="7"></td></tr><tr><td class="h">23</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L23">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use lib &quot;$LJ::HOME/cgi-bin&quot;;</td></tr>
<tr><td class="h">24</td><td colspan="7"></td></tr><tr><td class="h">25</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">require &quot;taglib.pl&quot;;</td></tr>
<tr><td class="h">26</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">require &quot;ljfeed.pl&quot;;</td></tr>
<tr><td class="h">27</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L27">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::EmbedModule;</td></tr>
<tr><td class="h">28</td><td colspan="7"></td></tr><tr><td class="h">29</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#### New interface (meta handler) ... other handlers should call into this.</td></tr>
<tr><td class="h">30</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ::Protocol;</td></tr>
<tr><td class="h">31</td><td colspan="7"></td></tr><tr><td class="h">32</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># global declaration of this text since we use it in two places</td></tr>
<tr><td class="h">33</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">our $CannotBeShown = &#39;(cannot be shown)&#39;;</td></tr>
<tr><td class="h">34</td><td colspan="7"></td></tr><tr><td class="h">35</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># error classes</td></tr>
<tr><td class="h">36</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L36">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use constant E_TEMP =&gt; 0;</td></tr>
<tr><td class="h">37</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L37">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use constant E_PERM =&gt; 1;</td></tr>
<tr><td class="h">38</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># maximum items for get_friends_page function</td></tr>
<tr><td class="h">39</td><td><div class="c3">8</div><div class="c3">8</div><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L39">8</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use constant FRIEND_ITEMS_LIMIT =&gt; 50;</td></tr>
<tr><td class="h">40</td><td colspan="7"></td></tr><tr><td class="h">41</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">my %e = (</td></tr>
<tr><td class="h">42</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# User Errors</td></tr>
<tr><td class="h">43</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;100&quot; =&gt; [ E_PERM, &quot;Invalid username&quot; ],</td></tr>
<tr><td class="h">44</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;101&quot; =&gt; [ E_PERM, &quot;Invalid password&quot; ],</td></tr>
<tr><td class="h">45</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;102&quot; =&gt; [ E_PERM, &quot;Can&#39;t use custom/private security on shared/community journals.&quot; ],</td></tr>
<tr><td class="h">46</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;103&quot; =&gt; [ E_PERM, &quot;Poll error&quot; ],</td></tr>
<tr><td class="h">47</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;104&quot; =&gt; [ E_TEMP, &quot;Error adding one or more friends&quot; ],</td></tr>
<tr><td class="h">48</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;105&quot; =&gt; [ E_PERM, &quot;Challenge expired&quot; ],</td></tr>
<tr><td class="h">49</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;150&quot; =&gt; [ E_PERM, &quot;Can&#39;t post as non-user&quot; ],</td></tr>
<tr><td class="h">50</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;151&quot; =&gt; [ E_TEMP, &quot;Banned from journal&quot; ],</td></tr>
<tr><td class="h">51</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;152&quot; =&gt; [ E_PERM, &quot;Can&#39;t make back-dated entries in non-personal journal.&quot; ],</td></tr>
<tr><td class="h">52</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;153&quot; =&gt; [ E_PERM, &quot;Incorrect time value&quot; ],</td></tr>
<tr><td class="h">53</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;154&quot; =&gt; [ E_PERM, &quot;Can&#39;t add a redirected account as a friend&quot; ],</td></tr>
<tr><td class="h">54</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;155&quot; =&gt; [ E_TEMP, &quot;Non-authenticated email address&quot; ],</td></tr>
<tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;156&quot; =&gt; [ E_TEMP, sub { # to reload w/o restart</td></tr>
<tr><td class="h">56</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::tosagree_str(&#39;protocol&#39; =&gt; &#39;text&#39;) ||</td></tr>
<tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::tosagree_str(&#39;protocol&#39; =&gt; &#39;title&#39;)</td></tr>
<tr><td class="h">58</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} ],</td></tr>
<tr><td class="h">59</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;157&quot; =&gt; [ E_TEMP, &quot;Tags error&quot; ],</td></tr>
<tr><td class="h">60</td><td colspan="7"></td></tr><tr><td class="h">61</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Client Errors</td></tr>
<tr><td class="h">62</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;200&quot; =&gt; [ E_PERM, &quot;Missing required argument(s)&quot; ],</td></tr>
<tr><td class="h">63</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;201&quot; =&gt; [ E_PERM, &quot;Unknown method&quot; ],</td></tr>
<tr><td class="h">64</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;202&quot; =&gt; [ E_PERM, &quot;Too many arguments&quot; ],</td></tr>
<tr><td class="h">65</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;203&quot; =&gt; [ E_PERM, &quot;Invalid argument(s)&quot; ],</td></tr>
<tr><td class="h">66</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;204&quot; =&gt; [ E_PERM, &quot;Invalid metadata datatype&quot; ],</td></tr>
<tr><td class="h">67</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;205&quot; =&gt; [ E_PERM, &quot;Unknown metadata&quot; ],</td></tr>
<tr><td class="h">68</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;206&quot; =&gt; [ E_PERM, &quot;Invalid destination journal username.&quot; ],</td></tr>
<tr><td class="h">69</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;207&quot; =&gt; [ E_PERM, &quot;Protocol version mismatch&quot; ],</td></tr>
<tr><td class="h">70</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;208&quot; =&gt; [ E_PERM, &quot;Invalid text encoding&quot; ],</td></tr>
<tr><td class="h">71</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;209&quot; =&gt; [ E_PERM, &quot;Parameter out of range&quot; ],</td></tr>
<tr><td class="h">72</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;210&quot; =&gt; [ E_PERM, &quot;Client tried to edit with corrupt data.  Preventing.&quot; ],</td></tr>
<tr><td class="h">73</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;211&quot; =&gt; [ E_PERM, &quot;Invalid or malformed tag list&quot; ],</td></tr>
<tr><td class="h">74</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;212&quot; =&gt; [ E_PERM, &quot;Message body is too long&quot; ],</td></tr>
<tr><td class="h">75</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;213&quot; =&gt; [ E_PERM, &quot;Message body is empty&quot; ],</td></tr>
<tr><td class="h">76</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;214&quot; =&gt; [ E_PERM, &quot;Message looks like spam&quot; ],</td></tr>
<tr><td class="h">77</td><td colspan="7"></td></tr><tr><td class="h">78</td><td colspan="7"></td></tr><tr><td class="h">79</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Access Errors</td></tr>
<tr><td class="h">80</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;300&quot; =&gt; [ E_TEMP, &quot;Don&#39;t have access to requested journal&quot; ],</td></tr>
<tr><td class="h">81</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;301&quot; =&gt; [ E_TEMP, &quot;Access of restricted feature&quot; ],</td></tr>
<tr><td class="h">82</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;302&quot; =&gt; [ E_TEMP, &quot;Can&#39;t edit post from requested journal&quot; ],</td></tr>
<tr><td class="h">83</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;303&quot; =&gt; [ E_TEMP, &quot;Can&#39;t edit post in community journal&quot; ],</td></tr>
<tr><td class="h">84</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;304&quot; =&gt; [ E_TEMP, &quot;Can&#39;t delete post in this community journal&quot; ],</td></tr>
<tr><td class="h">85</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;305&quot; =&gt; [ E_TEMP, &quot;Action forbidden; account is suspended.&quot; ],</td></tr>
<tr><td class="h">86</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;306&quot; =&gt; [ E_TEMP, &quot;This journal is temporarily in read-only mode.  Try again in a couple minutes.&quot; ],</td></tr>
<tr><td class="h">87</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;307&quot; =&gt; [ E_PERM, &quot;Selected journal no longer exists.&quot; ],</td></tr>
<tr><td class="h">88</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;308&quot; =&gt; [ E_TEMP, &quot;Account is locked and cannot be used.&quot; ],</td></tr>
<tr><td class="h">89</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;309&quot; =&gt; [ E_PERM, &quot;Account is marked as a memorial.&quot; ],</td></tr>
<tr><td class="h">90</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;310&quot; =&gt; [ E_TEMP, &quot;Account needs to be age verified before use.&quot; ],</td></tr>
<tr><td class="h">91</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;311&quot; =&gt; [ E_TEMP, &quot;Access temporarily disabled.&quot; ],</td></tr>
<tr><td class="h">92</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;312&quot; =&gt; [ E_TEMP, &quot;Not allowed to add tags to entries in this journal&quot; ],</td></tr>
<tr><td class="h">93</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;313&quot; =&gt; [ E_TEMP, &quot;Must use existing tags for entries in this journal (can&#39;t create new ones)&quot; ],</td></tr>
<tr><td class="h">94</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;314&quot; =&gt; [ E_PERM, &quot;Only paid users allowed to use this request&quot; ],</td></tr>
<tr><td class="h">95</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;315&quot; =&gt; [ E_PERM, &quot;User messaging is currently disabled&quot; ],</td></tr>
<tr><td class="h">96</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;316&quot; =&gt; [ E_TEMP, &quot;Poster is read-only and cannot post entries.&quot; ],</td></tr>
<tr><td class="h">97</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;317&quot; =&gt; [ E_TEMP, &quot;Journal is read-only and entries cannot be posted to it.&quot; ],</td></tr>
<tr><td class="h">98</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;318&quot; =&gt; [ E_TEMP, &quot;Poster is read-only and cannot edit entries.&quot; ],</td></tr>
<tr><td class="h">99</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;319&quot; =&gt; [ E_TEMP, &quot;Journal is read-only and its entries cannot be edited.&quot; ],</td></tr>
<tr><td class="h">100</td><td colspan="7"></td></tr><tr><td class="h">101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Limit errors</td></tr>
<tr><td class="h">102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;402&quot; =&gt; [ E_TEMP, &quot;Your IP address is temporarily banned for exceeding the login failure rate.&quot; ],</td></tr>
<tr><td class="h">103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;404&quot; =&gt; [ E_TEMP, &quot;Cannot post&quot; ],</td></tr>
<tr><td class="h">104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;405&quot; =&gt; [ E_TEMP, &quot;Post frequency limit.&quot; ],</td></tr>
<tr><td class="h">105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;406&quot; =&gt; [ E_TEMP, &quot;Client is making repeated requests.  Perhaps it&#39;s broken?&quot; ],</td></tr>
<tr><td class="h">106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;407&quot; =&gt; [ E_TEMP, &quot;Moderation queue full&quot; ],</td></tr>
<tr><td class="h">107</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;408&quot; =&gt; [ E_TEMP, &quot;Maximum queued posts for this community+poster combination reached.&quot; ],</td></tr>
<tr><td class="h">108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;409&quot; =&gt; [ E_PERM, &quot;Post too large.&quot; ],</td></tr>
<tr><td class="h">109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;410&quot; =&gt; [ E_PERM, &quot;Your trial account has expired.  Posting now disabled.&quot; ],</td></tr>
<tr><td class="h">110</td><td colspan="7"></td></tr><tr><td class="h">111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Server Errors</td></tr>
<tr><td class="h">112</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;500&quot; =&gt; [ E_TEMP, &quot;Internal server error&quot; ],</td></tr>
<tr><td class="h">113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;501&quot; =&gt; [ E_TEMP, &quot;Database error&quot; ],</td></tr>
<tr><td class="h">114</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;502&quot; =&gt; [ E_TEMP, &quot;Database temporarily unavailable&quot; ],</td></tr>
<tr><td class="h">115</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;503&quot; =&gt; [ E_TEMP, &quot;Error obtaining necessary database lock&quot; ],</td></tr>
<tr><td class="h">116</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;504&quot; =&gt; [ E_PERM, &quot;Protocol mode no longer supported.&quot; ],</td></tr>
<tr><td class="h">117</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;505&quot; =&gt; [ E_TEMP, &quot;Account data format on server is old and needs to be upgraded.&quot; ], # cluster0</td></tr>
<tr><td class="h">118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;506&quot; =&gt; [ E_TEMP, &quot;Journal sync temporarily unavailable.&quot; ],</td></tr>
<tr><td class="h">119</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">);</td></tr>
<tr><td class="h">120</td><td colspan="7"></td></tr><tr><td class="h">121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub translate</td></tr>
<tr><td class="h">122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">123</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L123">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $msg, $vars) = @_;</td></tr>
<tr><td class="h">124</td><td colspan="7"></td></tr><tr><td class="h">125</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L125">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($u, &quot;browselang&quot;) unless $u-&gt;{&#39;browselang&#39;};</td></tr>
<tr><td class="h">126</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Lang::get_text($u-&gt;{&#39;browselang&#39;}, &quot;protocol.$msg&quot;, undef, $vars);</td></tr>
<tr><td class="h">127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">128</td><td colspan="7"></td></tr><tr><td class="h">129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub error_class</td></tr>
<tr><td class="h">130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">131</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L131">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $code = shift;</td></tr>
<tr><td class="h">132</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L132">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$code = $1 if $code =~ /^(\d\d\d):(.+)/;</td></tr>
<tr><td class="h">133</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L133">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L133">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $e{$code} &amp;&amp; ref $e{$code} ? $e{$code}-&gt;[0] : undef;</td></tr>
<tr><td class="h">134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">135</td><td colspan="7"></td></tr><tr><td class="h">136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub error_message</td></tr>
<tr><td class="h">137</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">138</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L138">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $code = shift;</td></tr>
<tr><td class="h">139</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $des;</td></tr>
<tr><td class="h">140</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L140">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;($code, $des) = ($1, $2) if $code =~ /^(\d\d\d):(.+)/;</td></tr>
<tr><td class="h">141</td><td colspan="7"></td></tr><tr><td class="h">142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prefix = &quot;&quot;;</td></tr>
<tr><td class="h">143</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L143">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L143">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L143">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $error =</td></tr>
<tr><td class="h">144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$e{$code} &amp;&amp; ref $e{$code}</td></tr>
<tr><td class="h">145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? ( ref $e{$code}-&gt;[1] eq &#39;CODE&#39; ? $e{$code}-&gt;[1]-&gt;() : $e{$code}-&gt;[1] )</td></tr>
<tr><td class="h">146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: &quot;BUG: Unknown error code!&quot;;</td></tr>
<tr><td class="h">147</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L147">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$prefix = &quot;Client error: &quot; if $code &gt;= 200;</td></tr>
<tr><td class="h">148</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L148">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$prefix = &quot;Server error: &quot; if $code &gt;= 500;</td></tr>
<tr><td class="h">149</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $totalerror = &quot;$prefix$error&quot;;</td></tr>
<tr><td class="h">150</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L150">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$totalerror .= &quot;: $des&quot; if $des;</td></tr>
<tr><td class="h">151</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $totalerror;</td></tr>
<tr><td class="h">152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">153</td><td colspan="7"></td></tr><tr><td class="h">154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub do_request</td></tr>
<tr><td class="h">155</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get the request and response hash refs</td></tr>
<tr><td class="h">157</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L157">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($method, $req, $err, $flags) = @_;</td></tr>
<tr><td class="h">158</td><td colspan="7"></td></tr><tr><td class="h">159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if version isn&#39;t specified explicitly, it&#39;s version 0</td></tr>
<tr><td class="h">160</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L160">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref $req eq &quot;HASH&quot;) {</td></tr>
<tr><td class="h">161</td><td><div class="c3">34</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L161">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;ver&#39;} ||= $req-&gt;{&#39;version&#39;};</td></tr>
<tr><td class="h">162</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L162">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;ver&#39;} = 0 unless defined $req-&gt;{&#39;ver&#39;};</td></tr>
<tr><td class="h">163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">164</td><td colspan="7"></td></tr><tr><td class="h">165</td><td><div class="c3">34</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L165">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flags ||= {};</td></tr>
<tr><td class="h">166</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @args = ($req, $err, $flags);</td></tr>
<tr><td class="h">167</td><td colspan="7"></td></tr><tr><td class="h">168</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $r = eval { BML::get_request() };</td></tr>
<tr><td class="h">169</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L169">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L169">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;notes-&gt;{codepath} = &quot;protocol.$method&quot;</td></tr>
<tr><td class="h">170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $r &amp;&amp; ! $r-&gt;notes-&gt;{codepath};</td></tr>
<tr><td class="h">171</td><td colspan="7"></td></tr><tr><td class="h">172</td><td><div class="c3">34</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L172">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;login&quot;)            { return login(@args);            }</td></tr>
<tr><td class="h">173</td><td><div class="c3">34</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L173">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;getfriendgroups&quot;)  { return getfriendgroups(@args);  }</td></tr>
<tr><td class="h">174</td><td><div class="c3">34</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L174">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;getfriends&quot;)       { return getfriends(@args);       }</td></tr>
<tr><td class="h">175</td><td><div class="c3">34</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L175">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;friendof&quot;)         { return friendof(@args);         }</td></tr>
<tr><td class="h">176</td><td><div class="c3">34</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L176">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;checkfriends&quot;)     { return checkfriends(@args);     }</td></tr>
<tr><td class="h">177</td><td><div class="c3">34</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L177">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;getdaycounts&quot;)     { return getdaycounts(@args);     }</td></tr>
<tr><td class="h">178</td><td><div class="c3">34</div><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L178">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;postevent&quot;)        { return postevent(@args);        }</td></tr>
<tr><td class="h">179</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L179">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;editevent&quot;)        { return editevent(@args);        }</td></tr>
<tr><td class="h">180</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L180">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;syncitems&quot;)        { return syncitems(@args);        }</td></tr>
<tr><td class="h">181</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L181">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;getevents&quot;)        { return getevents(@args);        }</td></tr>
<tr><td class="h">182</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L182">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;editfriends&quot;)      { return editfriends(@args);      }</td></tr>
<tr><td class="h">183</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L183">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;editfriendgroups&quot;) { return editfriendgroups(@args); }</td></tr>
<tr><td class="h">184</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L184">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;consolecommand&quot;)   { return consolecommand(@args);   }</td></tr>
<tr><td class="h">185</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L185">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;getchallenge&quot;)     { return getchallenge(@args);     }</td></tr>
<tr><td class="h">186</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L186">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;sessiongenerate&quot;)  { return sessiongenerate(@args);  }</td></tr>
<tr><td class="h">187</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L187">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;sessionexpire&quot;)    { return sessionexpire(@args);    }</td></tr>
<tr><td class="h">188</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L188">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;getusertags&quot;)      { return getusertags(@args);      }</td></tr>
<tr><td class="h">189</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L189">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;getfriendspage&quot;)   { return getfriendspage(@args);   }</td></tr>
<tr><td class="h">190</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L190">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;getinbox&quot;)         { return getinbox(@args);         }</td></tr>
<tr><td class="h">191</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L191">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;sendmessage&quot;)      { return sendmessage(@args);      }</td></tr>
<tr><td class="h">192</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L192">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;setmessageread&quot;)   { return setmessageread(@args);   }</td></tr>
<tr><td class="h">193</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L193">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($method eq &quot;addcomment&quot;)       { return addcomment(@args);   }</td></tr>
<tr><td class="h">194</td><td colspan="7"></td></tr><tr><td class="h">195</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L195">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;notes-&gt;{codepath} = &quot;&quot;</td></tr>
<tr><td class="h">196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $r;</td></tr>
<tr><td class="h">197</td><td colspan="7"></td></tr><tr><td class="h">198</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,201);</td></tr>
<tr><td class="h">199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">200</td><td colspan="7"></td></tr><tr><td class="h">201</td><td colspan="7"></td></tr><tr><td class="h">202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub addcomment</td></tr>
<tr><td class="h">203</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">204</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L204">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">205</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L205">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">206</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">207</td><td colspan="7"></td></tr><tr><td class="h">208</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# some additional checks</td></tr>
<tr><td class="h">209</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L209">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,314) unless $u-&gt;is_paid;</td></tr>
<tr><td class="h">210</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L210">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,214) if LJ::Comment-&gt;is_text_spam( \ $req-&gt;{body} );</td></tr>
<tr><td class="h">211</td><td colspan="7"></td></tr><tr><td class="h">212</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# create</td></tr>
<tr><td class="h">213</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L213">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comment = LJ::Comment-&gt;create(</td></tr>
<tr><td class="h">214</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;journal      =&gt; $u,</td></tr>
<tr><td class="h">215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ditemid      =&gt; $req-&gt;{ditemid},</td></tr>
<tr><td class="h">216</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parenttalkid =&gt; ($req-&gt;{parenttalkid} || ($req-&gt;{parent} &gt;&gt; 8)),</td></tr>
<tr><td class="h">217</td><td colspan="7"></td></tr><tr><td class="h">218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;poster       =&gt; $u,</td></tr>
<tr><td class="h">219</td><td colspan="7"></td></tr><tr><td class="h">220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;body         =&gt; $req-&gt;{body},</td></tr>
<tr><td class="h">221</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject      =&gt; $req-&gt;{subject},</td></tr>
<tr><td class="h">222</td><td colspan="7"></td></tr><tr><td class="h">223</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;props        =&gt; { picture_keyword =&gt; $req-&gt;{prop_picture_keyword} }</td></tr>
<tr><td class="h">224</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">225</td><td colspan="7"></td></tr><tr><td class="h">226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# OK</td></tr>
<tr><td class="h">227</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {</td></tr>
<tr><td class="h">228</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status      =&gt; &quot;OK&quot;,</td></tr>
<tr><td class="h">229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;commentlink =&gt; $comment-&gt;url,</td></tr>
<tr><td class="h">230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dtalkid     =&gt; $comment-&gt;dtalkid,</td></tr>
<tr><td class="h">231</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">232</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">233</td><td colspan="7"></td></tr><tr><td class="h">234</td><td colspan="7"></td></tr><tr><td class="h">235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getfriendspage</td></tr>
<tr><td class="h">236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">237</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L237">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">238</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L238">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">239</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">240</td><td colspan="7"></td></tr><tr><td class="h">241</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L241">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemshow = (defined $req-&gt;{itemshow}) ? $req-&gt;{itemshow} : 100;</td></tr>
<tr><td class="h">242</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L242">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L242">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 209, &quot;Bad itemshow value&quot;) if $itemshow ne int($itemshow ) or $itemshow  &lt;= 0 or $itemshow  &gt; 100;</td></tr>
<tr><td class="h">243</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L243">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $skip = (defined $req-&gt;{skip}) ? $req-&gt;{skip} : 0;</td></tr>
<tr><td class="h">244</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L244">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L244">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 209, &quot;Bad skip value&quot;) if $skip ne int($skip ) or $skip  &lt; 0 or $skip  &gt; 100;</td></tr>
<tr><td class="h">245</td><td colspan="7"></td></tr><tr><td class="h">246</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @entries = LJ::get_friend_items({</td></tr>
<tr><td class="h">247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;u&#39; =&gt; $u,</td></tr>
<tr><td class="h">248</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;userid&#39; =&gt; $u-&gt;{&#39;userid&#39;},</td></tr>
<tr><td class="h">249</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;remote&#39; =&gt; $u,</td></tr>
<tr><td class="h">250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;itemshow&#39; =&gt; $itemshow,</td></tr>
<tr><td class="h">251</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;skip&#39; =&gt; $skip,</td></tr>
<tr><td class="h">252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;dateformat&#39; =&gt; &#39;S2&#39;,</td></tr>
<tr><td class="h">253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">254</td><td colspan="7"></td></tr><tr><td class="h">255</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @attrs = qw/subject_raw event_raw journalid posterid ditemid security/;</td></tr>
<tr><td class="h">256</td><td colspan="7"></td></tr><tr><td class="h">257</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @uids;</td></tr>
<tr><td class="h">258</td><td colspan="7"></td></tr><tr><td class="h">259</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @res = ();</td></tr>
<tr><td class="h">260</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lastsync = int $req-&gt;{lastsync};</td></tr>
<tr><td class="h">261</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $ei (@entries) {</td></tr>
<tr><td class="h">262</td><td colspan="7"></td></tr><tr><td class="h">263</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L263">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $ei;</td></tr>
<tr><td class="h">264</td><td colspan="7"></td></tr><tr><td class="h">265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# exit cycle if maximum friend items limit reached</td></tr>
<tr><td class="h">266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last </td></tr>
<tr><td class="h">267</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L267">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if scalar @res &gt;= FRIEND_ITEMS_LIMIT; </td></tr>
<tr><td class="h">268</td><td colspan="7"></td></tr><tr><td class="h">269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if passed lastsync argument - skip items with logtime less than lastsync</td></tr>
<tr><td class="h">270</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L270">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($lastsync) {</td></tr>
<tr><td class="h">271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next </td></tr>
<tr><td class="h">272</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L272">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $LJ::EndOfTime - $ei-&gt;{rlogtime} &lt;= $lastsync;</td></tr>
<tr><td class="h">273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">274</td><td colspan="7"></td></tr><tr><td class="h">275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new_from_item_hash($ei);</td></tr>
<tr><td class="h">276</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L276">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $entry;</td></tr>
<tr><td class="h">277</td><td colspan="7"></td></tr><tr><td class="h">278</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# event result data structure</td></tr>
<tr><td class="h">279</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %h = ();</td></tr>
<tr><td class="h">280</td><td colspan="7"></td></tr><tr><td class="h">281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Add more data for public posts</td></tr>
<tr><td class="h">282</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $method (@attrs) {</td></tr>
<tr><td class="h">283</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$h{$method} = $entry-&gt;$method;</td></tr>
<tr><td class="h">284</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">285</td><td colspan="7"></td></tr><tr><td class="h">286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# log time value </td></tr>
<tr><td class="h">287</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$h{logtime} = $LJ::EndOfTime - $ei-&gt;{rlogtime};</td></tr>
<tr><td class="h">288</td><td colspan="7"></td></tr><tr><td class="h">289</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @res, \%h;</td></tr>
<tr><td class="h">290</td><td colspan="7"></td></tr><tr><td class="h">291</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @uids, $h{posterid}, $h{journalid};</td></tr>
<tr><td class="h">292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">293</td><td colspan="7"></td></tr><tr><td class="h">294</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $users = LJ::load_userids(@uids);</td></tr>
<tr><td class="h">295</td><td colspan="7"></td></tr><tr><td class="h">296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (@res) {</td></tr>
<tr><td class="h">297</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_-&gt;{journalname} = $users-&gt;{ $_-&gt;{journalid} }-&gt;{&#39;user&#39;};</td></tr>
<tr><td class="h">298</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_-&gt;{journaltype} = $users-&gt;{ $_-&gt;{journalid} }-&gt;{&#39;journaltype&#39;};</td></tr>
<tr><td class="h">299</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $_-&gt;{journalid};</td></tr>
<tr><td class="h">300</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_-&gt;{postername} = $users-&gt;{ $_-&gt;{posterid} }-&gt;{&#39;user&#39;};</td></tr>
<tr><td class="h">301</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_-&gt;{postertype} = $users-&gt;{ $_-&gt;{posterid} }-&gt;{&#39;journaltype&#39;};</td></tr>
<tr><td class="h">302</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $_-&gt;{posterid};</td></tr>
<tr><td class="h">303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">304</td><td colspan="7"></td></tr><tr><td class="h">305</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;getfriendspage&quot;, { &#39;userid&#39; =&gt; $u-&gt;userid, });</td></tr>
<tr><td class="h">306</td><td colspan="7"></td></tr><tr><td class="h">307</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return { &#39;entries&#39; =&gt; [ @res ] };</td></tr>
<tr><td class="h">308</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">309</td><td colspan="7"></td></tr><tr><td class="h">310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getinbox</td></tr>
<tr><td class="h">311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">312</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L312">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">313</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L313">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">314</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">315</td><td colspan="7"></td></tr><tr><td class="h">316</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L316">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemshow = (defined $req-&gt;{itemshow}) ? $req-&gt;{itemshow} : 100;</td></tr>
<tr><td class="h">317</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L317">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L317">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 209, &quot;Bad itemshow value&quot;) if $itemshow ne int($itemshow ) or $itemshow  &lt;= 0 or $itemshow  &gt; 100;</td></tr>
<tr><td class="h">318</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L318">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $skip = (defined $req-&gt;{skip}) ? $req-&gt;{skip} : 0;</td></tr>
<tr><td class="h">319</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L319">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L319">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 209, &quot;Bad skip value&quot;) if $skip ne int($skip ) or $skip  &lt; 0 or $skip  &gt; 100;</td></tr>
<tr><td class="h">320</td><td colspan="7"></td></tr><tr><td class="h">321</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get the user&#39;s inbox</td></tr>
<tr><td class="h">322</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L322">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $inbox = $u-&gt;notification_inbox or return fail($err, 500, &quot;Cannot get user inbox&quot;);</td></tr>
<tr><td class="h">323</td><td colspan="7"></td></tr><tr><td class="h">324</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %type_number = (</td></tr>
<tr><td class="h">325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddedToCircle        =&gt; 1,</td></tr>
<tr><td class="h">326</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Birthday             =&gt; 2,</td></tr>
<tr><td class="h">327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CommunityInvite      =&gt; 3,</td></tr>
<tr><td class="h">328</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CommunityJoinApprove =&gt; 4,</td></tr>
<tr><td class="h">329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CommunityJoinReject  =&gt; 5,</td></tr>
<tr><td class="h">330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CommunityJoinRequest =&gt; 6,</td></tr>
<tr><td class="h">331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemovedFromCircle    =&gt; 7,</td></tr>
<tr><td class="h">332</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InvitedFriendJoins   =&gt; 8,</td></tr>
<tr><td class="h">333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JournalNewComment    =&gt; 9,</td></tr>
<tr><td class="h">334</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JournalNewEntry      =&gt; 10,</td></tr>
<tr><td class="h">335</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NewUserpic           =&gt; 11,</td></tr>
<tr><td class="h">336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NewVGift             =&gt; 12,</td></tr>
<tr><td class="h">337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OfficialPost         =&gt; 13,</td></tr>
<tr><td class="h">338</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PermSale             =&gt; 14,</td></tr>
<tr><td class="h">339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PollVote             =&gt; 15,</td></tr>
<tr><td class="h">340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SupOfficialPost      =&gt; 16,</td></tr>
<tr><td class="h">341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserExpunged         =&gt; 17,</td></tr>
<tr><td class="h">342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserMessageRecvd     =&gt; 18,</td></tr>
<tr><td class="h">343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserMessageSent      =&gt; 19,</td></tr>
<tr><td class="h">344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserNewComment       =&gt; 20,</td></tr>
<tr><td class="h">345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserNewEntry         =&gt; 21,</td></tr>
<tr><td class="h">346</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">347</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %number_type = reverse %type_number;</td></tr>
<tr><td class="h">348</td><td colspan="7"></td></tr><tr><td class="h">349</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @notifications;</td></tr>
<tr><td class="h">350</td><td colspan="7"></td></tr><tr><td class="h">351</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sync_date;</td></tr>
<tr><td class="h">352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check lastsync for valid date </td></tr>
<tr><td class="h">353</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L353">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;lastsync&#39;}) {</td></tr>
<tr><td class="h">354</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sync_date = int $req-&gt;{&#39;lastsync&#39;};</td></tr>
<tr><td class="h">355</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L355">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($sync_date &lt;= 0) {</td></tr>
<tr><td class="h">356</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Invalid syncitems date format (must be unixtime)&quot;);</td></tr>
<tr><td class="h">357</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">359</td><td colspan="7"></td></tr><tr><td class="h">360</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L360">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{gettype}) {</td></tr>
<tr><td class="h">361</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@notifications = grep { $_-&gt;event-&gt;class eq &quot;LJ::Event::&quot; . $number_type{$req-&gt;{gettype}} } $inbox-&gt;items;</td></tr>
<tr><td class="h">362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">363</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@notifications = $inbox-&gt;all_items;</td></tr>
<tr><td class="h">364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">365</td><td colspan="7"></td></tr><tr><td class="h">366</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# By default, notifications are sorted as &quot;oldest are the first&quot;</td></tr>
<tr><td class="h">367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Reverse it by &quot;newest are the first&quot;</td></tr>
<tr><td class="h">368</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;@notifications = reverse @notifications;</td></tr>
<tr><td class="h">369</td><td colspan="7"></td></tr><tr><td class="h">370</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L370">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$itemshow = scalar @notifications - $skip if scalar @notifications &lt; $skip + $itemshow;</td></tr>
<tr><td class="h">371</td><td colspan="7"></td></tr><tr><td class="h">372</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @res;</td></tr>
<tr><td class="h">373</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $item (@notifications[$skip .. $itemshow + $skip - 1]) {</td></tr>
<tr><td class="h">374</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L374">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L374">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $sync_date &amp;&amp; $item-&gt;when_unixtime &lt; $sync_date;</td></tr>
<tr><td class="h">375</td><td colspan="7"></td></tr><tr><td class="h">376</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $raw = $item-&gt;event-&gt;raw_info($u, {extended =&gt; $req-&gt;{extended}});</td></tr>
<tr><td class="h">377</td><td colspan="7"></td></tr><tr><td class="h">378</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $type_index = $type_number{$raw-&gt;{type}};</td></tr>
<tr><td class="h">379</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L379">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $type_index) {</td></tr>
<tr><td class="h">380</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$raw-&gt;{type} = $type_index;</td></tr>
<tr><td class="h">381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">382</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$raw-&gt;{typename} = $raw-&gt;{type};</td></tr>
<tr><td class="h">383</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$raw-&gt;{type} = 0;</td></tr>
<tr><td class="h">384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">385</td><td colspan="7"></td></tr><tr><td class="h">386</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$raw-&gt;{state} = $item-&gt;{state};</td></tr>
<tr><td class="h">387</td><td colspan="7"></td></tr><tr><td class="h">388</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @res, { %$raw, </td></tr>
<tr><td class="h">389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when   =&gt; $item-&gt;when_unixtime,</td></tr>
<tr><td class="h">390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qid    =&gt; $item-&gt;qid,</td></tr>
<tr><td class="h">391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">393</td><td colspan="7"></td></tr><tr><td class="h">394</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return { &#39;items&#39; =&gt; \@res, </td></tr>
<tr><td class="h">395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;login&#39; =&gt; $u-&gt;user, </td></tr>
<tr><td class="h">396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;journaltype&#39; =&gt; $u-&gt;journaltype };</td></tr>
<tr><td class="h">397</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">398</td><td colspan="7"></td></tr><tr><td class="h">399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub setmessageread {</td></tr>
<tr><td class="h">400</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L400">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">401</td><td colspan="7"></td></tr><tr><td class="h">402</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L402">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">403</td><td colspan="7"></td></tr><tr><td class="h">404</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">405</td><td colspan="7"></td></tr><tr><td class="h">406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get the user&#39;s inbox</td></tr>
<tr><td class="h">407</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L407">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $inbox = $u-&gt;notification_inbox or return fail($err, 500, &quot;Cannot get user inbox&quot;);</td></tr>
<tr><td class="h">408</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @result;</td></tr>
<tr><td class="h">409</td><td colspan="7"></td></tr><tr><td class="h">410</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# passing requested ids for loading</td></tr>
<tr><td class="h">411</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @notifications = $inbox-&gt;all_items;</td></tr>
<tr><td class="h">412</td><td colspan="7"></td></tr><tr><td class="h">413</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Try to select messages by qid if specified</td></tr>
<tr><td class="h">414</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @qids = @{$req-&gt;{qid}};</td></tr>
<tr><td class="h">415</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L415">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (scalar @qids) {</td></tr>
<tr><td class="h">416</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $qid (@qids) {</td></tr>
<tr><td class="h">417</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $item = eval {LJ::NotificationItem-&gt;new($u, $qid)};</td></tr>
<tr><td class="h">418</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L418">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;mark_read if $item;</td></tr>
<tr><td class="h">419</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @result, { qid =&gt; $qid, result =&gt; &#39;set read&#39;  };</td></tr>
<tr><td class="h">420</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">421</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else { # Else select it by msgid for back compatibility</td></tr>
<tr><td class="h">422</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# make hash of requested message ids</td></tr>
<tr><td class="h">423</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %requested_items = map { $_ =&gt; 1 } @{$req-&gt;{messageid}};</td></tr>
<tr><td class="h">424</td><td colspan="7"></td></tr><tr><td class="h">425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# proccessing only requested ids</td></tr>
<tr><td class="h">426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $item (@notifications) {</td></tr>
<tr><td class="h">427</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msgid = $item-&gt;event-&gt;raw_info($u)-&gt;{msgid};</td></tr>
<tr><td class="h">428</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L428">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $requested_items{$msgid}; </td></tr>
<tr><td class="h">429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if message already read - </td></tr>
<tr><td class="h">430</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L430">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($item-&gt;{state} eq &#39;R&#39;) {</td></tr>
<tr><td class="h">431</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @result, { msgid =&gt; $msgid, result =&gt; &#39;already red&#39; };</td></tr>
<tr><td class="h">432</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next;</td></tr>
<tr><td class="h">433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# in state no &#39;R&#39; - marking as red</td></tr>
<tr><td class="h">435</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;mark_read;</td></tr>
<tr><td class="h">436</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @result, { msgid =&gt; $msgid, result =&gt; &#39;set read&#39;  };</td></tr>
<tr><td class="h">437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">439</td><td colspan="7"></td></tr><tr><td class="h">440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {</td></tr>
<tr><td class="h">441</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result =&gt; \@result</td></tr>
<tr><td class="h">442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">443</td><td colspan="7"></td></tr><tr><td class="h">444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">445</td><td colspan="7"></td></tr><tr><td class="h">446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Sends a private message from one account to another</td></tr>
<tr><td class="h">447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub sendmessage</td></tr>
<tr><td class="h">448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">449</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L449">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">450</td><td colspan="7"></td></tr><tr><td class="h">451</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L451">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 315) unless LJ::is_enabled(&#39;user_messaging&#39;);</td></tr>
<tr><td class="h">452</td><td colspan="7"></td></tr><tr><td class="h">453</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L453">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">455</td><td colspan="7"></td></tr><tr><td class="h">456</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L456">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 305) if $u-&gt;is_suspended; # suspended cannot send private messages</td></tr>
<tr><td class="h">457</td><td colspan="7"></td></tr><tr><td class="h">458</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $msg_limit = LJ::get_cap($u, &quot;usermessage_length&quot;);</td></tr>
<tr><td class="h">459</td><td colspan="7"></td></tr><tr><td class="h">460</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @errors;</td></tr>
<tr><td class="h">461</td><td colspan="7"></td></tr><tr><td class="h">462</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# test encoding and length</td></tr>
<tr><td class="h">463</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $subject_text = $req-&gt;{&#39;subject&#39;};</td></tr>
<tr><td class="h">464</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L464">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 208, &#39;subject&#39;)</td></tr>
<tr><td class="h">465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::text_in($subject_text);</td></tr>
<tr><td class="h">466</td><td colspan="7"></td></tr><tr><td class="h">467</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# test encoding and length</td></tr>
<tr><td class="h">468</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $body_text = $req-&gt;{&#39;body&#39;};</td></tr>
<tr><td class="h">469</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L469">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 208, &#39;body&#39;)</td></tr>
<tr><td class="h">470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::text_in($body_text);</td></tr>
<tr><td class="h">471</td><td colspan="7"></td></tr><tr><td class="h">472</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($msg_len_b, $msg_len_c) = LJ::text_length($body_text);</td></tr>
<tr><td class="h">473</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L473">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 212, &#39;found: &#39; . LJ::commafy($msg_len_c) . &#39; characters, it should not exceed &#39; . LJ::commafy($msg_limit))</td></tr>
<tr><td class="h">474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($msg_len_c &lt;= $msg_limit);</td></tr>
<tr><td class="h">475</td><td colspan="7"></td></tr><tr><td class="h">476</td><td colspan="7"></td></tr><tr><td class="h">477</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L477">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 213, &#39;found: &#39; . LJ::commafy($msg_len_c) . &#39; characters, it should exceed zero&#39;)</td></tr>
<tr><td class="h">478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($msg_len_c &lt;= 0);</td></tr>
<tr><td class="h">479</td><td colspan="7"></td></tr><tr><td class="h">480</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L480">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @to = (ref $req-&gt;{&#39;to&#39;}) ? @{$req-&gt;{&#39;to&#39;}} : ($req-&gt;{&#39;to&#39;});</td></tr>
<tr><td class="h">481</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L481">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 200) unless scalar @to;</td></tr>
<tr><td class="h">482</td><td colspan="7"></td></tr><tr><td class="h">483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove duplicates</td></tr>
<tr><td class="h">484</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %to = map { lc($_), 1 } @to;</td></tr>
<tr><td class="h">485</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;@to = keys %to;</td></tr>
<tr><td class="h">486</td><td colspan="7"></td></tr><tr><td class="h">487</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @msg;</td></tr>
<tr><td class="h">488</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;BML::set_language(&#39;en&#39;); # FIXME</td></tr>
<tr><td class="h">489</td><td colspan="7"></td></tr><tr><td class="h">490</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $to (@to) {</td></tr>
<tr><td class="h">491</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tou = LJ::load_user($to);</td></tr>
<tr><td class="h">492</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L492">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 100, $to)</td></tr>
<tr><td class="h">493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $tou;</td></tr>
<tr><td class="h">494</td><td colspan="7"></td></tr><tr><td class="h">495</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L495">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L495">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg = LJ::Message-&gt;new({</td></tr>
<tr><td class="h">496</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;journalid =&gt; $u-&gt;userid,</td></tr>
<tr><td class="h">497</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;otherid =&gt; $tou-&gt;userid,</td></tr>
<tr><td class="h">498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject =&gt; $subject_text,</td></tr>
<tr><td class="h">499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;body =&gt; $body_text,</td></tr>
<tr><td class="h">500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent_msgid =&gt; defined $req-&gt;{&#39;parent&#39;} ? $req-&gt;{&#39;parent&#39;} + 0 : undef,</td></tr>
<tr><td class="h">501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userpic =&gt; $req-&gt;{&#39;userpic&#39;} || undef,</td></tr>
<tr><td class="h">502</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">503</td><td colspan="7"></td></tr><tr><td class="h">504</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L504">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @msg, $msg </td></tr>
<tr><td class="h">505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $msg-&gt;can_send(\@errors);</td></tr>
<tr><td class="h">506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">507</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L507">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 203, join(&#39;; &#39;, @errors))</td></tr>
<tr><td class="h">508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if scalar @errors;</td></tr>
<tr><td class="h">509</td><td colspan="7"></td></tr><tr><td class="h">510</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $msg (@msg) {</td></tr>
<tr><td class="h">511</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$msg-&gt;send(\@errors);</td></tr>
<tr><td class="h">512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">513</td><td colspan="7"></td></tr><tr><td class="h">514</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L514">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return { &#39;sent_count&#39; =&gt; scalar @msg, &#39;msgid&#39; =&gt; [ grep { $_ } map { $_-&gt;msgid } @msg ],</td></tr>
<tr><td class="h">515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(@errors ? (&#39;last_errors&#39; =&gt; \@errors) : () ),</td></tr>
<tr><td class="h">516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">517</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">518</td><td colspan="7"></td></tr><tr><td class="h">519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub login</td></tr>
<tr><td class="h">520</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">521</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L521">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">522</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L522">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">523</td><td colspan="7"></td></tr><tr><td class="h">524</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">525</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">526</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ver = $req-&gt;{&#39;ver&#39;};</td></tr>
<tr><td class="h">527</td><td colspan="7"></td></tr><tr><td class="h">528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## check for version mismatches</td></tr>
<tr><td class="h">529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## non-Unicode installations can&#39;t handle versions &gt;=1</td></tr>
<tr><td class="h">530</td><td colspan="7"></td></tr><tr><td class="h">531</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L531">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L531">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,207, &quot;This installation does not support Unicode clients&quot;)</td></tr>
<tr><td class="h">532</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $ver&gt;=1 and not $LJ::UNICODE;</td></tr>
<tr><td class="h">533</td><td colspan="7"></td></tr><tr><td class="h">534</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do not let locked people log in</td></tr>
<tr><td class="h">535</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L535">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 308) if $u-&gt;is_locked;</td></tr>
<tr><td class="h">536</td><td colspan="7"></td></tr><tr><td class="h">537</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## return a message to the client to be displayed (optional)</td></tr>
<tr><td class="h">538</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;login_message($req, $res, $flags);</td></tr>
<tr><td class="h">539</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L539">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L539">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$res-&gt;{&#39;message&#39;}) if $ver&gt;=1 and defined $res-&gt;{&#39;message&#39;};</td></tr>
<tr><td class="h">540</td><td colspan="7"></td></tr><tr><td class="h">541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## report what shared journals this user may post in</td></tr>
<tr><td class="h">542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;usejournals&#39;} = list_usejournals($u);</td></tr>
<tr><td class="h">543</td><td colspan="7"></td></tr><tr><td class="h">544</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## return their friend groups</td></tr>
<tr><td class="h">545</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;friendgroups&#39;} = list_friendgroups($u);</td></tr>
<tr><td class="h">546</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L546">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 502, &quot;Error loading friend groups&quot;) unless $res-&gt;{&#39;friendgroups&#39;};</td></tr>
<tr><td class="h">547</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L547">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($ver &gt;= 1) {</td></tr>
<tr><td class="h">548</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@{$res-&gt;{&#39;friendgroups&#39;}}) {</td></tr>
<tr><td class="h">549</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$_-&gt;{&#39;name&#39;});</td></tr>
<tr><td class="h">550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">552</td><td colspan="7"></td></tr><tr><td class="h">553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## if they gave us a number of moods to get higher than, then return them</td></tr>
<tr><td class="h">554</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L554">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $req-&gt;{&#39;getmoods&#39;}) {</td></tr>
<tr><td class="h">555</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;moods&#39;} = list_moods($req-&gt;{&#39;getmoods&#39;});</td></tr>
<tr><td class="h">556</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L556">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($ver &gt;= 1) {</td></tr>
<tr><td class="h">557</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# currently all moods are in English, but this might change</td></tr>
<tr><td class="h">558</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@{$res-&gt;{&#39;moods&#39;}}) { LJ::text_out(\$_-&gt;{&#39;name&#39;}) }</td></tr>
<tr><td class="h">559</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">560</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">561</td><td colspan="7"></td></tr><tr><td class="h">562</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### picture keywords, if they asked for them.</td></tr>
<tr><td class="h">563</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L563">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;getpickws&#39;}) {</td></tr>
<tr><td class="h">564</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pickws = list_pickws($u);</td></tr>
<tr><td class="h">565</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@$pickws = sort { lc($a-&gt;[0]) cmp lc($b-&gt;[0]) } @$pickws;</td></tr>
<tr><td class="h">566</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;pickws&#39;} = [ map { $_-&gt;[0] } @$pickws ];</td></tr>
<tr><td class="h">567</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L567">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;getpickwurls&#39;}) {</td></tr>
<tr><td class="h">568</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L568">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;defaultpicid&#39;}) {</td></tr>
<tr><td class="h">569</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;defaultpicurl&#39;} = &quot;$LJ::USERPIC_ROOT/$u-&gt;{&#39;defaultpicid&#39;}/$u-&gt;{&#39;userid&#39;}&quot;;</td></tr>
<tr><td class="h">570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">571</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;pickwurls&#39;} = [ map {</td></tr>
<tr><td class="h">572</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;$LJ::USERPIC_ROOT/$_-&gt;[1]/$u-&gt;{&#39;userid&#39;}&quot;</td></tr>
<tr><td class="h">573</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} @$pickws ];</td></tr>
<tr><td class="h">574</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">575</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L575">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($ver &gt;= 1) {</td></tr>
<tr><td class="h">576</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# validate all text</td></tr>
<tr><td class="h">577</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(@{$res-&gt;{&#39;pickws&#39;}}) { LJ::text_out(\$_); }</td></tr>
<tr><td class="h">578</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(@{$res-&gt;{&#39;pickwurls&#39;}}) { LJ::text_out(\$_); }</td></tr>
<tr><td class="h">579</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$res-&gt;{&#39;defaultpicurl&#39;});</td></tr>
<tr><td class="h">580</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## return caps, if they asked for them</td></tr>
<tr><td class="h">583</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L583">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;getcaps&#39;}) {</td></tr>
<tr><td class="h">584</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;caps&#39;} = $u-&gt;caps;</td></tr>
<tr><td class="h">585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">586</td><td colspan="7"></td></tr><tr><td class="h">587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## return client menu tree, if requested</td></tr>
<tr><td class="h">588</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L588">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;getmenus&#39;}) {</td></tr>
<tr><td class="h">589</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;menus&#39;} = hash_menus($u);</td></tr>
<tr><td class="h">590</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L590">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($ver &gt;= 1) {</td></tr>
<tr><td class="h">591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# validate all text, just in case, even though currently</td></tr>
<tr><td class="h">592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# it&#39;s all English</td></tr>
<tr><td class="h">593</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@{$res-&gt;{&#39;menus&#39;}}) {</td></tr>
<tr><td class="h">594</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$_-&gt;{&#39;text&#39;});</td></tr>
<tr><td class="h">595</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$_-&gt;{&#39;url&#39;}); # should be redundant</td></tr>
<tr><td class="h">596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">597</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">598</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">599</td><td colspan="7"></td></tr><tr><td class="h">600</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## tell some users they can hit the fast servers later.</td></tr>
<tr><td class="h">601</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L601">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;fastserver&#39;} = 1 if LJ::get_cap($u, &quot;fastserver&quot;);</td></tr>
<tr><td class="h">602</td><td colspan="7"></td></tr><tr><td class="h">603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## user info</td></tr>
<tr><td class="h">604</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;userid&#39;} = $u-&gt;{&#39;userid&#39;};</td></tr>
<tr><td class="h">605</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;fullname&#39;} = $u-&gt;{&#39;name&#39;};</td></tr>
<tr><td class="h">606</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L606">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$res-&gt;{&#39;fullname&#39;}) if $ver &gt;= 1;</td></tr>
<tr><td class="h">607</td><td colspan="7"></td></tr><tr><td class="h">608</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L608">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;clientversion&#39;} =~ /^\S+\/\S+$/) {</td></tr>
<tr><td class="h">609</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval {</td></tr>
<tr><td class="h">610</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $r = BML::get_request();</td></tr>
<tr><td class="h">611</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;notes-&gt;{clientver} = $req-&gt;{&#39;clientversion&#39;};</td></tr>
<tr><td class="h">612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">613</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">614</td><td colspan="7"></td></tr><tr><td class="h">615</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## update or add to clientusage table</td></tr>
<tr><td class="h">616</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L616">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L616">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;clientversion&#39;} =~ /^\S+\/\S+$/ &amp;&amp;</td></tr>
<tr><td class="h">617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::is_enabled(&#39;clientversionlog&#39;))</td></tr>
<tr><td class="h">618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">619</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $client = $req-&gt;{&#39;clientversion&#39;};</td></tr>
<tr><td class="h">620</td><td colspan="7"></td></tr><tr><td class="h">621</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L621">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L621">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 208, &quot;Bad clientversion string&quot;)</td></tr>
<tr><td class="h">622</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $ver &gt;= 1 and not LJ::text_in($client);</td></tr>
<tr><td class="h">623</td><td colspan="7"></td></tr><tr><td class="h">624</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">625</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $qclient = $dbh-&gt;quote($client);</td></tr>
<tr><td class="h">626</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cu_sql = &quot;REPLACE INTO clientusage (userid, clientid, lastlogin) &quot; .</td></tr>
<tr><td class="h">627</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SELECT $u-&gt;{&#39;userid&#39;}, clientid, NOW() FROM clients WHERE client=$qclient&quot;;</td></tr>
<tr><td class="h">628</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbh-&gt;prepare($cu_sql);</td></tr>
<tr><td class="h">629</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">630</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L630">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($sth-&gt;rows) {</td></tr>
<tr><td class="h">631</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# only way this can be 0 is if client doesn&#39;t exist in clients table, so</td></tr>
<tr><td class="h">632</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we need to add a new row there, to get a new clientid for this new client:</td></tr>
<tr><td class="h">633</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO clients (client) VALUES ($qclient)&quot;);</td></tr>
<tr><td class="h">634</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# and now we can do the query from before and it should work:</td></tr>
<tr><td class="h">635</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $dbh-&gt;prepare($cu_sql);</td></tr>
<tr><td class="h">636</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">637</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">639</td><td colspan="7"></td></tr><tr><td class="h">640</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">642</td><td colspan="7"></td></tr><tr><td class="h">643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getfriendgroups</td></tr>
<tr><td class="h">644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">645</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L645">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">646</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L646">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">647</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">648</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">649</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;friendgroups&#39;} = list_friendgroups($u);</td></tr>
<tr><td class="h">650</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L650">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 502, &quot;Error loading friend groups&quot;) unless $res-&gt;{&#39;friendgroups&#39;};</td></tr>
<tr><td class="h">651</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L651">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;ver&#39;} &gt;= 1) {</td></tr>
<tr><td class="h">652</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L652">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@{$res-&gt;{&#39;friendgroups&#39;} || []}) {</td></tr>
<tr><td class="h">653</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$_-&gt;{&#39;name&#39;});</td></tr>
<tr><td class="h">654</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">656</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">657</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">658</td><td colspan="7"></td></tr><tr><td class="h">659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getusertags</td></tr>
<tr><td class="h">660</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">661</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L661">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">662</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L662">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">663</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L663">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless check_altusage($req, $err, $flags);</td></tr>
<tr><td class="h">664</td><td colspan="7"></td></tr><tr><td class="h">665</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">666</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L666">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uowner = $flags-&gt;{&#39;u_owner&#39;} || $u;</td></tr>
<tr><td class="h">667</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L667">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L667">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($req, 502) unless $u &amp;&amp; $uowner;</td></tr>
<tr><td class="h">668</td><td colspan="7"></td></tr><tr><td class="h">669</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $tags = LJ::Tags::get_usertags($uowner, { remote =&gt; $u });</td></tr>
<tr><td class="h">670</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return { tags =&gt; [ values %$tags ] };</td></tr>
<tr><td class="h">671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">672</td><td colspan="7"></td></tr><tr><td class="h">673</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getfriends</td></tr>
<tr><td class="h">674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">675</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L675">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">676</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L676">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">677</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L677">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($req,502) unless LJ::get_db_reader();</td></tr>
<tr><td class="h">678</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">679</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">680</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L680">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;includegroups&#39;}) {</td></tr>
<tr><td class="h">681</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;friendgroups&#39;} = list_friendgroups($u);</td></tr>
<tr><td class="h">682</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L682">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 502, &quot;Error loading friend groups&quot;) unless $res-&gt;{&#39;friendgroups&#39;};</td></tr>
<tr><td class="h">683</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L683">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;ver&#39;} &gt;= 1) {</td></tr>
<tr><td class="h">684</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L684">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@{$res-&gt;{&#39;friendgroups&#39;} || []}) {</td></tr>
<tr><td class="h">685</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$_-&gt;{&#39;name&#39;});</td></tr>
<tr><td class="h">686</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">689</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TAG:FR:protocol:getfriends_of</td></tr>
<tr><td class="h">690</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L690">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;includefriendof&#39;}) {</td></tr>
<tr><td class="h">691</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;friendofs&#39;} = list_friends($u, {</td></tr>
<tr><td class="h">692</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;limit&#39; =&gt; $req-&gt;{&#39;friendoflimit&#39;},</td></tr>
<tr><td class="h">693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;friendof&#39; =&gt; 1,</td></tr>
<tr><td class="h">694</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">695</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L695">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;ver&#39;} &gt;= 1) {</td></tr>
<tr><td class="h">696</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(@{$res-&gt;{&#39;friendofs&#39;}}) { LJ::text_out(\$_-&gt;{&#39;fullname&#39;}) };</td></tr>
<tr><td class="h">697</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">698</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">699</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TAG:FR:protocol:getfriends</td></tr>
<tr><td class="h">700</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;friends&#39;} = list_friends($u, {</td></tr>
<tr><td class="h">701</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;limit&#39; =&gt; $req-&gt;{&#39;friendlimit&#39;},</td></tr>
<tr><td class="h">702</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;includebdays&#39; =&gt; $req-&gt;{&#39;includebdays&#39;},</td></tr>
<tr><td class="h">703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">704</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L704">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;ver&#39;} &gt;= 1) {</td></tr>
<tr><td class="h">705</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(@{$res-&gt;{&#39;friends&#39;}}) { LJ::text_out(\$_-&gt;{&#39;fullname&#39;}) };</td></tr>
<tr><td class="h">706</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">707</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">709</td><td colspan="7"></td></tr><tr><td class="h">710</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub friendof</td></tr>
<tr><td class="h">711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">712</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L712">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">713</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L713">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">714</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L714">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($req,502) unless LJ::get_db_reader();</td></tr>
<tr><td class="h">715</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">716</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">717</td><td colspan="7"></td></tr><tr><td class="h">718</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TAG:FR:protocol:getfriends_of2 (same as TAG:FR:protocol:getfriends_of)</td></tr>
<tr><td class="h">719</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;friendofs&#39;} = list_friends($u, {</td></tr>
<tr><td class="h">720</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;friendof&#39; =&gt; 1,</td></tr>
<tr><td class="h">721</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;limit&#39; =&gt; $req-&gt;{&#39;friendoflimit&#39;},</td></tr>
<tr><td class="h">722</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">723</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L723">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;ver&#39;} &gt;= 1) {</td></tr>
<tr><td class="h">724</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(@{$res-&gt;{&#39;friendofs&#39;}}) { LJ::text_out(\$_-&gt;{&#39;fullname&#39;}) };</td></tr>
<tr><td class="h">725</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">726</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">727</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">728</td><td colspan="7"></td></tr><tr><td class="h">729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub checkfriends</td></tr>
<tr><td class="h">730</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">731</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L731">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">732</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L732">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">733</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">734</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">735</td><td colspan="7"></td></tr><tr><td class="h">736</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return immediately if they can&#39;t use this mode</td></tr>
<tr><td class="h">737</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L737">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (LJ::get_cap($u, &quot;checkfriends&quot;)) {</td></tr>
<tr><td class="h">738</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;new&#39;} = 0;</td></tr>
<tr><td class="h">739</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;interval&#39;} = 36000;  # tell client to bugger off</td></tr>
<tr><td class="h">740</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">741</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">742</td><td colspan="7"></td></tr><tr><td class="h">743</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## have a valid date?</td></tr>
<tr><td class="h">744</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lastupdate = $req-&gt;{&#39;lastupdate&#39;};</td></tr>
<tr><td class="h">745</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L745">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($lastupdate) {</td></tr>
<tr><td class="h">746</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L746">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203) unless</td></tr>
<tr><td class="h">747</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($lastupdate =~ /^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d/);</td></tr>
<tr><td class="h">748</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">749</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lastupdate = &quot;0000-00-00 00:00:00&quot;;</td></tr>
<tr><td class="h">750</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">751</td><td colspan="7"></td></tr><tr><td class="h">752</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $interval = LJ::get_cap_min($u, &quot;checkfriends_interval&quot;);</td></tr>
<tr><td class="h">753</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;interval&#39;} = $interval;</td></tr>
<tr><td class="h">754</td><td colspan="7"></td></tr><tr><td class="h">755</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mask;</td></tr>
<tr><td class="h">756</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L756">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L756">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mask&#39;} and $req-&gt;{&#39;mask&#39;} !~ /\D/) {</td></tr>
<tr><td class="h">757</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mask = $req-&gt;{&#39;mask&#39;};</td></tr>
<tr><td class="h">758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">759</td><td colspan="7"></td></tr><tr><td class="h">760</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;{&#39;userid&#39;},&quot;checkfriends:$u-&gt;{userid}:$mask&quot;];</td></tr>
<tr><td class="h">761</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $update = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">762</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L762">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($update) {</td></tr>
<tr><td class="h">763</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# TAG:FR:protocol:checkfriends (wants reading list of mask, not &quot;friends&quot;)</td></tr>
<tr><td class="h">764</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fr = LJ::get_friends($u, $mask);</td></tr>
<tr><td class="h">765</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L765">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L765">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($fr &amp;&amp; %$fr) {</td></tr>
<tr><td class="h">766</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;new&#39;} = 0;</td></tr>
<tr><td class="h">767</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;lastupdate&#39;} = $lastupdate;</td></tr>
<tr><td class="h">768</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">769</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">770</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L770">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@LJ::MEMCACHE_SERVERS) {</td></tr>
<tr><td class="h">771</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tu = LJ::get_timeupdate_multi({ memcache_only =&gt; 1 }, keys %$fr);</td></tr>
<tr><td class="h">772</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $max = 0;</td></tr>
<tr><td class="h">773</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while ($_ = each %$tu) {</td></tr>
<tr><td class="h">774</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L774">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$max = $tu-&gt;{$_} if $tu-&gt;{$_} &gt; $max;</td></tr>
<tr><td class="h">775</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">776</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L776">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$update = LJ::mysql_time($max) if $max;</td></tr>
<tr><td class="h">777</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">778</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">779</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L779">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($dbr) {</td></tr>
<tr><td class="h">780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# rather than return a 502 no-db error, just say no updates,</td></tr>
<tr><td class="h">781</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# because problem&#39;ll be fixed soon enough by db admins</td></tr>
<tr><td class="h">782</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;new&#39;} = 0;</td></tr>
<tr><td class="h">783</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;lastupdate&#39;} = $lastupdate;</td></tr>
<tr><td class="h">784</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">785</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">786</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $list = join(&quot;, &quot;, map { int($_) } keys %$fr);</td></tr>
<tr><td class="h">787</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L787">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($list) {</td></tr>
<tr><td class="h">788</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sql = &quot;SELECT MAX(timeupdate) FROM userusage &quot;.</td></tr>
<tr><td class="h">789</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid IN ($list)&quot;;</td></tr>
<tr><td class="h">790</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$update = $dbr-&gt;selectrow_array($sql);</td></tr>
<tr><td class="h">791</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">792</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">793</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L793">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey,$update,time()+$interval) if $update;</td></tr>
<tr><td class="h">794</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">795</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L795">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$update ||= &quot;0000-00-00 00:00:00&quot;;</td></tr>
<tr><td class="h">796</td><td colspan="7"></td></tr><tr><td class="h">797</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L797">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L797">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;lastupdate&#39;} &amp;&amp; $update gt $lastupdate) {</td></tr>
<tr><td class="h">798</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;new&#39;} = 1;</td></tr>
<tr><td class="h">799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">800</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;new&#39;} = 0;</td></tr>
<tr><td class="h">801</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">802</td><td colspan="7"></td></tr><tr><td class="h">803</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;lastupdate&#39;} = $update;</td></tr>
<tr><td class="h">804</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">806</td><td colspan="7"></td></tr><tr><td class="h">807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getdaycounts</td></tr>
<tr><td class="h">808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">809</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L809">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">810</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L810">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">811</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L811">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless check_altusage($req, $err, $flags);</td></tr>
<tr><td class="h">812</td><td colspan="7"></td></tr><tr><td class="h">813</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">814</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L814">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uowner = $flags-&gt;{&#39;u_owner&#39;} || $u;</td></tr>
<tr><td class="h">815</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ownerid = $flags-&gt;{&#39;ownerid&#39;};</td></tr>
<tr><td class="h">816</td><td colspan="7"></td></tr><tr><td class="h">817</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">818</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $daycts = LJ::get_daycounts($uowner, $u);</td></tr>
<tr><td class="h">819</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L819">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,502) unless $daycts;</td></tr>
<tr><td class="h">820</td><td colspan="7"></td></tr><tr><td class="h">821</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $day (@$daycts) {</td></tr>
<tr><td class="h">822</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $date = sprintf(&quot;%04d-%02d-%02d&quot;, $day-&gt;[0], $day-&gt;[1], $day-&gt;[2]);</td></tr>
<tr><td class="h">823</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$res-&gt;{&#39;daycounts&#39;}}, { &#39;date&#39; =&gt; $date, &#39;count&#39; =&gt; $day-&gt;[3] };</td></tr>
<tr><td class="h">824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">825</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">827</td><td colspan="7"></td></tr><tr><td class="h">828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub common_event_validation</td></tr>
<tr><td class="h">829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">830</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L830">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">831</td><td colspan="7"></td></tr><tr><td class="h">832</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# clean up event whitespace</td></tr>
<tr><td class="h">833</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove surrounding whitespace</td></tr>
<tr><td class="h">834</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{event} =~ s/^\s+//;</td></tr>
<tr><td class="h">835</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{event} =~ s/\s+$//;</td></tr>
<tr><td class="h">836</td><td colspan="7"></td></tr><tr><td class="h">837</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# convert line endings to unix format</td></tr>
<tr><td class="h">838</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L838">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;lineendings&#39;} eq &quot;mac&quot;) {</td></tr>
<tr><td class="h">839</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{event} =~ s/\r/\n/g;</td></tr>
<tr><td class="h">840</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">841</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{event} =~ s/\r//g;</td></tr>
<tr><td class="h">842</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">843</td><td colspan="7"></td></tr><tr><td class="h">844</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# date validation</td></tr>
<tr><td class="h">845</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L845">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L845">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;year&#39;} !~ /^\d\d\d\d$/ ||</td></tr>
<tr><td class="h">846</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;year&#39;} &lt; 1970 ||    # before unix time started = bad</td></tr>
<tr><td class="h">847</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;year&#39;} &gt; 2037)      # after unix time ends = worse!  :)</td></tr>
<tr><td class="h">848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">849</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Invalid year value (must be in the range 1970-2037).&quot;);</td></tr>
<tr><td class="h">850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">851</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L851">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L851">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mon&#39;} !~ /^\d{1,2}$/ ||</td></tr>
<tr><td class="h">852</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;mon&#39;} &lt; 1 ||</td></tr>
<tr><td class="h">853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;mon&#39;} &gt; 12)</td></tr>
<tr><td class="h">854</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">855</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Invalid month value.&quot;);</td></tr>
<tr><td class="h">856</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">857</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L857">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L857">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;day&#39;} !~ /^\d{1,2}$/ || $req-&gt;{&#39;day&#39;} &lt; 1 ||</td></tr>
<tr><td class="h">858</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;day&#39;} &gt; LJ::days_in_month($req-&gt;{&#39;mon&#39;},</td></tr>
<tr><td class="h">859</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;year&#39;}))</td></tr>
<tr><td class="h">860</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">861</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Invalid day of month value.&quot;);</td></tr>
<tr><td class="h">862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">863</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L863">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L863">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;hour&#39;} !~ /^\d{1,2}$/ ||</td></tr>
<tr><td class="h">864</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;hour&#39;} &lt; 0 || $req-&gt;{&#39;hour&#39;} &gt; 23)</td></tr>
<tr><td class="h">865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">866</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Invalid hour value.&quot;);</td></tr>
<tr><td class="h">867</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">868</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L868">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L868">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;min&#39;} !~ /^\d{1,2}$/ ||</td></tr>
<tr><td class="h">869</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;min&#39;} &lt; 0 || $req-&gt;{&#39;min&#39;} &gt; 59)</td></tr>
<tr><td class="h">870</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">871</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Invalid minute value.&quot;);</td></tr>
<tr><td class="h">872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">873</td><td colspan="7"></td></tr><tr><td class="h">874</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# column width</td></tr>
<tr><td class="h">875</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we only trim Unicode data</td></tr>
<tr><td class="h">876</td><td colspan="7"></td></tr><tr><td class="h">877</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L877">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;ver&#39;} &gt;=1 ) {</td></tr>
<tr><td class="h">878</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;subject&#39;} = LJ::text_trim($req-&gt;{&#39;subject&#39;}, LJ::BMAX_SUBJECT, LJ::CMAX_SUBJECT);</td></tr>
<tr><td class="h">879</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;event&#39;} = LJ::text_trim($req-&gt;{&#39;event&#39;}, LJ::BMAX_EVENT, LJ::CMAX_EVENT);</td></tr>
<tr><td class="h">880</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %{$req-&gt;{&#39;props&#39;}}) {</td></tr>
<tr><td class="h">881</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# do not trim this property, as it&#39;s magical and handled later</td></tr>
<tr><td class="h">882</td><td><div class="c3">5</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L882">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $_ eq &#39;taglist&#39;;</td></tr>
<tr><td class="h">883</td><td colspan="7"></td></tr><tr><td class="h">884</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Allow syn_links and syn_ids the full width of the prop, to avoid truncating long URLS</td></tr>
<tr><td class="h">885</td><td><div class="c3">4</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L885">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L885">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($_ eq &#39;syn_link&#39; || $_ eq &#39;syn_id&#39;) {</td></tr>
<tr><td class="h">886</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;props&#39;}-&gt;{$_} = LJ::text_trim($req-&gt;{&#39;props&#39;}-&gt;{$_}, LJ::BMAX_PROP);</td></tr>
<tr><td class="h">887</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">888</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;props&#39;}-&gt;{$_} = LJ::text_trim($req-&gt;{&#39;props&#39;}-&gt;{$_}, LJ::BMAX_PROP, LJ::CMAX_PROP);</td></tr>
<tr><td class="h">889</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">890</td><td colspan="7"></td></tr><tr><td class="h">891</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">892</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">893</td><td colspan="7"></td></tr><tr><td class="h">894</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# setup non-user meta-data.  it&#39;s important we define this here to</td></tr>
<tr><td class="h">895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# 0.  if it&#39;s not defined at all, then an editevent where a user</td></tr>
<tr><td class="h">896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# removes random 8bit data won&#39;t remove the metadata.  not that</td></tr>
<tr><td class="h">897</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# that matters much.  but having this here won&#39;t hurt.  false</td></tr>
<tr><td class="h">898</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# meta-data isn&#39;t saved anyway.  so the only point of this next</td></tr>
<tr><td class="h">899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# line is making the metadata be deleted on edit.</td></tr>
<tr><td class="h">900</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;props&#39;}-&gt;{&#39;unknown8bit&#39;} = 0;</td></tr>
<tr><td class="h">901</td><td colspan="7"></td></tr><tr><td class="h">902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we don&#39;t want attackers sending something that looks like gzipped data</td></tr>
<tr><td class="h">903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# in protocol version 0 (unknown8bit allowed), otherwise they might</td></tr>
<tr><td class="h">904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# inject a 100MB string of single letters in a few bytes.</td></tr>
<tr><td class="h">905</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L905">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,208,&quot;Cannot send gzipped data&quot;)</td></tr>
<tr><td class="h">906</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if substr($req-&gt;{&#39;event&#39;},0,2) eq &quot;\037\213&quot;;</td></tr>
<tr><td class="h">907</td><td colspan="7"></td></tr><tr><td class="h">908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# non-ASCII?</td></tr>
<tr><td class="h">909</td><td><div class="c3">34</div><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L909">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L909">20</a></div></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $flags-&gt;{&#39;use_old_content&#39;} || (</td></tr>
<tr><td class="h">910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::is_ascii($req-&gt;{&#39;event&#39;}) &amp;&amp;</td></tr>
<tr><td class="h">911</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::is_ascii($req-&gt;{&#39;subject&#39;}) &amp;&amp;</td></tr>
<tr><td class="h">912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::is_ascii(join(&#39; &#39;, values %{$req-&gt;{&#39;props&#39;}})) ))</td></tr>
<tr><td class="h">913</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">914</td><td colspan="7"></td></tr><tr><td class="h">915</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L915">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;ver&#39;} &lt; 1) { # client doesn&#39;t support Unicode</td></tr>
<tr><td class="h">916</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# only people should have unknown8bit entries.</td></tr>
<tr><td class="h">917</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L917">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $uowner = $flags-&gt;{u_owner} || $flags-&gt;{u};</td></tr>
<tr><td class="h">918</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L918">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,207,&#39;Posting in a community with international or special characters require a Unicode-capable LiveJournal client.  Download one at http://www.livejournal.com/download/.&#39;)</td></tr>
<tr><td class="h">919</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ! $uowner-&gt;is_person;</td></tr>
<tr><td class="h">920</td><td colspan="7"></td></tr><tr><td class="h">921</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# so rest of site can change chars to ? marks until</td></tr>
<tr><td class="h">922</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# default user&#39;s encoding is set.  (legacy support)</td></tr>
<tr><td class="h">923</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;props&#39;}-&gt;{&#39;unknown8bit&#39;} = 1;</td></tr>
<tr><td class="h">924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">925</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L925">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,207, &quot;This installation does not support Unicode clients&quot;) unless $LJ::UNICODE;</td></tr>
<tr><td class="h">926</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# validate that the text is valid UTF-8</td></tr>
<tr><td class="h">927</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L927">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L927">0</a></div></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!LJ::text_in($req-&gt;{&#39;subject&#39;}) ||</td></tr>
<tr><td class="h">928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!LJ::text_in($req-&gt;{&#39;event&#39;}) ||</td></tr>
<tr><td class="h">929</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { !LJ::text_in($_) } values %{$req-&gt;{&#39;props&#39;}}) {</td></tr>
<tr><td class="h">930</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 208, &quot;The text entered is not a valid UTF-8 stream&quot;);</td></tr>
<tr><td class="h">931</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">932</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">933</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">934</td><td colspan="7"></td></tr><tr><td class="h">935</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## handle meta-data (properties)</td></tr>
<tr><td class="h">936</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_props(&quot;log&quot;);</td></tr>
<tr><td class="h">937</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $pname (keys %{$req-&gt;{&#39;props&#39;}})</td></tr>
<tr><td class="h">938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">939</td><td><div class="c3">39</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;log&quot;, $pname);</td></tr>
<tr><td class="h">940</td><td colspan="7"></td></tr><tr><td class="h">941</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# does the property even exist?</td></tr>
<tr><td class="h">942</td><td><div class="c3">39</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L942">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($p) {</td></tr>
<tr><td class="h">943</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pname =~ s/[^\w]//g;</td></tr>
<tr><td class="h">944</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,205,$pname);</td></tr>
<tr><td class="h">945</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">946</td><td colspan="7"></td></tr><tr><td class="h">947</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# This is a system logprop</td></tr>
<tr><td class="h">948</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fail with unknown metadata here?</td></tr>
<tr><td class="h">949</td><td><div class="c3">39</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L949">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $p-&gt;{ownership} eq &#39;system&#39; ) {</td></tr>
<tr><td class="h">950</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pname =~ s/[^\w]//g;</td></tr>
<tr><td class="h">951</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,205,$pname);</td></tr>
<tr><td class="h">952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">953</td><td colspan="7"></td></tr><tr><td class="h">954</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t validate its type if it&#39;s 0 or undef (deleting)</td></tr>
<tr><td class="h">955</td><td><div class="c3">39</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L955">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless ($req-&gt;{&#39;props&#39;}-&gt;{$pname});</td></tr>
<tr><td class="h">956</td><td colspan="7"></td></tr><tr><td class="h">957</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ptype = $p-&gt;{&#39;datatype&#39;};</td></tr>
<tr><td class="h">958</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $val = $req-&gt;{&#39;props&#39;}-&gt;{$pname};</td></tr>
<tr><td class="h">959</td><td colspan="7"></td></tr><tr><td class="h">960</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L960">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L960">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($ptype eq &quot;bool&quot; &amp;&amp; $val !~ /^[01]$/) {</td></tr>
<tr><td class="h">961</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,204,&quot;Property \&quot;$pname\&quot; should be 0 or 1&quot;);</td></tr>
<tr><td class="h">962</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">963</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L963">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L963">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($ptype eq &quot;num&quot; &amp;&amp; $val =~ /[^\d]/) {</td></tr>
<tr><td class="h">964</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,204,&quot;Property \&quot;$pname\&quot; should be numeric&quot;);</td></tr>
<tr><td class="h">965</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">966</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L966">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L966">0</a></div></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($pname eq &quot;current_coords&quot; &amp;&amp; ! eval { LJ::Location-&gt;new(coords =&gt; $val) }) {</td></tr>
<tr><td class="h">967</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,204,&quot;Property \&quot;current_coords\&quot; has invalid value&quot;);</td></tr>
<tr><td class="h">968</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">969</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">970</td><td colspan="7"></td></tr><tr><td class="h">971</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check props for inactive userpic</td></tr>
<tr><td class="h">972</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L972">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L972">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( ( my $pickwd = $req-&gt;{&#39;props&#39;}-&gt;{&#39;picture_keyword&#39;} ) and !$flags-&gt;{allow_inactive}) {</td></tr>
<tr><td class="h">973</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pic = LJ::get_pic_from_keyword($flags-&gt;{&#39;u&#39;}, $pickwd);</td></tr>
<tr><td class="h">974</td><td colspan="7"></td></tr><tr><td class="h">975</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# need to make sure they aren&#39;t trying to post with an inactive keyword, but also</td></tr>
<tr><td class="h">976</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we don&#39;t want to allow them to post with a keyword that has no pic at all to prevent</td></tr>
<tr><td class="h">977</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# them from deleting the keyword, posting, then adding it back with editpics.bml</td></tr>
<tr><td class="h">978</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L978">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L978">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $req-&gt;{&#39;props&#39;}-&gt;{&#39;picture_keyword&#39;} if ! $pic || $pic-&gt;{&#39;state&#39;} eq &#39;I&#39;;</td></tr>
<tr><td class="h">979</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">980</td><td colspan="7"></td></tr><tr><td class="h">981</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# validate incoming list of tags</td></tr>
<tr><td class="h">982</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L982">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L982">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 211)</td></tr>
<tr><td class="h">983</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $req-&gt;{props}-&gt;{taglist} &amp;&amp;</td></tr>
<tr><td class="h">984</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;! LJ::Tags::is_valid_tagstring($req-&gt;{props}-&gt;{taglist});</td></tr>
<tr><td class="h">985</td><td colspan="7"></td></tr><tr><td class="h">986</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">987</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">988</td><td colspan="7"></td></tr><tr><td class="h">989</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub postevent</td></tr>
<tr><td class="h">990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">991</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L991">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">992</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;un_utf8_request($req);</td></tr>
<tr><td class="h">993</td><td colspan="7"></td></tr><tr><td class="h">994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if the importer is calling us, we want to allow it to post in all but the most extreme</td></tr>
<tr><td class="h">995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# of cases.  and even then, we try our hardest to allow content to be posted.  setting this</td></tr>
<tr><td class="h">996</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# flag will bypass a lot of the safety restrictions about who can post where and when, so</td></tr>
<tr><td class="h">997</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we trust the importer to be intelligent about this.  (And if you aren&#39;t the importer, don&#39;t</td></tr>
<tr><td class="h">998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# use this option!!!)</td></tr>
<tr><td class="h">999</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L999">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $importer_bypass = $flags-&gt;{importer_bypass} ? 1 : 0;</td></tr>
<tr><td class="h">1000</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1000">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $importer_bypass ) {</td></tr>
<tr><td class="h">1001</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{nomod} = 1;</td></tr>
<tr><td class="h">1002</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{ignore_tags_max} = 1;</td></tr>
<tr><td class="h">1003</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{nonotify} = 1;</td></tr>
<tr><td class="h">1004</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{noauth} = 1;</td></tr>
<tr><td class="h">1005</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{usejournal_okay} = 1;</td></tr>
<tr><td class="h">1006</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1007</td><td colspan="7"></td></tr><tr><td class="h">1008</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1008">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1008">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::run_hook(&#39;post_noauth&#39;, $req) || authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">1009</td><td colspan="7"></td></tr><tr><td class="h">1010</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if going through mod queue, then we know they&#39;re permitted to post at least this entry</td></tr>
<tr><td class="h">1011</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1011">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1011">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless check_altusage($req, $err, $flags) || $flags-&gt;{nomod};</td></tr>
<tr><td class="h">1012</td><td colspan="7"></td></tr><tr><td class="h">1013</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">1014</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ownerid = $flags-&gt;{&#39;ownerid&#39;}+0;</td></tr>
<tr><td class="h">1015</td><td><div class="c3">34</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1015">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uowner = $flags-&gt;{&#39;u_owner&#39;} || $u;</td></tr>
<tr><td class="h">1016</td><td colspan="7"></td></tr><tr><td class="h">1017</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Make sure we have a real user object here</td></tr>
<tr><td class="h">1018</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1018">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$uowner = LJ::want_user($uowner) unless LJ::isu($uowner);</td></tr>
<tr><td class="h">1019</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $clusterid = $uowner-&gt;{&#39;clusterid&#39;};</td></tr>
<tr><td class="h">1020</td><td colspan="7"></td></tr><tr><td class="h">1021</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">1022</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = LJ::get_cluster_master($uowner);</td></tr>
<tr><td class="h">1023</td><td colspan="7"></td></tr><tr><td class="h">1024</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1024">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1024">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,306) unless $dbh &amp;&amp; $dbcm &amp;&amp; $uowner-&gt;writer;</td></tr>
<tr><td class="h">1025</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1025">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,200) unless $req-&gt;{&#39;event&#39;} =~ /\S/;</td></tr>
<tr><td class="h">1026</td><td colspan="7"></td></tr><tr><td class="h">1027</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### make sure community or identity journals don&#39;t post</td></tr>
<tr><td class="h">1028</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1028">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,150) if $u-&gt;is_community;</td></tr>
<tr><td class="h">1029</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1029">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1029">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,150) if ! $importer_bypass &amp;&amp; $u-&gt;is_identity;</td></tr>
<tr><td class="h">1030</td><td colspan="7"></td></tr><tr><td class="h">1031</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# suspended users can&#39;t post</td></tr>
<tr><td class="h">1032</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1032">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1032">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,305) if ! $importer_bypass &amp;&amp; $u-&gt;is_suspended;</td></tr>
<tr><td class="h">1033</td><td colspan="7"></td></tr><tr><td class="h">1034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# memorials can&#39;t post</td></tr>
<tr><td class="h">1035</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1035">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1035">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,309) if ! $importer_bypass &amp;&amp; $u-&gt;is_memorial;</td></tr>
<tr><td class="h">1036</td><td colspan="7"></td></tr><tr><td class="h">1037</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# locked accounts can&#39;t post</td></tr>
<tr><td class="h">1038</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1038">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1038">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,308) if ! $importer_bypass &amp;&amp; $u-&gt;is_locked;</td></tr>
<tr><td class="h">1039</td><td colspan="7"></td></tr><tr><td class="h">1040</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check the journal&#39;s read-only bit</td></tr>
<tr><td class="h">1041</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1041">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,306) if LJ::get_cap($uowner, &quot;readonly&quot;);</td></tr>
<tr><td class="h">1042</td><td colspan="7"></td></tr><tr><td class="h">1043</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# is the user allowed to post?</td></tr>
<tr><td class="h">1044</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1044">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1044">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,404,$LJ::MSG_NO_POST) unless $importer_bypass || LJ::get_cap($u, &quot;can_post&quot;);</td></tr>
<tr><td class="h">1045</td><td colspan="7"></td></tr><tr><td class="h">1046</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# is the user allowed to post?</td></tr>
<tr><td class="h">1047</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1047">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,410) if LJ::get_cap($u, &quot;disable_can_post&quot;);</td></tr>
<tr><td class="h">1048</td><td colspan="7"></td></tr><tr><td class="h">1049</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# read-only accounts can&#39;t post</td></tr>
<tr><td class="h">1050</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1050">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,316) if $u-&gt;is_readonly;</td></tr>
<tr><td class="h">1051</td><td colspan="7"></td></tr><tr><td class="h">1052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# read-only accounts can&#39;t be posted to</td></tr>
<tr><td class="h">1053</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1053">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,317) if $uowner-&gt;is_readonly;</td></tr>
<tr><td class="h">1054</td><td colspan="7"></td></tr><tr><td class="h">1055</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t post to deleted/suspended community</td></tr>
<tr><td class="h">1056</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1056">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1056">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,307) unless $importer_bypass || $uowner-&gt;is_visible;</td></tr>
<tr><td class="h">1057</td><td colspan="7"></td></tr><tr><td class="h">1058</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# must have a validated email address to post to a community</td></tr>
<tr><td class="h">1059</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# unless this is approved from the mod queue (we&#39;ll error out initially, but in case they change later)</td></tr>
<tr><td class="h">1060</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1060">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1060">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 155, &quot;You must have an authenticated email address in order to post to another account&quot;)</td></tr>
<tr><td class="h">1061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::u_equals($u, $uowner) || $u-&gt;{&#39;status&#39;} eq &#39;A&#39; || $flags-&gt;{&#39;nomod&#39;};</td></tr>
<tr><td class="h">1062</td><td colspan="7"></td></tr><tr><td class="h">1063</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# post content too large</td></tr>
<tr><td class="h">1064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# NOTE: requires $req-&gt;{event} be binary data, but we&#39;ve already</td></tr>
<tr><td class="h">1065</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# removed the utf-8 flag in the XML-RPC path, and it never gets</td></tr>
<tr><td class="h">1066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set in the &quot;flat&quot; protocol path.</td></tr>
<tr><td class="h">1067</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1067">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,409) if length($req-&gt;{&#39;event&#39;}) &gt;= LJ::BMAX_EVENT;</td></tr>
<tr><td class="h">1068</td><td colspan="7"></td></tr><tr><td class="h">1069</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $time_was_faked = 0;</td></tr>
<tr><td class="h">1070</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $offset = 0;  # assume gmt at first.</td></tr>
<tr><td class="h">1071</td><td colspan="7"></td></tr><tr><td class="h">1072</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1072">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $req-&gt;{&#39;tz&#39;}) {</td></tr>
<tr><td class="h">1073</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1073">50</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1073">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{tz} eq &#39;guess&#39;) {</td></tr>
<tr><td class="h">1074</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::get_timezone($u, \$offset, \$time_was_faked);</td></tr>
<tr><td class="h">1075</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($req-&gt;{&#39;tz&#39;} =~ /^[+\-]\d\d\d\d$/) {</td></tr>
<tr><td class="h">1076</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# FIXME we ought to store this timezone and make use of it somehow.</td></tr>
<tr><td class="h">1077</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$offset = $req-&gt;{&#39;tz&#39;} / 100.0;</td></tr>
<tr><td class="h">1078</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1079</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 203, &quot;Invalid tz&quot;);</td></tr>
<tr><td class="h">1080</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1082</td><td colspan="7"></td></tr><tr><td class="h">1083</td><td><div class="c3">34</div><div class="c3">170</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1083">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1083">33</a></div></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $req-&gt;{&#39;tz&#39;} and not grep { defined $req-&gt;{$_} } qw(year mon day hour min)) {</td></tr>
<tr><td class="h">1084</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @ltime = gmtime(time() + ($offset*3600));</td></tr>
<tr><td class="h">1085</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;year&#39;} = $ltime[5]+1900;</td></tr>
<tr><td class="h">1086</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;mon&#39;}  = $ltime[4]+1;</td></tr>
<tr><td class="h">1087</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;day&#39;}  = $ltime[3];</td></tr>
<tr><td class="h">1088</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;hour&#39;} = $ltime[2];</td></tr>
<tr><td class="h">1089</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;min&#39;}  = $ltime[1];</td></tr>
<tr><td class="h">1090</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$time_was_faked = 1;</td></tr>
<tr><td class="h">1091</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1092</td><td colspan="7"></td></tr><tr><td class="h">1093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef</td></tr>
<tr><td class="h">1094</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1094">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless common_event_validation($req, $err, $flags);</td></tr>
<tr><td class="h">1095</td><td colspan="7"></td></tr><tr><td class="h">1096</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# confirm we can add tags, at least</td></tr>
<tr><td class="h">1097</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1097">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1097">0</a></div><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1097">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 312)</td></tr>
<tr><td class="h">1098</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $req-&gt;{props} &amp;&amp; $req-&gt;{props}-&gt;{taglist} &amp;&amp;</td></tr>
<tr><td class="h">1099</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;! ( $importer_bypass || LJ::Tags::can_add_tags( $uowner, $u ) );</td></tr>
<tr><td class="h">1100</td><td colspan="7"></td></tr><tr><td class="h">1101</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $event = $req-&gt;{&#39;event&#39;};</td></tr>
<tr><td class="h">1102</td><td colspan="7"></td></tr><tr><td class="h">1103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### allow for posting to journals that aren&#39;t yours (if you have permission)</td></tr>
<tr><td class="h">1104</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posterid = $u-&gt;{&#39;userid&#39;}+0;</td></tr>
<tr><td class="h">1105</td><td colspan="7"></td></tr><tr><td class="h">1106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make the proper date format</td></tr>
<tr><td class="h">1107</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $eventtime = sprintf(&quot;%04d-%02d-%02d %02d:%02d&quot;,</td></tr>
<tr><td class="h">1108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;year&#39;}, $req-&gt;{&#39;mon&#39;},</td></tr>
<tr><td class="h">1109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;day&#39;}, $req-&gt;{&#39;hour&#39;},</td></tr>
<tr><td class="h">1110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;min&#39;});</td></tr>
<tr><td class="h">1111</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qeventtime = $dbh-&gt;quote($eventtime);</td></tr>
<tr><td class="h">1112</td><td colspan="7"></td></tr><tr><td class="h">1113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load userprops all at once</td></tr>
<tr><td class="h">1114</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @poster_props = qw(newesteventtime dupsig_post);</td></tr>
<tr><td class="h">1115</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @owner_props = qw(newpost_minsecurity moderated);</td></tr>
<tr><td class="h">1116</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1116">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @owner_props, &#39;opt_weblogscom&#39; unless $req-&gt;{&#39;props&#39;}-&gt;{&#39;opt_backdated&#39;};</td></tr>
<tr><td class="h">1117</td><td colspan="7"></td></tr><tr><td class="h">1118</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($u, @poster_props, @owner_props);</td></tr>
<tr><td class="h">1119</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1119">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($uowner-&gt;{&#39;userid&#39;} == $u-&gt;{&#39;userid&#39;}) {</td></tr>
<tr><td class="h">1120</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;{$_} = $u-&gt;{$_} foreach (@owner_props);</td></tr>
<tr><td class="h">1121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1122</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($uowner, @owner_props);</td></tr>
<tr><td class="h">1123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1124</td><td colspan="7"></td></tr><tr><td class="h">1125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# are they trying to post back in time?</td></tr>
<tr><td class="h">1126</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1126">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1126">14</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($posterid == $ownerid &amp;&amp; !$u-&gt;is_syndicated &amp;&amp;</td></tr>
<tr><td class="h">1127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$time_was_faked &amp;&amp; $u-&gt;{&#39;newesteventtime&#39;} &amp;&amp;</td></tr>
<tr><td class="h">1128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$eventtime lt $u-&gt;{&#39;newesteventtime&#39;} &amp;&amp;</td></tr>
<tr><td class="h">1129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$req-&gt;{&#39;props&#39;}-&gt;{&#39;opt_backdated&#39;}) {</td></tr>
<tr><td class="h">1130</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 153, &quot;You have an entry which was posted at $u-&gt;{&#39;newesteventtime&#39;}, but you&#39;re trying to post an entry before this. Please check the date and time of both entries. If the other entry is set in the future on purpose, edit that entry to use the \&quot;Date Out of Order\&quot; option. Otherwise, use the \&quot;Date Out of Order\&quot; option for this entry instead.&quot;);</td></tr>
<tr><td class="h">1131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1132</td><td colspan="7"></td></tr><tr><td class="h">1133</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qallowmask = $req-&gt;{&#39;allowmask&#39;}+0;</td></tr>
<tr><td class="h">1134</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $security = &quot;public&quot;;</td></tr>
<tr><td class="h">1135</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uselogsec = 0;</td></tr>
<tr><td class="h">1136</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1136">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1136">33</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;security&#39;} eq &quot;usemask&quot; || $req-&gt;{&#39;security&#39;} eq &quot;private&quot;) {</td></tr>
<tr><td class="h">1137</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$security = $req-&gt;{&#39;security&#39;};</td></tr>
<tr><td class="h">1138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1139</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1139">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;security&#39;} eq &quot;usemask&quot;) {</td></tr>
<tr><td class="h">1140</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uselogsec = 1;</td></tr>
<tr><td class="h">1141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1142</td><td colspan="7"></td></tr><tr><td class="h">1143</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t specify both a custom security and &#39;friends-only&#39;</td></tr>
<tr><td class="h">1144</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1144">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1144">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 203, &quot;Invalid friends group security set&quot;)</td></tr>
<tr><td class="h">1145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $qallowmask &gt; 1 &amp;&amp; $qallowmask % 2;</td></tr>
<tr><td class="h">1146</td><td colspan="7"></td></tr><tr><td class="h">1147</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## if newpost_minsecurity is set, new entries have to be</td></tr>
<tr><td class="h">1148</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## a minimum security level</td></tr>
<tr><td class="h">1149</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1149">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$security = &quot;private&quot;</td></tr>
<tr><td class="h">1150</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $uowner-&gt;{&#39;newpost_minsecurity&#39;} eq &quot;private&quot;;</td></tr>
<tr><td class="h">1151</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1151">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1151">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;($security, $qallowmask) = (&quot;usemask&quot;, 1)</td></tr>
<tr><td class="h">1152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $uowner-&gt;{&#39;newpost_minsecurity&#39;} eq &quot;friends&quot;</td></tr>
<tr><td class="h">1153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and $security eq &quot;public&quot;;</td></tr>
<tr><td class="h">1154</td><td colspan="7"></td></tr><tr><td class="h">1155</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qsecurity = $dbh-&gt;quote($security);</td></tr>
<tr><td class="h">1156</td><td colspan="7"></td></tr><tr><td class="h">1157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### make sure user can&#39;t post with &quot;custom/private security&quot; on shared journals</td></tr>
<tr><td class="h">1158</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1158">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1158">20</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,102)</td></tr>
<tr><td class="h">1159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($ownerid != $posterid &amp;&amp; # community post</td></tr>
<tr><td class="h">1160</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($req-&gt;{&#39;security&#39;} eq &quot;private&quot; ||</td></tr>
<tr><td class="h">1161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($req-&gt;{&#39;security&#39;} eq &quot;usemask&quot; &amp;&amp; $qallowmask != 1 )));</td></tr>
<tr><td class="h">1162</td><td colspan="7"></td></tr><tr><td class="h">1163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make sure this user isn&#39;t banned from posting here (if</td></tr>
<tr><td class="h">1164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# this is a community journal)</td></tr>
<tr><td class="h">1165</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1165">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,151) if</td></tr>
<tr><td class="h">1166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::is_banned($posterid, $ownerid);</td></tr>
<tr><td class="h">1167</td><td colspan="7"></td></tr><tr><td class="h">1168</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t allow backdated posts in communities</td></tr>
<tr><td class="h">1169</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1169">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1169">33</a></div><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1169">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,152) if</td></tr>
<tr><td class="h">1170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $req-&gt;{props}-&gt;{opt_backdated} &amp;&amp;</td></tr>
<tr><td class="h">1171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;! ( $importer_bypass || $uowner-&gt;is_person ) );</td></tr>
<tr><td class="h">1172</td><td colspan="7"></td></tr><tr><td class="h">1173</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do processing of embedded polls (doesn&#39;t add to database, just</td></tr>
<tr><td class="h">1174</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# does validity checking)</td></tr>
<tr><td class="h">1175</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @polls = ();</td></tr>
<tr><td class="h">1176</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1176">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::Poll-&gt;contains_new_poll(\$event))</td></tr>
<tr><td class="h">1177</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1178</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1178">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1178">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,301,&quot;Your account type doesn&#39;t permit creating polls.&quot;)</td></tr>
<tr><td class="h">1179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless (LJ::get_cap($u, &quot;makepoll&quot;)</td></tr>
<tr><td class="h">1180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| ($uowner-&gt;is_community</td></tr>
<tr><td class="h">1181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; LJ::get_cap($uowner, &quot;makepoll&quot;)));</td></tr>
<tr><td class="h">1182</td><td colspan="7"></td></tr><tr><td class="h">1183</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $error = &quot;&quot;;</td></tr>
<tr><td class="h">1184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@polls = LJ::Poll-&gt;new_from_html(\$event, \$error, {</td></tr>
<tr><td class="h">1185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;journalid&#39; =&gt; $ownerid,</td></tr>
<tr><td class="h">1186</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;posterid&#39; =&gt; $posterid,</td></tr>
<tr><td class="h">1187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">1188</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1188">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,103,$error) if $error;</td></tr>
<tr><td class="h">1189</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1190</td><td colspan="7"></td></tr><tr><td class="h">1191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# convert RTE lj-embeds to normal lj-embeds</td></tr>
<tr><td class="h">1192</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$event = LJ::EmbedModule-&gt;transform_rte_post($event);</td></tr>
<tr><td class="h">1193</td><td colspan="7"></td></tr><tr><td class="h">1194</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# process module embedding</td></tr>
<tr><td class="h">1195</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::EmbedModule-&gt;parse_module_embed($uowner, \$event);</td></tr>
<tr><td class="h">1196</td><td colspan="7"></td></tr><tr><td class="h">1197</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now = $dbcm-&gt;selectrow_array(&quot;SELECT UNIX_TIMESTAMP()&quot;);</td></tr>
<tr><td class="h">1198</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $anum  = int(rand(256));</td></tr>
<tr><td class="h">1199</td><td colspan="7"></td></tr><tr><td class="h">1200</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# by default we record the true reverse time that the item was entered.</td></tr>
<tr><td class="h">1201</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# however, if backdate is on, we put the reverse time at the end of time</td></tr>
<tr><td class="h">1202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# (which makes it equivalent to 1969, but get_recent_items will never load</td></tr>
<tr><td class="h">1203</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# it... where clause there is: &lt; $LJ::EndOfTime).  but this way we can</td></tr>
<tr><td class="h">1204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# have entries that don&#39;t show up on friends view, now that we don&#39;t have</td></tr>
<tr><td class="h">1205</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the hints table to not insert into.</td></tr>
<tr><td class="h">1206</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rlogtime = $LJ::EndOfTime;</td></tr>
<tr><td class="h">1207</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1207">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($req-&gt;{&#39;props&#39;}-&gt;{&quot;opt_backdated&quot;}) {</td></tr>
<tr><td class="h">1208</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rlogtime -= $now;</td></tr>
<tr><td class="h">1209</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1210</td><td colspan="7"></td></tr><tr><td class="h">1211</td><td><div class="c3">34</div><div class="c3">170</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dupsig = Digest::MD5::md5_hex(join(&#39;&#39;, map { $req-&gt;{$_} }</td></tr>
<tr><td class="h">1212</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qw(subject event usejournal security allowmask)));</td></tr>
<tr><td class="h">1213</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lock_key = &quot;post-$ownerid&quot;;</td></tr>
<tr><td class="h">1214</td><td colspan="7"></td></tr><tr><td class="h">1215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# release our duplicate lock</td></tr>
<tr><td class="h">1216</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L1216">34</a></div></td><td></td><td><div>4000</div><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $release = sub {  $dbcm-&gt;do(&quot;SELECT RELEASE_LOCK(?)&quot;, undef, $lock_key); };</td></tr>
<tr><td class="h">1217</td><td colspan="7"></td></tr><tr><td class="h">1218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# our own local version of fail that releases our lock first</td></tr>
<tr><td class="h">1219</td><td><div class="c3">34</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L1219">0</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $fail = sub { $release-&gt;(); return fail(@_); };</td></tr>
<tr><td class="h">1220</td><td colspan="7"></td></tr><tr><td class="h">1221</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">1222</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res_done = 0;  # set true by getlock when post was duplicate, or error getting lock</td></tr>
<tr><td class="h">1223</td><td colspan="7"></td></tr><tr><td class="h">1224</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $getlock = sub {</td></tr>
<tr><td class="h">1225</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L1225">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $r = $dbcm-&gt;selectrow_array(&quot;SELECT GET_LOCK(?, 2)&quot;, undef, $lock_key);</td></tr>
<tr><td class="h">1226</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1226">50</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($r) {</td></tr>
<tr><td class="h">1227</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res = undef;    # a failure case has an undef result</td></tr>
<tr><td class="h">1228</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail($err,503);  # set error flag to &quot;can&#39;t get lock&quot;;</td></tr>
<tr><td class="h">1229</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res_done = 1;   # tell caller to bail out</td></tr>
<tr><td class="h">1230</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">1231</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1232</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @parts = split(/:/, $u-&gt;{&#39;dupsig_post&#39;});</td></tr>
<tr><td class="h">1233</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1233">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($parts[0] eq $dupsig) {</td></tr>
<tr><td class="h">1234</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# duplicate!  let&#39;s make the client think this was just the</td></tr>
<tr><td class="h">1235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# normal first response.</td></tr>
<tr><td class="h">1236</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;itemid&#39;} = $parts[1];</td></tr>
<tr><td class="h">1237</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;anum&#39;} = $parts[2];</td></tr>
<tr><td class="h">1238</td><td colspan="7"></td></tr><tr><td class="h">1239</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dup_entry = LJ::Entry-&gt;new($uowner, jitemid =&gt; $res-&gt;{&#39;itemid&#39;}, anum =&gt; $res-&gt;{&#39;anum&#39;});</td></tr>
<tr><td class="h">1240</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;url&#39;} = $dup_entry-&gt;url;</td></tr>
<tr><td class="h">1241</td><td colspan="7"></td></tr><tr><td class="h">1242</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res_done = 1;</td></tr>
<tr><td class="h">1243</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$release-&gt;();</td></tr>
<tr><td class="h">1244</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1245</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1246</td><td colspan="7"></td></tr><tr><td class="h">1247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if posting to a moderated community, store and bail out here</td></tr>
<tr><td class="h">1248</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1248">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1248">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($uowner-&gt;is_community &amp;&amp; $uowner-&gt;{&#39;moderated&#39;} &amp;&amp; !$flags-&gt;{&#39;nomod&#39;}) {</td></tr>
<tr><td class="h">1249</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t moderate admins, moderators &amp; pre-approved users</td></tr>
<tr><td class="h">1250</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">1251</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $relcount = $dbh-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM reluser &quot;.</td></tr>
<tr><td class="h">1252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid=$ownerid AND targetid=$posterid &quot;.</td></tr>
<tr><td class="h">1253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND type IN (&#39;A&#39;,&#39;M&#39;,&#39;N&#39;)&quot;);</td></tr>
<tr><td class="h">1254</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1254">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($relcount) {</td></tr>
<tr><td class="h">1255</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# moderation queue full?</td></tr>
<tr><td class="h">1256</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $modcount = $dbcm-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM modlog WHERE journalid=$ownerid&quot;);</td></tr>
<tr><td class="h">1257</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1257">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 407) if $modcount &gt;= LJ::get_cap($uowner, &quot;mod_queue&quot;);</td></tr>
<tr><td class="h">1258</td><td colspan="7"></td></tr><tr><td class="h">1259</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$modcount = $dbcm-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM modlog &quot;.</td></tr>
<tr><td class="h">1260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$ownerid AND posterid=$posterid&quot;);</td></tr>
<tr><td class="h">1261</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1261">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 408) if $modcount &gt;= LJ::get_cap($uowner, &quot;mod_queue_per_poster&quot;);</td></tr>
<tr><td class="h">1262</td><td colspan="7"></td></tr><tr><td class="h">1263</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;_moderate&#39;}-&gt;{&#39;authcode&#39;} = LJ::make_auth_code(15);</td></tr>
<tr><td class="h">1264</td><td colspan="7"></td></tr><tr><td class="h">1265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# create tag &lt;lj-embed&gt; from HTML-tag &lt;embed&gt;</td></tr>
<tr><td class="h">1266</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::EmbedModule-&gt;parse_module_embed($uowner, \$req-&gt;{event});</td></tr>
<tr><td class="h">1267</td><td colspan="7"></td></tr><tr><td class="h">1268</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fr = $dbcm-&gt;quote(Storable::freeze($req));</td></tr>
<tr><td class="h">1269</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1269">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 409) if length($fr) &gt; 600_000;</td></tr>
<tr><td class="h">1270</td><td colspan="7"></td></tr><tr><td class="h">1271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# store</td></tr>
<tr><td class="h">1272</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $modid = LJ::alloc_user_counter($uowner, &quot;M&quot;);</td></tr>
<tr><td class="h">1273</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1273">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 501) unless $modid;</td></tr>
<tr><td class="h">1274</td><td colspan="7"></td></tr><tr><td class="h">1275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;do(&quot;INSERT INTO modlog (journalid, modid, posterid, subject, logtime) &quot;.</td></tr>
<tr><td class="h">1276</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES ($ownerid, $modid, $posterid, ?, NOW())&quot;, undef,</td></tr>
<tr><td class="h">1277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_trim($req-&gt;{&#39;subject&#39;}, 30, 0));</td></tr>
<tr><td class="h">1278</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1278">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 501) if $uowner-&gt;err;</td></tr>
<tr><td class="h">1279</td><td colspan="7"></td></tr><tr><td class="h">1280</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;do(&quot;INSERT INTO modblob (journalid, modid, request_stor) &quot;.</td></tr>
<tr><td class="h">1281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES ($ownerid, $modid, $fr)&quot;);</td></tr>
<tr><td class="h">1282</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1282">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($uowner-&gt;err) {</td></tr>
<tr><td class="h">1283</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;do(&quot;DELETE FROM modlog WHERE journalid=$ownerid AND modid=$modid&quot;);</td></tr>
<tr><td class="h">1284</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 501);</td></tr>
<tr><td class="h">1285</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1286</td><td colspan="7"></td></tr><tr><td class="h">1287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# expire mod_queue_count memcache</td></tr>
<tr><td class="h">1288</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;memc_delete( &#39;mqcount&#39; );</td></tr>
<tr><td class="h">1289</td><td colspan="7"></td></tr><tr><td class="h">1290</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# alert moderator(s)</td></tr>
<tr><td class="h">1291</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1291">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mods = LJ::load_rel_user($dbh, $ownerid, &#39;M&#39;) || [];</td></tr>
<tr><td class="h">1292</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1292">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@$mods) {</td></tr>
<tr><td class="h">1293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# load up all these mods and figure out if they want email or not</td></tr>
<tr><td class="h">1294</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $modlist = LJ::load_userids(@$mods);</td></tr>
<tr><td class="h">1295</td><td colspan="7"></td></tr><tr><td class="h">1296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @emails;</td></tr>
<tr><td class="h">1297</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ct;</td></tr>
<tr><td class="h">1298</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $mod (values %$modlist) {</td></tr>
<tr><td class="h">1299</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1299">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $ct &gt; 20;  # don&#39;t send more than 20 emails.</td></tr>
<tr><td class="h">1300</td><td colspan="7"></td></tr><tr><td class="h">1301</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1301">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $mod-&gt;is_visible;</td></tr>
<tr><td class="h">1302</td><td colspan="7"></td></tr><tr><td class="h">1303</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($mod, &#39;opt_nomodemail&#39;);</td></tr>
<tr><td class="h">1304</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1304">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $mod-&gt;{opt_nomodemail};</td></tr>
<tr><td class="h">1305</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1305">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $mod-&gt;{status} ne &quot;A&quot;;</td></tr>
<tr><td class="h">1306</td><td colspan="7"></td></tr><tr><td class="h">1307</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1307">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @emails,</td></tr>
<tr><td class="h">1308</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to          =&gt; $mod-&gt;email_raw,</td></tr>
<tr><td class="h">1310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;browselang  =&gt; $mod-&gt;prop(&#39;browselang&#39;),</td></tr>
<tr><td class="h">1311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;charset     =&gt; $mod-&gt;mailencoding || &#39;utf-8&#39;,</td></tr>
<tr><td class="h">1312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1313</td><td colspan="7"></td></tr><tr><td class="h">1314</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++$ct;</td></tr>
<tr><td class="h">1315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1316</td><td colspan="7"></td></tr><tr><td class="h">1317</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $to (@emails) {</td></tr>
<tr><td class="h">1318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# TODO: html/plain text.</td></tr>
<tr><td class="h">1319</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $body = LJ::Lang::get_text(</td></tr>
<tr><td class="h">1320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$to-&gt;{&#39;browselang&#39;},</td></tr>
<tr><td class="h">1321</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;esn.moderated_submission.body&#39;, undef,</td></tr>
<tr><td class="h">1322</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1323</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user        =&gt; $u-&gt;{&#39;user&#39;},</td></tr>
<tr><td class="h">1324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject     =&gt; $req-&gt;{&#39;subject&#39;},</td></tr>
<tr><td class="h">1325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;community   =&gt; $uowner-&gt;{&#39;user&#39;},</td></tr>
<tr><td class="h">1326</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modid       =&gt; $modid,</td></tr>
<tr><td class="h">1327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;siteroot    =&gt; $LJ::SITEROOT,</td></tr>
<tr><td class="h">1328</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sitename    =&gt; $LJ::SITENAME,</td></tr>
<tr><td class="h">1329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moderateurl =&gt; &quot;$LJ::SITEROOT/community/moderate?authas=$uowner-&gt;{&#39;user&#39;}&amp;modid=$modid&quot;,</td></tr>
<tr><td class="h">1330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewurl     =&gt; &quot;$LJ::SITEROOT/community/moderate?authas=$uowner-&gt;{&#39;user&#39;}&quot;,</td></tr>
<tr><td class="h">1331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">1332</td><td colspan="7"></td></tr><tr><td class="h">1333</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $subject = LJ::Lang::get_text($to-&gt;{&#39;browselang&#39;},&#39;esn.moderated_submission.subject&#39;);</td></tr>
<tr><td class="h">1334</td><td colspan="7"></td></tr><tr><td class="h">1335</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::send_mail({</td></tr>
<tr><td class="h">1336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;to&#39;        =&gt; $to-&gt;{to},</td></tr>
<tr><td class="h">1337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;from&#39;      =&gt; $LJ::ADMIN_EMAIL,</td></tr>
<tr><td class="h">1338</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;charset&#39;   =&gt; $to-&gt;{charset},</td></tr>
<tr><td class="h">1339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;subject&#39;   =&gt; $subject,</td></tr>
<tr><td class="h">1340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;body&#39;      =&gt; $body,</td></tr>
<tr><td class="h">1341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">1342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1344</td><td colspan="7"></td></tr><tr><td class="h">1345</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg = translate($u, &quot;modpost&quot;, undef);</td></tr>
<tr><td class="h">1346</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return { &#39;message&#39; =&gt; $msg };</td></tr>
<tr><td class="h">1347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} # /moderated comms</td></tr>
<tr><td class="h">1349</td><td colspan="7"></td></tr><tr><td class="h">1350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# posting:</td></tr>
<tr><td class="h">1351</td><td colspan="7"></td></tr><tr><td class="h">1352</td><td><div class="c3">34</div><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1352">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$getlock-&gt;(); return $res if $res_done;</td></tr>
<tr><td class="h">1353</td><td colspan="7"></td></tr><tr><td class="h">1354</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do rate-checking</td></tr>
<tr><td class="h">1355</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1355">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1355">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( ! $u-&gt;is_syndicated &amp;&amp; ! LJ::rate_log($u, &quot;post&quot;, 1) &amp;&amp; ! $importer_bypass ) {</td></tr>
<tr><td class="h">1356</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $fail-&gt;($err,405);</td></tr>
<tr><td class="h">1357</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1358</td><td colspan="7"></td></tr><tr><td class="h">1359</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $jitemid = LJ::alloc_user_counter($uowner, &quot;L&quot;);</td></tr>
<tr><td class="h">1360</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1360">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $fail-&gt;($err,501,&quot;No itemid could be generated.&quot;) unless $jitemid;</td></tr>
<tr><td class="h">1361</td><td colspan="7"></td></tr><tr><td class="h">1362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# bring in LJ::Entry with Class::Autouse</td></tr>
<tr><td class="h">1363</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Entry-&gt;can(&quot;dostuff&quot;);</td></tr>
<tr><td class="h">1364</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>16000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::replycount_do($uowner, $jitemid, &quot;init&quot;);</td></tr>
<tr><td class="h">1365</td><td colspan="7"></td></tr><tr><td class="h">1366</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dberr;</td></tr>
<tr><td class="h">1367</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;log2_do(\$dberr, &quot;INSERT INTO log2 (journalid, jitemid, posterid, eventtime, logtime, security, &quot;.</td></tr>
<tr><td class="h">1368</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;allowmask, replycount, year, month, day, revttime, rlogtime, anum) &quot;.</td></tr>
<tr><td class="h">1369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES ($ownerid, $jitemid, $posterid, $qeventtime, FROM_UNIXTIME($now), $qsecurity, $qallowmask, &quot;.</td></tr>
<tr><td class="h">1370</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;0, $req-&gt;{&#39;year&#39;}, $req-&gt;{&#39;mon&#39;}, $req-&gt;{&#39;day&#39;}, $LJ::EndOfTime-&quot;.</td></tr>
<tr><td class="h">1371</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;UNIX_TIMESTAMP($qeventtime), $rlogtime, $anum)&quot;);</td></tr>
<tr><td class="h">1372</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1372">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $fail-&gt;($err,501,$dberr) if $dberr;</td></tr>
<tr><td class="h">1373</td><td colspan="7"></td></tr><tr><td class="h">1374</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::incr([$ownerid, &quot;log2ct:$ownerid&quot;]);</td></tr>
<tr><td class="h">1375</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($ownerid, &quot;dayct2&quot;);</td></tr>
<tr><td class="h">1376</td><td colspan="7"></td></tr><tr><td class="h">1377</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set userprops.</td></tr>
<tr><td class="h">1378</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1379</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>4000</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %set_userprop;</td></tr>
<tr><td class="h">1380</td><td colspan="7"></td></tr><tr><td class="h">1381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# keep track of itemid/anum for later potential duplicates</td></tr>
<tr><td class="h">1382</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$set_userprop{&quot;dupsig_post&quot;} = &quot;$dupsig:$jitemid:$anum&quot;;</td></tr>
<tr><td class="h">1383</td><td colspan="7"></td></tr><tr><td class="h">1384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# record the eventtime of the last update (for own journals only)</td></tr>
<tr><td class="h">1385</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1385">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1385">25</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$set_userprop{&quot;newesteventtime&quot;} = $eventtime</td></tr>
<tr><td class="h">1386</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $posterid == $ownerid and not $req-&gt;{&#39;props&#39;}-&gt;{&#39;opt_backdated&#39;} and not $time_was_faked;</td></tr>
<tr><td class="h">1387</td><td colspan="7"></td></tr><tr><td class="h">1388</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_userprop($u, \%set_userprop);</td></tr>
<tr><td class="h">1389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1390</td><td colspan="7"></td></tr><tr><td class="h">1391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# end duplicate locking section</td></tr>
<tr><td class="h">1392</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$release-&gt;();</td></tr>
<tr><td class="h">1393</td><td colspan="7"></td></tr><tr><td class="h">1394</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ditemid = $jitemid * 256 + $anum;</td></tr>
<tr><td class="h">1395</td><td colspan="7"></td></tr><tr><td class="h">1396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### finish embedding stuff now that we have the itemid</td></tr>
<tr><td class="h">1397</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1398</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;### this should NOT return an error, and we&#39;re mildly fucked by now</td></tr>
<tr><td class="h">1399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;### if it does (would have to delete the log row up there), so we&#39;re</td></tr>
<tr><td class="h">1400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;### not going to check it for now.</td></tr>
<tr><td class="h">1401</td><td colspan="7"></td></tr><tr><td class="h">1402</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $error = &quot;&quot;;</td></tr>
<tr><td class="h">1403</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $poll (@polls) {</td></tr>
<tr><td class="h">1404</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$poll-&gt;save_to_db(</td></tr>
<tr><td class="h">1405</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;journalid =&gt; $ownerid,</td></tr>
<tr><td class="h">1406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;posterid  =&gt; $posterid,</td></tr>
<tr><td class="h">1407</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ditemid   =&gt; $ditemid,</td></tr>
<tr><td class="h">1408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error     =&gt; \$error,</td></tr>
<tr><td class="h">1409</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1410</td><td colspan="7"></td></tr><tr><td class="h">1411</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pollid = $poll-&gt;pollid;</td></tr>
<tr><td class="h">1412</td><td colspan="7"></td></tr><tr><td class="h">1413</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event =~ s/&lt;poll-placeholder&gt;/&lt;poll-$pollid&gt;/;</td></tr>
<tr><td class="h">1414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#### /embedding</td></tr>
<tr><td class="h">1417</td><td colspan="7"></td></tr><tr><td class="h">1418</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# record journal&#39;s disk usage</td></tr>
<tr><td class="h">1419</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bytes = length($event) + length($req-&gt;{&#39;subject&#39;});</td></tr>
<tr><td class="h">1420</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;dudata_set(&#39;L&#39;, $jitemid, $bytes);</td></tr>
<tr><td class="h">1421</td><td colspan="7"></td></tr><tr><td class="h">1422</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;do(&quot;INSERT INTO logtext2 (journalid, jitemid, subject, event) &quot;.</td></tr>
<tr><td class="h">1423</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES ($ownerid, $jitemid, ?, ?)&quot;, undef, $req-&gt;{&#39;subject&#39;},</td></tr>
<tr><td class="h">1424</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_compress($event));</td></tr>
<tr><td class="h">1425</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1425">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($uowner-&gt;err) {</td></tr>
<tr><td class="h">1426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg = $uowner-&gt;errstr;</td></tr>
<tr><td class="h">1427</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::delete_entry($uowner, $jitemid);   # roll-back</td></tr>
<tr><td class="h">1428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,501,&quot;logtext:$msg&quot;);</td></tr>
<tr><td class="h">1429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1430</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$ownerid,&quot;logtext:$clusterid:$ownerid:$jitemid&quot;],</td></tr>
<tr><td class="h">1431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ $req-&gt;{&#39;subject&#39;}, $event ]);</td></tr>
<tr><td class="h">1432</td><td colspan="7"></td></tr><tr><td class="h">1433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# keep track of custom security stuff in other table.</td></tr>
<tr><td class="h">1434</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1434">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($uselogsec) {</td></tr>
<tr><td class="h">1435</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;do(&quot;INSERT INTO logsec2 (journalid, jitemid, allowmask) &quot;.</td></tr>
<tr><td class="h">1436</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES ($ownerid, $jitemid, $qallowmask)&quot;);</td></tr>
<tr><td class="h">1437</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1437">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($uowner-&gt;err) {</td></tr>
<tr><td class="h">1438</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $msg = $uowner-&gt;errstr;</td></tr>
<tr><td class="h">1439</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::delete_entry($uowner, $jitemid);   # roll-back</td></tr>
<tr><td class="h">1440</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,501,&quot;logsec2:$msg&quot;);</td></tr>
<tr><td class="h">1441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1443</td><td colspan="7"></td></tr><tr><td class="h">1444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Entry tags</td></tr>
<tr><td class="h">1445</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1445">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1445">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $req-&gt;{props} &amp;&amp; defined $req-&gt;{props}-&gt;{taglist} &amp;&amp; $req-&gt;{props}-&gt;{taglist} ne &#39;&#39; ) {</td></tr>
<tr><td class="h">1446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# slightly misnamed, the taglist is/was normally a string, but now can also be an arrayref.</td></tr>
<tr><td class="h">1447</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $taginput = $req-&gt;{props}-&gt;{taglist};</td></tr>
<tr><td class="h">1448</td><td colspan="7"></td></tr><tr><td class="h">1449</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tagerr = &quot;&quot;;</td></tr>
<tr><td class="h">1450</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1450">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $logtag_opts = {</td></tr>
<tr><td class="h">1451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote =&gt; $u,</td></tr>
<tr><td class="h">1452</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore_max =&gt; $flags-&gt;{ignore_tags_max} ? 1 : 0,</td></tr>
<tr><td class="h">1453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;force =&gt; $importer_bypass,</td></tr>
<tr><td class="h">1454</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err_ref =&gt; \$tagerr,</td></tr>
<tr><td class="h">1455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1456</td><td colspan="7"></td></tr><tr><td class="h">1457</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1457">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ref $taginput eq &#39;ARRAY&#39;) {</td></tr>
<tr><td class="h">1458</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logtag_opts-&gt;{set} = [@$taginput];</td></tr>
<tr><td class="h">1459</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{props}-&gt;{taglist} = join(&quot;, &quot;, @$taginput);</td></tr>
<tr><td class="h">1460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1461</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logtag_opts-&gt;{set_string} = $taginput;</td></tr>
<tr><td class="h">1462</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1463</td><td colspan="7"></td></tr><tr><td class="h">1464</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rv = LJ::Tags::update_logtags($uowner, $jitemid, $logtag_opts);</td></tr>
<tr><td class="h">1465</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1465">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,157,$tagerr) unless $rv;</td></tr>
<tr><td class="h">1466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1467</td><td colspan="7"></td></tr><tr><td class="h">1468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# meta-data</td></tr>
<tr><td class="h">1469</td><td><div class="c3">34</div><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1469">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%{$req-&gt;{&#39;props&#39;}}) {</td></tr>
<tr><td class="h">1470</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $propset = {};</td></tr>
<tr><td class="h">1471</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $pname (keys %{$req-&gt;{&#39;props&#39;}}) {</td></tr>
<tr><td class="h">1472</td><td><div class="c3">39</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1472">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $req-&gt;{&#39;props&#39;}-&gt;{$pname};</td></tr>
<tr><td class="h">1473</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1473">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1473">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $pname eq &quot;revnum&quot; || $pname eq &quot;revtime&quot;;</td></tr>
<tr><td class="h">1474</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;log&quot;, $pname);</td></tr>
<tr><td class="h">1475</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1475">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $p;</td></tr>
<tr><td class="h">1476</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1476">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $req-&gt;{&#39;props&#39;}-&gt;{$pname};</td></tr>
<tr><td class="h">1477</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$propset-&gt;{$pname} = $req-&gt;{&#39;props&#39;}-&gt;{$pname};</td></tr>
<tr><td class="h">1478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1479</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %logprops;</td></tr>
<tr><td class="h">1480</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1480">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_logprop($uowner, $jitemid, $propset, \%logprops) if %$propset;</td></tr>
<tr><td class="h">1481</td><td colspan="7"></td></tr><tr><td class="h">1482</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if set_logprop modified props above, we can set the memcache key</td></tr>
<tr><td class="h">1483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# to be the hashref of modified props, since this is a new post</td></tr>
<tr><td class="h">1484</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1484">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$uowner-&gt;{&#39;userid&#39;}, &quot;logprop:$uowner-&gt;{&#39;userid&#39;}:$jitemid&quot;],</td></tr>
<tr><td class="h">1485</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\%logprops) if %logprops;</td></tr>
<tr><td class="h">1486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1487</td><td colspan="7"></td></tr><tr><td class="h">1488</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1488">50</a></div></td><td></td><td></td><td></td><td><div>84004</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE userusage SET timeupdate=NOW(), lastitemid=$jitemid &quot;.</td></tr>
<tr><td class="h">1489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid=$ownerid&quot;) unless $flags-&gt;{&#39;notimeupdate&#39;};</td></tr>
<tr><td class="h">1490</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$ownerid, &quot;tu:$ownerid&quot;], pack(&quot;N&quot;, time()), 30*60);</td></tr>
<tr><td class="h">1491</td><td colspan="7"></td></tr><tr><td class="h">1492</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# argh, this is all too ugly.  need to unify more postpost stuff into async</td></tr>
<tr><td class="h">1493</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;invalidate_directory_record;</td></tr>
<tr><td class="h">1494</td><td colspan="7"></td></tr><tr><td class="h">1495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# note this post in recentactions table</td></tr>
<tr><td class="h">1496</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::note_recent_action($uowner, &#39;post&#39;);</td></tr>
<tr><td class="h">1497</td><td colspan="7"></td></tr><tr><td class="h">1498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if the post was public, and the user has not opted out, try to insert into the random table;</td></tr>
<tr><td class="h">1499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# We&#39;re doing a REPLACE INTO because chances are the user will already</td></tr>
<tr><td class="h">1500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# be in there (having posted less than 7 days ago).</td></tr>
<tr><td class="h">1501</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1501">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1501">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($security eq &#39;public&#39; &amp;&amp; ! $u-&gt;prop(&#39;latest_optout&#39;)) {</td></tr>
<tr><td class="h">1502</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;REPLACE INTO random_user_set (posttime, userid, journaltype) VALUES (UNIX_TIMESTAMP(), ?, ?)&quot;,</td></tr>
<tr><td class="h">1503</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uowner-&gt;{userid}, $uowner-&gt;{journaltype});</td></tr>
<tr><td class="h">1504</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1505</td><td colspan="7"></td></tr><tr><td class="h">1506</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @jobs;  # jobs to add into TheSchwartz</td></tr>
<tr><td class="h">1507</td><td colspan="7"></td></tr><tr><td class="h">1508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# notify weblogs.com of post if necessary</td></tr>
<tr><td class="h">1509</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1509">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1509">17</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( LJ::is_enabled(&#39;weblogs_com&#39;) &amp;&amp; $u-&gt;{&#39;opt_weblogscom&#39;} &amp;&amp; LJ::get_cap($u, &quot;weblogscom&quot;) &amp;&amp;</td></tr>
<tr><td class="h">1510</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($security eq &quot;public&quot;) &amp;&amp; !$req-&gt;{&#39;props&#39;}-&gt;{&#39;opt_backdated&#39;} ) {</td></tr>
<tr><td class="h">1511</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1511">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, TheSchwartz::Job-&gt;new_from_array(&quot;LJ::Worker::Ping::WeblogsCom&quot;, {</td></tr>
<tr><td class="h">1512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;user&#39; =&gt; $u-&gt;{&#39;user&#39;},</td></tr>
<tr><td class="h">1513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;title&#39; =&gt; $u-&gt;{&#39;journaltitle&#39;} || $u-&gt;{&#39;name&#39;},</td></tr>
<tr><td class="h">1514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39; =&gt; LJ::journal_base($u) . &quot;/&quot;,</td></tr>
<tr><td class="h">1515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">1516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1517</td><td colspan="7"></td></tr><tr><td class="h">1518</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new($uowner, jitemid =&gt; $jitemid, anum =&gt; $anum);</td></tr>
<tr><td class="h">1519</td><td colspan="7"></td></tr><tr><td class="h">1520</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# run local site-specific actions</td></tr>
<tr><td class="h">1521</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;postpost&quot;, {</td></tr>
<tr><td class="h">1522</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;itemid&#39;    =&gt; $jitemid,</td></tr>
<tr><td class="h">1523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;anum&#39;      =&gt; $anum,</td></tr>
<tr><td class="h">1524</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;journal&#39;   =&gt; $uowner,</td></tr>
<tr><td class="h">1525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;poster&#39;    =&gt; $u,</td></tr>
<tr><td class="h">1526</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;event&#39;     =&gt; $event,</td></tr>
<tr><td class="h">1527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;eventtime&#39; =&gt; $eventtime,</td></tr>
<tr><td class="h">1528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;subject&#39;   =&gt; $req-&gt;{&#39;subject&#39;},</td></tr>
<tr><td class="h">1529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;security&#39;  =&gt; $security,</td></tr>
<tr><td class="h">1530</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;allowmask&#39; =&gt; $qallowmask,</td></tr>
<tr><td class="h">1531</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;props&#39;     =&gt; $req-&gt;{&#39;props&#39;},</td></tr>
<tr><td class="h">1532</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;entry&#39;     =&gt; $entry,</td></tr>
<tr><td class="h">1533</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jobs&#39;      =&gt; \@jobs,  # for hooks to push jobs onto</td></tr>
<tr><td class="h">1534</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">1535</td><td colspan="7"></td></tr><tr><td class="h">1536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# cluster tracking</td></tr>
<tr><td class="h">1537</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::mark_user_active($u, &#39;post&#39;);</td></tr>
<tr><td class="h">1538</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1538">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::mark_user_active($uowner, &#39;post&#39;) unless LJ::u_equals($u, $uowner);</td></tr>
<tr><td class="h">1539</td><td colspan="7"></td></tr><tr><td class="h">1540</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;itemid&#39;} = $jitemid;  # by request of mart</td></tr>
<tr><td class="h">1541</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;anum&#39;} = $anum;</td></tr>
<tr><td class="h">1542</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;url&#39;} = $entry-&gt;url;</td></tr>
<tr><td class="h">1543</td><td colspan="7"></td></tr><tr><td class="h">1544</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if the caller told us not to fire events (importer?) then skip the user events,</td></tr>
<tr><td class="h">1545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# but still fire the logging events</td></tr>
<tr><td class="h">1546</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1546">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $flags-&gt;{nonotify} ) {</td></tr>
<tr><td class="h">1547</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::Event::JournalNewEntry-&gt;new($entry)-&gt;fire_job;</td></tr>
<tr><td class="h">1548</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1548">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1548">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::Event::UserNewEntry-&gt;new($entry)-&gt;fire_job if LJ::is_enabled(&#39;esn-userevents&#39;) || $LJ::_T_FIRE_USERNEWENTRY;</td></tr>
<tr><td class="h">1549</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1549">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::Event::OfficialPost-&gt;new($entry)-&gt;fire_job if $uowner-&gt;is_official;        </td></tr>
<tr><td class="h">1550</td><td colspan="7"></td></tr><tr><td class="h">1551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# PubSubHubbub Support</td></tr>
<tr><td class="h">1552</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Feed::generate_hubbub_jobs( $uowner, \@jobs );</td></tr>
<tr><td class="h">1553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1554</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, LJ::EventLogRecord::NewEntry-&gt;new($entry)-&gt;fire_job;</td></tr>
<tr><td class="h">1555</td><td colspan="7"></td></tr><tr><td class="h">1556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the sphinx search engine</td></tr>
<tr><td class="h">1557</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L1557">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( @LJ::SPHINX_SEARCHD ) {</td></tr>
<tr><td class="h">1558</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @jobs, TheSchwartz::Job-&gt;new_from_array( &#39;DW::Worker::Sphinx::Copier&#39;, { userid =&gt; $uowner-&gt;id } );</td></tr>
<tr><td class="h">1559</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1560</td><td colspan="7"></td></tr><tr><td class="h">1561</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sclient = LJ::theschwartz();</td></tr>
<tr><td class="h">1562</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1562">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1562">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($sclient &amp;&amp; @jobs) {</td></tr>
<tr><td class="h">1563</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @handles = $sclient-&gt;insert_jobs(@jobs);</td></tr>
<tr><td class="h">1564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# TODO: error on failure?  depends on the job I suppose?  property of the job?</td></tr>
<tr><td class="h">1565</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1566</td><td colspan="7"></td></tr><tr><td class="h">1567</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">1568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1569</td><td colspan="7"></td></tr><tr><td class="h">1570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub editevent</td></tr>
<tr><td class="h">1571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1572</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L1572">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">1573</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;un_utf8_request($req);</td></tr>
<tr><td class="h">1574</td><td colspan="7"></td></tr><tr><td class="h">1575</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1575">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">1576</td><td colspan="7"></td></tr><tr><td class="h">1577</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we check later that user owns entry they&#39;re modifying, so all</td></tr>
<tr><td class="h">1578</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we care about for check_altusage is that the target journal</td></tr>
<tr><td class="h">1579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# exists, and we want it to setup some data in $flags.</td></tr>
<tr><td class="h">1580</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{&#39;ignorecanuse&#39;} = 1;</td></tr>
<tr><td class="h">1581</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1581">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless check_altusage($req, $err, $flags);</td></tr>
<tr><td class="h">1582</td><td colspan="7"></td></tr><tr><td class="h">1583</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">1584</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ownerid = $flags-&gt;{&#39;ownerid&#39;};</td></tr>
<tr><td class="h">1585</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1585">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uowner = $flags-&gt;{&#39;u_owner&#39;} || $u;</td></tr>
<tr><td class="h">1586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Make sure we have a user object here</td></tr>
<tr><td class="h">1587</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1587">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$uowner = LJ::want_user($uowner) unless LJ::isu($uowner);</td></tr>
<tr><td class="h">1588</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $clusterid = $uowner-&gt;{&#39;clusterid&#39;};</td></tr>
<tr><td class="h">1589</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posterid = $u-&gt;{&#39;userid&#39;};</td></tr>
<tr><td class="h">1590</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qallowmask = $req-&gt;{&#39;allowmask&#39;}+0;</td></tr>
<tr><td class="h">1591</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth;</td></tr>
<tr><td class="h">1592</td><td colspan="7"></td></tr><tr><td class="h">1593</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $itemid = $req-&gt;{&#39;itemid&#39;}+0;</td></tr>
<tr><td class="h">1594</td><td colspan="7"></td></tr><tr><td class="h">1595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check the journal&#39;s read-only bit</td></tr>
<tr><td class="h">1596</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1596">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,306) if LJ::get_cap($uowner, &quot;readonly&quot;);</td></tr>
<tr><td class="h">1597</td><td colspan="7"></td></tr><tr><td class="h">1598</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t edit in deleted/suspended community</td></tr>
<tr><td class="h">1599</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1599">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1599">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,307) unless $uowner-&gt;is_visible || $uowner-&gt;is_readonly;</td></tr>
<tr><td class="h">1600</td><td colspan="7"></td></tr><tr><td class="h">1601</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = LJ::get_cluster_master($uowner);</td></tr>
<tr><td class="h">1602</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1602">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,306) unless $dbcm;</td></tr>
<tr><td class="h">1603</td><td colspan="7"></td></tr><tr><td class="h">1604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t specify both a custom security and &#39;friends-only&#39;</td></tr>
<tr><td class="h">1605</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1605">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1605">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 203, &quot;Invalid friends group security set.&quot;)</td></tr>
<tr><td class="h">1606</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $qallowmask &gt; 1 &amp;&amp; $qallowmask % 2;</td></tr>
<tr><td class="h">1607</td><td colspan="7"></td></tr><tr><td class="h">1608</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### make sure user can&#39;t change a post to &quot;custom/private security&quot; on shared journals</td></tr>
<tr><td class="h">1609</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1609">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1609">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,102)</td></tr>
<tr><td class="h">1610</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($ownerid != $posterid &amp;&amp; # community post</td></tr>
<tr><td class="h">1611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($req-&gt;{&#39;security&#39;} eq &quot;private&quot; ||</td></tr>
<tr><td class="h">1612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($req-&gt;{&#39;security&#39;} eq &quot;usemask&quot; &amp;&amp; $qallowmask != 1 )));</td></tr>
<tr><td class="h">1613</td><td colspan="7"></td></tr><tr><td class="h">1614</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make sure the new entry&#39;s under the char limit</td></tr>
<tr><td class="h">1615</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# NOTE: as in postevent, this requires $req-&gt;{event} to be binary data</td></tr>
<tr><td class="h">1616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# but we&#39;ve already removed the utf-8 flag in the XML-RPC path, and it</td></tr>
<tr><td class="h">1617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# never gets set in the &quot;flat&quot; protocol path</td></tr>
<tr><td class="h">1618</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1618">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,409) if length($req-&gt;{event}) &gt;= LJ::BMAX_EVENT;</td></tr>
<tr><td class="h">1619</td><td colspan="7"></td></tr><tr><td class="h">1620</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# fetch the old entry from master database so we know what we</td></tr>
<tr><td class="h">1621</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# really have to update later.  usually people just edit one part,</td></tr>
<tr><td class="h">1622</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# not every field in every table.  reads are quicker than writes,</td></tr>
<tr><td class="h">1623</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so this is worth it.</td></tr>
<tr><td class="h">1624</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $oldevent = $dbcm-&gt;selectrow_hashref</td></tr>
<tr><td class="h">1625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&quot;SELECT journalid AS &#39;ownerid&#39;, posterid, eventtime, logtime, &quot;.</td></tr>
<tr><td class="h">1626</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;compressed, security, allowmask, year, month, day, &quot;.</td></tr>
<tr><td class="h">1627</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;rlogtime, anum FROM log2 WHERE journalid=$ownerid AND jitemid=$itemid&quot;);</td></tr>
<tr><td class="h">1628</td><td colspan="7"></td></tr><tr><td class="h">1629</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;($oldevent-&gt;{subject}, $oldevent-&gt;{event}) = $dbcm-&gt;selectrow_array</td></tr>
<tr><td class="h">1630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&quot;SELECT subject, event FROM logtext2 &quot;.</td></tr>
<tr><td class="h">1631</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$ownerid AND jitemid=$itemid&quot;);</td></tr>
<tr><td class="h">1632</td><td colspan="7"></td></tr><tr><td class="h">1633</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_uncompress(\$oldevent-&gt;{&#39;event&#39;});</td></tr>
<tr><td class="h">1634</td><td colspan="7"></td></tr><tr><td class="h">1635</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# use_old_content indicates the subject and entry are not changing</td></tr>
<tr><td class="h">1636</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1636">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($flags-&gt;{&#39;use_old_content&#39;}) {</td></tr>
<tr><td class="h">1637</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;event&#39;} = $oldevent-&gt;{event};</td></tr>
<tr><td class="h">1638</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;subject&#39;} = $oldevent-&gt;{subject};</td></tr>
<tr><td class="h">1639</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1640</td><td colspan="7"></td></tr><tr><td class="h">1641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# kill seconds in eventtime, since we don&#39;t use it, then we can use &#39;eq&#39; and such</td></tr>
<tr><td class="h">1642</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$oldevent-&gt;{&#39;eventtime&#39;} =~ s/:00$//;</td></tr>
<tr><td class="h">1643</td><td colspan="7"></td></tr><tr><td class="h">1644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### make sure this user is allowed to edit this entry</td></tr>
<tr><td class="h">1645</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1645">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,302)</td></tr>
<tr><td class="h">1646</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($ownerid == $oldevent-&gt;{&#39;ownerid&#39;});</td></tr>
<tr><td class="h">1647</td><td colspan="7"></td></tr><tr><td class="h">1648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### what can they do to somebody elses entry?  (in shared journal)</td></tr>
<tr><td class="h">1649</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### can edit it if they own or maintain the journal, but not if the journal is read-only</td></tr>
<tr><td class="h">1650</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1650">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1650">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($posterid != $oldevent-&gt;{&#39;posterid&#39;} || $u-&gt;is_readonly || $uowner-&gt;is_readonly)</td></tr>
<tr><td class="h">1651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1652</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## deleting.</td></tr>
<tr><td class="h">1653</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1653">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1653">0</a></div><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1653">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,304)</td></tr>
<tr><td class="h">1654</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;event&#39;} !~ /\S/ &amp;&amp; !</td></tr>
<tr><td class="h">1655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($ownerid == $u-&gt;{&#39;userid&#39;} ||</td></tr>
<tr><td class="h">1656</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# community account can delete it (ick)</td></tr>
<tr><td class="h">1657</td><td colspan="7"></td></tr><tr><td class="h">1658</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::can_manage_other($posterid, $ownerid)</td></tr>
<tr><td class="h">1659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if user is a community maintainer they can delete</td></tr>
<tr><td class="h">1660</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# it too (good)</td></tr>
<tr><td class="h">1661</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;));</td></tr>
<tr><td class="h">1662</td><td colspan="7"></td></tr><tr><td class="h">1663</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## editing:</td></tr>
<tr><td class="h">1664</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1664">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;event&#39;} =~ /\S/) {</td></tr>
<tr><td class="h">1665</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1665">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,303) if $posterid != $oldevent-&gt;{&#39;posterid&#39;};</td></tr>
<tr><td class="h">1666</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1666">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,318) if $u-&gt;is_readonly;</td></tr>
<tr><td class="h">1667</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1667">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,319) if $uowner-&gt;is_readonly;</td></tr>
<tr><td class="h">1668</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1669</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1670</td><td colspan="7"></td></tr><tr><td class="h">1671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# simple logic for deleting an entry</td></tr>
<tr><td class="h">1672</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1672">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1672">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$flags-&gt;{&#39;use_old_content&#39;} &amp;&amp; $req-&gt;{&#39;event&#39;} !~ /\S/)</td></tr>
<tr><td class="h">1673</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if their newesteventtime prop equals the time of the one they&#39;re deleting</td></tr>
<tr><td class="h">1675</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# then delete their newesteventtime.</td></tr>
<tr><td class="h">1676</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1676">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;userid&#39;} == $uowner-&gt;{&#39;userid&#39;}) {</td></tr>
<tr><td class="h">1677</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($u, { use_master =&gt; 1 }, &quot;newesteventtime&quot;);</td></tr>
<tr><td class="h">1678</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1678">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;newesteventtime&#39;} eq $oldevent-&gt;{&#39;eventtime&#39;}) {</td></tr>
<tr><td class="h">1679</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_userprop($u, &quot;newesteventtime&quot;, undef);</td></tr>
<tr><td class="h">1680</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1681</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1682</td><td colspan="7"></td></tr><tr><td class="h">1683</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# log this event, unless noauth is on, which means it is being done internally and we should</td></tr>
<tr><td class="h">1684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# rely on them to log why they&#39;re deleting the entry if they need to.  that way we don&#39;t have</td></tr>
<tr><td class="h">1685</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# double entries, and we have as much information available as possible at the location the</td></tr>
<tr><td class="h">1686</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# delete is initiated.</td></tr>
<tr><td class="h">1687</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1687">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;log_event(&#39;delete_entry&#39;, {</td></tr>
<tr><td class="h">1688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote =&gt; $u,</td></tr>
<tr><td class="h">1689</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actiontarget =&gt; ($req-&gt;{itemid} * 256 + $oldevent-&gt;{anum}),</td></tr>
<tr><td class="h">1690</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;method =&gt; &#39;protocol&#39;,</td></tr>
<tr><td class="h">1691</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</td></tr>
<tr><td class="h">1692</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $flags-&gt;{noauth};</td></tr>
<tr><td class="h">1693</td><td colspan="7"></td></tr><tr><td class="h">1694</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::delete_entry($uowner, $req-&gt;{&#39;itemid&#39;}, &#39;quick&#39;, $oldevent-&gt;{&#39;anum&#39;});</td></tr>
<tr><td class="h">1695</td><td colspan="7"></td></tr><tr><td class="h">1696</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# clear their duplicate protection, so they can later repost</td></tr>
<tr><td class="h">1697</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# what they just deleted.  (or something... probably rare.)</td></tr>
<tr><td class="h">1698</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_userprop($u, &quot;dupsig_post&quot;, undef);</td></tr>
<tr><td class="h">1699</td><td colspan="7"></td></tr><tr><td class="h">1700</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $res = { &#39;itemid&#39; =&gt; $itemid,</td></tr>
<tr><td class="h">1701</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;anum&#39; =&gt; $oldevent-&gt;{&#39;anum&#39;} };</td></tr>
<tr><td class="h">1702</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">1703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1704</td><td colspan="7"></td></tr><tr><td class="h">1705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now make sure the new entry text isn&#39;t $CannotBeShown</td></tr>
<tr><td class="h">1706</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1706">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 210)</td></tr>
<tr><td class="h">1707</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $req-&gt;{event} eq $CannotBeShown;</td></tr>
<tr><td class="h">1708</td><td colspan="7"></td></tr><tr><td class="h">1709</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t allow backdated posts in communities</td></tr>
<tr><td class="h">1710</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1710">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1710">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,152) if</td></tr>
<tr><td class="h">1711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($req-&gt;{&#39;props&#39;}-&gt;{&quot;opt_backdated&quot;} &amp;&amp;</td></tr>
<tr><td class="h">1712</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;! $uowner-&gt;is_person);</td></tr>
<tr><td class="h">1713</td><td colspan="7"></td></tr><tr><td class="h">1714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make year/mon/day/hour/min optional in an edit event,</td></tr>
<tr><td class="h">1715</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# and just inherit their old values</td></tr>
<tr><td class="h">1716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1717</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$oldevent-&gt;{&#39;eventtime&#39;} =~ /^(\d\d\d\d)-(\d\d)-(\d\d) (\d\d):(\d\d)/;</td></tr>
<tr><td class="h">1718</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1718">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;year&#39;} = $1 unless defined $req-&gt;{&#39;year&#39;};</td></tr>
<tr><td class="h">1719</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1719">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;mon&#39;} = $2+0 unless defined $req-&gt;{&#39;mon&#39;};</td></tr>
<tr><td class="h">1720</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1720">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;day&#39;} = $3+0 unless defined $req-&gt;{&#39;day&#39;};</td></tr>
<tr><td class="h">1721</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1721">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;hour&#39;} = $4+0 unless defined $req-&gt;{&#39;hour&#39;};</td></tr>
<tr><td class="h">1722</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1722">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;min&#39;} = $5+0 unless defined $req-&gt;{&#39;min&#39;};</td></tr>
<tr><td class="h">1723</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1724</td><td colspan="7"></td></tr><tr><td class="h">1725</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# updating an entry:</td></tr>
<tr><td class="h">1726</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef</td></tr>
<tr><td class="h">1727</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1727">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless common_event_validation($req, $err, $flags);</td></tr>
<tr><td class="h">1728</td><td colspan="7"></td></tr><tr><td class="h">1729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### load existing meta-data</td></tr>
<tr><td class="h">1730</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %curprops;</td></tr>
<tr><td class="h">1731</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_log_props2($dbcm, $ownerid, [ $itemid ], \%curprops);</td></tr>
<tr><td class="h">1732</td><td colspan="7"></td></tr><tr><td class="h">1733</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## handle meta-data (properties)</td></tr>
<tr><td class="h">1734</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %props_byname = ();</td></tr>
<tr><td class="h">1735</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $key (keys %{$req-&gt;{&#39;props&#39;}}) {</td></tr>
<tr><td class="h">1736</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## changing to something else?</td></tr>
<tr><td class="h">1737</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1737">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($curprops{$itemid}-&gt;{$key} ne $req-&gt;{&#39;props&#39;}-&gt;{$key}) {</td></tr>
<tr><td class="h">1738</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$props_byname{$key} = $req-&gt;{&#39;props&#39;}-&gt;{$key};</td></tr>
<tr><td class="h">1739</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1741</td><td colspan="7"></td></tr><tr><td class="h">1742</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $event = $req-&gt;{&#39;event&#39;};</td></tr>
<tr><td class="h">1743</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $owneru = LJ::load_userid($ownerid);</td></tr>
<tr><td class="h">1744</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$event = LJ::EmbedModule-&gt;transform_rte_post($event);</td></tr>
<tr><td class="h">1745</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::EmbedModule-&gt;parse_module_embed($owneru, \$event);</td></tr>
<tr><td class="h">1746</td><td colspan="7"></td></tr><tr><td class="h">1747</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bytes = length($event) + length($req-&gt;{&#39;subject&#39;});</td></tr>
<tr><td class="h">1748</td><td colspan="7"></td></tr><tr><td class="h">1749</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $eventtime = sprintf(&quot;%04d-%02d-%02d %02d:%02d&quot;,</td></tr>
<tr><td class="h">1750</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map { $req-&gt;{$_} } qw(year mon day hour min));</td></tr>
<tr><td class="h">1751</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qeventtime = $dbcm-&gt;quote($eventtime);</td></tr>
<tr><td class="h">1752</td><td colspan="7"></td></tr><tr><td class="h">1753</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# preserve old security by default, use user supplied if it&#39;s understood</td></tr>
<tr><td class="h">1754</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $security = $oldevent-&gt;{security};</td></tr>
<tr><td class="h">1755</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1755">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1755">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$security = $req-&gt;{security}</td></tr>
<tr><td class="h">1756</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $req-&gt;{security} &amp;&amp;</td></tr>
<tr><td class="h">1757</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{security} =~ /^(?:public|private|usemask)$/;</td></tr>
<tr><td class="h">1758</td><td colspan="7"></td></tr><tr><td class="h">1759</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1759">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $do_tags = $req-&gt;{props} &amp;&amp; defined $req-&gt;{props}-&gt;{taglist};</td></tr>
<tr><td class="h">1760</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1760">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1760">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($oldevent-&gt;{security} ne $security || $qallowmask != $oldevent-&gt;{allowmask}) {</td></tr>
<tr><td class="h">1761</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this is a hopefully temporary hack which deletes tags from the entry</td></tr>
<tr><td class="h">1762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# when the security has changed.  the real fix is to make update_logtags aware</td></tr>
<tr><td class="h">1763</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# of security changes so it can update logkwsum appropriately.</td></tr>
<tr><td class="h">1764</td><td colspan="7"></td></tr><tr><td class="h">1765</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1765">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($do_tags) {</td></tr>
<tr><td class="h">1766</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we need to fix security on this entry&#39;s tags, but the user didn&#39;t give us a tag list</td></tr>
<tr><td class="h">1767</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# to work with, so we have to go get the tags on the entry, and construct a tag list,</td></tr>
<tr><td class="h">1768</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# in order to pass to update_logtags down at the bottom of this whole update</td></tr>
<tr><td class="h">1769</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tags = LJ::Tags::get_logtags($uowner, $itemid);</td></tr>
<tr><td class="h">1770</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tags = $tags-&gt;{$itemid};</td></tr>
<tr><td class="h">1771</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1771">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{props}-&gt;{taglist} = join(&#39;,&#39;, sort values %{$tags || {}});</td></tr>
<tr><td class="h">1772</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$do_tags = 1; # bleh, force the update later</td></tr>
<tr><td class="h">1773</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1774</td><td colspan="7"></td></tr><tr><td class="h">1775</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Tags::delete_logtags($uowner, $itemid);</td></tr>
<tr><td class="h">1776</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1777</td><td colspan="7"></td></tr><tr><td class="h">1778</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qyear = $req-&gt;{&#39;year&#39;}+0;</td></tr>
<tr><td class="h">1779</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qmonth = $req-&gt;{&#39;mon&#39;}+0;</td></tr>
<tr><td class="h">1780</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qday = $req-&gt;{&#39;day&#39;}+0;</td></tr>
<tr><td class="h">1781</td><td colspan="7"></td></tr><tr><td class="h">1782</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1782">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1782">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($eventtime ne $oldevent-&gt;{&#39;eventtime&#39;} ||</td></tr>
<tr><td class="h">1783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$security ne $oldevent-&gt;{&#39;security&#39;} ||</td></tr>
<tr><td class="h">1784</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(!$curprops{$itemid}-&gt;{opt_backdated} &amp;&amp; $req-&gt;{props}{opt_backdated}) ||</td></tr>
<tr><td class="h">1785</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$qallowmask != $oldevent-&gt;{&#39;allowmask&#39;})</td></tr>
<tr><td class="h">1786</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1787</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# are they changing their most recent post?</td></tr>
<tr><td class="h">1788</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($u, &quot;newesteventtime&quot;);</td></tr>
<tr><td class="h">1789</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1789">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1789">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{userid} == $uowner-&gt;{userid} &amp;&amp;</td></tr>
<tr><td class="h">1790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{newesteventtime} eq $oldevent-&gt;{eventtime}) {</td></tr>
<tr><td class="h">1791</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# did they change the time?</td></tr>
<tr><td class="h">1792</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1792">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1792">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1792">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($eventtime ne $oldevent-&gt;{eventtime}) {</td></tr>
<tr><td class="h">1793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the newesteventtime is this event&#39;s new time.</td></tr>
<tr><td class="h">1794</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_userprop($u, &quot;newesteventtime&quot;, $eventtime);</td></tr>
<tr><td class="h">1795</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif (!$curprops{$itemid}-&gt;{opt_backdated} &amp;&amp; $req-&gt;{props}{opt_backdated}) {</td></tr>
<tr><td class="h">1796</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# otherwise, if they set the backdated flag,</td></tr>
<tr><td class="h">1797</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# then we no longer know the newesteventtime.</td></tr>
<tr><td class="h">1798</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_userprop($u, &quot;newesteventtime&quot;, undef);</td></tr>
<tr><td class="h">1799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1800</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1801</td><td colspan="7"></td></tr><tr><td class="h">1802</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $qsecurity = $uowner-&gt;quote($security);</td></tr>
<tr><td class="h">1803</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dberr;</td></tr>
<tr><td class="h">1804</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;log2_do(\$dberr, &quot;UPDATE log2 SET eventtime=$qeventtime, revttime=$LJ::EndOfTime-&quot;.</td></tr>
<tr><td class="h">1805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;UNIX_TIMESTAMP($qeventtime), year=$qyear, month=$qmonth, day=$qday, &quot;.</td></tr>
<tr><td class="h">1806</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;security=$qsecurity, allowmask=$qallowmask WHERE journalid=$ownerid &quot;.</td></tr>
<tr><td class="h">1807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND jitemid=$itemid&quot;);</td></tr>
<tr><td class="h">1808</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1808">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,501,$dberr) if $dberr;</td></tr>
<tr><td class="h">1809</td><td colspan="7"></td></tr><tr><td class="h">1810</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# update memcached</td></tr>
<tr><td class="h">1811</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sec = $qallowmask;</td></tr>
<tr><td class="h">1812</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1812">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sec = 0 if $security eq &#39;private&#39;;</td></tr>
<tr><td class="h">1813</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1813">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sec = 2**63 if $security eq &#39;public&#39;;</td></tr>
<tr><td class="h">1814</td><td colspan="7"></td></tr><tr><td class="h">1815</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $row = pack(&quot;NNNQN&quot;, $oldevent-&gt;{&#39;posterid&#39;},</td></tr>
<tr><td class="h">1816</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::mysqldate_to_time($eventtime, 1),</td></tr>
<tr><td class="h">1817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::mysqldate_to_time($oldevent-&gt;{&#39;logtime&#39;}, 1),</td></tr>
<tr><td class="h">1818</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sec,</td></tr>
<tr><td class="h">1819</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$itemid*256 + $oldevent-&gt;{&#39;anum&#39;});</td></tr>
<tr><td class="h">1820</td><td colspan="7"></td></tr><tr><td class="h">1821</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$ownerid, &quot;log2:$ownerid:$itemid&quot;], $row);</td></tr>
<tr><td class="h">1822</td><td colspan="7"></td></tr><tr><td class="h">1823</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1824</td><td colspan="7"></td></tr><tr><td class="h">1825</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1825">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1825">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($security ne $oldevent-&gt;{&#39;security&#39;} ||</td></tr>
<tr><td class="h">1826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$qallowmask != $oldevent-&gt;{&#39;allowmask&#39;})</td></tr>
<tr><td class="h">1827</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1828</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1828">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1828">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($security eq &quot;public&quot; || $security eq &quot;private&quot;) {</td></tr>
<tr><td class="h">1829</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;do(&quot;DELETE FROM logsec2 WHERE journalid=$ownerid AND jitemid=$itemid&quot;);</td></tr>
<tr><td class="h">1830</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1831</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;do(&quot;REPLACE INTO logsec2 (journalid, jitemid, allowmask) &quot;.</td></tr>
<tr><td class="h">1832</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES ($ownerid, $itemid, $qallowmask)&quot;);</td></tr>
<tr><td class="h">1833</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1834</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1834">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,501,$dbcm-&gt;errstr) if $uowner-&gt;err;</td></tr>
<tr><td class="h">1835</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1836</td><td colspan="7"></td></tr><tr><td class="h">1837</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$ownerid,&quot;logtext:$clusterid:$ownerid:$itemid&quot;],</td></tr>
<tr><td class="h">1838</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ $req-&gt;{&#39;subject&#39;}, $event ]);</td></tr>
<tr><td class="h">1839</td><td colspan="7"></td></tr><tr><td class="h">1840</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1840">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1840">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$flags-&gt;{&#39;use_old_content&#39;} &amp;&amp; (</td></tr>
<tr><td class="h">1841</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event ne $oldevent-&gt;{&#39;event&#39;} ||</td></tr>
<tr><td class="h">1842</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;subject&#39;} ne $oldevent-&gt;{&#39;subject&#39;}))</td></tr>
<tr><td class="h">1843</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1844</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;do(&quot;UPDATE logtext2 SET subject=?, event=? &quot;.</td></tr>
<tr><td class="h">1845</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$ownerid AND jitemid=$itemid&quot;, undef,</td></tr>
<tr><td class="h">1846</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;subject&#39;}, LJ::text_compress($event));</td></tr>
<tr><td class="h">1847</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1847">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,501,$uowner-&gt;errstr) if $uowner-&gt;err;</td></tr>
<tr><td class="h">1848</td><td colspan="7"></td></tr><tr><td class="h">1849</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# update disk usage</td></tr>
<tr><td class="h">1850</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;dudata_set(&#39;L&#39;, $itemid, $bytes);</td></tr>
<tr><td class="h">1851</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1852</td><td colspan="7"></td></tr><tr><td class="h">1853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# up the revision number</td></tr>
<tr><td class="h">1854</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1854">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;props&#39;}-&gt;{&#39;revnum&#39;} = ($curprops{$itemid}-&gt;{&#39;revnum&#39;} || 0) + 1;</td></tr>
<tr><td class="h">1855</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;props&#39;}-&gt;{&#39;revtime&#39;} = time();</td></tr>
<tr><td class="h">1856</td><td colspan="7"></td></tr><tr><td class="h">1857</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# handle tags if they&#39;re defined</td></tr>
<tr><td class="h">1858</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1858">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($do_tags) {</td></tr>
<tr><td class="h">1859</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tagerr = &quot;&quot;;</td></tr>
<tr><td class="h">1860</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rv = LJ::Tags::update_logtags($uowner, $itemid, {</td></tr>
<tr><td class="h">1861</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_string =&gt; $req-&gt;{props}-&gt;{taglist},</td></tr>
<tr><td class="h">1862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote =&gt; $u,</td></tr>
<tr><td class="h">1863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err_ref =&gt; \$tagerr,</td></tr>
<tr><td class="h">1864</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">1865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1866</td><td colspan="7"></td></tr><tr><td class="h">1867</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# handle the props</td></tr>
<tr><td class="h">1868</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1869</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $propset = {};</td></tr>
<tr><td class="h">1870</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $pname (keys %{$req-&gt;{&#39;props&#39;}}) {</td></tr>
<tr><td class="h">1871</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;log&quot;, $pname);</td></tr>
<tr><td class="h">1872</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1872">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $p;</td></tr>
<tr><td class="h">1873</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$propset-&gt;{$pname} = $req-&gt;{&#39;props&#39;}-&gt;{$pname};</td></tr>
<tr><td class="h">1874</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1875</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_logprop($uowner, $itemid, $propset);</td></tr>
<tr><td class="h">1876</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1877</td><td colspan="7"></td></tr><tr><td class="h">1878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# deal with backdated changes.  if the entry&#39;s rlogtime is</td></tr>
<tr><td class="h">1879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# $EndOfTime, then it&#39;s backdated.  if they want that off, need to</td></tr>
<tr><td class="h">1880</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# reset rlogtime to real reverse log time.  also need to set</td></tr>
<tr><td class="h">1881</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# rlogtime to $EndOfTime if they&#39;re turning backdate on.</td></tr>
<tr><td class="h">1882</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1882">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1882">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;props&#39;}-&gt;{&#39;opt_backdated&#39;} eq &quot;1&quot; &amp;&amp;</td></tr>
<tr><td class="h">1883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$oldevent-&gt;{&#39;rlogtime&#39;} != $LJ::EndOfTime) {</td></tr>
<tr><td class="h">1884</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dberr;</td></tr>
<tr><td class="h">1885</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;log2_do(undef, &quot;UPDATE log2 SET rlogtime=$LJ::EndOfTime WHERE &quot;.</td></tr>
<tr><td class="h">1886</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;journalid=$ownerid AND jitemid=$itemid&quot;);</td></tr>
<tr><td class="h">1887</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1887">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,501,$dberr) if $dberr;</td></tr>
<tr><td class="h">1888</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1889</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1889">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1889">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;props&#39;}-&gt;{&#39;opt_backdated&#39;} eq &quot;0&quot; &amp;&amp;</td></tr>
<tr><td class="h">1890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$oldevent-&gt;{&#39;rlogtime&#39;} == $LJ::EndOfTime) {</td></tr>
<tr><td class="h">1891</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dberr;</td></tr>
<tr><td class="h">1892</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uowner-&gt;log2_do(\$dberr, &quot;UPDATE log2 SET rlogtime=$LJ::EndOfTime-UNIX_TIMESTAMP(logtime) &quot;.</td></tr>
<tr><td class="h">1893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$ownerid AND jitemid=$itemid&quot;);</td></tr>
<tr><td class="h">1894</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1894">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,501,$dberr) if $dberr;</td></tr>
<tr><td class="h">1895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1896</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1896">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,501,$dbcm-&gt;errstr) if $dbcm-&gt;err;</td></tr>
<tr><td class="h">1897</td><td colspan="7"></td></tr><tr><td class="h">1898</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($ownerid, &quot;dayct2&quot;);</td></tr>
<tr><td class="h">1899</td><td colspan="7"></td></tr><tr><td class="h">1900</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = { &#39;itemid&#39; =&gt; $itemid };</td></tr>
<tr><td class="h">1901</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1901">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $oldevent-&gt;{&#39;anum&#39;}) {</td></tr>
<tr><td class="h">1902</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;anum&#39;} = $oldevent-&gt;{&#39;anum&#39;};</td></tr>
<tr><td class="h">1903</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;url&#39;} = LJ::item_link($uowner, $itemid, $oldevent-&gt;{&#39;anum&#39;});</td></tr>
<tr><td class="h">1904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1905</td><td colspan="7"></td></tr><tr><td class="h">1906</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new($ownerid, jitemid =&gt; $itemid);</td></tr>
<tr><td class="h">1907</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::EventLogRecord::EditEntry-&gt;new($entry)-&gt;fire;</td></tr>
<tr><td class="h">1908</td><td colspan="7"></td></tr><tr><td class="h">1909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# fired to copy the post over to the Sphinx search database</td></tr>
<tr><td class="h">1910</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1910">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1910">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( @LJ::SPHINX_SEARCHD &amp;&amp; ( my $sclient = LJ::theschwartz() ) ) {</td></tr>
<tr><td class="h">1911</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sclient-&gt;insert_jobs( TheSchwartz::Job-&gt;new_from_array( &#39;DW::Worker::Sphinx::Copier&#39;, { userid =&gt; $ownerid } ) );</td></tr>
<tr><td class="h">1912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1913</td><td colspan="7"></td></tr><tr><td class="h">1914</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# PubSubHubbub Support</td></tr>
<tr><td class="h">1915</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @jobs;</td></tr>
<tr><td class="h">1916</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Feed::generate_hubbub_jobs( $uowner, \@jobs );</td></tr>
<tr><td class="h">1917</td><td colspan="7"></td></tr><tr><td class="h">1918</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks( &quot;editpost&quot;, $entry, \@jobs );</td></tr>
<tr><td class="h">1919</td><td colspan="7"></td></tr><tr><td class="h">1920</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sclient = LJ::theschwartz();</td></tr>
<tr><td class="h">1921</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1921">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1921">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $sclient &amp;&amp; @jobs ) {</td></tr>
<tr><td class="h">1922</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @handles = $sclient-&gt;insert_jobs(@jobs);</td></tr>
<tr><td class="h">1923</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# TODO: error on failure?  depends on the job I suppose?  property of the job?</td></tr>
<tr><td class="h">1924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1925</td><td colspan="7"></td></tr><tr><td class="h">1926</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">1927</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1928</td><td colspan="7"></td></tr><tr><td class="h">1929</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getevents</td></tr>
<tr><td class="h">1930</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1931</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L1931">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">1932</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1932">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">1933</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1933">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless check_altusage($req, $err, $flags);</td></tr>
<tr><td class="h">1934</td><td colspan="7"></td></tr><tr><td class="h">1935</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">1936</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1936">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uowner = $flags-&gt;{&#39;u_owner&#39;} || $u;</td></tr>
<tr><td class="h">1937</td><td colspan="7"></td></tr><tr><td class="h">1938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### shared-journal support</td></tr>
<tr><td class="h">1939</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $posterid = $u-&gt;{&#39;userid&#39;};</td></tr>
<tr><td class="h">1940</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ownerid = $flags-&gt;{&#39;ownerid&#39;};</td></tr>
<tr><td class="h">1941</td><td colspan="7"></td></tr><tr><td class="h">1942</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">1943</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth;</td></tr>
<tr><td class="h">1944</td><td colspan="7"></td></tr><tr><td class="h">1945</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr =  LJ::get_cluster_reader($uowner);</td></tr>
<tr><td class="h">1946</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1946">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1946">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,502) unless $dbcr &amp;&amp; $dbr;</td></tr>
<tr><td class="h">1947</td><td colspan="7"></td></tr><tr><td class="h">1948</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t pull events from deleted/suspended journal</td></tr>
<tr><td class="h">1949</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1949">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1949">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,307) unless $uowner-&gt;is_visible || $uowner-&gt;is_readonly;</td></tr>
<tr><td class="h">1950</td><td colspan="7"></td></tr><tr><td class="h">1951</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $reject_code = $LJ::DISABLE_PROTOCOL{getevents};</td></tr>
<tr><td class="h">1952</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1952">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref $reject_code eq &quot;CODE&quot;) {</td></tr>
<tr><td class="h">1953</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $r = eval { BML::get_request() };</td></tr>
<tr><td class="h">1954</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $errmsg = $reject_code-&gt;($req, $flags, $r);</td></tr>
<tr><td class="h">1955</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1955">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($errmsg) { return fail($err, &quot;311&quot;, $errmsg); }</td></tr>
<tr><td class="h">1956</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1957</td><td colspan="7"></td></tr><tr><td class="h">1958</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if this is on, we sort things different (logtime vs. posttime)</td></tr>
<tr><td class="h">1959</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# to avoid timezone issues</td></tr>
<tr><td class="h">1960</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $is_community = $uowner-&gt;is_community;</td></tr>
<tr><td class="h">1961</td><td colspan="7"></td></tr><tr><td class="h">1962</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# in some cases we&#39;ll use the master, to ensure there&#39;s no</td></tr>
<tr><td class="h">1963</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# replication delay.  useful cases: getting one item, use master</td></tr>
<tr><td class="h">1964</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# since user might have just made a typo and realizes it as they</td></tr>
<tr><td class="h">1965</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# post, or wants to append something they forgot, etc, etc.  in</td></tr>
<tr><td class="h">1966</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# other cases, slave is pretty sure to have it.</td></tr>
<tr><td class="h">1967</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $use_master = 0;</td></tr>
<tr><td class="h">1968</td><td colspan="7"></td></tr><tr><td class="h">1969</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the benefit of this mode over actually doing &#39;lastn/1&#39; is</td></tr>
<tr><td class="h">1970</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the $use_master usage.</td></tr>
<tr><td class="h">1971</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1971">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1971">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;selecttype&#39;} eq &quot;one&quot; &amp;&amp; $req-&gt;{&#39;itemid&#39;} eq &quot;-1&quot;) {</td></tr>
<tr><td class="h">1972</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;selecttype&#39;} = &quot;lastn&quot;;</td></tr>
<tr><td class="h">1973</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;howmany&#39;} = 1;</td></tr>
<tr><td class="h">1974</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef $req-&gt;{&#39;itemid&#39;};</td></tr>
<tr><td class="h">1975</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$use_master = 1;  # see note above.</td></tr>
<tr><td class="h">1976</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1977</td><td colspan="7"></td></tr><tr><td class="h">1978</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# build the query to get log rows.  each selecttype branch is</td></tr>
<tr><td class="h">1979</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# responsible for either populating the following 3 variables</td></tr>
<tr><td class="h">1980</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# OR just populating $sql</td></tr>
<tr><td class="h">1981</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($orderby, $where, $limit);</td></tr>
<tr><td class="h">1982</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sql;</td></tr>
<tr><td class="h">1983</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1983">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1983">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1983">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1983">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1983">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;selecttype&#39;} eq &quot;day&quot;)</td></tr>
<tr><td class="h">1984</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">1985</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1985">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L1985">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203)</td></tr>
<tr><td class="h">1986</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($req-&gt;{&#39;year&#39;} =~ /^\d\d\d\d$/ &amp;&amp;</td></tr>
<tr><td class="h">1987</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;month&#39;} =~ /^\d\d?$/ &amp;&amp;</td></tr>
<tr><td class="h">1988</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;day&#39;} =~ /^\d\d?$/ &amp;&amp;</td></tr>
<tr><td class="h">1989</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;month&#39;} &gt;= 1 &amp;&amp; $req-&gt;{&#39;month&#39;} &lt;= 12 &amp;&amp;</td></tr>
<tr><td class="h">1990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{&#39;day&#39;} &gt;= 1 &amp;&amp; $req-&gt;{&#39;day&#39;} &lt;= 31);</td></tr>
<tr><td class="h">1991</td><td colspan="7"></td></tr><tr><td class="h">1992</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $qyear = $dbr-&gt;quote($req-&gt;{&#39;year&#39;});</td></tr>
<tr><td class="h">1993</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $qmonth = $dbr-&gt;quote($req-&gt;{&#39;month&#39;});</td></tr>
<tr><td class="h">1994</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $qday = $dbr-&gt;quote($req-&gt;{&#39;day&#39;});</td></tr>
<tr><td class="h">1995</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where = &quot;AND year=$qyear AND month=$qmonth AND day=$qday&quot;;</td></tr>
<tr><td class="h">1996</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$limit = &quot;LIMIT 200&quot;;  # FIXME: unhardcode this constant (also in ljviews.pl)</td></tr>
<tr><td class="h">1997</td><td colspan="7"></td></tr><tr><td class="h">1998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# see note above about why the sort order is different</td></tr>
<tr><td class="h">1999</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L1999">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$orderby = $is_community ? &quot;ORDER BY logtime&quot; : &quot;ORDER BY eventtime&quot;;</td></tr>
<tr><td class="h">2000</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;elsif ($req-&gt;{&#39;selecttype&#39;} eq &quot;lastn&quot;)</td></tr>
<tr><td class="h">2002</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2003</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2003">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $howmany = $req-&gt;{&#39;howmany&#39;} || 20;</td></tr>
<tr><td class="h">2004</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2004">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($howmany &gt; 50) { $howmany = 50; }</td></tr>
<tr><td class="h">2005</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$howmany = $howmany + 0;</td></tr>
<tr><td class="h">2006</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$limit = &quot;LIMIT $howmany&quot;;</td></tr>
<tr><td class="h">2007</td><td colspan="7"></td></tr><tr><td class="h">2008</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# okay, follow me here... see how we add the revttime predicate</td></tr>
<tr><td class="h">2009</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# even if no beforedate key is present?  you&#39;re probably saying,</td></tr>
<tr><td class="h">2010</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# that&#39;s retarded -- you&#39;re saying: &quot;revttime &gt; 0&quot;, that&#39;s like</td></tr>
<tr><td class="h">2011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# saying, &quot;if entry occurred at all.&quot;  yes yes, but that hints</td></tr>
<tr><td class="h">2012</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# mysql&#39;s braindead optimizer to use the right index.</td></tr>
<tr><td class="h">2013</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rtime_after = 0;</td></tr>
<tr><td class="h">2014</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2014">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rtime_what = $is_community ? &quot;rlogtime&quot; : &quot;revttime&quot;;</td></tr>
<tr><td class="h">2015</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2015">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;beforedate&#39;}) {</td></tr>
<tr><td class="h">2016</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2016">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Invalid beforedate format.&quot;)</td></tr>
<tr><td class="h">2017</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($req-&gt;{&#39;beforedate&#39;} =~</td></tr>
<tr><td class="h">2018</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d$/);</td></tr>
<tr><td class="h">2019</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $qd = $dbr-&gt;quote($req-&gt;{&#39;beforedate&#39;});</td></tr>
<tr><td class="h">2020</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rtime_after = &quot;$LJ::EndOfTime-UNIX_TIMESTAMP($qd)&quot;;</td></tr>
<tr><td class="h">2021</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2022</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where .= &quot;AND $rtime_what &gt; $rtime_after &quot;;</td></tr>
<tr><td class="h">2023</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$orderby = &quot;ORDER BY $rtime_what&quot;;</td></tr>
<tr><td class="h">2024</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2025</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;elsif ($req-&gt;{&#39;selecttype&#39;} eq &quot;one&quot;)</td></tr>
<tr><td class="h">2026</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2027</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = $req-&gt;{&#39;itemid&#39;} + 0;</td></tr>
<tr><td class="h">2028</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where = &quot;AND jitemid=$id&quot;;</td></tr>
<tr><td class="h">2029</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2030</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;elsif ($req-&gt;{&#39;selecttype&#39;} eq &quot;syncitems&quot;)</td></tr>
<tr><td class="h">2031</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2032</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2032">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,506) unless LJ::is_enabled(&#39;syncitems&#39;);</td></tr>
<tr><td class="h">2033</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2033">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $date = $req-&gt;{&#39;lastsync&#39;} || &quot;0000-00-00 00:00:00&quot;;</td></tr>
<tr><td class="h">2034</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2034">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Invalid syncitems date format&quot;)</td></tr>
<tr><td class="h">2035</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($date =~ /^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d/);</td></tr>
<tr><td class="h">2036</td><td colspan="7"></td></tr><tr><td class="h">2037</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $now = time();</td></tr>
<tr><td class="h">2038</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# broken client loop prevention</td></tr>
<tr><td class="h">2039</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2039">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;lastsync&#39;}) {</td></tr>
<tr><td class="h">2040</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pname = &quot;rl_syncitems_getevents_loop&quot;;</td></tr>
<tr><td class="h">2041</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props($u, $pname);</td></tr>
<tr><td class="h">2042</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# format is:  time/date/time/date/time/date/... so split</td></tr>
<tr><td class="h">2043</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# it into a hash, then delete pairs that are older than an hour</td></tr>
<tr><td class="h">2044</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %reqs = split(m!/!, $u-&gt;{$pname});</td></tr>
<tr><td class="h">2045</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (grep { $_ &lt; $now - 60*60 } keys %reqs) { delete $reqs{$_}; }</td></tr>
<tr><td class="h">2046</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $count = grep { $_ eq $date } values %reqs;</td></tr>
<tr><td class="h">2047</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$reqs{$now} = $date;</td></tr>
<tr><td class="h">2048</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2048">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($count &gt;= 2) {</td></tr>
<tr><td class="h">2049</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# 2 prior, plus this one = 3 repeated requests for same synctime.</td></tr>
<tr><td class="h">2050</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# their client is busted.  (doesn&#39;t understand syncitems semantics)</td></tr>
<tr><td class="h">2051</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,406);</td></tr>
<tr><td class="h">2052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2053</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_userprop($u, $pname,</td></tr>
<tr><td class="h">2054</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;join(&#39;/&#39;, map { $_, $reqs{$_} }</td></tr>
<tr><td class="h">2055</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort { $b &lt;=&gt; $a } keys %reqs));</td></tr>
<tr><td class="h">2056</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2057</td><td colspan="7"></td></tr><tr><td class="h">2058</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %item;</td></tr>
<tr><td class="h">2059</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $dbcr-&gt;prepare(&quot;SELECT jitemid, logtime FROM log2 WHERE &quot;.</td></tr>
<tr><td class="h">2060</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;journalid=? and logtime &gt; ?&quot;);</td></tr>
<tr><td class="h">2061</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($ownerid, $date);</td></tr>
<tr><td class="h">2062</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($id, $dt) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">2063</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item{$id} = $dt;</td></tr>
<tr><td class="h">2064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2065</td><td colspan="7"></td></tr><tr><td class="h">2066</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p_revtime = LJ::get_prop(&quot;log&quot;, &quot;revtime&quot;);</td></tr>
<tr><td class="h">2067</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $dbcr-&gt;prepare(&quot;SELECT jitemid, FROM_UNIXTIME(value) &quot;.</td></tr>
<tr><td class="h">2068</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM logprop2 WHERE journalid=? &quot;.</td></tr>
<tr><td class="h">2069</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND propid=$p_revtime-&gt;{&#39;id&#39;} &quot;.</td></tr>
<tr><td class="h">2070</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND value+0 &gt; UNIX_TIMESTAMP(?)&quot;);</td></tr>
<tr><td class="h">2071</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($ownerid, $date);</td></tr>
<tr><td class="h">2072</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($id, $dt) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">2073</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item{$id} = $dt;</td></tr>
<tr><td class="h">2074</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2075</td><td colspan="7"></td></tr><tr><td class="h">2076</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $limit = 100;</td></tr>
<tr><td class="h">2077</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @ids = sort { $item{$a} cmp $item{$b} } keys %item;</td></tr>
<tr><td class="h">2078</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2078">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@ids &gt; $limit) { @ids = @ids[0..$limit-1]; }</td></tr>
<tr><td class="h">2079</td><td colspan="7"></td></tr><tr><td class="h">2080</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2080">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&#39;,&#39;, @ids) || &quot;0&quot;;</td></tr>
<tr><td class="h">2081</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where = &quot;AND jitemid IN ($in)&quot;;</td></tr>
<tr><td class="h">2082</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2083</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;elsif ($req-&gt;{&#39;selecttype&#39;} eq &quot;multiple&quot;)</td></tr>
<tr><td class="h">2084</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2085</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @ids;</td></tr>
<tr><td class="h">2086</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $num (split(/\s*,\s*/, $req-&gt;{&#39;itemids&#39;})) {</td></tr>
<tr><td class="h">2087</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2087">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Non-numeric itemid&quot;) unless $num =~ /^\d+$/;</td></tr>
<tr><td class="h">2088</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @ids, $num;</td></tr>
<tr><td class="h">2089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2090</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $limit = 100;</td></tr>
<tr><td class="h">2091</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2091">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,209,&quot;Can&#39;t retrieve more than $limit entries at once&quot;) if @ids &gt; $limit;</td></tr>
<tr><td class="h">2092</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&#39;,&#39;, @ids);</td></tr>
<tr><td class="h">2093</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where = &quot;AND jitemid IN ($in)&quot;;</td></tr>
<tr><td class="h">2094</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2095</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;else</td></tr>
<tr><td class="h">2096</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2097</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,200,&quot;Invalid selecttype.&quot;);</td></tr>
<tr><td class="h">2098</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2099</td><td colspan="7"></td></tr><tr><td class="h">2100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# common SQL template:</td></tr>
<tr><td class="h">2101</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2101">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($sql) {</td></tr>
<tr><td class="h">2102</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql = &quot;SELECT jitemid, eventtime, security, allowmask, anum, posterid &quot;.</td></tr>
<tr><td class="h">2103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM log2 WHERE journalid=$ownerid $where $orderby $limit&quot;;</td></tr>
<tr><td class="h">2104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2105</td><td colspan="7"></td></tr><tr><td class="h">2106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# whatever selecttype might have wanted us to use the master db.</td></tr>
<tr><td class="h">2107</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2107">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbcr = LJ::get_cluster_def_reader($uowner) if $use_master;</td></tr>
<tr><td class="h">2108</td><td colspan="7"></td></tr><tr><td class="h">2109</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2109">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,502) unless $dbcr;</td></tr>
<tr><td class="h">2110</td><td colspan="7"></td></tr><tr><td class="h">2111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## load the log rows</td></tr>
<tr><td class="h">2112</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;($sth = $dbcr-&gt;prepare($sql))-&gt;execute;</td></tr>
<tr><td class="h">2113</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2113">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,501,$dbcr-&gt;errstr) if $dbcr-&gt;err;</td></tr>
<tr><td class="h">2114</td><td colspan="7"></td></tr><tr><td class="h">2115</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = 0;</td></tr>
<tr><td class="h">2116</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @itemids = ();</td></tr>
<tr><td class="h">2117</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">2118</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $events = $res-&gt;{&#39;events&#39;} = [];</td></tr>
<tr><td class="h">2119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %evt_from_itemid;</td></tr>
<tr><td class="h">2120</td><td colspan="7"></td></tr><tr><td class="h">2121</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($itemid, $eventtime, $sec, $mask, $anum, $jposterid) = $sth-&gt;fetchrow_array)</td></tr>
<tr><td class="h">2122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2123</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$count++;</td></tr>
<tr><td class="h">2124</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $evt = {};</td></tr>
<tr><td class="h">2125</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;itemid&#39;} = $itemid;</td></tr>
<tr><td class="h">2126</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @itemids, $itemid;</td></tr>
<tr><td class="h">2127</td><td colspan="7"></td></tr><tr><td class="h">2128</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt_from_itemid{$itemid} = $evt;</td></tr>
<tr><td class="h">2129</td><td colspan="7"></td></tr><tr><td class="h">2130</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&quot;eventtime&quot;} = $eventtime;</td></tr>
<tr><td class="h">2131</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2131">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($sec ne &quot;public&quot;) {</td></tr>
<tr><td class="h">2132</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;security&#39;} = $sec;</td></tr>
<tr><td class="h">2133</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2133">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;allowmask&#39;} = $mask if $sec eq &quot;usemask&quot;;</td></tr>
<tr><td class="h">2134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2135</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;anum&#39;} = $anum;</td></tr>
<tr><td class="h">2136</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2136">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;poster&#39;} = LJ::get_username($dbr, $jposterid) if $jposterid != $ownerid;</td></tr>
<tr><td class="h">2137</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;url&#39;} = LJ::item_link($uowner, $itemid, $anum);</td></tr>
<tr><td class="h">2138</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$events, $evt;</td></tr>
<tr><td class="h">2139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2140</td><td colspan="7"></td></tr><tr><td class="h">2141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load properties. Even if the caller doesn&#39;t want them, we need</td></tr>
<tr><td class="h">2142</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# them in Unicode installations to recognize older 8bit non-UF-8</td></tr>
<tr><td class="h">2143</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# entries.</td></tr>
<tr><td class="h">2144</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2144">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2144">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($req-&gt;{&#39;noprops&#39;} &amp;&amp; !$LJ::UNICODE)</td></tr>
<tr><td class="h">2145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;### do the properties now</td></tr>
<tr><td class="h">2147</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$count = 0;</td></tr>
<tr><td class="h">2148</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %props = ();</td></tr>
<tr><td class="h">2149</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_log_props2($dbcr, $ownerid, \@itemids, \%props);</td></tr>
<tr><td class="h">2150</td><td colspan="7"></td></tr><tr><td class="h">2151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# load the tags for these entries, unless told not to</td></tr>
<tr><td class="h">2152</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2152">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($req-&gt;{notags}) {</td></tr>
<tr><td class="h">2153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# construct %idsbycluster for the multi call to get these tags</td></tr>
<tr><td class="h">2154</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tags = LJ::Tags::get_logtags($uowner, \@itemids);</td></tr>
<tr><td class="h">2155</td><td colspan="7"></td></tr><tr><td class="h">2156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# add to props</td></tr>
<tr><td class="h">2157</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $itemid (@itemids) {</td></tr>
<tr><td class="h">2158</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2158">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $tags-&gt;{$itemid};</td></tr>
<tr><td class="h">2159</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$props{$itemid}-&gt;{taglist} = join(&#39;, &#39;, values %{$tags-&gt;{$itemid}});</td></tr>
<tr><td class="h">2160</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2162</td><td colspan="7"></td></tr><tr><td class="h">2163</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $itemid (keys %props) {</td></tr>
<tr><td class="h">2164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &#39;replycount&#39; is a pseudo-prop, don&#39;t send it.</td></tr>
<tr><td class="h">2165</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this goes away after we restructure APIs and</td></tr>
<tr><td class="h">2166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# replycounts cease being transferred in props</td></tr>
<tr><td class="h">2167</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $props{$itemid}-&gt;{&#39;replycount&#39;};</td></tr>
<tr><td class="h">2168</td><td colspan="7"></td></tr><tr><td class="h">2169</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $evt = $evt_from_itemid{$itemid};</td></tr>
<tr><td class="h">2170</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;props&#39;} = {};</td></tr>
<tr><td class="h">2171</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $name (keys %{$props{$itemid}}) {</td></tr>
<tr><td class="h">2172</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $value = $props{$itemid}-&gt;{$name};</td></tr>
<tr><td class="h">2173</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value =~ s/\n/ /g;</td></tr>
<tr><td class="h">2174</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;props&#39;}-&gt;{$name} = $value;</td></tr>
<tr><td class="h">2175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2176</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2177</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2178</td><td colspan="7"></td></tr><tr><td class="h">2179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## load the text</td></tr>
<tr><td class="h">2180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $text = LJ::cond_no_cache($use_master, sub {</td></tr>
<tr><td class="h">2181</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2181">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::get_logtext2($uowner, @itemids);</td></tr>
<tr><td class="h">2182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">2183</td><td colspan="7"></td></tr><tr><td class="h">2184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $i (@itemids)</td></tr>
<tr><td class="h">2185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2186</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $t = $text-&gt;{$i};</td></tr>
<tr><td class="h">2187</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $evt = $evt_from_itemid{$i};</td></tr>
<tr><td class="h">2188</td><td colspan="7"></td></tr><tr><td class="h">2189</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if they want subjects to be events, replace event</td></tr>
<tr><td class="h">2190</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# with subject when requested.</td></tr>
<tr><td class="h">2191</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2191">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2191">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;prefersubject&#39;} &amp;&amp; length($t-&gt;[0])) {</td></tr>
<tr><td class="h">2192</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] = $t-&gt;[0];  # event = subject</td></tr>
<tr><td class="h">2193</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[0] = undef;    # subject = undef</td></tr>
<tr><td class="h">2194</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2195</td><td colspan="7"></td></tr><tr><td class="h">2196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# now that we have the subject, the event and the props,</td></tr>
<tr><td class="h">2197</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# auto-translate them to UTF-8 if they&#39;re not in UTF-8.</td></tr>
<tr><td class="h">2198</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2198">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2198">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $req-&gt;{&#39;ver&#39;} &gt;= 1 &amp;&amp;</td></tr>
<tr><td class="h">2199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;props&#39;}-&gt;{&#39;unknown8bit&#39;}) {</td></tr>
<tr><td class="h">2200</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $error = 0;</td></tr>
<tr><td class="h">2201</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[0] = LJ::text_convert($t-&gt;[0], $uowner, \$error);</td></tr>
<tr><td class="h">2202</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] = LJ::text_convert($t-&gt;[1], $uowner, \$error);</td></tr>
<tr><td class="h">2203</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %{$evt-&gt;{&#39;props&#39;}}) {</td></tr>
<tr><td class="h">2204</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;props&#39;}-&gt;{$_} = LJ::text_convert($evt-&gt;{&#39;props&#39;}-&gt;{$_}, $uowner, \$error);</td></tr>
<tr><td class="h">2205</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2206</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2206">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,208,&quot;Cannot display this post.&quot;)</td></tr>
<tr><td class="h">2207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $error;</td></tr>
<tr><td class="h">2208</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2209</td><td colspan="7"></td></tr><tr><td class="h">2210</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2210">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2210">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::UNICODE &amp;&amp; $req-&gt;{&#39;ver&#39;} &lt; 1 &amp;&amp; !$evt-&gt;{&#39;props&#39;}-&gt;{&#39;unknown8bit&#39;}) {</td></tr>
<tr><td class="h">2211</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2211">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2211">0</a></div></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ( LJ::is_ascii($t-&gt;[0]) &amp;&amp;</td></tr>
<tr><td class="h">2212</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::is_ascii($t-&gt;[1]) &amp;&amp;</td></tr>
<tr><td class="h">2213</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::is_ascii(join(&#39; &#39;, values %{$evt-&gt;{&#39;props&#39;}}) )) {</td></tr>
<tr><td class="h">2214</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we want to fail the client that wants to get this entry</td></tr>
<tr><td class="h">2215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# but we make an exception for selecttype=day, in order to allow at least</td></tr>
<tr><td class="h">2216</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# viewing the daily summary</td></tr>
<tr><td class="h">2217</td><td colspan="7"></td></tr><tr><td class="h">2218</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2218">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;selecttype&#39;} eq &#39;day&#39;) {</td></tr>
<tr><td class="h">2219</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[0] = $t-&gt;[1] = $CannotBeShown;</td></tr>
<tr><td class="h">2220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2221</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,207,&quot;Cannot display/edit a Unicode post with a non-Unicode client. Please see $LJ::SITEROOT/support/encodings for more information.&quot;);</td></tr>
<tr><td class="h">2222</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2223</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2224</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2225</td><td colspan="7"></td></tr><tr><td class="h">2226</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2226">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($t-&gt;[0]) {</td></tr>
<tr><td class="h">2227</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[0] =~ s/[\r\n]/ /g;</td></tr>
<tr><td class="h">2228</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;subject&#39;} = $t-&gt;[0];</td></tr>
<tr><td class="h">2229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2230</td><td colspan="7"></td></tr><tr><td class="h">2231</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# truncate</td></tr>
<tr><td class="h">2232</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2232">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;truncate&#39;} &gt;= 4) {</td></tr>
<tr><td class="h">2233</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $original = $t-&gt;[1];</td></tr>
<tr><td class="h">2234</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2234">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;ver&#39;} &gt; 1) {</td></tr>
<tr><td class="h">2235</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] = LJ::text_trim($t-&gt;[1], $req-&gt;{&#39;truncate&#39;} - 3, 0);</td></tr>
<tr><td class="h">2236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2237</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] = LJ::text_trim($t-&gt;[1], 0, $req-&gt;{&#39;truncate&#39;} - 3);</td></tr>
<tr><td class="h">2238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2239</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# only append the elipsis if the text was actually truncated</td></tr>
<tr><td class="h">2240</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2240">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] .= &quot;...&quot; if $t-&gt;[1] ne $original;</td></tr>
<tr><td class="h">2241</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2242</td><td colspan="7"></td></tr><tr><td class="h">2243</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# line endings</td></tr>
<tr><td class="h">2244</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] =~ s/\r//g;</td></tr>
<tr><td class="h">2245</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2245">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2245">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2245">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2245">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;lineendings&#39;} eq &quot;unix&quot;) {</td></tr>
<tr><td class="h">2246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# do nothing.  native format.</td></tr>
<tr><td class="h">2247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($req-&gt;{&#39;lineendings&#39;} eq &quot;mac&quot;) {</td></tr>
<tr><td class="h">2248</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] =~ s/\n/\r/g;</td></tr>
<tr><td class="h">2249</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($req-&gt;{&#39;lineendings&#39;} eq &quot;space&quot;) {</td></tr>
<tr><td class="h">2250</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] =~ s/\n/ /g;</td></tr>
<tr><td class="h">2251</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($req-&gt;{&#39;lineendings&#39;} eq &quot;dots&quot;) {</td></tr>
<tr><td class="h">2252</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] =~ s/\n/ ... /g;</td></tr>
<tr><td class="h">2253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else { # &quot;pc&quot; -- default</td></tr>
<tr><td class="h">2254</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t-&gt;[1] =~ s/\n/\r\n/g;</td></tr>
<tr><td class="h">2255</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2256</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$evt-&gt;{&#39;event&#39;} = $t-&gt;[1];</td></tr>
<tr><td class="h">2257</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2258</td><td colspan="7"></td></tr><tr><td class="h">2259</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# maybe we don&#39;t need the props after all</td></tr>
<tr><td class="h">2260</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2260">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;noprops&#39;}) {</td></tr>
<tr><td class="h">2261</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(@$events) { delete $_-&gt;{&#39;props&#39;}; }</td></tr>
<tr><td class="h">2262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2263</td><td colspan="7"></td></tr><tr><td class="h">2264</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">2265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2266</td><td colspan="7"></td></tr><tr><td class="h">2267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># deprecated</td></tr>
<tr><td class="h">2268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub editfriends {</td></tr>
<tr><td class="h">2269</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2269">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail( $_[1], 504 );</td></tr>
<tr><td class="h">2270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2271</td><td colspan="7"></td></tr><tr><td class="h">2272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># deprecated</td></tr>
<tr><td class="h">2273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub editfriendgroups {</td></tr>
<tr><td class="h">2274</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2274">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail( $_[1], 504 );</td></tr>
<tr><td class="h">2275</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2276</td><td colspan="7"></td></tr><tr><td class="h">2277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub sessionexpire {</td></tr>
<tr><td class="h">2278</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2278">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">2279</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2279">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">2280</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{u};</td></tr>
<tr><td class="h">2281</td><td colspan="7"></td></tr><tr><td class="h">2282</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# expunge one? or all?</td></tr>
<tr><td class="h">2283</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2283">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{expireall}) {</td></tr>
<tr><td class="h">2284</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;kill_all_sessions;</td></tr>
<tr><td class="h">2285</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return {};</td></tr>
<tr><td class="h">2286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2287</td><td colspan="7"></td></tr><tr><td class="h">2288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# just expire a list</td></tr>
<tr><td class="h">2289</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2289">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $list = $req-&gt;{expire} || [];</td></tr>
<tr><td class="h">2290</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2290">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {} unless @$list;</td></tr>
<tr><td class="h">2291</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2291">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,502) unless $u-&gt;writer;</td></tr>
<tr><td class="h">2292</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;kill_sessions(@$list);</td></tr>
<tr><td class="h">2293</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {};</td></tr>
<tr><td class="h">2294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2295</td><td colspan="7"></td></tr><tr><td class="h">2296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub sessiongenerate {</td></tr>
<tr><td class="h">2297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# generate a session</td></tr>
<tr><td class="h">2298</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2298">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">2299</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2299">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">2300</td><td colspan="7"></td></tr><tr><td class="h">2301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# sanitize input</td></tr>
<tr><td class="h">2302</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2302">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{expiration} = &#39;short&#39; unless $req-&gt;{expiration} eq &#39;long&#39;;</td></tr>
<tr><td class="h">2303</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $boundip;</td></tr>
<tr><td class="h">2304</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2304">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$boundip = LJ::get_remote_ip() if $req-&gt;{bindtoip};</td></tr>
<tr><td class="h">2305</td><td colspan="7"></td></tr><tr><td class="h">2306</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{u};</td></tr>
<tr><td class="h">2307</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sess_opts = {</td></tr>
<tr><td class="h">2308</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exptype =&gt; $req-&gt;{expiration},</td></tr>
<tr><td class="h">2309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ipfixed =&gt; $boundip,</td></tr>
<tr><td class="h">2310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2311</td><td colspan="7"></td></tr><tr><td class="h">2312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do not let locked people do this</td></tr>
<tr><td class="h">2313</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2313">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err, 308) if $u-&gt;is_locked;</td></tr>
<tr><td class="h">2314</td><td colspan="7"></td></tr><tr><td class="h">2315</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sess = LJ::Session-&gt;create($u, %$sess_opts);</td></tr>
<tr><td class="h">2316</td><td colspan="7"></td></tr><tr><td class="h">2317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return our hash</td></tr>
<tr><td class="h">2318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {</td></tr>
<tr><td class="h">2319</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ljsession =&gt; $sess-&gt;master_cookie_string,</td></tr>
<tr><td class="h">2320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2321</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2322</td><td colspan="7"></td></tr><tr><td class="h">2323</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub list_friends</td></tr>
<tr><td class="h">2324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2325</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2325">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $opts) = @_;</td></tr>
<tr><td class="h">2326</td><td colspan="7"></td></tr><tr><td class="h">2327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do not show people in here</td></tr>
<tr><td class="h">2328</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %hide;  # userid -&gt; 1</td></tr>
<tr><td class="h">2329</td><td colspan="7"></td></tr><tr><td class="h">2330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TAG:FR:protocol:list_friends</td></tr>
<tr><td class="h">2331</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sql;</td></tr>
<tr><td class="h">2332</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2332">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{&#39;friendof&#39;}) {</td></tr>
<tr><td class="h">2333</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql = &quot;SELECT friendid, fgcolor, bgcolor, groupmask FROM friends WHERE userid=?&quot;;</td></tr>
<tr><td class="h">2334</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2335</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql = &quot;SELECT userid FROM friends WHERE friendid=?&quot;;</td></tr>
<tr><td class="h">2336</td><td colspan="7"></td></tr><tr><td class="h">2337</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2337">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $list = LJ::load_rel_user($u, &#39;B&#39;)) {</td></tr>
<tr><td class="h">2338</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hide{$_} = 1 foreach @$list;</td></tr>
<tr><td class="h">2339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2341</td><td colspan="7"></td></tr><tr><td class="h">2342</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">2343</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbr-&gt;prepare($sql);</td></tr>
<tr><td class="h">2344</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($u-&gt;{&#39;userid&#39;});</td></tr>
<tr><td class="h">2345</td><td colspan="7"></td></tr><tr><td class="h">2346</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @frow;</td></tr>
<tr><td class="h">2347</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my @row = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">2348</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2348">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $hide{$row[0]};</td></tr>
<tr><td class="h">2349</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @frow, [ @row ];</td></tr>
<tr><td class="h">2350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2351</td><td colspan="7"></td></tr><tr><td class="h">2352</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $us = LJ::load_userids(map { $_-&gt;[0] } @frow);</td></tr>
<tr><td class="h">2353</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $limitnum = $opts-&gt;{&#39;limit&#39;}+0;</td></tr>
<tr><td class="h">2354</td><td colspan="7"></td></tr><tr><td class="h">2355</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = [];</td></tr>
<tr><td class="h">2356</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $f (sort { $us-&gt;{$a-&gt;[0]}{&#39;user&#39;} cmp $us-&gt;{$b-&gt;[0]}{&#39;user&#39;} }</td></tr>
<tr><td class="h">2357</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { $us-&gt;{$_-&gt;[0]} } @frow)</td></tr>
<tr><td class="h">2358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2359</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = $us-&gt;{$f-&gt;[0]};</td></tr>
<tr><td class="h">2360</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2360">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2360">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $opts-&gt;{&#39;friendof&#39;} &amp;&amp; ! $u-&gt;is_visible;</td></tr>
<tr><td class="h">2361</td><td colspan="7"></td></tr><tr><td class="h">2362</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $r = {</td></tr>
<tr><td class="h">2363</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;username&#39; =&gt; $u-&gt;{&#39;user&#39;},</td></tr>
<tr><td class="h">2364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fullname&#39; =&gt; $u-&gt;{&#39;name&#39;},</td></tr>
<tr><td class="h">2365</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2366</td><td colspan="7"></td></tr><tr><td class="h">2367</td><td colspan="7"></td></tr><tr><td class="h">2368</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2368">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;identity) {</td></tr>
<tr><td class="h">2369</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $i = $u-&gt;identity;</td></tr>
<tr><td class="h">2370</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;identity_type&#39;} = $i-&gt;pretty_type;</td></tr>
<tr><td class="h">2371</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;identity_value&#39;} = $i-&gt;value;</td></tr>
<tr><td class="h">2372</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;identity_display&#39;} = $u-&gt;display_name;</td></tr>
<tr><td class="h">2373</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2374</td><td colspan="7"></td></tr><tr><td class="h">2375</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2375">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2375">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;includebdays&#39;} &amp;&amp;</td></tr>
<tr><td class="h">2376</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{&#39;bdate&#39;} &amp;&amp;</td></tr>
<tr><td class="h">2377</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{&#39;bdate&#39;} ne &quot;0000-00-00&quot; &amp;&amp;</td></tr>
<tr><td class="h">2378</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;can_show_full_bday)</td></tr>
<tr><td class="h">2379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2380</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;birthday&#39;} = $u-&gt;{&#39;bdate&#39;};</td></tr>
<tr><td class="h">2381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2382</td><td colspan="7"></td></tr><tr><td class="h">2383</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2383">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{&#39;friendof&#39;}) {</td></tr>
<tr><td class="h">2384</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;fgcolor&#39;} = LJ::color_fromdb($f-&gt;[1]);</td></tr>
<tr><td class="h">2385</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;bgcolor&#39;} = LJ::color_fromdb($f-&gt;[2]);</td></tr>
<tr><td class="h">2386</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2386">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&quot;groupmask&quot;} = $f-&gt;[3] if $f-&gt;[3] != 1;</td></tr>
<tr><td class="h">2387</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2388</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;fgcolor&#39;} = &quot;#000000&quot;;</td></tr>
<tr><td class="h">2389</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&#39;bgcolor&#39;} = &quot;#ffffff&quot;;</td></tr>
<tr><td class="h">2390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2391</td><td colspan="7"></td></tr><tr><td class="h">2392</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2392">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&quot;type&quot;} = {</td></tr>
<tr><td class="h">2393</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;C&#39; =&gt; &#39;community&#39;,</td></tr>
<tr><td class="h">2394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Y&#39; =&gt; &#39;syndicated&#39;,</td></tr>
<tr><td class="h">2395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;I&#39; =&gt; &#39;identity&#39;,</td></tr>
<tr><td class="h">2396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}-&gt;{$u-&gt;journaltype} unless $u-&gt;is_person;</td></tr>
<tr><td class="h">2397</td><td colspan="7"></td></tr><tr><td class="h">2398</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2398">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;{&quot;status&quot;} = {</td></tr>
<tr><td class="h">2399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;D&#39; =&gt; &quot;deleted&quot;,</td></tr>
<tr><td class="h">2400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;S&#39; =&gt; &quot;suspended&quot;,</td></tr>
<tr><td class="h">2401</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;X&#39; =&gt; &quot;purged&quot;,</td></tr>
<tr><td class="h">2402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}-&gt;{$u-&gt;statusvis} unless $u-&gt;is_visible;</td></tr>
<tr><td class="h">2403</td><td colspan="7"></td></tr><tr><td class="h">2404</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$res, $r;</td></tr>
<tr><td class="h">2405</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# won&#39;t happen for zero limit (which means no limit)</td></tr>
<tr><td class="h">2406</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2406">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if @$res == $limitnum;</td></tr>
<tr><td class="h">2407</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2408</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">2409</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2410</td><td colspan="7"></td></tr><tr><td class="h">2411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub syncitems</td></tr>
<tr><td class="h">2412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2413</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2413">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">2414</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2414">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">2415</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2415">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless check_altusage($req, $err, $flags);</td></tr>
<tr><td class="h">2416</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2416">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,506) unless LJ::is_enabled(&#39;syncitems&#39;);</td></tr>
<tr><td class="h">2417</td><td colspan="7"></td></tr><tr><td class="h">2418</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ownerid = $flags-&gt;{&#39;ownerid&#39;};</td></tr>
<tr><td class="h">2419</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2419">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uowner = $flags-&gt;{&#39;u_owner&#39;} || $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">2420</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth;</td></tr>
<tr><td class="h">2421</td><td colspan="7"></td></tr><tr><td class="h">2422</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db = LJ::get_cluster_reader($uowner);</td></tr>
<tr><td class="h">2423</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2423">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,502) unless $db;</td></tr>
<tr><td class="h">2424</td><td colspan="7"></td></tr><tr><td class="h">2425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## have a valid date?</td></tr>
<tr><td class="h">2426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $date = $req-&gt;{&#39;lastsync&#39;};</td></tr>
<tr><td class="h">2427</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2427">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($date) {</td></tr>
<tr><td class="h">2428</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2428">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,203,&quot;Invalid date format&quot;)</td></tr>
<tr><td class="h">2429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($date =~ /^\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d/);</td></tr>
<tr><td class="h">2430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2431</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$date = &quot;0000-00-00 00:00:00&quot;;</td></tr>
<tr><td class="h">2432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2433</td><td colspan="7"></td></tr><tr><td class="h">2434</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $LIMIT = 500;</td></tr>
<tr><td class="h">2435</td><td colspan="7"></td></tr><tr><td class="h">2436</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %item;</td></tr>
<tr><td class="h">2437</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth = $db-&gt;prepare(&quot;SELECT jitemid, logtime FROM log2 WHERE &quot;.</td></tr>
<tr><td class="h">2438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;journalid=? and logtime &gt; ?&quot;);</td></tr>
<tr><td class="h">2439</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($ownerid, $date);</td></tr>
<tr><td class="h">2440</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($id, $dt) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">2441</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item{$id} = [ &#39;L&#39;, $id, $dt, &quot;create&quot; ];</td></tr>
<tr><td class="h">2442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2443</td><td colspan="7"></td></tr><tr><td class="h">2444</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %cmt;</td></tr>
<tr><td class="h">2445</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $p_calter = LJ::get_prop(&quot;log&quot;, &quot;commentalter&quot;);</td></tr>
<tr><td class="h">2446</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $p_revtime = LJ::get_prop(&quot;log&quot;, &quot;revtime&quot;);</td></tr>
<tr><td class="h">2447</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth = $db-&gt;prepare(&quot;SELECT jitemid, propid, FROM_UNIXTIME(value) &quot;.</td></tr>
<tr><td class="h">2448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM logprop2 WHERE journalid=? &quot;.</td></tr>
<tr><td class="h">2449</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND propid IN ($p_calter-&gt;{&#39;id&#39;}, $p_revtime-&gt;{&#39;id&#39;}) &quot;.</td></tr>
<tr><td class="h">2450</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND value+0 &gt; UNIX_TIMESTAMP(?)&quot;);</td></tr>
<tr><td class="h">2451</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($ownerid, $date);</td></tr>
<tr><td class="h">2452</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($id, $prop, $dt) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">2453</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2453">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2453">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($prop == $p_calter-&gt;{&#39;id&#39;}) {</td></tr>
<tr><td class="h">2454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cmt{$id} = [ &#39;C&#39;, $id, $dt, &quot;update&quot; ];</td></tr>
<tr><td class="h">2455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($prop == $p_revtime-&gt;{&#39;id&#39;}) {</td></tr>
<tr><td class="h">2456</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item{$id} = [ &#39;L&#39;, $id, $dt, &quot;update&quot; ];</td></tr>
<tr><td class="h">2457</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2458</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2459</td><td colspan="7"></td></tr><tr><td class="h">2460</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @ev = sort { $a-&gt;[2] cmp $b-&gt;[2] } (values %item, values %cmt);</td></tr>
<tr><td class="h">2461</td><td colspan="7"></td></tr><tr><td class="h">2462</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">2463</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $list = $res-&gt;{&#39;syncitems&#39;} = [];</td></tr>
<tr><td class="h">2464</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;total&#39;} = scalar @ev;</td></tr>
<tr><td class="h">2465</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ct = 0;</td></tr>
<tr><td class="h">2466</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my $ev = shift @ev) {</td></tr>
<tr><td class="h">2467</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ct++;</td></tr>
<tr><td class="h">2468</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$list, { &#39;item&#39; =&gt; &quot;$ev-&gt;[0]-$ev-&gt;[1]&quot;,</td></tr>
<tr><td class="h">2469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;time&#39; =&gt; $ev-&gt;[2],</td></tr>
<tr><td class="h">2470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; =&gt; $ev-&gt;[3],  };</td></tr>
<tr><td class="h">2471</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2471">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $ct &gt;= $LIMIT;</td></tr>
<tr><td class="h">2472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2473</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;count&#39;} = $ct;</td></tr>
<tr><td class="h">2474</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">2475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2476</td><td colspan="7"></td></tr><tr><td class="h">2477</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub consolecommand</td></tr>
<tr><td class="h">2478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2479</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2479">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">2480</td><td colspan="7"></td></tr><tr><td class="h">2481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# logging in isn&#39;t necessary, but most console commands do require it</td></tr>
<tr><td class="h">2482</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2482">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_remote($flags-&gt;{&#39;u&#39;}) if authenticate($req, $err, $flags);</td></tr>
<tr><td class="h">2483</td><td colspan="7"></td></tr><tr><td class="h">2484</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">2485</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cmdout = $res-&gt;{&#39;results&#39;} = [];</td></tr>
<tr><td class="h">2486</td><td colspan="7"></td></tr><tr><td class="h">2487</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $cmd (@{$req-&gt;{&#39;commands&#39;}}) {</td></tr>
<tr><td class="h">2488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# callee can pre-parse the args, or we can do it bash-style</td></tr>
<tr><td class="h">2489</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2489">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @args = ref $cmd eq &quot;ARRAY&quot; ? @$cmd</td></tr>
<tr><td class="h">2490</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: LJ::Console-&gt;parse_line($cmd);</td></tr>
<tr><td class="h">2491</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $c = LJ::Console-&gt;parse_array(@args);</td></tr>
<tr><td class="h">2492</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $c-&gt;execute_safely;</td></tr>
<tr><td class="h">2493</td><td colspan="7"></td></tr><tr><td class="h">2494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @output;</td></tr>
<tr><td class="h">2495</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @output, [$_-&gt;status, $_-&gt;text] foreach $c-&gt;responses;</td></tr>
<tr><td class="h">2496</td><td colspan="7"></td></tr><tr><td class="h">2497</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$cmdout}, {</td></tr>
<tr><td class="h">2498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;success&#39; =&gt; $rv,</td></tr>
<tr><td class="h">2499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;output&#39; =&gt; \@output,</td></tr>
<tr><td class="h">2500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2502</td><td colspan="7"></td></tr><tr><td class="h">2503</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">2504</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2505</td><td colspan="7"></td></tr><tr><td class="h">2506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getchallenge</td></tr>
<tr><td class="h">2507</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2508</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2508">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">2509</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = {};</td></tr>
<tr><td class="h">2510</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now = time();</td></tr>
<tr><td class="h">2511</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $etime = 60;</td></tr>
<tr><td class="h">2512</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;challenge&#39;} = LJ::challenge_generate($etime);</td></tr>
<tr><td class="h">2513</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;server_time&#39;} = $now;</td></tr>
<tr><td class="h">2514</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;expire_time&#39;} = $now + $etime;</td></tr>
<tr><td class="h">2515</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;auth_scheme&#39;} = &quot;c0&quot;;  # fixed for now, might support others later</td></tr>
<tr><td class="h">2516</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">2517</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2518</td><td colspan="7"></td></tr><tr><td class="h">2519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub login_message</td></tr>
<tr><td class="h">2520</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2521</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2521">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">2522</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">2523</td><td colspan="7"></td></tr><tr><td class="h">2524</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $msg = sub {</td></tr>
<tr><td class="h">2525</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2525">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $code = shift;</td></tr>
<tr><td class="h">2526</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2526">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $args = shift || {};</td></tr>
<tr><td class="h">2527</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$args-&gt;{&#39;sitename&#39;} = $LJ::SITENAME;</td></tr>
<tr><td class="h">2528</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$args-&gt;{&#39;siteroot&#39;} = $LJ::SITEROOT;</td></tr>
<tr><td class="h">2529</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pre = delete $args-&gt;{&#39;pre&#39;};</td></tr>
<tr><td class="h">2530</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;message&#39;} = $pre . translate($u, $code, $args);</td></tr>
<tr><td class="h">2531</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2532</td><td colspan="7"></td></tr><tr><td class="h">2533</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2533">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $msg-&gt;(&quot;readonly&quot;)          if LJ::get_cap($u, &quot;readonly&quot;);</td></tr>
<tr><td class="h">2534</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2534">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2534">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $msg-&gt;(&quot;not_validated&quot;)     if ($u-&gt;{&#39;status&#39;} eq &quot;N&quot; and not $LJ::EVERYONE_VALID);</td></tr>
<tr><td class="h">2535</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2535">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2535">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $msg-&gt;(&quot;must_revalidate&quot;)   if ($u-&gt;{&#39;status&#39;} eq &quot;T&quot; and not $LJ::EVERYONE_VALID);</td></tr>
<tr><td class="h">2536</td><td colspan="7"></td></tr><tr><td class="h">2537</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $checkpass = LJ::CreatePage-&gt;verify_password( u =&gt; $u );</td></tr>
<tr><td class="h">2538</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2538">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $msg-&gt;(&quot;bad_password&quot;, { &#39;pre&#39; =&gt; &quot;$checkpass &quot; }) if $checkpass;</td></tr>
<tr><td class="h">2539</td><td colspan="7"></td></tr><tr><td class="h">2540</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2540">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $msg-&gt;(&quot;old_win32_client&quot;)  if $req-&gt;{&#39;clientversion&#39;} =~ /^Win32-MFC\/(1.2.[0123456])$/;</td></tr>
<tr><td class="h">2541</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2541">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $msg-&gt;(&quot;old_win32_client&quot;)  if $req-&gt;{&#39;clientversion&#39;} =~ /^Win32-MFC\/(1.3.[01234])\b/;</td></tr>
<tr><td class="h">2542</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2542">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $msg-&gt;(&quot;hello_test&quot;)        if grep { $u-&gt;{user} eq $_ } @LJ::TESTACCTS;</td></tr>
<tr><td class="h">2543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2544</td><td colspan="7"></td></tr><tr><td class="h">2545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub list_friendgroups</td></tr>
<tr><td class="h">2546</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2547</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2547">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2548</td><td colspan="7"></td></tr><tr><td class="h">2549</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    warn &quot;ljprotocol.pl: list_friendgroups called.\n&quot;;</td></tr>
<tr><td class="h">2550</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return [];</td></tr>
<tr><td class="h">2551</td><td colspan="7"></td></tr><tr><td class="h">2552</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># TODO(mark): this needs updating to determine if we should send trust groups?</td></tr>
<tr><td class="h">2553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             answer is yes, but we also need to move this to list_trustgroups</td></tr>
<tr><td class="h">2554</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             so clients don&#39;t think those are friend groups.</td></tr>
<tr><td class="h">2555</td><td colspan="7"></td></tr><tr><td class="h">2556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get the groups for this user, return undef if error</td></tr>
<tr><td class="h">2557</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $groups = LJ::get_friend_group($u);</td></tr>
<tr><td class="h">2558</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2558">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $groups;</td></tr>
<tr><td class="h">2559</td><td colspan="7"></td></tr><tr><td class="h">2560</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we got all of the groups, so put them into an arrayref sorted by the</td></tr>
<tr><td class="h">2561</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# group sortorder; also note that the map is used to construct a new hashref</td></tr>
<tr><td class="h">2562</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# out of the old group hashref so that we have all of the field names converted</td></tr>
<tr><td class="h">2563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# to a format our callers can recognize</td></tr>
<tr><td class="h">2564</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @res = map { { id =&gt; $_-&gt;{groupnum},      name =&gt; $_-&gt;{groupname},</td></tr>
<tr><td class="h">2565</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public =&gt; $_-&gt;{is_public}, sortorder =&gt; $_-&gt;{sortorder}, } }</td></tr>
<tr><td class="h">2566</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort { $a-&gt;{sortorder} &lt;=&gt; $b-&gt;{sortorder} }</td></tr>
<tr><td class="h">2567</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values %$groups;</td></tr>
<tr><td class="h">2568</td><td colspan="7"></td></tr><tr><td class="h">2569</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \@res;</td></tr>
<tr><td class="h">2570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2571</td><td colspan="7"></td></tr><tr><td class="h">2572</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub list_usejournals {</td></tr>
<tr><td class="h">2573</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2573">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2574</td><td colspan="7"></td></tr><tr><td class="h">2575</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @us = $u-&gt;posting_access_list;</td></tr>
<tr><td class="h">2576</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @unames = map { $_-&gt;{user} } @us;</td></tr>
<tr><td class="h">2577</td><td colspan="7"></td></tr><tr><td class="h">2578</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \@unames;</td></tr>
<tr><td class="h">2579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2580</td><td colspan="7"></td></tr><tr><td class="h">2581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub hash_menus</td></tr>
<tr><td class="h">2582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2583</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2583">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2584</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = $u-&gt;{&#39;user&#39;};</td></tr>
<tr><td class="h">2585</td><td colspan="7"></td></tr><tr><td class="h">2586</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $menu = [</td></tr>
<tr><td class="h">2587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;Recent Entries&quot;,</td></tr>
<tr><td class="h">2588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39; =&gt; &quot;$LJ::SITEROOT/users/$user/&quot;, },</td></tr>
<tr><td class="h">2589</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;Calendar View&quot;,</td></tr>
<tr><td class="h">2590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39; =&gt; &quot;$LJ::SITEROOT/users/$user/calendar&quot;, },</td></tr>
<tr><td class="h">2591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;Friends View&quot;,</td></tr>
<tr><td class="h">2592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39; =&gt; &quot;$LJ::SITEROOT/users/$user/read&quot;, },</td></tr>
<tr><td class="h">2593</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;-&quot;, },</td></tr>
<tr><td class="h">2594</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;Your Profile&quot;,</td></tr>
<tr><td class="h">2595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39; =&gt; &quot;$LJ::SITEROOT/userinfo?user=$user&quot;, },</td></tr>
<tr><td class="h">2596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;-&quot;, },</td></tr>
<tr><td class="h">2597</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;Change Settings&quot;,</td></tr>
<tr><td class="h">2598</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;sub&#39; =&gt; [ { &#39;text&#39; =&gt; &quot;Personal Info&quot;,</td></tr>
<tr><td class="h">2599</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39; =&gt; &quot;$LJ::SITEROOT/manage/profile/&quot;, },</td></tr>
<tr><td class="h">2600</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;Customize Journal&quot;,</td></tr>
<tr><td class="h">2601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39; =&gt;&quot;$LJ::SITEROOT/customize/&quot;, }, ] },</td></tr>
<tr><td class="h">2602</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;-&quot;, },</td></tr>
<tr><td class="h">2603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;text&#39; =&gt; &quot;Support&quot;,</td></tr>
<tr><td class="h">2604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39; =&gt; &quot;$LJ::SITEROOT/support/&quot;, }</td></tr>
<tr><td class="h">2605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];</td></tr>
<tr><td class="h">2606</td><td colspan="7"></td></tr><tr><td class="h">2607</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;modify_login_menu&quot;, {</td></tr>
<tr><td class="h">2608</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;menu&#39; =&gt; $menu,</td></tr>
<tr><td class="h">2609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;u&#39; =&gt; $u,</td></tr>
<tr><td class="h">2610</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;user&#39; =&gt; $user,</td></tr>
<tr><td class="h">2611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">2612</td><td colspan="7"></td></tr><tr><td class="h">2613</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $menu;</td></tr>
<tr><td class="h">2614</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2615</td><td colspan="7"></td></tr><tr><td class="h">2616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub list_pickws</td></tr>
<tr><td class="h">2617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2618</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2618">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2619</td><td colspan="7"></td></tr><tr><td class="h">2620</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pi = LJ::get_userpic_info($u);</td></tr>
<tr><td class="h">2621</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @res;</td></tr>
<tr><td class="h">2622</td><td colspan="7"></td></tr><tr><td class="h">2623</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %seen;  # mashifiedptr -&gt; 1</td></tr>
<tr><td class="h">2624</td><td colspan="7"></td></tr><tr><td class="h">2625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: should be a utf-8 sort</td></tr>
<tr><td class="h">2626</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $kw (sort keys %{$pi-&gt;{&#39;kw&#39;}}) {</td></tr>
<tr><td class="h">2627</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pic = $pi-&gt;{&#39;kw&#39;}{$kw};</td></tr>
<tr><td class="h">2628</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$seen{$pic} = 1;</td></tr>
<tr><td class="h">2629</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2629">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $pic-&gt;{&#39;state&#39;} eq &quot;I&quot;;</td></tr>
<tr><td class="h">2630</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @res, [ $kw, $pic-&gt;{&#39;picid&#39;} ];</td></tr>
<tr><td class="h">2631</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2632</td><td colspan="7"></td></tr><tr><td class="h">2633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now add all the pictures that don&#39;t have a keyword</td></tr>
<tr><td class="h">2634</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $picid (keys %{$pi-&gt;{&#39;pic&#39;}}) {</td></tr>
<tr><td class="h">2635</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pic = $pi-&gt;{&#39;pic&#39;}{$picid};</td></tr>
<tr><td class="h">2636</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2636">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $seen{$pic};</td></tr>
<tr><td class="h">2637</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @res, [ &quot;pic#$picid&quot;, $picid ];</td></tr>
<tr><td class="h">2638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2639</td><td colspan="7"></td></tr><tr><td class="h">2640</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \@res;</td></tr>
<tr><td class="h">2641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2642</td><td colspan="7"></td></tr><tr><td class="h">2643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub list_moods</td></tr>
<tr><td class="h">2644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2645</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2645">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mood_max = int(shift);</td></tr>
<tr><td class="h">2646</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_moods();</td></tr>
<tr><td class="h">2647</td><td colspan="7"></td></tr><tr><td class="h">2648</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = [];</td></tr>
<tr><td class="h">2649</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2649">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res if $mood_max &gt;= $LJ::CACHED_MOOD_MAX;</td></tr>
<tr><td class="h">2650</td><td colspan="7"></td></tr><tr><td class="h">2651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;for (my $id = $mood_max+1; $id &lt;= $LJ::CACHED_MOOD_MAX; $id++) {</td></tr>
<tr><td class="h">2652</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2652">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless defined $LJ::CACHE_MOODS{$id};</td></tr>
<tr><td class="h">2653</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mood = $LJ::CACHE_MOODS{$id};</td></tr>
<tr><td class="h">2654</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2654">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $mood-&gt;{&#39;name&#39;};</td></tr>
<tr><td class="h">2655</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$res, { &#39;id&#39; =&gt; $id,</td></tr>
<tr><td class="h">2656</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;name&#39; =&gt; $mood-&gt;{&#39;name&#39;},</td></tr>
<tr><td class="h">2657</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;parent&#39; =&gt; $mood-&gt;{&#39;parent&#39;} };</td></tr>
<tr><td class="h">2658</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2659</td><td colspan="7"></td></tr><tr><td class="h">2660</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">2661</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2662</td><td colspan="7"></td></tr><tr><td class="h">2663</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub check_altusage</td></tr>
<tr><td class="h">2664</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2665</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2665">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $err, $flags) = @_;</td></tr>
<tr><td class="h">2666</td><td colspan="7"></td></tr><tr><td class="h">2667</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# see note in ljlib.pl::can_use_journal about why we return</td></tr>
<tr><td class="h">2668</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# both &#39;ownerid&#39; and &#39;u_owner&#39; in $flags</td></tr>
<tr><td class="h">2669</td><td colspan="7"></td></tr><tr><td class="h">2670</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $alt = $req-&gt;{&#39;usejournal&#39;};</td></tr>
<tr><td class="h">2671</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{&#39;u&#39;};</td></tr>
<tr><td class="h">2672</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2672">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($u) {</td></tr>
<tr><td class="h">2673</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $username = $req-&gt;{&#39;username&#39;};</td></tr>
<tr><td class="h">2674</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2674">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,200) unless $username;</td></tr>
<tr><td class="h">2675</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2675">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,100) unless LJ::canonical_username($username);</td></tr>
<tr><td class="h">2676</td><td colspan="7"></td></tr><tr><td class="h">2677</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">2678</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2678">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,502) unless $dbr;</td></tr>
<tr><td class="h">2679</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u = $flags-&gt;{&#39;u&#39;} = LJ::load_user($username);</td></tr>
<tr><td class="h">2680</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2681</td><td colspan="7"></td></tr><tr><td class="h">2682</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{&#39;ownerid&#39;} = $u-&gt;{&#39;userid&#39;};</td></tr>
<tr><td class="h">2683</td><td colspan="7"></td></tr><tr><td class="h">2684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# all good if not using an alt journal</td></tr>
<tr><td class="h">2685</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2685">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $alt;</td></tr>
<tr><td class="h">2686</td><td colspan="7"></td></tr><tr><td class="h">2687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# complain if the username is invalid</td></tr>
<tr><td class="h">2688</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2688">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,206) unless LJ::canonical_username($alt);</td></tr>
<tr><td class="h">2689</td><td colspan="7"></td></tr><tr><td class="h">2690</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $r = eval { BML::get_request() };</td></tr>
<tr><td class="h">2691</td><td colspan="7"></td></tr><tr><td class="h">2692</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# allow usage if we&#39;re told explicitly that it&#39;s okay</td></tr>
<tr><td class="h">2693</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2693">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($flags-&gt;{&#39;usejournal_okay&#39;}) {</td></tr>
<tr><td class="h">2694</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{&#39;u_owner&#39;} = LJ::load_user($alt);</td></tr>
<tr><td class="h">2695</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{&#39;ownerid&#39;} = $flags-&gt;{&#39;u_owner&#39;}-&gt;{&#39;userid&#39;};</td></tr>
<tr><td class="h">2696</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2696">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2696">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;notes-&gt;{journalid} = $flags-&gt;{&#39;ownerid&#39;}</td></tr>
<tr><td class="h">2697</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $r &amp;&amp; !$r-&gt;notes-&gt;{journalid};</td></tr>
<tr><td class="h">2698</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2698">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $flags-&gt;{&#39;ownerid&#39;};</td></tr>
<tr><td class="h">2699</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,206);</td></tr>
<tr><td class="h">2700</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2701</td><td colspan="7"></td></tr><tr><td class="h">2702</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# otherwise, check for access:</td></tr>
<tr><td class="h">2703</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $info = {};</td></tr>
<tr><td class="h">2704</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $canuse = LJ::can_use_journal($u-&gt;{&#39;userid&#39;}, $alt, $info);</td></tr>
<tr><td class="h">2705</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{&#39;ownerid&#39;} = $info-&gt;{&#39;ownerid&#39;};</td></tr>
<tr><td class="h">2706</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{&#39;u_owner&#39;} = $info-&gt;{&#39;u_owner&#39;};</td></tr>
<tr><td class="h">2707</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2707">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2707">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;notes-&gt;{journalid} = $flags-&gt;{&#39;ownerid&#39;}</td></tr>
<tr><td class="h">2708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $r &amp;&amp; !$r-&gt;notes-&gt;{journalid};</td></tr>
<tr><td class="h">2709</td><td colspan="7"></td></tr><tr><td class="h">2710</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2710">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2710">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $canuse || $flags-&gt;{&#39;ignorecanuse&#39;};</td></tr>
<tr><td class="h">2711</td><td colspan="7"></td></tr><tr><td class="h">2712</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# not allowed to access it</td></tr>
<tr><td class="h">2713</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail($err,300);</td></tr>
<tr><td class="h">2714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2715</td><td colspan="7"></td></tr><tr><td class="h">2716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub authenticate</td></tr>
<tr><td class="h">2717</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2718</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2718">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $req, $err, $flags ) = @_;</td></tr>
<tr><td class="h">2719</td><td colspan="7"></td></tr><tr><td class="h">2720</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $username = $req-&gt;{username};</td></tr>
<tr><td class="h">2721</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2721">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail( $err, 200 ) unless $username;</td></tr>
<tr><td class="h">2722</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2722">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail( $err, 100 ) unless LJ::canonical_username($username);</td></tr>
<tr><td class="h">2723</td><td colspan="7"></td></tr><tr><td class="h">2724</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $flags-&gt;{u};</td></tr>
<tr><td class="h">2725</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2725">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $u ) {</td></tr>
<tr><td class="h">2726</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2726">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader()</td></tr>
<tr><td class="h">2727</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return fail( $err, 502 );</td></tr>
<tr><td class="h">2728</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::load_user( $username );</td></tr>
<tr><td class="h">2729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2730</td><td colspan="7"></td></tr><tr><td class="h">2731</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2731">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail( $err, 100 ) unless $u;</td></tr>
<tr><td class="h">2732</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2732">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail( $err, 100 ) if $u-&gt;is_expunged;</td></tr>
<tr><td class="h">2733</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2733">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail( $err, 505 ) unless $u-&gt;{clusterid};</td></tr>
<tr><td class="h">2734</td><td colspan="7"></td></tr><tr><td class="h">2735</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $r = DW::Request-&gt;get;</td></tr>
<tr><td class="h">2736</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ip = LJ::get_remote_ip();</td></tr>
<tr><td class="h">2737</td><td colspan="7"></td></tr><tr><td class="h">2738</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2738">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $r ) {</td></tr>
<tr><td class="h">2739</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2739">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;note( ljuser =&gt; $u-&gt;user )</td></tr>
<tr><td class="h">2740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $r-&gt;note( &#39;ljuser&#39; );</td></tr>
<tr><td class="h">2741</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2741">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;note( journalid =&gt; $u-&gt;id )</td></tr>
<tr><td class="h">2742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $r-&gt;note( &#39;journalid&#39; );</td></tr>
<tr><td class="h">2743</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2744</td><td colspan="7"></td></tr><tr><td class="h">2745</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ip_banned = 0;</td></tr>
<tr><td class="h">2746</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $chal_expired = 0;</td></tr>
<tr><td class="h">2747</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $auth_check = sub {</td></tr>
<tr><td class="h">2748</td><td colspan="7"></td></tr><tr><td class="h">2749</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2749">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2749">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $auth_meth = $req-&gt;{auth_method} || &#39;clear&#39;;</td></tr>
<tr><td class="h">2750</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2750">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $auth_meth eq &#39;clear&#39; ) {</td></tr>
<tr><td class="h">2751</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::auth_okay(</td></tr>
<tr><td class="h">2752</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u, $req-&gt;{password}, $req-&gt;{hpassword}, $u-&gt;password, \$ip_banned</td></tr>
<tr><td class="h">2753</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2754</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2755</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2755">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $auth_meth eq &#39;challenge&#39; ) {</td></tr>
<tr><td class="h">2756</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $chal_opts = {};</td></tr>
<tr><td class="h">2757</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $chall_ok = LJ::challenge_check_login(</td></tr>
<tr><td class="h">2758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u, $req-&gt;{auth_challenge}, $req-&gt;{auth_response}, \$ip_banned, $chal_opts</td></tr>
<tr><td class="h">2759</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2760</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2760">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$chal_expired = 1 if $chal_opts-&gt;{expired};</td></tr>
<tr><td class="h">2761</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $chall_ok;</td></tr>
<tr><td class="h">2762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2763</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2763">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $auth_meth eq &#39;cookie&#39; ) {</td></tr>
<tr><td class="h">2764</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2764">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2764">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless $r &amp;&amp; $r-&gt;header_in( &#39;X-LJ-Auth&#39; ) eq &#39;cookie&#39;;</td></tr>
<tr><td class="h">2765</td><td colspan="7"></td></tr><tr><td class="h">2766</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">2767</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2767">0</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2767">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $remote &amp;&amp; $remote-&gt;user eq $username ? 1 : 0;</td></tr>
<tr><td class="h">2768</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2769</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2770</td><td colspan="7"></td></tr><tr><td class="h">2771</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2771">50</a></div></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--condition.html#L2771">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $flags-&gt;{nopassword} ||</td></tr>
<tr><td class="h">2772</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{noauth} ||</td></tr>
<tr><td class="h">2773</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$auth_check-&gt;() )</td></tr>
<tr><td class="h">2774</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2775</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2775">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail( $err, 402 ) if $ip_banned;</td></tr>
<tr><td class="h">2776</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2776">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail( $err, 105 ) if $chal_expired;</td></tr>
<tr><td class="h">2777</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return fail( $err, 101 );</td></tr>
<tr><td class="h">2778</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2779</td><td colspan="7"></td></tr><tr><td class="h">2780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if there is a require TOS revision, check for it now</td></tr>
<tr><td class="h">2781</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2781">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return fail( $err, 156, LJ::tosagree_str( protocol =&gt; &#39;text&#39; ) )</td></tr>
<tr><td class="h">2782</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $u-&gt;tosagree_verify;</td></tr>
<tr><td class="h">2783</td><td colspan="7"></td></tr><tr><td class="h">2784</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remember the user record for later.</td></tr>
<tr><td class="h">2785</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flags-&gt;{u} = $u;</td></tr>
<tr><td class="h">2786</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2787</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2788</td><td colspan="7"></td></tr><tr><td class="h">2789</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub fail</td></tr>
<tr><td class="h">2790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2791</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2791">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = shift;</td></tr>
<tr><td class="h">2792</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $code = shift;</td></tr>
<tr><td class="h">2793</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $des = shift;</td></tr>
<tr><td class="h">2794</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2794">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$code .= &quot;:$des&quot; if $des;</td></tr>
<tr><td class="h">2795</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2795">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$err = $code if (ref $err eq &quot;SCALAR&quot;);</td></tr>
<tr><td class="h">2796</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">2797</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2798</td><td colspan="7"></td></tr><tr><td class="h">2799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub un_utf8_request {</td></tr>
<tr><td class="h">2800</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2800">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $req = shift;</td></tr>
<tr><td class="h">2801</td><td><div class="c3">34</div><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$req-&gt;{$_} = LJ::no_utf8_flag($req-&gt;{$_}) foreach qw(subject event);</td></tr>
<tr><td class="h">2802</td><td><div class="c3">34</div></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--condition.html#L2802">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $props = $req-&gt;{props} || {};</td></tr>
<tr><td class="h">2803</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $k (keys %$props) {</td></tr>
<tr><td class="h">2804</td><td><div class="c3">5</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2804">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if ref $props-&gt;{$k};  # if this is multiple levels deep?  don&#39;t think so.</td></tr>
<tr><td class="h">2805</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$props-&gt;{$k} = LJ::no_utf8_flag($props-&gt;{$k});</td></tr>
<tr><td class="h">2806</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2808</td><td colspan="7"></td></tr><tr><td class="h">2809</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#### Old interface (flat key/values) -- wrapper aruond LJ::Protocol</td></tr>
<tr><td class="h">2810</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ;</td></tr>
<tr><td class="h">2811</td><td colspan="7"></td></tr><tr><td class="h">2812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub do_request</td></tr>
<tr><td class="h">2813</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get the request and response hash refs</td></tr>
<tr><td class="h">2815</td><td><div class="c3">33</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2815">33</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">2816</td><td colspan="7"></td></tr><tr><td class="h">2817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# initialize some stuff</td></tr>
<tr><td class="h">2818</td><td><div class="c3">33</div><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;%{$res} = ();                      # clear the given response hash</td></tr>
<tr><td class="h">2819</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2819">50</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flags = {} unless (ref $flags eq &quot;HASH&quot;);</td></tr>
<tr><td class="h">2820</td><td colspan="7"></td></tr><tr><td class="h">2821</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# did they send a mode?</td></tr>
<tr><td class="h">2822</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2822">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($req-&gt;{&#39;mode&#39;}) {</td></tr>
<tr><td class="h">2823</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">2824</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = &quot;Client error: No mode specified.&quot;;</td></tr>
<tr><td class="h">2825</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">2826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2827</td><td colspan="7"></td></tr><tr><td class="h">2828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# this method doesn&#39;t require auth</td></tr>
<tr><td class="h">2829</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2829">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;getchallenge&quot;) {</td></tr>
<tr><td class="h">2830</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getchallenge($req, $res, $flags);</td></tr>
<tr><td class="h">2831</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2832</td><td colspan="7"></td></tr><tr><td class="h">2833</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# mode from here on out require a username</td></tr>
<tr><td class="h">2834</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = LJ::canonical_username($req-&gt;{&#39;user&#39;});</td></tr>
<tr><td class="h">2835</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2835">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($user) {</td></tr>
<tr><td class="h">2836</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">2837</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = &quot;Client error: No username sent.&quot;;</td></tr>
<tr><td class="h">2838</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">2839</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2840</td><td colspan="7"></td></tr><tr><td class="h">2841</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### see if the server&#39;s under maintenance now</td></tr>
<tr><td class="h">2842</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2842">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::SERVER_DOWN) {</td></tr>
<tr><td class="h">2843</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">2844</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = $LJ::SERVER_DOWN_MESSAGE;</td></tr>
<tr><td class="h">2845</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">2846</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2847</td><td colspan="7"></td></tr><tr><td class="h">2848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## dispatch wrappers</td></tr>
<tr><td class="h">2849</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2849">50</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;login&quot;) {</td></tr>
<tr><td class="h">2850</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return login($req, $res, $flags);</td></tr>
<tr><td class="h">2851</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2852</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2852">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;getfriendgroups&quot;) {</td></tr>
<tr><td class="h">2853</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getfriendgroups($req, $res, $flags);</td></tr>
<tr><td class="h">2854</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2855</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2855">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;getfriends&quot;) {</td></tr>
<tr><td class="h">2856</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getfriends($req, $res, $flags);</td></tr>
<tr><td class="h">2857</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2858</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2858">50</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;friendof&quot;) {</td></tr>
<tr><td class="h">2859</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return friendof($req, $res, $flags);</td></tr>
<tr><td class="h">2860</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2861</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2861">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;checkfriends&quot;) {</td></tr>
<tr><td class="h">2862</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return checkfriends($req, $res, $flags);</td></tr>
<tr><td class="h">2863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2864</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L2864">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;getdaycounts&quot;) {</td></tr>
<tr><td class="h">2865</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getdaycounts($req, $res, $flags);</td></tr>
<tr><td class="h">2866</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2867</td><td><div class="c3">33</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2867">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;postevent&quot;) {</td></tr>
<tr><td class="h">2868</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return postevent($req, $res, $flags);</td></tr>
<tr><td class="h">2869</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2870</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2870">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;editevent&quot;) {</td></tr>
<tr><td class="h">2871</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return editevent($req, $res, $flags);</td></tr>
<tr><td class="h">2872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2873</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2873">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;syncitems&quot;) {</td></tr>
<tr><td class="h">2874</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return syncitems($req, $res, $flags);</td></tr>
<tr><td class="h">2875</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2876</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2876">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;getevents&quot;) {</td></tr>
<tr><td class="h">2877</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getevents($req, $res, $flags);</td></tr>
<tr><td class="h">2878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2879</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2879">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;editfriends&quot;) {</td></tr>
<tr><td class="h">2880</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return editfriends($req, $res, $flags);</td></tr>
<tr><td class="h">2881</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2882</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2882">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;editfriendgroups&quot;) {</td></tr>
<tr><td class="h">2883</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return editfriendgroups($req, $res, $flags);</td></tr>
<tr><td class="h">2884</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2885</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2885">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;consolecommand&quot;) {</td></tr>
<tr><td class="h">2886</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return consolecommand($req, $res, $flags);</td></tr>
<tr><td class="h">2887</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2888</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2888">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;sessiongenerate&quot;) {</td></tr>
<tr><td class="h">2889</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return sessiongenerate($req, $res, $flags);</td></tr>
<tr><td class="h">2890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2891</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2891">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;sessionexpire&quot;) {</td></tr>
<tr><td class="h">2892</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return sessionexpire($req, $res, $flags);</td></tr>
<tr><td class="h">2893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2894</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2894">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;getusertags&quot;) {</td></tr>
<tr><td class="h">2895</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getusertags($req, $res, $flags);</td></tr>
<tr><td class="h">2896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2897</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2897">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;mode&#39;} eq &quot;getfriendspage&quot;) {</td></tr>
<tr><td class="h">2898</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getfriendspage($req, $res, $flags);</td></tr>
<tr><td class="h">2899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2900</td><td colspan="7"></td></tr><tr><td class="h">2901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### unknown mode!</td></tr>
<tr><td class="h">2902</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">2903</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = &quot;Client error: Unknown mode ($req-&gt;{&#39;mode&#39;})&quot;;</td></tr>
<tr><td class="h">2904</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">2905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2906</td><td colspan="7"></td></tr><tr><td class="h">2907</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">2908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getfriendspage</td></tr>
<tr><td class="h">2909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2910</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2910">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">2911</td><td colspan="7"></td></tr><tr><td class="h">2912</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">2913</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">2914</td><td colspan="7"></td></tr><tr><td class="h">2915</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;getfriendspage&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">2916</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2916">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">2917</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">2918</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">2919</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">2920</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2921</td><td colspan="7"></td></tr><tr><td class="h">2922</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ect = 0;</td></tr>
<tr><td class="h">2923</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $evt (@{$rs-&gt;{&#39;entries&#39;}}) {</td></tr>
<tr><td class="h">2924</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ect++;</td></tr>
<tr><td class="h">2925</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $f (qw(subject_raw journalname journaltype postername postertype ditemid security)) {</td></tr>
<tr><td class="h">2926</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2926">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $evt-&gt;{$f}) {</td></tr>
<tr><td class="h">2927</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;entries_${ect}_$f&quot;} = $evt-&gt;{$f};</td></tr>
<tr><td class="h">2928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2929</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2930</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;entries_${ect}_event&quot;} = LJ::eurl($evt-&gt;{&#39;event_raw&#39;});</td></tr>
<tr><td class="h">2931</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2932</td><td colspan="7"></td></tr><tr><td class="h">2933</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;entries_count&#39;} = $ect;</td></tr>
<tr><td class="h">2934</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">2935</td><td colspan="7"></td></tr><tr><td class="h">2936</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2937</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2938</td><td colspan="7"></td></tr><tr><td class="h">2939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">2940</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub login</td></tr>
<tr><td class="h">2941</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">2942</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2942">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">2943</td><td colspan="7"></td></tr><tr><td class="h">2944</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">2945</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">2946</td><td colspan="7"></td></tr><tr><td class="h">2947</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;login&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">2948</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2948">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">2949</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">2950</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">2951</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">2952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2953</td><td colspan="7"></td></tr><tr><td class="h">2954</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">2955</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;name&#39;} = $rs-&gt;{&#39;fullname&#39;};</td></tr>
<tr><td class="h">2956</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2956">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;message&#39;} = $rs-&gt;{&#39;message&#39;} if $rs-&gt;{&#39;message&#39;};</td></tr>
<tr><td class="h">2957</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2957">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;fastserver&#39;} = 1 if $rs-&gt;{&#39;fastserver&#39;};</td></tr>
<tr><td class="h">2958</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2958">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;caps&#39;} = $rs-&gt;{&#39;caps&#39;} if $rs-&gt;{&#39;caps&#39;};</td></tr>
<tr><td class="h">2959</td><td colspan="7"></td></tr><tr><td class="h">2960</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# shared journals</td></tr>
<tr><td class="h">2961</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $access_count = 0;</td></tr>
<tr><td class="h">2962</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $user (@{$rs-&gt;{&#39;usejournals&#39;}}) {</td></tr>
<tr><td class="h">2963</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$access_count++;</td></tr>
<tr><td class="h">2964</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;access_${access_count}&quot;} = $user;</td></tr>
<tr><td class="h">2965</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2966</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2966">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($access_count) {</td></tr>
<tr><td class="h">2967</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;access_count&quot;} = $access_count;</td></tr>
<tr><td class="h">2968</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2969</td><td colspan="7"></td></tr><tr><td class="h">2970</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# friend groups</td></tr>
<tr><td class="h">2971</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;populate_friend_groups($res, $rs-&gt;{&#39;friendgroups&#39;});</td></tr>
<tr><td class="h">2972</td><td colspan="7"></td></tr><tr><td class="h">2973</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $flatten = sub {</td></tr>
<tr><td class="h">2974</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L2974">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($prefix, $listref) = @_;</td></tr>
<tr><td class="h">2975</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ct = 0;</td></tr>
<tr><td class="h">2976</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@$listref) {</td></tr>
<tr><td class="h">2977</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ct++;</td></tr>
<tr><td class="h">2978</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${prefix}_$ct&quot;} = $_;</td></tr>
<tr><td class="h">2979</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2980</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${prefix}_count&quot;} = $ct;</td></tr>
<tr><td class="h">2981</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2982</td><td colspan="7"></td></tr><tr><td class="h">2983</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### picture keywords</td></tr>
<tr><td class="h">2984</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2984">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flatten-&gt;(&quot;pickw&quot;, $rs-&gt;{&#39;pickws&#39;})</td></tr>
<tr><td class="h">2985</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if defined $req-&gt;{&quot;getpickws&quot;};</td></tr>
<tr><td class="h">2986</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2986">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$flatten-&gt;(&quot;pickwurl&quot;, $rs-&gt;{&#39;pickwurls&#39;})</td></tr>
<tr><td class="h">2987</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if defined $req-&gt;{&quot;getpickwurls&quot;};</td></tr>
<tr><td class="h">2988</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2988">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;defaultpicurl&#39;} = $rs-&gt;{&#39;defaultpicurl&#39;} if $rs-&gt;{&#39;defaultpicurl&#39;};</td></tr>
<tr><td class="h">2989</td><td colspan="7"></td></tr><tr><td class="h">2990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### report new moods that this client hasn&#39;t heard of, if they care</td></tr>
<tr><td class="h">2991</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2991">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $req-&gt;{&quot;getmoods&quot;}) {</td></tr>
<tr><td class="h">2992</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mood_count = 0;</td></tr>
<tr><td class="h">2993</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $m (@{$rs-&gt;{&#39;moods&#39;}}) {</td></tr>
<tr><td class="h">2994</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mood_count++;</td></tr>
<tr><td class="h">2995</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;mood_${mood_count}_id&quot;} = $m-&gt;{&#39;id&#39;};</td></tr>
<tr><td class="h">2996</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;mood_${mood_count}_name&quot;} = $m-&gt;{&#39;name&#39;};</td></tr>
<tr><td class="h">2997</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;mood_${mood_count}_parent&quot;} = $m-&gt;{&#39;parent&#39;};</td></tr>
<tr><td class="h">2998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2999</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L2999">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($mood_count) {</td></tr>
<tr><td class="h">3000</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;mood_count&quot;} = $mood_count;</td></tr>
<tr><td class="h">3001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3002</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3003</td><td colspan="7"></td></tr><tr><td class="h">3004</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#### send web menus</td></tr>
<tr><td class="h">3005</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3005">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&quot;getmenus&quot;} == 1) {</td></tr>
<tr><td class="h">3006</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $menu = $rs-&gt;{&#39;menus&#39;};</td></tr>
<tr><td class="h">3007</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $menu_num = 0;</td></tr>
<tr><td class="h">3008</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;populate_web_menu($res, $menu, \$menu_num);</td></tr>
<tr><td class="h">3009</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3010</td><td colspan="7"></td></tr><tr><td class="h">3011</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3012</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3013</td><td colspan="7"></td></tr><tr><td class="h">3014</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getfriendgroups</td></tr>
<tr><td class="h">3016</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3017</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3017">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3018</td><td colspan="7"></td></tr><tr><td class="h">3019</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3020</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3021</td><td colspan="7"></td></tr><tr><td class="h">3022</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;getfriendgroups&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3023</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3023">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3024</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3025</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3026</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3027</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3028</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3029</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;populate_friend_groups($res, $rs-&gt;{&#39;friendgroups&#39;});</td></tr>
<tr><td class="h">3030</td><td colspan="7"></td></tr><tr><td class="h">3031</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3032</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3033</td><td colspan="7"></td></tr><tr><td class="h">3034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3035</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getusertags</td></tr>
<tr><td class="h">3036</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3037</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3037">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3038</td><td colspan="7"></td></tr><tr><td class="h">3039</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3040</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3041</td><td colspan="7"></td></tr><tr><td class="h">3042</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;getusertags&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3043</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3043">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3044</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3045</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3046</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3047</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3048</td><td colspan="7"></td></tr><tr><td class="h">3049</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3050</td><td colspan="7"></td></tr><tr><td class="h">3051</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ct = 0;</td></tr>
<tr><td class="h">3052</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $tag (@{$rs-&gt;{tags}}) {</td></tr>
<tr><td class="h">3053</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ct++;</td></tr>
<tr><td class="h">3054</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;tag_${ct}_security&quot;} = $tag-&gt;{security_level};</td></tr>
<tr><td class="h">3055</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3055">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;tag_${ct}_uses&quot;} = $tag-&gt;{uses} if $tag-&gt;{uses};</td></tr>
<tr><td class="h">3056</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3056">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;tag_${ct}_display&quot;} = $tag-&gt;{display} if $tag-&gt;{display};</td></tr>
<tr><td class="h">3057</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;tag_${ct}_name&quot;} = $tag-&gt;{name};</td></tr>
<tr><td class="h">3058</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $lev (qw(friends private public)) {</td></tr>
<tr><td class="h">3059</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3059">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;tag_${ct}_sb_$_&quot;} = $tag-&gt;{security}-&gt;{$_}</td></tr>
<tr><td class="h">3060</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $tag-&gt;{security}-&gt;{$_};</td></tr>
<tr><td class="h">3061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3062</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $gm = 0;</td></tr>
<tr><td class="h">3063</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $grpid (keys %{$tag-&gt;{security}-&gt;{groups}}) {</td></tr>
<tr><td class="h">3064</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3064">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $tag-&gt;{security}-&gt;{groups}-&gt;{$grpid};</td></tr>
<tr><td class="h">3065</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$gm++;</td></tr>
<tr><td class="h">3066</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;tag_${ct}_sb_group_${gm}_id&quot;} = $grpid;</td></tr>
<tr><td class="h">3067</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;tag_${ct}_sb_group_${gm}_count&quot;} = $tag-&gt;{security}-&gt;{groups}-&gt;{$grpid};</td></tr>
<tr><td class="h">3068</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3069</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3069">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;tag_${ct}_sb_group_count&quot;} = $gm if $gm;</td></tr>
<tr><td class="h">3070</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3071</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;tag_count&#39;} = $ct;</td></tr>
<tr><td class="h">3072</td><td colspan="7"></td></tr><tr><td class="h">3073</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3074</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3075</td><td colspan="7"></td></tr><tr><td class="h">3076</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3077</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getfriends</td></tr>
<tr><td class="h">3078</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3079</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3079">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3080</td><td colspan="7"></td></tr><tr><td class="h">3081</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3082</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3083</td><td colspan="7"></td></tr><tr><td class="h">3084</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;getfriends&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3085</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3085">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3086</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3087</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3088</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3090</td><td colspan="7"></td></tr><tr><td class="h">3091</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3092</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3092">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;includegroups&#39;}) {</td></tr>
<tr><td class="h">3093</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;populate_friend_groups($res, $rs-&gt;{&#39;friendgroups&#39;});</td></tr>
<tr><td class="h">3094</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3095</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3095">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{&#39;includefriendof&#39;}) {</td></tr>
<tr><td class="h">3096</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;populate_friends($res, &quot;friendof&quot;, $rs-&gt;{&#39;friendofs&#39;});</td></tr>
<tr><td class="h">3097</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3098</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;populate_friends($res, &quot;friend&quot;, $rs-&gt;{&#39;friends&#39;});</td></tr>
<tr><td class="h">3099</td><td colspan="7"></td></tr><tr><td class="h">3100</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3102</td><td colspan="7"></td></tr><tr><td class="h">3103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub friendof</td></tr>
<tr><td class="h">3105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3106</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3106">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3107</td><td colspan="7"></td></tr><tr><td class="h">3108</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3109</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3110</td><td colspan="7"></td></tr><tr><td class="h">3111</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;friendof&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3112</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3112">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3113</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3114</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3115</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3116</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3117</td><td colspan="7"></td></tr><tr><td class="h">3118</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;populate_friends($res, &quot;friendof&quot;, $rs-&gt;{&#39;friendofs&#39;});</td></tr>
<tr><td class="h">3120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3122</td><td colspan="7"></td></tr><tr><td class="h">3123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3124</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub checkfriends</td></tr>
<tr><td class="h">3125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3126</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3126">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3127</td><td colspan="7"></td></tr><tr><td class="h">3128</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3129</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3130</td><td colspan="7"></td></tr><tr><td class="h">3131</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;checkfriends&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3132</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3132">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3135</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3137</td><td colspan="7"></td></tr><tr><td class="h">3138</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3139</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;new&#39;} = $rs-&gt;{&#39;new&#39;};</td></tr>
<tr><td class="h">3140</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;lastupdate&#39;} = $rs-&gt;{&#39;lastupdate&#39;};</td></tr>
<tr><td class="h">3141</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;interval&#39;} = $rs-&gt;{&#39;interval&#39;};</td></tr>
<tr><td class="h">3142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3143</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3144</td><td colspan="7"></td></tr><tr><td class="h">3145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getdaycounts</td></tr>
<tr><td class="h">3147</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3148</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3148">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3149</td><td colspan="7"></td></tr><tr><td class="h">3150</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3151</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3152</td><td colspan="7"></td></tr><tr><td class="h">3153</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;getdaycounts&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3154</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3154">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3155</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3156</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3157</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3158</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3159</td><td colspan="7"></td></tr><tr><td class="h">3160</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3161</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $d (@{ $rs-&gt;{&#39;daycounts&#39;} }) {</td></tr>
<tr><td class="h">3162</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{$d-&gt;{&#39;date&#39;}} = $d-&gt;{&#39;count&#39;};</td></tr>
<tr><td class="h">3163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3164</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3165</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3166</td><td colspan="7"></td></tr><tr><td class="h">3167</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3168</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub syncitems</td></tr>
<tr><td class="h">3169</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3170</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3170">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3171</td><td colspan="7"></td></tr><tr><td class="h">3172</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3173</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3174</td><td colspan="7"></td></tr><tr><td class="h">3175</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;syncitems&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3176</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3176">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3177</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3178</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3179</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3181</td><td colspan="7"></td></tr><tr><td class="h">3182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3183</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;sync_total&#39;} = $rs-&gt;{&#39;total&#39;};</td></tr>
<tr><td class="h">3184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;sync_count&#39;} = $rs-&gt;{&#39;count&#39;};</td></tr>
<tr><td class="h">3185</td><td colspan="7"></td></tr><tr><td class="h">3186</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ct = 0;</td></tr>
<tr><td class="h">3187</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $s (@{ $rs-&gt;{&#39;syncitems&#39;} }) {</td></tr>
<tr><td class="h">3188</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ct++;</td></tr>
<tr><td class="h">3189</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $a (qw(item action time)) {</td></tr>
<tr><td class="h">3190</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;sync_${ct}_$a&quot;} = $s-&gt;{$a};</td></tr>
<tr><td class="h">3191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3192</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3193</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3194</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3195</td><td colspan="7"></td></tr><tr><td class="h">3196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper: limited functionality.  (1 command only, server-parsed only)</td></tr>
<tr><td class="h">3197</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub consolecommand</td></tr>
<tr><td class="h">3198</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3199</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3199">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3200</td><td colspan="7"></td></tr><tr><td class="h">3201</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3202</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3203</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;delete $rq-&gt;{&#39;command&#39;};</td></tr>
<tr><td class="h">3204</td><td colspan="7"></td></tr><tr><td class="h">3205</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{&#39;commands&#39;} = [ $req-&gt;{&#39;command&#39;} ];</td></tr>
<tr><td class="h">3206</td><td colspan="7"></td></tr><tr><td class="h">3207</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;consolecommand&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3208</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3208">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3209</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3210</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3212</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3213</td><td colspan="7"></td></tr><tr><td class="h">3214</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;cmd_success&#39;} = $rs-&gt;{&#39;results&#39;}-&gt;[0]-&gt;{&#39;success&#39;};</td></tr>
<tr><td class="h">3215</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;cmd_line_count&#39;} = 0;</td></tr>
<tr><td class="h">3216</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $l (@{$rs-&gt;{&#39;results&#39;}-&gt;[0]-&gt;{&#39;output&#39;}}) {</td></tr>
<tr><td class="h">3217</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;cmd_line_count&#39;}++;</td></tr>
<tr><td class="h">3218</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $line = $res-&gt;{&#39;cmd_line_count&#39;};</td></tr>
<tr><td class="h">3219</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3219">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;cmd_line_${line}_type&quot;} = $l-&gt;[0]</td></tr>
<tr><td class="h">3220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $l-&gt;[0];</td></tr>
<tr><td class="h">3221</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;cmd_line_${line}&quot;} = $l-&gt;[1];</td></tr>
<tr><td class="h">3222</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3223</td><td colspan="7"></td></tr><tr><td class="h">3224</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3225</td><td colspan="7"></td></tr><tr><td class="h">3226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3227</td><td colspan="7"></td></tr><tr><td class="h">3228</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getchallenge</td></tr>
<tr><td class="h">3230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3231</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3231">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3232</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3233</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;getchallenge&quot;, $req, \$err, $flags);</td></tr>
<tr><td class="h">3234</td><td colspan="7"></td></tr><tr><td class="h">3235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# stupid copy (could just return $rs), but it might change in the future</td></tr>
<tr><td class="h">3236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so this protects us from future accidental harm.</td></tr>
<tr><td class="h">3237</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $k (qw(challenge server_time expire_time auth_scheme)) {</td></tr>
<tr><td class="h">3238</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{$k} = $rs-&gt;{$k};</td></tr>
<tr><td class="h">3239</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3240</td><td colspan="7"></td></tr><tr><td class="h">3241</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3242</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">3243</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3244</td><td colspan="7"></td></tr><tr><td class="h">3245</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub editfriends</td></tr>
<tr><td class="h">3247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3248</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3248">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3249</td><td colspan="7"></td></tr><tr><td class="h">3250</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3251</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3252</td><td colspan="7"></td></tr><tr><td class="h">3253</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{&#39;add&#39;} = [];</td></tr>
<tr><td class="h">3254</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{&#39;delete&#39;} = [];</td></tr>
<tr><td class="h">3255</td><td colspan="7"></td></tr><tr><td class="h">3256</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %$req) {</td></tr>
<tr><td class="h">3257</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3257">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3257">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (/^editfriend_add_(\d+)_user$/) {</td></tr>
<tr><td class="h">3258</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $n = $1;</td></tr>
<tr><td class="h">3259</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3259">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless ($req-&gt;{&quot;editfriend_add_${n}_user&quot;} =~ /\S/);</td></tr>
<tr><td class="h">3260</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fa = { &#39;username&#39; =&gt; $req-&gt;{&quot;editfriend_add_${n}_user&quot;},</td></tr>
<tr><td class="h">3261</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fgcolor&#39; =&gt; $req-&gt;{&quot;editfriend_add_${n}_fg&quot;},</td></tr>
<tr><td class="h">3262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;bgcolor&#39; =&gt; $req-&gt;{&quot;editfriend_add_${n}_bg&quot;},</td></tr>
<tr><td class="h">3263</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;groupmask&#39; =&gt; $req-&gt;{&quot;editfriend_add_${n}_groupmask&quot;},</td></tr>
<tr><td class="h">3264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">3265</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$rq-&gt;{&#39;add&#39;}}, $fa;</td></tr>
<tr><td class="h">3266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif (/^editfriend_delete_(\w+)$/) {</td></tr>
<tr><td class="h">3267</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$rq-&gt;{&#39;delete&#39;}}, $1;</td></tr>
<tr><td class="h">3268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3270</td><td colspan="7"></td></tr><tr><td class="h">3271</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;editfriends&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3272</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3272">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3273</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3274</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3276</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3277</td><td colspan="7"></td></tr><tr><td class="h">3278</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3279</td><td colspan="7"></td></tr><tr><td class="h">3280</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ct = 0;</td></tr>
<tr><td class="h">3281</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $fa (@{ $rs-&gt;{&#39;added&#39;} }) {</td></tr>
<tr><td class="h">3282</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ct++;</td></tr>
<tr><td class="h">3283</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;friend_${ct}_user&quot;} = $fa-&gt;{&#39;username&#39;};</td></tr>
<tr><td class="h">3284</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;friend_${ct}_name&quot;} = $fa-&gt;{&#39;fullname&#39;};</td></tr>
<tr><td class="h">3285</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3286</td><td colspan="7"></td></tr><tr><td class="h">3287</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;friends_added&#39;} = $ct;</td></tr>
<tr><td class="h">3288</td><td colspan="7"></td></tr><tr><td class="h">3289</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3290</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3291</td><td colspan="7"></td></tr><tr><td class="h">3292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub editfriendgroups</td></tr>
<tr><td class="h">3294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3295</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3295">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3296</td><td colspan="7"></td></tr><tr><td class="h">3297</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3298</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3299</td><td colspan="7"></td></tr><tr><td class="h">3300</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{&#39;groupmasks&#39;} = {};</td></tr>
<tr><td class="h">3301</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{&#39;set&#39;} = {};</td></tr>
<tr><td class="h">3302</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{&#39;delete&#39;} = [];</td></tr>
<tr><td class="h">3303</td><td colspan="7"></td></tr><tr><td class="h">3304</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (keys %$req) {</td></tr>
<tr><td class="h">3305</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3305">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3305">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3305">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (/^efg_set_(\d+)_name$/) {</td></tr>
<tr><td class="h">3306</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3306">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless ($req-&gt;{$_} ne &quot;&quot;);</td></tr>
<tr><td class="h">3307</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $n = $1;</td></tr>
<tr><td class="h">3308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fs = {</td></tr>
<tr><td class="h">3309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;name&#39; =&gt; $req-&gt;{&quot;efg_set_${n}_name&quot;},</td></tr>
<tr><td class="h">3310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;sort&#39; =&gt; $req-&gt;{&quot;efg_set_${n}_sort&quot;},</td></tr>
<tr><td class="h">3311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">3312</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3312">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $req-&gt;{&quot;efg_set_${n}_public&quot;}) {</td></tr>
<tr><td class="h">3313</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fs-&gt;{&#39;public&#39;} = $req-&gt;{&quot;efg_set_${n}_public&quot;};</td></tr>
<tr><td class="h">3314</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3315</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{&#39;set&#39;}-&gt;{$n} = $fs;</td></tr>
<tr><td class="h">3316</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elsif (/^efg_delete_(\d+)$/) {</td></tr>
<tr><td class="h">3318</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3318">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req-&gt;{$_}) {</td></tr>
<tr><td class="h">3319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# delete group if value is true</td></tr>
<tr><td class="h">3320</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$rq-&gt;{&#39;delete&#39;}}, $1;</td></tr>
<tr><td class="h">3321</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3322</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3323</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elsif (/^editfriend_groupmask_(\w+)$/) {</td></tr>
<tr><td class="h">3324</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{&#39;groupmasks&#39;}-&gt;{$1} = $req-&gt;{$_};</td></tr>
<tr><td class="h">3325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3326</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3327</td><td colspan="7"></td></tr><tr><td class="h">3328</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;editfriendgroups&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3329</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3329">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3330</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3331</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3332</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3334</td><td colspan="7"></td></tr><tr><td class="h">3335</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3336</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3338</td><td colspan="7"></td></tr><tr><td class="h">3339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub flatten_props</td></tr>
<tr><td class="h">3340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3341</td><td><div class="c3">33</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3341">33</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $rq) = @_;</td></tr>
<tr><td class="h">3342</td><td colspan="7"></td></tr><tr><td class="h">3343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## changes prop_* to props hashref</td></tr>
<tr><td class="h">3344</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $k (keys %$req) {</td></tr>
<tr><td class="h">3345</td><td><div class="c3">264</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3345">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless ($k =~ /^prop_(.+)/);</td></tr>
<tr><td class="h">3346</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{&#39;props&#39;}-&gt;{$1} = $req-&gt;{$k};</td></tr>
<tr><td class="h">3347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3349</td><td colspan="7"></td></tr><tr><td class="h">3350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3351</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub postevent</td></tr>
<tr><td class="h">3352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3353</td><td><div class="c3">33</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3353">33</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3354</td><td colspan="7"></td></tr><tr><td class="h">3355</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3356</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3357</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;flatten_props($req, $rq);</td></tr>
<tr><td class="h">3358</td><td colspan="7"></td></tr><tr><td class="h">3359</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;postevent&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3360</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L3360">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3361</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3362</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3363</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3365</td><td colspan="7"></td></tr><tr><td class="h">3366</td><td><div class="c3">33</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-ljprotocol-pl--branch.html#L3366">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;message&#39;} = $rs-&gt;{&#39;message&#39;} if $rs-&gt;{&#39;message&#39;};</td></tr>
<tr><td class="h">3367</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3368</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;itemid&#39;} = $rs-&gt;{&#39;itemid&#39;};</td></tr>
<tr><td class="h">3369</td><td><div class="c3">33</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3369">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;anum&#39;} = $rs-&gt;{&#39;anum&#39;} if defined $rs-&gt;{&#39;anum&#39;};</td></tr>
<tr><td class="h">3370</td><td><div class="c3">33</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3370">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;url&#39;} = $rs-&gt;{&#39;url&#39;} if defined $rs-&gt;{&#39;url&#39;};</td></tr>
<tr><td class="h">3371</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3372</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3373</td><td colspan="7"></td></tr><tr><td class="h">3374</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3375</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub editevent</td></tr>
<tr><td class="h">3376</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3377</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3377">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3378</td><td colspan="7"></td></tr><tr><td class="h">3379</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3380</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3381</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;flatten_props($req, $rq);</td></tr>
<tr><td class="h">3382</td><td colspan="7"></td></tr><tr><td class="h">3383</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;editevent&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3384</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3384">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3385</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3386</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3387</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3389</td><td colspan="7"></td></tr><tr><td class="h">3390</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3391</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;itemid&#39;} = $rs-&gt;{&#39;itemid&#39;};</td></tr>
<tr><td class="h">3392</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3392">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;anum&#39;} = $rs-&gt;{&#39;anum&#39;} if defined $rs-&gt;{&#39;anum&#39;};</td></tr>
<tr><td class="h">3393</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3393">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;url&#39;} = $rs-&gt;{&#39;url&#39;} if defined $rs-&gt;{&#39;url&#39;};</td></tr>
<tr><td class="h">3394</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3396</td><td colspan="7"></td></tr><tr><td class="h">3397</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3398</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub sessiongenerate {</td></tr>
<tr><td class="h">3399</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3399">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3400</td><td colspan="7"></td></tr><tr><td class="h">3401</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3402</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3403</td><td colspan="7"></td></tr><tr><td class="h">3404</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&#39;sessiongenerate&#39;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3405</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3405">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3406</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{success} = &#39;FAIL&#39;;</td></tr>
<tr><td class="h">3407</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{errmsg} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3409</td><td colspan="7"></td></tr><tr><td class="h">3410</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{success} = &#39;OK&#39;;</td></tr>
<tr><td class="h">3411</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{ljsession} = $rs-&gt;{ljsession};</td></tr>
<tr><td class="h">3412</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3413</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3414</td><td colspan="7"></td></tr><tr><td class="h">3415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrappre</td></tr>
<tr><td class="h">3416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub sessionexpire {</td></tr>
<tr><td class="h">3417</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3417">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3418</td><td colspan="7"></td></tr><tr><td class="h">3419</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3420</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3421</td><td colspan="7"></td></tr><tr><td class="h">3422</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$rq-&gt;{expire} = [];</td></tr>
<tr><td class="h">3423</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $k (keys %$rq) {</td></tr>
<tr><td class="h">3424</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3424">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$rq-&gt;{expire}}, $1</td></tr>
<tr><td class="h">3425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $k =~ /^expire_id_(\d+)$/;</td></tr>
<tr><td class="h">3426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3427</td><td colspan="7"></td></tr><tr><td class="h">3428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&#39;sessionexpire&#39;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3429</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3429">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3430</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{success} = &#39;FAIL&#39;;</td></tr>
<tr><td class="h">3431</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{errmsg} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3433</td><td colspan="7"></td></tr><tr><td class="h">3434</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{success} = &#39;OK&#39;;</td></tr>
<tr><td class="h">3435</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3436</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3437</td><td colspan="7"></td></tr><tr><td class="h">3438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## flat wrapper</td></tr>
<tr><td class="h">3439</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub getevents</td></tr>
<tr><td class="h">3440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3441</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3441">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($req, $res, $flags) = @_;</td></tr>
<tr><td class="h">3442</td><td colspan="7"></td></tr><tr><td class="h">3443</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err = 0;</td></tr>
<tr><td class="h">3444</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rq = upgrade_request($req);</td></tr>
<tr><td class="h">3445</td><td colspan="7"></td></tr><tr><td class="h">3446</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = LJ::Protocol::do_request(&quot;getevents&quot;, $rq, \$err, $flags);</td></tr>
<tr><td class="h">3447</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3447">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($rs) {</td></tr>
<tr><td class="h">3448</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;FAIL&quot;;</td></tr>
<tr><td class="h">3449</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;errmsg&#39;} = LJ::Protocol::error_message($err);</td></tr>
<tr><td class="h">3450</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3452</td><td colspan="7"></td></tr><tr><td class="h">3453</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ect = 0;</td></tr>
<tr><td class="h">3454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pct = 0;</td></tr>
<tr><td class="h">3455</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $evt (@{$rs-&gt;{&#39;events&#39;}}) {</td></tr>
<tr><td class="h">3456</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ect++;</td></tr>
<tr><td class="h">3457</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $f (qw(itemid eventtime security allowmask subject anum url poster)) {</td></tr>
<tr><td class="h">3458</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3458">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $evt-&gt;{$f}) {</td></tr>
<tr><td class="h">3459</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;events_${ect}_$f&quot;} = $evt-&gt;{$f};</td></tr>
<tr><td class="h">3460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3462</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;events_${ect}_event&quot;} = LJ::eurl($evt-&gt;{&#39;event&#39;});</td></tr>
<tr><td class="h">3463</td><td colspan="7"></td></tr><tr><td class="h">3464</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3464">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($evt-&gt;{&#39;props&#39;}) {</td></tr>
<tr><td class="h">3465</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $k (sort keys %{$evt-&gt;{&#39;props&#39;}}) {</td></tr>
<tr><td class="h">3466</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pct++;</td></tr>
<tr><td class="h">3467</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;prop_${pct}_itemid&quot;} = $evt-&gt;{&#39;itemid&#39;};</td></tr>
<tr><td class="h">3468</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;prop_${pct}_name&quot;} = $k;</td></tr>
<tr><td class="h">3469</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;prop_${pct}_value&quot;} = $evt-&gt;{&#39;props&#39;}-&gt;{$k};</td></tr>
<tr><td class="h">3470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3473</td><td colspan="7"></td></tr><tr><td class="h">3474</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3474">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($req-&gt;{&#39;noprops&#39;}) {</td></tr>
<tr><td class="h">3475</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;prop_count&#39;} = $pct;</td></tr>
<tr><td class="h">3476</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3477</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;events_count&#39;} = $ect;</td></tr>
<tr><td class="h">3478</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;success&#39;} = &quot;OK&quot;;</td></tr>
<tr><td class="h">3479</td><td colspan="7"></td></tr><tr><td class="h">3480</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3482</td><td colspan="7"></td></tr><tr><td class="h">3483</td><td colspan="7"></td></tr><tr><td class="h">3484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub populate_friends</td></tr>
<tr><td class="h">3485</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3486</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3486">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($res, $pfx, $list) = @_;</td></tr>
<tr><td class="h">3487</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = 0;</td></tr>
<tr><td class="h">3488</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $f (@$list)</td></tr>
<tr><td class="h">3489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">3490</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$count++;</td></tr>
<tr><td class="h">3491</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_name&quot;} = $f-&gt;{&#39;fullname&#39;};</td></tr>
<tr><td class="h">3492</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_user&quot;} = $f-&gt;{&#39;username&#39;};</td></tr>
<tr><td class="h">3493</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3493">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_birthday&quot;} = $f-&gt;{&#39;birthday&#39;} if $f-&gt;{&#39;birthday&#39;};</td></tr>
<tr><td class="h">3494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_bg&quot;} = $f-&gt;{&#39;bgcolor&#39;};</td></tr>
<tr><td class="h">3495</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_fg&quot;} = $f-&gt;{&#39;fgcolor&#39;};</td></tr>
<tr><td class="h">3496</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3496">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $f-&gt;{&#39;groupmask&#39;}) {</td></tr>
<tr><td class="h">3497</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_groupmask&quot;} = $f-&gt;{&#39;groupmask&#39;};</td></tr>
<tr><td class="h">3498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3499</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3499">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $f-&gt;{&#39;type&#39;}) {</td></tr>
<tr><td class="h">3500</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_type&quot;} = $f-&gt;{&#39;type&#39;};</td></tr>
<tr><td class="h">3501</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3501">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($f-&gt;{&#39;type&#39;} eq &#39;identity&#39;) {</td></tr>
<tr><td class="h">3502</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_identity_type&quot;}    = $f-&gt;{&#39;identity_type&#39;};</td></tr>
<tr><td class="h">3503</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_identity_value&quot;}   = $f-&gt;{&#39;identity_value&#39;};</td></tr>
<tr><td class="h">3504</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_identity_display&quot;} = $f-&gt;{&#39;identity_display&#39;};</td></tr>
<tr><td class="h">3505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3507</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3507">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $f-&gt;{&#39;status&#39;}) {</td></tr>
<tr><td class="h">3508</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_${count}_status&quot;} = $f-&gt;{&#39;status&#39;};</td></tr>
<tr><td class="h">3509</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3510</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3511</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;${pfx}_count&quot;} = $count;</td></tr>
<tr><td class="h">3512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3513</td><td colspan="7"></td></tr><tr><td class="h">3514</td><td colspan="7"></td></tr><tr><td class="h">3515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub upgrade_request</td></tr>
<tr><td class="h">3516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3517</td><td><div class="c3">33</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3517">33</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $r = shift;</td></tr>
<tr><td class="h">3518</td><td><div class="c3">33</div><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $new = { %{ $r } };</td></tr>
<tr><td class="h">3519</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$new-&gt;{&#39;username&#39;} = $r-&gt;{&#39;user&#39;};</td></tr>
<tr><td class="h">3520</td><td colspan="7"></td></tr><tr><td class="h">3521</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# but don&#39;t delete $r-&gt;{&#39;user&#39;}, as it might be, say, %FORM,</td></tr>
<tr><td class="h">3522</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# that&#39;ll get reused in a later request in, say, update.bml after</td></tr>
<tr><td class="h">3523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the login before postevent.  whoops.</td></tr>
<tr><td class="h">3524</td><td colspan="7"></td></tr><tr><td class="h">3525</td><td><div class="c3">33</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $new;</td></tr>
<tr><td class="h">3526</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3527</td><td colspan="7"></td></tr><tr><td class="h">3528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## given a $res hashref and friend group subtree (arrayref), flattens it</td></tr>
<tr><td class="h">3529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub populate_friend_groups</td></tr>
<tr><td class="h">3530</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3531</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3531">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($res, $fr) = @_;</td></tr>
<tr><td class="h">3532</td><td colspan="7"></td></tr><tr><td class="h">3533</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $maxnum = 0;</td></tr>
<tr><td class="h">3534</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $fg (@$fr)</td></tr>
<tr><td class="h">3535</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">3536</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $num = $fg-&gt;{&#39;id&#39;};</td></tr>
<tr><td class="h">3537</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;frgrp_${num}_name&quot;} = $fg-&gt;{&#39;name&#39;};</td></tr>
<tr><td class="h">3538</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;frgrp_${num}_sortorder&quot;} = $fg-&gt;{&#39;sortorder&#39;};</td></tr>
<tr><td class="h">3539</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3539">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($fg-&gt;{&#39;public&#39;}) {</td></tr>
<tr><td class="h">3540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;frgrp_${num}_public&quot;} = 1;</td></tr>
<tr><td class="h">3541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3542</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3542">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($num &gt; $maxnum) { $maxnum = $num; }</td></tr>
<tr><td class="h">3543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3544</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&#39;frgrp_maxnum&#39;} = $maxnum;</td></tr>
<tr><td class="h">3545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3546</td><td colspan="7"></td></tr><tr><td class="h">3547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">## given a menu tree, flattens it into $res hashref</td></tr>
<tr><td class="h">3548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub populate_web_menu</td></tr>
<tr><td class="h">3549</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">3550</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-ljprotocol-pl--subroutine.html#L3550">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($res, $menu, $numref) = @_;</td></tr>
<tr><td class="h">3551</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mn = $$numref;  # menu number</td></tr>
<tr><td class="h">3552</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mi = 0;         # menu item</td></tr>
<tr><td class="h">3553</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $it (@$menu) {</td></tr>
<tr><td class="h">3554</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mi++;</td></tr>
<tr><td class="h">3555</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;menu_${mn}_${mi}_text&quot;} = $it-&gt;{&#39;text&#39;};</td></tr>
<tr><td class="h">3556</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3556">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($it-&gt;{&#39;text&#39;} eq &quot;-&quot;) { next; }</td></tr>
<tr><td class="h">3557</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-ljprotocol-pl--branch.html#L3557">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($it-&gt;{&#39;sub&#39;}) {</td></tr>
<tr><td class="h">3558</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$numref++;</td></tr>
<tr><td class="h">3559</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;menu_${mn}_${mi}_sub&quot;} = $$numref;</td></tr>
<tr><td class="h">3560</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;populate_web_menu($res, $it-&gt;{&#39;sub&#39;}, $numref);</td></tr>
<tr><td class="h">3561</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next;</td></tr>
<tr><td class="h">3562</td><td colspan="7"></td></tr><tr><td class="h">3563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3564</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;menu_${mn}_${mi}_url&quot;} = $it-&gt;{&#39;url&#39;};</td></tr>
<tr><td class="h">3565</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3566</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$res-&gt;{&quot;menu_${mn}_count&quot;} = $mi;</td></tr>
<tr><td class="h">3567</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3568</td><td colspan="7"></td></tr><tr><td class="h">3569</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
