<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/DW/User/Edges/WatchTrust.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/DW/User/Edges/WatchTrust.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">2.3%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#!/usr/bin/perl</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># DW::User::Edges::WatchTrust</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Implements the watch and trust edges between accounts.  These are closely</td></tr>
<tr><td class="h">6</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># related edges that serve a lot of core functionality of the site.  Without</td></tr>
<tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># these edges, the site will probably not work.</td></tr>
<tr><td class="h">8</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">9</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Authors:</td></tr>
<tr><td class="h">10</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      Mark Smith &lt;mark@dreamwidth.org&gt;</td></tr>
<tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">12</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Copyright (c) 2008 by Dreamwidth Studios, LLC.</td></tr>
<tr><td class="h">13</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">14</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This program is free software; you may redistribute it and/or modify it under</td></tr>
<tr><td class="h">15</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># the same terms as Perl itself.  For a copy of the license, please reference</td></tr>
<tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &#39;perldoc perlartistic&#39; or &#39;perldoc perlgpl&#39;.</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">18</td><td colspan="7"></td></tr><tr><td class="h">19</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package DW::User::Edges::WatchTrust;</td></tr>
<tr><td class="h">20</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L20">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">21</td><td colspan="7"></td></tr><tr><td class="h">22</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L22">80</a></div></td><td></td><td><div>0</div><div>0</div><div>4000</div></td><td class="s">use Carp qw/ confess /;</td></tr>
<tr><td class="h">23</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L23">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use DW::User::Edges::WatchTrust::Loader;</td></tr>
<tr><td class="h">24</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L24">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use DW::User::Edges::WatchTrust::UserHelper;</td></tr>
<tr><td class="h">25</td><td colspan="7"></td></tr><tr><td class="h">26</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># the watch edge simply adds one user&#39;s content to another user&#39;s watch page</td></tr>
<tr><td class="h">27</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># and has no security implications whatsoever</td></tr>
<tr><td class="h">28</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">DW::User::Edges::define_edge(</td></tr>
<tr><td class="h">29</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;watch =&gt;</td></tr>
<tr><td class="h">30</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">31</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type =&gt; &#39;hashref&#39;,</td></tr>
<tr><td class="h">32</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db_edge =&gt; &#39;W&#39;,</td></tr>
<tr><td class="h">33</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options =&gt; {</td></tr>
<tr><td class="h">34</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fgcolor  =&gt; { required =&gt; 0, type =&gt; &#39;int&#39;                },</td></tr>
<tr><td class="h">35</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bgcolor  =&gt; { required =&gt; 0, type =&gt; &#39;int&#39;                },</td></tr>
<tr><td class="h">36</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nonotify =&gt; { required =&gt; 0, type =&gt; &#39;bool&#39;, default =&gt; 0 },</td></tr>
<tr><td class="h">37</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</td></tr>
<tr><td class="h">38</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_sub =&gt; \&amp;_add_wt_edge,</td></tr>
<tr><td class="h">39</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;del_sub =&gt; \&amp;_del_wt_edge,</td></tr>
<tr><td class="h">40</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">41</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">42</td><td colspan="7"></td></tr><tr><td class="h">43</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># the trust edge is what provides authorization for one user to see another</td></tr>
<tr><td class="h">44</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># user&#39;s protected posts</td></tr>
<tr><td class="h">45</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">DW::User::Edges::define_edge(</td></tr>
<tr><td class="h">46</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trust =&gt;</td></tr>
<tr><td class="h">47</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">48</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type =&gt; &#39;hashref&#39;,</td></tr>
<tr><td class="h">49</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db_edge =&gt; &#39;T&#39;,</td></tr>
<tr><td class="h">50</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options =&gt; {</td></tr>
<tr><td class="h">51</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask     =&gt; { required =&gt; 0, type =&gt; &#39;int&#39;                },</td></tr>
<tr><td class="h">52</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nonotify =&gt; { required =&gt; 0, type =&gt; &#39;bool&#39;, default =&gt; 0 },</td></tr>
<tr><td class="h">53</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</td></tr>
<tr><td class="h">54</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_sub =&gt; \&amp;_add_wt_edge,</td></tr>
<tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;del_sub =&gt; \&amp;_del_wt_edge,</td></tr>
<tr><td class="h">56</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">58</td><td colspan="7"></td></tr><tr><td class="h">59</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># internal method used to add a watch/trust edge to an account</td></tr>
<tr><td class="h">60</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _add_wt_edge {</td></tr>
<tr><td class="h">61</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L61">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $from_u, $to_u, $edges ) = @_;</td></tr>
<tr><td class="h">62</td><td colspan="7"></td></tr><tr><td class="h">63</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# bail unless there are watch/trust edges</td></tr>
<tr><td class="h">64</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $trust_edge, $watch_edge ) = ( delete $edges-&gt;{trust}, delete $edges-&gt;{watch} );</td></tr>
<tr><td class="h">65</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L65">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L65">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $trust_edge || $watch_edge;</td></tr>
<tr><td class="h">66</td><td colspan="7"></td></tr><tr><td class="h">67</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now setup some helper variables</td></tr>
<tr><td class="h">68</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L68">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $do_watch = $watch_edge ? 1 : 0;</td></tr>
<tr><td class="h">69</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L69">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$watch_edge ||= {};</td></tr>
<tr><td class="h">70</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L70">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $do_trust = $trust_edge ? 1 : 0;</td></tr>
<tr><td class="h">71</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L71">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$trust_edge ||= {};</td></tr>
<tr><td class="h">72</td><td colspan="7"></td></tr><tr><td class="h">73</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# throw errors if we&#39;re not allowed</td></tr>
<tr><td class="h">74</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L74">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L74">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $do_watch &amp;&amp; ! $from_u-&gt;can_watch( $to_u );</td></tr>
<tr><td class="h">75</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L75">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L75">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $do_trust &amp;&amp; ! $from_u-&gt;can_trust( $to_u );</td></tr>
<tr><td class="h">76</td><td colspan="7"></td></tr><tr><td class="h">77</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get current record, so we know what to modify</td></tr>
<tr><td class="h">78</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">79</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $row = $dbh-&gt;selectrow_hashref( &#39;SELECT fgcolor, bgcolor, groupmask FROM wt_edges WHERE from_userid = ? AND to_userid = ?&#39;,</td></tr>
<tr><td class="h">80</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $from_u-&gt;id, $to_u-&gt;id );</td></tr>
<tr><td class="h">81</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L81">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess $dbh-&gt;errstr if $dbh-&gt;err;</td></tr>
<tr><td class="h">82</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L82">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$row ||= { groupmask =&gt; 0 };</td></tr>
<tr><td class="h">83</td><td colspan="7"></td></tr><tr><td class="h">84</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# store some existing trust/watch values for use later</td></tr>
<tr><td class="h">85</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $existing_watch = $row-&gt;{groupmask} &amp;  ( 1 &lt;&lt; 61 );</td></tr>
<tr><td class="h">86</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $existing_trust = $row-&gt;{groupmask} &amp; ~( 7 &lt;&lt; 61 );</td></tr>
<tr><td class="h">87</td><td colspan="7"></td></tr><tr><td class="h">88</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# only matters in the read case, but ...</td></tr>
<tr><td class="h">89</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L89">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L89">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $fgcol, $bgcol ) = ( $row-&gt;{fgcolor} || LJ::color_todb( &#39;#000000&#39; ),</td></tr>
<tr><td class="h">90</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exists $row-&gt;{bgcolor} ? $row-&gt;{bgcolor} : LJ::color_todb( &#39;#ffffff&#39; ) );</td></tr>
<tr><td class="h">91</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L91">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$fgcol = $watch_edge-&gt;{fgcolor} if exists $watch_edge-&gt;{fgcolor};</td></tr>
<tr><td class="h">92</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L92">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$bgcol = $watch_edge-&gt;{bgcolor} if exists $watch_edge-&gt;{bgcolor};</td></tr>
<tr><td class="h">93</td><td colspan="7"></td></tr><tr><td class="h">94</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# calculate the mask we&#39;re going to apply to the user; this is somewhat complicated</td></tr>
<tr><td class="h">95</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# as we have to account for situations where we&#39;re updating only one of the edges, as</td></tr>
<tr><td class="h">96</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# well as the situation where we are just updating the trust edge without changing</td></tr>
<tr><td class="h">97</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the user&#39;s group memberships.  lots of comments.  start with a mask of 0.</td></tr>
<tr><td class="h">98</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mask = 0;</td></tr>
<tr><td class="h">99</td><td colspan="7"></td></tr><tr><td class="h">100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if they are adding a watch edge, simply turn that bit on</td></tr>
<tr><td class="h">101</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L101">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$mask |= ( 1 &lt;&lt; 61 ) if $do_watch;</td></tr>
<tr><td class="h">102</td><td colspan="7"></td></tr><tr><td class="h">103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if they are not adding a watch edge, import the existing watch edge</td></tr>
<tr><td class="h">104</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L104">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$mask |= $existing_watch unless $do_watch;</td></tr>
<tr><td class="h">105</td><td colspan="7"></td></tr><tr><td class="h">106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if they are adding a trust edge, we need to turn bit 1 on</td></tr>
<tr><td class="h">107</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L107">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$mask |= 1 if $do_trust;</td></tr>
<tr><td class="h">108</td><td colspan="7"></td></tr><tr><td class="h">109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now, we have to copy some trustmask, depending on some factors</td></tr>
<tr><td class="h">110</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L110">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L110">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( ( $do_watch &amp;&amp; ! $do_trust ) ||                   # 1) if we&#39;re only updating watch</td></tr>
<tr><td class="h">111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $do_trust &amp;&amp; ! exists $trust_edge-&gt;{mask} ) )   # 2) they&#39;re adding a trust edge but don&#39;t set a mask</td></tr>
<tr><td class="h">112</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# in these two cases, we want to copy up the trustmask from the database</td></tr>
<tr><td class="h">114</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mask |= $existing_trust;</td></tr>
<tr><td class="h">115</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">116</td><td colspan="7"></td></tr><tr><td class="h">117</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the final case, they are trusting and have specified a mask; but note we cannot allow</td></tr>
<tr><td class="h">118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# them to set the high bits</td></tr>
<tr><td class="h">119</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L119">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L119">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $do_trust &amp;&amp; exists $trust_edge-&gt;{mask} ) {</td></tr>
<tr><td class="h">120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mask |= ( $trust_edge-&gt;{mask}+0 &amp; ~( 7 &lt;&lt; 61 ) );</td></tr>
<tr><td class="h">121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">122</td><td colspan="7"></td></tr><tr><td class="h">123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now add the row</td></tr>
<tr><td class="h">124</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do( &#39;REPLACE INTO wt_edges (from_userid, to_userid, fgcolor, bgcolor, groupmask) VALUES (?, ?, ?, ?, ?)&#39;,</td></tr>
<tr><td class="h">125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $from_u-&gt;id, $to_u-&gt;id, $fgcol, $bgcol, $mask );</td></tr>
<tr><td class="h">126</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L126">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess $dbh-&gt;errstr if $dbh-&gt;err;</td></tr>
<tr><td class="h">127</td><td colspan="7"></td></tr><tr><td class="h">128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# delete friend-of memcache keys for anyone who was added</td></tr>
<tr><td class="h">129</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $from_userid, $to_userid ) = ( $from_u-&gt;id, $to_u-&gt;id );</td></tr>
<tr><td class="h">130</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete( [$from_userid, &quot;trustmask:$from_userid:$to_userid&quot;] );</td></tr>
<tr><td class="h">131</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $to_userid, &#39;wt_edges_rev&#39; );</td></tr>
<tr><td class="h">132</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $from_userid, &#39;wt_edges&#39; );</td></tr>
<tr><td class="h">133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $from_userid, &#39;wt_list&#39; );</td></tr>
<tr><td class="h">134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $from_userid, &#39;watched&#39; );</td></tr>
<tr><td class="h">135</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $from_userid, &#39;trusted&#39; );</td></tr>
<tr><td class="h">136</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $to_userid, &#39;watched_by&#39; );</td></tr>
<tr><td class="h">137</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $to_userid, &#39;trusted_by&#39; );</td></tr>
<tr><td class="h">138</td><td colspan="7"></td></tr><tr><td class="h">139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# fire notifications if we have theschwartz</td></tr>
<tr><td class="h">140</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L140">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( my $sclient = LJ::theschwartz() ) {</td></tr>
<tr><td class="h">141</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L141">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L141">0</a></div><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L141">0</a></div><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L141">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $notify = LJ::is_enabled(&#39;esn&#39;) &amp;&amp;</td></tr>
<tr><td class="h">142</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$from_u-&gt;equals( $to_u ) &amp;&amp;</td></tr>
<tr><td class="h">143</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$from_u-&gt;is_visible &amp;&amp;</td></tr>
<tr><td class="h">144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $from_u-&gt;is_personal || $from_u-&gt;is_identity ) &amp;&amp;</td></tr>
<tr><td class="h">145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $to_u-&gt;is_personal || $to_u-&gt;is_identity ) &amp;&amp;</td></tr>
<tr><td class="h">146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$to_u-&gt;has_banned( $from_u ) ? 1 : 0;</td></tr>
<tr><td class="h">147</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L147">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L147">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $trust_notify = $notify &amp;&amp; !$trust_edge-&gt;{nonotify} ? 1 : 0;</td></tr>
<tr><td class="h">148</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L148">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L148">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $watch_notify = $notify &amp;&amp; !$watch_edge-&gt;{nonotify} ? 1 : 0;</td></tr>
<tr><td class="h">149</td><td colspan="7"></td></tr><tr><td class="h">150</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L150">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L150">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sclient-&gt;insert_jobs( LJ::Event::AddedToCircle-&gt;new( $to_u, $from_u, 1 )-&gt;fire_job )</td></tr>
<tr><td class="h">151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $do_trust &amp;&amp; $trust_notify;</td></tr>
<tr><td class="h">152</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L152">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L152">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sclient-&gt;insert_jobs( LJ::Event::AddedToCircle-&gt;new( $to_u, $from_u, 2 )-&gt;fire_job )</td></tr>
<tr><td class="h">153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $do_watch &amp;&amp; $watch_notify;</td></tr>
<tr><td class="h">154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">155</td><td colspan="7"></td></tr><tr><td class="h">156</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">158</td><td colspan="7"></td></tr><tr><td class="h">159</td><td colspan="7"></td></tr><tr><td class="h">160</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># internal method to delete an edge</td></tr>
<tr><td class="h">161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _del_wt_edge {</td></tr>
<tr><td class="h">162</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L162">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $from_u, $to_u, $edges ) = @_;</td></tr>
<tr><td class="h">163</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L163">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$from_u = LJ::want_user( $from_u ) or return 0;</td></tr>
<tr><td class="h">164</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L164">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$to_u = LJ::want_user( $to_u ) or return 0;</td></tr>
<tr><td class="h">165</td><td colspan="7"></td></tr><tr><td class="h">166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# determine if we&#39;re doing an update or a delete</td></tr>
<tr><td class="h">167</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $de_watch = delete $edges-&gt;{watch};</td></tr>
<tr><td class="h">168</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $de_trust = delete $edges-&gt;{trust};</td></tr>
<tr><td class="h">169</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L169">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L169">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $de_watch || $de_trust;</td></tr>
<tr><td class="h">170</td><td colspan="7"></td></tr><tr><td class="h">171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now setup some helper variables</td></tr>
<tr><td class="h">172</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L172">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $do_watch = $de_watch ? 1 : 0;</td></tr>
<tr><td class="h">173</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L173">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $do_trust = $de_trust ? 1 : 0;</td></tr>
<tr><td class="h">174</td><td colspan="7"></td></tr><tr><td class="h">175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get what we know</td></tr>
<tr><td class="h">176</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $does_watch = $from_u-&gt;watches( $to_u );</td></tr>
<tr><td class="h">177</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $does_trust = $from_u-&gt;trusts( $to_u );</td></tr>
<tr><td class="h">178</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L178">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L178">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $does_watch || $does_trust;</td></tr>
<tr><td class="h">179</td><td colspan="7"></td></tr><tr><td class="h">180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make sure we have a valid edge to remove</td></tr>
<tr><td class="h">181</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L181">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L181">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless</td></tr>
<tr><td class="h">182</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $de_watch &amp;&amp; $does_watch ) ||</td></tr>
<tr><td class="h">183</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $de_trust &amp;&amp; $does_trust );</td></tr>
<tr><td class="h">184</td><td colspan="7"></td></tr><tr><td class="h">185</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L185">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer()</td></tr>
<tr><td class="h">186</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return 0;</td></tr>
<tr><td class="h">187</td><td colspan="7"></td></tr><tr><td class="h">188</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# deletes are easy, these are cases where we&#39;re removing both edges,</td></tr>
<tr><td class="h">189</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# or removing the only remaining edge</td></tr>
<tr><td class="h">190</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L190">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L190">0</a></div><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L190">0</a></div><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L190">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( ( $de_watch &amp;&amp; $de_trust ) ||</td></tr>
<tr><td class="h">191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $de_watch &amp;&amp; $does_watch &amp;&amp; ! $does_trust ) ||</td></tr>
<tr><td class="h">192</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $de_trust &amp;&amp; $does_trust &amp;&amp; ! $does_watch ) ) {</td></tr>
<tr><td class="h">193</td><td colspan="7"></td></tr><tr><td class="h">194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do( &#39;DELETE FROM wt_edges WHERE from_userid = ? AND to_userid = ?&#39;,</td></tr>
<tr><td class="h">195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $from_u-&gt;id, $to_u-&gt;id );</td></tr>
<tr><td class="h">196</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L196">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">197</td><td colspan="7"></td></tr><tr><td class="h">198</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# at this point, we&#39;re guaranteed to have only the other edge remaining</td></tr>
<tr><td class="h">199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">200</td><td colspan="7"></td></tr><tr><td class="h">201</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L201">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mask = $de_trust ? 1 &lt;&lt; 61 : $from_u-&gt;trustmask( $to_u );</td></tr>
<tr><td class="h">202</td><td colspan="7"></td></tr><tr><td class="h">203</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do( &#39;UPDATE wt_edges SET groupmask = ? WHERE from_userid = ? AND to_userid = ?&#39;,</td></tr>
<tr><td class="h">204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $mask, $from_u-&gt;id, $to_u-&gt;id );</td></tr>
<tr><td class="h">205</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L205">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">206</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">207</td><td colspan="7"></td></tr><tr><td class="h">208</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# kill memcaches</td></tr>
<tr><td class="h">209</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $from_u, &#39;wt_edges&#39; );</td></tr>
<tr><td class="h">210</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $to_u, &#39;wt_edges_rev&#39; );</td></tr>
<tr><td class="h">211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $from_u, &#39;wt_list&#39; );</td></tr>
<tr><td class="h">212</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $from_u, &#39;watched&#39; );</td></tr>
<tr><td class="h">213</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $from_u, &#39;trusted&#39; );</td></tr>
<tr><td class="h">214</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $to_u, &#39;watched_by&#39; );</td></tr>
<tr><td class="h">215</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $to_u, &#39;trusted_by&#39; );</td></tr>
<tr><td class="h">216</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete( [$from_u-&gt;id, &quot;trustmask:&quot; . $from_u-&gt;id . &quot;:&quot; . $to_u-&gt;id] );</td></tr>
<tr><td class="h">217</td><td colspan="7"></td></tr><tr><td class="h">218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# fire notifications if we have theschwartz</td></tr>
<tr><td class="h">219</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L219">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( my $sclient = LJ::theschwartz() ) {</td></tr>
<tr><td class="h">220</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L220">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L220">0</a></div><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L220">0</a></div><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L220">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $notify = LJ::is_enabled(&#39;esn&#39;) &amp;&amp;</td></tr>
<tr><td class="h">221</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$from_u-&gt;equals( $to_u ) &amp;&amp;</td></tr>
<tr><td class="h">222</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$from_u-&gt;is_visible &amp;&amp;</td></tr>
<tr><td class="h">223</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $from_u-&gt;is_personal || $from_u-&gt;is_identity ) &amp;&amp;</td></tr>
<tr><td class="h">224</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $to_u-&gt;is_personal || $to_u-&gt;is_identity ) &amp;&amp;</td></tr>
<tr><td class="h">225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!$to_u-&gt;has_banned( $from_u ) ? 1 : 0;</td></tr>
<tr><td class="h">226</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L226">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L226">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $trust_notify = $notify &amp;&amp; !$de_trust-&gt;{nonotify} ? 1 : 0;</td></tr>
<tr><td class="h">227</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L227">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L227">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $watch_notify = $notify &amp;&amp; !$de_watch-&gt;{nonotify} ? 1 : 0;</td></tr>
<tr><td class="h">228</td><td colspan="7"></td></tr><tr><td class="h">229</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L229">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L229">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sclient-&gt;insert_jobs( LJ::Event::RemovedFromCircle-&gt;new( $to_u, $from_u, 1 )-&gt;fire_job )</td></tr>
<tr><td class="h">230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $do_trust &amp;&amp; $trust_notify;</td></tr>
<tr><td class="h">231</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L231">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L231">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sclient-&gt;insert_jobs( LJ::Event::RemovedFromCircle-&gt;new( $to_u, $from_u, 2 )-&gt;fire_job )</td></tr>
<tr><td class="h">232</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $do_watch &amp;&amp; $watch_notify;</td></tr>
<tr><td class="h">233</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">234</td><td colspan="7"></td></tr><tr><td class="h">235</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">237</td><td colspan="7"></td></tr><tr><td class="h">238</td><td colspan="7"></td></tr><tr><td class="h">239</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the valid version of a group name</td></tr>
<tr><td class="h">240</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub valid_group_name {</td></tr>
<tr><td class="h">241</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L241">0</a></div></td><td><div class="c0">0</div></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $name = shift;</td></tr>
<tr><td class="h">242</td><td colspan="7"></td></tr><tr><td class="h">243</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# strip off trailing slash(es)</td></tr>
<tr><td class="h">244</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$name =~ s!/+$!!;</td></tr>
<tr><td class="h">245</td><td colspan="7"></td></tr><tr><td class="h">246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# conform to maxes</td></tr>
<tr><td class="h">247</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$name = LJ::text_trim( $name, LJ::BMAX_GRPNAME2, LJ::CMAX_GRPNAME2 );</td></tr>
<tr><td class="h">248</td><td colspan="7"></td></tr><tr><td class="h">249</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $name;</td></tr>
<tr><td class="h">250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">251</td><td colspan="7"></td></tr><tr><td class="h">252</td><td colspan="7"></td></tr><tr><td class="h">253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###############################################################################</td></tr>
<tr><td class="h">254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</td></tr>
<tr><td class="h">255</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###############################################################################</td></tr>
<tr><td class="h">256</td><td colspan="7"></td></tr><tr><td class="h">257</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># push methods up into the DW::User namespace</td></tr>
<tr><td class="h">258</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package DW::User;</td></tr>
<tr><td class="h">259</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L259">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">260</td><td colspan="7"></td></tr><tr><td class="h">261</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L261">80</a></div></td><td></td><td><div>0</div><div>0</div><div>4000</div></td><td class="s">use Carp qw/ confess /;</td></tr>
<tr><td class="h">262</td><td colspan="7"></td></tr><tr><td class="h">263</td><td colspan="7"></td></tr><tr><td class="h">264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1 if the given user watches the given account</td></tr>
<tr><td class="h">265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 0 otherwise</td></tr>
<tr><td class="h">266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub watches {</td></tr>
<tr><td class="h">267</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L267">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $from_u, $to_u ) = @_;</td></tr>
<tr><td class="h">268</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L268">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$from_u = LJ::want_user( $from_u ) or return 0;</td></tr>
<tr><td class="h">269</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L269">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$to_u = LJ::want_user( $to_u ) or return 0;</td></tr>
<tr><td class="h">270</td><td colspan="7"></td></tr><tr><td class="h">271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now get the mask; note we have to use the internal method so we</td></tr>
<tr><td class="h">272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can get the real mask - without the top-bit masking that $u-&gt;trustmask</td></tr>
<tr><td class="h">273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# does...</td></tr>
<tr><td class="h">274</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mask = DW::User::Edges::WatchTrust::Loader::_trustmask( $from_u-&gt;id, $to_u-&gt;id );</td></tr>
<tr><td class="h">275</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L275">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ( $mask &amp; ( 1 &lt;&lt; 61 ) ) ? 1 : 0;</td></tr>
<tr><td class="h">276</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::watches = \&amp;watches;</td></tr>
<tr><td class="h">278</td><td colspan="7"></td></tr><tr><td class="h">279</td><td colspan="7"></td></tr><tr><td class="h">280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1 if you generally trust the target user</td></tr>
<tr><td class="h">281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 0 otherwise</td></tr>
<tr><td class="h">282</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trusts {</td></tr>
<tr><td class="h">283</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L283">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $from_u, $to_u ) = @_;</td></tr>
<tr><td class="h">284</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L284">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$from_u = LJ::want_user( $from_u ) or return 0;</td></tr>
<tr><td class="h">285</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L285">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$to_u = LJ::want_user( $to_u ) or return 0;</td></tr>
<tr><td class="h">286</td><td colspan="7"></td></tr><tr><td class="h">287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# you always trust yourself...</td></tr>
<tr><td class="h">288</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L288">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $from_u-&gt;id == $to_u-&gt;id;</td></tr>
<tr><td class="h">289</td><td colspan="7"></td></tr><tr><td class="h">290</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now get the mask; again with the internal mask method</td></tr>
<tr><td class="h">291</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mask = DW::User::Edges::WatchTrust::Loader::_trustmask( $from_u-&gt;id, $to_u-&gt;id );</td></tr>
<tr><td class="h">292</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L292">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ( $mask &amp; 1 ) ? 1 : 0;</td></tr>
<tr><td class="h">293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::trusts = \&amp;trusts;</td></tr>
<tr><td class="h">295</td><td colspan="7"></td></tr><tr><td class="h">296</td><td colspan="7"></td></tr><tr><td class="h">297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return 1/0 if the given user is mutually trusted</td></tr>
<tr><td class="h">298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mutually_trusts {</td></tr>
<tr><td class="h">299</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L299">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $from_u, $to_u ) = @_;</td></tr>
<tr><td class="h">300</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L300">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$from_u = LJ::want_user( $from_u ) or return 0;</td></tr>
<tr><td class="h">301</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L301">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$to_u = LJ::want_user( $to_u ) or return 0;</td></tr>
<tr><td class="h">302</td><td colspan="7"></td></tr><tr><td class="h">303</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L303">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L303">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $from_u-&gt;trusts( $to_u ) &amp;&amp;</td></tr>
<tr><td class="h">304</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$to_u-&gt;trusts( $from_u );</td></tr>
<tr><td class="h">305</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">306</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">307</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::mutually_trusts = \&amp;mutually_trusts;</td></tr>
<tr><td class="h">308</td><td colspan="7"></td></tr><tr><td class="h">309</td><td colspan="7"></td></tr><tr><td class="h">310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a numeric trustmask; can also be used as a setter if you specify a numeric</td></tr>
<tr><td class="h">311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># as the third argument.  in which case it returns the newly updated trustmask.</td></tr>
<tr><td class="h">312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trustmask {</td></tr>
<tr><td class="h">313</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L313">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $from_u, $to_u ) = @_;</td></tr>
<tr><td class="h">314</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L314">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$from_u = LJ::want_user( $from_u ) or return 0;</td></tr>
<tr><td class="h">315</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L315">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$to_u = LJ::want_user( $to_u ) or return 0;</td></tr>
<tr><td class="h">316</td><td colspan="7"></td></tr><tr><td class="h">317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we still have an argument, we need to set someone&#39;s mask</td></tr>
<tr><td class="h">318</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L318">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( scalar( @_ ) == 3 ) {</td></tr>
<tr><td class="h">319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# make sure we trust them... we have to do this here because otherwise we could</td></tr>
<tr><td class="h">320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# implicitly create a trust relationship when one doesn&#39;t exist</td></tr>
<tr><td class="h">321</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L321">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;attempted to set trustmask on non-trusted edge&#39;</td></tr>
<tr><td class="h">322</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $from_u-&gt;trusts( $to_u );</td></tr>
<tr><td class="h">323</td><td colspan="7"></td></tr><tr><td class="h">324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we update the mask by re-adding the trust edge; this is the simplest way</td></tr>
<tr><td class="h">325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# that ensures we do everything &quot;properly&quot;</td></tr>
<tr><td class="h">326</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$from_u-&gt;add_edge( $to_u, trust =&gt; { mask =&gt; $_[2], nonotify =&gt; 1 } );</td></tr>
<tr><td class="h">327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">328</td><td colspan="7"></td></tr><tr><td class="h">329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# note: we mask out the top three bits (i.e., the reserved bits and the watch bit)</td></tr>
<tr><td class="h">330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so external callers never see them.</td></tr>
<tr><td class="h">331</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::User::Edges::WatchTrust::Loader::_trustmask( $from_u-&gt;id, $to_u-&gt;id ) &amp; ~( 7 &lt;&lt; 61 );</td></tr>
<tr><td class="h">332</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::trustmask = \&amp;trustmask;</td></tr>
<tr><td class="h">334</td><td colspan="7"></td></tr><tr><td class="h">335</td><td colspan="7"></td></tr><tr><td class="h">336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::User::get_birthdays</td></tr>
<tr><td class="h">337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: get the upcoming birthdays for friends of a user. shows birthdays 3 months away by default</td></tr>
<tr><td class="h">338</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      pass in full =&gt; 1 to get all friends&#39; birthdays.</td></tr>
<tr><td class="h">339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: arrayref of [ month, day, username ] arrayrefs</td></tr>
<tr><td class="h">340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_birthdays {</td></tr>
<tr><td class="h">341</td><td colspan="7"></td></tr><tr><td class="h">342</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L342">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L342">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::want_user( shift )</td></tr>
<tr><td class="h">343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return undef;</td></tr>
<tr><td class="h">344</td><td colspan="7"></td></tr><tr><td class="h">345</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %opts = @_;</td></tr>
<tr><td class="h">346</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L346">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $months_ahead = $opts{months_ahead} || 3;</td></tr>
<tr><td class="h">347</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $full = $opts{full};</td></tr>
<tr><td class="h">348</td><td colspan="7"></td></tr><tr><td class="h">349</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# what day is it now?</td></tr>
<tr><td class="h">350</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now = $u-&gt;time_now;</td></tr>
<tr><td class="h">351</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($mnow, $dnow) = ($now-&gt;month, $now-&gt;day);</td></tr>
<tr><td class="h">352</td><td colspan="7"></td></tr><tr><td class="h">353</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L353">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;userid, &#39;bdays:&#39; . $u-&gt;userid . &#39;:&#39; . ($full ? &#39;full&#39; : $months_ahead)];</td></tr>
<tr><td class="h">354</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cached_bdays = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">355</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we cached the sorted data, don&#39;t need to re-sort</td></tr>
<tr><td class="h">356</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L356">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @$cached_bdays if $cached_bdays;</td></tr>
<tr><td class="h">357</td><td colspan="7"></td></tr><tr><td class="h">358</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L358">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @circle = $u-&gt;is_community ? $u-&gt;member_userids : $u-&gt;circle_userids;</td></tr>
<tr><td class="h">359</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $nb = LJ::User-&gt;next_birthdays( @circle );</td></tr>
<tr><td class="h">360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# returns ref to hash of form (userid =&gt; date)</td></tr>
<tr><td class="h">361</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uids = LJ::load_userids( keys %$nb );</td></tr>
<tr><td class="h">362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# returns ref to hash of form (userid =&gt; user object)</td></tr>
<tr><td class="h">363</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %timedata;</td></tr>
<tr><td class="h">364</td><td colspan="7"></td></tr><tr><td class="h">365</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while ( my ( $id, $u ) = each %$uids ) {</td></tr>
<tr><td class="h">366</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L366">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L366">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $u-&gt;is_personal &amp;&amp; $u-&gt;can_show_bday;</td></tr>
<tr><td class="h">367</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L367">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $date = $nb-&gt;{$id} or next;</td></tr>
<tr><td class="h">368</td><td colspan="7"></td></tr><tr><td class="h">369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# need numeric month and day</td></tr>
<tr><td class="h">370</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @lt = localtime( $date );</td></tr>
<tr><td class="h">371</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $month = $lt[4] + 1;</td></tr>
<tr><td class="h">372</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $day = $lt[3];</td></tr>
<tr><td class="h">373</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L373">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L373">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $month &gt; 0 &amp;&amp; $day &gt; 0;</td></tr>
<tr><td class="h">374</td><td colspan="7"></td></tr><tr><td class="h">375</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# skip over unless a few months away (except in full mode)</td></tr>
<tr><td class="h">376</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L376">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($full) {</td></tr>
<tr><td class="h">377</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the case where months_ahead doesn&#39;t wrap around to a new year</td></tr>
<tr><td class="h">378</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L378">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($mnow + $months_ahead &lt;= 12) {</td></tr>
<tr><td class="h">379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# discard old months</td></tr>
<tr><td class="h">380</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L380">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $month &lt; $mnow;</td></tr>
<tr><td class="h">381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# discard months too far in the future</td></tr>
<tr><td class="h">382</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L382">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $month &gt; $mnow + $months_ahead;</td></tr>
<tr><td class="h">383</td><td colspan="7"></td></tr><tr><td class="h">384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the case where we wrap around the end of the year (eg, oct-&gt;jan)</td></tr>
<tr><td class="h">385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">386</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we&#39;re okay if the month is in the future, because</td></tr>
<tr><td class="h">387</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we KNOW we&#39;re wrapping around. but if the month is</td></tr>
<tr><td class="h">388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# in the past, we need to verify that we&#39;ve wrapped</td></tr>
<tr><td class="h">389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# around and are still within the timeframe</td></tr>
<tr><td class="h">390</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L390">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L390">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if ($month &lt; $mnow) &amp;&amp; ($month &gt; ($mnow + $months_ahead) % 12);</td></tr>
<tr><td class="h">391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">392</td><td colspan="7"></td></tr><tr><td class="h">393</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# month is fine. check the day.</td></tr>
<tr><td class="h">394</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L394">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L394">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if ($month == $mnow &amp;&amp; $day &lt; $dnow);</td></tr>
<tr><td class="h">395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">396</td><td colspan="7"></td></tr><tr><td class="h">397</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$timedata{&quot;$date.$id&quot;} = [$month, $day, $u-&gt;user];</td></tr>
<tr><td class="h">398</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">399</td><td colspan="7"></td></tr><tr><td class="h">400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# hash slice for array sorted by date</td></tr>
<tr><td class="h">401</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @bdays = @timedata{ sort keys %timedata };</td></tr>
<tr><td class="h">402</td><td colspan="7"></td></tr><tr><td class="h">403</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set birthdays in memcache for later</td></tr>
<tr><td class="h">404</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, \@bdays, 86400);</td></tr>
<tr><td class="h">405</td><td colspan="7"></td></tr><tr><td class="h">406</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @bdays;</td></tr>
<tr><td class="h">407</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::get_birthdays = \&amp;get_birthdays;</td></tr>
<tr><td class="h">409</td><td colspan="7"></td></tr><tr><td class="h">410</td><td colspan="7"></td></tr><tr><td class="h">411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return users you trust</td></tr>
<tr><td class="h">412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trusted_users {</td></tr>
<tr><td class="h">413</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L413">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">414</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @trustids = $u-&gt;trusted_userids;</td></tr>
<tr><td class="h">415</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $users = LJ::load_userids(@trustids);</td></tr>
<tr><td class="h">416</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L416">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return values %$users if wantarray;</td></tr>
<tr><td class="h">417</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $users;</td></tr>
<tr><td class="h">418</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">419</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::trusted_users = \&amp;trusted_users;</td></tr>
<tr><td class="h">420</td><td colspan="7"></td></tr><tr><td class="h">421</td><td colspan="7"></td></tr><tr><td class="h">422</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return users you watch</td></tr>
<tr><td class="h">423</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub watched_users {</td></tr>
<tr><td class="h">424</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L424">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">425</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @watchids = $u-&gt;watched_userids;</td></tr>
<tr><td class="h">426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $users = LJ::load_userids(@watchids);</td></tr>
<tr><td class="h">427</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L427">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return values %$users if wantarray;</td></tr>
<tr><td class="h">428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $users;</td></tr>
<tr><td class="h">429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::watched_users = \&amp;watched_users;</td></tr>
<tr><td class="h">431</td><td colspan="7"></td></tr><tr><td class="h">432</td><td colspan="7"></td></tr><tr><td class="h">433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return users you watch and/or trust</td></tr>
<tr><td class="h">434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub circle_users {</td></tr>
<tr><td class="h">435</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L435">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">436</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @circleids = $u-&gt;circle_userids;</td></tr>
<tr><td class="h">437</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $users = LJ::load_userids(@circleids);</td></tr>
<tr><td class="h">438</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L438">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return values %$users if wantarray;</td></tr>
<tr><td class="h">439</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $users;</td></tr>
<tr><td class="h">440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::circle_users = \&amp;circle_users;</td></tr>
<tr><td class="h">442</td><td colspan="7"></td></tr><tr><td class="h">443</td><td colspan="7"></td></tr><tr><td class="h">444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns array of trusted by uids.  by default, limited at 50,000 items.</td></tr>
<tr><td class="h">445</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trusted_by_userids {</td></tr>
<tr><td class="h">446</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L446">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">447</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L447">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;not a valid user object&#39;;</td></tr>
<tr><td class="h">448</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L448">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $limit = int(delete $args{limit}) || 50000;</td></tr>
<tr><td class="h">449</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L449">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;unknown option&#39; if %args;</td></tr>
<tr><td class="h">450</td><td colspan="7"></td></tr><tr><td class="h">451</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::User::Edges::WatchTrust::Loader::_wt_userids(</td></tr>
<tr><td class="h">452</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u, limit =&gt; $limit, mode =&gt; &#39;trust&#39;, reverse =&gt; 1</td></tr>
<tr><td class="h">453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">454</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::trusted_by_userids = \&amp;trusted_by_userids;</td></tr>
<tr><td class="h">456</td><td colspan="7"></td></tr><tr><td class="h">457</td><td colspan="7"></td></tr><tr><td class="h">458</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns array of trusted uids.  by default, limited at 50,000 items.</td></tr>
<tr><td class="h">459</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trusted_userids {</td></tr>
<tr><td class="h">460</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L460">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">461</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L461">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;not a valid user object&#39;;</td></tr>
<tr><td class="h">462</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L462">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $limit = int(delete $args{limit}) || 50000;</td></tr>
<tr><td class="h">463</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L463">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;unknown option&#39; if %args;</td></tr>
<tr><td class="h">464</td><td colspan="7"></td></tr><tr><td class="h">465</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::User::Edges::WatchTrust::Loader::_wt_userids(</td></tr>
<tr><td class="h">466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u, limit =&gt; $limit, mode =&gt; &#39;trust&#39;</td></tr>
<tr><td class="h">467</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::trusted_userids = \&amp;trusted_userids;</td></tr>
<tr><td class="h">470</td><td colspan="7"></td></tr><tr><td class="h">471</td><td colspan="7"></td></tr><tr><td class="h">472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns array of watched by uids.  by default, limited at 50,000 items.</td></tr>
<tr><td class="h">473</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub watched_by_userids {</td></tr>
<tr><td class="h">474</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L474">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">475</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L475">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;not a valid user object&#39;;</td></tr>
<tr><td class="h">476</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L476">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $limit = int(delete $args{limit}) || 50000;</td></tr>
<tr><td class="h">477</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L477">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;unknown option&#39; if %args;</td></tr>
<tr><td class="h">478</td><td colspan="7"></td></tr><tr><td class="h">479</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::User::Edges::WatchTrust::Loader::_wt_userids(</td></tr>
<tr><td class="h">480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u, limit =&gt; $limit, mode =&gt; &#39;watch&#39;, reverse =&gt; 1</td></tr>
<tr><td class="h">481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">482</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::watched_by_userids = \&amp;watched_by_userids;</td></tr>
<tr><td class="h">484</td><td colspan="7"></td></tr><tr><td class="h">485</td><td colspan="7"></td></tr><tr><td class="h">486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns array of watched uids.  by default, limited at 50,000 items.</td></tr>
<tr><td class="h">487</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub watched_userids {</td></tr>
<tr><td class="h">488</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L488">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">489</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L489">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;not a valid user object&#39;;</td></tr>
<tr><td class="h">490</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L490">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $limit = int(delete $args{limit}) || 50000;</td></tr>
<tr><td class="h">491</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L491">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;unknown option&#39; if %args;</td></tr>
<tr><td class="h">492</td><td colspan="7"></td></tr><tr><td class="h">493</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::User::Edges::WatchTrust::Loader::_wt_userids(</td></tr>
<tr><td class="h">494</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u, limit =&gt; $limit, mode =&gt; &#39;watch&#39;</td></tr>
<tr><td class="h">495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">496</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">497</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::watched_userids = \&amp;watched_userids;</td></tr>
<tr><td class="h">498</td><td colspan="7"></td></tr><tr><td class="h">499</td><td colspan="7"></td></tr><tr><td class="h">500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns array of watched and/or trusted uids.</td></tr>
<tr><td class="h">501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub circle_userids {</td></tr>
<tr><td class="h">502</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L502">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">503</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L503">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;not a valid user object&#39;;</td></tr>
<tr><td class="h">504</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %circle;  # using a hash avoids duplicate elements</td></tr>
<tr><td class="h">505</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;map { $circle{$_}++ }</td></tr>
<tr><td class="h">506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $u-&gt;watched_userids( %args ), $u-&gt;trusted_userids( %args ) );</td></tr>
<tr><td class="h">507</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return keys %circle;</td></tr>
<tr><td class="h">508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">509</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::circle_userids = \&amp;circle_userids;</td></tr>
<tr><td class="h">510</td><td colspan="7"></td></tr><tr><td class="h">511</td><td colspan="7"></td></tr><tr><td class="h">512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns array of mutually watched userids.  by default, limit at 50k.</td></tr>
<tr><td class="h">513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># note that this function will be wildly inaccurate in any situation where</td></tr>
<tr><td class="h">514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># an account actually has more than 50k of either direction.  but we&#39;ll</td></tr>
<tr><td class="h">515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># cross that bridge when we come to it...</td></tr>
<tr><td class="h">516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mutually_watched_userids {</td></tr>
<tr><td class="h">517</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L517">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">518</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L518">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;not a valid user object&#39;;</td></tr>
<tr><td class="h">519</td><td colspan="7"></td></tr><tr><td class="h">520</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %mutual;</td></tr>
<tr><td class="h">521</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %watched_fwd = map { $_ =&gt; 1 } $u-&gt;watched_userids( %args );</td></tr>
<tr><td class="h">522</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $uid ( $u-&gt;watched_by_userids( %args ) ) {</td></tr>
<tr><td class="h">523</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L523">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mutual{$uid} = 1</td></tr>
<tr><td class="h">524</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if exists $watched_fwd{$uid};</td></tr>
<tr><td class="h">525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">526</td><td colspan="7"></td></tr><tr><td class="h">527</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return keys %mutual;</td></tr>
<tr><td class="h">528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::mutually_watched_userids = \&amp;mutually_watched_userids;</td></tr>
<tr><td class="h">530</td><td colspan="7"></td></tr><tr><td class="h">531</td><td colspan="7"></td></tr><tr><td class="h">532</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns array of mutually trusted userids.  by default, limit at 50k.</td></tr>
<tr><td class="h">533</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># same limitations as above.</td></tr>
<tr><td class="h">534</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mutually_trusted_userids {</td></tr>
<tr><td class="h">535</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L535">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">536</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L536">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;not a valid user object&#39;;</td></tr>
<tr><td class="h">537</td><td colspan="7"></td></tr><tr><td class="h">538</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %mutual;</td></tr>
<tr><td class="h">539</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %trusted_fwd = map { $_ =&gt; 1 } $u-&gt;trusted_userids( %args );</td></tr>
<tr><td class="h">540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $uid ( $u-&gt;trusted_by_userids( %args ) ) {</td></tr>
<tr><td class="h">541</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L541">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mutual{$uid} = 1</td></tr>
<tr><td class="h">542</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if exists $trusted_fwd{$uid};</td></tr>
<tr><td class="h">543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">544</td><td colspan="7"></td></tr><tr><td class="h">545</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return keys %mutual;</td></tr>
<tr><td class="h">546</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::mutually_trusted_userids = \&amp;mutually_trusted_userids;</td></tr>
<tr><td class="h">548</td><td colspan="7"></td></tr><tr><td class="h">549</td><td colspan="7"></td></tr><tr><td class="h">550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns hashref;</td></tr>
<tr><td class="h">551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">552</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   { userid =&gt;</td></tr>
<tr><td class="h">553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      { groupmask =&gt; NNN, fgcolor =&gt; &#39;#xxx&#39;, bgcolor =&gt; &#39;#xxx&#39;, showbydefault =&gt; NNN }</td></tr>
<tr><td class="h">554</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   }</td></tr>
<tr><td class="h">555</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># one entry in the hashref for everything the given user trusts.  note that fgcolor/bgcolor</td></tr>
<tr><td class="h">557</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># are only really useful for watched users, so these will be default/empty if the user</td></tr>
<tr><td class="h">558</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># is only trusted.</td></tr>
<tr><td class="h">559</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">560</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># arguments is a hash of options</td></tr>
<tr><td class="h">561</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    memcache_only =&gt; 1,     if set, never hit database</td></tr>
<tr><td class="h">562</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    force_database =&gt; 1,    if set, ALWAYS hit database (DANGER)</td></tr>
<tr><td class="h">563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trust_list {</td></tr>
<tr><td class="h">565</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L565">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">566</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L566">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">567</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L567">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memc_only = delete $args{memcache_only} || 0;</td></tr>
<tr><td class="h">568</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L568">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db_only = delete $args{force_database} || 0;</td></tr>
<tr><td class="h">569</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L569">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;extra/invalid arguments&#39; if %args;</td></tr>
<tr><td class="h">570</td><td colspan="7"></td></tr><tr><td class="h">571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# special case, we can disable loading friends for a user if there is a site</td></tr>
<tr><td class="h">572</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# problem or some other issue with this codebranch</td></tr>
<tr><td class="h">573</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L573">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef if $LJ::FORCE_EMPTY_FRIENDS{ $u-&gt;id };</td></tr>
<tr><td class="h">574</td><td colspan="7"></td></tr><tr><td class="h">575</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# attempt memcache if allowed</td></tr>
<tr><td class="h">576</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L576">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $db_only ) {</td></tr>
<tr><td class="h">577</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $memc = DW::User::Edges::WatchTrust::Loader::_trust_list_memc( $u );</td></tr>
<tr><td class="h">578</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L578">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $memc if $memc;</td></tr>
<tr><td class="h">579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">580</td><td colspan="7"></td></tr><tr><td class="h">581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# bail early if we are supposed to only hit memcache, this saves us from a</td></tr>
<tr><td class="h">582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# potentially expensive database call in codepaths that are best-effort</td></tr>
<tr><td class="h">583</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L583">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {} if $memc_only;</td></tr>
<tr><td class="h">584</td><td colspan="7"></td></tr><tr><td class="h">585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# damn you memcache for not having our data</td></tr>
<tr><td class="h">586</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::User::Edges::WatchTrust::Loader::_trust_list_db( $u, force_database =&gt; $db_only );</td></tr>
<tr><td class="h">587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::trust_list = \&amp;trust_list;</td></tr>
<tr><td class="h">589</td><td colspan="7"></td></tr><tr><td class="h">590</td><td colspan="7"></td></tr><tr><td class="h">591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns hashref;</td></tr>
<tr><td class="h">592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">593</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   { userid =&gt;</td></tr>
<tr><td class="h">594</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      { groupmask =&gt; NNN, fgcolor =&gt; &#39;#xxx&#39;, bgcolor =&gt; &#39;#xxx&#39;, showbydefault =&gt; NNN }</td></tr>
<tr><td class="h">595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   }</td></tr>
<tr><td class="h">596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">597</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># one entry in the hashref for everything the given user has in a particular trust</td></tr>
<tr><td class="h">598</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># group.  you can specify the group by id or name.</td></tr>
<tr><td class="h">599</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">600</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># arguments is a hash of options</td></tr>
<tr><td class="h">601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    id =&gt; 1,                if set, get members of trust group id 1</td></tr>
<tr><td class="h">602</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    name =&gt; &quot;Foo Group&quot;,    if set, get members of trust group &quot;Foo Group&quot;</td></tr>
<tr><td class="h">603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    memcache_only =&gt; 1,     if set, never hit database</td></tr>
<tr><td class="h">604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    force_database =&gt; 1,    if set, ALWAYS hit database (DANGER)</td></tr>
<tr><td class="h">605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">606</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trust_group_members {</td></tr>
<tr><td class="h">607</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L607">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">608</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L608">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">609</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L609">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memc_only = delete $args{memcache_only} || 0;</td></tr>
<tr><td class="h">610</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L610">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db_only = delete $args{force_database} || 0;</td></tr>
<tr><td class="h">611</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $name = delete $args{name};</td></tr>
<tr><td class="h">612</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $id = delete $args{id};</td></tr>
<tr><td class="h">613</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L613">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;extra/invalid arguments&#39; if %args;</td></tr>
<tr><td class="h">614</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L614">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L614">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;need one of: id, name&#39; unless $id || $name;</td></tr>
<tr><td class="h">615</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L615">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L615">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;do not need both: id, name&#39; if $id &amp;&amp; $name;</td></tr>
<tr><td class="h">616</td><td colspan="7"></td></tr><tr><td class="h">617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# special case, we can disable loading friends for a user if there is a site</td></tr>
<tr><td class="h">618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# problem or some other issue with this codebranch</td></tr>
<tr><td class="h">619</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L619">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef if $LJ::FORCE_EMPTY_FRIENDS{ $u-&gt;id };</td></tr>
<tr><td class="h">620</td><td colspan="7"></td></tr><tr><td class="h">621</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load the user&#39;s groups</td></tr>
<tr><td class="h">622</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $grp = $u-&gt;trust_groups( id =&gt; $id, name =&gt; $name );</td></tr>
<tr><td class="h">623</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L623">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {} unless $grp;</td></tr>
<tr><td class="h">624</td><td colspan="7"></td></tr><tr><td class="h">625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# calculate mask to use later</td></tr>
<tr><td class="h">626</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mask = 1 &lt;&lt; $grp-&gt;{groupnum};</td></tr>
<tr><td class="h">627</td><td colspan="7"></td></tr><tr><td class="h">628</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# attempt memcache if allowed</td></tr>
<tr><td class="h">629</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L629">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $db_only ) {</td></tr>
<tr><td class="h">630</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $memc = DW::User::Edges::WatchTrust::Loader::_trust_group_members_memc( $mask, $u );</td></tr>
<tr><td class="h">631</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L631">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $memc if $memc;</td></tr>
<tr><td class="h">632</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">633</td><td colspan="7"></td></tr><tr><td class="h">634</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# bail early if we are supposed to only hit memcache, this saves us from a</td></tr>
<tr><td class="h">635</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# potentially expensive database call in codepaths that are best-effort</td></tr>
<tr><td class="h">636</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L636">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {} if $memc_only;</td></tr>
<tr><td class="h">637</td><td colspan="7"></td></tr><tr><td class="h">638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# damn you memcache for not having our data</td></tr>
<tr><td class="h">639</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::User::Edges::WatchTrust::Loader::_trust_group_members_db( $mask, $u, force_database =&gt; $db_only );</td></tr>
<tr><td class="h">640</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::trust_group_members = \&amp;trust_group_members;</td></tr>
<tr><td class="h">642</td><td colspan="7"></td></tr><tr><td class="h">643</td><td colspan="7"></td></tr><tr><td class="h">644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns hashref;</td></tr>
<tr><td class="h">645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">646</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   { userid =&gt;</td></tr>
<tr><td class="h">647</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      { groupmask =&gt; NNN, fgcolor =&gt; &#39;#xxx&#39;, bgcolor =&gt; &#39;#xxx&#39;, showbydefault =&gt; NNN }</td></tr>
<tr><td class="h">648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   }</td></tr>
<tr><td class="h">649</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">650</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># one entry in the hashref for everything the given user is watching.</td></tr>
<tr><td class="h">651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">652</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># arguments is a hash of options</td></tr>
<tr><td class="h">653</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    memcache_only =&gt; 1,     if set, never hit database</td></tr>
<tr><td class="h">654</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    force_database =&gt; 1,    if set, ALWAYS hit database (DANGER)</td></tr>
<tr><td class="h">655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">656</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub watch_list {</td></tr>
<tr><td class="h">657</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L657">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %args ) = @_;</td></tr>
<tr><td class="h">658</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L658">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">659</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L659">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memc_only = delete $args{memcache_only} || 0;</td></tr>
<tr><td class="h">660</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L660">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db_only = delete $args{force_database} || 0;</td></tr>
<tr><td class="h">661</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L661">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comm_okay = delete $args{community_okay} || 0;</td></tr>
<tr><td class="h">662</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L662">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;extra/invalid arguments&#39; if %args;</td></tr>
<tr><td class="h">663</td><td colspan="7"></td></tr><tr><td class="h">664</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# special case, we can disable loading friends for a user if there is a site</td></tr>
<tr><td class="h">665</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# problem or some other issue with this codebranch</td></tr>
<tr><td class="h">666</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L666">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef if $LJ::FORCE_EMPTY_FRIENDS{ $u-&gt;id };</td></tr>
<tr><td class="h">667</td><td colspan="7"></td></tr><tr><td class="h">668</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# attempt memcache if allowed</td></tr>
<tr><td class="h">669</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L669">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $db_only ) {</td></tr>
<tr><td class="h">670</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $memc = DW::User::Edges::WatchTrust::Loader::_watch_list_memc( $u, community_okay =&gt; $comm_okay );</td></tr>
<tr><td class="h">671</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L671">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $memc if $memc;</td></tr>
<tr><td class="h">672</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">673</td><td colspan="7"></td></tr><tr><td class="h">674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# bail early if we are supposed to only hit memcache, this saves us from a</td></tr>
<tr><td class="h">675</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# potentially expensive database call in codepaths that are best-effort</td></tr>
<tr><td class="h">676</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L676">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {} if $memc_only;</td></tr>
<tr><td class="h">677</td><td colspan="7"></td></tr><tr><td class="h">678</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# damn you memcache for not having our data</td></tr>
<tr><td class="h">679</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::User::Edges::WatchTrust::Loader::_watch_list_db(</td></tr>
<tr><td class="h">680</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u,</td></tr>
<tr><td class="h">681</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;force_database =&gt; $db_only,</td></tr>
<tr><td class="h">682</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;community_okay =&gt; $comm_okay</td></tr>
<tr><td class="h">683</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">685</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::watch_list = \&amp;watch_list;</td></tr>
<tr><td class="h">686</td><td colspan="7"></td></tr><tr><td class="h">687</td><td colspan="7"></td></tr><tr><td class="h">688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># gets a hashref of trust group requested.  arguments is a hash of options</td></tr>
<tr><td class="h">689</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   id =&gt; NNN,      id of group to get</td></tr>
<tr><td class="h">690</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   name =&gt; &quot;ZZZ&quot;,  name of group to get</td></tr>
<tr><td class="h">691</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">692</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns undef if group not found</td></tr>
<tr><td class="h">693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">694</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trust_groups {</td></tr>
<tr><td class="h">695</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L695">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %opts ) = @_;</td></tr>
<tr><td class="h">696</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L696">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u )</td></tr>
<tr><td class="h">697</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">698</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bit = delete( $opts{id} )+0;</td></tr>
<tr><td class="h">699</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L699">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L699">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;invalid bit number&#39; if $bit &lt; 0 || $bit &gt; 60;</td></tr>
<tr><td class="h">700</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $name = lc delete( $opts{name} );</td></tr>
<tr><td class="h">701</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L701">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;invalid arguments&#39; if %opts;</td></tr>
<tr><td class="h">702</td><td colspan="7"></td></tr><tr><td class="h">703</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::User::Edges::WatchTrust::Loader::_trust_groups( $u, $bit, $name );</td></tr>
<tr><td class="h">704</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::trust_groups = \&amp;trust_groups;</td></tr>
<tr><td class="h">706</td><td colspan="7"></td></tr><tr><td class="h">707</td><td colspan="7"></td></tr><tr><td class="h">708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># edits a new trust_group, arguments is a hash of options</td></tr>
<tr><td class="h">709</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   id =&gt; NNN,           (optional) bit/ID of the group to edit (1..60)</td></tr>
<tr><td class="h">710</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   groupname =&gt; &quot;ZZZ&quot;,  name of this group</td></tr>
<tr><td class="h">711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   sortorder =&gt; NNN,    (optional) sort order (0..255)</td></tr>
<tr><td class="h">712</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   is_public =&gt; 1/0,    (optional) defaults to 0</td></tr>
<tr><td class="h">713</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># arguments are used to create the group.  if you don&#39;t specify an id then one</td></tr>
<tr><td class="h">715</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># will be automatically created for you.</td></tr>
<tr><td class="h">716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">717</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns id of new group.</td></tr>
<tr><td class="h">718</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_trust_group {</td></tr>
<tr><td class="h">720</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L720">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %opts ) = @_;</td></tr>
<tr><td class="h">721</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L721">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u )</td></tr>
<tr><td class="h">722</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">723</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $grp = $u-&gt;trust_groups;</td></tr>
<tr><td class="h">724</td><td colspan="7"></td></tr><tr><td class="h">725</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# calculate an id to use</td></tr>
<tr><td class="h">726</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $id = delete( $opts{id} )+0;</td></tr>
<tr><td class="h">727</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L727">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L727">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;group with that id already exists&#39;</td></tr>
<tr><td class="h">728</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $id &gt; 0 &amp;&amp; exists $grp-&gt;{$id};</td></tr>
<tr><td class="h">729</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L729">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;($id) ||= (grep { ! exists $grp-&gt;{$_} } 1..60)[0];</td></tr>
<tr><td class="h">730</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L730">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L730">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;id invalid&#39;</td></tr>
<tr><td class="h">731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $id &lt; 1 || $id &gt; 60;</td></tr>
<tr><td class="h">732</td><td colspan="7"></td></tr><tr><td class="h">733</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# validate other parameters</td></tr>
<tr><td class="h">734</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L734">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L734">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;invalid sortorder (not in range 0..255)&#39;</td></tr>
<tr><td class="h">735</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if exists $opts{sortorder} &amp;&amp; $opts{sortorder} !~ /^\d+$/;</td></tr>
<tr><td class="h">736</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L736">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L736">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;invalid is_public (not 1/0)&#39;</td></tr>
<tr><td class="h">737</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if exists $opts{is_public} &amp;&amp; $opts{is_public} !~ /^(?:0|1)$/;</td></tr>
<tr><td class="h">738</td><td colspan="7"></td></tr><tr><td class="h">739</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# need a name</td></tr>
<tr><td class="h">740</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts{groupname} = DW::User::Edges::WatchTrust::valid_group_name( $opts{groupname} );</td></tr>
<tr><td class="h">741</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L741">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;name not provided&#39;</td></tr>
<tr><td class="h">742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $opts{groupname};</td></tr>
<tr><td class="h">743</td><td colspan="7"></td></tr><tr><td class="h">744</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now perform an edit with our chosen id</td></tr>
<tr><td class="h">745</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L745">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $id</td></tr>
<tr><td class="h">746</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $u-&gt;edit_trust_group( id =&gt; $id, _force_create =&gt; 1, %opts );</td></tr>
<tr><td class="h">747</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">748</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">749</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::create_trust_group = \&amp;create_trust_group;</td></tr>
<tr><td class="h">750</td><td colspan="7"></td></tr><tr><td class="h">751</td><td colspan="7"></td></tr><tr><td class="h">752</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># edits a new trust_group, arguments is a hash of options</td></tr>
<tr><td class="h">753</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   id =&gt; NNN,           bit/ID of the group to edit (1..60)</td></tr>
<tr><td class="h">754</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   groupname =&gt; &quot;ZZZ&quot;,  (optional) name of this group</td></tr>
<tr><td class="h">755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   sortorder =&gt; NNN,    (optional) sort order (0..255)</td></tr>
<tr><td class="h">756</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   is_public =&gt; 1/0,    (optional) defaults to 0</td></tr>
<tr><td class="h">757</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># arguments are used to update the group, if you don&#39;t specify a particular</td></tr>
<tr><td class="h">759</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># parameter then we won&#39;t update that column.</td></tr>
<tr><td class="h">760</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">761</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1/0.</td></tr>
<tr><td class="h">762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">763</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub edit_trust_group {</td></tr>
<tr><td class="h">764</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L764">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %opts ) = @_;</td></tr>
<tr><td class="h">765</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L765">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u )</td></tr>
<tr><td class="h">766</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">767</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $id = delete( $opts{id} )+0;</td></tr>
<tr><td class="h">768</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L768">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L768">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;invalid id number&#39; if $id &lt; 0 || $id &gt; 60;</td></tr>
<tr><td class="h">769</td><td colspan="7"></td></tr><tr><td class="h">770</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# and just in case they didn&#39;t tell us to change anything...</td></tr>
<tr><td class="h">771</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L771">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless %opts;</td></tr>
<tr><td class="h">772</td><td colspan="7"></td></tr><tr><td class="h">773</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get current trust groups</td></tr>
<tr><td class="h">774</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $grps = $u-&gt;trust_groups;</td></tr>
<tr><td class="h">775</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L775">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L775">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless exists $grps-&gt;{$id} || $opts{_force_create};</td></tr>
<tr><td class="h">776</td><td colspan="7"></td></tr><tr><td class="h">777</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now calculate what to change</td></tr>
<tr><td class="h">778</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %change = (</td></tr>
<tr><td class="h">779</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sortorder =&gt; $grps-&gt;{$id}-&gt;{sortorder},</td></tr>
<tr><td class="h">780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groupname =&gt; $grps-&gt;{$id}-&gt;{groupname},</td></tr>
<tr><td class="h">781</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_public =&gt; $grps-&gt;{$id}-&gt;{is_public},</td></tr>
<tr><td class="h">782</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">783</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L783">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L783">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$change{sortorder} = $opts{sortorder}</td></tr>
<tr><td class="h">784</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if exists $opts{sortorder} &amp;&amp; $opts{sortorder} =~ /^\d+$/;</td></tr>
<tr><td class="h">785</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L785">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$change{groupname} = DW::User::Edges::WatchTrust::valid_group_name( $opts{groupname} )</td></tr>
<tr><td class="h">786</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if exists $opts{groupname};</td></tr>
<tr><td class="h">787</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L787">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L787">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$change{is_public} = $opts{is_public}</td></tr>
<tr><td class="h">788</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if exists $opts{is_public} &amp;&amp; $opts{is_public} =~ /^(?:0|1)$/;</td></tr>
<tr><td class="h">789</td><td colspan="7"></td></tr><tr><td class="h">790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update the database</td></tr>
<tr><td class="h">791</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L791">0</a></div><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L791">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do( &#39;REPLACE INTO trust_groups (userid, groupnum, groupname, sortorder, is_public) VALUES (?, ?, ?, ?, ?)&#39;,</td></tr>
<tr><td class="h">792</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id, $id, $change{groupname}, $change{sortorder} || 50, $change{is_public} || 0 );</td></tr>
<tr><td class="h">793</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L793">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess $u-&gt;errstr if $u-&gt;err;</td></tr>
<tr><td class="h">794</td><td colspan="7"></td></tr><tr><td class="h">795</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# kill memcache and return</td></tr>
<tr><td class="h">796</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $u, &#39;trust_group&#39; );</td></tr>
<tr><td class="h">797</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">798</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::edit_trust_group = \&amp;edit_trust_group;</td></tr>
<tr><td class="h">800</td><td colspan="7"></td></tr><tr><td class="h">801</td><td colspan="7"></td></tr><tr><td class="h">802</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># deletes a trust_group, arguments is a hash of options</td></tr>
<tr><td class="h">803</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   id =&gt; NNN,       delete by id (1..60)</td></tr>
<tr><td class="h">804</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   name =&gt; &quot;ZZZ&quot;,   or delete by name</td></tr>
<tr><td class="h">805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">806</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># specify either the id or the name.  note that deletion is a rather permanent</td></tr>
<tr><td class="h">807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># option that will remove this group from all entries that are secured to it</td></tr>
<tr><td class="h">808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># as well as remove this bit from all trustmasks.</td></tr>
<tr><td class="h">809</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">810</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1/0.</td></tr>
<tr><td class="h">811</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_trust_group {</td></tr>
<tr><td class="h">813</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L813">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %opts ) = @_;</td></tr>
<tr><td class="h">814</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L814">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">815</td><td colspan="7"></td></tr><tr><td class="h">816</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# use existing accessor to figure out what group they mean</td></tr>
<tr><td class="h">817</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $grp = $u-&gt;trust_groups( id =&gt; $opts{id}, name =&gt; $opts{name} );</td></tr>
<tr><td class="h">818</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L818">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $grp;</td></tr>
<tr><td class="h">819</td><td colspan="7"></td></tr><tr><td class="h">820</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set bit to remove</td></tr>
<tr><td class="h">821</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bit = $grp-&gt;{groupnum}+0;</td></tr>
<tr><td class="h">822</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L822">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L822">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $bit &gt;= 1 &amp;&amp; $bit &lt;= 60;</td></tr>
<tr><td class="h">823</td><td colspan="7"></td></tr><tr><td class="h">824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove all posts from allowing that group:</td></tr>
<tr><td class="h">825</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L825">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @posts_to_clean = @{ $u-&gt;selectcol_arrayref(</td></tr>
<tr><td class="h">826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q{SELECT jitemid FROM logsec2 WHERE journalid = ? AND allowmask &amp; (1 &lt;&lt; ?)},</td></tr>
<tr><td class="h">827</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id, $bit</td></tr>
<tr><td class="h">828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;) || [] };</td></tr>
<tr><td class="h">829</td><td colspan="7"></td></tr><tr><td class="h">830</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now clean the posts while we can, this is a loop so we can do it in blocks of twenty</td></tr>
<tr><td class="h">831</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# as it&#39;s somewhat hard on the database to do this enmasse</td></tr>
<tr><td class="h">832</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;id; # convenience</td></tr>
<tr><td class="h">833</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while ( @posts_to_clean ) {</td></tr>
<tr><td class="h">834</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @batch = splice( @posts_to_clean, 0, 50 );</td></tr>
<tr><td class="h">835</td><td colspan="7"></td></tr><tr><td class="h">836</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# actually updates the entries.  note that we do not return an error here because</td></tr>
<tr><td class="h">837</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# it&#39;s not the end of the world if one of these fails...</td></tr>
<tr><td class="h">838</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = join &#39;,&#39;, @batch;</td></tr>
<tr><td class="h">839</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;UPDATE log2 SET allowmask=allowmask &amp; ~(1 &lt;&lt; $bit) &quot;.</td></tr>
<tr><td class="h">840</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$userid AND jitemid IN ($in) AND security=&#39;usemask&#39;&quot;);</td></tr>
<tr><td class="h">841</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;UPDATE logsec2 SET allowmask=allowmask &amp; ~(1 &lt;&lt; $bit) &quot;.</td></tr>
<tr><td class="h">842</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=$userid AND jitemid IN ($in)&quot;);</td></tr>
<tr><td class="h">843</td><td colspan="7"></td></tr><tr><td class="h">844</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $id (@batch) {</td></tr>
<tr><td class="h">845</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete([$userid, &quot;log2:$userid:$id&quot;]);</td></tr>
<tr><td class="h">846</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">847</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete([$userid, &quot;log2lt:$userid&quot;]);</td></tr>
<tr><td class="h">848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">849</td><td colspan="7"></td></tr><tr><td class="h">850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# notify the tags system so it can do its thing</td></tr>
<tr><td class="h">851</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Tags::deleted_trust_group( $u, $bit );</td></tr>
<tr><td class="h">852</td><td colspan="7"></td></tr><tr><td class="h">853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# used here down</td></tr>
<tr><td class="h">854</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L854">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer()</td></tr>
<tr><td class="h">855</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return 0;</td></tr>
<tr><td class="h">856</td><td colspan="7"></td></tr><tr><td class="h">857</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# iterate over everybody in this group and remove the bit</td></tr>
<tr><td class="h">858</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $tglist = $u-&gt;trust_group_members( id =&gt; $bit, force_database =&gt; 1 );</td></tr>
<tr><td class="h">859</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L859">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $tid ( keys %{ $tglist || {} } ) {</td></tr>
<tr><td class="h">860</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(</td></tr>
<tr><td class="h">861</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q{UPDATE wt_edges SET groupmask = groupmask &amp; ~(1 &lt;&lt; ?) WHERE from_userid = ? AND to_userid = ?},</td></tr>
<tr><td class="h">862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $bit, $u-&gt;id, $tid</td></tr>
<tr><td class="h">863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">864</td><td colspan="7"></td></tr><tr><td class="h">865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t forget memcache</td></tr>
<tr><td class="h">866</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete( [$userid, &quot;trustmask:$userid:$tid&quot;] );</td></tr>
<tr><td class="h">867</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">868</td><td colspan="7"></td></tr><tr><td class="h">869</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# finally remove the trust group, huzzah</td></tr>
<tr><td class="h">870</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(</td></tr>
<tr><td class="h">871</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q{DELETE FROM trust_groups WHERE userid = ? AND groupnum = ?},</td></tr>
<tr><td class="h">872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id, $bit</td></tr>
<tr><td class="h">873</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">874</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L874">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;err;</td></tr>
<tr><td class="h">875</td><td colspan="7"></td></tr><tr><td class="h">876</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# invalidate memcache of friends/groups</td></tr>
<tr><td class="h">877</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $u-&gt;id, &quot;trust_group&quot; );</td></tr>
<tr><td class="h">878</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill( $u-&gt;id, &quot;wt_list&quot; );</td></tr>
<tr><td class="h">879</td><td colspan="7"></td></tr><tr><td class="h">880</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# sister mary of the holy hand grenade says hi and apologies if any of the</td></tr>
<tr><td class="h">881</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# above failed.  we think it worked by this point, though.</td></tr>
<tr><td class="h">882</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">884</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::delete_trust_group = \&amp;delete_trust_group;</td></tr>
<tr><td class="h">885</td><td colspan="7"></td></tr><tr><td class="h">886</td><td colspan="7"></td></tr><tr><td class="h">887</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># alters a trustmask to munge someone&#39;s group membership</td></tr>
<tr><td class="h">888</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">889</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   $u-&gt;edit_trustmask( $otheru, ARGUMENTS )</td></tr>
<tr><td class="h">890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">891</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># where ARGUMENTS can be one or more of:</td></tr>
<tr><td class="h">892</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   set =&gt; [ 1, 3 ]        put $otheru in groups 1 and 3 only, remove from others</td></tr>
<tr><td class="h">894</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   add =&gt; [ 1, 3 ]        add $otheru to groups 1 and 3</td></tr>
<tr><td class="h">895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   remove =&gt; [ 1, 3 ]     remove $otheru from groups 1 and 3</td></tr>
<tr><td class="h">896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">897</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># if you are only adding/removing/setting a single group, you may pass the argument</td></tr>
<tr><td class="h">898</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># as a single number, not an arrayref.  e.g.,</td></tr>
<tr><td class="h">899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">900</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   $u-&gt;edit_trustmask( $otheru, add =&gt; 5 )</td></tr>
<tr><td class="h">901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># adds $otheru to group 5.</td></tr>
<tr><td class="h">903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># NOTE: passing the &#39;set&#39; argument will override &#39;add&#39; and &#39;remove&#39; so they have no</td></tr>
<tr><td class="h">905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># effect in the same call.  (so use either set or add/remove.  not both.)</td></tr>
<tr><td class="h">906</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">907</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1 on success, 0 on error.</td></tr>
<tr><td class="h">908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub edit_trustmask {</td></tr>
<tr><td class="h">910</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L910">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $tu, %opts ) = @_;</td></tr>
<tr><td class="h">911</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L911">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">912</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L912">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$tu = LJ::want_user( $tu ) or confess &#39;invalid target user object&#39;;</td></tr>
<tr><td class="h">913</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L913">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;trusts( $tu );</td></tr>
<tr><td class="h">914</td><td colspan="7"></td></tr><tr><td class="h">915</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# there&#39;s got to be a better way of doing this... but we want our arrays to only</td></tr>
<tr><td class="h">916</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# contain valid group ids</td></tr>
<tr><td class="h">917</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L917">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L917">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @add = grep { $_ &gt;= 1 &amp;&amp; $_ &lt;= 60 } map { $_ + 0 } @{ ref $opts{add} ? $opts{add} : [$opts{add}] };</td></tr>
<tr><td class="h">918</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L918">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L918">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @del = grep { $_ &gt;= 1 &amp;&amp; $_ &lt;= 60 } map { $_ + 0 } @{ ref $opts{remove} ? $opts{remove} : [$opts{remove}] };</td></tr>
<tr><td class="h">919</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L919">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L919">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @set = grep { $_ &gt;= 1 &amp;&amp; $_ &lt;= 60 } map { $_ + 0 } @{ ref $opts{set} ? $opts{set} : [$opts{set}] };</td></tr>
<tr><td class="h">920</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L920">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L920">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $do_clear = ( ref $opts{set} eq &#39;ARRAY&#39; &amp;&amp; scalar( @set ) == 0 ) ? 1 : 0;</td></tr>
<tr><td class="h">921</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L921">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L921">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless @add || @del || @set || $do_clear;</td></tr>
<tr><td class="h">922</td><td colspan="7"></td></tr><tr><td class="h">923</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# this is a special case, they said &quot;set =&gt; []&quot; with an empty arrayref,</td></tr>
<tr><td class="h">924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so we remove this person&#39;s membership from all groups</td></tr>
<tr><td class="h">925</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L925">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $do_clear ) {</td></tr>
<tr><td class="h">926</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;trustmask( $tu, 0 );</td></tr>
<tr><td class="h">927</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">929</td><td colspan="7"></td></tr><tr><td class="h">930</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we&#39;re only doing a set, we can do that easily too</td></tr>
<tr><td class="h">931</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L931">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( @set ) {</td></tr>
<tr><td class="h">932</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mask = 0;</td></tr>
<tr><td class="h">933</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mask += ( 1 &lt;&lt; $_ ) foreach @set;</td></tr>
<tr><td class="h">934</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;trustmask( $tu, $mask );</td></tr>
<tr><td class="h">935</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">937</td><td colspan="7"></td></tr><tr><td class="h">938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# hard path, we need to break down a user&#39;s mask and then update it</td></tr>
<tr><td class="h">939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# and send out a new one</td></tr>
<tr><td class="h">940</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mask = $u-&gt;trustmask( $tu );</td></tr>
<tr><td class="h">941</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %groups = map { $_ =&gt; 1 } grep { $mask &amp; ( 1 &lt;&lt; $_ ) } 1..60;</td></tr>
<tr><td class="h">942</td><td colspan="7"></td></tr><tr><td class="h">943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now process adds/deletes</td></tr>
<tr><td class="h">944</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$groups{$_} = 1 foreach @add;</td></tr>
<tr><td class="h">945</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;delete $groups{$_} foreach @del;</td></tr>
<tr><td class="h">946</td><td colspan="7"></td></tr><tr><td class="h">947</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now set it back and we&#39;re done</td></tr>
<tr><td class="h">948</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$mask = 0;</td></tr>
<tr><td class="h">949</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$mask += ( 1 &lt;&lt; $_ ) foreach keys %groups;</td></tr>
<tr><td class="h">950</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;trustmask( $tu, $mask );</td></tr>
<tr><td class="h">951</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">953</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::edit_trustmask = \&amp;edit_trustmask;</td></tr>
<tr><td class="h">954</td><td colspan="7"></td></tr><tr><td class="h">955</td><td colspan="7"></td></tr><tr><td class="h">956</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># give a user and a group, returns if they are in that group</td></tr>
<tr><td class="h">957</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trust_group_contains {</td></tr>
<tr><td class="h">958</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L958">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $tu, $gid ) = @_;</td></tr>
<tr><td class="h">959</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L959">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">960</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L960">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$tu = LJ::want_user( $tu ) or confess &#39;invalid target user object&#39;;</td></tr>
<tr><td class="h">961</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$gid = $gid + 0;</td></tr>
<tr><td class="h">962</td><td colspan="7"></td></tr><tr><td class="h">963</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L963">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L963">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $gid &gt;= 1 &amp;&amp; $gid &lt;= 60;</td></tr>
<tr><td class="h">964</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L964">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;trustmask( $tu ) &amp; ( 1 &lt;&lt; $gid );</td></tr>
<tr><td class="h">965</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">966</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">967</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::trust_group_contains = \&amp;trust_group_contains;</td></tr>
<tr><td class="h">968</td><td colspan="7"></td></tr><tr><td class="h">969</td><td colspan="7"></td></tr><tr><td class="h">970</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1/0 depending on if the source is allowed to add a trust edge</td></tr>
<tr><td class="h">971</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># to the target.  note: if you don&#39;t pass a target user, then we return</td></tr>
<tr><td class="h">972</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># a generic 1/0 meaning &quot;this account is allowed to have a trust edge&quot;.</td></tr>
<tr><td class="h">973</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_trust {</td></tr>
<tr><td class="h">974</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L974">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $tu, %opts ) = @_;</td></tr>
<tr><td class="h">975</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L975">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">976</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$tu = LJ::want_user( $tu );</td></tr>
<tr><td class="h">977</td><td colspan="7"></td></tr><tr><td class="h">978</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $errref = $opts{errref};</td></tr>
<tr><td class="h">979</td><td colspan="7"></td></tr><tr><td class="h">980</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the user must be an individual</td></tr>
<tr><td class="h">981</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L981">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $u-&gt;is_individual ) {</td></tr>
<tr><td class="h">982</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml( &#39;edges.trust.error.usernotindividual&#39; );</td></tr>
<tr><td class="h">983</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">984</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">985</td><td colspan="7"></td></tr><tr><td class="h">986</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the user must be visible</td></tr>
<tr><td class="h">987</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L987">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $u-&gt;is_visible ) {</td></tr>
<tr><td class="h">988</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml( &#39;edges.trust.error.usernotvisible&#39; );</td></tr>
<tr><td class="h">989</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">991</td><td colspan="7"></td></tr><tr><td class="h">992</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L992">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $tu ) {</td></tr>
<tr><td class="h">993</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the user cannot be the same as the target</td></tr>
<tr><td class="h">994</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L994">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;equals( $tu ) ) {</td></tr>
<tr><td class="h">995</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml( &#39;edges.trust.error.userequalstarget&#39; );</td></tr>
<tr><td class="h">996</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">997</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">998</td><td colspan="7"></td></tr><tr><td class="h">999</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the target must be an individual</td></tr>
<tr><td class="h">1000</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1000">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ( $tu-&gt;is_individual ) {</td></tr>
<tr><td class="h">1001</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml( &#39;edges.trust.error.targetnotindividual&#39; );</td></tr>
<tr><td class="h">1002</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1003</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1004</td><td colspan="7"></td></tr><tr><td class="h">1005</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the target must not be purged/suspended/locked</td></tr>
<tr><td class="h">1006</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1006">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L1006">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $tu-&gt;is_expunged || $tu-&gt;is_suspended || $tu-&gt;is_locked ) {</td></tr>
<tr><td class="h">1007</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml( &#39;edges.trust.error.targetinvalidstatusvis&#39; );</td></tr>
<tr><td class="h">1008</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1009</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1010</td><td colspan="7"></td></tr><tr><td class="h">1011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the target must not be banned by the user</td></tr>
<tr><td class="h">1012</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1012">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;has_banned( $tu ) ) {</td></tr>
<tr><td class="h">1013</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml( &#39;edges.trust.error.userbannedtarget&#39; );</td></tr>
<tr><td class="h">1014</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1016</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1017</td><td colspan="7"></td></tr><tr><td class="h">1018</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# okay, good to go!</td></tr>
<tr><td class="h">1019</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1020</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1021</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::can_trust = \&amp;can_trust;</td></tr>
<tr><td class="h">1022</td><td colspan="7"></td></tr><tr><td class="h">1023</td><td colspan="7"></td></tr><tr><td class="h">1024</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1/0 depending on if the source is allowed to add a watch edge</td></tr>
<tr><td class="h">1025</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># to the target.  note: if you don&#39;t pass a target user, then we return</td></tr>
<tr><td class="h">1026</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># a generic 1/0 meaning &quot;this account is allowed to have a watch edge&quot;.</td></tr>
<tr><td class="h">1027</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_watch {</td></tr>
<tr><td class="h">1028</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L1028">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $tu, %opts ) = @_;</td></tr>
<tr><td class="h">1029</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1029">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or confess &#39;invalid user object&#39;;</td></tr>
<tr><td class="h">1030</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$tu = LJ::want_user( $tu );</td></tr>
<tr><td class="h">1031</td><td colspan="7"></td></tr><tr><td class="h">1032</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $errref = $opts{errref};</td></tr>
<tr><td class="h">1033</td><td colspan="7"></td></tr><tr><td class="h">1034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the user must be an individual</td></tr>
<tr><td class="h">1035</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1035">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $u-&gt;is_individual ) {</td></tr>
<tr><td class="h">1036</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml( &#39;edges.watch.error.usernotindividual&#39; );</td></tr>
<tr><td class="h">1037</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1038</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1039</td><td colspan="7"></td></tr><tr><td class="h">1040</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the user must be visible</td></tr>
<tr><td class="h">1041</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1041">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $u-&gt;is_visible ) {</td></tr>
<tr><td class="h">1042</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml( &#39;edges.watch.error.usernotvisible&#39; );</td></tr>
<tr><td class="h">1043</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1044</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1045</td><td colspan="7"></td></tr><tr><td class="h">1046</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1046">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $tu ) {</td></tr>
<tr><td class="h">1047</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the target must not be purged/suspended/locked</td></tr>
<tr><td class="h">1048</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1048">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L1048">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $tu-&gt;is_expunged || $tu-&gt;is_suspended || $tu-&gt;is_locked ) {</td></tr>
<tr><td class="h">1049</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = LJ::Lang::ml( &#39;edges.watch.error.targetinvalidstatusvis&#39; );</td></tr>
<tr><td class="h">1050</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1053</td><td colspan="7"></td></tr><tr><td class="h">1054</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# okay, good to go!</td></tr>
<tr><td class="h">1055</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1056</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*LJ::User::can_watch = \&amp;can_watch;</td></tr>
<tr><td class="h">1058</td><td colspan="7"></td></tr><tr><td class="h">1059</td><td colspan="7"></td></tr><tr><td class="h">1060</td><td colspan="7"></td></tr><tr><td class="h">1061</td><td colspan="7"></td></tr><tr><td class="h">1062</td><td colspan="7"></td></tr><tr><td class="h">1063</td><td colspan="7"></td></tr><tr><td class="h">1064</td><td colspan="7"></td></tr><tr><td class="h">1065</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># internal helper sub to determine if we&#39;re at the rate limit</td></tr>
<tr><td class="h">1066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _can_add_wt_edge {</td></tr>
<tr><td class="h">1067</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--subroutine.html#L1067">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $err, $opts) = @_;</td></tr>
<tr><td class="h">1068</td><td colspan="7"></td></tr><tr><td class="h">1069</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1069">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_suspended) {</td></tr>
<tr><td class="h">1070</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$err = &quot;Suspended journals cannot add friends.&quot;;</td></tr>
<tr><td class="h">1071</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1072</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1073</td><td colspan="7"></td></tr><tr><td class="h">1074</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# have they reached their friend limit?</td></tr>
<tr><td class="h">1075</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L1075">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $fr_count = $opts-&gt;{&#39;numfriends&#39;} || $u-&gt;friend_uids;</td></tr>
<tr><td class="h">1076</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $maxfriends = $u-&gt;get_cap(&#39;maxfriends&#39;);</td></tr>
<tr><td class="h">1077</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1077">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($fr_count &gt;= $maxfriends) {</td></tr>
<tr><td class="h">1078</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$err = &quot;You have reached your limit of $maxfriends friends.&quot;;</td></tr>
<tr><td class="h">1079</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1080</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1081</td><td colspan="7"></td></tr><tr><td class="h">1082</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# are they trying to add friends too quickly?</td></tr>
<tr><td class="h">1083</td><td colspan="7"></td></tr><tr><td class="h">1084</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t count mutual friends</td></tr>
<tr><td class="h">1085</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1085">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (exists($opts-&gt;{friend})) {</td></tr>
<tr><td class="h">1086</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fr_user = $opts-&gt;{friend};</td></tr>
<tr><td class="h">1087</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we needed LJ::User object, not just a hash.</td></tr>
<tr><td class="h">1088</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1088">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ref($fr_user) eq &#39;HASH&#39;) {</td></tr>
<tr><td class="h">1089</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fr_user = LJ::load_user($fr_user-&gt;{username});</td></tr>
<tr><td class="h">1090</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1091</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fr_user = LJ::want_user($fr_user);</td></tr>
<tr><td class="h">1092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1093</td><td colspan="7"></td></tr><tr><td class="h">1094</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1094">0</a></div></td><td><div class="c0"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--condition.html#L1094">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $fr_user &amp;&amp; $fr_user-&gt;is_friend($u);</td></tr>
<tr><td class="h">1095</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1096</td><td colspan="7"></td></tr><tr><td class="h">1097</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-DW-User-Edges-WatchTrust-pm--branch.html#L1097">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($u-&gt;rate_log(&#39;addfriend&#39;, 1)) {</td></tr>
<tr><td class="h">1098</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$err = &quot;You are trying to add too many friends in too short a period of time.&quot;;</td></tr>
<tr><td class="h">1099</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1101</td><td colspan="7"></td></tr><tr><td class="h">1102</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1104</td><td colspan="7"></td></tr><tr><td class="h">1105</td><td colspan="7"></td></tr><tr><td class="h">1106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
