<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.61
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: cgi-bin/LJ/User.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">cgi-bin/LJ/User.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c0">25.4%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">2</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># LiveJournal user object</td></tr>
<tr><td class="h">3</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">4</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># 2004-07-21: we&#39;re transitioning from $u hashrefs to $u objects, currently</td></tr>
<tr><td class="h">5</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             backed by hashrefs, to ease migration.  in the future,</td></tr>
<tr><td class="h">6</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             more methods from ljlib.pl and other places will move here,</td></tr>
<tr><td class="h">7</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             and the representation of a $u object will change to &#39;fields&#39;.</td></tr>
<tr><td class="h">8</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             at present, the motivation to moving to $u objects is to do</td></tr>
<tr><td class="h">9</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             all database access for a given user through his/her $u object</td></tr>
<tr><td class="h">10</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             so the queries can be tagged for use by the star replication</td></tr>
<tr><td class="h">11</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             daemon.</td></tr>
<tr><td class="h">12</td><td colspan="7"></td></tr><tr><td class="h">13</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L13">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">14</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L14">80</a></div></td><td></td><td><div>0</div><div>0</div><div>4000</div></td><td class="s">no warnings &#39;uninitialized&#39;;</td></tr>
<tr><td class="h">15</td><td colspan="7"></td></tr><tr><td class="h">16</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">17</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### Begin LJ::User functions</td></tr>
<tr><td class="h">18</td><td colspan="7"></td></tr><tr><td class="h">19</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ::User;</td></tr>
<tr><td class="h">20</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L20">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use Carp;</td></tr>
<tr><td class="h">21</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L21">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use lib &quot;$LJ::HOME/cgi-bin&quot;;</td></tr>
<tr><td class="h">22</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L22">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use List::Util ();</td></tr>
<tr><td class="h">23</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L23">80</a></div></td><td></td><td><div>0</div><div>4000</div><div>4000</div></td><td class="s">use LJ::Constants;</td></tr>
<tr><td class="h">24</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L24">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use LJ::MemCache;</td></tr>
<tr><td class="h">25</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L25">80</a></div></td><td></td><td><div>4000</div><div>0</div><div>0</div></td><td class="s">use LJ::Session;</td></tr>
<tr><td class="h">26</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L26">80</a></div></td><td></td><td><div>4000</div><div>0</div><div>0</div></td><td class="s">use DW::User::Edges;</td></tr>
<tr><td class="h">27</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L27">80</a></div></td><td></td><td><div>0</div><div>0</div><div>4000</div></td><td class="s">use DW::Logic::ProfilePage;</td></tr>
<tr><td class="h">28</td><td colspan="7"></td></tr><tr><td class="h">29</td><td><div class="c3">80</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">use Class::Autouse qw(</td></tr>
<tr><td class="h">30</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Subscription</td></tr>
<tr><td class="h">31</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Identity</td></tr>
<tr><td class="h">32</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Auth</td></tr>
<tr><td class="h">33</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Jabber::Presence</td></tr>
<tr><td class="h">34</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::S2</td></tr>
<tr><td class="h">35</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IO::Socket::INET</td></tr>
<tr><td class="h">36</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Time::Local</td></tr>
<tr><td class="h">37</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::BetaFeatures</td></tr>
<tr><td class="h">38</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::S2Theme</td></tr>
<tr><td class="h">39</td><td><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L39">80</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">40</td><td colspan="7"></td></tr><tr><td class="h">41</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">42</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### Please keep these categorized and alphabetized for ease of use. </td></tr>
<tr><td class="h">43</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### If you need a new category, add it at the end, BEFORE category 99.</td></tr>
<tr><td class="h">44</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### Categories kinda fuzzy, but better than nothing.</td></tr>
<tr><td class="h">45</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###</td></tr>
<tr><td class="h">46</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### Categories:</td></tr>
<tr><td class="h">47</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  1. Creating and Deleting Accounts</td></tr>
<tr><td class="h">48</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  2. Statusvis and Account Types</td></tr>
<tr><td class="h">49</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  3. Working with All Types of Account</td></tr>
<tr><td class="h">50</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  4. Login, Session, and Rename Functions</td></tr>
<tr><td class="h">51</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  5. Database and Memcache Functions</td></tr>
<tr><td class="h">52</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  6. What the App Shows to Users</td></tr>
<tr><td class="h">53</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  7. Userprops, Caps, and Displaying Content to Others</td></tr>
<tr><td class="h">54</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  8. Formatting Content Shown to Users</td></tr>
<tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  9. Logging and Recording Actions</td></tr>
<tr><td class="h">56</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  10. Banning-Related Functions</td></tr>
<tr><td class="h">57</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  11. Birthdays and Age-Related Functions</td></tr>
<tr><td class="h">58</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  12. Comment-Related Functions</td></tr>
<tr><td class="h">59</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  13. Community-Related Functions and Authas</td></tr>
<tr><td class="h">60</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  14. Adult Content Functions</td></tr>
<tr><td class="h">61</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  15. Email-Related Functions</td></tr>
<tr><td class="h">62</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  16. Entry-Related Functions</td></tr>
<tr><td class="h">63</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  17. Interest-Related Functions</td></tr>
<tr><td class="h">64</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  18. Jabber-Related Functions</td></tr>
<tr><td class="h">65</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  19. OpenID and Identity Functions</td></tr>
<tr><td class="h">66</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  20. Page Notices Functions</td></tr>
<tr><td class="h">67</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  21. Password Functions</td></tr>
<tr><td class="h">68</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  22. Priv-Related Functions</td></tr>
<tr><td class="h">69</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  24. Styles and S2-Related Functions</td></tr>
<tr><td class="h">70</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  25. Subscription, Notifiction, and Messaging Functions</td></tr>
<tr><td class="h">71</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  26. Syndication-Related Functions</td></tr>
<tr><td class="h">72</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  27. Tag-Related Functions</td></tr>
<tr><td class="h">73</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  28. Userpic-Related Functions</td></tr>
<tr><td class="h">74</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  99. Miscellaneous Legacy Items</td></tr>
<tr><td class="h">75</td><td colspan="7"></td></tr><tr><td class="h">76</td><td colspan="7"></td></tr><tr><td class="h">77</td><td colspan="7"></td></tr><tr><td class="h">78</td><td colspan="7"></td></tr><tr><td class="h">79</td><td colspan="7"></td></tr><tr><td class="h">80</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">81</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 1. Creating and Deleting Accounts</td></tr>
<tr><td class="h">82</td><td colspan="7"></td></tr><tr><td class="h">83</td><td colspan="7"></td></tr><tr><td class="h">84</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_expunge {</td></tr>
<tr><td class="h">85</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L85">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">86</td><td colspan="7"></td></tr><tr><td class="h">87</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# must be already deleted</td></tr>
<tr><td class="h">88</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L88">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;is_deleted;</td></tr>
<tr><td class="h">89</td><td colspan="7"></td></tr><tr><td class="h">90</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# and deleted 30 days ago</td></tr>
<tr><td class="h">91</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L91">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $expunge_days = LJ::conf_test($LJ::DAYS_BEFORE_EXPUNGE) || 30;</td></tr>
<tr><td class="h">92</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L92">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;statusvisdate_unix &lt; time() - 86400*$expunge_days;</td></tr>
<tr><td class="h">93</td><td colspan="7"></td></tr><tr><td class="h">94</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $hook_rv = 0;</td></tr>
<tr><td class="h">95</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L95">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::are_hooks(&quot;can_expunge_user&quot;, $u)) {</td></tr>
<tr><td class="h">96</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hook_rv = LJ::run_hook(&quot;can_expunge_user&quot;, $u);</td></tr>
<tr><td class="h">97</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L97">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $hook_rv ? 1 : 0;</td></tr>
<tr><td class="h">98</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">99</td><td colspan="7"></td></tr><tr><td class="h">100</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">102</td><td colspan="7"></td></tr><tr><td class="h">103</td><td colspan="7"></td></tr><tr><td class="h">104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method to create a new account.</td></tr>
<tr><td class="h">105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create {</td></tr>
<tr><td class="h">106</td><td><div class="c3">324</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L106">324</a></div></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">107</td><td colspan="7"></td></tr><tr><td class="h">108</td><td><div class="c3">324</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L108">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $username = LJ::canonical_username($opts{user}) or return;</td></tr>
<tr><td class="h">109</td><td colspan="7"></td></tr><tr><td class="h">110</td><td><div class="c3">324</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L110">33</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cluster     = $opts{cluster} || LJ::new_account_cluster();</td></tr>
<tr><td class="h">111</td><td><div class="c3">324</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L111">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $caps        = $opts{caps} || $LJ::NEWUSER_CAPS;</td></tr>
<tr><td class="h">112</td><td><div class="c3">324</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L112">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journaltype = $opts{journaltype} || &quot;P&quot;;</td></tr>
<tr><td class="h">113</td><td colspan="7"></td></tr><tr><td class="h">114</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# non-clustered accounts aren&#39;t supported anymore</td></tr>
<tr><td class="h">115</td><td><div class="c3">324</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L115">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $cluster;</td></tr>
<tr><td class="h">116</td><td colspan="7"></td></tr><tr><td class="h">117</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">118</td><td colspan="7"></td></tr><tr><td class="h">119</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>2464144</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO user (user, clusterid, dversion, caps, journaltype) &quot; .</td></tr>
<tr><td class="h">120</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES (?, ?, ?, ?, ?)&quot;, undef,</td></tr>
<tr><td class="h">121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$username, $cluster, $LJ::MAX_DVERSION, $caps, $journaltype);</td></tr>
<tr><td class="h">122</td><td><div class="c3">324</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L122">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $dbh-&gt;err;</td></tr>
<tr><td class="h">123</td><td colspan="7"></td></tr><tr><td class="h">124</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $dbh-&gt;{&#39;mysql_insertid&#39;};</td></tr>
<tr><td class="h">125</td><td><div class="c3">324</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L125">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $userid;</td></tr>
<tr><td class="h">126</td><td colspan="7"></td></tr><tr><td class="h">127</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>1284077</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO useridmap (userid, user) VALUES (?, ?)&quot;,</td></tr>
<tr><td class="h">128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid, $username);</td></tr>
<tr><td class="h">129</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>680039</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO userusage (userid, timecreate) VALUES (?, NOW())&quot;,</td></tr>
<tr><td class="h">130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid);</td></tr>
<tr><td class="h">131</td><td colspan="7"></td></tr><tr><td class="h">132</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::load_userid($userid, &quot;force&quot;);</td></tr>
<tr><td class="h">133</td><td colspan="7"></td></tr><tr><td class="h">134</td><td><div class="c3">324</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L134">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L134">33</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $status   = $opts{status}   || ($LJ::EVERYONE_VALID ? &#39;A&#39; : &#39;N&#39;);</td></tr>
<tr><td class="h">135</td><td><div class="c3">324</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L135">33</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $name     = $opts{name}     || $username;</td></tr>
<tr><td class="h">136</td><td><div class="c3">324</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L136">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bdate    = $opts{bdate}    || &quot;0000-00-00&quot;;</td></tr>
<tr><td class="h">137</td><td><div class="c3">324</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L137">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $email    = $opts{email}    || &quot;&quot;;</td></tr>
<tr><td class="h">138</td><td><div class="c3">324</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L138">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $password = $opts{password} || &quot;&quot;;</td></tr>
<tr><td class="h">139</td><td colspan="7"></td></tr><tr><td class="h">140</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::update_user($u, { &#39;status&#39; =&gt; $status, &#39;name&#39; =&gt; $name, &#39;bdate&#39; =&gt; $bdate,</td></tr>
<tr><td class="h">141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;email&#39; =&gt; $email, &#39;password&#39; =&gt; $password, %LJ::USER_INIT });</td></tr>
<tr><td class="h">142</td><td colspan="7"></td></tr><tr><td class="h">143</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">144</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;log_event(&#39;account_create&#39;, { remote =&gt; $remote });</td></tr>
<tr><td class="h">145</td><td colspan="7"></td></tr><tr><td class="h">146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# only s2 is supported</td></tr>
<tr><td class="h">147</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop( stylesys =&gt; 2 );</td></tr>
<tr><td class="h">148</td><td colspan="7"></td></tr><tr><td class="h">149</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($name, $val) = each %LJ::USERPROP_INIT) {</td></tr>
<tr><td class="h">150</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop($name, $val);</td></tr>
<tr><td class="h">151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">152</td><td colspan="7"></td></tr><tr><td class="h">153</td><td><div class="c3">324</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L153">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts{extra_props}) {</td></tr>
<tr><td class="h">154</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($key, $value) = each( %{$opts{extra_props}} )) {</td></tr>
<tr><td class="h">155</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop( $key =&gt; $value );</td></tr>
<tr><td class="h">156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">158</td><td colspan="7"></td></tr><tr><td class="h">159</td><td><div class="c3">324</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L159">50</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts{status_history}) {</td></tr>
<tr><td class="h">160</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $system = LJ::load_user(&quot;system&quot;);</td></tr>
<tr><td class="h">161</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L161">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($system) {</td></tr>
<tr><td class="h">162</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($key, $value) = each( %{$opts{status_history}} )) {</td></tr>
<tr><td class="h">163</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add($u, $system, $key, $value);</td></tr>
<tr><td class="h">164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">165</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">167</td><td colspan="7"></td></tr><tr><td class="h">168</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;post_create&quot;, {</td></tr>
<tr><td class="h">169</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;userid&#39; =&gt; $userid,</td></tr>
<tr><td class="h">170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;user&#39;   =&gt; $username,</td></tr>
<tr><td class="h">171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;code&#39;   =&gt; undef,</td></tr>
<tr><td class="h">172</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;news&#39;   =&gt; $opts{get_news},</td></tr>
<tr><td class="h">173</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">174</td><td colspan="7"></td></tr><tr><td class="h">175</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">176</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">177</td><td colspan="7"></td></tr><tr><td class="h">178</td><td colspan="7"></td></tr><tr><td class="h">179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_community {</td></tr>
<tr><td class="h">180</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L180">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">181</td><td colspan="7"></td></tr><tr><td class="h">182</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts{journaltype} = &quot;C&quot;;</td></tr>
<tr><td class="h">183</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L183">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::User-&gt;create(%opts) or return;</td></tr>
<tr><td class="h">184</td><td colspan="7"></td></tr><tr><td class="h">185</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop(&quot;nonmember_posting&quot;, $opts{nonmember_posting}+0);</td></tr>
<tr><td class="h">186</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop(&quot;moderated&quot;, $opts{moderated}+0);</td></tr>
<tr><td class="h">187</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L187">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop(&quot;adult_content&quot;, $opts{journal_adult_settings}) if LJ::is_enabled( &#39;adult_content&#39; );</td></tr>
<tr><td class="h">188</td><td colspan="7"></td></tr><tr><td class="h">189</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">190</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_rel($u, $remote, &quot;A&quot;);  # maintainer</td></tr>
<tr><td class="h">191</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L191">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_rel($u, $remote, &quot;M&quot;) if $opts{moderated}; # moderator if moderated</td></tr>
<tr><td class="h">192</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::join_community($remote, $u, 1, 1); # member</td></tr>
<tr><td class="h">193</td><td colspan="7"></td></tr><tr><td class="h">194</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_comm_settings($u, $remote, { membership =&gt; $opts{membership},</td></tr>
<tr><td class="h">195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;postlevel =&gt; $opts{postlevel} });</td></tr>
<tr><td class="h">196</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">197</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">198</td><td colspan="7"></td></tr><tr><td class="h">199</td><td colspan="7"></td></tr><tr><td class="h">200</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_personal {</td></tr>
<tr><td class="h">201</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L201">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">202</td><td colspan="7"></td></tr><tr><td class="h">203</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L203">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::User-&gt;create(%opts) or return;</td></tr>
<tr><td class="h">204</td><td colspan="7"></td></tr><tr><td class="h">205</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop(&quot;init_bdate&quot;, $opts{bdate});</td></tr>
<tr><td class="h">206</td><td colspan="7"></td></tr><tr><td class="h">207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so birthday notifications get sent</td></tr>
<tr><td class="h">208</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_next_birthday;</td></tr>
<tr><td class="h">209</td><td colspan="7"></td></tr><tr><td class="h">210</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Set the default style</td></tr>
<tr><td class="h">211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hook(&#39;set_default_style&#39;, $u);</td></tr>
<tr><td class="h">212</td><td colspan="7"></td></tr><tr><td class="h">213</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L213">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $opts{inviter} ) {</td></tr>
<tr><td class="h">214</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# store inviter, if there was one</td></tr>
<tr><td class="h">215</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $inviter = LJ::load_user( $opts{inviter} );</td></tr>
<tr><td class="h">216</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L216">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $inviter ) {</td></tr>
<tr><td class="h">217</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_rel( $u, $inviter, &#39;I&#39; );</td></tr>
<tr><td class="h">218</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add( $u, $inviter, &#39;create_from_invite&#39;, &quot;Created new account.&quot; );</td></tr>
<tr><td class="h">219</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Event::InvitedFriendJoins-&gt;new( $inviter, $u )-&gt;fire;</td></tr>
<tr><td class="h">220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">221</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">222</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we have initial friends for new accounts, add them.</td></tr>
<tr><td class="h">223</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO(mark): INITIAL_FRIENDS should be moved/renamed.</td></tr>
<tr><td class="h">224</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $friend ( @LJ::INITIAL_FRIENDS ) {</td></tr>
<tr><td class="h">225</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L225">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $friendid = LJ::get_userid( $friend )</td></tr>
<tr><td class="h">226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or next;</td></tr>
<tr><td class="h">227</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;add_edge( $friendid, watch =&gt; {} );</td></tr>
<tr><td class="h">228</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">229</td><td colspan="7"></td></tr><tr><td class="h">230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# apply any paid time that this account should get</td></tr>
<tr><td class="h">231</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L231">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L231">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $LJ::USE_ACCT_CODES &amp;&amp; $opts{code} ) {</td></tr>
<tr><td class="h">232</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $code = $opts{code};</td></tr>
<tr><td class="h">233</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $itemidref;</td></tr>
<tr><td class="h">234</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L234">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L234">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( DW::InviteCodes-&gt;is_promo_code( code =&gt; $code ) ) {</td></tr>
<tr><td class="h">235</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add( $u, undef, &#39;create_from_promo&#39;, &quot;Created new account from promo code &#39;$code&#39;.&quot; );</td></tr>
<tr><td class="h">236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( my $cart = DW::Shop::Cart-&gt;get_from_invite( $code, itemidref =&gt; \$itemidref ) ) {</td></tr>
<tr><td class="h">237</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $item = $cart-&gt;get_item( $itemidref );</td></tr>
<tr><td class="h">238</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L238">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L238">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $item &amp;&amp; $item-&gt;isa( &#39;DW::Shop::Item::Account&#39; ) ) {</td></tr>
<tr><td class="h">239</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# first update the item&#39;s target user and the cart</td></tr>
<tr><td class="h">240</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;t_userid( $u-&gt;id );</td></tr>
<tr><td class="h">241</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cart-&gt;save( no_memcache =&gt; 1 );</td></tr>
<tr><td class="h">242</td><td colspan="7"></td></tr><tr><td class="h">243</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# now add paid time to the user</td></tr>
<tr><td class="h">244</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L244">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $from_u = $item-&gt;from_userid ? LJ::load_userid( $item-&gt;from_userid ) : undef;</td></tr>
<tr><td class="h">245</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L245">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( DW::Pay::add_paid_time( $u, $item-&gt;class, $item-&gt;months ) ) {</td></tr>
<tr><td class="h">246</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add( $u, $from_u, &#39;paid_from_invite&#39;, &quot;Created new &#39;&quot; . $item-&gt;class . &quot;&#39; account.&quot; );</td></tr>
<tr><td class="h">247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">248</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L248">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $paid_error = DW::Pay::error_text() || $@ || &#39;unknown error&#39;;</td></tr>
<tr><td class="h">249</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add( $u, $from_u, &#39;paid_from_invite&#39;, &quot;Failed to create new &#39;&quot; . $item-&gt;class . &quot;&#39; account: $paid_error&quot; );</td></tr>
<tr><td class="h">250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">251</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">254</td><td colspan="7"></td></tr><tr><td class="h">255</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# populate some default friends groups</td></tr>
<tr><td class="h">256</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO(mark): this should probably be removed or refactored, especially since</td></tr>
<tr><td class="h">257</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#             editfriendgroups is dying/dead</td></tr>
<tr><td class="h">258</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    LJ::do_request(</td></tr>
<tr><td class="h">259</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                   {</td></tr>
<tr><td class="h">260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       &#39;mode&#39;           =&gt; &#39;editfriendgroups&#39;,</td></tr>
<tr><td class="h">261</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       &#39;user&#39;           =&gt; $u-&gt;user,</td></tr>
<tr><td class="h">262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       &#39;ver&#39;            =&gt; $LJ::PROTOCOL_VER,</td></tr>
<tr><td class="h">263</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       &#39;efg_set_1_name&#39; =&gt; &#39;Family&#39;,</td></tr>
<tr><td class="h">264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       &#39;efg_set_2_name&#39; =&gt; &#39;Local Friends&#39;,</td></tr>
<tr><td class="h">265</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       &#39;efg_set_3_name&#39; =&gt; &#39;Online Friends&#39;,</td></tr>
<tr><td class="h">266</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       &#39;efg_set_4_name&#39; =&gt; &#39;School&#39;,</td></tr>
<tr><td class="h">267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       &#39;efg_set_5_name&#39; =&gt; &#39;Work&#39;,</td></tr>
<tr><td class="h">268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       &#39;efg_set_6_name&#39; =&gt; &#39;Mobile View&#39;,</td></tr>
<tr><td class="h">269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                   }, \%res, { &#39;u&#39; =&gt; $u, &#39;noauth&#39; =&gt; 1, }</td></tr>
<tr><td class="h">270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                   );</td></tr>
<tr><td class="h">271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">272</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# subscribe to default events</td></tr>
<tr><td class="h">273</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;OfficialPost&#39;, method =&gt; &#39;Inbox&#39; );</td></tr>
<tr><td class="h">274</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L274">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;OfficialPost&#39;, method =&gt; &#39;Email&#39; ) if $opts{get_news};</td></tr>
<tr><td class="h">275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;JournalNewComment&#39;, journal =&gt; $u, method =&gt; &#39;Inbox&#39; );</td></tr>
<tr><td class="h">276</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;JournalNewComment&#39;, journal =&gt; $u, method =&gt; &#39;Email&#39; );</td></tr>
<tr><td class="h">277</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;AddedToCircle&#39;, journal =&gt; $u, method =&gt; &#39;Inbox&#39; );</td></tr>
<tr><td class="h">278</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;AddedToCircle&#39;, journal =&gt; $u, method =&gt; &#39;Email&#39; );</td></tr>
<tr><td class="h">279</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# inbox notifications for PMs are on for everyone automatically</td></tr>
<tr><td class="h">280</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;UserMessageRecvd&#39;, journal =&gt; $u, method =&gt; &#39;Email&#39; );</td></tr>
<tr><td class="h">281</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;InvitedFriendJoins&#39;, journal =&gt; $u, method =&gt; &#39;Inbox&#39; );</td></tr>
<tr><td class="h">282</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;InvitedFriendJoins&#39;, journal =&gt; $u, method =&gt; &#39;Email&#39; );</td></tr>
<tr><td class="h">283</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;CommunityInvite&#39;, journal =&gt; $u, method =&gt; &#39;Inbox&#39; );</td></tr>
<tr><td class="h">284</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;CommunityInvite&#39;, journal =&gt; $u, method =&gt; &#39;Email&#39; );</td></tr>
<tr><td class="h">285</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;CommunityJoinRequest&#39;, journal =&gt; $u, method =&gt; &#39;Inbox&#39; );</td></tr>
<tr><td class="h">286</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;subscribe( event =&gt; &#39;CommunityJoinRequest&#39;, journal =&gt; $u, method =&gt; &#39;Email&#39; );</td></tr>
<tr><td class="h">287</td><td colspan="7"></td></tr><tr><td class="h">288</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">289</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">290</td><td colspan="7"></td></tr><tr><td class="h">291</td><td colspan="7"></td></tr><tr><td class="h">292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_syndicated {</td></tr>
<tr><td class="h">293</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L293">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, %opts) = @_;</td></tr>
<tr><td class="h">294</td><td colspan="7"></td></tr><tr><td class="h">295</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L295">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $opts{feedurl};</td></tr>
<tr><td class="h">296</td><td colspan="7"></td></tr><tr><td class="h">297</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts{caps}        = $LJ::SYND_CAPS;</td></tr>
<tr><td class="h">298</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts{cluster}     = $LJ::SYND_CLUSTER;</td></tr>
<tr><td class="h">299</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts{journaltype} = &quot;Y&quot;;</td></tr>
<tr><td class="h">300</td><td colspan="7"></td></tr><tr><td class="h">301</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L301">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::User-&gt;create(%opts) or return;</td></tr>
<tr><td class="h">302</td><td colspan="7"></td></tr><tr><td class="h">303</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">304</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO syndicated (userid, synurl, checknext) VALUES (?, ?, NOW())&quot;,</td></tr>
<tr><td class="h">305</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id, $opts{feedurl});</td></tr>
<tr><td class="h">306</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L306">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die $dbh-&gt;errstr if $dbh-&gt;err;</td></tr>
<tr><td class="h">307</td><td colspan="7"></td></tr><tr><td class="h">308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">309</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add( $u, $remote, &quot;synd_create&quot;, &quot;acct: &quot; . $u-&gt;user );</td></tr>
<tr><td class="h">310</td><td colspan="7"></td></tr><tr><td class="h">311</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">313</td><td colspan="7"></td></tr><tr><td class="h">314</td><td colspan="7"></td></tr><tr><td class="h">315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_and_purge_completely {</td></tr>
<tr><td class="h">316</td><td><div class="c3">324</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L316">324</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO: delete from user tables</td></tr>
<tr><td class="h">318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO: delete from global tables</td></tr>
<tr><td class="h">319</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">320</td><td colspan="7"></td></tr><tr><td class="h">321</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @tables = qw(user useridmap reluser priv_map infohistory email password);</td></tr>
<tr><td class="h">322</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $table (@tables) {</td></tr>
<tr><td class="h">323</td><td><div class="c3">2268</div></td><td></td><td></td><td></td><td></td><td><div>24000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM $table WHERE userid=?&quot;, undef, $u-&gt;id);</td></tr>
<tr><td class="h">324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">325</td><td colspan="7"></td></tr><tr><td class="h">326</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM wt_edges WHERE from_userid = ? OR to_userid = ?&quot;, undef, $u-&gt;id, $u-&gt;id);</td></tr>
<tr><td class="h">327</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM reluser WHERE targetid=?&quot;, undef, $u-&gt;id);</td></tr>
<tr><td class="h">328</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM email_aliases WHERE alias=?&quot;, undef, $u-&gt;user . &quot;\@$LJ::USER_DOMAIN&quot;);</td></tr>
<tr><td class="h">329</td><td colspan="7"></td></tr><tr><td class="h">330</td><td><div class="c3">324</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L330">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM community WHERE userid=?&quot;, undef, $u-&gt;id)</td></tr>
<tr><td class="h">331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $u-&gt;is_community;</td></tr>
<tr><td class="h">332</td><td><div class="c3">324</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L332">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM syndicated WHERE userid=?&quot;, undef, $u-&gt;id)</td></tr>
<tr><td class="h">333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $u-&gt;is_syndicated;</td></tr>
<tr><td class="h">334</td><td colspan="7"></td></tr><tr><td class="h">335</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">337</td><td colspan="7"></td></tr><tr><td class="h">338</td><td colspan="7"></td></tr><tr><td class="h">339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># checks against the file containing our regular expressions to determine if a</td></tr>
<tr><td class="h">340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># given username is disallowed</td></tr>
<tr><td class="h">341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_protected_username {</td></tr>
<tr><td class="h">342</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L342">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $class, $username ) = @_;</td></tr>
<tr><td class="h">343</td><td colspan="7"></td></tr><tr><td class="h">344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# site admins (people with siteadmin:usernames) can override this check and</td></tr>
<tr><td class="h">345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# create any account they want</td></tr>
<tr><td class="h">346</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">347</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L347">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L347">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $remote &amp;&amp; $remote-&gt;has_priv( siteadmin =&gt; &#39;usernames&#39; );</td></tr>
<tr><td class="h">348</td><td colspan="7"></td></tr><tr><td class="h">349</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @res = grep { $_ } split( /\r?\n/, LJ::load_include( &#39;reserved-usernames&#39; ) );</td></tr>
<tr><td class="h">350</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $re ( @res ) {</td></tr>
<tr><td class="h">351</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L351">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $username =~ /$re/;</td></tr>
<tr><td class="h">352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">353</td><td colspan="7"></td></tr><tr><td class="h">354</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">355</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">356</td><td colspan="7"></td></tr><tr><td class="h">357</td><td colspan="7"></td></tr><tr><td class="h">358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub postreg_completed {</td></tr>
<tr><td class="h">359</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L359">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">360</td><td colspan="7"></td></tr><tr><td class="h">361</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L361">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;bio;</td></tr>
<tr><td class="h">362</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L362">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;interest_count;</td></tr>
<tr><td class="h">363</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">365</td><td colspan="7"></td></tr><tr><td class="h">366</td><td colspan="7"></td></tr><tr><td class="h">367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub who_invited {</td></tr>
<tr><td class="h">368</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L368">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">369</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $inviterid = LJ::load_rel_user($u, &#39;I&#39;);</td></tr>
<tr><td class="h">370</td><td colspan="7"></td></tr><tr><td class="h">371</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::load_userid($inviterid);</td></tr>
<tr><td class="h">372</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">373</td><td colspan="7"></td></tr><tr><td class="h">374</td><td colspan="7"></td></tr><tr><td class="h">375</td><td colspan="7"></td></tr><tr><td class="h">376</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">377</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  2. Statusvis and Account Types</td></tr>
<tr><td class="h">378</td><td colspan="7"></td></tr><tr><td class="h">379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_previous_statusvis {</td></tr>
<tr><td class="h">380</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L380">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">381</td><td colspan="7"></td></tr><tr><td class="h">382</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $extra = $u-&gt;selectcol_arrayref(</td></tr>
<tr><td class="h">383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SELECT extra FROM userlog WHERE userid=? AND action=&#39;accountstatus&#39; ORDER BY logtime DESC&quot;,</td></tr>
<tr><td class="h">384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;userid );</td></tr>
<tr><td class="h">385</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @statusvis;</td></tr>
<tr><td class="h">386</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $e (@$extra) {</td></tr>
<tr><td class="h">387</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %fields;</td></tr>
<tr><td class="h">388</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::decode_url_string($e, \%fields, []);</td></tr>
<tr><td class="h">389</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @statusvis, $fields{old};</td></tr>
<tr><td class="h">390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">391</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @statusvis;</td></tr>
<tr><td class="h">392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">393</td><td colspan="7"></td></tr><tr><td class="h">394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_deleted {</td></tr>
<tr><td class="h">395</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L395">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">396</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;statusvis eq &#39;D&#39;;</td></tr>
<tr><td class="h">397</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">398</td><td colspan="7"></td></tr><tr><td class="h">399</td><td colspan="7"></td></tr><tr><td class="h">400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_expunged {</td></tr>
<tr><td class="h">401</td><td><div class="c3">4084</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L401">4084</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">402</td><td><div class="c3">4084</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L402">33</a></div></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;statusvis eq &#39;X&#39; || $u-&gt;clusterid == 0;</td></tr>
<tr><td class="h">403</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">404</td><td colspan="7"></td></tr><tr><td class="h">405</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_inactive {</td></tr>
<tr><td class="h">406</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L406">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">407</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $statusvis = $u-&gt;statusvis;</td></tr>
<tr><td class="h">408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# true if deleted, expunged or suspended</td></tr>
<tr><td class="h">409</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L409">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $statusvis eq &#39;D&#39; || $statusvis eq &#39;X&#39; || $statusvis eq &#39;S&#39;;</td></tr>
<tr><td class="h">410</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">411</td><td colspan="7"></td></tr><tr><td class="h">412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_locked {</td></tr>
<tr><td class="h">413</td><td><div class="c3">35</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L413">35</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">414</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;statusvis eq &#39;L&#39;;</td></tr>
<tr><td class="h">415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">416</td><td colspan="7"></td></tr><tr><td class="h">417</td><td colspan="7"></td></tr><tr><td class="h">418</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_memorial {</td></tr>
<tr><td class="h">419</td><td><div class="c3">35</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L419">35</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">420</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;statusvis eq &#39;M&#39;;</td></tr>
<tr><td class="h">421</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">422</td><td colspan="7"></td></tr><tr><td class="h">423</td><td colspan="7"></td></tr><tr><td class="h">424</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_readonly {</td></tr>
<tr><td class="h">425</td><td><div class="c3">68</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L425">68</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">426</td><td><div class="c3">68</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;statusvis eq &#39;O&#39;;</td></tr>
<tr><td class="h">427</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">428</td><td colspan="7"></td></tr><tr><td class="h">429</td><td colspan="7"></td></tr><tr><td class="h">430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_renamed {</td></tr>
<tr><td class="h">431</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L431">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">432</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;statusvis eq &#39;R&#39;;</td></tr>
<tr><td class="h">433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">434</td><td colspan="7"></td></tr><tr><td class="h">435</td><td colspan="7"></td></tr><tr><td class="h">436</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_suspended {</td></tr>
<tr><td class="h">437</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L437">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">438</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;statusvis eq &#39;S&#39;;</td></tr>
<tr><td class="h">439</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">440</td><td colspan="7"></td></tr><tr><td class="h">441</td><td colspan="7"></td></tr><tr><td class="h">442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns if this user is considered visible</td></tr>
<tr><td class="h">443</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_visible {</td></tr>
<tr><td class="h">444</td><td><div class="c3">334</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L444">334</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">445</td><td><div class="c3">334</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;statusvis eq &#39;V&#39;;</td></tr>
<tr><td class="h">446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">447</td><td colspan="7"></td></tr><tr><td class="h">448</td><td colspan="7"></td></tr><tr><td class="h">449</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_deleted {</td></tr>
<tr><td class="h">450</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L450">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">451</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = $u-&gt;set_statusvis(&#39;D&#39;);</td></tr>
<tr><td class="h">452</td><td colspan="7"></td></tr><tr><td class="h">453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# run any account cancellation hooks</td></tr>
<tr><td class="h">454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;account_delete&quot;, $u);</td></tr>
<tr><td class="h">455</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">456</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">457</td><td colspan="7"></td></tr><tr><td class="h">458</td><td colspan="7"></td></tr><tr><td class="h">459</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_expunged {</td></tr>
<tr><td class="h">460</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L460">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">461</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;set_statusvis(&#39;X&#39;);</td></tr>
<tr><td class="h">462</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">463</td><td colspan="7"></td></tr><tr><td class="h">464</td><td colspan="7"></td></tr><tr><td class="h">465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_locked {</td></tr>
<tr><td class="h">466</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L466">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">467</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;set_statusvis(&#39;L&#39;);</td></tr>
<tr><td class="h">468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">469</td><td colspan="7"></td></tr><tr><td class="h">470</td><td colspan="7"></td></tr><tr><td class="h">471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_memorial {</td></tr>
<tr><td class="h">472</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L472">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">473</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;set_statusvis(&#39;M&#39;);</td></tr>
<tr><td class="h">474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">475</td><td colspan="7"></td></tr><tr><td class="h">476</td><td colspan="7"></td></tr><tr><td class="h">477</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_readonly {</td></tr>
<tr><td class="h">478</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L478">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">479</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;set_statusvis(&#39;O&#39;);</td></tr>
<tr><td class="h">480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">481</td><td colspan="7"></td></tr><tr><td class="h">482</td><td colspan="7"></td></tr><tr><td class="h">483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_renamed {</td></tr>
<tr><td class="h">484</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L484">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">485</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;set_statusvis(&#39;R&#39;);</td></tr>
<tr><td class="h">486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">487</td><td colspan="7"></td></tr><tr><td class="h">488</td><td colspan="7"></td></tr><tr><td class="h">489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># set_statusvis only change statusvis parameter, all accompanied actions are done in set_* methods</td></tr>
<tr><td class="h">490</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_statusvis {</td></tr>
<tr><td class="h">491</td><td><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L491">4</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $statusvis) = @_;</td></tr>
<tr><td class="h">492</td><td colspan="7"></td></tr><tr><td class="h">493</td><td><div class="c3">4</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L493">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;Invalid statusvis: $statusvis&quot;</td></tr>
<tr><td class="h">494</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $statusvis =~ /^(?:</td></tr>
<tr><td class="h">495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;V|       # visible</td></tr>
<tr><td class="h">496</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D|       # deleted</td></tr>
<tr><td class="h">497</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X|       # expunged</td></tr>
<tr><td class="h">498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S|       # suspended</td></tr>
<tr><td class="h">499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L|       # locked</td></tr>
<tr><td class="h">500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;M|       # memorial</td></tr>
<tr><td class="h">501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;O|       # read-only</td></tr>
<tr><td class="h">502</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R        # renamed</td></tr>
<tr><td class="h">503</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)$/x;</td></tr>
<tr><td class="h">504</td><td colspan="7"></td></tr><tr><td class="h">505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# log the change to userlog</td></tr>
<tr><td class="h">506</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;log_event(&#39;accountstatus&#39;, {</td></tr>
<tr><td class="h">507</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# remote looked up by log_event</td></tr>
<tr><td class="h">508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old =&gt; $u-&gt;statusvis,</td></tr>
<tr><td class="h">509</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new =&gt; $statusvis,</td></tr>
<tr><td class="h">510</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">511</td><td colspan="7"></td></tr><tr><td class="h">512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do update</td></tr>
<tr><td class="h">513</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::update_user($u, { statusvis =&gt; $statusvis,</td></tr>
<tr><td class="h">514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raw =&gt; &#39;statusvisdate=NOW()&#39; });</td></tr>
<tr><td class="h">515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">516</td><td colspan="7"></td></tr><tr><td class="h">517</td><td colspan="7"></td></tr><tr><td class="h">518</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_suspended {</td></tr>
<tr><td class="h">519</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L519">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $who, $reason, $errref) = @_;</td></tr>
<tr><td class="h">520</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L520">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L520">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Not enough parameters for LJ::User::set_suspended call&quot; unless $who and $reason;</td></tr>
<tr><td class="h">521</td><td colspan="7"></td></tr><tr><td class="h">522</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = $u-&gt;set_statusvis(&#39;S&#39;);</td></tr>
<tr><td class="h">523</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L523">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($res) {</td></tr>
<tr><td class="h">524</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L524">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = &quot;DB error while setting statusvis to &#39;S&#39;&quot; if ref $errref;</td></tr>
<tr><td class="h">525</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">526</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">527</td><td colspan="7"></td></tr><tr><td class="h">528</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add($u, $who, &quot;suspend&quot;, $reason);</td></tr>
<tr><td class="h">529</td><td colspan="7"></td></tr><tr><td class="h">530</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;account_cancel&quot;, $u);</td></tr>
<tr><td class="h">531</td><td colspan="7"></td></tr><tr><td class="h">532</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L532">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $err = LJ::run_hook(&quot;cdn_purge_userpics&quot;, $u)) {</td></tr>
<tr><td class="h">533</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L533">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L533">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = $err if ref $errref and $err;</td></tr>
<tr><td class="h">534</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">535</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">536</td><td colspan="7"></td></tr><tr><td class="h">537</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res; # success</td></tr>
<tr><td class="h">538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">539</td><td colspan="7"></td></tr><tr><td class="h">540</td><td colspan="7"></td></tr><tr><td class="h">541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># sets a user to visible, but also does all of the stuff necessary when a suspended account is unsuspended</td></tr>
<tr><td class="h">542</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># this can only be run on a suspended account</td></tr>
<tr><td class="h">543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_unsuspended {</td></tr>
<tr><td class="h">544</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L544">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $who, $reason, $errref) = @_;</td></tr>
<tr><td class="h">545</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L545">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L545">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Not enough parameters for LJ::User::set_unsuspended call&quot; unless $who and $reason;</td></tr>
<tr><td class="h">546</td><td colspan="7"></td></tr><tr><td class="h">547</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L547">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($u-&gt;is_suspended) {</td></tr>
<tr><td class="h">548</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L548">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = &quot;User isn&#39;t suspended&quot; if ref $errref;</td></tr>
<tr><td class="h">549</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">551</td><td colspan="7"></td></tr><tr><td class="h">552</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = $u-&gt;set_statusvis(&#39;V&#39;);</td></tr>
<tr><td class="h">553</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L553">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($res) {</td></tr>
<tr><td class="h">554</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L554">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$errref = &quot;DB error while setting statusvis to &#39;V&#39;&quot; if ref $errref;</td></tr>
<tr><td class="h">555</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $res;</td></tr>
<tr><td class="h">556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">557</td><td colspan="7"></td></tr><tr><td class="h">558</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add($u, $who, &quot;unsuspend&quot;, $reason);</td></tr>
<tr><td class="h">559</td><td colspan="7"></td></tr><tr><td class="h">560</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $res; # success</td></tr>
<tr><td class="h">561</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">562</td><td colspan="7"></td></tr><tr><td class="h">563</td><td colspan="7"></td></tr><tr><td class="h">564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_visible {</td></tr>
<tr><td class="h">565</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L565">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">566</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;set_statusvis(&#39;V&#39;);</td></tr>
<tr><td class="h">567</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">568</td><td colspan="7"></td></tr><tr><td class="h">569</td><td colspan="7"></td></tr><tr><td class="h">570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub statusvis {</td></tr>
<tr><td class="h">571</td><td><div class="c3">4601</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L571">4601</a></div></td><td></td><td><div>24002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">572</td><td><div class="c3">4601</div></td><td></td><td></td><td></td><td></td><td><div>60000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{statusvis};</td></tr>
<tr><td class="h">573</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">574</td><td colspan="7"></td></tr><tr><td class="h">575</td><td colspan="7"></td></tr><tr><td class="h">576</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub statusvisdate {</td></tr>
<tr><td class="h">577</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L577">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">578</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{statusvisdate};</td></tr>
<tr><td class="h">579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">580</td><td colspan="7"></td></tr><tr><td class="h">581</td><td colspan="7"></td></tr><tr><td class="h">582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub statusvisdate_unix {</td></tr>
<tr><td class="h">583</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L583">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">584</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::mysqldate_to_time( $u-&gt;statusvisdate );</td></tr>
<tr><td class="h">585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">586</td><td colspan="7"></td></tr><tr><td class="h">587</td><td colspan="7"></td></tr><tr><td class="h">588</td><td colspan="7"></td></tr><tr><td class="h">589</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 3. Working with All Types of Account</td></tr>
<tr><td class="h">591</td><td colspan="7"></td></tr><tr><td class="h">592</td><td colspan="7"></td></tr><tr><td class="h">593</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># this will return a hash of information about this user.</td></tr>
<tr><td class="h">594</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># this is useful for JavaScript endpoints which need to dump</td></tr>
<tr><td class="h">595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># JSON data about users.</td></tr>
<tr><td class="h">596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub info_for_js {</td></tr>
<tr><td class="h">597</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L597">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">598</td><td colspan="7"></td></tr><tr><td class="h">599</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %ret = (</td></tr>
<tr><td class="h">600</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;username         =&gt; $u-&gt;user,</td></tr>
<tr><td class="h">601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display_username =&gt; $u-&gt;display_username,</td></tr>
<tr><td class="h">602</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display_name     =&gt; $u-&gt;display_name,</td></tr>
<tr><td class="h">603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userid           =&gt; $u-&gt;userid,</td></tr>
<tr><td class="h">604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url_journal      =&gt; $u-&gt;journal_base,</td></tr>
<tr><td class="h">605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url_profile      =&gt; $u-&gt;profile_url,</td></tr>
<tr><td class="h">606</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url_allpics      =&gt; $u-&gt;allpics_base,</td></tr>
<tr><td class="h">607</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ljuser_tag       =&gt; $u-&gt;ljuser_display,</td></tr>
<tr><td class="h">608</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_comm          =&gt; $u-&gt;is_comm,</td></tr>
<tr><td class="h">609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_person        =&gt; $u-&gt;is_person,</td></tr>
<tr><td class="h">610</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_syndicated    =&gt; $u-&gt;is_syndicated,</td></tr>
<tr><td class="h">611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_identity      =&gt; $u-&gt;is_identity,</td></tr>
<tr><td class="h">612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">613</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Without url_message &quot;Send Message&quot; link should not display</td></tr>
<tr><td class="h">614</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L614">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret{url_message} = $u-&gt;message_url unless ($u-&gt;opt_usermsg eq &#39;N&#39;);</td></tr>
<tr><td class="h">615</td><td colspan="7"></td></tr><tr><td class="h">616</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hook(&quot;extra_info_for_js&quot;, $u, \%ret);</td></tr>
<tr><td class="h">617</td><td colspan="7"></td></tr><tr><td class="h">618</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $up = $u-&gt;userpic;</td></tr>
<tr><td class="h">619</td><td colspan="7"></td></tr><tr><td class="h">620</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L620">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($up) {</td></tr>
<tr><td class="h">621</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret{url_userpic} = $up-&gt;url;</td></tr>
<tr><td class="h">622</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret{userpic_w}   = $up-&gt;width;</td></tr>
<tr><td class="h">623</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret{userpic_h}   = $up-&gt;height;</td></tr>
<tr><td class="h">624</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">625</td><td colspan="7"></td></tr><tr><td class="h">626</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return %ret;</td></tr>
<tr><td class="h">627</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">628</td><td colspan="7"></td></tr><tr><td class="h">629</td><td colspan="7"></td></tr><tr><td class="h">630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_community {</td></tr>
<tr><td class="h">631</td><td><div class="c3">398</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L631">398</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;{journaltype} eq &quot;C&quot;;</td></tr>
<tr><td class="h">632</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*is_comm = \&amp;is_community;</td></tr>
<tr><td class="h">634</td><td colspan="7"></td></tr><tr><td class="h">635</td><td colspan="7"></td></tr><tr><td class="h">636</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_identity {</td></tr>
<tr><td class="h">637</td><td><div class="c3">51</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L637">51</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;{journaltype} eq &quot;I&quot;;</td></tr>
<tr><td class="h">638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">639</td><td colspan="7"></td></tr><tr><td class="h">640</td><td colspan="7"></td></tr><tr><td class="h">641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return true if the user is either a personal journal or an identity journal</td></tr>
<tr><td class="h">642</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_individual {</td></tr>
<tr><td class="h">643</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L643">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">644</td><td><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L644">100</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L644">67</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;is_personal || $u-&gt;is_identity ? 1 : 0;</td></tr>
<tr><td class="h">645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">646</td><td colspan="7"></td></tr><tr><td class="h">647</td><td colspan="7"></td></tr><tr><td class="h">648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_official {</td></tr>
<tr><td class="h">649</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L649">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">650</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L650">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::OFFICIAL_JOURNALS{$u-&gt;username} ? 1 : 0;</td></tr>
<tr><td class="h">651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">652</td><td colspan="7"></td></tr><tr><td class="h">653</td><td colspan="7"></td></tr><tr><td class="h">654</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_paid {</td></tr>
<tr><td class="h">655</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L655">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">656</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L656">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L656">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;is_identity || $u-&gt;is_syndicated;</td></tr>
<tr><td class="h">657</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L657">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::Pay::get_account_type( $u ) ne &#39;free&#39; ? 1 : 0;</td></tr>
<tr><td class="h">658</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">659</td><td colspan="7"></td></tr><tr><td class="h">660</td><td colspan="7"></td></tr><tr><td class="h">661</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_perm {</td></tr>
<tr><td class="h">662</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L662">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">663</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L663">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L663">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;is_identity || $u-&gt;is_syndicated;</td></tr>
<tr><td class="h">664</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L664">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return DW::Pay::get_account_type( $u ) eq &#39;seed&#39; ? 1 : 0;</td></tr>
<tr><td class="h">665</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">666</td><td colspan="7"></td></tr><tr><td class="h">667</td><td colspan="7"></td></tr><tr><td class="h">668</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_person {</td></tr>
<tr><td class="h">669</td><td><div class="c3">1215</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L669">1215</a></div></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;{journaltype} eq &quot;P&quot;;</td></tr>
<tr><td class="h">670</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*is_personal = \&amp;is_person;</td></tr>
<tr><td class="h">672</td><td colspan="7"></td></tr><tr><td class="h">673</td><td colspan="7"></td></tr><tr><td class="h">674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_redirect {</td></tr>
<tr><td class="h">675</td><td><div class="c3">10</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L675">10</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;{journaltype} eq &quot;R&quot;;</td></tr>
<tr><td class="h">676</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">677</td><td colspan="7"></td></tr><tr><td class="h">678</td><td colspan="7"></td></tr><tr><td class="h">679</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_syndicated {</td></tr>
<tr><td class="h">680</td><td><div class="c3">392</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L680">392</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;{journaltype} eq &quot;Y&quot;;</td></tr>
<tr><td class="h">681</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">682</td><td colspan="7"></td></tr><tr><td class="h">683</td><td colspan="7"></td></tr><tr><td class="h">684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub journaltype {</td></tr>
<tr><td class="h">685</td><td><div class="c3">65</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L685">65</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;{journaltype};</td></tr>
<tr><td class="h">686</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">687</td><td colspan="7"></td></tr><tr><td class="h">688</td><td colspan="7"></td></tr><tr><td class="h">689</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return the journal type as a name</td></tr>
<tr><td class="h">690</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub journaltype_readable {</td></tr>
<tr><td class="h">691</td><td><div class="c3">10</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L691">10</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">692</td><td colspan="7"></td></tr><tr><td class="h">693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return {</td></tr>
<tr><td class="h">694</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R =&gt; &#39;redirect&#39;,</td></tr>
<tr><td class="h">695</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I =&gt; &#39;identity&#39;,</td></tr>
<tr><td class="h">696</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P =&gt; &#39;personal&#39;,</td></tr>
<tr><td class="h">697</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y =&gt; &#39;syndicated&#39;,</td></tr>
<tr><td class="h">698</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C =&gt; &#39;community&#39;,</td></tr>
<tr><td class="h">699</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}-&gt;{$u-&gt;journaltype};</td></tr>
<tr><td class="h">700</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">701</td><td colspan="7"></td></tr><tr><td class="h">702</td><td colspan="7"></td></tr><tr><td class="h">703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns LJ::User class of a random user, undef if we couldn&#39;t get one</td></tr>
<tr><td class="h">704</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   my $random_u = LJ::User-&gt;load_random_user(type);</td></tr>
<tr><td class="h">705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># If type is null, assumes a person.</td></tr>
<tr><td class="h">706</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_random_user {</td></tr>
<tr><td class="h">707</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L707">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">708</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L708">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $type = shift || &#39;P&#39;;</td></tr>
<tr><td class="h">709</td><td colspan="7"></td></tr><tr><td class="h">710</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get a random database, but make sure to try them all if one is down or not</td></tr>
<tr><td class="h">711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# responding or similar</td></tr>
<tr><td class="h">712</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr;</td></tr>
<tr><td class="h">713</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (List::Util::shuffle(@LJ::CLUSTERS)) {</td></tr>
<tr><td class="h">714</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbcr = LJ::get_cluster_reader($_);</td></tr>
<tr><td class="h">715</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L715">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $dbcr;</td></tr>
<tr><td class="h">716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">717</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L717">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Unable to get database cluster reader handle\n&quot; unless $dbcr;</td></tr>
<tr><td class="h">718</td><td colspan="7"></td></tr><tr><td class="h">719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get a selection of users around a random time</td></tr>
<tr><td class="h">720</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $when = time() - int(rand($LJ::RANDOM_USER_PERIOD * 24 * 60 * 60)); # days -&gt; seconds</td></tr>
<tr><td class="h">721</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uids = $dbcr-&gt;selectcol_arrayref(qq{</td></tr>
<tr><td class="h">722</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT userid FROM random_user_set</td></tr>
<tr><td class="h">723</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE posttime &gt; $when</td></tr>
<tr><td class="h">724</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND journaltype = ?</td></tr>
<tr><td class="h">725</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ORDER BY posttime</td></tr>
<tr><td class="h">726</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIMIT 10</td></tr>
<tr><td class="h">727</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, undef, $type);</td></tr>
<tr><td class="h">728</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L728">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Failed to execute query: &quot; . $dbcr-&gt;errstr . &quot;\n&quot; if $dbcr-&gt;err;</td></tr>
<tr><td class="h">729</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L729">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L729">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $uids &amp;&amp; @$uids;</td></tr>
<tr><td class="h">730</td><td colspan="7"></td></tr><tr><td class="h">731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# try the users we got</td></tr>
<tr><td class="h">732</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $uid (@$uids) {</td></tr>
<tr><td class="h">733</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L733">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::load_userid($uid)</td></tr>
<tr><td class="h">734</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or next;</td></tr>
<tr><td class="h">735</td><td colspan="7"></td></tr><tr><td class="h">736</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# situational checks to ensure this user is a good one to show</td></tr>
<tr><td class="h">737</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L737">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $u-&gt;is_visible;        # no suspended/deleted/etc users</td></tr>
<tr><td class="h">738</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L738">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $u-&gt;prop(&#39;latest_optout&#39;); # they have chosen to be excluded</td></tr>
<tr><td class="h">739</td><td colspan="7"></td></tr><tr><td class="h">740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# they&#39;ve passed the checks, return this user</td></tr>
<tr><td class="h">741</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">743</td><td colspan="7"></td></tr><tr><td class="h">744</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# must have failed</td></tr>
<tr><td class="h">745</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">746</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">747</td><td colspan="7"></td></tr><tr><td class="h">748</td><td colspan="7"></td></tr><tr><td class="h">749</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub preload_props {</td></tr>
<tr><td class="h">750</td><td><div class="c3">3749</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L750">3749</a></div></td><td></td><td><div>24001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_props( @_ );</td></tr>
<tr><td class="h">751</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">752</td><td colspan="7"></td></tr><tr><td class="h">753</td><td colspan="7"></td></tr><tr><td class="h">754</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method.  returns remote (logged in) user object.  or undef if</td></tr>
<tr><td class="h">755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># no session is active.</td></tr>
<tr><td class="h">756</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub remote {</td></tr>
<tr><td class="h">757</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L757">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $opts) = @_;</td></tr>
<tr><td class="h">758</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::get_remote($opts);</td></tr>
<tr><td class="h">759</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">760</td><td colspan="7"></td></tr><tr><td class="h">761</td><td colspan="7"></td></tr><tr><td class="h">762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method.  set the remote user ($u or undef) for the duration of this request.</td></tr>
<tr><td class="h">763</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># once set, it&#39;ll never be reloaded, unless &quot;unset_remote&quot; is called to forget it.</td></tr>
<tr><td class="h">764</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_remote</td></tr>
<tr><td class="h">765</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">766</td><td><div class="c3">42</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L766">42</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $remote) = @_;</td></tr>
<tr><td class="h">767</td><td><div class="c3">42</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::CACHED_REMOTE = 1;</td></tr>
<tr><td class="h">768</td><td><div class="c3">42</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::CACHE_REMOTE = $remote;</td></tr>
<tr><td class="h">769</td><td><div class="c3">42</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;1;</td></tr>
<tr><td class="h">770</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">771</td><td colspan="7"></td></tr><tr><td class="h">772</td><td colspan="7"></td></tr><tr><td class="h">773</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># when was this account created?</td></tr>
<tr><td class="h">774</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns unixtime</td></tr>
<tr><td class="h">775</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub timecreate {</td></tr>
<tr><td class="h">776</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L776">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">777</td><td colspan="7"></td></tr><tr><td class="h">778</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L778">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_cache_timecreate} if $u-&gt;{_cache_timecreate};</td></tr>
<tr><td class="h">779</td><td colspan="7"></td></tr><tr><td class="h">780</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;id, &quot;tc:&quot; . $u-&gt;id];</td></tr>
<tr><td class="h">781</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $timecreate = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">782</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L782">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($timecreate) {</td></tr>
<tr><td class="h">783</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_cache_timecreate} = $timecreate;</td></tr>
<tr><td class="h">784</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $timecreate;</td></tr>
<tr><td class="h">785</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">786</td><td colspan="7"></td></tr><tr><td class="h">787</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L787">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader() or die &quot;No db&quot;;</td></tr>
<tr><td class="h">788</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $when = $dbr-&gt;selectrow_array(&quot;SELECT timecreate FROM userusage WHERE userid=?&quot;, undef, $u-&gt;id);</td></tr>
<tr><td class="h">789</td><td colspan="7"></td></tr><tr><td class="h">790</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$timecreate = LJ::mysqldate_to_time($when);</td></tr>
<tr><td class="h">791</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_cache_timecreate} = $timecreate;</td></tr>
<tr><td class="h">792</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $timecreate, 60*60*24);</td></tr>
<tr><td class="h">793</td><td colspan="7"></td></tr><tr><td class="h">794</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $timecreate;</td></tr>
<tr><td class="h">795</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">796</td><td colspan="7"></td></tr><tr><td class="h">797</td><td colspan="7"></td></tr><tr><td class="h">798</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># when was last time this account updated?</td></tr>
<tr><td class="h">799</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns unixtime</td></tr>
<tr><td class="h">800</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub timeupdate {</td></tr>
<tr><td class="h">801</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L801">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">802</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $timeupdate = LJ::get_timeupdate_multi($u-&gt;id);</td></tr>
<tr><td class="h">803</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $timeupdate-&gt;{$u-&gt;id};</td></tr>
<tr><td class="h">804</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">805</td><td colspan="7"></td></tr><tr><td class="h">806</td><td colspan="7"></td></tr><tr><td class="h">807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method.  forgets the cached remote user.</td></tr>
<tr><td class="h">808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unset_remote</td></tr>
<tr><td class="h">809</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">810</td><td><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L810">8</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">811</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::CACHED_REMOTE = 0;</td></tr>
<tr><td class="h">812</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::CACHE_REMOTE = undef;</td></tr>
<tr><td class="h">813</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;1;</td></tr>
<tr><td class="h">814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">815</td><td colspan="7"></td></tr><tr><td class="h">816</td><td colspan="7"></td></tr><tr><td class="h">817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">818</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 4. Login, Session, and Rename Functions</td></tr>
<tr><td class="h">819</td><td colspan="7"></td></tr><tr><td class="h">820</td><td colspan="7"></td></tr><tr><td class="h">821</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a new LJ::Session object, or undef on failure</td></tr>
<tr><td class="h">822</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_session</td></tr>
<tr><td class="h">823</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">824</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L824">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, %opts) = @_;</td></tr>
<tr><td class="h">825</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Session-&gt;create($u, %opts);</td></tr>
<tr><td class="h">826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">827</td><td colspan="7"></td></tr><tr><td class="h">828</td><td colspan="7"></td></tr><tr><td class="h">829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#&lt;LJFUNC&gt;</td></tr>
<tr><td class="h">830</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::User::get_renamed_user</td></tr>
<tr><td class="h">831</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Get the actual user of a renamed user</td></tr>
<tr><td class="h">832</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: user</td></tr>
<tr><td class="h">833</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: user</td></tr>
<tr><td class="h">834</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">835</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_renamed_user {</td></tr>
<tr><td class="h">836</td><td><div class="c3">10</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L836">10</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">837</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %opts = @_;</td></tr>
<tr><td class="h">838</td><td><div class="c3">10</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L838">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $hops = $opts{hops} || 5;</td></tr>
<tr><td class="h">839</td><td colspan="7"></td></tr><tr><td class="h">840</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Traverse the renames to the final journal</td></tr>
<tr><td class="h">841</td><td><div class="c3">10</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L841">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u) {</td></tr>
<tr><td class="h">842</td><td><div class="c3">10</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L842">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while ( $u-&gt;is_redirect &amp;&amp; $hops-- &gt; 0 ) {</td></tr>
<tr><td class="h">843</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rt = $u-&gt;prop(&quot;renamedto&quot;);</td></tr>
<tr><td class="h">844</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L844">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last unless length $rt;</td></tr>
<tr><td class="h">845</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::load_user($rt);</td></tr>
<tr><td class="h">846</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">847</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">848</td><td colspan="7"></td></tr><tr><td class="h">849</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">851</td><td colspan="7"></td></tr><tr><td class="h">852</td><td colspan="7"></td></tr><tr><td class="h">853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::User-&gt;get_timeactive</td></tr>
<tr><td class="h">854</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des:  retrieve last active time for user from [dbtable[clustertrack2]] or</td></tr>
<tr><td class="h">855</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       memcache</td></tr>
<tr><td class="h">856</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_timeactive {</td></tr>
<tr><td class="h">857</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L857">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u) = @_;</td></tr>
<tr><td class="h">858</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;userid, &quot;timeactive:&quot; . $u-&gt;userid];</td></tr>
<tr><td class="h">859</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $active;</td></tr>
<tr><td class="h">860</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L860">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (defined($active = LJ::MemCache::get($memkey))) {</td></tr>
<tr><td class="h">861</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# TODO: die if unable to get handle? This was left verbatim from</td></tr>
<tr><td class="h">862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# refactored code.</td></tr>
<tr><td class="h">863</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L863">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u) or return 0;</td></tr>
<tr><td class="h">864</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$active = $dbcr-&gt;selectrow_array(&quot;SELECT timeactive FROM clustertrack2 &quot;.</td></tr>
<tr><td class="h">865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid=?&quot;, undef, $u-&gt;userid);</td></tr>
<tr><td class="h">866</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $active, 86400);</td></tr>
<tr><td class="h">867</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">868</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $active;</td></tr>
<tr><td class="h">869</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">870</td><td colspan="7"></td></tr><tr><td class="h">871</td><td colspan="7"></td></tr><tr><td class="h">872</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub kill_all_sessions {</td></tr>
<tr><td class="h">873</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L873">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L873">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift</td></tr>
<tr><td class="h">874</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return 0;</td></tr>
<tr><td class="h">875</td><td colspan="7"></td></tr><tr><td class="h">876</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L876">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Session-&gt;destroy_all_sessions($u)</td></tr>
<tr><td class="h">877</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return 0;</td></tr>
<tr><td class="h">878</td><td colspan="7"></td></tr><tr><td class="h">879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# forget this user, if we knew they were logged in</td></tr>
<tr><td class="h">880</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L880">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L880">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::CACHE_REMOTE &amp;&amp; $LJ::CACHE_REMOTE-&gt;userid == $u-&gt;userid) {</td></tr>
<tr><td class="h">881</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Session-&gt;clear_master_cookie;</td></tr>
<tr><td class="h">882</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::User-&gt;set_remote(undef);</td></tr>
<tr><td class="h">883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">884</td><td colspan="7"></td></tr><tr><td class="h">885</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">886</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">887</td><td colspan="7"></td></tr><tr><td class="h">888</td><td colspan="7"></td></tr><tr><td class="h">889</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $u-&gt;kill_session(@sessids)</td></tr>
<tr><td class="h">890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub kill_session {</td></tr>
<tr><td class="h">891</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L891">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L891">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift</td></tr>
<tr><td class="h">892</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return 0;</td></tr>
<tr><td class="h">893</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L893">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sess = $u-&gt;session</td></tr>
<tr><td class="h">894</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return 0;</td></tr>
<tr><td class="h">895</td><td colspan="7"></td></tr><tr><td class="h">896</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sess-&gt;destroy;</td></tr>
<tr><td class="h">897</td><td colspan="7"></td></tr><tr><td class="h">898</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L898">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L898">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::CACHE_REMOTE &amp;&amp; $LJ::CACHE_REMOTE-&gt;userid == $u-&gt;userid) {</td></tr>
<tr><td class="h">899</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::Session-&gt;clear_master_cookie;</td></tr>
<tr><td class="h">900</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::User-&gt;set_remote(undef);</td></tr>
<tr><td class="h">901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">902</td><td colspan="7"></td></tr><tr><td class="h">903</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">905</td><td colspan="7"></td></tr><tr><td class="h">906</td><td colspan="7"></td></tr><tr><td class="h">907</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub kill_sessions {</td></tr>
<tr><td class="h">908</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L908">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Session-&gt;destroy_sessions( @_ );</td></tr>
<tr><td class="h">909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">910</td><td colspan="7"></td></tr><tr><td class="h">911</td><td colspan="7"></td></tr><tr><td class="h">912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub logout {</td></tr>
<tr><td class="h">913</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L913">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">914</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L914">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $sess = $u-&gt;session) {</td></tr>
<tr><td class="h">915</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sess-&gt;destroy;</td></tr>
<tr><td class="h">916</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">917</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;_logout_common;</td></tr>
<tr><td class="h">918</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">919</td><td colspan="7"></td></tr><tr><td class="h">920</td><td colspan="7"></td></tr><tr><td class="h">921</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub logout_all {</td></tr>
<tr><td class="h">922</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L922">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">923</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L923">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Session-&gt;destroy_all_sessions($u)</td></tr>
<tr><td class="h">924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;Failed to logout all&quot;;</td></tr>
<tr><td class="h">925</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;_logout_common;</td></tr>
<tr><td class="h">926</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">927</td><td colspan="7"></td></tr><tr><td class="h">928</td><td colspan="7"></td></tr><tr><td class="h">929</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub make_login_session {</td></tr>
<tr><td class="h">930</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L930">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $exptype, $ipfixed) = @_;</td></tr>
<tr><td class="h">931</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L931">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$exptype ||= &#39;short&#39;;</td></tr>
<tr><td class="h">932</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L932">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u;</td></tr>
<tr><td class="h">933</td><td colspan="7"></td></tr><tr><td class="h">934</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;eval { BML::get_request()-&gt;notes-&gt;{ljuser} = $u-&gt;user; };</td></tr>
<tr><td class="h">935</td><td colspan="7"></td></tr><tr><td class="h">936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# create session and log user in</td></tr>
<tr><td class="h">937</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sess_opts = {</td></tr>
<tr><td class="h">938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;exptype&#39; =&gt; $exptype,</td></tr>
<tr><td class="h">939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;ipfixed&#39; =&gt; $ipfixed,</td></tr>
<tr><td class="h">940</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">941</td><td colspan="7"></td></tr><tr><td class="h">942</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sess = LJ::Session-&gt;create($u, %$sess_opts);</td></tr>
<tr><td class="h">943</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sess-&gt;update_master_cookie;</td></tr>
<tr><td class="h">944</td><td colspan="7"></td></tr><tr><td class="h">945</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::User-&gt;set_remote($u);</td></tr>
<tr><td class="h">946</td><td colspan="7"></td></tr><tr><td class="h">947</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# add a uniqmap row if we don&#39;t have one already</td></tr>
<tr><td class="h">948</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uniq = LJ::UniqCookie-&gt;current_uniq;</td></tr>
<tr><td class="h">949</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::UniqCookie-&gt;save_mapping($uniq =&gt; $u);</td></tr>
<tr><td class="h">950</td><td colspan="7"></td></tr><tr><td class="h">951</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# restore scheme and language</td></tr>
<tr><td class="h">952</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bl = LJ::Lang::get_lang($u-&gt;prop(&#39;browselang&#39;));</td></tr>
<tr><td class="h">953</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L953">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;BML::set_language($bl-&gt;{&#39;lncode&#39;}) if $bl;</td></tr>
<tr><td class="h">954</td><td colspan="7"></td></tr><tr><td class="h">955</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t set/force the scheme for this page if we&#39;re on SSL.</td></tr>
<tr><td class="h">956</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we&#39;ll pick it up from cookies on subsequent pageloads</td></tr>
<tr><td class="h">957</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# but if their scheme doesn&#39;t have an SSL equivalent,</td></tr>
<tr><td class="h">958</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# then the post-login page throws security errors</td></tr>
<tr><td class="h">959</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L959">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;BML::set_scheme($u-&gt;prop(&#39;schemepref&#39;))</td></tr>
<tr><td class="h">960</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $LJ::IS_SSL;</td></tr>
<tr><td class="h">961</td><td colspan="7"></td></tr><tr><td class="h">962</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# run some hooks</td></tr>
<tr><td class="h">963</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @sopts;</td></tr>
<tr><td class="h">964</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;login_add_opts&quot;, {</td></tr>
<tr><td class="h">965</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;u&quot; =&gt; $u,</td></tr>
<tr><td class="h">966</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;form&quot; =&gt; {},</td></tr>
<tr><td class="h">967</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;opts&quot; =&gt; \@sopts</td></tr>
<tr><td class="h">968</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">969</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L969">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sopts = @sopts ? &quot;:&quot; . join(&#39;&#39;, map { &quot;.$_&quot; } @sopts) : &quot;&quot;;</td></tr>
<tr><td class="h">970</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sess-&gt;flags($sopts);</td></tr>
<tr><td class="h">971</td><td colspan="7"></td></tr><tr><td class="h">972</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $etime = $sess-&gt;expiration_time;</td></tr>
<tr><td class="h">973</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;post_login&quot;, {</td></tr>
<tr><td class="h">974</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;u&quot; =&gt; $u,</td></tr>
<tr><td class="h">975</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;form&quot; =&gt; {},</td></tr>
<tr><td class="h">976</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;expiretime&quot; =&gt; $etime,</td></tr>
<tr><td class="h">977</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">978</td><td colspan="7"></td></tr><tr><td class="h">979</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# activity for cluster usage tracking</td></tr>
<tr><td class="h">980</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::mark_user_active($u, &#39;login&#39;);</td></tr>
<tr><td class="h">981</td><td colspan="7"></td></tr><tr><td class="h">982</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# activity for global account number tracking</td></tr>
<tr><td class="h">983</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;note_activity(&#39;A&#39;);</td></tr>
<tr><td class="h">984</td><td colspan="7"></td></tr><tr><td class="h">985</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">986</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">987</td><td colspan="7"></td></tr><tr><td class="h">988</td><td colspan="7"></td></tr><tr><td class="h">989</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># We have about 10 million different forms of activity tracking.</td></tr>
<tr><td class="h">990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This one is for tracking types of user activity on a per-hour basis</td></tr>
<tr><td class="h">991</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">992</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    Example: $u had login activity during this out</td></tr>
<tr><td class="h">993</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub note_activity {</td></tr>
<tr><td class="h">995</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L995">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $atype) = @_;</td></tr>
<tr><td class="h">996</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L996">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak (&quot;invalid user&quot;) unless ref $u;</td></tr>
<tr><td class="h">997</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L997">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak (&quot;invalid activity type&quot;) unless $atype;</td></tr>
<tr><td class="h">998</td><td colspan="7"></td></tr><tr><td class="h">999</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# If we have no memcache servers, this function would trigger</td></tr>
<tr><td class="h">1000</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# an insert for every logged-in pageview.  Probably not a problem</td></tr>
<tr><td class="h">1001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load-wise if the site isn&#39;t using memcache anyway, but if the</td></tr>
<tr><td class="h">1002</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# site is that small active user tracking probably doesn&#39;t matter</td></tr>
<tr><td class="h">1003</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# much either.  :/</td></tr>
<tr><td class="h">1004</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1004">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless @LJ::MEMCACHE_SERVERS;</td></tr>
<tr><td class="h">1005</td><td colspan="7"></td></tr><tr><td class="h">1006</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Also disable via config flag</td></tr>
<tr><td class="h">1007</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1007">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::is_enabled(&#39;active_user_tracking&#39;);</td></tr>
<tr><td class="h">1008</td><td colspan="7"></td></tr><tr><td class="h">1009</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now    = time();</td></tr>
<tr><td class="h">1010</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid    = $u-&gt;userid;   # yep, lazy typist w/ rsi</td></tr>
<tr><td class="h">1011</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $explen = 1800;         # 30 min, same for all types now</td></tr>
<tr><td class="h">1012</td><td colspan="7"></td></tr><tr><td class="h">1013</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [ $uid, &quot;uactive:$atype:$uid&quot; ];</td></tr>
<tr><td class="h">1014</td><td colspan="7"></td></tr><tr><td class="h">1015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get activity key from memcache</td></tr>
<tr><td class="h">1016</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $atime = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">1017</td><td colspan="7"></td></tr><tr><td class="h">1018</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# nothing to do if we got an $atime within the last hour</td></tr>
<tr><td class="h">1019</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1019">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1019">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $atime &amp;&amp; $atime &gt; $now - $explen;</td></tr>
<tr><td class="h">1020</td><td colspan="7"></td></tr><tr><td class="h">1021</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# key didn&#39;t exist due to expiration, or was too old,</td></tr>
<tr><td class="h">1022</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# means we need to make an activity entry for the user</td></tr>
<tr><td class="h">1023</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($hr, $dy, $mo, $yr) = (gmtime($now))[2..5];</td></tr>
<tr><td class="h">1024</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$yr += 1900; # offset from 1900</td></tr>
<tr><td class="h">1025</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$mo += 1;    # 0-based</td></tr>
<tr><td class="h">1026</td><td colspan="7"></td></tr><tr><td class="h">1027</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# delayed insert in case the table is currently locked due to an analysis</td></tr>
<tr><td class="h">1028</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# running.  this way the apache won&#39;t be tied up waiting</td></tr>
<tr><td class="h">1029</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;INSERT IGNORE INTO active_user &quot; .</td></tr>
<tr><td class="h">1030</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SET year=?, month=?, day=?, hour=?, userid=?, type=?&quot;,</td></tr>
<tr><td class="h">1031</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $yr, $mo, $dy, $hr, $uid, $atype);</td></tr>
<tr><td class="h">1032</td><td colspan="7"></td></tr><tr><td class="h">1033</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set a new memcache key good for $explen</td></tr>
<tr><td class="h">1034</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $now, $explen);</td></tr>
<tr><td class="h">1035</td><td colspan="7"></td></tr><tr><td class="h">1036</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1037</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1038</td><td colspan="7"></td></tr><tr><td class="h">1039</td><td colspan="7"></td></tr><tr><td class="h">1040</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1040">0</a></div></td><td></td><td><div>0</div></td><td class="s">sub rate_check { LJ::rate_check( @_ ); }</td></tr>
<tr><td class="h">1041</td><td colspan="7"></td></tr><tr><td class="h">1042</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1042">0</a></div></td><td></td><td><div>0</div></td><td class="s">sub rate_log { LJ::rate_log( @_ ); }</td></tr>
<tr><td class="h">1043</td><td colspan="7"></td></tr><tr><td class="h">1044</td><td colspan="7"></td></tr><tr><td class="h">1045</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub record_login {</td></tr>
<tr><td class="h">1046</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1046">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $sessid) = @_;</td></tr>
<tr><td class="h">1047</td><td colspan="7"></td></tr><tr><td class="h">1048</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $too_old = time() - 86400 * 30;</td></tr>
<tr><td class="h">1049</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM loginlog WHERE userid=? AND logintime &lt; ?&quot;,</td></tr>
<tr><td class="h">1050</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;userid, $too_old);</td></tr>
<tr><td class="h">1051</td><td colspan="7"></td></tr><tr><td class="h">1052</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $r  = DW::Request-&gt;get;</td></tr>
<tr><td class="h">1053</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ip = LJ::get_remote_ip();</td></tr>
<tr><td class="h">1054</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ua = $r-&gt;header_in(&#39;User-Agent&#39;);</td></tr>
<tr><td class="h">1055</td><td colspan="7"></td></tr><tr><td class="h">1056</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;do(&quot;INSERT INTO loginlog SET userid=?, sessid=?, logintime=UNIX_TIMESTAMP(), &quot;.</td></tr>
<tr><td class="h">1057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ip=?, ua=?&quot;, undef, $u-&gt;userid, $sessid, $ip, $ua);</td></tr>
<tr><td class="h">1058</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1059</td><td colspan="7"></td></tr><tr><td class="h">1060</td><td colspan="7"></td></tr><tr><td class="h">1061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># my $sess = $u-&gt;session           (returns current session)</td></tr>
<tr><td class="h">1062</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># my $sess = $u-&gt;session($sessid)  (returns given session id for user)</td></tr>
<tr><td class="h">1063</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub session {</td></tr>
<tr><td class="h">1064</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1064">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $sessid) = @_;</td></tr>
<tr><td class="h">1065</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sessid = $sessid + 0;</td></tr>
<tr><td class="h">1066</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1066">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_session} unless $sessid;  # should be undef, or LJ::Session hashref</td></tr>
<tr><td class="h">1067</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Session-&gt;instance($u, $sessid);</td></tr>
<tr><td class="h">1068</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1069</td><td colspan="7"></td></tr><tr><td class="h">1070</td><td colspan="7"></td></tr><tr><td class="h">1071</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># in list context, returns an array of LJ::Session objects which are active.</td></tr>
<tr><td class="h">1072</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># in scalar context, returns hashref of sessid -&gt; LJ::Session, which are active</td></tr>
<tr><td class="h">1073</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub sessions {</td></tr>
<tr><td class="h">1074</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1074">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1075</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @sessions = LJ::Session-&gt;active_sessions($u);</td></tr>
<tr><td class="h">1076</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1076">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @sessions if wantarray;</td></tr>
<tr><td class="h">1077</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = {};</td></tr>
<tr><td class="h">1078</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $s (@sessions) {</td></tr>
<tr><td class="h">1079</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{$s-&gt;id} = $s;</td></tr>
<tr><td class="h">1080</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1081</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">1082</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1083</td><td colspan="7"></td></tr><tr><td class="h">1084</td><td colspan="7"></td></tr><tr><td class="h">1085</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _logout_common {</td></tr>
<tr><td class="h">1086</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1086">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1087</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Session-&gt;clear_master_cookie;</td></tr>
<tr><td class="h">1088</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::User-&gt;set_remote(undef);</td></tr>
<tr><td class="h">1089</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;delete $BML::COOKIE{&#39;BMLschemepref&#39;};</td></tr>
<tr><td class="h">1090</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;eval { BML::set_scheme(undef); };</td></tr>
<tr><td class="h">1091</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1092</td><td colspan="7"></td></tr><tr><td class="h">1093</td><td colspan="7"></td></tr><tr><td class="h">1094</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">1095</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 5. Database and Memcache Functions</td></tr>
<tr><td class="h">1096</td><td colspan="7"></td></tr><tr><td class="h">1097</td><td colspan="7"></td></tr><tr><td class="h">1098</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub begin_work {</td></tr>
<tr><td class="h">1099</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1099">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1100</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1100">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $u-&gt;is_innodb;</td></tr>
<tr><td class="h">1101</td><td colspan="7"></td></tr><tr><td class="h">1102</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1102">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1102">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1104</td><td colspan="7"></td></tr><tr><td class="h">1105</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $dbcm-&gt;begin_work;</td></tr>
<tr><td class="h">1106</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1106">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{_dberr} = $dbcm-&gt;err) {</td></tr>
<tr><td class="h">1107</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_dberrstr} = $dbcm-&gt;errstr;</td></tr>
<tr><td class="h">1108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1109</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1111</td><td colspan="7"></td></tr><tr><td class="h">1112</td><td colspan="7"></td></tr><tr><td class="h">1113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub cache {</td></tr>
<tr><td class="h">1114</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1114">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $key) = @_;</td></tr>
<tr><td class="h">1115</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $val = $u-&gt;selectrow_array(&quot;SELECT value FROM userblobcache WHERE userid=? AND bckey=?&quot;,</td></tr>
<tr><td class="h">1116</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;userid, $key);</td></tr>
<tr><td class="h">1117</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1117">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless defined $val;</td></tr>
<tr><td class="h">1118</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1118">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $thaw = eval { Storable::thaw($val); }) {</td></tr>
<tr><td class="h">1119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $thaw;</td></tr>
<tr><td class="h">1120</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1121</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $val;</td></tr>
<tr><td class="h">1122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1123</td><td colspan="7"></td></tr><tr><td class="h">1124</td><td colspan="7"></td></tr><tr><td class="h">1125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># front-end to LJ::cmd_buffer_add, which has terrible interface</td></tr>
<tr><td class="h">1126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   cmd: scalar</td></tr>
<tr><td class="h">1127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   args: hashref</td></tr>
<tr><td class="h">1128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub cmd_buffer_add {</td></tr>
<tr><td class="h">1129</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1129">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $cmd, $args) = @_;</td></tr>
<tr><td class="h">1130</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1130">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$args ||= {};</td></tr>
<tr><td class="h">1131</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::cmd_buffer_add( $u-&gt;clusterid, $u-&gt;userid, $cmd, $args );</td></tr>
<tr><td class="h">1132</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1133</td><td colspan="7"></td></tr><tr><td class="h">1134</td><td colspan="7"></td></tr><tr><td class="h">1135</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub commit {</td></tr>
<tr><td class="h">1136</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1136">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1137</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1137">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $u-&gt;is_innodb;</td></tr>
<tr><td class="h">1138</td><td colspan="7"></td></tr><tr><td class="h">1139</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1139">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1139">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1141</td><td colspan="7"></td></tr><tr><td class="h">1142</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $dbcm-&gt;commit;</td></tr>
<tr><td class="h">1143</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1143">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{_dberr} = $dbcm-&gt;err) {</td></tr>
<tr><td class="h">1144</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_dberrstr} = $dbcm-&gt;errstr;</td></tr>
<tr><td class="h">1145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1146</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1147</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1148</td><td colspan="7"></td></tr><tr><td class="h">1149</td><td colspan="7"></td></tr><tr><td class="h">1150</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $u-&gt;do(&quot;UPDATE foo SET key=?&quot;, undef, $val);</td></tr>
<tr><td class="h">1151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub do {</td></tr>
<tr><td class="h">1152</td><td><div class="c3">2479</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1152">2479</a></div></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1153</td><td><div class="c3">2479</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $query = shift;</td></tr>
<tr><td class="h">1154</td><td colspan="7"></td></tr><tr><td class="h">1155</td><td><div class="c3">2479</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1155">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $u-&gt;userid + 0</td></tr>
<tr><td class="h">1156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak &quot;Database update called on null user object&quot;;</td></tr>
<tr><td class="h">1157</td><td colspan="7"></td></tr><tr><td class="h">1158</td><td><div class="c3">2479</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1158">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1158">67</a></div></td><td></td><td></td><td><div>36002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1160</td><td colspan="7"></td></tr><tr><td class="h">1161</td><td><div class="c3">2479</div></td><td></td><td></td><td></td><td></td><td><div>48002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$query =~ s!^(\s*\w+\s+)!$1/* uid=$uid */ !;</td></tr>
<tr><td class="h">1162</td><td colspan="7"></td></tr><tr><td class="h">1163</td><td><div class="c3">2479</div></td><td></td><td></td><td></td><td></td><td><div>8060456</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $dbcm-&gt;do($query, @_);</td></tr>
<tr><td class="h">1164</td><td><div class="c3">2479</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1164">100</a></div></td><td></td><td></td><td></td><td><div>44003</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{_dberr} = $dbcm-&gt;err) {</td></tr>
<tr><td class="h">1165</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_dberrstr} = $dbcm-&gt;errstr;</td></tr>
<tr><td class="h">1166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1167</td><td colspan="7"></td></tr><tr><td class="h">1168</td><td><div class="c3">2479</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1168">50</a></div></td><td></td><td></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_mysql_insertid} = $dbcm-&gt;{&#39;mysql_insertid&#39;} if $dbcm-&gt;{&#39;mysql_insertid&#39;};</td></tr>
<tr><td class="h">1169</td><td colspan="7"></td></tr><tr><td class="h">1170</td><td><div class="c3">2479</div></td><td></td><td></td><td></td><td></td><td><div>64003</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1172</td><td colspan="7"></td></tr><tr><td class="h">1173</td><td colspan="7"></td></tr><tr><td class="h">1174</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub dversion {</td></tr>
<tr><td class="h">1175</td><td><div class="c3">1259</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1175">1259</a></div></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1176</td><td><div class="c3">1259</div></td><td></td><td></td><td></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{dversion};</td></tr>
<tr><td class="h">1177</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1178</td><td colspan="7"></td></tr><tr><td class="h">1179</td><td colspan="7"></td></tr><tr><td class="h">1180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub err {</td></tr>
<tr><td class="h">1181</td><td><div class="c3">1035</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1181">1035</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1182</td><td><div class="c3">1035</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_dberr};</td></tr>
<tr><td class="h">1183</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1184</td><td colspan="7"></td></tr><tr><td class="h">1185</td><td colspan="7"></td></tr><tr><td class="h">1186</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub errstr {</td></tr>
<tr><td class="h">1187</td><td><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1187">15</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1188</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_dberrstr};</td></tr>
<tr><td class="h">1189</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1190</td><td colspan="7"></td></tr><tr><td class="h">1191</td><td colspan="7"></td></tr><tr><td class="h">1192</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_innodb {</td></tr>
<tr><td class="h">1193</td><td><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1193">8</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1194</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cluid = $u-&gt;clusterid;</td></tr>
<tr><td class="h">1195</td><td><div class="c3">8</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1195">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::CACHE_CLUSTER_IS_INNO{$cluid}</td></tr>
<tr><td class="h">1196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if defined $LJ::CACHE_CLUSTER_IS_INNO{$cluid};</td></tr>
<tr><td class="h">1197</td><td colspan="7"></td></tr><tr><td class="h">1198</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1198">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1198">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1200</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my (undef, $ctable) = $dbcm-&gt;selectrow_array(&quot;SHOW CREATE TABLE log2&quot;);</td></tr>
<tr><td class="h">1201</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1201">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Failed to auto-discover database type for cluster \#$cluid: [$ctable]&quot;</td></tr>
<tr><td class="h">1202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $ctable =~ /^CREATE TABLE/;</td></tr>
<tr><td class="h">1203</td><td colspan="7"></td></tr><tr><td class="h">1204</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1204">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $is_inno = ($ctable =~ /=InnoDB/i ? 1 : 0);</td></tr>
<tr><td class="h">1205</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::CACHE_CLUSTER_IS_INNO{$cluid} = $is_inno;</td></tr>
<tr><td class="h">1206</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1207</td><td colspan="7"></td></tr><tr><td class="h">1208</td><td colspan="7"></td></tr><tr><td class="h">1209</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub last_transition {</td></tr>
<tr><td class="h">1210</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this function is unused as of Aug 2009 - kareila</td></tr>
<tr><td class="h">1211</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1211">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $what) = @_;</td></tr>
<tr><td class="h">1212</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1212">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">1213</td><td colspan="7"></td></tr><tr><td class="h">1214</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;transition_list($what)-&gt;[-1];</td></tr>
<tr><td class="h">1215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1216</td><td colspan="7"></td></tr><tr><td class="h">1217</td><td colspan="7"></td></tr><tr><td class="h">1218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># log2_do</td></tr>
<tr><td class="h">1219</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># see comments for talk2_do</td></tr>
<tr><td class="h">1220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub log2_do {</td></tr>
<tr><td class="h">1221</td><td><div class="c3">35</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1221">35</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $errref, $sql, @args) = @_;</td></tr>
<tr><td class="h">1222</td><td><div class="c3">35</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1222">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u-&gt;writer;</td></tr>
<tr><td class="h">1223</td><td colspan="7"></td></tr><tr><td class="h">1224</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{_dbcm};</td></tr>
<tr><td class="h">1225</td><td colspan="7"></td></tr><tr><td class="h">1226</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;userid, &quot;log2lt:&quot; . $u-&gt;userid];</td></tr>
<tr><td class="h">1227</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lockkey = $memkey-&gt;[1];</td></tr>
<tr><td class="h">1228</td><td colspan="7"></td></tr><tr><td class="h">1229</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbcm-&gt;selectrow_array(&quot;SELECT GET_LOCK(?,10)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">1230</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = $u-&gt;do($sql, undef, @args);</td></tr>
<tr><td class="h">1231</td><td><div class="c3">35</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1231">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1231">67</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$errref = $u-&gt;errstr if ref $errref &amp;&amp; $u-&gt;err;</td></tr>
<tr><td class="h">1232</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbcm-&gt;selectrow_array(&quot;SELECT RELEASE_LOCK(?)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">1233</td><td colspan="7"></td></tr><tr><td class="h">1234</td><td><div class="c3">35</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1234">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete($memkey, 0) if int($ret);</td></tr>
<tr><td class="h">1235</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">1236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1237</td><td colspan="7"></td></tr><tr><td class="h">1238</td><td colspan="7"></td></tr><tr><td class="h">1239</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># simple function for getting something from memcache; this assumes that the</td></tr>
<tr><td class="h">1240</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># item being gotten follows the standard format [ $userid, &quot;item:$userid&quot; ]</td></tr>
<tr><td class="h">1241</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub memc_get {</td></tr>
<tr><td class="h">1242</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1242">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::MemCache::get( [$_[0]-&gt;userid, &quot;$_[1]:&quot; . $_[0]-&gt;userid] );</td></tr>
<tr><td class="h">1243</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1244</td><td colspan="7"></td></tr><tr><td class="h">1245</td><td colspan="7"></td></tr><tr><td class="h">1246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># sets a predictably named item. usage:</td></tr>
<tr><td class="h">1247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   $u-&gt;memc_set( key =&gt; &#39;value&#39;, [ $timeout ] );</td></tr>
<tr><td class="h">1248</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub memc_set {</td></tr>
<tr><td class="h">1249</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1249">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1249">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::MemCache::set( [$_[0]-&gt;userid, &quot;$_[1]:&quot; . $_[0]-&gt;userid], $_[2], $_[3] || 1800 );</td></tr>
<tr><td class="h">1250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1251</td><td colspan="7"></td></tr><tr><td class="h">1252</td><td colspan="7"></td></tr><tr><td class="h">1253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># deletes a predictably named item. usage:</td></tr>
<tr><td class="h">1254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   $u-&gt;memc_delete( key );</td></tr>
<tr><td class="h">1255</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub memc_delete {</td></tr>
<tr><td class="h">1256</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1256">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::MemCache::delete( [$_[0]-&gt;userid, &quot;$_[1]:&quot; . $_[0]-&gt;userid] );</td></tr>
<tr><td class="h">1257</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1258</td><td colspan="7"></td></tr><tr><td class="h">1259</td><td colspan="7"></td></tr><tr><td class="h">1260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mysql_insertid {</td></tr>
<tr><td class="h">1261</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1261">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1262</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1262">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1262">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;isa(&quot;LJ::User&quot;)) {</td></tr>
<tr><td class="h">1263</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_mysql_insertid};</td></tr>
<tr><td class="h">1264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif (LJ::isdb($u)) {</td></tr>
<tr><td class="h">1265</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = $u;</td></tr>
<tr><td class="h">1266</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $db-&gt;{&#39;mysql_insertid&#39;};</td></tr>
<tr><td class="h">1267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1268</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Unknown object &#39;$u&#39; being passed to LJ::User::mysql_insertid.&quot;;</td></tr>
<tr><td class="h">1269</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1271</td><td colspan="7"></td></tr><tr><td class="h">1272</td><td colspan="7"></td></tr><tr><td class="h">1273</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub nodb_err {</td></tr>
<tr><td class="h">1274</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1274">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;Database handle unavailable (user: &quot; . $u-&gt;user . &quot;; cluster: &quot; . $u-&gt;clusterid . &quot;)&quot;;</td></tr>
<tr><td class="h">1276</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1277</td><td colspan="7"></td></tr><tr><td class="h">1278</td><td colspan="7"></td></tr><tr><td class="h">1279</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub note_transition {</td></tr>
<tr><td class="h">1280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this function is unused as of Aug 2009 - kareila</td></tr>
<tr><td class="h">1281</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1281">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $what, $from, $to) = @_;</td></tr>
<tr><td class="h">1282</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1282">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">1283</td><td colspan="7"></td></tr><tr><td class="h">1284</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1284">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless LJ::is_enabled(&#39;user_transitions&#39;);</td></tr>
<tr><td class="h">1285</td><td colspan="7"></td></tr><tr><td class="h">1286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we don&#39;t want to insert if the requested transition is already</td></tr>
<tr><td class="h">1287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the last noted one for this user... in that case there has been</td></tr>
<tr><td class="h">1288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# no transition at all</td></tr>
<tr><td class="h">1289</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $last = $u-&gt;last_transition($what);</td></tr>
<tr><td class="h">1290</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1290">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1290">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if</td></tr>
<tr><td class="h">1291</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last-&gt;{before} eq $from &amp;&amp;</td></tr>
<tr><td class="h">1292</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last-&gt;{after}  eq $to;</td></tr>
<tr><td class="h">1293</td><td colspan="7"></td></tr><tr><td class="h">1294</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1294">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer()</td></tr>
<tr><td class="h">1295</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;unable to contact global db master&quot;;</td></tr>
<tr><td class="h">1296</td><td colspan="7"></td></tr><tr><td class="h">1297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# bleh, need backticks on the &#39;before&#39; and &#39;after&#39; columns since those</td></tr>
<tr><td class="h">1298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# are MySQL reserved words</td></tr>
<tr><td class="h">1299</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO usertrans &quot; .</td></tr>
<tr><td class="h">1300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SET userid=?, time=UNIX_TIMESTAMP(), what=?, &quot; .</td></tr>
<tr><td class="h">1301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;`before`=?, `after`=?&quot;,</td></tr>
<tr><td class="h">1302</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;{userid}, $what, $from, $to);</td></tr>
<tr><td class="h">1303</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1303">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die $dbh-&gt;errstr if $dbh-&gt;err;</td></tr>
<tr><td class="h">1304</td><td colspan="7"></td></tr><tr><td class="h">1305</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# also log account changes to statushistory</td></tr>
<tr><td class="h">1306</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">1307</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1307">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add($u, $remote, &quot;account_level_change&quot;, &quot;$from -&gt; $to&quot;)</td></tr>
<tr><td class="h">1308</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $what eq &quot;account&quot;;</td></tr>
<tr><td class="h">1309</td><td colspan="7"></td></tr><tr><td class="h">1310</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1312</td><td colspan="7"></td></tr><tr><td class="h">1313</td><td colspan="7"></td></tr><tr><td class="h">1314</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># get an $sth from the writer</td></tr>
<tr><td class="h">1315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub prepare {</td></tr>
<tr><td class="h">1316</td><td><div class="c3">50</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1316">50</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1317</td><td colspan="7"></td></tr><tr><td class="h">1318</td><td><div class="c3">50</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1318">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1318">67</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1320</td><td colspan="7"></td></tr><tr><td class="h">1321</td><td><div class="c3">50</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $dbcm-&gt;prepare(@_);</td></tr>
<tr><td class="h">1322</td><td><div class="c3">50</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1322">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{_dberr} = $dbcm-&gt;err) {</td></tr>
<tr><td class="h">1323</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_dberrstr} = $dbcm-&gt;errstr;</td></tr>
<tr><td class="h">1324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1325</td><td><div class="c3">50</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1326</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1327</td><td colspan="7"></td></tr><tr><td class="h">1328</td><td colspan="7"></td></tr><tr><td class="h">1329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub quote {</td></tr>
<tr><td class="h">1330</td><td><div class="c3">1044</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1330">1044</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $text ) = @_;</td></tr>
<tr><td class="h">1331</td><td colspan="7"></td></tr><tr><td class="h">1332</td><td><div class="c3">1044</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1332">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1332">33</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1334</td><td colspan="7"></td></tr><tr><td class="h">1335</td><td><div class="c3">1044</div></td><td></td><td></td><td></td><td></td><td><div>20001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $dbcm-&gt;quote($text);</td></tr>
<tr><td class="h">1336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1337</td><td colspan="7"></td></tr><tr><td class="h">1338</td><td colspan="7"></td></tr><tr><td class="h">1339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># memcache key that holds the number of times a user performed one of the rate-limited actions</td></tr>
<tr><td class="h">1340</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub rate_memkey {</td></tr>
<tr><td class="h">1341</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1341">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $rp) = @_;</td></tr>
<tr><td class="h">1342</td><td colspan="7"></td></tr><tr><td class="h">1343</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return [$u-&gt;id, &quot;rate:&quot; . $u-&gt;id . &quot;:$rp-&gt;{id}&quot;];</td></tr>
<tr><td class="h">1344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1345</td><td colspan="7"></td></tr><tr><td class="h">1346</td><td colspan="7"></td></tr><tr><td class="h">1347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub readonly {</td></tr>
<tr><td class="h">1348</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1348">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1349</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::get_cap($u, &quot;readonly&quot;);</td></tr>
<tr><td class="h">1350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1351</td><td colspan="7"></td></tr><tr><td class="h">1352</td><td colspan="7"></td></tr><tr><td class="h">1353</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub rollback {</td></tr>
<tr><td class="h">1354</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1354">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1355</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1355">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $u-&gt;is_innodb;</td></tr>
<tr><td class="h">1356</td><td colspan="7"></td></tr><tr><td class="h">1357</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1357">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1357">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1359</td><td colspan="7"></td></tr><tr><td class="h">1360</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $dbcm-&gt;rollback;</td></tr>
<tr><td class="h">1361</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1361">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{_dberr} = $dbcm-&gt;err) {</td></tr>
<tr><td class="h">1362</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_dberrstr} = $dbcm-&gt;errstr;</td></tr>
<tr><td class="h">1363</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1364</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1365</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1366</td><td colspan="7"></td></tr><tr><td class="h">1367</td><td colspan="7"></td></tr><tr><td class="h">1368</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub selectall_hashref {</td></tr>
<tr><td class="h">1369</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1369">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1370</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1370">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1370">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1371</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1372</td><td colspan="7"></td></tr><tr><td class="h">1373</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $dbcm-&gt;selectall_hashref(@_);</td></tr>
<tr><td class="h">1374</td><td colspan="7"></td></tr><tr><td class="h">1375</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1375">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{_dberr} = $dbcm-&gt;err) {</td></tr>
<tr><td class="h">1376</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_dberrstr} = $dbcm-&gt;errstr;</td></tr>
<tr><td class="h">1377</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1378</td><td colspan="7"></td></tr><tr><td class="h">1379</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1380</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1381</td><td colspan="7"></td></tr><tr><td class="h">1382</td><td colspan="7"></td></tr><tr><td class="h">1383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub selectcol_arrayref {</td></tr>
<tr><td class="h">1384</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1384">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1385</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1385">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1385">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1386</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1387</td><td colspan="7"></td></tr><tr><td class="h">1388</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $dbcm-&gt;selectcol_arrayref(@_);</td></tr>
<tr><td class="h">1389</td><td colspan="7"></td></tr><tr><td class="h">1390</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1390">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{_dberr} = $dbcm-&gt;err) {</td></tr>
<tr><td class="h">1391</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_dberrstr} = $dbcm-&gt;errstr;</td></tr>
<tr><td class="h">1392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1393</td><td colspan="7"></td></tr><tr><td class="h">1394</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1396</td><td colspan="7"></td></tr><tr><td class="h">1397</td><td colspan="7"></td></tr><tr><td class="h">1398</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub selectrow_array {</td></tr>
<tr><td class="h">1399</td><td><div class="c3">496</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1399">496</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1400</td><td><div class="c3">496</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1400">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1400">33</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1401</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1402</td><td colspan="7"></td></tr><tr><td class="h">1403</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $set_err = sub {</td></tr>
<tr><td class="h">1404</td><td><div class="c3">496</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1404">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1404">496</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{_dberr} = $dbcm-&gt;err) {</td></tr>
<tr><td class="h">1405</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_dberrstr} = $dbcm-&gt;errstr;</td></tr>
<tr><td class="h">1406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1407</td><td><div class="c3">496</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1408</td><td colspan="7"></td></tr><tr><td class="h">1409</td><td><div class="c3">496</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1409">50</a></div></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (wantarray()) {</td></tr>
<tr><td class="h">1410</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @rv = $dbcm-&gt;selectrow_array(@_);</td></tr>
<tr><td class="h">1411</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$set_err-&gt;();</td></tr>
<tr><td class="h">1412</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return @rv;</td></tr>
<tr><td class="h">1413</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1414</td><td colspan="7"></td></tr><tr><td class="h">1415</td><td><div class="c3">496</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $dbcm-&gt;selectrow_array(@_);</td></tr>
<tr><td class="h">1416</td><td><div class="c3">496</div></td><td></td><td></td><td></td><td></td><td><div>240019</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$set_err-&gt;();</td></tr>
<tr><td class="h">1417</td><td><div class="c3">496</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1418</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1419</td><td colspan="7"></td></tr><tr><td class="h">1420</td><td colspan="7"></td></tr><tr><td class="h">1421</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub selectrow_hashref {</td></tr>
<tr><td class="h">1422</td><td><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1422">4</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1423</td><td><div class="c3">4</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1423">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1423">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u)</td></tr>
<tr><td class="h">1424</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or croak $u-&gt;nodb_err;</td></tr>
<tr><td class="h">1425</td><td colspan="7"></td></tr><tr><td class="h">1426</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $dbcm-&gt;selectrow_hashref(@_);</td></tr>
<tr><td class="h">1427</td><td colspan="7"></td></tr><tr><td class="h">1428</td><td><div class="c3">4</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1428">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{_dberr} = $dbcm-&gt;err) {</td></tr>
<tr><td class="h">1429</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_dberrstr} = $dbcm-&gt;errstr;</td></tr>
<tr><td class="h">1430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1431</td><td colspan="7"></td></tr><tr><td class="h">1432</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1434</td><td colspan="7"></td></tr><tr><td class="h">1435</td><td colspan="7"></td></tr><tr><td class="h">1436</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># do some internal consistency checks on self.  die if problems,</td></tr>
<tr><td class="h">1437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># else returns 1.</td></tr>
<tr><td class="h">1438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub selfassert {</td></tr>
<tr><td class="h">1439</td><td><div class="c3">4369</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1439">4369</a></div></td><td></td><td><div>20002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1440</td><td><div class="c3">4369</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1440">50</a></div></td><td></td><td></td><td></td><td><div>56005</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::assert_is( $u-&gt;userid, $u-&gt;{_orig_userid} )</td></tr>
<tr><td class="h">1441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $u-&gt;{_orig_userid};</td></tr>
<tr><td class="h">1442</td><td><div class="c3">4369</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1442">50</a></div></td><td></td><td></td><td></td><td><div>40001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::assert_is( $u-&gt;user, $u-&gt;{_orig_user} )</td></tr>
<tr><td class="h">1443</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $u-&gt;{_orig_user};</td></tr>
<tr><td class="h">1444</td><td><div class="c3">4369</div></td><td></td><td></td><td></td><td></td><td><div>20000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1445</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1446</td><td colspan="7"></td></tr><tr><td class="h">1447</td><td colspan="7"></td></tr><tr><td class="h">1448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_cache {</td></tr>
<tr><td class="h">1449</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1449">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $key, $value, $expr) = @_;</td></tr>
<tr><td class="h">1450</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now = time();</td></tr>
<tr><td class="h">1451</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1451">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$expr ||= $now + 86400;</td></tr>
<tr><td class="h">1452</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1452">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$expr += $now if $expr &lt; 315532800;  # relative to absolute time</td></tr>
<tr><td class="h">1453</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1453">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$value = Storable::nfreeze($value) if ref $value;</td></tr>
<tr><td class="h">1454</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;REPLACE INTO userblobcache (userid, bckey, value, timeexpire) VALUES (?,?,?,?)&quot;,</td></tr>
<tr><td class="h">1455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;userid, $key, $value, $expr);</td></tr>
<tr><td class="h">1456</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1457</td><td colspan="7"></td></tr><tr><td class="h">1458</td><td colspan="7"></td></tr><tr><td class="h">1459</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># this is for debugging/special uses where you need to instruct</td></tr>
<tr><td class="h">1460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># a user object on what database handle to use.  returns the</td></tr>
<tr><td class="h">1461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># handle that you gave it.</td></tr>
<tr><td class="h">1462</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_dbcm {</td></tr>
<tr><td class="h">1463</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1463">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1464</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{&#39;_dbcm&#39;} = shift;</td></tr>
<tr><td class="h">1465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1466</td><td colspan="7"></td></tr><tr><td class="h">1467</td><td colspan="7"></td></tr><tr><td class="h">1468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method, returns { clusterid =&gt; [ uid, uid ], ... }</td></tr>
<tr><td class="h">1469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub split_by_cluster {</td></tr>
<tr><td class="h">1470</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1470">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">1471</td><td colspan="7"></td></tr><tr><td class="h">1472</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @uids = @_;</td></tr>
<tr><td class="h">1473</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $us = LJ::load_userids(@uids);</td></tr>
<tr><td class="h">1474</td><td colspan="7"></td></tr><tr><td class="h">1475</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %clusters;</td></tr>
<tr><td class="h">1476</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $u (values %$us) {</td></tr>
<tr><td class="h">1477</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1477">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $u;</td></tr>
<tr><td class="h">1478</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$clusters{$u-&gt;clusterid}}, $u-&gt;id;</td></tr>
<tr><td class="h">1479</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1480</td><td colspan="7"></td></tr><tr><td class="h">1481</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \%clusters;</td></tr>
<tr><td class="h">1482</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1483</td><td colspan="7"></td></tr><tr><td class="h">1484</td><td colspan="7"></td></tr><tr><td class="h">1485</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># all reads/writes to talk2 must be done inside a lock, so there&#39;s</td></tr>
<tr><td class="h">1486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># no race conditions between reading from db and putting in memcache.</td></tr>
<tr><td class="h">1487</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># can&#39;t do a db write in between those 2 steps.  the talk2 -&gt; memcache</td></tr>
<tr><td class="h">1488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># is elsewhere (talklib.pl), but this $dbh-&gt;do wrapper is provided</td></tr>
<tr><td class="h">1489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># here because non-talklib things modify the talk2 table, and it&#39;s</td></tr>
<tr><td class="h">1490</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># nice to centralize the locking rules.</td></tr>
<tr><td class="h">1491</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1492</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return value is return of $dbh-&gt;do.  $errref scalar ref is optional, and</td></tr>
<tr><td class="h">1493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># if set, gets value of $dbh-&gt;errstr</td></tr>
<tr><td class="h">1494</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># write:  (LJ::talk2_do)</td></tr>
<tr><td class="h">1496</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   GET_LOCK</td></tr>
<tr><td class="h">1497</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    update/insert into talk2</td></tr>
<tr><td class="h">1498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   RELEASE_LOCK</td></tr>
<tr><td class="h">1499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    delete memcache</td></tr>
<tr><td class="h">1500</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">1501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># read:   (LJ::Talk::get_talk_data)</td></tr>
<tr><td class="h">1502</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   try memcache</td></tr>
<tr><td class="h">1503</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   GET_LOCk</td></tr>
<tr><td class="h">1504</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#     read db</td></tr>
<tr><td class="h">1505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#     update memcache</td></tr>
<tr><td class="h">1506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   RELEASE_LOCK</td></tr>
<tr><td class="h">1507</td><td colspan="7"></td></tr><tr><td class="h">1508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub talk2_do {</td></tr>
<tr><td class="h">1509</td><td><div class="c3">220</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1509">220</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $nodetype, $nodeid, $errref, $sql, @args) = @_;</td></tr>
<tr><td class="h">1510</td><td><div class="c3">220</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1510">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $nodetype =~ /^\w$/;</td></tr>
<tr><td class="h">1511</td><td><div class="c3">220</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1511">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $nodeid =~ /^\d+$/;</td></tr>
<tr><td class="h">1512</td><td><div class="c3">220</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1512">50</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u-&gt;writer;</td></tr>
<tr><td class="h">1513</td><td colspan="7"></td></tr><tr><td class="h">1514</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = $u-&gt;{_dbcm};</td></tr>
<tr><td class="h">1515</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">1516</td><td colspan="7"></td></tr><tr><td class="h">1517</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$userid, &quot;talk2:$userid:$nodetype:$nodeid&quot;];</td></tr>
<tr><td class="h">1518</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lockkey = $memkey-&gt;[1];</td></tr>
<tr><td class="h">1519</td><td colspan="7"></td></tr><tr><td class="h">1520</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbcm-&gt;selectrow_array(&quot;SELECT GET_LOCK(?,10)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">1521</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>44002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = $u-&gt;do($sql, undef, @args);</td></tr>
<tr><td class="h">1522</td><td><div class="c3">220</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1522">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1522">67</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$errref = $u-&gt;errstr if ref $errref &amp;&amp; $u-&gt;err;</td></tr>
<tr><td class="h">1523</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbcm-&gt;selectrow_array(&quot;SELECT RELEASE_LOCK(?)&quot;, undef, $lockkey);</td></tr>
<tr><td class="h">1524</td><td colspan="7"></td></tr><tr><td class="h">1525</td><td><div class="c3">220</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1525">50</a></div></td><td></td><td></td><td></td><td><div>28002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete($memkey, 0) if int($ret);</td></tr>
<tr><td class="h">1526</td><td><div class="c3">220</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">1527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1528</td><td colspan="7"></td></tr><tr><td class="h">1529</td><td colspan="7"></td></tr><tr><td class="h">1530</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub transition_list {</td></tr>
<tr><td class="h">1531</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this function is unused as of Aug 2009 - kareila</td></tr>
<tr><td class="h">1532</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1532">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $what) = @_;</td></tr>
<tr><td class="h">1533</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1533">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">1534</td><td colspan="7"></td></tr><tr><td class="h">1535</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1535">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer()</td></tr>
<tr><td class="h">1536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;unable to contact global db master&quot;;</td></tr>
<tr><td class="h">1537</td><td colspan="7"></td></tr><tr><td class="h">1538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: return list of transition object singleton instances?</td></tr>
<tr><td class="h">1539</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @list = ();</td></tr>
<tr><td class="h">1540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbh-&gt;prepare(&quot;SELECT time, `before`, `after` &quot; .</td></tr>
<tr><td class="h">1541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM usertrans WHERE userid=? AND what=?&quot;);</td></tr>
<tr><td class="h">1542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($u-&gt;{userid}, $what);</td></tr>
<tr><td class="h">1543</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1543">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die $dbh-&gt;errstr if $dbh-&gt;err;</td></tr>
<tr><td class="h">1544</td><td colspan="7"></td></tr><tr><td class="h">1545</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my $trans = $sth-&gt;fetchrow_hashref) {</td></tr>
<tr><td class="h">1546</td><td colspan="7"></td></tr><tr><td class="h">1547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fill in a couple of properties here rather than</td></tr>
<tr><td class="h">1548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# sending over the network from db</td></tr>
<tr><td class="h">1549</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$trans-&gt;{userid} = $u-&gt;{userid};</td></tr>
<tr><td class="h">1550</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$trans-&gt;{what}   = $what;</td></tr>
<tr><td class="h">1551</td><td colspan="7"></td></tr><tr><td class="h">1552</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @list, $trans;</td></tr>
<tr><td class="h">1553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1554</td><td colspan="7"></td></tr><tr><td class="h">1555</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1555">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return wantarray() ? @list : \@list;</td></tr>
<tr><td class="h">1556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1557</td><td colspan="7"></td></tr><tr><td class="h">1558</td><td colspan="7"></td></tr><tr><td class="h">1559</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub uncache_prop {</td></tr>
<tr><td class="h">1560</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1560">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $name) = @_;</td></tr>
<tr><td class="h">1561</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1561">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop = LJ::get_prop(&quot;user&quot;, $name) or die; # FIXME: use exceptions</td></tr>
<tr><td class="h">1562</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">1563</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete( [$userid, &quot;uprop:$userid:$prop-&gt;{id}&quot;] );</td></tr>
<tr><td class="h">1564</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;delete $u-&gt;{$name};</td></tr>
<tr><td class="h">1565</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1566</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1567</td><td colspan="7"></td></tr><tr><td class="h">1568</td><td colspan="7"></td></tr><tr><td class="h">1569</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns self (the $u object which can be used for $u-&gt;do) if</td></tr>
<tr><td class="h">1570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># user is writable, else 0</td></tr>
<tr><td class="h">1571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub writer {</td></tr>
<tr><td class="h">1572</td><td><div class="c3">1376</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1572">1376</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1573</td><td><div class="c3">1376</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1573">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1573">67</a></div></td><td></td><td></td><td><div>16000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u if $u-&gt;{&#39;_dbcm&#39;} ||= LJ::get_cluster_master($u);</td></tr>
<tr><td class="h">1574</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1575</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1576</td><td colspan="7"></td></tr><tr><td class="h">1577</td><td colspan="7"></td></tr><tr><td class="h">1578</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">1579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 6. What the App Shows to Users</td></tr>
<tr><td class="h">1580</td><td colspan="7"></td></tr><tr><td class="h">1581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># format unixtimestamp according to the user&#39;s timezone setting</td></tr>
<tr><td class="h">1582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub format_time {</td></tr>
<tr><td class="h">1583</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this function is unused as of Aug 2009 - kareila</td></tr>
<tr><td class="h">1584</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1584">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1585</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $time = shift;</td></tr>
<tr><td class="h">1586</td><td colspan="7"></td></tr><tr><td class="h">1587</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1587">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $time;</td></tr>
<tr><td class="h">1588</td><td colspan="7"></td></tr><tr><td class="h">1589</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1589">0</a></div></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return eval { DateTime-&gt;from_epoch(epoch=&gt;$time, time_zone=&gt;$u-&gt;prop(&quot;timezone&quot;))-&gt;ymd(&#39;-&#39;) } ||</td></tr>
<tr><td class="h">1590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTime-&gt;from_epoch(epoch =&gt; $time)-&gt;ymd(&#39;-&#39;);</td></tr>
<tr><td class="h">1591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1592</td><td colspan="7"></td></tr><tr><td class="h">1593</td><td colspan="7"></td></tr><tr><td class="h">1594</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_in_beta {</td></tr>
<tr><td class="h">1595</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1595">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $key) = @_;</td></tr>
<tr><td class="h">1596</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::BetaFeatures-&gt;user_in_beta( $u =&gt; $key );</td></tr>
<tr><td class="h">1597</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1598</td><td colspan="7"></td></tr><tr><td class="h">1599</td><td colspan="7"></td></tr><tr><td class="h">1600</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># sometimes when the app throws errors, we want to display &quot;nice&quot;</td></tr>
<tr><td class="h">1601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># text to end-users, while allowing admins to view the actual error message</td></tr>
<tr><td class="h">1602</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub show_raw_errors {</td></tr>
<tr><td class="h">1603</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1603">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1604</td><td colspan="7"></td></tr><tr><td class="h">1605</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1605">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $LJ::IS_DEV_SERVER;</td></tr>
<tr><td class="h">1606</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1606">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $LJ::ENABLE_BETA_TOOLS;</td></tr>
<tr><td class="h">1607</td><td colspan="7"></td></tr><tr><td class="h">1608</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1608">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::isu( $u );</td></tr>
<tr><td class="h">1609</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1609">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;has_priv( &quot;supporthelp&quot; );</td></tr>
<tr><td class="h">1610</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1610">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;has_priv( &quot;supportviewscreened&quot; );</td></tr>
<tr><td class="h">1611</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1611">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;has_priv( &quot;siteadmin&quot; );</td></tr>
<tr><td class="h">1612</td><td colspan="7"></td></tr><tr><td class="h">1613</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1614</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1615</td><td colspan="7"></td></tr><tr><td class="h">1616</td><td colspan="7"></td></tr><tr><td class="h">1617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a DateTime object corresponding to a user&#39;s &quot;now&quot;</td></tr>
<tr><td class="h">1618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub time_now {</td></tr>
<tr><td class="h">1619</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1619">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1620</td><td colspan="7"></td></tr><tr><td class="h">1621</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now = DateTime-&gt;now;</td></tr>
<tr><td class="h">1622</td><td colspan="7"></td></tr><tr><td class="h">1623</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if user has timezone, use it!</td></tr>
<tr><td class="h">1624</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $tz = $u-&gt;prop(&quot;timezone&quot;);</td></tr>
<tr><td class="h">1625</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1625">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $now unless $tz;</td></tr>
<tr><td class="h">1626</td><td colspan="7"></td></tr><tr><td class="h">1627</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$now = eval { DateTime-&gt;from_epoch(</td></tr>
<tr><td class="h">1628</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;epoch =&gt; time(),</td></tr>
<tr><td class="h">1629</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time_zone =&gt; $tz,</td></tr>
<tr><td class="h">1630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">1631</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1632</td><td colspan="7"></td></tr><tr><td class="h">1633</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $now;</td></tr>
<tr><td class="h">1634</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1635</td><td colspan="7"></td></tr><tr><td class="h">1636</td><td colspan="7"></td></tr><tr><td class="h">1637</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return the user&#39;s timezone based on the prop if it&#39;s defined, otherwise best guess</td></tr>
<tr><td class="h">1638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub timezone {</td></tr>
<tr><td class="h">1639</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1639">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1640</td><td colspan="7"></td></tr><tr><td class="h">1641</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $offset = 0;</td></tr>
<tr><td class="h">1642</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::get_timezone($u, \$offset);</td></tr>
<tr><td class="h">1643</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $offset;</td></tr>
<tr><td class="h">1644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1645</td><td colspan="7"></td></tr><tr><td class="h">1646</td><td colspan="7"></td></tr><tr><td class="h">1647</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub tosagree_set</td></tr>
<tr><td class="h">1648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">1649</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1649">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $err) = @_;</td></tr>
<tr><td class="h">1650</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1650">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u;</td></tr>
<tr><td class="h">1651</td><td colspan="7"></td></tr><tr><td class="h">1652</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1652">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (-f &quot;$LJ::HOME/htdocs/inc/legal-tos&quot;) {</td></tr>
<tr><td class="h">1653</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$err = &quot;TOS include file could not be found&quot;;</td></tr>
<tr><td class="h">1654</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">1655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1656</td><td colspan="7"></td></tr><tr><td class="h">1657</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rev;</td></tr>
<tr><td class="h">1658</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;open (TOS, &quot;$LJ::HOME/htdocs/inc/legal-tos&quot;);</td></tr>
<tr><td class="h">1659</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1659">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while ((!$rev) &amp;&amp; (my $line = &lt;TOS&gt;)) {</td></tr>
<tr><td class="h">1660</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rcstag = &quot;Revision&quot;;</td></tr>
<tr><td class="h">1661</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1661">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($line =~ /\$$rcstag:\s*(\S+)\s*\$/) {</td></tr>
<tr><td class="h">1662</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rev = $1;</td></tr>
<tr><td class="h">1663</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1664</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1665</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;close TOS;</td></tr>
<tr><td class="h">1666</td><td colspan="7"></td></tr><tr><td class="h">1667</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if the required version of the tos is not available, error!</td></tr>
<tr><td class="h">1668</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rev_req = $LJ::REQUIRED_TOS{rev};</td></tr>
<tr><td class="h">1669</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1669">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1669">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($rev_req &gt; 0 &amp;&amp; $rev ne $rev_req) {</td></tr>
<tr><td class="h">1670</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$err = &quot;Required Terms of Service revision is $rev_req, but system version is $rev.&quot;;</td></tr>
<tr><td class="h">1671</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">1672</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1673</td><td colspan="7"></td></tr><tr><td class="h">1674</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $newval = join(&#39;, &#39;, time(), $rev);</td></tr>
<tr><td class="h">1675</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $u-&gt;set_prop(&quot;legal_tosagree&quot;, $newval);</td></tr>
<tr><td class="h">1676</td><td colspan="7"></td></tr><tr><td class="h">1677</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set in $u object for callers later</td></tr>
<tr><td class="h">1678</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1678">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{legal_tosagree} = $newval if $rv;</td></tr>
<tr><td class="h">1679</td><td colspan="7"></td></tr><tr><td class="h">1680</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rv;</td></tr>
<tr><td class="h">1681</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1682</td><td colspan="7"></td></tr><tr><td class="h">1683</td><td colspan="7"></td></tr><tr><td class="h">1684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub tosagree_verify {</td></tr>
<tr><td class="h">1685</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1685">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1686</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1686">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $LJ::TOS_CHECK;</td></tr>
<tr><td class="h">1687</td><td colspan="7"></td></tr><tr><td class="h">1688</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rev_req = $LJ::REQUIRED_TOS{rev};</td></tr>
<tr><td class="h">1689</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1689">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $rev_req &gt; 0;</td></tr>
<tr><td class="h">1690</td><td colspan="7"></td></tr><tr><td class="h">1691</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rev_cur = (split(/\s*,\s*/, $u-&gt;prop(&quot;legal_tosagree&quot;)))[1];</td></tr>
<tr><td class="h">1692</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $rev_cur eq $rev_req;</td></tr>
<tr><td class="h">1693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1694</td><td colspan="7"></td></tr><tr><td class="h">1695</td><td colspan="7"></td></tr><tr><td class="h">1696</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">1697</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 7. Userprops, Caps, and Displaying Content to Others</td></tr>
<tr><td class="h">1698</td><td colspan="7"></td></tr><tr><td class="h">1699</td><td colspan="7"></td></tr><tr><td class="h">1700</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub add_to_class {</td></tr>
<tr><td class="h">1701</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1701">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $class) = @_;</td></tr>
<tr><td class="h">1702</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bit = LJ::class_bit($class);</td></tr>
<tr><td class="h">1703</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1703">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;unknown class &#39;$class&#39;&quot; unless defined $bit;</td></tr>
<tr><td class="h">1704</td><td colspan="7"></td></tr><tr><td class="h">1705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# call add_to_class hook before we modify the</td></tr>
<tr><td class="h">1706</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# current $u, so it can make inferences from the</td></tr>
<tr><td class="h">1707</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# old $u caps vs the new we say we&#39;ll be adding</td></tr>
<tr><td class="h">1708</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1708">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::are_hooks(&#39;add_to_class&#39;)) {</td></tr>
<tr><td class="h">1709</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&#39;add_to_class&#39;, $u, $class);</td></tr>
<tr><td class="h">1710</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1711</td><td colspan="7"></td></tr><tr><td class="h">1712</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::modify_caps($u, [$bit], []);</td></tr>
<tr><td class="h">1713</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1714</td><td colspan="7"></td></tr><tr><td class="h">1715</td><td colspan="7"></td></tr><tr><td class="h">1716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub caps {</td></tr>
<tr><td class="h">1717</td><td><div class="c3">72</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1717">72</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1718</td><td><div class="c3">72</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{caps};</td></tr>
<tr><td class="h">1719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1720</td><td colspan="7"></td></tr><tr><td class="h">1721</td><td colspan="7"></td></tr><tr><td class="h">1722</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_be_text_messaged_by {</td></tr>
<tr><td class="h">1723</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1723">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $sender) = @_;</td></tr>
<tr><td class="h">1724</td><td colspan="7"></td></tr><tr><td class="h">1725</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1725">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;get_cap(&quot;textmessaging&quot;);</td></tr>
<tr><td class="h">1726</td><td colspan="7"></td></tr><tr><td class="h">1727</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $security = LJ::TextMessage-&gt;tm_security($u);</td></tr>
<tr><td class="h">1728</td><td colspan="7"></td></tr><tr><td class="h">1729</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1729">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $security eq &quot;none&quot;;</td></tr>
<tr><td class="h">1730</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1730">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $security eq &quot;all&quot;;</td></tr>
<tr><td class="h">1731</td><td colspan="7"></td></tr><tr><td class="h">1732</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1732">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($sender) {</td></tr>
<tr><td class="h">1733</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1733">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $security eq &quot;reg&quot;;</td></tr>
<tr><td class="h">1734</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1734">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1734">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $security eq &quot;friends&quot; &amp;&amp; $u-&gt;trusts( $sender );</td></tr>
<tr><td class="h">1735</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1736</td><td colspan="7"></td></tr><tr><td class="h">1737</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1738</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1739</td><td colspan="7"></td></tr><tr><td class="h">1740</td><td colspan="7"></td></tr><tr><td class="h">1741</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_show_location {</td></tr>
<tr><td class="h">1742</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1742">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1743</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1743">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">1744</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">1745</td><td colspan="7"></td></tr><tr><td class="h">1746</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1746">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_showlocation eq &#39;N&#39;;</td></tr>
<tr><td class="h">1747</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1747">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1747">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_showlocation eq &#39;R&#39; &amp;&amp; !$remote;</td></tr>
<tr><td class="h">1748</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1748">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1748">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_showlocation eq &#39;F&#39; &amp;&amp; !$u-&gt;trusts( $remote );</td></tr>
<tr><td class="h">1749</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1750</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1751</td><td colspan="7"></td></tr><tr><td class="h">1752</td><td colspan="7"></td></tr><tr><td class="h">1753</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_show_onlinestatus {</td></tr>
<tr><td class="h">1754</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this function is unused as of Aug 2009 - kareila</td></tr>
<tr><td class="h">1755</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1755">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1756</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = shift;</td></tr>
<tr><td class="h">1757</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1757">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object passed&quot;</td></tr>
<tr><td class="h">1758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::isu($u);</td></tr>
<tr><td class="h">1759</td><td colspan="7"></td></tr><tr><td class="h">1760</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Nobody can see online status of $u</td></tr>
<tr><td class="h">1761</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1761">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_showonlinestatus eq &#39;N&#39;;</td></tr>
<tr><td class="h">1762</td><td colspan="7"></td></tr><tr><td class="h">1763</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Everybody can see online status of $u</td></tr>
<tr><td class="h">1764</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1764">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;opt_showonlinestatus eq &#39;Y&#39;;</td></tr>
<tr><td class="h">1765</td><td colspan="7"></td></tr><tr><td class="h">1766</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Only mutually trusted people of $u can see online status</td></tr>
<tr><td class="h">1767</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1767">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;opt_showonlinestatus eq &#39;F&#39;) {</td></tr>
<tr><td class="h">1768</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1768">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $remote;</td></tr>
<tr><td class="h">1769</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1769">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;mutually_trusts( $remote );</td></tr>
<tr><td class="h">1770</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1771</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1772</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">1773</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1774</td><td colspan="7"></td></tr><tr><td class="h">1775</td><td colspan="7"></td></tr><tr><td class="h">1776</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_use_google_analytics {</td></tr>
<tr><td class="h">1777</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1777">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1777">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;get_cap( &#39;google_analytics&#39; ) ? 1 : 0;</td></tr>
<tr><td class="h">1778</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1779</td><td colspan="7"></td></tr><tr><td class="h">1780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Check if the user can use *any* page statistic module for their own journal.</td></tr>
<tr><td class="h">1781</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_use_page_statistics {</td></tr>
<tr><td class="h">1782</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1782">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;can_use_google_analytics;</td></tr>
<tr><td class="h">1783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1784</td><td colspan="7"></td></tr><tr><td class="h">1785</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub clear_prop {</td></tr>
<tr><td class="h">1786</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1786">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $prop) = @_;</td></tr>
<tr><td class="h">1787</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop($prop, undef);</td></tr>
<tr><td class="h">1788</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">1789</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1790</td><td colspan="7"></td></tr><tr><td class="h">1791</td><td colspan="7"></td></tr><tr><td class="h">1792</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub control_strip_display {</td></tr>
<tr><td class="h">1793</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1793">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1794</td><td colspan="7"></td></tr><tr><td class="h">1795</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return prop value if it exists and is valid</td></tr>
<tr><td class="h">1796</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop_val = $u-&gt;prop( &#39;control_strip_display&#39; );</td></tr>
<tr><td class="h">1797</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1797">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $prop_val eq &#39;none&#39;;</td></tr>
<tr><td class="h">1798</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1798">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $prop_val if $prop_val =~ /^\d+$/;</td></tr>
<tr><td class="h">1799</td><td colspan="7"></td></tr><tr><td class="h">1800</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# otherwise, return the default: all options checked</td></tr>
<tr><td class="h">1801</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret;</td></tr>
<tr><td class="h">1802</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @pageoptions = LJ::run_hook( &#39;page_control_strip_options&#39; );</td></tr>
<tr><td class="h">1803</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;for ( my $i = 0; $i &lt; scalar @pageoptions; $i++ ) {</td></tr>
<tr><td class="h">1804</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret |= 1 &lt;&lt; $i;</td></tr>
<tr><td class="h">1805</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1806</td><td colspan="7"></td></tr><tr><td class="h">1807</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1807">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret ? $ret : 0;</td></tr>
<tr><td class="h">1808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1809</td><td colspan="7"></td></tr><tr><td class="h">1810</td><td colspan="7"></td></tr><tr><td class="h">1811</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the country specified by the user</td></tr>
<tr><td class="h">1812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub country {</td></tr>
<tr><td class="h">1813</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1813">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;prop( &#39;country&#39; );</td></tr>
<tr><td class="h">1814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1815</td><td colspan="7"></td></tr><tr><td class="h">1816</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub exclude_from_own_stats {</td></tr>
<tr><td class="h">1817</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1817">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1818</td><td colspan="7"></td></tr><tr><td class="h">1819</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1819">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1819">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( defined $_[0] &amp;&amp; $_[0] =~ /[01]/ ) {</td></tr>
<tr><td class="h">1820</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop( exclude_from_own_stats =&gt; $_[0] );</td></tr>
<tr><td class="h">1821</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $_[0];</td></tr>
<tr><td class="h">1822</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1823</td><td colspan="7"></td></tr><tr><td class="h">1824</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1824">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;prop( &#39;exclude_from_own_stats&#39; ) eq &quot;1&quot; ? 1 : 0;</td></tr>
<tr><td class="h">1825</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1826</td><td colspan="7"></td></tr><tr><td class="h">1827</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the max capability ($cname) for all the classes</td></tr>
<tr><td class="h">1828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># the user is a member of</td></tr>
<tr><td class="h">1829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_cap {</td></tr>
<tr><td class="h">1830</td><td><div class="c3">11</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1830">11</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $cname ) = @_;</td></tr>
<tr><td class="h">1831</td><td><div class="c3">11</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1831">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $LJ::T_HAS_ALL_CAPS;</td></tr>
<tr><td class="h">1832</td><td><div class="c3">11</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::get_cap( $u, $cname );</td></tr>
<tr><td class="h">1833</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1834</td><td colspan="7"></td></tr><tr><td class="h">1835</td><td colspan="7"></td></tr><tr><td class="h">1836</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># get/set the gizmo account of a user</td></tr>
<tr><td class="h">1837</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub gizmo_account {</td></tr>
<tr><td class="h">1838</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1838">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1839</td><td colspan="7"></td></tr><tr><td class="h">1840</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# parse out their account information</td></tr>
<tr><td class="h">1841</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $acct = $u-&gt;prop( &#39;gizmo&#39; );</td></tr>
<tr><td class="h">1842</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($validated, $gizmo);</td></tr>
<tr><td class="h">1843</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1843">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1843">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($acct &amp;&amp; $acct =~ /^([01]);(.+)$/) {</td></tr>
<tr><td class="h">1844</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($validated, $gizmo) = ($1, $2);</td></tr>
<tr><td class="h">1845</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1846</td><td colspan="7"></td></tr><tr><td class="h">1847</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# setting the account</td></tr>
<tr><td class="h">1848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# all account sets are initially unvalidated</td></tr>
<tr><td class="h">1849</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1849">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@_) {</td></tr>
<tr><td class="h">1850</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $newgizmo = shift;</td></tr>
<tr><td class="h">1851</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop( &#39;gizmo&#39; =&gt; &quot;0;$newgizmo&quot; );</td></tr>
<tr><td class="h">1852</td><td colspan="7"></td></tr><tr><td class="h">1853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# purge old memcache keys</td></tr>
<tr><td class="h">1854</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete( &quot;gizmo-ljmap:$gizmo&quot; );</td></tr>
<tr><td class="h">1855</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1856</td><td colspan="7"></td></tr><tr><td class="h">1857</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return the information (either account + validation or just account)</td></tr>
<tr><td class="h">1858</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1858">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1858">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return wantarray ? ($gizmo, $validated) : $gizmo unless @_;</td></tr>
<tr><td class="h">1859</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1860</td><td colspan="7"></td></tr><tr><td class="h">1861</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># get/set the Google Analytics ID</td></tr>
<tr><td class="h">1862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub google_analytics {</td></tr>
<tr><td class="h">1863</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1863">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1864</td><td colspan="7"></td></tr><tr><td class="h">1865</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1865">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( defined $_[0] ) {</td></tr>
<tr><td class="h">1866</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop( google_analytics =&gt; $_[0] );</td></tr>
<tr><td class="h">1867</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $_[0];</td></tr>
<tr><td class="h">1868</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1869</td><td colspan="7"></td></tr><tr><td class="h">1870</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;prop( &#39;google_analytics&#39; );</td></tr>
<tr><td class="h">1871</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1872</td><td colspan="7"></td></tr><tr><td class="h">1873</td><td colspan="7"></td></tr><tr><td class="h">1874</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># tests to see if a user is in a specific named class. class</td></tr>
<tr><td class="h">1875</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># names are site-specific.</td></tr>
<tr><td class="h">1876</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub in_class {</td></tr>
<tr><td class="h">1877</td><td><div class="c3">42</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1877">42</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $class) = @_;</td></tr>
<tr><td class="h">1878</td><td><div class="c3">42</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::caps_in_group($u-&gt;{caps}, $class);</td></tr>
<tr><td class="h">1879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1880</td><td colspan="7"></td></tr><tr><td class="h">1881</td><td colspan="7"></td></tr><tr><td class="h">1882</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># must be called whenever birthday, location, journal modtime, journaltype, etc.</td></tr>
<tr><td class="h">1883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># changes.  see LJ/Directory/PackedUserRecord.pm</td></tr>
<tr><td class="h">1884</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub invalidate_directory_record {</td></tr>
<tr><td class="h">1885</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1885">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1886</td><td colspan="7"></td></tr><tr><td class="h">1887</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Future: ?</td></tr>
<tr><td class="h">1888</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# LJ::try_our_best_to(&quot;invalidate_directory_record&quot;, $u-&gt;id);</td></tr>
<tr><td class="h">1889</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# then elsewhere, map that key to subref.  if primary run fails,</td></tr>
<tr><td class="h">1890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# put in schwartz, then have one worker (misc-deferred) to</td></tr>
<tr><td class="h">1891</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# redo...</td></tr>
<tr><td class="h">1892</td><td colspan="7"></td></tr><tr><td class="h">1893</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1893">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbs = defined $LJ::USERSEARCH_DB_WRITER ? LJ::get_dbh($LJ::USERSEARCH_DB_WRITER) : LJ::get_db_writer();</td></tr>
<tr><td class="h">1894</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbs-&gt;do(&quot;UPDATE usersearch_packdata SET good_until=0 WHERE userid=?&quot;,</td></tr>
<tr><td class="h">1895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id);</td></tr>
<tr><td class="h">1896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1897</td><td colspan="7"></td></tr><tr><td class="h">1898</td><td colspan="7"></td></tr><tr><td class="h">1899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">1900</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::User::large_journal_icon</td></tr>
<tr><td class="h">1901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: get the large icon by journal type.</td></tr>
<tr><td class="h">1902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: HTML to display large journal icon.</td></tr>
<tr><td class="h">1903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">1904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub large_journal_icon {</td></tr>
<tr><td class="h">1905</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1905">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1906</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1906">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object&quot;</td></tr>
<tr><td class="h">1907</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::isu($u);</td></tr>
<tr><td class="h">1908</td><td colspan="7"></td></tr><tr><td class="h">1909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $wrap_img = sub {</td></tr>
<tr><td class="h">1910</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1910">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;img src=&#39;$LJ::IMGPREFIX/silk/24x24/$_[0]&#39; border=&#39;0&#39; height=&#39;24&#39; &quot; .</td></tr>
<tr><td class="h">1911</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;width=&#39;24&#39; style=&#39;padding: 0px 2px 0px 0px&#39; /&gt;&quot;;</td></tr>
<tr><td class="h">1912</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">1913</td><td colspan="7"></td></tr><tr><td class="h">1914</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# hook will return image to use if it cares about</td></tr>
<tr><td class="h">1915</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the $u it&#39;s been passed</td></tr>
<tr><td class="h">1916</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $hook_img = LJ::run_hook(&quot;large_journal_icon&quot;, $u);</td></tr>
<tr><td class="h">1917</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1917">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $wrap_img-&gt;($hook_img) if $hook_img;</td></tr>
<tr><td class="h">1918</td><td colspan="7"></td></tr><tr><td class="h">1919</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1919">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_comm) {</td></tr>
<tr><td class="h">1920</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $wrap_img-&gt;(&quot;community.png&quot;);</td></tr>
<tr><td class="h">1921</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1922</td><td colspan="7"></td></tr><tr><td class="h">1923</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1923">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_syndicated) {</td></tr>
<tr><td class="h">1924</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $wrap_img-&gt;(&quot;feed.png&quot;);</td></tr>
<tr><td class="h">1925</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1926</td><td colspan="7"></td></tr><tr><td class="h">1927</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1927">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_identity) {</td></tr>
<tr><td class="h">1928</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $wrap_img-&gt;(&quot;openid.png&quot;);</td></tr>
<tr><td class="h">1929</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1930</td><td colspan="7"></td></tr><tr><td class="h">1931</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# personal or unknown fallthrough</td></tr>
<tr><td class="h">1932</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $wrap_img-&gt;(&quot;user.png&quot;);</td></tr>
<tr><td class="h">1933</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1934</td><td colspan="7"></td></tr><tr><td class="h">1935</td><td colspan="7"></td></tr><tr><td class="h">1936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_logcommentips {</td></tr>
<tr><td class="h">1937</td><td><div class="c3">214</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1937">214</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1938</td><td colspan="7"></td></tr><tr><td class="h">1939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return prop value if it exists and is valid</td></tr>
<tr><td class="h">1940</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop_val = $u-&gt;prop( &#39;opt_logcommentips&#39; );</td></tr>
<tr><td class="h">1941</td><td><div class="c3">214</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L1941">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $prop_val if $prop_val =~ /^[NSA]$/;</td></tr>
<tr><td class="h">1942</td><td colspan="7"></td></tr><tr><td class="h">1943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# otherwise, return the default: log for all comments</td></tr>
<tr><td class="h">1944</td><td><div class="c3">214</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;A&#39;;</td></tr>
<tr><td class="h">1945</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1946</td><td colspan="7"></td></tr><tr><td class="h">1947</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_nctalklinks {</td></tr>
<tr><td class="h">1948</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1948">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $val ) = @_;</td></tr>
<tr><td class="h">1949</td><td colspan="7"></td></tr><tr><td class="h">1950</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1950">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1950">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( defined $val &amp;&amp; $val =~ /^[01]$/ ) {</td></tr>
<tr><td class="h">1951</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop( opt_nctalklinks =&gt; $val );</td></tr>
<tr><td class="h">1952</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $val;</td></tr>
<tr><td class="h">1953</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1954</td><td colspan="7"></td></tr><tr><td class="h">1955</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1955">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;prop( &#39;opt_nctalklinks&#39; ) eq &quot;1&quot; ? 1 : 0;</td></tr>
<tr><td class="h">1956</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1957</td><td colspan="7"></td></tr><tr><td class="h">1958</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_randompaidgifts {</td></tr>
<tr><td class="h">1959</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1959">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1960</td><td colspan="7"></td></tr><tr><td class="h">1961</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1961">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;prop( &#39;opt_randompaidgifts&#39; ) eq &#39;N&#39; ? 0 : 1;</td></tr>
<tr><td class="h">1962</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1963</td><td colspan="7"></td></tr><tr><td class="h">1964</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_showcontact {</td></tr>
<tr><td class="h">1965</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1965">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1966</td><td colspan="7"></td></tr><tr><td class="h">1967</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1967">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{&#39;allow_contactshow&#39;} =~ /^(N|Y|R|F)$/) {</td></tr>
<tr><td class="h">1968</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{&#39;allow_contactshow&#39;};</td></tr>
<tr><td class="h">1969</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1970</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1970">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;F&#39; if $u-&gt;is_minor;</td></tr>
<tr><td class="h">1971</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;Y&#39;;</td></tr>
<tr><td class="h">1972</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1973</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1974</td><td colspan="7"></td></tr><tr><td class="h">1975</td><td colspan="7"></td></tr><tr><td class="h">1976</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_showlocation {</td></tr>
<tr><td class="h">1977</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1977">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">1978</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# option not set = &quot;yes&quot;, set to N = &quot;no&quot;</td></tr>
<tr><td class="h">1979</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;_lazy_migrate_infoshow;</td></tr>
<tr><td class="h">1980</td><td colspan="7"></td></tr><tr><td class="h">1981</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# see comments for opt_showbday</td></tr>
<tr><td class="h">1982</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1982">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L1982">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( LJ::is_enabled(&#39;infoshow_migrate&#39;) || $u-&gt;{allow_infoshow} eq &#39; &#39; ) {</td></tr>
<tr><td class="h">1983</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1983">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{allow_infoshow} eq &#39;Y&#39; ? undef : &#39;N&#39;;</td></tr>
<tr><td class="h">1984</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1985</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1985">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;raw_prop(&#39;opt_showlocation&#39;) =~ /^(N|Y|R|F)$/) {</td></tr>
<tr><td class="h">1986</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;raw_prop(&#39;opt_showlocation&#39;);</td></tr>
<tr><td class="h">1987</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">1988</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L1988">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;F&#39; if ($u-&gt;is_minor);</td></tr>
<tr><td class="h">1989</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;Y&#39;;</td></tr>
<tr><td class="h">1990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">1991</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">1992</td><td colspan="7"></td></tr><tr><td class="h">1993</td><td colspan="7"></td></tr><tr><td class="h">1994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># opt_showonlinestatus options</td></tr>
<tr><td class="h">1995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># F = Mutually Trusted</td></tr>
<tr><td class="h">1996</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Y = Everybody</td></tr>
<tr><td class="h">1997</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># N = Nobody</td></tr>
<tr><td class="h">1998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_showonlinestatus {</td></tr>
<tr><td class="h">1999</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L1999">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2000</td><td colspan="7"></td></tr><tr><td class="h">2001</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2001">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;raw_prop(&#39;opt_showonlinestatus&#39;) =~ /^(F|N|Y)$/) {</td></tr>
<tr><td class="h">2002</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;raw_prop(&#39;opt_showonlinestatus&#39;);</td></tr>
<tr><td class="h">2003</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2004</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;F&#39;;</td></tr>
<tr><td class="h">2005</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2006</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2007</td><td colspan="7"></td></tr><tr><td class="h">2008</td><td colspan="7"></td></tr><tr><td class="h">2009</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_whatemailshow {</td></tr>
<tr><td class="h">2010</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2010">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2011</td><td colspan="7"></td></tr><tr><td class="h">2012</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2012">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2012">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user_email = $LJ::USER_EMAIL &amp;&amp; $u-&gt;get_cap( &#39;useremail&#39; ) ? 1 : 0;</td></tr>
<tr><td class="h">2013</td><td colspan="7"></td></tr><tr><td class="h">2014</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return prop value if it exists and is valid</td></tr>
<tr><td class="h">2015</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop_val = $u-&gt;prop( &#39;opt_whatemailshow&#39; );</td></tr>
<tr><td class="h">2016</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2016">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $user_email ) {</td></tr>
<tr><td class="h">2017</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2017">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $prop_val if $prop_val =~ /^[ALBNDV]$/;</td></tr>
<tr><td class="h">2018</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2019</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2019">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $prop_val if $prop_val =~ /^[AND]$/;</td></tr>
<tr><td class="h">2020</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2021</td><td colspan="7"></td></tr><tr><td class="h">2022</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# otherwise, return the default: no email shown</td></tr>
<tr><td class="h">2023</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;N&#39;;</td></tr>
<tr><td class="h">2024</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2025</td><td colspan="7"></td></tr><tr><td class="h">2026</td><td colspan="7"></td></tr><tr><td class="h">2027</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub profile_url {</td></tr>
<tr><td class="h">2028</td><td><div class="c3">10</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2028">10</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, %opts) = @_;</td></tr>
<tr><td class="h">2029</td><td colspan="7"></td></tr><tr><td class="h">2030</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $url;</td></tr>
<tr><td class="h">2031</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2031">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;is_identity ) {</td></tr>
<tr><td class="h">2032</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url = &quot;$LJ::SITEROOT/userinfo?userid=&quot; . $u-&gt;userid . &quot;&amp;t=I&quot;;</td></tr>
<tr><td class="h">2033</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2033">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url .= &quot;&amp;mode=full&quot; if $opts{full};</td></tr>
<tr><td class="h">2034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2035</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url = $u-&gt;journal_base . &quot;/profile&quot;;</td></tr>
<tr><td class="h">2036</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2036">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url .= &quot;?mode=full&quot; if $opts{full};</td></tr>
<tr><td class="h">2037</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2038</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $url;</td></tr>
<tr><td class="h">2039</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2040</td><td colspan="7"></td></tr><tr><td class="h">2041</td><td colspan="7"></td></tr><tr><td class="h">2042</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># get/set the displayed email on profile (if user has specified)</td></tr>
<tr><td class="h">2043</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub profile_email {</td></tr>
<tr><td class="h">2044</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2044">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $email ) = @_;</td></tr>
<tr><td class="h">2045</td><td colspan="7"></td></tr><tr><td class="h">2046</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2046">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( defined $email ) {</td></tr>
<tr><td class="h">2047</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop( opt_profileemail =&gt; $email );</td></tr>
<tr><td class="h">2048</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $email;</td></tr>
<tr><td class="h">2049</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2050</td><td colspan="7"></td></tr><tr><td class="h">2051</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;prop( &#39;opt_profileemail&#39; );</td></tr>
<tr><td class="h">2052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2053</td><td colspan="7"></td></tr><tr><td class="h">2054</td><td colspan="7"></td></tr><tr><td class="h">2055</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># instance method:  returns userprop for a user.  currently from cache with no</td></tr>
<tr><td class="h">2056</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># way yet to force master.</td></tr>
<tr><td class="h">2057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub prop {</td></tr>
<tr><td class="h">2058</td><td><div class="c3">1511</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2058">1511</a></div></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $prop) = @_;</td></tr>
<tr><td class="h">2059</td><td colspan="7"></td></tr><tr><td class="h">2060</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# some props have accessors which do crazy things, if so they need</td></tr>
<tr><td class="h">2061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# to be redirected from this method, which only loads raw values</td></tr>
<tr><td class="h">2062</td><td><div class="c3">1511</div><div class="c3">13599</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2062">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>60003</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ({ map { $_ =&gt; 1 }</td></tr>
<tr><td class="h">2063</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qw(opt_sharebday opt_showbday opt_showlocation opt_showmutualfriends</td></tr>
<tr><td class="h">2064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view_control_strip show_control_strip opt_ctxpopup opt_embedplaceholders</td></tr>
<tr><td class="h">2065</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esn_inbox_default_expand)</td></tr>
<tr><td class="h">2066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}-&gt;{$prop})</td></tr>
<tr><td class="h">2067</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">2068</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;$prop;</td></tr>
<tr><td class="h">2069</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2070</td><td colspan="7"></td></tr><tr><td class="h">2071</td><td><div class="c3">1511</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;raw_prop($prop);</td></tr>
<tr><td class="h">2072</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2073</td><td colspan="7"></td></tr><tr><td class="h">2074</td><td colspan="7"></td></tr><tr><td class="h">2075</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub raw_prop {</td></tr>
<tr><td class="h">2076</td><td><div class="c3">3749</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2076">3749</a></div></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $prop) = @_;</td></tr>
<tr><td class="h">2077</td><td><div class="c3">3749</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2077">50</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;preload_props($prop) unless exists $u-&gt;{$_};</td></tr>
<tr><td class="h">2078</td><td><div class="c3">3749</div></td><td></td><td></td><td></td><td></td><td><div>32002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{$prop};</td></tr>
<tr><td class="h">2079</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2080</td><td colspan="7"></td></tr><tr><td class="h">2081</td><td colspan="7"></td></tr><tr><td class="h">2082</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub remove_from_class {</td></tr>
<tr><td class="h">2083</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2083">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $class) = @_;</td></tr>
<tr><td class="h">2084</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bit = LJ::class_bit($class);</td></tr>
<tr><td class="h">2085</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2085">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;unknown class &#39;$class&#39;&quot; unless defined $bit;</td></tr>
<tr><td class="h">2086</td><td colspan="7"></td></tr><tr><td class="h">2087</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# call remove_from_class hook before we modify the</td></tr>
<tr><td class="h">2088</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# current $u, so it can make inferences from the</td></tr>
<tr><td class="h">2089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# old $u caps vs what we&#39;ll be removing</td></tr>
<tr><td class="h">2090</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2090">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::are_hooks(&#39;remove_from_class&#39;)) {</td></tr>
<tr><td class="h">2091</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&#39;remove_from_class&#39;, $u, $class);</td></tr>
<tr><td class="h">2092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2093</td><td colspan="7"></td></tr><tr><td class="h">2094</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::modify_caps($u, [], [$bit]);</td></tr>
<tr><td class="h">2095</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2096</td><td colspan="7"></td></tr><tr><td class="h">2097</td><td colspan="7"></td></tr><tr><td class="h">2098</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># sets prop, and also updates $u&#39;s cached version</td></tr>
<tr><td class="h">2099</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_prop {</td></tr>
<tr><td class="h">2100</td><td><div class="c3">815</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2100">815</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $prop, $value) = @_;</td></tr>
<tr><td class="h">2101</td><td><div class="c3">815</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2101">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::set_userprop($u, $prop, $value);  # FIXME: use exceptions</td></tr>
<tr><td class="h">2102</td><td><div class="c3">815</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{$prop} = $value;</td></tr>
<tr><td class="h">2103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2104</td><td colspan="7"></td></tr><tr><td class="h">2105</td><td colspan="7"></td></tr><tr><td class="h">2106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub share_contactinfo {</td></tr>
<tr><td class="h">2107</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2107">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $remote) = @_;</td></tr>
<tr><td class="h">2108</td><td colspan="7"></td></tr><tr><td class="h">2109</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2109">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;is_syndicated;</td></tr>
<tr><td class="h">2110</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2110">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_showcontact eq &#39;N&#39;;</td></tr>
<tr><td class="h">2111</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2111">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2111">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_showcontact eq &#39;R&#39; &amp;&amp; !$remote;</td></tr>
<tr><td class="h">2112</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2112">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2112">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_showcontact eq &#39;F&#39; &amp;&amp; !$u-&gt;trusts( $remote );</td></tr>
<tr><td class="h">2113</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2114</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2115</td><td colspan="7"></td></tr><tr><td class="h">2116</td><td colspan="7"></td></tr><tr><td class="h">2117</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub should_block_robots {</td></tr>
<tr><td class="h">2118</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2118">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2119</td><td colspan="7"></td></tr><tr><td class="h">2120</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2120">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;prop(&#39;opt_blockrobots&#39;);</td></tr>
<tr><td class="h">2121</td><td colspan="7"></td></tr><tr><td class="h">2122</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2122">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::is_enabled( &#39;adult_content&#39; );</td></tr>
<tr><td class="h">2123</td><td colspan="7"></td></tr><tr><td class="h">2124</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $adult_content = $u-&gt;adult_content_calculated;</td></tr>
<tr><td class="h">2125</td><td colspan="7"></td></tr><tr><td class="h">2126</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2126">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2126">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $LJ::CONTENT_FLAGS{$adult_content} &amp;&amp; $LJ::CONTENT_FLAGS{$adult_content}-&gt;{block_robots};</td></tr>
<tr><td class="h">2127</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">2128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2129</td><td colspan="7"></td></tr><tr><td class="h">2130</td><td colspan="7"></td></tr><tr><td class="h">2131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub support_points_count {</td></tr>
<tr><td class="h">2132</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2132">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2133</td><td colspan="7"></td></tr><tr><td class="h">2134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">2135</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;id;</td></tr>
<tr><td class="h">2136</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count;</td></tr>
<tr><td class="h">2137</td><td colspan="7"></td></tr><tr><td class="h">2138</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$count = $u-&gt;{_supportpointsum};</td></tr>
<tr><td class="h">2139</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2139">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $count if defined $count;</td></tr>
<tr><td class="h">2140</td><td colspan="7"></td></tr><tr><td class="h">2141</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$userid, &quot;supportpointsum:$userid&quot;];</td></tr>
<tr><td class="h">2142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$count = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">2143</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2143">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $count) {</td></tr>
<tr><td class="h">2144</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_supportpointsum} = $count;</td></tr>
<tr><td class="h">2145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $count;</td></tr>
<tr><td class="h">2146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2147</td><td colspan="7"></td></tr><tr><td class="h">2148</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2148">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$count = $dbr-&gt;selectrow_array(&quot;SELECT totpoints FROM supportpointsum WHERE userid=?&quot;, undef, $userid) || 0;</td></tr>
<tr><td class="h">2149</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_supportpointsum} = $count;</td></tr>
<tr><td class="h">2150</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $count, 60*5);</td></tr>
<tr><td class="h">2151</td><td colspan="7"></td></tr><tr><td class="h">2152</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $count;</td></tr>
<tr><td class="h">2153</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2154</td><td colspan="7"></td></tr><tr><td class="h">2155</td><td colspan="7"></td></tr><tr><td class="h">2156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub should_show_schools_to {</td></tr>
<tr><td class="h">2157</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2157">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $targetu) = @_;</td></tr>
<tr><td class="h">2158</td><td colspan="7"></td></tr><tr><td class="h">2159</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2159">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::is_enabled(&quot;schools&quot;);</td></tr>
<tr><td class="h">2160</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2160">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2160">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;{&#39;opt_showschools&#39;} eq &#39;&#39; || $u-&gt;{&#39;opt_showschools&#39;} eq &#39;Y&#39;;</td></tr>
<tr><td class="h">2161</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2161">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2161">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;{&#39;opt_showschools&#39;} eq &#39;F&#39; &amp;&amp; $u-&gt;trusts( $targetu );</td></tr>
<tr><td class="h">2162</td><td colspan="7"></td></tr><tr><td class="h">2163</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">2164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2165</td><td colspan="7"></td></tr><tr><td class="h">2166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># should show the thread expander for this user/journal</td></tr>
<tr><td class="h">2167</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub show_thread_expander {</td></tr>
<tr><td class="h">2168</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2168">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $remote ) = @_;</td></tr>
<tr><td class="h">2169</td><td colspan="7"></td></tr><tr><td class="h">2170</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2170">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2170">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $remote &amp;&amp; $remote-&gt;get_cap( &#39;thread_expander&#39; )</td></tr>
<tr><td class="h">2171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| $u-&gt;get_cap( &#39;thread_expander&#39; );</td></tr>
<tr><td class="h">2172</td><td colspan="7"></td></tr><tr><td class="h">2173</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">2174</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2175</td><td colspan="7"></td></tr><tr><td class="h">2176</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _lazy_migrate_infoshow {</td></tr>
<tr><td class="h">2177</td><td><div class="c3">576</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2177">576</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u) = @_;</td></tr>
<tr><td class="h">2178</td><td><div class="c3">576</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2178">50</a></div></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless LJ::is_enabled(&#39;infoshow_migrate&#39;);</td></tr>
<tr><td class="h">2179</td><td colspan="7"></td></tr><tr><td class="h">2180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# 1) column exists, but value is migrated</td></tr>
<tr><td class="h">2181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# 2) column has died from &#39;user&#39;)</td></tr>
<tr><td class="h">2182</td><td><div class="c3">576</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2182">100</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2182">67</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{allow_infoshow} eq &#39; &#39; || ! $u-&gt;{allow_infoshow}) {</td></tr>
<tr><td class="h">2183</td><td><div class="c3">399</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1; # nothing to do</td></tr>
<tr><td class="h">2184</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2185</td><td colspan="7"></td></tr><tr><td class="h">2186</td><td><div class="c3">177</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2186">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $infoval = $u-&gt;{allow_infoshow} eq &#39;Y&#39; ? undef : &#39;N&#39;;</td></tr>
<tr><td class="h">2187</td><td colspan="7"></td></tr><tr><td class="h">2188</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# need to migrate allow_infoshow =&gt; opt_showbday</td></tr>
<tr><td class="h">2189</td><td><div class="c3">177</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2189">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($infoval) {</td></tr>
<tr><td class="h">2190</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $prop (qw(opt_showbday opt_showlocation)) {</td></tr>
<tr><td class="h">2191</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop($prop =&gt; $infoval);</td></tr>
<tr><td class="h">2192</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2193</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2194</td><td colspan="7"></td></tr><tr><td class="h">2195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# setting allow_infoshow to &#39; &#39; means we&#39;ve migrated it</td></tr>
<tr><td class="h">2196</td><td><div class="c3">177</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2196">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::update_user($u, { allow_infoshow =&gt; &#39; &#39; })</td></tr>
<tr><td class="h">2197</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;unable to update user after infoshow migration&quot;;</td></tr>
<tr><td class="h">2198</td><td><div class="c3">177</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{allow_infoshow} = &#39; &#39;;</td></tr>
<tr><td class="h">2199</td><td colspan="7"></td></tr><tr><td class="h">2200</td><td><div class="c3">177</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2201</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2202</td><td colspan="7"></td></tr><tr><td class="h">2203</td><td colspan="7"></td></tr><tr><td class="h">2204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">2205</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 8. Formatting Content Shown to Users</td></tr>
<tr><td class="h">2206</td><td colspan="7"></td></tr><tr><td class="h">2207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub ajax_auth_token {</td></tr>
<tr><td class="h">2208</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2208">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Auth-&gt;ajax_auth_token( @_ );</td></tr>
<tr><td class="h">2209</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2210</td><td colspan="7"></td></tr><tr><td class="h">2211</td><td colspan="7"></td></tr><tr><td class="h">2212</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub bio {</td></tr>
<tr><td class="h">2213</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2213">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2214</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::get_bio($u);</td></tr>
<tr><td class="h">2215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2216</td><td colspan="7"></td></tr><tr><td class="h">2217</td><td colspan="7"></td></tr><tr><td class="h">2218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub check_ajax_auth_token {</td></tr>
<tr><td class="h">2219</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2219">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Auth-&gt;check_ajax_auth_token( @_ );</td></tr>
<tr><td class="h">2220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2221</td><td colspan="7"></td></tr><tr><td class="h">2222</td><td colspan="7"></td></tr><tr><td class="h">2223</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub clusterid {</td></tr>
<tr><td class="h">2224</td><td><div class="c3">4389</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2224">4389</a></div></td><td></td><td><div>28004</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;{clusterid};</td></tr>
<tr><td class="h">2225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2226</td><td colspan="7"></td></tr><tr><td class="h">2227</td><td colspan="7"></td></tr><tr><td class="h">2228</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns username or identity display name, not escaped</td></tr>
<tr><td class="h">2229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*display_username = \&amp;display_name;</td></tr>
<tr><td class="h">2230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub display_name {</td></tr>
<tr><td class="h">2231</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2231">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2232</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2232">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;user unless $u-&gt;is_identity;</td></tr>
<tr><td class="h">2233</td><td colspan="7"></td></tr><tr><td class="h">2234</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $id = $u-&gt;identity;</td></tr>
<tr><td class="h">2235</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2235">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;[ERR:unknown_identity]&quot; unless $id;</td></tr>
<tr><td class="h">2236</td><td colspan="7"></td></tr><tr><td class="h">2237</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($url, $name);</td></tr>
<tr><td class="h">2238</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2238">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($id-&gt;typeid eq &#39;O&#39;) {</td></tr>
<tr><td class="h">2239</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require Net::OpenID::Consumer;</td></tr>
<tr><td class="h">2240</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url = $id-&gt;value;</td></tr>
<tr><td class="h">2241</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name = Net::OpenID::VerifiedIdentity::DisplayOfURL($url, $LJ::IS_DEV_SERVER);</td></tr>
<tr><td class="h">2242</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2242">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name = LJ::run_hook(&quot;identity_display_name&quot;, $name) || $name;</td></tr>
<tr><td class="h">2243</td><td colspan="7"></td></tr><tr><td class="h">2244</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## Unescape %xx sequences</td></tr>
<tr><td class="h">2245</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name =~ s/%([\dA-Fa-f]{2})/chr(hex($1))/ge;</td></tr>
<tr><td class="h">2246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2247</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $name;</td></tr>
<tr><td class="h">2248</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2249</td><td colspan="7"></td></tr><tr><td class="h">2250</td><td colspan="7"></td></tr><tr><td class="h">2251</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub equals {</td></tr>
<tr><td class="h">2252</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2252">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::u_equals( @_ );</td></tr>
<tr><td class="h">2253</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2254</td><td colspan="7"></td></tr><tr><td class="h">2255</td><td colspan="7"></td></tr><tr><td class="h">2256</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># userid</td></tr>
<tr><td class="h">2257</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*userid = \&amp;id;</td></tr>
<tr><td class="h">2258</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub id {</td></tr>
<tr><td class="h">2259</td><td><div class="c3">21153</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2259">21153</a></div></td><td></td><td><div>4832269</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;{userid};</td></tr>
<tr><td class="h">2260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2261</td><td colspan="7"></td></tr><tr><td class="h">2262</td><td colspan="7"></td></tr><tr><td class="h">2263</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub ljuser_display {</td></tr>
<tr><td class="h">2264</td><td><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2264">6</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $opts ) = @_;</td></tr>
<tr><td class="h">2265</td><td colspan="7"></td></tr><tr><td class="h">2266</td><td><div class="c3">6</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2266">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::ljuser( $u, $opts ) unless $u-&gt;is_identity;</td></tr>
<tr><td class="h">2267</td><td colspan="7"></td></tr><tr><td class="h">2268</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $id = $u-&gt;identity;</td></tr>
<tr><td class="h">2269</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2269">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;b&gt;????&lt;/b&gt;&quot; unless $id;</td></tr>
<tr><td class="h">2270</td><td colspan="7"></td></tr><tr><td class="h">2271</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2271">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $andfull = $opts-&gt;{&#39;full&#39;} ? &quot;&amp;amp;mode=full&quot; : &quot;&quot;;</td></tr>
<tr><td class="h">2272</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2272">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $img = $opts-&gt;{&#39;imgroot&#39;} || $LJ::IMGPREFIX;</td></tr>
<tr><td class="h">2273</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2273">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $strike = $opts-&gt;{&#39;del&#39;} ? &#39; text-decoration: line-through;&#39; : &#39;&#39;;</td></tr>
<tr><td class="h">2274</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2274">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $profile_url = $opts-&gt;{&#39;profile_url&#39;} || &#39;&#39;;</td></tr>
<tr><td class="h">2275</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2275">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journal_url = $opts-&gt;{&#39;journal_url&#39;} || &#39;&#39;;</td></tr>
<tr><td class="h">2276</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2276">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $display_class = $opts-&gt;{no_ljuser_class} ? &quot;&quot; : &quot;class=&#39;ljuser&#39;&quot;;</td></tr>
<tr><td class="h">2277</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $type = $u-&gt;journaltype_readable;</td></tr>
<tr><td class="h">2278</td><td colspan="7"></td></tr><tr><td class="h">2279</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($url, $name);</td></tr>
<tr><td class="h">2280</td><td colspan="7"></td></tr><tr><td class="h">2281</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2281">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($id-&gt;typeid eq &#39;O&#39;) {</td></tr>
<tr><td class="h">2282</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2282">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url = $journal_url ne &#39;&#39; ? $journal_url : $id-&gt;value;</td></tr>
<tr><td class="h">2283</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name = $u-&gt;display_name;</td></tr>
<tr><td class="h">2284</td><td colspan="7"></td></tr><tr><td class="h">2285</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2285">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url ||= &quot;about:blank&quot;;</td></tr>
<tr><td class="h">2286</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2286">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name ||= &quot;[no_name]&quot;;</td></tr>
<tr><td class="h">2287</td><td colspan="7"></td></tr><tr><td class="h">2288</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url = LJ::ehtml($url);</td></tr>
<tr><td class="h">2289</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name = LJ::ehtml($name);</td></tr>
<tr><td class="h">2290</td><td colspan="7"></td></tr><tr><td class="h">2291</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($imgurl, $width, $height);</td></tr>
<tr><td class="h">2292</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $head_size = $opts-&gt;{head_size};</td></tr>
<tr><td class="h">2293</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2293">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($head_size) {</td></tr>
<tr><td class="h">2294</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$imgurl = &quot;$img/openid_${head_size}.gif&quot;;</td></tr>
<tr><td class="h">2295</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$width = $head_size;</td></tr>
<tr><td class="h">2296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$height = $head_size;</td></tr>
<tr><td class="h">2297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2298</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$imgurl = &quot;$img/silk/identity/openid.png&quot;;</td></tr>
<tr><td class="h">2299</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$width = 16;</td></tr>
<tr><td class="h">2300</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$height = 16;</td></tr>
<tr><td class="h">2301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2302</td><td colspan="7"></td></tr><tr><td class="h">2303</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2303">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $site = LJ::ExternalSite-&gt;find_matching_site($url)) {</td></tr>
<tr><td class="h">2304</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$imgurl = $site-&gt;icon_url;</td></tr>
<tr><td class="h">2305</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2306</td><td colspan="7"></td></tr><tr><td class="h">2307</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2307">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $profile = $profile_url ne &#39;&#39; ? $profile_url :</td></tr>
<tr><td class="h">2308</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;$LJ::SITEROOT/userinfo?userid=&quot; . $u-&gt;userid . &quot;&amp;amp;t=I$andfull&quot;;</td></tr>
<tr><td class="h">2309</td><td colspan="7"></td></tr><tr><td class="h">2310</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;span $display_class lj:user=&#39;$name&#39; style=&#39;white-space: nowrap;$strike&#39;&gt;&lt;a href=&#39;$profile&#39;&gt;&quot; .</td></tr>
<tr><td class="h">2311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;img src=&#39;$imgurl&#39; alt=&#39;[info - $type] &#39; width=&#39;$width&#39; height=&#39;$height&#39;&quot; .</td></tr>
<tr><td class="h">2312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; style=&#39;vertical-align: text-bottom; border: 0; padding-right: 1px;&#39; /&gt;&lt;/a&gt;&quot; .</td></tr>
<tr><td class="h">2313</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$url&#39; rel=&#39;nofollow&#39;&gt;&lt;b&gt;$name&lt;/b&gt;&lt;/a&gt;&lt;/span&gt;&quot;;</td></tr>
<tr><td class="h">2314</td><td colspan="7"></td></tr><tr><td class="h">2315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2316</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;b&gt;????&lt;/b&gt;&quot;;</td></tr>
<tr><td class="h">2317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2319</td><td colspan="7"></td></tr><tr><td class="h">2320</td><td colspan="7"></td></tr><tr><td class="h">2321</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the user-specified name of a journal in valid UTF-8</td></tr>
<tr><td class="h">2322</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># and with HTML escaped</td></tr>
<tr><td class="h">2323</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub name_html {</td></tr>
<tr><td class="h">2324</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2324">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2325</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::ehtml($u-&gt;name_raw);</td></tr>
<tr><td class="h">2326</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2327</td><td colspan="7"></td></tr><tr><td class="h">2328</td><td colspan="7"></td></tr><tr><td class="h">2329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the user-specified name of a journal exactly as entered</td></tr>
<tr><td class="h">2330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub name_orig {</td></tr>
<tr><td class="h">2331</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2331">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2332</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{name};</td></tr>
<tr><td class="h">2333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2334</td><td colspan="7"></td></tr><tr><td class="h">2335</td><td colspan="7"></td></tr><tr><td class="h">2336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the user-specified name of a journal in valid UTF-8</td></tr>
<tr><td class="h">2337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub name_raw {</td></tr>
<tr><td class="h">2338</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2338">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2339</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::text_out(\$u-&gt;{name});</td></tr>
<tr><td class="h">2340</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{name};</td></tr>
<tr><td class="h">2341</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2342</td><td colspan="7"></td></tr><tr><td class="h">2343</td><td colspan="7"></td></tr><tr><td class="h">2344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new_from_row {</td></tr>
<tr><td class="h">2345</td><td><div class="c3">374</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2345">374</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $row) = @_;</td></tr>
<tr><td class="h">2346</td><td><div class="c3">374</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = bless $row, $class;</td></tr>
<tr><td class="h">2347</td><td colspan="7"></td></tr><tr><td class="h">2348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# for selfassert method below:</td></tr>
<tr><td class="h">2349</td><td><div class="c3">374</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_orig_userid} = $u-&gt;userid;</td></tr>
<tr><td class="h">2350</td><td><div class="c3">374</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_orig_user}   = $u-&gt;user;</td></tr>
<tr><td class="h">2351</td><td colspan="7"></td></tr><tr><td class="h">2352</td><td><div class="c3">374</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">2353</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2354</td><td colspan="7"></td></tr><tr><td class="h">2355</td><td colspan="7"></td></tr><tr><td class="h">2356</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new_from_url {</td></tr>
<tr><td class="h">2357</td><td><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2357">15</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($class, $url) = @_;</td></tr>
<tr><td class="h">2358</td><td colspan="7"></td></tr><tr><td class="h">2359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# this doesn&#39;t seem to like URLs with ?...</td></tr>
<tr><td class="h">2360</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$url =~ s/\?.+$//;</td></tr>
<tr><td class="h">2361</td><td colspan="7"></td></tr><tr><td class="h">2362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# /users, /community, or /~</td></tr>
<tr><td class="h">2363</td><td><div class="c3">15</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2363">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($url =~ m!^\Q$LJ::SITEROOT\E/(?:users/|community/|~)([\w-]+)/?!) {</td></tr>
<tr><td class="h">2364</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::load_user($1);</td></tr>
<tr><td class="h">2365</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2366</td><td colspan="7"></td></tr><tr><td class="h">2367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user subdomains</td></tr>
<tr><td class="h">2368</td><td><div class="c3">15</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2368">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2368">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::USER_DOMAIN &amp;&amp; $url =~ m!^http://([\w-]+)\.\Q$LJ::USER_DOMAIN\E/?$!) {</td></tr>
<tr><td class="h">2369</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::load_user($1);</td></tr>
<tr><td class="h">2370</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2371</td><td colspan="7"></td></tr><tr><td class="h">2372</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# subdomains that hold a bunch of users (eg, users.siteroot.com/username/)</td></tr>
<tr><td class="h">2373</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2373">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($url =~ m!^http://\w+\.\Q$LJ::USER_DOMAIN\E/([\w-]+)/?$!) {</td></tr>
<tr><td class="h">2374</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::load_user($1);</td></tr>
<tr><td class="h">2375</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2376</td><td colspan="7"></td></tr><tr><td class="h">2377</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">2378</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2379</td><td colspan="7"></td></tr><tr><td class="h">2380</td><td colspan="7"></td></tr><tr><td class="h">2381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub url {</td></tr>
<tr><td class="h">2382</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2382">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2383</td><td colspan="7"></td></tr><tr><td class="h">2384</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $url;</td></tr>
<tr><td class="h">2385</td><td colspan="7"></td></tr><tr><td class="h">2386</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2386">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2386">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;is_identity &amp;&amp; ! $u-&gt;prop( &#39;url&#39; ) ) {</td></tr>
<tr><td class="h">2387</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = $u-&gt;identity;</td></tr>
<tr><td class="h">2388</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2388">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2388">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($id &amp;&amp; $id-&gt;typeid eq &#39;O&#39;) {</td></tr>
<tr><td class="h">2389</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url = $id-&gt;value;</td></tr>
<tr><td class="h">2390</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2390">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop(&quot;url&quot;, $url) if $url;</td></tr>
<tr><td class="h">2391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2393</td><td colspan="7"></td></tr><tr><td class="h">2394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# not openid, what does their &#39;url&#39; prop say?</td></tr>
<tr><td class="h">2395</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2395">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$url ||= $u-&gt;prop( &#39;url&#39; );</td></tr>
<tr><td class="h">2396</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2396">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $url;</td></tr>
<tr><td class="h">2397</td><td colspan="7"></td></tr><tr><td class="h">2398</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2398">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$url = &quot;http://$url&quot; unless $url =~ m!^https?://!;</td></tr>
<tr><td class="h">2399</td><td colspan="7"></td></tr><tr><td class="h">2400</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $url;</td></tr>
<tr><td class="h">2401</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2402</td><td colspan="7"></td></tr><tr><td class="h">2403</td><td colspan="7"></td></tr><tr><td class="h">2404</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns username</td></tr>
<tr><td class="h">2405</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*username = \&amp;user;</td></tr>
<tr><td class="h">2406</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub user {</td></tr>
<tr><td class="h">2407</td><td><div class="c3">6197</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2407">6197</a></div></td><td></td><td><div>164010</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $_[0]-&gt;{user};</td></tr>
<tr><td class="h">2408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2409</td><td colspan="7"></td></tr><tr><td class="h">2410</td><td colspan="7"></td></tr><tr><td class="h">2411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># if bio_absent is set to &quot;yes&quot;, bio won&#39;t be updated</td></tr>
<tr><td class="h">2412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_bio {</td></tr>
<tr><td class="h">2413</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2413">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $text, $bio_absent) = @_;</td></tr>
<tr><td class="h">2414</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2414">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$bio_absent = &quot;&quot; unless $bio_absent;</td></tr>
<tr><td class="h">2415</td><td colspan="7"></td></tr><tr><td class="h">2416</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $oldbio = $u-&gt;bio;</td></tr>
<tr><td class="h">2417</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2417">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $newbio = $bio_absent eq &quot;yes&quot; ? $oldbio : $text;</td></tr>
<tr><td class="h">2418</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2418">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $has_bio = ($newbio =~ /\S/) ? &quot;Y&quot; : &quot;N&quot;;</td></tr>
<tr><td class="h">2419</td><td colspan="7"></td></tr><tr><td class="h">2420</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %update = (</td></tr>
<tr><td class="h">2421</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;has_bio&#39; =&gt; $has_bio,</td></tr>
<tr><td class="h">2422</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2423</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::update_user($u, \%update);</td></tr>
<tr><td class="h">2424</td><td colspan="7"></td></tr><tr><td class="h">2425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update their bio text</td></tr>
<tr><td class="h">2426</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2426">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2426">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (($oldbio ne $text) &amp;&amp; $bio_absent ne &quot;yes&quot;) {</td></tr>
<tr><td class="h">2427</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2427">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($has_bio eq &quot;N&quot;) {</td></tr>
<tr><td class="h">2428</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM userbio WHERE userid=?&quot;, undef, $u-&gt;id);</td></tr>
<tr><td class="h">2429</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;dudata_set(&#39;B&#39;, 0, 0);</td></tr>
<tr><td class="h">2430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2431</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;REPLACE INTO userbio (userid, bio) VALUES (?, ?)&quot;,</td></tr>
<tr><td class="h">2432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id, $text);</td></tr>
<tr><td class="h">2433</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;dudata_set(&#39;B&#39;, 0, length($text));</td></tr>
<tr><td class="h">2434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2435</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$u-&gt;id, &quot;bio:&quot; . $u-&gt;id], $text);</td></tr>
<tr><td class="h">2436</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2438</td><td colspan="7"></td></tr><tr><td class="h">2439</td><td colspan="7"></td></tr><tr><td class="h">2440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">2441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 9. Logging and Recording Actions</td></tr>
<tr><td class="h">2442</td><td colspan="7"></td></tr><tr><td class="h">2443</td><td colspan="7"></td></tr><tr><td class="h">2444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">2445</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::User::dudata_set</td></tr>
<tr><td class="h">2446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: logging</td></tr>
<tr><td class="h">2447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Record or delete disk usage data for a journal.</td></tr>
<tr><td class="h">2448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, area, areaid, bytes</td></tr>
<tr><td class="h">2449</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-area: One character: &quot;L&quot; for log, &quot;T&quot; for talk, &quot;B&quot; for bio, &quot;P&quot; for pic.</td></tr>
<tr><td class="h">2450</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-areaid: Unique ID within $area, or &#39;0&#39; if area has no ids (like bio)</td></tr>
<tr><td class="h">2451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-bytes: Number of bytes item takes up.  Or 0 to delete record.</td></tr>
<tr><td class="h">2452</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1.</td></tr>
<tr><td class="h">2453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">2454</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub dudata_set {</td></tr>
<tr><td class="h">2455</td><td><div class="c3">35</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2455">35</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $area, $areaid, $bytes) = @_;</td></tr>
<tr><td class="h">2456</td><td><div class="c3">35</div><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$bytes += 0; $areaid += 0;</td></tr>
<tr><td class="h">2457</td><td><div class="c3">35</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2457">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($bytes) {</td></tr>
<tr><td class="h">2458</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;REPLACE INTO dudata (userid, area, areaid, bytes) &quot;.</td></tr>
<tr><td class="h">2459</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES (?, ?, $areaid, $bytes)&quot;, undef,</td></tr>
<tr><td class="h">2460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;userid, $area);</td></tr>
<tr><td class="h">2461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2462</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM dudata WHERE userid=? AND &quot;.</td></tr>
<tr><td class="h">2463</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;area=? AND areaid=$areaid&quot;, undef,</td></tr>
<tr><td class="h">2464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;userid, $area);</td></tr>
<tr><td class="h">2465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2466</td><td><div class="c3">35</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2467</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2468</td><td colspan="7"></td></tr><tr><td class="h">2469</td><td colspan="7"></td></tr><tr><td class="h">2470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># log a line to our userlog</td></tr>
<tr><td class="h">2471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub log_event {</td></tr>
<tr><td class="h">2472</td><td><div class="c3">340</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2472">340</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $type, $info ) = @_;</td></tr>
<tr><td class="h">2473</td><td><div class="c3">340</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2473">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $type;</td></tr>
<tr><td class="h">2474</td><td><div class="c3">340</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2474">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$info ||= {};</td></tr>
<tr><td class="h">2475</td><td colspan="7"></td></tr><tr><td class="h">2476</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now get variables we need; we use delete to remove them from the hash so when we&#39;re</td></tr>
<tr><td class="h">2477</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# done we can just encode what&#39;s left</td></tr>
<tr><td class="h">2478</td><td><div class="c3">340</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2478">33</a></div></td><td></td><td></td><td><div>12002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ip = delete($info-&gt;{ip}) || LJ::get_remote_ip() || undef;</td></tr>
<tr><td class="h">2479</td><td><div class="c3">340</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uniq = delete $info-&gt;{uniq};</td></tr>
<tr><td class="h">2480</td><td><div class="c3">340</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2480">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($uniq) {</td></tr>
<tr><td class="h">2481</td><td><div class="c3">340</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval {</td></tr>
<tr><td class="h">2482</td><td><div class="c3">340</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uniq = BML::get_request()-&gt;notes-&gt;{uniq};</td></tr>
<tr><td class="h">2483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2485</td><td><div class="c3">340</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L2485">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = delete($info-&gt;{remote}) || LJ::get_remote() || undef;</td></tr>
<tr><td class="h">2486</td><td><div class="c3">340</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L2486">100</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $targetid = (delete($info-&gt;{actiontarget})+0) || undef;</td></tr>
<tr><td class="h">2487</td><td><div class="c3">340</div><div class="c3">23</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2487">100</a></div></td><td></td><td></td><td></td><td><div>4001</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $extra = %$info ? join(&#39;&amp;&#39;, map { LJ::eurl($_) . &#39;=&#39; . LJ::eurl($info-&gt;{$_}) } keys %$info) : undef;</td></tr>
<tr><td class="h">2488</td><td colspan="7"></td></tr><tr><td class="h">2489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now insert the data we have</td></tr>
<tr><td class="h">2490</td><td><div class="c3">340</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2490">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;INSERT INTO userlog (userid, logtime, action, actiontarget, remoteid, ip, uniq, extra) &quot; .</td></tr>
<tr><td class="h">2491</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES (?, UNIX_TIMESTAMP(), ?, ?, ?, ?, ?, ?)&quot;, undef, $u-&gt;userid, $type,</td></tr>
<tr><td class="h">2492</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$targetid, $remote ? $remote-&gt;userid : undef, $ip, $uniq, $extra);</td></tr>
<tr><td class="h">2493</td><td><div class="c3">340</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2493">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef if $u-&gt;err;</td></tr>
<tr><td class="h">2494</td><td><div class="c3">340</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2496</td><td colspan="7"></td></tr><tr><td class="h">2497</td><td colspan="7"></td></tr><tr><td class="h">2498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">2499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 10. Banning-Related Functions</td></tr>
<tr><td class="h">2500</td><td colspan="7"></td></tr><tr><td class="h">2501</td><td colspan="7"></td></tr><tr><td class="h">2502</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub ban_user {</td></tr>
<tr><td class="h">2503</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2503">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $ban_u) = @_;</td></tr>
<tr><td class="h">2504</td><td colspan="7"></td></tr><tr><td class="h">2505</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">2506</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;log_event(&#39;ban_set&#39;, { actiontarget =&gt; $ban_u-&gt;id, remote =&gt; $remote });</td></tr>
<tr><td class="h">2507</td><td colspan="7"></td></tr><tr><td class="h">2508</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::set_rel($u-&gt;id, $ban_u-&gt;id, &#39;B&#39;);</td></tr>
<tr><td class="h">2509</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2510</td><td colspan="7"></td></tr><tr><td class="h">2511</td><td colspan="7"></td></tr><tr><td class="h">2512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub ban_user_multi {</td></tr>
<tr><td class="h">2513</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2513">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, @banlist) = @_;</td></tr>
<tr><td class="h">2514</td><td colspan="7"></td></tr><tr><td class="h">2515</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_rel_multi(map { [$u-&gt;id, $_, &#39;B&#39;] } @banlist);</td></tr>
<tr><td class="h">2516</td><td colspan="7"></td></tr><tr><td class="h">2517</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $us = LJ::load_userids(@banlist);</td></tr>
<tr><td class="h">2518</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $banuid (@banlist) {</td></tr>
<tr><td class="h">2519</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;log_event(&#39;ban_set&#39;, { actiontarget =&gt; $banuid, remote =&gt; LJ::get_remote() });</td></tr>
<tr><td class="h">2520</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2520">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&#39;ban_set&#39;, $u, $us-&gt;{$banuid}) if $us-&gt;{$banuid};</td></tr>
<tr><td class="h">2521</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2522</td><td colspan="7"></td></tr><tr><td class="h">2523</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2524</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2525</td><td colspan="7"></td></tr><tr><td class="h">2526</td><td colspan="7"></td></tr><tr><td class="h">2527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return if $target is banned from $u&#39;s journal</td></tr>
<tr><td class="h">2528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*has_banned = \&amp;is_banned;</td></tr>
<tr><td class="h">2529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_banned {</td></tr>
<tr><td class="h">2530</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2530">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $target) = @_;</td></tr>
<tr><td class="h">2531</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::is_banned($target-&gt;userid, $u-&gt;userid);</td></tr>
<tr><td class="h">2532</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2533</td><td colspan="7"></td></tr><tr><td class="h">2534</td><td colspan="7"></td></tr><tr><td class="h">2535</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unban_user_multi {</td></tr>
<tr><td class="h">2536</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2536">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, @unbanlist) = @_;</td></tr>
<tr><td class="h">2537</td><td colspan="7"></td></tr><tr><td class="h">2538</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::clear_rel_multi(map { [$u-&gt;id, $_, &#39;B&#39;] } @unbanlist);</td></tr>
<tr><td class="h">2539</td><td colspan="7"></td></tr><tr><td class="h">2540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $us = LJ::load_userids(@unbanlist);</td></tr>
<tr><td class="h">2541</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $banuid (@unbanlist) {</td></tr>
<tr><td class="h">2542</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;log_event(&#39;ban_unset&#39;, { actiontarget =&gt; $banuid, remote =&gt; LJ::get_remote() });</td></tr>
<tr><td class="h">2543</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2543">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&#39;ban_unset&#39;, $u, $us-&gt;{$banuid}) if $us-&gt;{$banuid};</td></tr>
<tr><td class="h">2544</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2545</td><td colspan="7"></td></tr><tr><td class="h">2546</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2548</td><td colspan="7"></td></tr><tr><td class="h">2549</td><td colspan="7"></td></tr><tr><td class="h">2550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">2551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 11. Birthdays and Age-Related Functions</td></tr>
<tr><td class="h">2552</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###   FIXME: Some of these may be outdated when we remove under-13 accounts.</td></tr>
<tr><td class="h">2553</td><td colspan="7"></td></tr><tr><td class="h">2554</td><td colspan="7"></td></tr><tr><td class="h">2555</td><td colspan="7"></td></tr><tr><td class="h">2556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Users age based off their profile birthdate</td></tr>
<tr><td class="h">2557</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub age {</td></tr>
<tr><td class="h">2558</td><td><div class="c3">1206</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2558">1206</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2559</td><td><div class="c3">1206</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2559">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;Invalid user object&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">2560</td><td colspan="7"></td></tr><tr><td class="h">2561</td><td><div class="c3">1206</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bdate = $u-&gt;{bdate};</td></tr>
<tr><td class="h">2562</td><td><div class="c3">1206</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2562">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless length $bdate;</td></tr>
<tr><td class="h">2563</td><td colspan="7"></td></tr><tr><td class="h">2564</td><td><div class="c3">1206</div></td><td></td><td></td><td></td><td></td><td><div>12000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($year, $mon, $day) = $bdate =~ m/^(\d\d\d\d)-(\d\d)-(\d\d)/;</td></tr>
<tr><td class="h">2565</td><td><div class="c3">1206</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $age = LJ::calc_age($year, $mon, $day);</td></tr>
<tr><td class="h">2566</td><td><div class="c3">1206</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2566">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $age if $age &gt; 0;</td></tr>
<tr><td class="h">2567</td><td><div class="c3">702</div></td><td></td><td></td><td></td><td></td><td><div>20000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">2568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2569</td><td colspan="7"></td></tr><tr><td class="h">2570</td><td colspan="7"></td></tr><tr><td class="h">2571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This will format the birthdate based on the user prop</td></tr>
<tr><td class="h">2572</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub bday_string {</td></tr>
<tr><td class="h">2573</td><td><div class="c3">126</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2573">126</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2574</td><td><div class="c3">126</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2574">100</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">2575</td><td colspan="7"></td></tr><tr><td class="h">2576</td><td><div class="c3">123</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bdate = $u-&gt;{&#39;bdate&#39;};</td></tr>
<tr><td class="h">2577</td><td><div class="c3">123</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($year,$mon,$day) = split(/-/, $bdate);</td></tr>
<tr><td class="h">2578</td><td><div class="c3">123</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bday_string = &#39;&#39;;</td></tr>
<tr><td class="h">2579</td><td colspan="7"></td></tr><tr><td class="h">2580</td><td><div class="c3">123</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2580">100</a></div><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2580">100</a></div><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2580">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L2580">100</a></div><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L2580">100</a></div><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L2580">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;can_show_full_bday &amp;&amp; $day &gt; 0 &amp;&amp; $mon &gt; 0 &amp;&amp; $year &gt; 0) {</td></tr>
<tr><td class="h">2581</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bday_string = $bdate;</td></tr>
<tr><td class="h">2582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($u-&gt;can_show_bday &amp;&amp; $day &gt; 0 &amp;&amp; $mon &gt; 0) {</td></tr>
<tr><td class="h">2583</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bday_string = &quot;$mon-$day&quot;;</td></tr>
<tr><td class="h">2584</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($u-&gt;can_show_bday_year &amp;&amp; $year &gt; 0) {</td></tr>
<tr><td class="h">2585</td><td><div class="c3">21</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bday_string = $year;</td></tr>
<tr><td class="h">2586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2587</td><td><div class="c3">123</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$bday_string =~ s/^0000-//;</td></tr>
<tr><td class="h">2588</td><td><div class="c3">123</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $bday_string;</td></tr>
<tr><td class="h">2589</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2590</td><td colspan="7"></td></tr><tr><td class="h">2591</td><td colspan="7"></td></tr><tr><td class="h">2592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Returns the best guess age of the user, which is init_age if it exists, otherwise age</td></tr>
<tr><td class="h">2593</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub best_guess_age {</td></tr>
<tr><td class="h">2594</td><td><div class="c3">1206</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2594">1206</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2595</td><td><div class="c3">1206</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2595">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2595">33</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;is_person || $u-&gt;is_identity;</td></tr>
<tr><td class="h">2596</td><td><div class="c3">1206</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2596">67</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;init_age || $u-&gt;age;</td></tr>
<tr><td class="h">2597</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2598</td><td colspan="7"></td></tr><tr><td class="h">2599</td><td colspan="7"></td></tr><tr><td class="h">2600</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns if this user can join an adult community or not</td></tr>
<tr><td class="h">2601</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># adultref will hold the value of the community&#39;s adult content flag</td></tr>
<tr><td class="h">2602</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_join_adult_comm {</td></tr>
<tr><td class="h">2603</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2603">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, %opts) = @_;</td></tr>
<tr><td class="h">2604</td><td colspan="7"></td></tr><tr><td class="h">2605</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2605">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless LJ::is_enabled( &#39;adult_content&#39; );</td></tr>
<tr><td class="h">2606</td><td colspan="7"></td></tr><tr><td class="h">2607</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $adultref = $opts{adultref};</td></tr>
<tr><td class="h">2608</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2608">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $comm = $opts{comm} or croak &quot;No community passed&quot;;</td></tr>
<tr><td class="h">2609</td><td colspan="7"></td></tr><tr><td class="h">2610</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $adult_content = $comm-&gt;adult_content_calculated;</td></tr>
<tr><td class="h">2611</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$adultref = $adult_content;</td></tr>
<tr><td class="h">2612</td><td colspan="7"></td></tr><tr><td class="h">2613</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2613">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2613">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $adult_content eq &quot;explicit&quot; &amp;&amp; ( $u-&gt;is_minor || !$u-&gt;best_guess_age );</td></tr>
<tr><td class="h">2614</td><td colspan="7"></td></tr><tr><td class="h">2615</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2617</td><td colspan="7"></td></tr><tr><td class="h">2618</td><td colspan="7"></td></tr><tr><td class="h">2619</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Birthday logic -- can any of the birthday info be shown</td></tr>
<tr><td class="h">2620</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This will return true if any birthday info can be shown</td></tr>
<tr><td class="h">2621</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_share_bday {</td></tr>
<tr><td class="h">2622</td><td><div class="c3">402</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2622">402</a></div></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %opts ) = @_;</td></tr>
<tr><td class="h">2623</td><td><div class="c3">402</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2623">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">2624</td><td colspan="7"></td></tr><tr><td class="h">2625</td><td><div class="c3">402</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2625">33</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $with_u = $opts{with} || LJ::get_remote();</td></tr>
<tr><td class="h">2626</td><td colspan="7"></td></tr><tr><td class="h">2627</td><td><div class="c3">402</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2627">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_sharebday eq &#39;N&#39;;</td></tr>
<tr><td class="h">2628</td><td><div class="c3">402</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2628">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2628">33</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_sharebday eq &#39;R&#39; &amp;&amp; !$with_u;</td></tr>
<tr><td class="h">2629</td><td><div class="c3">402</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2629">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2629">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_sharebday eq &#39;F&#39; &amp;&amp; !$u-&gt;trusts( $with_u );</td></tr>
<tr><td class="h">2630</td><td><div class="c3">402</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2631</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2632</td><td colspan="7"></td></tr><tr><td class="h">2633</td><td colspan="7"></td></tr><tr><td class="h">2634</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Birthday logic -- show appropriate string based on opt_showbday</td></tr>
<tr><td class="h">2635</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This will return true if the actual birthday can be shown</td></tr>
<tr><td class="h">2636</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_show_bday {</td></tr>
<tr><td class="h">2637</td><td><div class="c3">141</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2637">141</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %opts ) = @_;</td></tr>
<tr><td class="h">2638</td><td><div class="c3">141</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2638">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">2639</td><td colspan="7"></td></tr><tr><td class="h">2640</td><td><div class="c3">138</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2640">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $to_u = $opts{to} || LJ::get_remote();</td></tr>
<tr><td class="h">2641</td><td colspan="7"></td></tr><tr><td class="h">2642</td><td><div class="c3">138</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2642">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;can_share_bday( with =&gt; $to_u );</td></tr>
<tr><td class="h">2643</td><td><div class="c3">138</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2643">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L2643">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;opt_showbday eq &#39;D&#39; || $u-&gt;opt_showbday eq &#39;F&#39;;</td></tr>
<tr><td class="h">2644</td><td><div class="c3">84</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2646</td><td colspan="7"></td></tr><tr><td class="h">2647</td><td colspan="7"></td></tr><tr><td class="h">2648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This will return true if the actual birth year can be shown</td></tr>
<tr><td class="h">2649</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_show_bday_year {</td></tr>
<tr><td class="h">2650</td><td><div class="c3">126</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2650">126</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %opts ) = @_;</td></tr>
<tr><td class="h">2651</td><td><div class="c3">126</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2651">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">2652</td><td colspan="7"></td></tr><tr><td class="h">2653</td><td><div class="c3">123</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2653">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $to_u = $opts{to} || LJ::get_remote();</td></tr>
<tr><td class="h">2654</td><td colspan="7"></td></tr><tr><td class="h">2655</td><td><div class="c3">123</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2655">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;can_share_bday( with =&gt; $to_u );</td></tr>
<tr><td class="h">2656</td><td><div class="c3">123</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2656">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L2656">100</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;opt_showbday eq &#39;Y&#39; || $u-&gt;opt_showbday eq &#39;F&#39;;</td></tr>
<tr><td class="h">2657</td><td><div class="c3">48</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2658</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2659</td><td colspan="7"></td></tr><tr><td class="h">2660</td><td colspan="7"></td></tr><tr><td class="h">2661</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This will return true if month, day, and year can be shown</td></tr>
<tr><td class="h">2662</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_show_full_bday {</td></tr>
<tr><td class="h">2663</td><td><div class="c3">144</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2663">144</a></div></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %opts ) = @_;</td></tr>
<tr><td class="h">2664</td><td><div class="c3">144</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2664">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">2665</td><td colspan="7"></td></tr><tr><td class="h">2666</td><td><div class="c3">141</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2666">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $to_u = $opts{to} || LJ::get_remote();</td></tr>
<tr><td class="h">2667</td><td colspan="7"></td></tr><tr><td class="h">2668</td><td><div class="c3">141</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2668">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;can_share_bday( with =&gt; $to_u );</td></tr>
<tr><td class="h">2669</td><td><div class="c3">141</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2669">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;opt_showbday eq &#39;F&#39;;</td></tr>
<tr><td class="h">2670</td><td><div class="c3">27</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2672</td><td colspan="7"></td></tr><tr><td class="h">2673</td><td colspan="7"></td></tr><tr><td class="h">2674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub include_in_age_search {</td></tr>
<tr><td class="h">2675</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2675">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2676</td><td colspan="7"></td></tr><tr><td class="h">2677</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if they don&#39;t display the year</td></tr>
<tr><td class="h">2678</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2678">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_showbday =~ /^[DN]$/;</td></tr>
<tr><td class="h">2679</td><td colspan="7"></td></tr><tr><td class="h">2680</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it&#39;s not visible to registered users</td></tr>
<tr><td class="h">2681</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2681">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_sharebday =~ /^[NF]$/;</td></tr>
<tr><td class="h">2682</td><td colspan="7"></td></tr><tr><td class="h">2683</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2685</td><td colspan="7"></td></tr><tr><td class="h">2686</td><td colspan="7"></td></tr><tr><td class="h">2687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># This returns the users age based on the init_bdate (users coppa validation birthdate)</td></tr>
<tr><td class="h">2688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub init_age {</td></tr>
<tr><td class="h">2689</td><td><div class="c3">1206</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2689">1206</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2690</td><td><div class="c3">1206</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2690">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;Invalid user object&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">2691</td><td colspan="7"></td></tr><tr><td class="h">2692</td><td><div class="c3">1206</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $init_bdate = $u-&gt;prop(&#39;init_bdate&#39;);</td></tr>
<tr><td class="h">2693</td><td><div class="c3">1206</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2693">50</a></div></td><td></td><td></td><td></td><td><div>24001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $init_bdate;</td></tr>
<tr><td class="h">2694</td><td colspan="7"></td></tr><tr><td class="h">2695</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($year, $mon, $day) = $init_bdate =~ m/^(\d\d\d\d)-(\d\d)-(\d\d)/;</td></tr>
<tr><td class="h">2696</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $age = LJ::calc_age($year, $mon, $day);</td></tr>
<tr><td class="h">2697</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2697">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $age if $age &gt; 0;</td></tr>
<tr><td class="h">2698</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">2699</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2700</td><td colspan="7"></td></tr><tr><td class="h">2701</td><td colspan="7"></td></tr><tr><td class="h">2702</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub next_birthday {</td></tr>
<tr><td class="h">2703</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2703">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2704</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2704">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $u-&gt;is_expunged;</td></tr>
<tr><td class="h">2705</td><td colspan="7"></td></tr><tr><td class="h">2706</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;selectrow_array(&quot;SELECT nextbirthday FROM birthdays &quot; .</td></tr>
<tr><td class="h">2707</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid = ?&quot;, undef, $u-&gt;id)+0;</td></tr>
<tr><td class="h">2708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2709</td><td colspan="7"></td></tr><tr><td class="h">2710</td><td colspan="7"></td></tr><tr><td class="h">2711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class method, loads next birthdays for a bunch of users</td></tr>
<tr><td class="h">2712</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub next_birthdays {</td></tr>
<tr><td class="h">2713</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2713">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">2714</td><td colspan="7"></td></tr><tr><td class="h">2715</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load the users we need, so we can get their clusters</td></tr>
<tr><td class="h">2716</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $clusters = LJ::User-&gt;split_by_cluster(@_);</td></tr>
<tr><td class="h">2717</td><td colspan="7"></td></tr><tr><td class="h">2718</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %bdays = ();</td></tr>
<tr><td class="h">2719</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $cid (keys %$clusters) {</td></tr>
<tr><td class="h">2720</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2720">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $cid;</td></tr>
<tr><td class="h">2721</td><td colspan="7"></td></tr><tr><td class="h">2722</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2722">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @users = @{$clusters-&gt;{$cid} || []};</td></tr>
<tr><td class="h">2723</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2723">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($cid)</td></tr>
<tr><td class="h">2724</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or die &quot;Unable to load reader for cluster: $cid&quot;;</td></tr>
<tr><td class="h">2725</td><td colspan="7"></td></tr><tr><td class="h">2726</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $bind = join(&quot;,&quot;, map { &quot;?&quot; } @users);</td></tr>
<tr><td class="h">2727</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbcr-&gt;prepare(&quot;SELECT * FROM birthdays WHERE userid IN ($bind)&quot;);</td></tr>
<tr><td class="h">2728</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute(@users);</td></tr>
<tr><td class="h">2729</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my $row = $sth-&gt;fetchrow_hashref) {</td></tr>
<tr><td class="h">2730</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bdays{$row-&gt;{userid}} = $row-&gt;{nextbirthday};</td></tr>
<tr><td class="h">2731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2732</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2733</td><td colspan="7"></td></tr><tr><td class="h">2734</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \%bdays;</td></tr>
<tr><td class="h">2735</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2736</td><td colspan="7"></td></tr><tr><td class="h">2737</td><td colspan="7"></td></tr><tr><td class="h">2738</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># opt_showbday options</td></tr>
<tr><td class="h">2739</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># F - Full Display of Birthday</td></tr>
<tr><td class="h">2740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># D - Only Show Month/Day       DEFAULT</td></tr>
<tr><td class="h">2741</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Y - Only Show Year</td></tr>
<tr><td class="h">2742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># N - Do not display</td></tr>
<tr><td class="h">2743</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_showbday {</td></tr>
<tr><td class="h">2744</td><td><div class="c3">576</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2744">576</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2745</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# option not set = &quot;yes&quot;, set to N = &quot;no&quot;</td></tr>
<tr><td class="h">2746</td><td><div class="c3">576</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;_lazy_migrate_infoshow;</td></tr>
<tr><td class="h">2747</td><td colspan="7"></td></tr><tr><td class="h">2748</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# migrate above did nothing</td></tr>
<tr><td class="h">2749</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# -- if user was already migrated in the past, we&#39;ll</td></tr>
<tr><td class="h">2750</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#    fall through and show their prop value</td></tr>
<tr><td class="h">2751</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# -- if user not migrated yet, we&#39;ll synthesize a prop</td></tr>
<tr><td class="h">2752</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#    value from infoshow without writing it</td></tr>
<tr><td class="h">2753</td><td><div class="c3">576</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2753">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2753">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( LJ::is_enabled(&#39;infoshow_migrate&#39;) || $u-&gt;{allow_infoshow} eq &#39; &#39; ) {</td></tr>
<tr><td class="h">2754</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2754">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{allow_infoshow} eq &#39;Y&#39; ? undef : &#39;N&#39;;</td></tr>
<tr><td class="h">2755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2756</td><td><div class="c3">576</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2756">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;raw_prop(&#39;opt_showbday&#39;) =~ /^(D|F|N|Y)$/) {</td></tr>
<tr><td class="h">2757</td><td><div class="c3">456</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;raw_prop(&#39;opt_showbday&#39;);</td></tr>
<tr><td class="h">2758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2759</td><td><div class="c3">120</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;D&#39;;</td></tr>
<tr><td class="h">2760</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2761</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2762</td><td colspan="7"></td></tr><tr><td class="h">2763</td><td colspan="7"></td></tr><tr><td class="h">2764</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># opt_sharebday options</td></tr>
<tr><td class="h">2765</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># A - All people</td></tr>
<tr><td class="h">2766</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># R - Registered Users</td></tr>
<tr><td class="h">2767</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># F - Trusted Only</td></tr>
<tr><td class="h">2768</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># N - Nobody</td></tr>
<tr><td class="h">2769</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_sharebday {</td></tr>
<tr><td class="h">2770</td><td><div class="c3">1206</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2770">1206</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2771</td><td colspan="7"></td></tr><tr><td class="h">2772</td><td><div class="c3">1206</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2772">50</a></div></td><td></td><td></td><td></td><td><div>20002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;raw_prop(&#39;opt_sharebday&#39;) =~ /^(A|F|N|R)$/) {</td></tr>
<tr><td class="h">2773</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;raw_prop(&#39;opt_sharebday&#39;);</td></tr>
<tr><td class="h">2774</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">2775</td><td><div class="c3">1206</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L2775">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;F&#39; if $u-&gt;is_minor;</td></tr>
<tr><td class="h">2776</td><td><div class="c3">1206</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;A&#39;;</td></tr>
<tr><td class="h">2777</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2778</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2779</td><td colspan="7"></td></tr><tr><td class="h">2780</td><td colspan="7"></td></tr><tr><td class="h">2781</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># this sets the unix time of their next birthday for notifications</td></tr>
<tr><td class="h">2782</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_next_birthday {</td></tr>
<tr><td class="h">2783</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2783">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2784</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2784">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $u-&gt;is_expunged;</td></tr>
<tr><td class="h">2785</td><td colspan="7"></td></tr><tr><td class="h">2786</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($year, $mon, $day) = split(/-/, $u-&gt;{bdate});</td></tr>
<tr><td class="h">2787</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2787">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2787">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($mon &gt; 0 &amp;&amp; $day &gt; 0) {</td></tr>
<tr><td class="h">2788</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM birthdays WHERE userid = ?&quot;, undef, $u-&gt;id);</td></tr>
<tr><td class="h">2789</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">2790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2791</td><td colspan="7"></td></tr><tr><td class="h">2792</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $as_unix = sub {</td></tr>
<tr><td class="h">2793</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2793">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::mysqldate_to_time(sprintf(&quot;%04d-%02d-%02d&quot;, @_));</td></tr>
<tr><td class="h">2794</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">2795</td><td colspan="7"></td></tr><tr><td class="h">2796</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $curyear = (gmtime(time))[5]+1900;</td></tr>
<tr><td class="h">2797</td><td colspan="7"></td></tr><tr><td class="h">2798</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Calculate the time of their next birthday.</td></tr>
<tr><td class="h">2799</td><td colspan="7"></td></tr><tr><td class="h">2800</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Assumption is that birthday-notify jobs won&#39;t be backed up.</td></tr>
<tr><td class="h">2801</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# therefore, if a user&#39;s birthday is 1 day from now, but</td></tr>
<tr><td class="h">2802</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we process notifications for 2 days in advance, their next</td></tr>
<tr><td class="h">2803</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# birthday is really a year from tomorrow.</td></tr>
<tr><td class="h">2804</td><td colspan="7"></td></tr><tr><td class="h">2805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# We need to do calculate three possible &quot;next birthdays&quot;:</td></tr>
<tr><td class="h">2806</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Current Year + 0: For the case where we it for the first</td></tr>
<tr><td class="h">2807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   time, which could happen later this year.</td></tr>
<tr><td class="h">2808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Current Year + 1: For the case where we&#39;re setting their next</td></tr>
<tr><td class="h">2809</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   birthday on (approximately) their birthday. Gotta set it for</td></tr>
<tr><td class="h">2810</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   next year. This works in all cases but...</td></tr>
<tr><td class="h">2811</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Current Year + 2: For the case where we&#39;re processing notifs</td></tr>
<tr><td class="h">2812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   for next year already (eg, 2 days in advance, and we do</td></tr>
<tr><td class="h">2813</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   1/1 birthdays on 12/30). Year + 1 gives us the date two days</td></tr>
<tr><td class="h">2814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   from now! So, add another year on top of that.</td></tr>
<tr><td class="h">2815</td><td colspan="7"></td></tr><tr><td class="h">2816</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# We take whichever one is earliest, yet still later than the</td></tr>
<tr><td class="h">2817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# window of dates where we&#39;re processing notifications.</td></tr>
<tr><td class="h">2818</td><td colspan="7"></td></tr><tr><td class="h">2819</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bday;</td></tr>
<tr><td class="h">2820</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;for my $inc (0..2) {</td></tr>
<tr><td class="h">2821</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bday = $as_unix-&gt;($curyear + $inc, $mon, $day);</td></tr>
<tr><td class="h">2822</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2822">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $bday &gt; time() + $LJ::BIRTHDAY_NOTIFS_ADVANCE;</td></tr>
<tr><td class="h">2823</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2824</td><td colspan="7"></td></tr><tr><td class="h">2825</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# up to twelve hours drift so we don&#39;t get waves</td></tr>
<tr><td class="h">2826</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$bday += int(rand(12*3600));</td></tr>
<tr><td class="h">2827</td><td colspan="7"></td></tr><tr><td class="h">2828</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;REPLACE INTO birthdays VALUES (?, ?)&quot;, undef, $u-&gt;id, $bday);</td></tr>
<tr><td class="h">2829</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2829">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die $u-&gt;errstr if $u-&gt;err;</td></tr>
<tr><td class="h">2830</td><td colspan="7"></td></tr><tr><td class="h">2831</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $bday;</td></tr>
<tr><td class="h">2832</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2833</td><td colspan="7"></td></tr><tr><td class="h">2834</td><td colspan="7"></td></tr><tr><td class="h">2835</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub should_fire_birthday_notif {</td></tr>
<tr><td class="h">2836</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2836">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2837</td><td colspan="7"></td></tr><tr><td class="h">2838</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2838">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;is_person;</td></tr>
<tr><td class="h">2839</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2839">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;is_visible;</td></tr>
<tr><td class="h">2840</td><td colspan="7"></td></tr><tr><td class="h">2841</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if the month/day can&#39;t be shown</td></tr>
<tr><td class="h">2842</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2842">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_showbday =~ /^[YN]$/;</td></tr>
<tr><td class="h">2843</td><td colspan="7"></td></tr><tr><td class="h">2844</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if the birthday isn&#39;t shown to anyone</td></tr>
<tr><td class="h">2845</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2845">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;opt_sharebday eq &quot;N&quot;;</td></tr>
<tr><td class="h">2846</td><td colspan="7"></td></tr><tr><td class="h">2847</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# note: this isn&#39;t intended to capture all cases where birthday</td></tr>
<tr><td class="h">2848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# info is restricted. we want to pare out as much as possible;</td></tr>
<tr><td class="h">2849</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# individual &quot;can user X see this birthday&quot; is handled in</td></tr>
<tr><td class="h">2850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# LJ::Event::Birthday-&gt;matches_filter</td></tr>
<tr><td class="h">2851</td><td colspan="7"></td></tr><tr><td class="h">2852</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">2853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2854</td><td colspan="7"></td></tr><tr><td class="h">2855</td><td colspan="7"></td></tr><tr><td class="h">2856</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># data for generating packed directory records</td></tr>
<tr><td class="h">2857</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub usersearch_age_with_expire {</td></tr>
<tr><td class="h">2858</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2858">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2859</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2859">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;Invalid user object&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">2860</td><td colspan="7"></td></tr><tr><td class="h">2861</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t include their age in directory searches</td></tr>
<tr><td class="h">2862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it&#39;s not publicly visible in their profile</td></tr>
<tr><td class="h">2863</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2863">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $age = $u-&gt;include_in_age_search ? $u-&gt;age : 0;</td></tr>
<tr><td class="h">2864</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$age += 0;</td></tr>
<tr><td class="h">2865</td><td colspan="7"></td></tr><tr><td class="h">2866</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# no need to expire due to age if we don&#39;t have a birthday</td></tr>
<tr><td class="h">2867</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2867">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $expire = $u-&gt;next_birthday || undef;</td></tr>
<tr><td class="h">2868</td><td colspan="7"></td></tr><tr><td class="h">2869</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ($age, $expire);</td></tr>
<tr><td class="h">2870</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2871</td><td colspan="7"></td></tr><tr><td class="h">2872</td><td colspan="7"></td></tr><tr><td class="h">2873</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">2874</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 12. Comment-Related Functions</td></tr>
<tr><td class="h">2875</td><td colspan="7"></td></tr><tr><td class="h">2876</td><td colspan="7"></td></tr><tr><td class="h">2877</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># get recent talkitems posted to this user</td></tr>
<tr><td class="h">2878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: maximum number of comments to retrieve</td></tr>
<tr><td class="h">2879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: array of hashrefs with jtalkid, nodetype, nodeid, parenttalkid, posterid, state</td></tr>
<tr><td class="h">2880</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_recent_talkitems {</td></tr>
<tr><td class="h">2881</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2881">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $maxshow, %opts) = @_;</td></tr>
<tr><td class="h">2882</td><td colspan="7"></td></tr><tr><td class="h">2883</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2883">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$maxshow ||= 15;</td></tr>
<tr><td class="h">2884</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2884">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $max_fetch = int($LJ::TOOLS_RECENT_COMMENTS_MAX*1.5) || 150;</td></tr>
<tr><td class="h">2885</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# We fetch more items because some may be screened</td></tr>
<tr><td class="h">2886</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# or from suspended users, and we weed those out later</td></tr>
<tr><td class="h">2887</td><td colspan="7"></td></tr><tr><td class="h">2888</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2888">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote   = $opts{remote} || LJ::get_remote();</td></tr>
<tr><td class="h">2889</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2889">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::isu($u);</td></tr>
<tr><td class="h">2890</td><td colspan="7"></td></tr><tr><td class="h">2891</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## $raw_talkitems - contains DB rows that are not filtered</td></tr>
<tr><td class="h">2892</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## to match remote user&#39;s permissions to see</td></tr>
<tr><td class="h">2893</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $raw_talkitems;</td></tr>
<tr><td class="h">2894</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;userid, &#39;rcntalk:&#39; . $u-&gt;userid ];</td></tr>
<tr><td class="h">2895</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$raw_talkitems = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">2896</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2896">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$raw_talkitems) {</td></tr>
<tr><td class="h">2897</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $u-&gt;prepare(</td></tr>
<tr><td class="h">2898</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SELECT jtalkid, nodetype, nodeid, parenttalkid, &quot;.</td></tr>
<tr><td class="h">2899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;       posterid, UNIX_TIMESTAMP(datepost) as &#39;datepostunix&#39;, state &quot;.</td></tr>
<tr><td class="h">2900</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM talk2 &quot;.</td></tr>
<tr><td class="h">2901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=? AND state &lt;&gt; &#39;D&#39; &quot; .</td></tr>
<tr><td class="h">2902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ORDER BY jtalkid DESC &quot;.</td></tr>
<tr><td class="h">2903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;LIMIT $max_fetch&quot;</td></tr>
<tr><td class="h">2904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">2905</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute( $u-&gt;userid );</td></tr>
<tr><td class="h">2906</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$raw_talkitems = $sth-&gt;fetchall_arrayref({});</td></tr>
<tr><td class="h">2907</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $raw_talkitems, 60*5);</td></tr>
<tr><td class="h">2908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2909</td><td colspan="7"></td></tr><tr><td class="h">2910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## Check remote&#39;s permission to see the comment, and create singletons</td></tr>
<tr><td class="h">2911</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @recv;</td></tr>
<tr><td class="h">2912</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $r (@$raw_talkitems) {</td></tr>
<tr><td class="h">2913</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2913">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if @recv &gt;= $maxshow;</td></tr>
<tr><td class="h">2914</td><td colspan="7"></td></tr><tr><td class="h">2915</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# construct an LJ::Comment singleton</td></tr>
<tr><td class="h">2916</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $comment = LJ::Comment-&gt;new($u, jtalkid =&gt; $r-&gt;{jtalkid});</td></tr>
<tr><td class="h">2917</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comment-&gt;absorb_row(%$r);</td></tr>
<tr><td class="h">2918</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2918">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $comment-&gt;visible_to($remote);</td></tr>
<tr><td class="h">2919</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @recv, $r;</td></tr>
<tr><td class="h">2920</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2921</td><td colspan="7"></td></tr><tr><td class="h">2922</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# need to put the comments in order, with &quot;oldest first&quot;</td></tr>
<tr><td class="h">2923</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# they are fetched from DB in &quot;recent first&quot; order</td></tr>
<tr><td class="h">2924</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return reverse @recv;</td></tr>
<tr><td class="h">2925</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2926</td><td colspan="7"></td></tr><tr><td class="h">2927</td><td colspan="7"></td></tr><tr><td class="h">2928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return the number of comments a user has posted</td></tr>
<tr><td class="h">2929</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub num_comments_posted {</td></tr>
<tr><td class="h">2930</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2930">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2931</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %opts = @_;</td></tr>
<tr><td class="h">2932</td><td colspan="7"></td></tr><tr><td class="h">2933</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2933">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = $opts{dbh} || LJ::get_cluster_reader($u);</td></tr>
<tr><td class="h">2934</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;id;</td></tr>
<tr><td class="h">2935</td><td colspan="7"></td></tr><tr><td class="h">2936</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$userid, &quot;talkleftct:$userid&quot;];</td></tr>
<tr><td class="h">2937</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">2938</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2938">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($count) {</td></tr>
<tr><td class="h">2939</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $expire = time() + 3600*24*2; # 2 days;</td></tr>
<tr><td class="h">2940</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$count = $dbcr-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM talkleft &quot; .</td></tr>
<tr><td class="h">2941</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid=?&quot;, undef, $userid);</td></tr>
<tr><td class="h">2942</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2942">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $count, $expire) if defined $count;</td></tr>
<tr><td class="h">2943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2944</td><td colspan="7"></td></tr><tr><td class="h">2945</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $count;</td></tr>
<tr><td class="h">2946</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2947</td><td colspan="7"></td></tr><tr><td class="h">2948</td><td colspan="7"></td></tr><tr><td class="h">2949</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return the number of comments a user has received</td></tr>
<tr><td class="h">2950</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub num_comments_received {</td></tr>
<tr><td class="h">2951</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2951">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2952</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %opts = @_;</td></tr>
<tr><td class="h">2953</td><td colspan="7"></td></tr><tr><td class="h">2954</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L2954">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = $opts{dbh} || LJ::get_cluster_reader($u);</td></tr>
<tr><td class="h">2955</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;id;</td></tr>
<tr><td class="h">2956</td><td colspan="7"></td></tr><tr><td class="h">2957</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$userid, &quot;talk2ct:$userid&quot;];</td></tr>
<tr><td class="h">2958</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">2959</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2959">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($count) {</td></tr>
<tr><td class="h">2960</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $expire = time() + 3600*24*2; # 2 days;</td></tr>
<tr><td class="h">2961</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$count = $dbcr-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM talk2 &quot;.</td></tr>
<tr><td class="h">2962</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=?&quot;, undef, $userid);</td></tr>
<tr><td class="h">2963</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2963">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $count, $expire) if defined $count;</td></tr>
<tr><td class="h">2964</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">2965</td><td colspan="7"></td></tr><tr><td class="h">2966</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $count;</td></tr>
<tr><td class="h">2967</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2968</td><td colspan="7"></td></tr><tr><td class="h">2969</td><td colspan="7"></td></tr><tr><td class="h">2970</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">2971</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 13. Community-Related Functions and Authas</td></tr>
<tr><td class="h">2972</td><td colspan="7"></td></tr><tr><td class="h">2973</td><td colspan="7"></td></tr><tr><td class="h">2974</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_manage {</td></tr>
<tr><td class="h">2975</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2975">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::can_manage( @_ );</td></tr>
<tr><td class="h">2976</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2977</td><td colspan="7"></td></tr><tr><td class="h">2978</td><td colspan="7"></td></tr><tr><td class="h">2979</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># can $u post to $targetu?</td></tr>
<tr><td class="h">2980</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_post_to {</td></tr>
<tr><td class="h">2981</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2981">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $targetu) = @_;</td></tr>
<tr><td class="h">2982</td><td colspan="7"></td></tr><tr><td class="h">2983</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::can_use_journal($u-&gt;id, $targetu-&gt;user);</td></tr>
<tr><td class="h">2984</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2985</td><td colspan="7"></td></tr><tr><td class="h">2986</td><td colspan="7"></td></tr><tr><td class="h">2987</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_closed_membership {</td></tr>
<tr><td class="h">2988</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2988">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2989</td><td colspan="7"></td></tr><tr><td class="h">2990</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2990">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;membership_level eq &#39;closed&#39; ? 1 : 0;</td></tr>
<tr><td class="h">2991</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2992</td><td colspan="7"></td></tr><tr><td class="h">2993</td><td colspan="7"></td></tr><tr><td class="h">2994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_moderated_membership {</td></tr>
<tr><td class="h">2995</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L2995">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">2996</td><td colspan="7"></td></tr><tr><td class="h">2997</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L2997">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;membership_level eq &#39;moderated&#39; ? 1 : 0;</td></tr>
<tr><td class="h">2998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">2999</td><td colspan="7"></td></tr><tr><td class="h">3000</td><td colspan="7"></td></tr><tr><td class="h">3001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_open_membership {</td></tr>
<tr><td class="h">3002</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3002">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3003</td><td colspan="7"></td></tr><tr><td class="h">3004</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3004">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;membership_level eq &#39;open&#39; ? 1 : 0;</td></tr>
<tr><td class="h">3005</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3006</td><td colspan="7"></td></tr><tr><td class="h">3007</td><td colspan="7"></td></tr><tr><td class="h">3008</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns an array of maintainer userids</td></tr>
<tr><td class="h">3009</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub maintainer_userids {</td></tr>
<tr><td class="h">3010</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3010">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3011</td><td colspan="7"></td></tr><tr><td class="h">3012</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3012">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () unless $u-&gt;is_community;</td></tr>
<tr><td class="h">3013</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @{LJ::load_rel_user_cache( $u-&gt;id, &#39;A&#39; )};</td></tr>
<tr><td class="h">3014</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3015</td><td colspan="7"></td></tr><tr><td class="h">3016</td><td colspan="7"></td></tr><tr><td class="h">3017</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the membership level of a community</td></tr>
<tr><td class="h">3018</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub membership_level {</td></tr>
<tr><td class="h">3019</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3019">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3020</td><td colspan="7"></td></tr><tr><td class="h">3021</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3021">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u-&gt;is_community;</td></tr>
<tr><td class="h">3022</td><td colspan="7"></td></tr><tr><td class="h">3023</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $membership_level, $post_level ) = LJ::get_comm_settings( $u );</td></tr>
<tr><td class="h">3024</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3024">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $membership_level || undef;</td></tr>
<tr><td class="h">3025</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3026</td><td colspan="7"></td></tr><tr><td class="h">3027</td><td colspan="7"></td></tr><tr><td class="h">3028</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns an array of moderator userids</td></tr>
<tr><td class="h">3029</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub moderator_userids {</td></tr>
<tr><td class="h">3030</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3030">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3031</td><td colspan="7"></td></tr><tr><td class="h">3032</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3032">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3032">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () unless $u-&gt;is_community &amp;&amp; $u-&gt;prop( &#39;moderated&#39; );</td></tr>
<tr><td class="h">3033</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @{LJ::load_rel_user_cache( $u-&gt;id, &#39;M&#39; )};</td></tr>
<tr><td class="h">3034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3035</td><td colspan="7"></td></tr><tr><td class="h">3036</td><td colspan="7"></td></tr><tr><td class="h">3037</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># What journals can this user post to?</td></tr>
<tr><td class="h">3038</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub posting_access_list {</td></tr>
<tr><td class="h">3039</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3039">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3040</td><td colspan="7"></td></tr><tr><td class="h">3041</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @res;</td></tr>
<tr><td class="h">3042</td><td colspan="7"></td></tr><tr><td class="h">3043</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ids = LJ::load_rel_target($u, &#39;P&#39;);</td></tr>
<tr><td class="h">3044</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $us = LJ::load_userids(@$ids);</td></tr>
<tr><td class="h">3045</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (values %$us) {</td></tr>
<tr><td class="h">3046</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3046">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $_-&gt;is_visible;</td></tr>
<tr><td class="h">3047</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @res, $_;</td></tr>
<tr><td class="h">3048</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3049</td><td colspan="7"></td></tr><tr><td class="h">3050</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return sort { $a-&gt;{user} cmp $b-&gt;{user} } @res;</td></tr>
<tr><td class="h">3051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3052</td><td colspan="7"></td></tr><tr><td class="h">3053</td><td colspan="7"></td></tr><tr><td class="h">3054</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># gets the relevant communities that the user is a member of</td></tr>
<tr><td class="h">3055</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># used to suggest communities to a person who know the user</td></tr>
<tr><td class="h">3056</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub relevant_communities {</td></tr>
<tr><td class="h">3057</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3057">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3058</td><td colspan="7"></td></tr><tr><td class="h">3059</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %comms;</td></tr>
<tr><td class="h">3060</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @ids = $u-&gt;member_of_userids;</td></tr>
<tr><td class="h">3061</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memberships = LJ::load_userids( @ids );</td></tr>
<tr><td class="h">3062</td><td colspan="7"></td></tr><tr><td class="h">3063</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get all communities that $u is a member of that aren&#39;t closed membership</td></tr>
<tr><td class="h">3064</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $membershipid ( keys %$memberships ) {</td></tr>
<tr><td class="h">3065</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $membershipu = $memberships-&gt;{$membershipid};</td></tr>
<tr><td class="h">3066</td><td colspan="7"></td></tr><tr><td class="h">3067</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3067">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $membershipu-&gt;is_community;</td></tr>
<tr><td class="h">3068</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3068">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $membershipu-&gt;is_visible;</td></tr>
<tr><td class="h">3069</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3069">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $membershipu-&gt;is_closed_membership;</td></tr>
<tr><td class="h">3070</td><td colspan="7"></td></tr><tr><td class="h">3071</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comms{$membershipid}-&gt;{u} = $membershipu;</td></tr>
<tr><td class="h">3072</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comms{$membershipid}-&gt;{istatus} = &#39;normal&#39;;</td></tr>
<tr><td class="h">3073</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3074</td><td colspan="7"></td></tr><tr><td class="h">3075</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get usage information about comms</td></tr>
<tr><td class="h">3076</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3076">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( scalar keys %comms ) {</td></tr>
<tr><td class="h">3077</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $comms_times = LJ::get_times_multi( keys %comms );</td></tr>
<tr><td class="h">3078</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $commid ( keys %comms ) {</td></tr>
<tr><td class="h">3079</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3079">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3079">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $comms_times-&gt;{created} &amp;&amp; defined $comms_times-&gt;{created}-&gt;{$commid} ) {</td></tr>
<tr><td class="h">3080</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comms{$commid}-&gt;{created} = $comms_times-&gt;{created}-&gt;{$commid};</td></tr>
<tr><td class="h">3081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3082</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3082">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3082">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $comms_times-&gt;{updated} &amp;&amp; defined $comms_times-&gt;{updated}-&gt;{$commid} ) {</td></tr>
<tr><td class="h">3083</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comms{$commid}-&gt;{updated} = $comms_times-&gt;{updated}-&gt;{$commid};</td></tr>
<tr><td class="h">3084</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3085</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3086</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3087</td><td colspan="7"></td></tr><tr><td class="h">3088</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# prune the list of communities</td></tr>
<tr><td class="h">3089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#</td></tr>
<tr><td class="h">3090</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# keep a community in the list if:</td></tr>
<tr><td class="h">3091</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# * it was created in the past 10 days OR</td></tr>
<tr><td class="h">3092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# * $u is a maint or mod of it OR</td></tr>
<tr><td class="h">3093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# * it was updated in the past 30 days</td></tr>
<tr><td class="h">3094</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $over30 = 0;</td></tr>
<tr><td class="h">3095</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now = time();</td></tr>
<tr><td class="h">3096</td><td colspan="7"></td></tr><tr><td class="h">3097</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;COMMUNITY:</td></tr>
<tr><td class="h">3098</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $commid ( sort { $comms{$b}-&gt;{updated} &lt;=&gt; $comms{$a}-&gt;{updated} } keys %comms ) {</td></tr>
<tr><td class="h">3099</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $commu = $comms{$commid}-&gt;{u};</td></tr>
<tr><td class="h">3100</td><td colspan="7"></td></tr><tr><td class="h">3101</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3101">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $now - $comms{$commid}-&gt;{created} &lt;= 60*60*24*10 ) { # 10 days</td></tr>
<tr><td class="h">3102</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comms{$commid}-&gt;{istatus} = &#39;new&#39;;</td></tr>
<tr><td class="h">3103</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next COMMUNITY;</td></tr>
<tr><td class="h">3104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3105</td><td colspan="7"></td></tr><tr><td class="h">3106</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @maintainers = $commu-&gt;maintainer_userids;</td></tr>
<tr><td class="h">3107</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @moderators  = $commu-&gt;moderator_userids;</td></tr>
<tr><td class="h">3108</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $mid ( @maintainers, @moderators ) {</td></tr>
<tr><td class="h">3109</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3109">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $mid == $u-&gt;id ) {</td></tr>
<tr><td class="h">3110</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$comms{$commid}-&gt;{istatus} = &#39;mm&#39;;</td></tr>
<tr><td class="h">3111</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next COMMUNITY;</td></tr>
<tr><td class="h">3112</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3114</td><td colspan="7"></td></tr><tr><td class="h">3115</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3115">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $over30 ) {</td></tr>
<tr><td class="h">3116</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $comms{$commid};</td></tr>
<tr><td class="h">3117</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next COMMUNITY;</td></tr>
<tr><td class="h">3118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3119</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3119">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $now - $comms{$commid}-&gt;{updated} &gt; 60*60*24*30 ) { # 30 days</td></tr>
<tr><td class="h">3120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $comms{$commid};</td></tr>
<tr><td class="h">3121</td><td colspan="7"></td></tr><tr><td class="h">3122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# since we&#39;re going through the communities in timeupdate order,</td></tr>
<tr><td class="h">3123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we know every community in %comms after this one was updated</td></tr>
<tr><td class="h">3124</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# more than 30 days ago</td></tr>
<tr><td class="h">3125</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$over30 = 1;</td></tr>
<tr><td class="h">3126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3129</td><td colspan="7"></td></tr><tr><td class="h">3130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we still have more than 20 comms, delete any with fewer than five members</td></tr>
<tr><td class="h">3131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# as long as it&#39;s not new and $u isn&#39;t a maint/mod</td></tr>
<tr><td class="h">3132</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3132">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( scalar keys %comms &gt; 20 ) {</td></tr>
<tr><td class="h">3133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $commid ( keys %comms ) {</td></tr>
<tr><td class="h">3134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $commu = $comms{$commid}-&gt;{u};</td></tr>
<tr><td class="h">3135</td><td colspan="7"></td></tr><tr><td class="h">3136</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3136">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $comms{$commid}-&gt;{istatus} eq &#39;normal&#39;;</td></tr>
<tr><td class="h">3137</td><td colspan="7"></td></tr><tr><td class="h">3138</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @ids = $commu-&gt;member_userids;</td></tr>
<tr><td class="h">3139</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3139">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( scalar @ids &lt; 5 ) {</td></tr>
<tr><td class="h">3140</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $comms{$commid};</td></tr>
<tr><td class="h">3141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3142</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3143</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3144</td><td colspan="7"></td></tr><tr><td class="h">3145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return %comms;</td></tr>
<tr><td class="h">3146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3147</td><td colspan="7"></td></tr><tr><td class="h">3148</td><td colspan="7"></td></tr><tr><td class="h">3149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub trusts_or_has_member {</td></tr>
<tr><td class="h">3150</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3150">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $target_u ) = @_;</td></tr>
<tr><td class="h">3151</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3151">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$target_u = LJ::want_user( $target_u ) or return 0;</td></tr>
<tr><td class="h">3152</td><td colspan="7"></td></tr><tr><td class="h">3153</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3153">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3153">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $target_u-&gt;member_of( $u ) ? 1 : 0</td></tr>
<tr><td class="h">3154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $u-&gt;is_community;</td></tr>
<tr><td class="h">3155</td><td colspan="7"></td></tr><tr><td class="h">3156</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3156">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;trusts( $target_u ) ? 1 : 0;</td></tr>
<tr><td class="h">3157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3158</td><td colspan="7"></td></tr><tr><td class="h">3159</td><td colspan="7"></td></tr><tr><td class="h">3160</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">3161</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 14. Adult Content Functions</td></tr>
<tr><td class="h">3162</td><td colspan="7"></td></tr><tr><td class="h">3163</td><td colspan="7"></td></tr><tr><td class="h">3164</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># defined by the user</td></tr>
<tr><td class="h">3165</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns &#39;none&#39;, &#39;concepts&#39; or &#39;explicit&#39;</td></tr>
<tr><td class="h">3166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content {</td></tr>
<tr><td class="h">3167</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3167">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3168</td><td colspan="7"></td></tr><tr><td class="h">3169</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop_value = $u-&gt;prop(&#39;adult_content&#39;);</td></tr>
<tr><td class="h">3170</td><td colspan="7"></td></tr><tr><td class="h">3171</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3171">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $prop_value ? $prop_value : &quot;none&quot;;</td></tr>
<tr><td class="h">3172</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3173</td><td colspan="7"></td></tr><tr><td class="h">3174</td><td colspan="7"></td></tr><tr><td class="h">3175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># uses user-defined prop to figure out the adult content level</td></tr>
<tr><td class="h">3176</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content_calculated {</td></tr>
<tr><td class="h">3177</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3177">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3178</td><td colspan="7"></td></tr><tr><td class="h">3179</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;adult_content;</td></tr>
<tr><td class="h">3180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3181</td><td colspan="7"></td></tr><tr><td class="h">3182</td><td colspan="7"></td></tr><tr><td class="h">3183</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns who marked the entry as the &#39;adult_content_calculated&#39; adult content level</td></tr>
<tr><td class="h">3184</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content_marker {</td></tr>
<tr><td class="h">3185</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3185">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3186</td><td colspan="7"></td></tr><tr><td class="h">3187</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;journal&quot;;</td></tr>
<tr><td class="h">3188</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3189</td><td colspan="7"></td></tr><tr><td class="h">3190</td><td colspan="7"></td></tr><tr><td class="h">3191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># defuned by the user</td></tr>
<tr><td class="h">3192</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub adult_content_reason {</td></tr>
<tr><td class="h">3193</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3193">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3194</td><td colspan="7"></td></tr><tr><td class="h">3195</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;prop(&#39;adult_content_reason&#39;);</td></tr>
<tr><td class="h">3196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3197</td><td colspan="7"></td></tr><tr><td class="h">3198</td><td colspan="7"></td></tr><tr><td class="h">3199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub hide_adult_content {</td></tr>
<tr><td class="h">3200</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3200">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3201</td><td colspan="7"></td></tr><tr><td class="h">3202</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop_value = $u-&gt;prop(&#39;hide_adult_content&#39;);</td></tr>
<tr><td class="h">3203</td><td colspan="7"></td></tr><tr><td class="h">3204</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3204">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (!$u-&gt;best_guess_age) {</td></tr>
<tr><td class="h">3205</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;concepts&quot;;</td></tr>
<tr><td class="h">3206</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3207</td><td colspan="7"></td></tr><tr><td class="h">3208</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3208">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3208">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_minor &amp;&amp; $prop_value ne &quot;concepts&quot;) {</td></tr>
<tr><td class="h">3209</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;explicit&quot;;</td></tr>
<tr><td class="h">3210</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3211</td><td colspan="7"></td></tr><tr><td class="h">3212</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3212">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $prop_value ? $prop_value : &quot;none&quot;;</td></tr>
<tr><td class="h">3213</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3214</td><td colspan="7"></td></tr><tr><td class="h">3215</td><td colspan="7"></td></tr><tr><td class="h">3216</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a number that represents the user&#39;s chosen search filtering level</td></tr>
<tr><td class="h">3217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># 0 = no filtering</td></tr>
<tr><td class="h">3218</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># 1-10 = moderate filtering</td></tr>
<tr><td class="h">3219</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &gt;10 = strict filtering</td></tr>
<tr><td class="h">3220</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub safe_search {</td></tr>
<tr><td class="h">3221</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3221">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3222</td><td colspan="7"></td></tr><tr><td class="h">3223</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop_value = $u-&gt;prop(&#39;safe_search&#39;);</td></tr>
<tr><td class="h">3224</td><td colspan="7"></td></tr><tr><td class="h">3225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# current user 18+ default is 0</td></tr>
<tr><td class="h">3226</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# current user &lt;18 default is 10</td></tr>
<tr><td class="h">3227</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# new user default (prop value is &quot;nu_default&quot;) is 10</td></tr>
<tr><td class="h">3228</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3228">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $prop_value eq &quot;none&quot;;</td></tr>
<tr><td class="h">3229</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3229">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3229">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $prop_value if $prop_value &amp;&amp; $prop_value =~ /^\d+$/;</td></tr>
<tr><td class="h">3230</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3230">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3230">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $prop_value ne &quot;nu_default&quot; &amp;&amp; $u-&gt;best_guess_age &amp;&amp; !$u-&gt;is_minor;</td></tr>
<tr><td class="h">3231</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 10;</td></tr>
<tr><td class="h">3232</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3233</td><td colspan="7"></td></tr><tr><td class="h">3234</td><td colspan="7"></td></tr><tr><td class="h">3235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># determine if the user in &quot;for_u&quot; should see $u in a search result</td></tr>
<tr><td class="h">3236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub should_show_in_search_results {</td></tr>
<tr><td class="h">3237</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3237">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3238</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %opts = @_;</td></tr>
<tr><td class="h">3239</td><td colspan="7"></td></tr><tr><td class="h">3240</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3240">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3240">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless LJ::is_enabled( &#39;adult_content&#39; ) &amp;&amp; LJ::is_enabled( &#39;safe_search&#39; );</td></tr>
<tr><td class="h">3241</td><td colspan="7"></td></tr><tr><td class="h">3242</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $adult_content = $u-&gt;adult_content_calculated;</td></tr>
<tr><td class="h">3243</td><td colspan="7"></td></tr><tr><td class="h">3244</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $for_u = $opts{for};</td></tr>
<tr><td class="h">3245</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3245">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (LJ::isu($for_u)) {</td></tr>
<tr><td class="h">3246</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3246">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $adult_content eq &quot;none&quot; ? 1 : 0;</td></tr>
<tr><td class="h">3247</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3248</td><td colspan="7"></td></tr><tr><td class="h">3249</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $safe_search = $for_u-&gt;safe_search;</td></tr>
<tr><td class="h">3250</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3250">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $safe_search == 0;</td></tr>
<tr><td class="h">3251</td><td colspan="7"></td></tr><tr><td class="h">3252</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3252">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $adult_content_flag_level = $LJ::CONTENT_FLAGS{$adult_content} ? $LJ::CONTENT_FLAGS{$adult_content}-&gt;{safe_search_level} : 0;</td></tr>
<tr><td class="h">3253</td><td colspan="7"></td></tr><tr><td class="h">3254</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3254">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3254">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $adult_content_flag_level &amp;&amp; ($safe_search &gt;= $adult_content_flag_level);</td></tr>
<tr><td class="h">3255</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3256</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3257</td><td colspan="7"></td></tr><tr><td class="h">3258</td><td colspan="7"></td></tr><tr><td class="h">3259</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">3260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  15. Email-Related Functions</td></tr>
<tr><td class="h">3261</td><td colspan="7"></td></tr><tr><td class="h">3262</td><td colspan="7"></td></tr><tr><td class="h">3263</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_email_alias {</td></tr>
<tr><td class="h">3264</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3264">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3265</td><td colspan="7"></td></tr><tr><td class="h">3266</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3266">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if exists $LJ::FIXED_ALIAS{$u-&gt;user};</td></tr>
<tr><td class="h">3267</td><td colspan="7"></td></tr><tr><td class="h">3268</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">3269</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do( &quot;DELETE FROM email_aliases WHERE alias=?&quot;,</td></tr>
<tr><td class="h">3270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;user . &quot;\@$LJ::USER_DOMAIN&quot; );</td></tr>
<tr><td class="h">3271</td><td colspan="7"></td></tr><tr><td class="h">3272</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3272">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">3273</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3274</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3275</td><td colspan="7"></td></tr><tr><td class="h">3276</td><td colspan="7"></td></tr><tr><td class="h">3277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub email_for_feeds {</td></tr>
<tr><td class="h">3278</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3278">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3279</td><td colspan="7"></td></tr><tr><td class="h">3280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t display if it&#39;s mangled</td></tr>
<tr><td class="h">3281</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3281">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $u-&gt;prop(&quot;opt_mangleemail&quot;) eq &quot;Y&quot;;</td></tr>
<tr><td class="h">3282</td><td colspan="7"></td></tr><tr><td class="h">3283</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">3284</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;email_visible($remote);</td></tr>
<tr><td class="h">3285</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3286</td><td colspan="7"></td></tr><tr><td class="h">3287</td><td colspan="7"></td></tr><tr><td class="h">3288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub email_raw {</td></tr>
<tr><td class="h">3289</td><td><div class="c3">221</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3289">221</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3290</td><td><div class="c3">221</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">3291</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_email} ||= LJ::MemCache::get_or_set( [$userid, &quot;email:$userid&quot;], sub {</td></tr>
<tr><td class="h">3292</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L3292">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3292">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer() or die &quot;Couldn&#39;t get db master&quot;;</td></tr>
<tr><td class="h">3293</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $dbh-&gt;selectrow_array( &quot;SELECT email FROM email WHERE userid=?&quot;,</td></tr>
<tr><td class="h">3294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid );</td></tr>
<tr><td class="h">3295</td><td><div class="c3">221</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3295">67</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} );</td></tr>
<tr><td class="h">3296</td><td><div class="c3">221</div></td><td></td><td></td><td></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_email};</td></tr>
<tr><td class="h">3297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3298</td><td colspan="7"></td></tr><tr><td class="h">3299</td><td colspan="7"></td></tr><tr><td class="h">3300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub email_status {</td></tr>
<tr><td class="h">3301</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3301">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3302</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{status};</td></tr>
<tr><td class="h">3303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3304</td><td colspan="7"></td></tr><tr><td class="h">3305</td><td colspan="7"></td></tr><tr><td class="h">3306</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># in scalar context, returns user&#39;s email address.  given a remote user,</td></tr>
<tr><td class="h">3307</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># bases decision based on whether $remote user can see it.  in list context,</td></tr>
<tr><td class="h">3308</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns all emails that can be shown</td></tr>
<tr><td class="h">3309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub email_visible {</td></tr>
<tr><td class="h">3310</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3310">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $remote) = @_;</td></tr>
<tr><td class="h">3311</td><td colspan="7"></td></tr><tr><td class="h">3312</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return scalar $u-&gt;emails_visible($remote);</td></tr>
<tr><td class="h">3313</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3314</td><td colspan="7"></td></tr><tr><td class="h">3315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns an array of emails based on the user&#39;s display prefs</td></tr>
<tr><td class="h">3316</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># A: actual email address</td></tr>
<tr><td class="h">3317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># D: display email address</td></tr>
<tr><td class="h">3318</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># L: local email address</td></tr>
<tr><td class="h">3319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># B: both actual + local email address</td></tr>
<tr><td class="h">3320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># V: both display + local email address</td></tr>
<tr><td class="h">3321</td><td colspan="7"></td></tr><tr><td class="h">3322</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub emails_visible {</td></tr>
<tr><td class="h">3323</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3323">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $remote) = @_;</td></tr>
<tr><td class="h">3324</td><td colspan="7"></td></tr><tr><td class="h">3325</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3325">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3325">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () if $u-&gt;is_identity || $u-&gt;is_syndicated;</td></tr>
<tr><td class="h">3326</td><td colspan="7"></td></tr><tr><td class="h">3327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# security controls</td></tr>
<tr><td class="h">3328</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3328">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () unless $u-&gt;share_contactinfo($remote);</td></tr>
<tr><td class="h">3329</td><td colspan="7"></td></tr><tr><td class="h">3330</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $whatemail = $u-&gt;opt_whatemailshow;</td></tr>
<tr><td class="h">3331</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $useremail_cap = LJ::get_cap($u, &#39;useremail&#39;);</td></tr>
<tr><td class="h">3332</td><td colspan="7"></td></tr><tr><td class="h">3333</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# some classes of users we want to have their contact info hidden</td></tr>
<tr><td class="h">3334</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# after so much time of activity, to prevent people from bugging</td></tr>
<tr><td class="h">3335</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# them for their account or trying to brute force it.</td></tr>
<tr><td class="h">3336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $hide_contactinfo = sub {</td></tr>
<tr><td class="h">3337</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3337">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $hide_after = LJ::get_cap($u, &quot;hide_email_after&quot;);</td></tr>
<tr><td class="h">3338</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3338">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $hide_after;</td></tr>
<tr><td class="h">3339</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $active = $u-&gt;get_timeactive;</td></tr>
<tr><td class="h">3340</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3340">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $active &amp;&amp; (time() - $active) &gt; $hide_after * 86400;</td></tr>
<tr><td class="h">3341</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">3342</td><td colspan="7"></td></tr><tr><td class="h">3343</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3343">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3343">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return () if $whatemail eq &quot;N&quot; ||</td></tr>
<tr><td class="h">3344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whatemail eq &quot;L&quot; &amp;&amp; ($u-&gt;prop(&quot;no_mail_alias&quot;) || ! $useremail_cap || ! $LJ::USER_EMAIL) ||</td></tr>
<tr><td class="h">3345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hide_contactinfo-&gt;();</td></tr>
<tr><td class="h">3346</td><td colspan="7"></td></tr><tr><td class="h">3347</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @emails = ();</td></tr>
<tr><td class="h">3348</td><td colspan="7"></td></tr><tr><td class="h">3349</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3349">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3349">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3349">0</a></div><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3349">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;prop( &#39;opt_whatemailshow&#39; ) eq &quot;A&quot; || $u-&gt;prop( &#39;opt_whatemailshow&#39; ) eq &quot;B&quot; ) {</td></tr>
<tr><td class="h">3350</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @emails, $u-&gt;email_raw;</td></tr>
<tr><td class="h">3351</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( $u-&gt;prop( &#39;opt_whatemailshow&#39; ) eq &quot;D&quot; || $u-&gt;prop( &#39;opt_whatemailshow&#39; ) eq &quot;V&quot; ) {</td></tr>
<tr><td class="h">3352</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @emails, $u-&gt;prop( &#39;opt_profileemail&#39; );</td></tr>
<tr><td class="h">3353</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} </td></tr>
<tr><td class="h">3354</td><td colspan="7"></td></tr><tr><td class="h">3355</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3355">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3355">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::USER_EMAIL &amp;&amp; $useremail_cap) {</td></tr>
<tr><td class="h">3356</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3356">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3356">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($whatemail eq &quot;B&quot; || $whatemail eq &quot;V&quot; || $whatemail eq &quot;L&quot;) {</td></tr>
<tr><td class="h">3357</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3357">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @emails, $u-&gt;user . &quot;\@$LJ::USER_DOMAIN&quot; unless $u-&gt;prop(&#39;no_mail_alias&#39;);</td></tr>
<tr><td class="h">3358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3360</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3360">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return wantarray ? @emails : $emails[0];</td></tr>
<tr><td class="h">3361</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3362</td><td colspan="7"></td></tr><tr><td class="h">3363</td><td colspan="7"></td></tr><tr><td class="h">3364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_validated {</td></tr>
<tr><td class="h">3365</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3365">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3366</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;email_status eq &quot;A&quot;;</td></tr>
<tr><td class="h">3367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3368</td><td colspan="7"></td></tr><tr><td class="h">3369</td><td colspan="7"></td></tr><tr><td class="h">3370</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return user selected mail encoding or undef</td></tr>
<tr><td class="h">3371</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mailencoding {</td></tr>
<tr><td class="h">3372</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3372">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3373</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $enc = $u-&gt;prop(&#39;mailencoding&#39;);</td></tr>
<tr><td class="h">3374</td><td colspan="7"></td></tr><tr><td class="h">3375</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3375">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $enc;</td></tr>
<tr><td class="h">3376</td><td colspan="7"></td></tr><tr><td class="h">3377</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3377">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_codes({ &quot;encoding&quot; =&gt; \%LJ::CACHE_ENCODINGS } )</td></tr>
<tr><td class="h">3378</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless %LJ::CACHE_ENCODINGS;</td></tr>
<tr><td class="h">3379</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::CACHE_ENCODINGS{$enc}</td></tr>
<tr><td class="h">3380</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3381</td><td colspan="7"></td></tr><tr><td class="h">3382</td><td colspan="7"></td></tr><tr><td class="h">3383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return the setting indicating how a user can be found by their email address</td></tr>
<tr><td class="h">3384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Y - Findable, N - Not findable, H - Findable but identity hidden</td></tr>
<tr><td class="h">3385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_findbyemail {</td></tr>
<tr><td class="h">3386</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3386">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3387</td><td colspan="7"></td></tr><tr><td class="h">3388</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3388">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;raw_prop(&#39;opt_findbyemail&#39;) =~ /^(N|Y|H)$/) {</td></tr>
<tr><td class="h">3389</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;raw_prop(&#39;opt_findbyemail&#39;);</td></tr>
<tr><td class="h">3390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3391</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">3392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3393</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3394</td><td colspan="7"></td></tr><tr><td class="h">3395</td><td colspan="7"></td></tr><tr><td class="h">3396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_email {</td></tr>
<tr><td class="h">3397</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3397">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $email) = @_;</td></tr>
<tr><td class="h">3398</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::set_email($u-&gt;id, $email);</td></tr>
<tr><td class="h">3399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3400</td><td colspan="7"></td></tr><tr><td class="h">3401</td><td colspan="7"></td></tr><tr><td class="h">3402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub update_email_alias {</td></tr>
<tr><td class="h">3403</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3403">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3404</td><td colspan="7"></td></tr><tr><td class="h">3405</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3405">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3405">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $u &amp;&amp; $u-&gt;get_cap(&quot;useremail&quot;);</td></tr>
<tr><td class="h">3406</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3406">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if exists $LJ::FIXED_ALIAS{$u-&gt;user};</td></tr>
<tr><td class="h">3407</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3407">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $u-&gt;prop(&quot;no_mail_alias&quot;);</td></tr>
<tr><td class="h">3408</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3408">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $u-&gt;is_validated;</td></tr>
<tr><td class="h">3409</td><td colspan="7"></td></tr><tr><td class="h">3410</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">3411</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do( &quot;REPLACE INTO email_aliases (alias, rcpt) VALUES (?,?)&quot;,</td></tr>
<tr><td class="h">3412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;user . &quot;\@$LJ::USER_DOMAIN&quot;, $u-&gt;email_raw );</td></tr>
<tr><td class="h">3413</td><td colspan="7"></td></tr><tr><td class="h">3414</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3414">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">3415</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3417</td><td colspan="7"></td></tr><tr><td class="h">3418</td><td colspan="7"></td></tr><tr><td class="h">3419</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub validated_mbox_sha1sum {</td></tr>
<tr><td class="h">3420</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3420">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3421</td><td colspan="7"></td></tr><tr><td class="h">3422</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# must be validated</td></tr>
<tr><td class="h">3423</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3423">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u-&gt;is_validated;</td></tr>
<tr><td class="h">3424</td><td colspan="7"></td></tr><tr><td class="h">3425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# must have one on file</td></tr>
<tr><td class="h">3426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $email = $u-&gt;email_raw;</td></tr>
<tr><td class="h">3427</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3427">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $email;</td></tr>
<tr><td class="h">3428</td><td colspan="7"></td></tr><tr><td class="h">3429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return SHA1, which does not disclose the actual value</td></tr>
<tr><td class="h">3430</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return Digest::SHA1::sha1_hex(&#39;mailto:&#39; . $email);</td></tr>
<tr><td class="h">3431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3432</td><td colspan="7"></td></tr><tr><td class="h">3433</td><td colspan="7"></td></tr><tr><td class="h">3434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">3435</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  16. Entry-Related Functions</td></tr>
<tr><td class="h">3436</td><td colspan="7"></td></tr><tr><td class="h">3437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># front-end to recent_entries, which forces the remote user to be</td></tr>
<tr><td class="h">3438</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># the owner, so we get everything.</td></tr>
<tr><td class="h">3439</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub all_recent_entries {</td></tr>
<tr><td class="h">3440</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3440">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, %opts ) = @_;</td></tr>
<tr><td class="h">3441</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts{filtered_for} = $u;</td></tr>
<tr><td class="h">3442</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;recent_entries(%opts);</td></tr>
<tr><td class="h">3443</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3444</td><td colspan="7"></td></tr><tr><td class="h">3445</td><td colspan="7"></td></tr><tr><td class="h">3446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub draft_text {</td></tr>
<tr><td class="h">3447</td><td><div class="c3">9</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3447">9</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u) = @_;</td></tr>
<tr><td class="h">3448</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;prop(&#39;entry_draft&#39;);</td></tr>
<tr><td class="h">3449</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3450</td><td colspan="7"></td></tr><tr><td class="h">3451</td><td colspan="7"></td></tr><tr><td class="h">3452</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">3453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_post_ids</td></tr>
<tr><td class="h">3454</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Given a user object and some options, return the number of posts or the</td></tr>
<tr><td class="h">3455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      posts&#39;&#39; IDs (jitemids) that match.</td></tr>
<tr><td class="h">3456</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: number of matching posts, &lt;strong&gt;or&lt;/strong&gt; IDs of</td></tr>
<tr><td class="h">3457</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          matching posts (default).</td></tr>
<tr><td class="h">3458</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, opts</td></tr>
<tr><td class="h">3459</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: &#39;security&#39; - [public|private|usemask]</td></tr>
<tr><td class="h">3460</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           &#39;allowmask&#39; - integer for friends-only or custom groups</td></tr>
<tr><td class="h">3461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           &#39;start_date&#39; - UTC date after which to look for match</td></tr>
<tr><td class="h">3462</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           &#39;end_date&#39; - UTC date before which to look for match</td></tr>
<tr><td class="h">3463</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           &#39;return&#39; - if &#39;count&#39; just return the count</td></tr>
<tr><td class="h">3464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           TODO: Add caching?</td></tr>
<tr><td class="h">3465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">3466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_post_ids {</td></tr>
<tr><td class="h">3467</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3467">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, %opts) = @_;</td></tr>
<tr><td class="h">3468</td><td colspan="7"></td></tr><tr><td class="h">3469</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $query = &#39;SELECT&#39;;</td></tr>
<tr><td class="h">3470</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @vals; # parameters to query</td></tr>
<tr><td class="h">3471</td><td colspan="7"></td></tr><tr><td class="h">3472</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3472">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3472">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts{&#39;start_date&#39;} || $opts{&#39;end_date&#39;}) {</td></tr>
<tr><td class="h">3473</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3473">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3473">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;start or end date not defined&quot;</td></tr>
<tr><td class="h">3474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!$opts{&#39;start_date&#39;} || !$opts{&#39;end_date&#39;});</td></tr>
<tr><td class="h">3475</td><td colspan="7"></td></tr><tr><td class="h">3476</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3476">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3476">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!($opts{&#39;start_date&#39;} &gt;= 0) || !($opts{&#39;end_date&#39;} &gt;= 0) ||</td></tr>
<tr><td class="h">3477</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!($opts{&#39;start_date&#39;} &lt;= $LJ::EndOfTime) ||</td></tr>
<tr><td class="h">3478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!($opts{&#39;end_date&#39;} &lt;= $LJ::EndOfTime) ) {</td></tr>
<tr><td class="h">3479</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">3480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3481</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3482</td><td colspan="7"></td></tr><tr><td class="h">3483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return count or jitemids</td></tr>
<tr><td class="h">3484</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3484">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts{&#39;return&#39;} eq &#39;count&#39;) {</td></tr>
<tr><td class="h">3485</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query .= &quot; COUNT(*)&quot;;</td></tr>
<tr><td class="h">3486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3487</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query .= &quot; jitemid&quot;;</td></tr>
<tr><td class="h">3488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3489</td><td colspan="7"></td></tr><tr><td class="h">3490</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# from the journal entries table for this user</td></tr>
<tr><td class="h">3491</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$query .= &quot; FROM log2 WHERE journalid=?&quot;;</td></tr>
<tr><td class="h">3492</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push( @vals, $u-&gt;userid );</td></tr>
<tr><td class="h">3493</td><td colspan="7"></td></tr><tr><td class="h">3494</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# filter by security</td></tr>
<tr><td class="h">3495</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3495">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts{&#39;security&#39;}) {</td></tr>
<tr><td class="h">3496</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query .= &quot; AND security=?&quot;;</td></tr>
<tr><td class="h">3497</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push(@vals, $opts{&#39;security&#39;});</td></tr>
<tr><td class="h">3498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# If friends-only or custom</td></tr>
<tr><td class="h">3499</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3499">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3499">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($opts{&#39;security&#39;} eq &#39;usemask&#39; &amp;&amp; $opts{&#39;allowmask&#39;}) {</td></tr>
<tr><td class="h">3500</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query .= &quot; AND allowmask=?&quot;;</td></tr>
<tr><td class="h">3501</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push(@vals, $opts{&#39;allowmask&#39;});</td></tr>
<tr><td class="h">3502</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3503</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3504</td><td colspan="7"></td></tr><tr><td class="h">3505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# filter by date, use revttime as it is indexed</td></tr>
<tr><td class="h">3506</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3506">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3506">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts{&#39;start_date&#39;} &amp;&amp; $opts{&#39;end_date&#39;}) {</td></tr>
<tr><td class="h">3507</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# revttime is reverse event time</td></tr>
<tr><td class="h">3508</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $s_date = $LJ::EndOfTime - $opts{&#39;start_date&#39;};</td></tr>
<tr><td class="h">3509</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $e_date = $LJ::EndOfTime - $opts{&#39;end_date&#39;};</td></tr>
<tr><td class="h">3510</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query .= &quot; AND revttime&lt;?&quot;;</td></tr>
<tr><td class="h">3511</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push(@vals, $s_date);</td></tr>
<tr><td class="h">3512</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query .= &quot; AND revttime&gt;?&quot;;</td></tr>
<tr><td class="h">3513</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push(@vals, $e_date);</td></tr>
<tr><td class="h">3514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3515</td><td colspan="7"></td></tr><tr><td class="h">3516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return count or jitemids</td></tr>
<tr><td class="h">3517</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3517">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts{&#39;return&#39;} eq &#39;count&#39;) {</td></tr>
<tr><td class="h">3518</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;selectrow_array($query, undef, @vals);</td></tr>
<tr><td class="h">3519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3520</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3520">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $jitemids = $u-&gt;selectcol_arrayref($query, undef, @vals) || [];</td></tr>
<tr><td class="h">3521</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3521">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die $u-&gt;errstr if $u-&gt;err;</td></tr>
<tr><td class="h">3522</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return @$jitemids;</td></tr>
<tr><td class="h">3523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3524</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3525</td><td colspan="7"></td></tr><tr><td class="h">3526</td><td colspan="7"></td></tr><tr><td class="h">3527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Returns &#39;rich&#39; or &#39;plain&#39; depending on user&#39;s</td></tr>
<tr><td class="h">3528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># setting of which editor they would like to use</td></tr>
<tr><td class="h">3529</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># and what they last used</td></tr>
<tr><td class="h">3530</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new_entry_editor {</td></tr>
<tr><td class="h">3531</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3531">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3532</td><td colspan="7"></td></tr><tr><td class="h">3533</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $editor = $u-&gt;prop(&#39;entry_editor&#39;);</td></tr>
<tr><td class="h">3534</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3534">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;plain&#39; if $editor eq &#39;always_plain&#39;; # They said they always want plain</td></tr>
<tr><td class="h">3535</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3535">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;rich&#39; if $editor eq &#39;always_rich&#39;; # They said they always want rich</td></tr>
<tr><td class="h">3536</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3536">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $editor if $editor =~ /(rich|plain)/; # What did they last use?</td></tr>
<tr><td class="h">3537</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::DEFAULT_EDITOR; # Use config default</td></tr>
<tr><td class="h">3538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3539</td><td colspan="7"></td></tr><tr><td class="h">3540</td><td colspan="7"></td></tr><tr><td class="h">3541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub newpost_minsecurity {</td></tr>
<tr><td class="h">3542</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3542">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3543</td><td colspan="7"></td></tr><tr><td class="h">3544</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3544">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;prop(&#39;newpost_minsecurity&#39;) || &#39;public&#39;;</td></tr>
<tr><td class="h">3545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3546</td><td colspan="7"></td></tr><tr><td class="h">3547</td><td colspan="7"></td></tr><tr><td class="h">3548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*get_post_count = \&amp;number_of_posts;</td></tr>
<tr><td class="h">3549</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub number_of_posts {</td></tr>
<tr><td class="h">3550</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3550">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, %opts) = @_;</td></tr>
<tr><td class="h">3551</td><td colspan="7"></td></tr><tr><td class="h">3552</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# to count only a subset of all posts</td></tr>
<tr><td class="h">3553</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3553">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%opts) {</td></tr>
<tr><td class="h">3554</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts{return} = &#39;count&#39;;</td></tr>
<tr><td class="h">3555</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;get_post_ids(%opts);</td></tr>
<tr><td class="h">3556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3557</td><td colspan="7"></td></tr><tr><td class="h">3558</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">3559</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$userid, &quot;log2ct:$userid&quot;];</td></tr>
<tr><td class="h">3560</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $expire = time() + 3600*24*2; # 2 days</td></tr>
<tr><td class="h">3561</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::MemCache::get_or_set($memkey, sub {</td></tr>
<tr><td class="h">3562</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3562">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;selectrow_array( &quot;SELECT COUNT(*) FROM log2 WHERE journalid=?&quot;,</td></tr>
<tr><td class="h">3563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid );</td></tr>
<tr><td class="h">3564</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}, $expire);</td></tr>
<tr><td class="h">3565</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3566</td><td colspan="7"></td></tr><tr><td class="h">3567</td><td colspan="7"></td></tr><tr><td class="h">3568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns array of LJ::Entry objects, ignoring security</td></tr>
<tr><td class="h">3569</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub recent_entries {</td></tr>
<tr><td class="h">3570</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3570">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, %opts) = @_;</td></tr>
<tr><td class="h">3571</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3571">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = delete $opts{&#39;filtered_for&#39;} || LJ::get_remote();</td></tr>
<tr><td class="h">3572</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3572">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count  = delete $opts{&#39;count&#39;}        || 50;</td></tr>
<tr><td class="h">3573</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3573">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $order  = delete $opts{&#39;order&#39;}        || &quot;&quot;;</td></tr>
<tr><td class="h">3574</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3574">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;unknown options&quot; if %opts;</td></tr>
<tr><td class="h">3575</td><td colspan="7"></td></tr><tr><td class="h">3576</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $err;</td></tr>
<tr><td class="h">3577</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @recent = $u-&gt;recent_items(</td></tr>
<tr><td class="h">3578</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itemshow  =&gt; $count,</td></tr>
<tr><td class="h">3579</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err       =&gt; \$err,</td></tr>
<tr><td class="h">3580</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clusterid =&gt; $u-&gt;clusterid,</td></tr>
<tr><td class="h">3581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remote    =&gt; $remote,</td></tr>
<tr><td class="h">3582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order     =&gt; $order,</td></tr>
<tr><td class="h">3583</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">3584</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3584">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Error loading recent items: $err&quot; if $err;</td></tr>
<tr><td class="h">3585</td><td colspan="7"></td></tr><tr><td class="h">3586</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @objs;</td></tr>
<tr><td class="h">3587</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $ri (@recent) {</td></tr>
<tr><td class="h">3588</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = LJ::Entry-&gt;new($u, jitemid =&gt; $ri-&gt;{itemid});</td></tr>
<tr><td class="h">3589</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @objs, $entry;</td></tr>
<tr><td class="h">3590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: populate the $entry with security/posterid/alldatepart/ownerid/rlogtime</td></tr>
<tr><td class="h">3591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3592</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @objs;</td></tr>
<tr><td class="h">3593</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3594</td><td colspan="7"></td></tr><tr><td class="h">3595</td><td colspan="7"></td></tr><tr><td class="h">3596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub security_group_display {</td></tr>
<tr><td class="h">3597</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3597">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $allowmask ) = @_;</td></tr>
<tr><td class="h">3598</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3598">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39; unless LJ::isu( $u );</td></tr>
<tr><td class="h">3599</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3599">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39; unless defined $allowmask;</td></tr>
<tr><td class="h">3600</td><td colspan="7"></td></tr><tr><td class="h">3601</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3601">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote() or return &#39;&#39;;</td></tr>
<tr><td class="h">3602</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3602">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $use_urls = $remote-&gt;get_cap( &quot;security_filter&quot; ) || $u-&gt;get_cap( &quot;security_filter&quot; );</td></tr>
<tr><td class="h">3603</td><td colspan="7"></td></tr><tr><td class="h">3604</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# see which group ids are in the security mask</td></tr>
<tr><td class="h">3605</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %group_ids = ( map { $_ =&gt; 1 } grep { $allowmask &amp; ( 1 &lt;&lt; $_ ) } 1..60 );</td></tr>
<tr><td class="h">3606</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3606">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39; unless scalar( keys %group_ids ) &gt; 0;</td></tr>
<tr><td class="h">3607</td><td colspan="7"></td></tr><tr><td class="h">3608</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @ret;</td></tr>
<tr><td class="h">3609</td><td colspan="7"></td></tr><tr><td class="h">3610</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @groups = $u-&gt;trust_groups;</td></tr>
<tr><td class="h">3611</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $group ( @groups ) {</td></tr>
<tr><td class="h">3612</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3612">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $group_ids{$group-&gt;{groupnum}};  # not in mask</td></tr>
<tr><td class="h">3613</td><td colspan="7"></td></tr><tr><td class="h">3614</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $name = LJ::ehtml( $group-&gt;{groupname} );</td></tr>
<tr><td class="h">3615</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3615">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $use_urls ) {</td></tr>
<tr><td class="h">3616</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $url = LJ::eurl( $u-&gt;journal_base . &quot;/security/group:$name&quot; );</td></tr>
<tr><td class="h">3617</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @ret, &quot;&lt;a href=&#39;$url&#39;&gt;$name&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">3618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3619</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @ret, $name;</td></tr>
<tr><td class="h">3620</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3621</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3622</td><td colspan="7"></td></tr><tr><td class="h">3623</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return join( &#39;, &#39;, @ret );</td></tr>
<tr><td class="h">3624</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3625</td><td colspan="7"></td></tr><tr><td class="h">3626</td><td colspan="7"></td></tr><tr><td class="h">3627</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_draft_text {</td></tr>
<tr><td class="h">3628</td><td><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3628">6</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $draft) = @_;</td></tr>
<tr><td class="h">3629</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $old = $u-&gt;draft_text;</td></tr>
<tr><td class="h">3630</td><td colspan="7"></td></tr><tr><td class="h">3631</td><td><div class="c3">6</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L3631">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::_T_DRAFT_RACE-&gt;() if $LJ::_T_DRAFT_RACE;</td></tr>
<tr><td class="h">3632</td><td colspan="7"></td></tr><tr><td class="h">3633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# try to find a shortcut that makes the SQL shorter</td></tr>
<tr><td class="h">3634</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @methods;  # list of [ $subref, $cost ]</td></tr>
<tr><td class="h">3635</td><td colspan="7"></td></tr><tr><td class="h">3636</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# one method is just setting it all at once.  which incurs about</td></tr>
<tr><td class="h">3637</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# 75 bytes of SQL overhead on top of the length of the draft,</td></tr>
<tr><td class="h">3638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# not counting the escaping</td></tr>
<tr><td class="h">3639</td><td><div class="c3">4</div><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3639">4</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @methods, [ &quot;set&quot;, sub { $u-&gt;set_prop(&#39;entry_draft&#39;, $draft); 1 },</td></tr>
<tr><td class="h">3640</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;75 + length $draft ];</td></tr>
<tr><td class="h">3641</td><td colspan="7"></td></tr><tr><td class="h">3642</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# stupid case, setting the same thing:</td></tr>
<tr><td class="h">3643</td><td><div class="c3">6</div><div class="c3">1</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L3643">100</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3643">1</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @methods, [ &quot;noop&quot;, sub { 1 }, 0 ] if $draft eq $old;</td></tr>
<tr><td class="h">3644</td><td colspan="7"></td></tr><tr><td class="h">3645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# simple case: appending</td></tr>
<tr><td class="h">3646</td><td><div class="c3">6</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L3646">100</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3646">67</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (length $old &amp;&amp; $draft =~ /^\Q$old\E(.+)/s) {</td></tr>
<tr><td class="h">3647</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $new = $1;</td></tr>
<tr><td class="h">3648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $appending = sub {</td></tr>
<tr><td class="h">3649</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L3649">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3649">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $prop = LJ::get_prop(&quot;user&quot;, &quot;entry_draft&quot;) or die; # FIXME: use exceptions</td></tr>
<tr><td class="h">3650</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rv = $u-&gt;do(&quot;UPDATE userpropblob SET value = CONCAT(value, ?) WHERE userid=? AND upropid=? AND LENGTH(value)=?&quot;,</td></tr>
<tr><td class="h">3651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $new, $u-&gt;userid, $prop-&gt;{id}, length $old);</td></tr>
<tr><td class="h">3652</td><td><div class="c3">2</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L3652">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $rv &gt; 0;</td></tr>
<tr><td class="h">3653</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;uncache_prop(&quot;entry_draft&quot;);</td></tr>
<tr><td class="h">3654</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3655</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">3656</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @methods, [ &quot;append&quot;, $appending, 40 + length $new ];</td></tr>
<tr><td class="h">3657</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3658</td><td colspan="7"></td></tr><tr><td class="h">3659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# TODO: prepending/middle insertion (the former being just the latter), as well</td></tr>
<tr><td class="h">3660</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# appending, wihch we could then get rid of</td></tr>
<tr><td class="h">3661</td><td colspan="7"></td></tr><tr><td class="h">3662</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# try the methods in increasing order</td></tr>
<tr><td class="h">3663</td><td><div class="c3">6</div><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $m (sort { $a-&gt;[2] &lt;=&gt; $b-&gt;[2] } @methods) {</td></tr>
<tr><td class="h">3664</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $func = $m-&gt;[1];</td></tr>
<tr><td class="h">3665</td><td><div class="c3">7</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L3665">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($func-&gt;()) {</td></tr>
<tr><td class="h">3666</td><td><div class="c3">6</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L3666">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::_T_METHOD_USED-&gt;($m-&gt;[0]) if $LJ::_T_METHOD_USED; # for testing</td></tr>
<tr><td class="h">3667</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3668</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3669</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3670</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3672</td><td colspan="7"></td></tr><tr><td class="h">3673</td><td colspan="7"></td></tr><tr><td class="h">3674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub third_party_notify_list {</td></tr>
<tr><td class="h">3675</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3675">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3676</td><td colspan="7"></td></tr><tr><td class="h">3677</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $val = $u-&gt;prop(&#39;third_party_notify_list&#39;);</td></tr>
<tr><td class="h">3678</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @services = split(&#39;,&#39;, $val);</td></tr>
<tr><td class="h">3679</td><td colspan="7"></td></tr><tr><td class="h">3680</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @services;</td></tr>
<tr><td class="h">3681</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3682</td><td colspan="7"></td></tr><tr><td class="h">3683</td><td colspan="7"></td></tr><tr><td class="h">3684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Add a service to a user&#39;s notify list</td></tr>
<tr><td class="h">3685</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub third_party_notify_list_add {</td></tr>
<tr><td class="h">3686</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3686">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $svc ) = @_;</td></tr>
<tr><td class="h">3687</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3687">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $svc;</td></tr>
<tr><td class="h">3688</td><td colspan="7"></td></tr><tr><td class="h">3689</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Is it already there?</td></tr>
<tr><td class="h">3690</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3690">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;third_party_notify_list_contains($svc);</td></tr>
<tr><td class="h">3691</td><td colspan="7"></td></tr><tr><td class="h">3692</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Create the new list of services</td></tr>
<tr><td class="h">3693</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @cur_services = $u-&gt;third_party_notify_list;</td></tr>
<tr><td class="h">3694</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @cur_services, $svc;</td></tr>
<tr><td class="h">3695</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $svc_list = join(&#39;,&#39;, @cur_services);</td></tr>
<tr><td class="h">3696</td><td colspan="7"></td></tr><tr><td class="h">3697</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Trim a service from the list if it is too long</td></tr>
<tr><td class="h">3698</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3698">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (length $svc_list &gt; 255) {</td></tr>
<tr><td class="h">3699</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shift @cur_services;</td></tr>
<tr><td class="h">3700</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$svc_list = join(&#39;,&#39;, @cur_services)</td></tr>
<tr><td class="h">3701</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3702</td><td colspan="7"></td></tr><tr><td class="h">3703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Set it</td></tr>
<tr><td class="h">3704</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop(&#39;third_party_notify_list&#39;, $svc_list);</td></tr>
<tr><td class="h">3705</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3706</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3707</td><td colspan="7"></td></tr><tr><td class="h">3708</td><td colspan="7"></td></tr><tr><td class="h">3709</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Check if the user&#39;s notify list contains a particular service</td></tr>
<tr><td class="h">3710</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub third_party_notify_list_contains {</td></tr>
<tr><td class="h">3711</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3711">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $val ) = @_;</td></tr>
<tr><td class="h">3712</td><td colspan="7"></td></tr><tr><td class="h">3713</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3713">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if grep { $_ eq $val } $u-&gt;third_party_notify_list;</td></tr>
<tr><td class="h">3714</td><td colspan="7"></td></tr><tr><td class="h">3715</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3717</td><td colspan="7"></td></tr><tr><td class="h">3718</td><td colspan="7"></td></tr><tr><td class="h">3719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Remove a service to a user&#39;s notify list</td></tr>
<tr><td class="h">3720</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub third_party_notify_list_remove {</td></tr>
<tr><td class="h">3721</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3721">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $svc ) = @_;</td></tr>
<tr><td class="h">3722</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3722">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $svc;</td></tr>
<tr><td class="h">3723</td><td colspan="7"></td></tr><tr><td class="h">3724</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Is it even there?</td></tr>
<tr><td class="h">3725</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3725">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $u-&gt;third_party_notify_list_contains($svc);</td></tr>
<tr><td class="h">3726</td><td colspan="7"></td></tr><tr><td class="h">3727</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Remove it!</td></tr>
<tr><td class="h">3728</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop(&#39;third_party_notify_list&#39;,</td></tr>
<tr><td class="h">3729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;join(&#39;,&#39;,</td></tr>
<tr><td class="h">3730</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { $_ ne $svc } $u-&gt;third_party_notify_list</td></tr>
<tr><td class="h">3731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</td></tr>
<tr><td class="h">3732</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">3733</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3734</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3735</td><td colspan="7"></td></tr><tr><td class="h">3736</td><td colspan="7"></td></tr><tr><td class="h">3737</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">3738</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  17. Interest-Related Functions</td></tr>
<tr><td class="h">3739</td><td colspan="7"></td></tr><tr><td class="h">3740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub interest_count {</td></tr>
<tr><td class="h">3741</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3741">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3742</td><td colspan="7"></td></tr><tr><td class="h">3743</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: fall back to SELECT COUNT(*) if not cached already?</td></tr>
<tr><td class="h">3744</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return scalar @{LJ::get_interests($u, { justids =&gt; 1 })};</td></tr>
<tr><td class="h">3745</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3746</td><td colspan="7"></td></tr><tr><td class="h">3747</td><td colspan="7"></td></tr><tr><td class="h">3748</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub interest_list {</td></tr>
<tr><td class="h">3749</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3749">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3750</td><td colspan="7"></td></tr><tr><td class="h">3751</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return map { $_-&gt;[1] } @{ LJ::get_interests($u) };</td></tr>
<tr><td class="h">3752</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3753</td><td colspan="7"></td></tr><tr><td class="h">3754</td><td colspan="7"></td></tr><tr><td class="h">3755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return hashref with intname =&gt; intid</td></tr>
<tr><td class="h">3756</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub interests {</td></tr>
<tr><td class="h">3757</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3757">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3758</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uints = LJ::get_interests($u);</td></tr>
<tr><td class="h">3759</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %interests;</td></tr>
<tr><td class="h">3760</td><td colspan="7"></td></tr><tr><td class="h">3761</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $int (@$uints) {</td></tr>
<tr><td class="h">3762</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$interests{$int-&gt;[1]} = $int-&gt;[0];  # $interests{name} = intid</td></tr>
<tr><td class="h">3763</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3764</td><td colspan="7"></td></tr><tr><td class="h">3765</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \%interests;</td></tr>
<tr><td class="h">3766</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3767</td><td colspan="7"></td></tr><tr><td class="h">3768</td><td colspan="7"></td></tr><tr><td class="h">3769</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub lazy_interests_cleanup {</td></tr>
<tr><td class="h">3770</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3770">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3771</td><td colspan="7"></td></tr><tr><td class="h">3772</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">3773</td><td colspan="7"></td></tr><tr><td class="h">3774</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3774">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_community) {</td></tr>
<tr><td class="h">3775</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT IGNORE INTO comminterests SELECT * FROM userinterests WHERE userid=?&quot;, undef, $u-&gt;id);</td></tr>
<tr><td class="h">3776</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM userinterests WHERE userid=?&quot;, undef, $u-&gt;id);</td></tr>
<tr><td class="h">3777</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3778</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT IGNORE INTO userinterests SELECT * FROM comminterests WHERE userid=?&quot;, undef, $u-&gt;id);</td></tr>
<tr><td class="h">3779</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM comminterests WHERE userid=?&quot;, undef, $u-&gt;id);</td></tr>
<tr><td class="h">3780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3781</td><td colspan="7"></td></tr><tr><td class="h">3782</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($u, &quot;intids&quot;);</td></tr>
<tr><td class="h">3783</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">3784</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3785</td><td colspan="7"></td></tr><tr><td class="h">3786</td><td colspan="7"></td></tr><tr><td class="h">3787</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_interests {</td></tr>
<tr><td class="h">3788</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3788">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_interests( @_ );</td></tr>
<tr><td class="h">3789</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3790</td><td colspan="7"></td></tr><tr><td class="h">3791</td><td colspan="7"></td></tr><tr><td class="h">3792</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">3793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  18. Jabber-Related Functions</td></tr>
<tr><td class="h">3794</td><td colspan="7"></td></tr><tr><td class="h">3795</td><td colspan="7"></td></tr><tr><td class="h">3796</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Hide the LJ Talk field on profile?  opt_showljtalk needs a value of &#39;N&#39;.</td></tr>
<tr><td class="h">3797</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub hide_ljtalk {</td></tr>
<tr><td class="h">3798</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3798">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3799</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3799">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;Invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">3800</td><td colspan="7"></td></tr><tr><td class="h">3801</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# ... The opposite of showing the field. :)</td></tr>
<tr><td class="h">3802</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3802">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;show_ljtalk ? 0 : 1;</td></tr>
<tr><td class="h">3803</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3804</td><td colspan="7"></td></tr><tr><td class="h">3805</td><td colspan="7"></td></tr><tr><td class="h">3806</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns whether or not the user is online on jabber</td></tr>
<tr><td class="h">3807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub jabber_is_online {</td></tr>
<tr><td class="h">3808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this function is unused as of Aug 2009 - kareila</td></tr>
<tr><td class="h">3809</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3809">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3810</td><td colspan="7"></td></tr><tr><td class="h">3811</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3811">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return keys %{LJ::Jabber::Presence-&gt;get_resources($u)} ? 1 : 0;</td></tr>
<tr><td class="h">3812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3813</td><td colspan="7"></td></tr><tr><td class="h">3814</td><td colspan="7"></td></tr><tr><td class="h">3815</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub ljtalk_id {</td></tr>
<tr><td class="h">3816</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3816">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3817</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3817">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;Invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">3818</td><td colspan="7"></td></tr><tr><td class="h">3819</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;user . &#39;@&#39; . $LJ::USER_DOMAIN;</td></tr>
<tr><td class="h">3820</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3821</td><td colspan="7"></td></tr><tr><td class="h">3822</td><td colspan="7"></td></tr><tr><td class="h">3823</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># opt_showljtalk options based on user setting</td></tr>
<tr><td class="h">3824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Y = Show the LJ Talk field on profile (default)</td></tr>
<tr><td class="h">3825</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># N = Don&#39;t show the LJ Talk field on profile</td></tr>
<tr><td class="h">3826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_showljtalk {</td></tr>
<tr><td class="h">3827</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3827">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3828</td><td colspan="7"></td></tr><tr><td class="h">3829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Check for valid value, or just return default of &#39;Y&#39;.</td></tr>
<tr><td class="h">3830</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3830">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;raw_prop(&#39;opt_showljtalk&#39;) =~ /^(Y|N)$/) {</td></tr>
<tr><td class="h">3831</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;raw_prop(&#39;opt_showljtalk&#39;);</td></tr>
<tr><td class="h">3832</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3833</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;Y&#39;;</td></tr>
<tr><td class="h">3834</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3835</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3836</td><td colspan="7"></td></tr><tr><td class="h">3837</td><td colspan="7"></td></tr><tr><td class="h">3838</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># find what servers a user is logged in to, and send them an IM</td></tr>
<tr><td class="h">3839</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns true if sent, false if failure or user not logged on</td></tr>
<tr><td class="h">3840</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Please do not call from web context</td></tr>
<tr><td class="h">3841</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub send_im {</td></tr>
<tr><td class="h">3842</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3842">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($self, %opts) = @_;</td></tr>
<tr><td class="h">3843</td><td colspan="7"></td></tr><tr><td class="h">3844</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3844">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;Can&#39;t call in web context&quot; if LJ::is_web_context();</td></tr>
<tr><td class="h">3845</td><td colspan="7"></td></tr><tr><td class="h">3846</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $from = delete $opts{from};</td></tr>
<tr><td class="h">3847</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3847">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $msg  = delete $opts{message} or croak &quot;No message specified&quot;;</td></tr>
<tr><td class="h">3848</td><td colspan="7"></td></tr><tr><td class="h">3849</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3849">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3849">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;No from or bot jid defined&quot; unless $from || $LJ::JABBER_BOT_JID;</td></tr>
<tr><td class="h">3850</td><td colspan="7"></td></tr><tr><td class="h">3851</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3851">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @resources = keys %{LJ::Jabber::Presence-&gt;get_resources($self)} or return 0;</td></tr>
<tr><td class="h">3852</td><td colspan="7"></td></tr><tr><td class="h">3853</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3853">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $res = $resources[0] or return 0; # FIXME: pick correct server based on priority?</td></tr>
<tr><td class="h">3854</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3854">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pres = LJ::Jabber::Presence-&gt;new($self, $res) or return 0;</td></tr>
<tr><td class="h">3855</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3855">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ip = $LJ::JABBER_SERVER_IP || &#39;127.0.0.1&#39;;</td></tr>
<tr><td class="h">3856</td><td colspan="7"></td></tr><tr><td class="h">3857</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3857">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sock = IO::Socket::INET-&gt;new(PeerAddr =&gt; &quot;${ip}:5200&quot;)</td></tr>
<tr><td class="h">3858</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return 0;</td></tr>
<tr><td class="h">3859</td><td colspan="7"></td></tr><tr><td class="h">3860</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $vhost = $LJ::DOMAIN;</td></tr>
<tr><td class="h">3861</td><td colspan="7"></td></tr><tr><td class="h">3862</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $to_jid   = $self-&gt;user   . &#39;@&#39; . $LJ::DOMAIN;</td></tr>
<tr><td class="h">3863</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3863">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $from_jid = $from ? $from-&gt;user . &#39;@&#39; . $LJ::DOMAIN : $LJ::JABBER_BOT_JID;</td></tr>
<tr><td class="h">3864</td><td colspan="7"></td></tr><tr><td class="h">3865</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $emsg = LJ::exml($msg);</td></tr>
<tr><td class="h">3866</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $stanza = LJ::eurl(qq{&lt;message to=&quot;$to_jid&quot; from=&quot;$from_jid&quot;&gt;&lt;body&gt;$emsg&lt;/body&gt;&lt;/message&gt;});</td></tr>
<tr><td class="h">3867</td><td colspan="7"></td></tr><tr><td class="h">3868</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;print $sock &quot;send_stanza $vhost $to_jid $stanza\n&quot;;</td></tr>
<tr><td class="h">3869</td><td colspan="7"></td></tr><tr><td class="h">3870</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $start_time = time();</td></tr>
<tr><td class="h">3871</td><td colspan="7"></td></tr><tr><td class="h">3872</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (1) {</td></tr>
<tr><td class="h">3873</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rin = &#39;&#39;;</td></tr>
<tr><td class="h">3874</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec($rin, fileno($sock), 1) = 1;</td></tr>
<tr><td class="h">3875</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select(my $rout=$rin, undef, undef, 1);</td></tr>
<tr><td class="h">3876</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3876">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (vec($rout, fileno($sock), 1)) {</td></tr>
<tr><td class="h">3877</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ln = &lt;$sock&gt;;</td></tr>
<tr><td class="h">3878</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3878">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $ln =~ /^OK/;</td></tr>
<tr><td class="h">3879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3880</td><td colspan="7"></td></tr><tr><td class="h">3881</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3881">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if time() &gt; $start_time + 5;</td></tr>
<tr><td class="h">3882</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3883</td><td colspan="7"></td></tr><tr><td class="h">3884</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">3885</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3886</td><td colspan="7"></td></tr><tr><td class="h">3887</td><td colspan="7"></td></tr><tr><td class="h">3888</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Show LJ Talk field on profile?  opt_showljtalk needs a value of &#39;Y&#39;.</td></tr>
<tr><td class="h">3889</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub show_ljtalk {</td></tr>
<tr><td class="h">3890</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3890">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3891</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3891">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;Invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">3892</td><td colspan="7"></td></tr><tr><td class="h">3893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Fail if the user wants to hide the LJ Talk field on their profile,</td></tr>
<tr><td class="h">3894</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# or doesn&#39;t even have the ability to show it.</td></tr>
<tr><td class="h">3895</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3895">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3895">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;opt_showljtalk eq &#39;Y&#39; &amp;&amp; LJ::is_enabled(&#39;ljtalk&#39;) &amp;&amp; $u-&gt;is_person;</td></tr>
<tr><td class="h">3896</td><td colspan="7"></td></tr><tr><td class="h">3897</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# User either decided to show LJ Talk field or has left it at the default.</td></tr>
<tr><td class="h">3898</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3898">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;opt_showljtalk eq &#39;Y&#39;;</td></tr>
<tr><td class="h">3899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3900</td><td colspan="7"></td></tr><tr><td class="h">3901</td><td colspan="7"></td></tr><tr><td class="h">3902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">3903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  19. OpenID and Identity Users</td></tr>
<tr><td class="h">3904</td><td colspan="7"></td></tr><tr><td class="h">3905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a true value if user has a reserved &#39;ext&#39; name.</td></tr>
<tr><td class="h">3906</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub external {</td></tr>
<tr><td class="h">3907</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3907">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3908</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;user =~ /^ext_/;</td></tr>
<tr><td class="h">3909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3910</td><td colspan="7"></td></tr><tr><td class="h">3911</td><td colspan="7"></td></tr><tr><td class="h">3912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns LJ::Identity object</td></tr>
<tr><td class="h">3913</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub identity {</td></tr>
<tr><td class="h">3914</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3914">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">3915</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3915">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_identity} if $u-&gt;{_identity};</td></tr>
<tr><td class="h">3916</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3916">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u-&gt;is_identity;</td></tr>
<tr><td class="h">3917</td><td colspan="7"></td></tr><tr><td class="h">3918</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;userid, &quot;ident:&quot; . $u-&gt;userid];</td></tr>
<tr><td class="h">3919</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ident = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">3920</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3920">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($ident) {</td></tr>
<tr><td class="h">3921</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $i = LJ::Identity-&gt;new(</td></tr>
<tr><td class="h">3922</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typeid =&gt; $ident-&gt;[0],</td></tr>
<tr><td class="h">3923</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value  =&gt; $ident-&gt;[1],</td></tr>
<tr><td class="h">3924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">3925</td><td colspan="7"></td></tr><tr><td class="h">3926</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_identity} = $i;</td></tr>
<tr><td class="h">3927</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3928</td><td colspan="7"></td></tr><tr><td class="h">3929</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">3930</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ident = $dbh-&gt;selectrow_arrayref( &quot;SELECT idtype, identity FROM identitymap &quot;.</td></tr>
<tr><td class="h">3931</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid=? LIMIT 1&quot;, undef, $u-&gt;userid );</td></tr>
<tr><td class="h">3932</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3932">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($ident) {</td></tr>
<tr><td class="h">3933</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $ident);</td></tr>
<tr><td class="h">3934</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $i = LJ::Identity-&gt;new(</td></tr>
<tr><td class="h">3935</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typeid =&gt; $ident-&gt;[0],</td></tr>
<tr><td class="h">3936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value  =&gt; $ident-&gt;[1],</td></tr>
<tr><td class="h">3937</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">3938</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $i;</td></tr>
<tr><td class="h">3939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3940</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">3941</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3942</td><td colspan="7"></td></tr><tr><td class="h">3943</td><td colspan="7"></td></tr><tr><td class="h">3944</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class function - load an identity user, but only if they&#39;re already known to us</td></tr>
<tr><td class="h">3945</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_existing_identity_user {</td></tr>
<tr><td class="h">3946</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3946">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($type, $ident) = @_;</td></tr>
<tr><td class="h">3947</td><td colspan="7"></td></tr><tr><td class="h">3948</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_reader();</td></tr>
<tr><td class="h">3949</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $dbh-&gt;selectrow_array(&quot;SELECT userid FROM identitymap WHERE idtype=? AND identity=?&quot;,</td></tr>
<tr><td class="h">3950</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $type, $ident);</td></tr>
<tr><td class="h">3951</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3951">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $uid ? LJ::load_userid($uid) : undef;</td></tr>
<tr><td class="h">3952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">3953</td><td colspan="7"></td></tr><tr><td class="h">3954</td><td colspan="7"></td></tr><tr><td class="h">3955</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class function - load an identity user, and if we&#39;ve never seen them before create a user account for them</td></tr>
<tr><td class="h">3956</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_identity_user {</td></tr>
<tr><td class="h">3957</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L3957">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($type, $ident, $vident) = @_;</td></tr>
<tr><td class="h">3958</td><td colspan="7"></td></tr><tr><td class="h">3959</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = load_existing_identity_user($type, $ident);</td></tr>
<tr><td class="h">3960</td><td colspan="7"></td></tr><tr><td class="h">3961</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# If the user is marked as expunged, move identity mapping aside</td></tr>
<tr><td class="h">3962</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# and continue to create new account.</td></tr>
<tr><td class="h">3963</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Otherwise return user if it exists.</td></tr>
<tr><td class="h">3964</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3964">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u) {</td></tr>
<tr><td class="h">3965</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3965">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;is_expunged) {</td></tr>
<tr><td class="h">3966</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3966">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless ($u-&gt;rename_identity);</td></tr>
<tr><td class="h">3967</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">3968</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">3969</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3970</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3971</td><td colspan="7"></td></tr><tr><td class="h">3972</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# increment ext_ counter until we successfully create an LJ</td></tr>
<tr><td class="h">3973</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# account.  hard cap it at 10 tries. (arbitrary, but we really</td></tr>
<tr><td class="h">3974</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# shouldn&#39;t have *any* failures here, let alone 10 in a row)</td></tr>
<tr><td class="h">3975</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">3976</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid;</td></tr>
<tr><td class="h">3977</td><td colspan="7"></td></tr><tr><td class="h">3978</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;for (1..10) {</td></tr>
<tr><td class="h">3979</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $extuser = &#39;ext_&#39; . LJ::alloc_global_counter(&#39;E&#39;);</td></tr>
<tr><td class="h">3980</td><td colspan="7"></td></tr><tr><td class="h">3981</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $name = $extuser;</td></tr>
<tr><td class="h">3982</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3982">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3982">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($type eq &quot;O&quot; &amp;&amp; ref $vident) {</td></tr>
<tr><td class="h">3983</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name = $vident-&gt;display;</td></tr>
<tr><td class="h">3984</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3985</td><td colspan="7"></td></tr><tr><td class="h">3986</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uid = LJ::create_account({</td></tr>
<tr><td class="h">3987</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;caps =&gt; undef,</td></tr>
<tr><td class="h">3988</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user =&gt; $extuser,</td></tr>
<tr><td class="h">3989</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name =&gt; $ident,</td></tr>
<tr><td class="h">3990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;journaltype =&gt; &#39;I&#39;,</td></tr>
<tr><td class="h">3991</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">3992</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3992">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $uid;</td></tr>
<tr><td class="h">3993</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select undef, undef, undef, .10;  # lets not thrash over this</td></tr>
<tr><td class="h">3994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">3995</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L3995">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L3995">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $uid &amp;&amp;</td></tr>
<tr><td class="h">3996</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO identitymap (idtype, identity, userid) VALUES (?,?,?)&quot;,</td></tr>
<tr><td class="h">3997</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $type, $ident, $uid);</td></tr>
<tr><td class="h">3998</td><td colspan="7"></td></tr><tr><td class="h">3999</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::load_userid($uid);</td></tr>
<tr><td class="h">4000</td><td colspan="7"></td></tr><tr><td class="h">4001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# record create information</td></tr>
<tr><td class="h">4002</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">4003</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;log_event(&#39;account_create&#39;, { remote =&gt; $remote });</td></tr>
<tr><td class="h">4004</td><td colspan="7"></td></tr><tr><td class="h">4005</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">4006</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4007</td><td colspan="7"></td></tr><tr><td class="h">4008</td><td colspan="7"></td></tr><tr><td class="h">4009</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns a URL if account is an OpenID identity.  undef otherwise.</td></tr>
<tr><td class="h">4010</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub openid_identity {</td></tr>
<tr><td class="h">4011</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4011">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4012</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ident = $u-&gt;identity;</td></tr>
<tr><td class="h">4013</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4013">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4013">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $ident &amp;&amp; $ident-&gt;typeid eq &#39;O&#39;;</td></tr>
<tr><td class="h">4014</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ident-&gt;value;</td></tr>
<tr><td class="h">4015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4016</td><td colspan="7"></td></tr><tr><td class="h">4017</td><td colspan="7"></td></tr><tr><td class="h">4018</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># prepare OpenId part of html-page, if needed</td></tr>
<tr><td class="h">4019</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub openid_tags {</td></tr>
<tr><td class="h">4020</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4020">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4021</td><td colspan="7"></td></tr><tr><td class="h">4022</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $head = &#39;&#39;;</td></tr>
<tr><td class="h">4023</td><td colspan="7"></td></tr><tr><td class="h">4024</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# OpenID Server and Yadis</td></tr>
<tr><td class="h">4025</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4025">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4025">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::OpenID-&gt;server_enabled and defined $u) {</td></tr>
<tr><td class="h">4026</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $journalbase = $u-&gt;journal_base;</td></tr>
<tr><td class="h">4027</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head .= qq{&lt;link rel=&quot;openid.server&quot; href=&quot;$LJ::OPENID_SERVER&quot; /&gt;\n};</td></tr>
<tr><td class="h">4028</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head .= qq{&lt;meta http-equiv=&quot;X-XRDS-Location&quot; content=&quot;$journalbase/data/yadis&quot; /&gt;\n};</td></tr>
<tr><td class="h">4029</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4030</td><td colspan="7"></td></tr><tr><td class="h">4031</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $head;</td></tr>
<tr><td class="h">4032</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4033</td><td colspan="7"></td></tr><tr><td class="h">4034</td><td colspan="7"></td></tr><tr><td class="h">4035</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">4036</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::User::rename_identity</td></tr>
<tr><td class="h">4037</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Change an identity user&#39;s &#39;identity&#39;, update DB,</td></tr>
<tr><td class="h">4038</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      clear memcache and log change.</td></tr>
<tr><td class="h">4039</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: user</td></tr>
<tr><td class="h">4040</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Success or failure.</td></tr>
<tr><td class="h">4041</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">4042</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub rename_identity {</td></tr>
<tr><td class="h">4043</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4043">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4044</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4044">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4044">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless ($u &amp;&amp; $u-&gt;is_identity &amp;&amp; $u-&gt;is_expunged);</td></tr>
<tr><td class="h">4045</td><td colspan="7"></td></tr><tr><td class="h">4046</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $id = $u-&gt;identity;</td></tr>
<tr><td class="h">4047</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4047">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $id;</td></tr>
<tr><td class="h">4048</td><td colspan="7"></td></tr><tr><td class="h">4049</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">4050</td><td colspan="7"></td></tr><tr><td class="h">4051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# generate a new identity value that looks like ex_oldidvalue555</td></tr>
<tr><td class="h">4052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $tempid = sub {</td></tr>
<tr><td class="h">4053</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4053">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $ident, $idtype ) = @_;</td></tr>
<tr><td class="h">4054</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4054">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $temp = (length($ident) &gt; 249) ? substr($ident, 0, 249) : $ident;</td></tr>
<tr><td class="h">4055</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $exid;</td></tr>
<tr><td class="h">4056</td><td colspan="7"></td></tr><tr><td class="h">4057</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (1..10) {</td></tr>
<tr><td class="h">4058</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$exid = &quot;ex_$temp&quot; . int(rand(999));</td></tr>
<tr><td class="h">4059</td><td colspan="7"></td></tr><tr><td class="h">4060</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# check to see if this identity already exists</td></tr>
<tr><td class="h">4061</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4061">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($dbh-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM identitymap WHERE identity=? AND idtype=? LIMIT 1&quot;, undef, $exid, $idtype)) {</td></tr>
<tr><td class="h">4062</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# name doesn&#39;t already exist, use this one</td></tr>
<tr><td class="h">4063</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last;</td></tr>
<tr><td class="h">4064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4065</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# name existed, try and get another</td></tr>
<tr><td class="h">4066</td><td colspan="7"></td></tr><tr><td class="h">4067</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4067">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($_ &gt;= 10) {</td></tr>
<tr><td class="h">4068</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">4069</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4070</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4071</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $exid;</td></tr>
<tr><td class="h">4072</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">4073</td><td colspan="7"></td></tr><tr><td class="h">4074</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $from = $id-&gt;value;</td></tr>
<tr><td class="h">4075</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $to = $tempid-&gt;($id-&gt;value, $id-&gt;typeid);</td></tr>
<tr><td class="h">4076</td><td colspan="7"></td></tr><tr><td class="h">4077</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4077">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $to;</td></tr>
<tr><td class="h">4078</td><td colspan="7"></td></tr><tr><td class="h">4079</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE identitymap SET identity=? WHERE identity=? AND idtype=?&quot;,</td></tr>
<tr><td class="h">4080</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $to, $from, $id-&gt;typeid);</td></tr>
<tr><td class="h">4081</td><td colspan="7"></td></tr><tr><td class="h">4082</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($u, &quot;userid&quot;);</td></tr>
<tr><td class="h">4083</td><td colspan="7"></td></tr><tr><td class="h">4084</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::infohistory_add($u, &#39;identity&#39;, $from);</td></tr>
<tr><td class="h">4085</td><td colspan="7"></td></tr><tr><td class="h">4086</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">4087</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4088</td><td colspan="7"></td></tr><tr><td class="h">4089</td><td colspan="7"></td></tr><tr><td class="h">4090</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4091</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  20. Page Notices Functions</td></tr>
<tr><td class="h">4092</td><td colspan="7"></td></tr><tr><td class="h">4093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub dismissed_page_notices {</td></tr>
<tr><td class="h">4094</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4094">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4095</td><td colspan="7"></td></tr><tr><td class="h">4096</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $val = $u-&gt;prop(&quot;dismissed_page_notices&quot;);</td></tr>
<tr><td class="h">4097</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @notices = split(&quot;,&quot;, $val);</td></tr>
<tr><td class="h">4098</td><td colspan="7"></td></tr><tr><td class="h">4099</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @notices;</td></tr>
<tr><td class="h">4100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4101</td><td colspan="7"></td></tr><tr><td class="h">4102</td><td colspan="7"></td></tr><tr><td class="h">4103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># add a page notice to a user&#39;s dismissed page notices list</td></tr>
<tr><td class="h">4104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub dismissed_page_notices_add {</td></tr>
<tr><td class="h">4105</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4105">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $notice_string ) = @_;</td></tr>
<tr><td class="h">4106</td><td colspan="7"></td></tr><tr><td class="h">4107</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4107">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4107">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $notice_string &amp;&amp; $LJ::VALID_PAGE_NOTICES{$notice_string};</td></tr>
<tr><td class="h">4108</td><td colspan="7"></td></tr><tr><td class="h">4109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# is it already there?</td></tr>
<tr><td class="h">4110</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4110">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;has_dismissed_page_notice($notice_string);</td></tr>
<tr><td class="h">4111</td><td colspan="7"></td></tr><tr><td class="h">4112</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# create the new list of dismissed page notices</td></tr>
<tr><td class="h">4113</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @cur_notices = $u-&gt;dismissed_page_notices;</td></tr>
<tr><td class="h">4114</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;push @cur_notices, $notice_string;</td></tr>
<tr><td class="h">4115</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cur_notices_string = join(&quot;,&quot;, @cur_notices);</td></tr>
<tr><td class="h">4116</td><td colspan="7"></td></tr><tr><td class="h">4117</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove the oldest notice if the list is too long</td></tr>
<tr><td class="h">4118</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4118">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (length $cur_notices_string &gt; 255) {</td></tr>
<tr><td class="h">4119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shift @cur_notices;</td></tr>
<tr><td class="h">4120</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cur_notices_string = join(&quot;,&quot;, @cur_notices);</td></tr>
<tr><td class="h">4121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4122</td><td colspan="7"></td></tr><tr><td class="h">4123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set it</td></tr>
<tr><td class="h">4124</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop(&quot;dismissed_page_notices&quot;, $cur_notices_string);</td></tr>
<tr><td class="h">4125</td><td colspan="7"></td></tr><tr><td class="h">4126</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">4127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4128</td><td colspan="7"></td></tr><tr><td class="h">4129</td><td colspan="7"></td></tr><tr><td class="h">4130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># remove a page notice from a user&#39;s dismissed page notices list</td></tr>
<tr><td class="h">4131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub dismissed_page_notices_remove {</td></tr>
<tr><td class="h">4132</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4132">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $notice_string ) = @_;</td></tr>
<tr><td class="h">4133</td><td colspan="7"></td></tr><tr><td class="h">4134</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4134">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4134">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $notice_string &amp;&amp; $LJ::VALID_PAGE_NOTICES{$notice_string};</td></tr>
<tr><td class="h">4135</td><td colspan="7"></td></tr><tr><td class="h">4136</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# is it even there?</td></tr>
<tr><td class="h">4137</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4137">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;has_dismissed_page_notice($notice_string);</td></tr>
<tr><td class="h">4138</td><td colspan="7"></td></tr><tr><td class="h">4139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove it</td></tr>
<tr><td class="h">4140</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;set_prop(&quot;dismissed_page_notices&quot;, join(&quot;,&quot;, grep { $_ ne $notice_string } $u-&gt;dismissed_page_notices));</td></tr>
<tr><td class="h">4141</td><td colspan="7"></td></tr><tr><td class="h">4142</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">4143</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4144</td><td colspan="7"></td></tr><tr><td class="h">4145</td><td colspan="7"></td></tr><tr><td class="h">4146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub has_dismissed_page_notice {</td></tr>
<tr><td class="h">4147</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4147">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $notice_string ) = @_;</td></tr>
<tr><td class="h">4148</td><td colspan="7"></td></tr><tr><td class="h">4149</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4149">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if grep { $_ eq $notice_string } $u-&gt;dismissed_page_notices;</td></tr>
<tr><td class="h">4150</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">4151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4152</td><td colspan="7"></td></tr><tr><td class="h">4153</td><td colspan="7"></td></tr><tr><td class="h">4154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4155</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  21. Password Functions</td></tr>
<tr><td class="h">4156</td><td colspan="7"></td></tr><tr><td class="h">4157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_receive_password {</td></tr>
<tr><td class="h">4158</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4158">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $email) = @_;</td></tr>
<tr><td class="h">4159</td><td colspan="7"></td></tr><tr><td class="h">4160</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4160">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4160">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u &amp;&amp; $email;</td></tr>
<tr><td class="h">4161</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4161">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if lc($email) eq lc($u-&gt;email_raw);</td></tr>
<tr><td class="h">4162</td><td colspan="7"></td></tr><tr><td class="h">4163</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_reader();</td></tr>
<tr><td class="h">4164</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $dbh-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM infohistory &quot;.</td></tr>
<tr><td class="h">4165</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid=? AND what=&#39;email&#39; &quot;.</td></tr>
<tr><td class="h">4166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND oldvalue=? AND other=&#39;A&#39;&quot;,</td></tr>
<tr><td class="h">4167</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id, $email);</td></tr>
<tr><td class="h">4168</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4169</td><td colspan="7"></td></tr><tr><td class="h">4170</td><td colspan="7"></td></tr><tr><td class="h">4171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub password {</td></tr>
<tr><td class="h">4172</td><td><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4172">4</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4173</td><td><div class="c3">4</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4173">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $u-&gt;is_person;</td></tr>
<tr><td class="h">4174</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">4175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_password} ||= LJ::MemCache::get_or_set( [$userid, &quot;pw:$userid&quot;], sub {</td></tr>
<tr><td class="h">4176</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4176">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4176">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer() or die &quot;Couldn&#39;t get db master&quot;;</td></tr>
<tr><td class="h">4177</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $dbh-&gt;selectrow_array( &quot;SELECT password FROM password WHERE userid=?&quot;,</td></tr>
<tr><td class="h">4178</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid );</td></tr>
<tr><td class="h">4179</td><td><div class="c3">3</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4179">67</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} );</td></tr>
<tr><td class="h">4180</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_password};</td></tr>
<tr><td class="h">4181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4182</td><td colspan="7"></td></tr><tr><td class="h">4183</td><td colspan="7"></td></tr><tr><td class="h">4184</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_password {</td></tr>
<tr><td class="h">4185</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4185">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $password) = @_;</td></tr>
<tr><td class="h">4186</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::set_password($u-&gt;id, $password);</td></tr>
<tr><td class="h">4187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4188</td><td colspan="7"></td></tr><tr><td class="h">4189</td><td colspan="7"></td></tr><tr><td class="h">4190</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  22. Priv-Related Functions</td></tr>
<tr><td class="h">4192</td><td colspan="7"></td></tr><tr><td class="h">4193</td><td colspan="7"></td></tr><tr><td class="h">4194</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub grant_priv {</td></tr>
<tr><td class="h">4195</td><td><div class="c3">16</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4195">16</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $priv, $arg) = @_;</td></tr>
<tr><td class="h">4196</td><td><div class="c3">16</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L4196">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$arg ||= &quot;&quot;;</td></tr>
<tr><td class="h">4197</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">4198</td><td colspan="7"></td></tr><tr><td class="h">4199</td><td><div class="c3">16</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4199">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;has_priv( $priv, $arg );</td></tr>
<tr><td class="h">4200</td><td colspan="7"></td></tr><tr><td class="h">4201</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $privid = $dbh-&gt;selectrow_array(&quot;SELECT prlid FROM priv_list&quot;.</td></tr>
<tr><td class="h">4202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; WHERE privcode = ?&quot;, undef, $priv);</td></tr>
<tr><td class="h">4203</td><td><div class="c3">16</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4203">50</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $privid;</td></tr>
<tr><td class="h">4204</td><td colspan="7"></td></tr><tr><td class="h">4205</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO priv_map (userid, prlid, arg) VALUES (?, ?, ?)&quot;,</td></tr>
<tr><td class="h">4206</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id, $privid, $arg);</td></tr>
<tr><td class="h">4207</td><td><div class="c3">16</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4207">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">4208</td><td colspan="7"></td></tr><tr><td class="h">4209</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;undef $u-&gt;{&#39;_privloaded&#39;}; # to force reloading of privs later</td></tr>
<tr><td class="h">4210</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">4211</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4212</td><td colspan="7"></td></tr><tr><td class="h">4213</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub has_priv {</td></tr>
<tr><td class="h">4214</td><td><div class="c3">98</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4214">98</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $priv, $arg ) = @_;</td></tr>
<tr><td class="h">4215</td><td colspan="7"></td></tr><tr><td class="h">4216</td><td><div class="c3">98</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4216">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_user_privs($u, $priv)</td></tr>
<tr><td class="h">4217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $u-&gt;{&#39;_privloaded&#39;}-&gt;{$priv};</td></tr>
<tr><td class="h">4218</td><td colspan="7"></td></tr><tr><td class="h">4219</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# no access if they don&#39;t have the priv</td></tr>
<tr><td class="h">4220</td><td><div class="c3">98</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4220">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless defined $u-&gt;{&#39;_priv&#39;}-&gt;{$priv};</td></tr>
<tr><td class="h">4221</td><td colspan="7"></td></tr><tr><td class="h">4222</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# at this point we know they have the priv</td></tr>
<tr><td class="h">4223</td><td><div class="c3">63</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4223">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless defined $arg;</td></tr>
<tr><td class="h">4224</td><td colspan="7"></td></tr><tr><td class="h">4225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check if they have the right arguments</td></tr>
<tr><td class="h">4226</td><td><div class="c3">21</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4226">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if defined $u-&gt;{&#39;_priv&#39;}-&gt;{$priv}-&gt;{$arg};</td></tr>
<tr><td class="h">4227</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4227">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if defined $u-&gt;{&#39;_priv&#39;}-&gt;{$priv}-&gt;{&quot;*&quot;};</td></tr>
<tr><td class="h">4228</td><td colspan="7"></td></tr><tr><td class="h">4229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t have the right argument</td></tr>
<tr><td class="h">4230</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">4231</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4232</td><td colspan="7"></td></tr><tr><td class="h">4233</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub priv_args</td></tr>
<tr><td class="h">4234</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">4235</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4235">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $priv ) = @_;</td></tr>
<tr><td class="h">4236</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4236">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4236">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $priv &amp;&amp; $u-&gt;has_priv( $priv );</td></tr>
<tr><td class="h">4237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# returns hash of form { arg =&gt; 1 }</td></tr>
<tr><td class="h">4238</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return %{ $u-&gt;{&#39;_priv&#39;}-&gt;{$priv} };</td></tr>
<tr><td class="h">4239</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4240</td><td colspan="7"></td></tr><tr><td class="h">4241</td><td colspan="7"></td></tr><tr><td class="h">4242</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub revoke_priv {</td></tr>
<tr><td class="h">4243</td><td><div class="c3">9</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4243">9</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $priv, $arg) = @_;</td></tr>
<tr><td class="h">4244</td><td><div class="c3">9</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L4244">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$arg ||=&quot;&quot;;</td></tr>
<tr><td class="h">4245</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">4246</td><td colspan="7"></td></tr><tr><td class="h">4247</td><td><div class="c3">9</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4247">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $u-&gt;has_priv( $priv, $arg );</td></tr>
<tr><td class="h">4248</td><td colspan="7"></td></tr><tr><td class="h">4249</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $privid = $dbh-&gt;selectrow_array(&quot;SELECT prlid FROM priv_list&quot;.</td></tr>
<tr><td class="h">4250</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; WHERE privcode = ?&quot;, undef, $priv);</td></tr>
<tr><td class="h">4251</td><td><div class="c3">9</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4251">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $privid;</td></tr>
<tr><td class="h">4252</td><td colspan="7"></td></tr><tr><td class="h">4253</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM priv_map WHERE userid = ? AND prlid = ? AND arg = ?&quot;,</td></tr>
<tr><td class="h">4254</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id, $privid, $arg);</td></tr>
<tr><td class="h">4255</td><td><div class="c3">9</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4255">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">4256</td><td colspan="7"></td></tr><tr><td class="h">4257</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;undef $u-&gt;{&#39;_privloaded&#39;}; # to force reloading of privs later</td></tr>
<tr><td class="h">4258</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;undef $u-&gt;{&#39;_priv&#39;};</td></tr>
<tr><td class="h">4259</td><td><div class="c3">9</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">4260</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4261</td><td colspan="7"></td></tr><tr><td class="h">4262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub revoke_priv_all {</td></tr>
<tr><td class="h">4263</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4263">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $priv) = @_;</td></tr>
<tr><td class="h">4264</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">4265</td><td colspan="7"></td></tr><tr><td class="h">4266</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $privid = $dbh-&gt;selectrow_array(&quot;SELECT prlid FROM priv_list&quot;.</td></tr>
<tr><td class="h">4267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; WHERE privcode = ?&quot;, undef, $priv);</td></tr>
<tr><td class="h">4268</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4268">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $privid;</td></tr>
<tr><td class="h">4269</td><td colspan="7"></td></tr><tr><td class="h">4270</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM priv_map WHERE userid = ? AND prlid = ?&quot;,</td></tr>
<tr><td class="h">4271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;id, $privid);</td></tr>
<tr><td class="h">4272</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4272">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">4273</td><td colspan="7"></td></tr><tr><td class="h">4274</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;undef $u-&gt;{&#39;_privloaded&#39;}; # to force reloading of privs later</td></tr>
<tr><td class="h">4275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;undef $u-&gt;{&#39;_priv&#39;};</td></tr>
<tr><td class="h">4276</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">4277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4278</td><td colspan="7"></td></tr><tr><td class="h">4279</td><td colspan="7"></td></tr><tr><td class="h">4280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  24. Styles and S2-Related Functions</td></tr>
<tr><td class="h">4282</td><td colspan="7"></td></tr><tr><td class="h">4283</td><td colspan="7"></td></tr><tr><td class="h">4284</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub journal_base {</td></tr>
<tr><td class="h">4285</td><td><div class="c3">59</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4285">59</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4286</td><td><div class="c3">59</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::journal_base($u);</td></tr>
<tr><td class="h">4287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4288</td><td colspan="7"></td></tr><tr><td class="h">4289</td><td colspan="7"></td></tr><tr><td class="h">4290</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_ctxpopup {</td></tr>
<tr><td class="h">4291</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4291">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4292</td><td colspan="7"></td></tr><tr><td class="h">4293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if unset, default to on</td></tr>
<tr><td class="h">4294</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4294">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop = $u-&gt;raw_prop(&#39;opt_ctxpopup&#39;) || &#39;Y&#39;;</td></tr>
<tr><td class="h">4295</td><td colspan="7"></td></tr><tr><td class="h">4296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $prop eq &#39;Y&#39;;</td></tr>
<tr><td class="h">4297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4298</td><td colspan="7"></td></tr><tr><td class="h">4299</td><td colspan="7"></td></tr><tr><td class="h">4300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_embedplaceholders {</td></tr>
<tr><td class="h">4301</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4301">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4302</td><td colspan="7"></td></tr><tr><td class="h">4303</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop = $u-&gt;raw_prop(&#39;opt_embedplaceholders&#39;);</td></tr>
<tr><td class="h">4304</td><td colspan="7"></td></tr><tr><td class="h">4305</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4305">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $prop) {</td></tr>
<tr><td class="h">4306</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $prop;</td></tr>
<tr><td class="h">4307</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">4308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $imagelinks = $u-&gt;prop(&#39;opt_imagelinks&#39;);</td></tr>
<tr><td class="h">4309</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $imagelinks;</td></tr>
<tr><td class="h">4310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4312</td><td colspan="7"></td></tr><tr><td class="h">4313</td><td colspan="7"></td></tr><tr><td class="h">4314</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub show_control_strip {</td></tr>
<tr><td class="h">4315</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4315">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4316</td><td colspan="7"></td></tr><tr><td class="h">4317</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4317">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hook(&#39;control_strip_propcheck&#39;, $u, &#39;show_control_strip&#39;) if LJ::is_enabled(&#39;control_strip_propcheck&#39;);</td></tr>
<tr><td class="h">4318</td><td colspan="7"></td></tr><tr><td class="h">4319</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop = $u-&gt;raw_prop(&#39;show_control_strip&#39;);</td></tr>
<tr><td class="h">4320</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4320">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $prop =~ /^off/;</td></tr>
<tr><td class="h">4321</td><td colspan="7"></td></tr><tr><td class="h">4322</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4322">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;dark&#39; if $prop eq &#39;forced&#39;;</td></tr>
<tr><td class="h">4323</td><td colspan="7"></td></tr><tr><td class="h">4324</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $prop;</td></tr>
<tr><td class="h">4325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4326</td><td colspan="7"></td></tr><tr><td class="h">4327</td><td colspan="7"></td></tr><tr><td class="h">4328</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub view_control_strip {</td></tr>
<tr><td class="h">4329</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4329">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4330</td><td colspan="7"></td></tr><tr><td class="h">4331</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4331">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hook(&#39;control_strip_propcheck&#39;, $u, &#39;view_control_strip&#39;) if LJ::is_enabled(&#39;control_strip_propcheck&#39;);</td></tr>
<tr><td class="h">4332</td><td colspan="7"></td></tr><tr><td class="h">4333</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop = $u-&gt;raw_prop(&#39;view_control_strip&#39;);</td></tr>
<tr><td class="h">4334</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4334">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $prop =~ /^off/;</td></tr>
<tr><td class="h">4335</td><td colspan="7"></td></tr><tr><td class="h">4336</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4336">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &#39;dark&#39; if $prop eq &#39;forced&#39;;</td></tr>
<tr><td class="h">4337</td><td colspan="7"></td></tr><tr><td class="h">4338</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $prop;</td></tr>
<tr><td class="h">4339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4340</td><td colspan="7"></td></tr><tr><td class="h">4341</td><td colspan="7"></td></tr><tr><td class="h">4342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  25. Subscription, Notifiction, and Messaging Functions</td></tr>
<tr><td class="h">4344</td><td colspan="7"></td></tr><tr><td class="h">4345</td><td colspan="7"></td></tr><tr><td class="h">4346</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># this is the count used to check the maximum subscription count</td></tr>
<tr><td class="h">4347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub active_inbox_subscription_count {</td></tr>
<tr><td class="h">4348</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4348">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4349</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4349">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return scalar ( grep { $_-&gt;active &amp;&amp; $_-&gt;enabled } $u-&gt;find_subscriptions(method =&gt; &#39;Inbox&#39;) );</td></tr>
<tr><td class="h">4350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4351</td><td colspan="7"></td></tr><tr><td class="h">4352</td><td colspan="7"></td></tr><tr><td class="h">4353</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_add_inbox_subscription {</td></tr>
<tr><td class="h">4354</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4354">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4355</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4355">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;active_inbox_subscription_count &gt;= $u-&gt;max_subscriptions ? 0 : 1;</td></tr>
<tr><td class="h">4356</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4357</td><td colspan="7"></td></tr><tr><td class="h">4358</td><td colspan="7"></td></tr><tr><td class="h">4359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># can this user use ESN?</td></tr>
<tr><td class="h">4360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_use_esn {</td></tr>
<tr><td class="h">4361</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4361">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4362</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4362">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4362">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;is_community || $u-&gt;is_syndicated;</td></tr>
<tr><td class="h">4363</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4363">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::is_enabled(&#39;esn&#39;);</td></tr>
<tr><td class="h">4364</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::is_enabled(&#39;esn_ui&#39;, $u);</td></tr>
<tr><td class="h">4365</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4366</td><td colspan="7"></td></tr><tr><td class="h">4367</td><td colspan="7"></td></tr><tr><td class="h">4368</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># 1/0 if someone can send a message to $u</td></tr>
<tr><td class="h">4369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_receive_message {</td></tr>
<tr><td class="h">4370</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4370">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $sender) = @_;</td></tr>
<tr><td class="h">4371</td><td colspan="7"></td></tr><tr><td class="h">4372</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opt_usermsg = $u-&gt;opt_usermsg;</td></tr>
<tr><td class="h">4373</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4373">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4373">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $opt_usermsg eq &#39;N&#39; || !$sender;</td></tr>
<tr><td class="h">4374</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4374">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;has_banned($sender);</td></tr>
<tr><td class="h">4375</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4375">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4375">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $opt_usermsg eq &#39;M&#39; &amp;&amp; !$u-&gt;mutually_trusts($sender);</td></tr>
<tr><td class="h">4376</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4376">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4376">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $opt_usermsg eq &#39;F&#39; &amp;&amp; !$u-&gt;trusts($sender);</td></tr>
<tr><td class="h">4377</td><td colspan="7"></td></tr><tr><td class="h">4378</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">4379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4380</td><td colspan="7"></td></tr><tr><td class="h">4381</td><td colspan="7"></td></tr><tr><td class="h">4382</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># delete all of a user&#39;s subscriptions</td></tr>
<tr><td class="h">4383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_all_subscriptions {</td></tr>
<tr><td class="h">4384</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4384">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Subscription-&gt;delete_all_subs( @_ );</td></tr>
<tr><td class="h">4385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4386</td><td colspan="7"></td></tr><tr><td class="h">4387</td><td colspan="7"></td></tr><tr><td class="h">4388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># delete all of a user&#39;s subscriptions</td></tr>
<tr><td class="h">4389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_all_inactive_subscriptions {</td></tr>
<tr><td class="h">4390</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4390">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Subscription-&gt;delete_all_inactive_subs( @_ );</td></tr>
<tr><td class="h">4391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4392</td><td colspan="7"></td></tr><tr><td class="h">4393</td><td colspan="7"></td></tr><tr><td class="h">4394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># ensure that this user does not have more than the maximum number of subscriptions</td></tr>
<tr><td class="h">4395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># allowed by their cap, and enable subscriptions up to their current limit</td></tr>
<tr><td class="h">4396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub enable_subscriptions {</td></tr>
<tr><td class="h">4397</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4397">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4398</td><td colspan="7"></td></tr><tr><td class="h">4399</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# first thing, disable everything they don&#39;t have caps for</td></tr>
<tr><td class="h">4400</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# and make sure everything is enabled that should be enabled</td></tr>
<tr><td class="h">4401</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4401">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;map { $_-&gt;available_for_user($u) ? $_-&gt;enable : $_-&gt;disable } $u-&gt;find_subscriptions(method =&gt; &#39;Inbox&#39;);</td></tr>
<tr><td class="h">4402</td><td colspan="7"></td></tr><tr><td class="h">4403</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $max_subs = $u-&gt;get_cap(&#39;subscriptions&#39;);</td></tr>
<tr><td class="h">4404</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4404">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @inbox_subs = grep { $_-&gt;active &amp;&amp; $_-&gt;enabled } $u-&gt;find_subscriptions(method =&gt; &#39;Inbox&#39;);</td></tr>
<tr><td class="h">4405</td><td colspan="7"></td></tr><tr><td class="h">4406</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4406">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ((scalar @inbox_subs) &gt; $max_subs) {</td></tr>
<tr><td class="h">4407</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# oh no, too many subs.</td></tr>
<tr><td class="h">4408</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# disable the oldest subscriptions that are &quot;tracking&quot; subscriptions</td></tr>
<tr><td class="h">4409</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @tracking = grep { $_-&gt;is_tracking_category } @inbox_subs;</td></tr>
<tr><td class="h">4410</td><td colspan="7"></td></tr><tr><td class="h">4411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# oldest subs first</td></tr>
<tr><td class="h">4412</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@tracking = sort {</td></tr>
<tr><td class="h">4413</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $a-&gt;createtime &lt;=&gt; $b-&gt;createtime;</td></tr>
<tr><td class="h">4414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} @tracking;</td></tr>
<tr><td class="h">4415</td><td colspan="7"></td></tr><tr><td class="h">4416</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $need_to_deactivate = (scalar @inbox_subs) - $max_subs;</td></tr>
<tr><td class="h">4417</td><td colspan="7"></td></tr><tr><td class="h">4418</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (1..$need_to_deactivate) {</td></tr>
<tr><td class="h">4419</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sub_to_deactivate = shift @tracking;</td></tr>
<tr><td class="h">4420</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4420">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sub_to_deactivate-&gt;deactivate if $sub_to_deactivate;</td></tr>
<tr><td class="h">4421</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4422</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">4423</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# make sure all subscriptions are activated</td></tr>
<tr><td class="h">4424</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $need_to_activate = $max_subs - (scalar @inbox_subs);</td></tr>
<tr><td class="h">4425</td><td colspan="7"></td></tr><tr><td class="h">4426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get deactivated subs</td></tr>
<tr><td class="h">4427</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4427">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@inbox_subs = grep { $_-&gt;active &amp;&amp; $_-&gt;available_for_user } $u-&gt;find_subscriptions(method =&gt; &#39;Inbox&#39;);</td></tr>
<tr><td class="h">4428</td><td colspan="7"></td></tr><tr><td class="h">4429</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (1..$need_to_activate) {</td></tr>
<tr><td class="h">4430</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sub_to_activate = shift @inbox_subs;</td></tr>
<tr><td class="h">4431</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4431">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sub_to_activate-&gt;activate if $sub_to_activate;</td></tr>
<tr><td class="h">4432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4435</td><td colspan="7"></td></tr><tr><td class="h">4436</td><td colspan="7"></td></tr><tr><td class="h">4437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub esn_inbox_default_expand {</td></tr>
<tr><td class="h">4438</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4438">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4439</td><td colspan="7"></td></tr><tr><td class="h">4440</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $prop = $u-&gt;raw_prop(&#39;esn_inbox_default_expand&#39;);</td></tr>
<tr><td class="h">4441</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $prop ne &#39;N&#39;;</td></tr>
<tr><td class="h">4442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4443</td><td colspan="7"></td></tr><tr><td class="h">4444</td><td colspan="7"></td></tr><tr><td class="h">4445</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># interim solution while legacy/ESN notifications are both happening:</td></tr>
<tr><td class="h">4446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># checks possible subscriptions to see if user will get an ESN notification</td></tr>
<tr><td class="h">4447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># THIS IS TEMPORARY. FIXME. Should only be called by talklib.</td></tr>
<tr><td class="h">4448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># params: journal, arg1 (entry ditemid), arg2 (comment talkid)</td></tr>
<tr><td class="h">4449</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub gets_notified {</td></tr>
<tr><td class="h">4450</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4450">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, %params) = @_;</td></tr>
<tr><td class="h">4451</td><td colspan="7"></td></tr><tr><td class="h">4452</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$params{event} = &quot;LJ::Event::JournalNewComment&quot;;</td></tr>
<tr><td class="h">4453</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$params{method} = &quot;LJ::NotificationMethod::Email&quot;;</td></tr>
<tr><td class="h">4454</td><td colspan="7"></td></tr><tr><td class="h">4455</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $has_sub;</td></tr>
<tr><td class="h">4456</td><td colspan="7"></td></tr><tr><td class="h">4457</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# did they subscribe to the parent comment?</td></tr>
<tr><td class="h">4458</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$has_sub = LJ::Subscription-&gt;find($u, %params);</td></tr>
<tr><td class="h">4459</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4459">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $has_sub if $has_sub;</td></tr>
<tr><td class="h">4460</td><td colspan="7"></td></tr><tr><td class="h">4461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove the comment-specific parameter, then check for an entry subscription</td></tr>
<tr><td class="h">4462</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$params{arg2} = 0;</td></tr>
<tr><td class="h">4463</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$has_sub = LJ::Subscription-&gt;find($u, %params);</td></tr>
<tr><td class="h">4464</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4464">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $has_sub if $has_sub;</td></tr>
<tr><td class="h">4465</td><td colspan="7"></td></tr><tr><td class="h">4466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove the entry-specific parameter, then check if they&#39;re subscribed to the entire journal</td></tr>
<tr><td class="h">4467</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$params{arg1} = 0;</td></tr>
<tr><td class="h">4468</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$has_sub = LJ::Subscription-&gt;find($u, %params);</td></tr>
<tr><td class="h">4469</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $has_sub;</td></tr>
<tr><td class="h">4470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4471</td><td colspan="7"></td></tr><tr><td class="h">4472</td><td colspan="7"></td></tr><tr><td class="h">4473</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># search for a subscription</td></tr>
<tr><td class="h">4474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*find_subscriptions = \&amp;has_subscription;</td></tr>
<tr><td class="h">4475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub has_subscription {</td></tr>
<tr><td class="h">4476</td><td><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4476">4</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, %params) = @_;</td></tr>
<tr><td class="h">4477</td><td><div class="c3">4</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4477">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;No parameters&quot; unless %params;</td></tr>
<tr><td class="h">4478</td><td colspan="7"></td></tr><tr><td class="h">4479</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Subscription-&gt;find($u, %params);</td></tr>
<tr><td class="h">4480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4481</td><td colspan="7"></td></tr><tr><td class="h">4482</td><td colspan="7"></td></tr><tr><td class="h">4483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub max_subscriptions {</td></tr>
<tr><td class="h">4484</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4484">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4485</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;get_cap(&#39;subscriptions&#39;);</td></tr>
<tr><td class="h">4486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4487</td><td colspan="7"></td></tr><tr><td class="h">4488</td><td colspan="7"></td></tr><tr><td class="h">4489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return the URL to the send message page</td></tr>
<tr><td class="h">4490</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub message_url {</td></tr>
<tr><td class="h">4491</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4491">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4492</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4492">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;invalid user object passed&quot; unless LJ::isu($u);</td></tr>
<tr><td class="h">4493</td><td colspan="7"></td></tr><tr><td class="h">4494</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4494">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::is_enabled(&#39;user_messaging&#39;);</td></tr>
<tr><td class="h">4495</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$LJ::SITEROOT/inbox/compose?user=&quot; . $u-&gt;user;</td></tr>
<tr><td class="h">4496</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4497</td><td colspan="7"></td></tr><tr><td class="h">4498</td><td colspan="7"></td></tr><tr><td class="h">4499</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new_message_count {</td></tr>
<tr><td class="h">4500</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4500">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4501</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $inbox = $u-&gt;notification_inbox;</td></tr>
<tr><td class="h">4502</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = $inbox-&gt;unread_count;</td></tr>
<tr><td class="h">4503</td><td colspan="7"></td></tr><tr><td class="h">4504</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4504">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $count || 0;</td></tr>
<tr><td class="h">4505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4506</td><td colspan="7"></td></tr><tr><td class="h">4507</td><td colspan="7"></td></tr><tr><td class="h">4508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub notification_archive {</td></tr>
<tr><td class="h">4509</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4509">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4510</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::NotificationArchive-&gt;new($u);</td></tr>
<tr><td class="h">4511</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4512</td><td colspan="7"></td></tr><tr><td class="h">4513</td><td colspan="7"></td></tr><tr><td class="h">4514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Returns the NotificationInbox for this user</td></tr>
<tr><td class="h">4515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*inbox = \&amp;notification_inbox;</td></tr>
<tr><td class="h">4516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub notification_inbox {</td></tr>
<tr><td class="h">4517</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4517">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4518</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::NotificationInbox-&gt;new($u);</td></tr>
<tr><td class="h">4519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4520</td><td colspan="7"></td></tr><tr><td class="h">4521</td><td colspan="7"></td></tr><tr><td class="h">4522</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># opt_usermsg options</td></tr>
<tr><td class="h">4523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Y - Registered Users</td></tr>
<tr><td class="h">4524</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># F - Trusted Users</td></tr>
<tr><td class="h">4525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># M - Mutually Trusted Users</td></tr>
<tr><td class="h">4526</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># N - Nobody</td></tr>
<tr><td class="h">4527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_usermsg {</td></tr>
<tr><td class="h">4528</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4528">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4529</td><td colspan="7"></td></tr><tr><td class="h">4530</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4530">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;raw_prop(&#39;opt_usermsg&#39;) =~ /^(Y|F|M|N)$/) {</td></tr>
<tr><td class="h">4531</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;raw_prop(&#39;opt_usermsg&#39;);</td></tr>
<tr><td class="h">4532</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">4533</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4533">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;M&#39; if $u-&gt;is_minor;</td></tr>
<tr><td class="h">4534</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;Y&#39;;</td></tr>
<tr><td class="h">4535</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4537</td><td colspan="7"></td></tr><tr><td class="h">4538</td><td colspan="7"></td></tr><tr><td class="h">4539</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># subscribe to an event</td></tr>
<tr><td class="h">4540</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subscribe {</td></tr>
<tr><td class="h">4541</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4541">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, %opts) = @_;</td></tr>
<tr><td class="h">4542</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4542">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;croak &quot;No subscription options&quot; unless %opts;</td></tr>
<tr><td class="h">4543</td><td colspan="7"></td></tr><tr><td class="h">4544</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Subscription-&gt;create($u, %opts);</td></tr>
<tr><td class="h">4545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4546</td><td colspan="7"></td></tr><tr><td class="h">4547</td><td colspan="7"></td></tr><tr><td class="h">4548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subscription_count {</td></tr>
<tr><td class="h">4549</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4549">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4550</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return scalar LJ::Subscription-&gt;subscriptions_of_user($u);</td></tr>
<tr><td class="h">4551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4552</td><td colspan="7"></td></tr><tr><td class="h">4553</td><td colspan="7"></td></tr><tr><td class="h">4554</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub subscriptions {</td></tr>
<tr><td class="h">4555</td><td><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4555">4</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4556</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Subscription-&gt;subscriptions_of_user($u);</td></tr>
<tr><td class="h">4557</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4558</td><td colspan="7"></td></tr><tr><td class="h">4559</td><td colspan="7"></td></tr><tr><td class="h">4560</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4561</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### 26. Syndication-Related Functions</td></tr>
<tr><td class="h">4562</td><td colspan="7"></td></tr><tr><td class="h">4563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># retrieve hash of basic syndicated info</td></tr>
<tr><td class="h">4564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_syndicated {</td></tr>
<tr><td class="h">4565</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4565">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4566</td><td colspan="7"></td></tr><tr><td class="h">4567</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4567">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $u-&gt;is_syndicated;</td></tr>
<tr><td class="h">4568</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">4569</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$userid, &quot;synd:$userid&quot;];</td></tr>
<tr><td class="h">4570</td><td colspan="7"></td></tr><tr><td class="h">4571</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $synd = {};</td></tr>
<tr><td class="h">4572</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$synd = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">4573</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4573">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($synd) {</td></tr>
<tr><td class="h">4574</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">4575</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4575">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return unless $dbr;</td></tr>
<tr><td class="h">4576</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$synd = $dbr-&gt;selectrow_hashref( &quot;SELECT * FROM syndicated WHERE userid=$userid&quot; );</td></tr>
<tr><td class="h">4577</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4577">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $synd, 60 * 30) if $synd;</td></tr>
<tr><td class="h">4578</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4579</td><td colspan="7"></td></tr><tr><td class="h">4580</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $synd;</td></tr>
<tr><td class="h">4581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4582</td><td colspan="7"></td></tr><tr><td class="h">4583</td><td colspan="7"></td></tr><tr><td class="h">4584</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  27. Tag-Related Functions</td></tr>
<tr><td class="h">4586</td><td colspan="7"></td></tr><tr><td class="h">4587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># can $u add existing tags to $targetu&#39;s entries?</td></tr>
<tr><td class="h">4588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_add_tags_to {</td></tr>
<tr><td class="h">4589</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4589">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $targetu) = @_;</td></tr>
<tr><td class="h">4590</td><td colspan="7"></td></tr><tr><td class="h">4591</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Tags::can_add_tags($targetu, $u);</td></tr>
<tr><td class="h">4592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4593</td><td colspan="7"></td></tr><tr><td class="h">4594</td><td colspan="7"></td></tr><tr><td class="h">4595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub tags {</td></tr>
<tr><td class="h">4596</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4596">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4597</td><td colspan="7"></td></tr><tr><td class="h">4598</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Tags::get_usertags($u);</td></tr>
<tr><td class="h">4599</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4600</td><td colspan="7"></td></tr><tr><td class="h">4601</td><td colspan="7"></td></tr><tr><td class="h">4602</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4603</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  28. Userpic-Related Functions</td></tr>
<tr><td class="h">4604</td><td colspan="7"></td></tr><tr><td class="h">4605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">4606</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::User::activate_userpics</td></tr>
<tr><td class="h">4607</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Sets/unsets userpics as inactive based on account caps.</td></tr>
<tr><td class="h">4608</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: nothing</td></tr>
<tr><td class="h">4609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">4610</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub activate_userpics {</td></tr>
<tr><td class="h">4611</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4611">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4612</td><td colspan="7"></td></tr><tr><td class="h">4613</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# this behavior is optional, but enabled by default</td></tr>
<tr><td class="h">4614</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4614">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $LJ::ALLOW_PICS_OVER_QUOTA;</td></tr>
<tr><td class="h">4615</td><td colspan="7"></td></tr><tr><td class="h">4616</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4616">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::isu($u);</td></tr>
<tr><td class="h">4617</td><td colspan="7"></td></tr><tr><td class="h">4618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t get a cluster read for expunged users since they are clusterid 0,</td></tr>
<tr><td class="h">4619</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so just return 1 to the caller from here and act like everything went fine</td></tr>
<tr><td class="h">4620</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4620">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;is_expunged;</td></tr>
<tr><td class="h">4621</td><td colspan="7"></td></tr><tr><td class="h">4622</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">4623</td><td colspan="7"></td></tr><tr><td class="h">4624</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# active / inactive lists</td></tr>
<tr><td class="h">4625</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @active = ();</td></tr>
<tr><td class="h">4626</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @inactive = ();</td></tr>
<tr><td class="h">4627</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $allow = LJ::get_cap($u, &quot;userpics&quot;);</td></tr>
<tr><td class="h">4628</td><td colspan="7"></td></tr><tr><td class="h">4629</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get a database handle for reading/writing</td></tr>
<tr><td class="h">4630</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">4631</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u);</td></tr>
<tr><td class="h">4632</td><td colspan="7"></td></tr><tr><td class="h">4633</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# select all userpics and build active / inactive lists</td></tr>
<tr><td class="h">4634</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth;</td></tr>
<tr><td class="h">4635</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4635">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;dversion &gt; 6 ) {</td></tr>
<tr><td class="h">4636</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4636">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $dbcr;</td></tr>
<tr><td class="h">4637</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $dbcr-&gt;prepare(&quot;SELECT picid, state FROM userpic2 WHERE userid=?&quot;);</td></tr>
<tr><td class="h">4638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">4639</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4639">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $dbh;</td></tr>
<tr><td class="h">4640</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $dbh-&gt;prepare(&quot;SELECT picid, state FROM userpic WHERE userid=?&quot;);</td></tr>
<tr><td class="h">4641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4642</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($userid);</td></tr>
<tr><td class="h">4643</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($picid, $state) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">4644</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4644">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $state eq &#39;X&#39;; # expunged, means userpic has been removed from site by admins</td></tr>
<tr><td class="h">4645</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4645">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($state eq &#39;I&#39;) {</td></tr>
<tr><td class="h">4646</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @inactive, $picid;</td></tr>
<tr><td class="h">4647</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">4648</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @active, $picid;</td></tr>
<tr><td class="h">4649</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4650</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4651</td><td colspan="7"></td></tr><tr><td class="h">4652</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# inactivate previously activated userpics</td></tr>
<tr><td class="h">4653</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4653">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@active &gt; $allow) {</td></tr>
<tr><td class="h">4654</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $to_ban = @active - $allow;</td></tr>
<tr><td class="h">4655</td><td colspan="7"></td></tr><tr><td class="h">4656</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# find first jitemid greater than time 2 months ago using rlogtime index</td></tr>
<tr><td class="h">4657</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# ($LJ::EndOfTime - UnixTime)</td></tr>
<tr><td class="h">4658</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $jitemid = $dbcr-&gt;selectrow_array(&quot;SELECT jitemid FROM log2 USE INDEX (rlogtime) &quot; .</td></tr>
<tr><td class="h">4659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=? AND rlogtime &gt; ? LIMIT 1&quot;,</td></tr>
<tr><td class="h">4660</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid, $LJ::EndOfTime - time() + 86400*60);</td></tr>
<tr><td class="h">4661</td><td colspan="7"></td></tr><tr><td class="h">4662</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# query all pickws in logprop2 with jitemid &gt; that value</td></tr>
<tr><td class="h">4663</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %count_kw = ();</td></tr>
<tr><td class="h">4664</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $propid = LJ::get_prop(&quot;log&quot;, &quot;picture_keyword&quot;)-&gt;{&#39;id&#39;};</td></tr>
<tr><td class="h">4665</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbcr-&gt;prepare(&quot;SELECT value, COUNT(*) FROM logprop2 &quot; .</td></tr>
<tr><td class="h">4666</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=? AND jitemid &gt; ? AND propid=?&quot; .</td></tr>
<tr><td class="h">4667</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;GROUP BY value&quot;);</td></tr>
<tr><td class="h">4668</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($userid, $jitemid, $propid);</td></tr>
<tr><td class="h">4669</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($value, $ct) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">4670</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# keyword =&gt; count</td></tr>
<tr><td class="h">4671</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$count_kw{$value} = $ct;</td></tr>
<tr><td class="h">4672</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4673</td><td colspan="7"></td></tr><tr><td class="h">4674</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $keywords_in = join(&quot;,&quot;, map { $dbh-&gt;quote($_) } keys %count_kw);</td></tr>
<tr><td class="h">4675</td><td colspan="7"></td></tr><tr><td class="h">4676</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# map pickws to picids for freq hash below</td></tr>
<tr><td class="h">4677</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %count_picid = ();</td></tr>
<tr><td class="h">4678</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4678">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($keywords_in) {</td></tr>
<tr><td class="h">4679</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth;</td></tr>
<tr><td class="h">4680</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4680">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;dversion &gt; 6 ) {</td></tr>
<tr><td class="h">4681</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $dbcr-&gt;prepare(&quot;SELECT k.keyword, m.picid FROM userkeywords k, userpicmap2 m &quot;.</td></tr>
<tr><td class="h">4682</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE k.keyword IN ($keywords_in) AND k.kwid=m.kwid AND k.userid=m.userid &quot; .</td></tr>
<tr><td class="h">4683</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND k.userid=?&quot;);</td></tr>
<tr><td class="h">4684</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">4685</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $dbh-&gt;prepare(&quot;SELECT k.keyword, m.picid FROM keywords k, userpicmap m &quot; .</td></tr>
<tr><td class="h">4686</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE k.keyword IN ($keywords_in) AND k.kwid=m.kwid &quot; .</td></tr>
<tr><td class="h">4687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND m.userid=?&quot;);</td></tr>
<tr><td class="h">4688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4689</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($userid);</td></tr>
<tr><td class="h">4690</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($keyword, $picid) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">4691</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# keyword =&gt; picid</td></tr>
<tr><td class="h">4692</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$count_picid{$picid} += $count_kw{$keyword};</td></tr>
<tr><td class="h">4693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4694</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4695</td><td colspan="7"></td></tr><tr><td class="h">4696</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we&#39;re only going to ban the least used, excluding the user&#39;s default</td></tr>
<tr><td class="h">4697</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @ban = (grep { $_ != $u-&gt;{&#39;defaultpicid&#39;} }</td></tr>
<tr><td class="h">4698</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort { $count_picid{$a} &lt;=&gt; $count_picid{$b} } @active);</td></tr>
<tr><td class="h">4699</td><td colspan="7"></td></tr><tr><td class="h">4700</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4700">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@ban = splice(@ban, 0, $to_ban) if @ban &gt; $to_ban;</td></tr>
<tr><td class="h">4701</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ban_in = join(&quot;,&quot;, map { $dbh-&gt;quote($_) } @ban);</td></tr>
<tr><td class="h">4702</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4702">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;dversion &gt; 6 ) {</td></tr>
<tr><td class="h">4703</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4703">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;UPDATE userpic2 SET state=&#39;I&#39; WHERE userid=? AND picid IN ($ban_in)&quot;,</td></tr>
<tr><td class="h">4704</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid) if $ban_in;</td></tr>
<tr><td class="h">4705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">4706</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4706">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE userpic SET state=&#39;I&#39; WHERE userid=? AND picid IN ($ban_in)&quot;,</td></tr>
<tr><td class="h">4707</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid) if $ban_in;</td></tr>
<tr><td class="h">4708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4709</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4710</td><td colspan="7"></td></tr><tr><td class="h">4711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# activate previously inactivated userpics</td></tr>
<tr><td class="h">4712</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4712">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4712">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@inactive &amp;&amp; @active &lt; $allow) {</td></tr>
<tr><td class="h">4713</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $to_activate = $allow - @active;</td></tr>
<tr><td class="h">4714</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4714">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$to_activate = @inactive if $to_activate &gt; @inactive;</td></tr>
<tr><td class="h">4715</td><td colspan="7"></td></tr><tr><td class="h">4716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# take the $to_activate newest (highest numbered) pictures</td></tr>
<tr><td class="h">4717</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# to reactivated</td></tr>
<tr><td class="h">4718</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@inactive = sort @inactive;</td></tr>
<tr><td class="h">4719</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @activate_picids = splice(@inactive, -$to_activate);</td></tr>
<tr><td class="h">4720</td><td colspan="7"></td></tr><tr><td class="h">4721</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $activate_in = join(&quot;,&quot;, map { $dbh-&gt;quote($_) } @activate_picids);</td></tr>
<tr><td class="h">4722</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4722">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($activate_in) {</td></tr>
<tr><td class="h">4723</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4723">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;dversion &gt; 6 ) {</td></tr>
<tr><td class="h">4724</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;UPDATE userpic2 SET state=&#39;N&#39; WHERE userid=? AND picid IN ($activate_in)&quot;,</td></tr>
<tr><td class="h">4725</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid);</td></tr>
<tr><td class="h">4726</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">4727</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE userpic SET state=&#39;N&#39; WHERE userid=? AND picid IN ($activate_in)&quot;,</td></tr>
<tr><td class="h">4728</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid);</td></tr>
<tr><td class="h">4729</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4730</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4732</td><td colspan="7"></td></tr><tr><td class="h">4733</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# delete userpic info object from memcache</td></tr>
<tr><td class="h">4734</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::Userpic-&gt;delete_cache($u);</td></tr>
<tr><td class="h">4735</td><td colspan="7"></td></tr><tr><td class="h">4736</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">4737</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4738</td><td colspan="7"></td></tr><tr><td class="h">4739</td><td colspan="7"></td></tr><tr><td class="h">4740</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub allpics_base {</td></tr>
<tr><td class="h">4741</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4741">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4742</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;journal_base . &quot;/icons&quot;;;</td></tr>
<tr><td class="h">4743</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4744</td><td colspan="7"></td></tr><tr><td class="h">4745</td><td colspan="7"></td></tr><tr><td class="h">4746</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_userpic_count {</td></tr>
<tr><td class="h">4747</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4747">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4747">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift or return undef;</td></tr>
<tr><td class="h">4748</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $count = scalar LJ::Userpic-&gt;load_user_userpics($u);</td></tr>
<tr><td class="h">4749</td><td colspan="7"></td></tr><tr><td class="h">4750</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $count;</td></tr>
<tr><td class="h">4751</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4752</td><td colspan="7"></td></tr><tr><td class="h">4753</td><td colspan="7"></td></tr><tr><td class="h">4754</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">4755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::User::mogfs_userpic_key</td></tr>
<tr><td class="h">4756</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: mogilefs</td></tr>
<tr><td class="h">4757</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Make a mogilefs key for the given pic for the user.</td></tr>
<tr><td class="h">4758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: pic</td></tr>
<tr><td class="h">4759</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-pic: Either the userpic hash or the picid of the userpic.</td></tr>
<tr><td class="h">4760</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1.</td></tr>
<tr><td class="h">4761</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">4762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mogfs_userpic_key {</td></tr>
<tr><td class="h">4763</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4763">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4763">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift or return undef;</td></tr>
<tr><td class="h">4764</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4764">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $pic = shift or croak &quot;missing required arg: userpic&quot;;</td></tr>
<tr><td class="h">4765</td><td colspan="7"></td></tr><tr><td class="h">4766</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4766">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $picid = ref $pic ? $pic-&gt;{picid} : $pic+0;</td></tr>
<tr><td class="h">4767</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;up:&quot; . $self-&gt;userid . &quot;:$picid&quot;;</td></tr>
<tr><td class="h">4768</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4769</td><td colspan="7"></td></tr><tr><td class="h">4770</td><td colspan="7"></td></tr><tr><td class="h">4771</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub userpic {</td></tr>
<tr><td class="h">4772</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4772">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4773</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4773">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u-&gt;{defaultpicid};</td></tr>
<tr><td class="h">4774</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Userpic-&gt;new($u, $u-&gt;{defaultpicid});</td></tr>
<tr><td class="h">4775</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4776</td><td colspan="7"></td></tr><tr><td class="h">4777</td><td colspan="7"></td></tr><tr><td class="h">4778</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub userpic_quota {</td></tr>
<tr><td class="h">4779</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4779">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4779">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift or return undef;</td></tr>
<tr><td class="h">4780</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $quota = $u-&gt;get_cap(&#39;userpics&#39;);</td></tr>
<tr><td class="h">4781</td><td colspan="7"></td></tr><tr><td class="h">4782</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $quota;</td></tr>
<tr><td class="h">4783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4784</td><td colspan="7"></td></tr><tr><td class="h">4785</td><td colspan="7"></td></tr><tr><td class="h">4786</td><td colspan="7"></td></tr><tr><td class="h">4787</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4788</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  99. Miscellaneous Legacy Items</td></tr>
<tr><td class="h">4789</td><td colspan="7"></td></tr><tr><td class="h">4790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return true if we know user is a minor (&lt; 18)</td></tr>
<tr><td class="h">4791</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_minor {</td></tr>
<tr><td class="h">4792</td><td><div class="c3">1206</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4792">1206</a></div></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $self = shift;</td></tr>
<tr><td class="h">4793</td><td><div class="c3">1206</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $age = $self-&gt;best_guess_age;</td></tr>
<tr><td class="h">4794</td><td><div class="c3">1206</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4794">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $age;</td></tr>
<tr><td class="h">4795</td><td><div class="c3">504</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4795">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if ($age &lt; 18);</td></tr>
<tr><td class="h">4796</td><td><div class="c3">504</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">4797</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4798</td><td colspan="7"></td></tr><tr><td class="h">4799</td><td colspan="7"></td></tr><tr><td class="h">4800</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4801</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  99B. Deprecated (FIXME: we shouldn&#39;t need these)</td></tr>
<tr><td class="h">4802</td><td colspan="7"></td></tr><tr><td class="h">4803</td><td colspan="7"></td></tr><tr><td class="h">4804</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># THIS IS DEPRECATED DO NOT USE</td></tr>
<tr><td class="h">4805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub email {</td></tr>
<tr><td class="h">4806</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4806">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $remote) = @_;</td></tr>
<tr><td class="h">4807</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;emails_visible($remote);</td></tr>
<tr><td class="h">4808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4809</td><td colspan="7"></td></tr><tr><td class="h">4810</td><td colspan="7"></td></tr><tr><td class="h">4811</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">*has_friend = \&amp;is_friend;</td></tr>
<tr><td class="h">4812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub is_friend {</td></tr>
<tr><td class="h">4813</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4813">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;LJ::User-&gt;is_friend is deprecated&#39;;</td></tr>
<tr><td class="h">4814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4815</td><td colspan="7"></td></tr><tr><td class="h">4816</td><td colspan="7"></td></tr><tr><td class="h">4817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub add_friend {</td></tr>
<tr><td class="h">4818</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4818">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;LJ::User-&gt;add_friend deprecated.&#39;;</td></tr>
<tr><td class="h">4819</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4820</td><td colspan="7"></td></tr><tr><td class="h">4821</td><td colspan="7"></td></tr><tr><td class="h">4822</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub remove_friend {</td></tr>
<tr><td class="h">4823</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4823">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;LJ::User-&gt;remove_friend has been deprecated.&#39;;</td></tr>
<tr><td class="h">4824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4825</td><td colspan="7"></td></tr><tr><td class="h">4826</td><td colspan="7"></td></tr><tr><td class="h">4827</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># take a user on dversion 7 and upgrade them to dversion 8 (clustered polls)</td></tr>
<tr><td class="h">4828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># DW doesn&#39;t support anything earlier than dversion 8, so this can</td></tr>
<tr><td class="h">4829</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># probably go away at some point.</td></tr>
<tr><td class="h">4830</td><td colspan="7"></td></tr><tr><td class="h">4831</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns if this user&#39;s polls are clustered</td></tr>
<tr><td class="h">4832</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># DW doesn&#39;t support anything earlier than dversion 8, so this can</td></tr>
<tr><td class="h">4833</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># probably go away at some point.</td></tr>
<tr><td class="h">4834</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub polls_clustered {</td></tr>
<tr><td class="h">4835</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4835">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4836</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;dversion &gt;= 8;</td></tr>
<tr><td class="h">4837</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4838</td><td colspan="7"></td></tr><tr><td class="h">4839</td><td colspan="7"></td></tr><tr><td class="h">4840</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub upgrade_to_dversion_8 {</td></tr>
<tr><td class="h">4841</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4841">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $u, $dbh, $dbhslo, $dbcm ) = @_;</td></tr>
<tr><td class="h">4842</td><td colspan="7"></td></tr><tr><td class="h">4843</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# If user has been purged, go ahead and update version</td></tr>
<tr><td class="h">4844</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Otherwise move their polls</td></tr>
<tr><td class="h">4845</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4845">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ok = $u-&gt;is_expunged ? 1 : LJ::Poll-&gt;make_polls_clustered($u, $dbh, $dbhslo, $dbcm);</td></tr>
<tr><td class="h">4846</td><td colspan="7"></td></tr><tr><td class="h">4847</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4847">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::update_user($u, { &#39;dversion&#39; =&gt; 8 }) if $ok;</td></tr>
<tr><td class="h">4848</td><td colspan="7"></td></tr><tr><td class="h">4849</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ok;</td></tr>
<tr><td class="h">4850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4851</td><td colspan="7"></td></tr><tr><td class="h">4852</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># FIXME: Needs updating for WTF</td></tr>
<tr><td class="h">4853</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub opt_showmutualfriends {</td></tr>
<tr><td class="h">4854</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4854">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4855</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4855">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;raw_prop(&#39;opt_showmutualfriends&#39;) ? 1 : 0;</td></tr>
<tr><td class="h">4856</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4857</td><td colspan="7"></td></tr><tr><td class="h">4858</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># FIXME: Needs updating for WTF</td></tr>
<tr><td class="h">4859</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># only certain journaltypes can show mutual friends</td></tr>
<tr><td class="h">4860</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub show_mutualfriends {</td></tr>
<tr><td class="h">4861</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4861">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">4862</td><td colspan="7"></td></tr><tr><td class="h">4863</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4863">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;is_individual;</td></tr>
<tr><td class="h">4864</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4864">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;opt_showmutualfriends ? 1 : 0;</td></tr>
<tr><td class="h">4865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4866</td><td colspan="7"></td></tr><tr><td class="h">4867</td><td colspan="7"></td></tr><tr><td class="h">4868</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># FIXME: Needs updating for our gift shop</td></tr>
<tr><td class="h">4869</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># after that, it goes in section 7</td></tr>
<tr><td class="h">4870</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the gift shop URL to buy a gift for that user</td></tr>
<tr><td class="h">4871</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub gift_url {</td></tr>
<tr><td class="h">4872</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4872">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$LJ::SITEROOT/shop/account?for=gift&quot;;</td></tr>
<tr><td class="h">4873</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4874</td><td colspan="7"></td></tr><tr><td class="h">4875</td><td colspan="7"></td></tr><tr><td class="h">4876</td><td colspan="7"></td></tr><tr><td class="h">4877</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### End LJ::User functions</td></tr>
<tr><td class="h">4879</td><td colspan="7"></td></tr><tr><td class="h">4880</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4881</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### Begin LJ functions</td></tr>
<tr><td class="h">4882</td><td colspan="7"></td></tr><tr><td class="h">4883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package LJ;</td></tr>
<tr><td class="h">4884</td><td colspan="7"></td></tr><tr><td class="h">4885</td><td><div class="c3">80</div><div class="c3">80</div><div class="c3">80</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4885">80</a></div></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">use Carp;</td></tr>
<tr><td class="h">4886</td><td colspan="7"></td></tr><tr><td class="h">4887</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4888</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### Please keep these categorized and alphabetized for ease of use. </td></tr>
<tr><td class="h">4889</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### If you need a new category, add it at the end, BEFORE category 99.</td></tr>
<tr><td class="h">4890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### Categories kinda fuzzy, but better than nothing. Weird numbers are</td></tr>
<tr><td class="h">4891</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### to match the sections above -- please check up there if adding.</td></tr>
<tr><td class="h">4892</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###</td></tr>
<tr><td class="h">4893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">### Categories:</td></tr>
<tr><td class="h">4894</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  1. Creating and Deleting Accounts</td></tr>
<tr><td class="h">4895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  3. Working with All Types of Accounts</td></tr>
<tr><td class="h">4896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  4. Login, Session, and Rename Functions</td></tr>
<tr><td class="h">4897</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  5. Database and Memcache Functions</td></tr>
<tr><td class="h">4898</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  6. What the App Shows to Users</td></tr>
<tr><td class="h">4899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  7. Userprops, Caps, and Displaying Content to Others</td></tr>
<tr><td class="h">4900</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  8. Formatting Content Shown to Users</td></tr>
<tr><td class="h">4901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  9. Logging and Recording Actions</td></tr>
<tr><td class="h">4902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  12. Comment-Related Functions</td></tr>
<tr><td class="h">4903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  13. Community-Related Functions and Authas</td></tr>
<tr><td class="h">4904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  15. Email-Related Functions</td></tr>
<tr><td class="h">4905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  16. Entry-Related Functions</td></tr>
<tr><td class="h">4906</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  17. Interest-Related Functions</td></tr>
<tr><td class="h">4907</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  19. OpenID and Identity Functions</td></tr>
<tr><td class="h">4908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  21. Password Functions</td></tr>
<tr><td class="h">4909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  22. Priv-Related Functions</td></tr>
<tr><td class="h">4910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  24. Styles and S2-Related Functions</td></tr>
<tr><td class="h">4911</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  28. Userpic-Related Functions</td></tr>
<tr><td class="h">4912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  99. Miscellaneous Legacy Items</td></tr>
<tr><td class="h">4913</td><td colspan="7"></td></tr><tr><td class="h">4914</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4915</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  1. Creating and Deleting Accounts</td></tr>
<tr><td class="h">4916</td><td colspan="7"></td></tr><tr><td class="h">4917</td><td colspan="7"></td></tr><tr><td class="h">4918</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">4919</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::create_account</td></tr>
<tr><td class="h">4920</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Creates a new basic account.  &lt;strong&gt;Note:&lt;/strong&gt; This function is</td></tr>
<tr><td class="h">4921</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      not really too useful but should be extended to be useful so</td></tr>
<tr><td class="h">4922</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      htdocs/create.bml can use it, rather than doing the work itself.</td></tr>
<tr><td class="h">4923</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: integer of userid created, or 0 on failure.</td></tr>
<tr><td class="h">4924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, opts</td></tr>
<tr><td class="h">4925</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: hashref containing keys &#39;user&#39;, &#39;name&#39;, &#39;password&#39;, &#39;email&#39;, &#39;caps&#39;, &#39;journaltype&#39;.</td></tr>
<tr><td class="h">4926</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">4927</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_account {</td></tr>
<tr><td class="h">4928</td><td><div class="c3">324</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4928">324</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">4929</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = shift;</td></tr>
<tr><td class="h">4930</td><td><div class="c3">324</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4930">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::User-&gt;create(%$opts)</td></tr>
<tr><td class="h">4931</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return 0;</td></tr>
<tr><td class="h">4932</td><td colspan="7"></td></tr><tr><td class="h">4933</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;id;</td></tr>
<tr><td class="h">4934</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4935</td><td colspan="7"></td></tr><tr><td class="h">4936</td><td colspan="7"></td></tr><tr><td class="h">4937</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">4938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::new_account_cluster</td></tr>
<tr><td class="h">4939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Which cluster to put a new account on.  $DEFAULT_CLUSTER if it&#39;s</td></tr>
<tr><td class="h">4940</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      a scalar, random element from [ljconfig[default_cluster]] if it&#39;s arrayref.</td></tr>
<tr><td class="h">4941</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      also verifies that the database seems to be available.</td></tr>
<tr><td class="h">4942</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: clusterid where the new account should be created; 0 on error</td></tr>
<tr><td class="h">4943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          (such as no clusters available).</td></tr>
<tr><td class="h">4944</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">4945</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub new_account_cluster</td></tr>
<tr><td class="h">4946</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">4947</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it&#39;s not an arrayref, put it in an array ref so we can use it below</td></tr>
<tr><td class="h">4948</td><td><div class="c3">324</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4948">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4948">324</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $clusters = ref $LJ::DEFAULT_CLUSTER ? $LJ::DEFAULT_CLUSTER : [ $LJ::DEFAULT_CLUSTER+0 ];</td></tr>
<tr><td class="h">4949</td><td colspan="7"></td></tr><tr><td class="h">4950</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# select a random cluster from the set we&#39;ve chosen in $LJ::DEFAULT_CLUSTER</td></tr>
<tr><td class="h">4951</td><td><div class="c3">324</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::random_cluster(@$clusters);</td></tr>
<tr><td class="h">4952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4953</td><td colspan="7"></td></tr><tr><td class="h">4954</td><td colspan="7"></td></tr><tr><td class="h">4955</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the clusterid of a random cluster which is up</td></tr>
<tr><td class="h">4956</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># -- accepts @clusters as an arg to enforce a subset, otherwise</td></tr>
<tr><td class="h">4957</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    uses @LJ::CLUSTERS</td></tr>
<tr><td class="h">4958</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub random_cluster {</td></tr>
<tr><td class="h">4959</td><td><div class="c3">326</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4959">100</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4959">326</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @clusters = @_ ? @_ : @LJ::CLUSTERS;</td></tr>
<tr><td class="h">4960</td><td colspan="7"></td></tr><tr><td class="h">4961</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# iterate through the new clusters from a random point</td></tr>
<tr><td class="h">4962</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $size = @clusters;</td></tr>
<tr><td class="h">4963</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $start = int(rand() * $size);</td></tr>
<tr><td class="h">4964</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (1..$size) {</td></tr>
<tr><td class="h">4965</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cid = $clusters[$start++ % $size];</td></tr>
<tr><td class="h">4966</td><td colspan="7"></td></tr><tr><td class="h">4967</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# verify that this cluster is in @LJ::CLUSTERS</td></tr>
<tr><td class="h">4968</td><td><div class="c3">326</div><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>4000</div><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @check = grep { $_ == $cid } @LJ::CLUSTERS;</td></tr>
<tr><td class="h">4969</td><td><div class="c3">326</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L4969">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L4969">33</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless scalar(@check) &gt;= 1 &amp;&amp; $check[0] == $cid;</td></tr>
<tr><td class="h">4970</td><td colspan="7"></td></tr><tr><td class="h">4971</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# try this cluster to see if we can use it, return if so</td></tr>
<tr><td class="h">4972</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = LJ::get_cluster_master($cid);</td></tr>
<tr><td class="h">4973</td><td><div class="c3">326</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4973">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $cid if $dbcm;</td></tr>
<tr><td class="h">4974</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">4975</td><td colspan="7"></td></tr><tr><td class="h">4976</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we get here, we found no clusters that were up...</td></tr>
<tr><td class="h">4977</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">4978</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">4979</td><td colspan="7"></td></tr><tr><td class="h">4980</td><td colspan="7"></td></tr><tr><td class="h">4981</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">4982</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  2. Working with All Types of Accounts</td></tr>
<tr><td class="h">4983</td><td colspan="7"></td></tr><tr><td class="h">4984</td><td colspan="7"></td></tr><tr><td class="h">4985</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">4986</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::canonical_username</td></tr>
<tr><td class="h">4987</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: normalizes username.</td></tr>
<tr><td class="h">4988</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info:</td></tr>
<tr><td class="h">4989</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: user</td></tr>
<tr><td class="h">4990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: the canonical username given, or blank if the username is not well-formed</td></tr>
<tr><td class="h">4991</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">4992</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub canonical_username</td></tr>
<tr><td class="h">4993</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">4994</td><td><div class="c3">504</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L4994">504</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $input = lc( $_[0] );</td></tr>
<tr><td class="h">4995</td><td><div class="c3">504</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = &quot;&quot;;</td></tr>
<tr><td class="h">4996</td><td><div class="c3">504</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L4996">50</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $input =~ /^\s*([a-z0-9_\-]{1,25})\s*$/ ) {  # good username</td></tr>
<tr><td class="h">4997</td><td><div class="c3">504</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user = $1;</td></tr>
<tr><td class="h">4998</td><td><div class="c3">504</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user =~ s/-/_/g;</td></tr>
<tr><td class="h">4999</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5000</td><td><div class="c3">504</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $user;</td></tr>
<tr><td class="h">5001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5002</td><td colspan="7"></td></tr><tr><td class="h">5003</td><td colspan="7"></td></tr><tr><td class="h">5004</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5005</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_userid</td></tr>
<tr><td class="h">5006</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Returns a userid given a username.</td></tr>
<tr><td class="h">5007</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: Results cached in memory.  On miss, does DB call.  Not advised</td></tr>
<tr><td class="h">5008</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       to use this many times in a row... only once or twice perhaps</td></tr>
<tr><td class="h">5009</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       per request.  Tons of serialized db requests, even when small,</td></tr>
<tr><td class="h">5010</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       are slow.  Opposite of [func[LJ::get_username]].</td></tr>
<tr><td class="h">5011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, user</td></tr>
<tr><td class="h">5012</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-user: Username whose userid to look up.</td></tr>
<tr><td class="h">5013</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Userid, or 0 if invalid user.</td></tr>
<tr><td class="h">5014</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_userid</td></tr>
<tr><td class="h">5016</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5017</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5017">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">5018</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = LJ::canonical_username( $_[0] );</td></tr>
<tr><td class="h">5019</td><td colspan="7"></td></tr><tr><td class="h">5020</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5020">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::CACHE_USERID{$user}) { return $LJ::CACHE_USERID{$user}; }</td></tr>
<tr><td class="h">5021</td><td colspan="7"></td></tr><tr><td class="h">5022</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = LJ::MemCache::get(&quot;uidof:$user&quot;);</td></tr>
<tr><td class="h">5023</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5023">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::CACHE_USERID{$user} = $userid if $userid;</td></tr>
<tr><td class="h">5024</td><td colspan="7"></td></tr><tr><td class="h">5025</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">5026</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$userid = $dbr-&gt;selectrow_array(&quot;SELECT userid FROM useridmap WHERE user=?&quot;, undef, $user);</td></tr>
<tr><td class="h">5027</td><td colspan="7"></td></tr><tr><td class="h">5028</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# implicitly create an account if we&#39;re using an external</td></tr>
<tr><td class="h">5029</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# auth mechanism</td></tr>
<tr><td class="h">5030</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5030">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5030">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (! $userid &amp;&amp; ref $LJ::AUTH_EXISTS eq &quot;CODE&quot;)</td></tr>
<tr><td class="h">5031</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">5032</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$userid = LJ::create_account({ &#39;user&#39; =&gt; $user,</td></tr>
<tr><td class="h">5033</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;name&#39; =&gt; $user,</td></tr>
<tr><td class="h">5034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;password&#39; =&gt; &#39;&#39;, });</td></tr>
<tr><td class="h">5035</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5036</td><td colspan="7"></td></tr><tr><td class="h">5037</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5037">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($userid) {</td></tr>
<tr><td class="h">5038</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::CACHE_USERID{$user} = $userid;</td></tr>
<tr><td class="h">5039</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set(&quot;uidof:$user&quot;, $userid);</td></tr>
<tr><td class="h">5040</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5041</td><td colspan="7"></td></tr><tr><td class="h">5042</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ($userid+0);</td></tr>
<tr><td class="h">5043</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5044</td><td colspan="7"></td></tr><tr><td class="h">5045</td><td colspan="7"></td></tr><tr><td class="h">5046</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5047</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_username</td></tr>
<tr><td class="h">5048</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Returns a username given a userid.</td></tr>
<tr><td class="h">5049</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: Results cached in memory.  On miss, does DB call.  Not advised</td></tr>
<tr><td class="h">5050</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       to use this many times in a row... only once or twice perhaps</td></tr>
<tr><td class="h">5051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       per request.  Tons of serialized db requests, even when small,</td></tr>
<tr><td class="h">5052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       are slow.  Opposite of [func[LJ::get_userid]].</td></tr>
<tr><td class="h">5053</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, user</td></tr>
<tr><td class="h">5054</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-user: Username whose userid to look up.</td></tr>
<tr><td class="h">5055</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Userid, or 0 if invalid user.</td></tr>
<tr><td class="h">5056</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_username</td></tr>
<tr><td class="h">5058</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5059</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5059">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">5060</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $_[0] + 0;</td></tr>
<tr><td class="h">5061</td><td colspan="7"></td></tr><tr><td class="h">5062</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Checked the cache first.</td></tr>
<tr><td class="h">5063</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5063">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::CACHE_USERNAME{$userid}) { return $LJ::CACHE_USERNAME{$userid}; }</td></tr>
<tr><td class="h">5064</td><td colspan="7"></td></tr><tr><td class="h">5065</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we&#39;re using memcache, it&#39;s faster to just query memcache for</td></tr>
<tr><td class="h">5066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# an entire $u object and just return the username.  otherwise, we&#39;ll</td></tr>
<tr><td class="h">5067</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# go ahead and query useridmap</td></tr>
<tr><td class="h">5068</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5068">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@LJ::MEMCACHE_SERVERS) {</td></tr>
<tr><td class="h">5069</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::load_userid($userid);</td></tr>
<tr><td class="h">5070</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5070">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u;</td></tr>
<tr><td class="h">5071</td><td colspan="7"></td></tr><tr><td class="h">5072</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::CACHE_USERNAME{$userid} = $u-&gt;user;</td></tr>
<tr><td class="h">5073</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;user;</td></tr>
<tr><td class="h">5074</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5075</td><td colspan="7"></td></tr><tr><td class="h">5076</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">5077</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = $dbr-&gt;selectrow_array(&quot;SELECT user FROM useridmap WHERE userid=?&quot;, undef, $userid);</td></tr>
<tr><td class="h">5078</td><td colspan="7"></td></tr><tr><td class="h">5079</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Fall back to master if it doesn&#39;t exist.</td></tr>
<tr><td class="h">5080</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5080">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (defined $user) {</td></tr>
<tr><td class="h">5081</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">5082</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user = $dbh-&gt;selectrow_array(&quot;SELECT user FROM useridmap WHERE userid=?&quot;, undef, $userid);</td></tr>
<tr><td class="h">5083</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5084</td><td colspan="7"></td></tr><tr><td class="h">5085</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5085">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless defined $user;</td></tr>
<tr><td class="h">5086</td><td colspan="7"></td></tr><tr><td class="h">5087</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::CACHE_USERNAME{$userid} = $user;</td></tr>
<tr><td class="h">5088</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $user;</td></tr>
<tr><td class="h">5089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5090</td><td colspan="7"></td></tr><tr><td class="h">5091</td><td colspan="7"></td></tr><tr><td class="h">5092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># is a user object (at least a hashref)</td></tr>
<tr><td class="h">5093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub isu {</td></tr>
<tr><td class="h">5094</td><td><div class="c3">10651</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5094">100</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5094">10651</a></div></td><td></td><td><div>56001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless ref $_[0];</td></tr>
<tr><td class="h">5095</td><td><div class="c3">9986</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5095">50</a></div></td><td></td><td></td><td></td><td><div>144012</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if UNIVERSAL::isa($_[0], &quot;LJ::User&quot;);</td></tr>
<tr><td class="h">5096</td><td colspan="7"></td></tr><tr><td class="h">5097</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5097">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5097">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref $_[0] eq &quot;HASH&quot; &amp;&amp; $_[0]-&gt;{userid}) {</td></tr>
<tr><td class="h">5098</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5098">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;carp &quot;User HASH objects are deprecated from use.&quot; if $LJ::IS_DEV_SERVER;</td></tr>
<tr><td class="h">5099</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">5100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5102</td><td colspan="7"></td></tr><tr><td class="h">5103</td><td colspan="7"></td></tr><tr><td class="h">5104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::load_user</td></tr>
<tr><td class="h">5106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Loads a user record, from the [dbtable[user]] table, given a username.</td></tr>
<tr><td class="h">5107</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, user, force?</td></tr>
<tr><td class="h">5108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-user: Username of user to load.</td></tr>
<tr><td class="h">5109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-force: if set to true, won&#39;t return cached user object and will</td></tr>
<tr><td class="h">5110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            query a dbh.</td></tr>
<tr><td class="h">5111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Hashref, with keys being columns of [dbtable[user]] table.</td></tr>
<tr><td class="h">5112</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_user</td></tr>
<tr><td class="h">5114</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5115</td><td><div class="c3">109</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5115">109</a></div></td><td></td><td><div>12002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">5116</td><td><div class="c3">109</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($user, $force) = @_;</td></tr>
<tr><td class="h">5117</td><td colspan="7"></td></tr><tr><td class="h">5118</td><td><div class="c3">109</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$user = LJ::canonical_username($user);</td></tr>
<tr><td class="h">5119</td><td><div class="c3">109</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5119">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless length $user;</td></tr>
<tr><td class="h">5120</td><td colspan="7"></td></tr><tr><td class="h">5121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $get_user = sub {</td></tr>
<tr><td class="h">5122</td><td><div class="c3">24</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5122">24</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $use_dbh = shift;</td></tr>
<tr><td class="h">5123</td><td><div class="c3">24</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5123">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = $use_dbh ? LJ::get_db_writer() : LJ::get_db_reader();</td></tr>
<tr><td class="h">5124</td><td><div class="c3">24</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5124">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = _load_user_raw($db, &quot;user&quot;, $user)</td></tr>
<tr><td class="h">5125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return undef;</td></tr>
<tr><td class="h">5126</td><td colspan="7"></td></tr><tr><td class="h">5127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# set caches since we got a u from the master</td></tr>
<tr><td class="h">5128</td><td><div class="c3">24</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5128">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_set_u($u) if $use_dbh;</td></tr>
<tr><td class="h">5129</td><td colspan="7"></td></tr><tr><td class="h">5130</td><td><div class="c3">24</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return _set_u_req_cache($u);</td></tr>
<tr><td class="h">5131</td><td><div class="c3">109</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">5132</td><td colspan="7"></td></tr><tr><td class="h">5133</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# caller is forcing a master, return now</td></tr>
<tr><td class="h">5134</td><td><div class="c3">109</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5134">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L5134">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $get_user-&gt;(&quot;master&quot;) if $force || $LJ::_PRAGMA_FORCE_MASTER;</td></tr>
<tr><td class="h">5135</td><td colspan="7"></td></tr><tr><td class="h">5136</td><td><div class="c3">103</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u;</td></tr>
<tr><td class="h">5137</td><td colspan="7"></td></tr><tr><td class="h">5138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return process cache if we have one</td></tr>
<tr><td class="h">5139</td><td><div class="c3">103</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5139">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u = $LJ::REQ_CACHE_USER_NAME{$user}) {</td></tr>
<tr><td class="h">5140</td><td><div class="c3">84</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;selfassert;</td></tr>
<tr><td class="h">5141</td><td><div class="c3">84</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">5142</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5143</td><td colspan="7"></td></tr><tr><td class="h">5144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check memcache</td></tr>
<tr><td class="h">5145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">5146</td><td><div class="c3">19</div><div class="c3">19</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $uid = LJ::MemCache::get(&quot;uidof:$user&quot;);</td></tr>
<tr><td class="h">5147</td><td><div class="c3">19</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5147">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::memcache_get_u([$uid, &quot;userid:$uid&quot;]) if $uid;</td></tr>
<tr><td class="h">5148</td><td><div class="c3">19</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5148">100</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return _set_u_req_cache($u) if $u;</td></tr>
<tr><td class="h">5149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5150</td><td colspan="7"></td></tr><tr><td class="h">5151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# try to load from master if using memcache, otherwise from slave</td></tr>
<tr><td class="h">5152</td><td><div class="c3">18</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = $get_user-&gt;(scalar @LJ::MEMCACHE_SERVERS);</td></tr>
<tr><td class="h">5153</td><td><div class="c3">18</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5153">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u if $u;</td></tr>
<tr><td class="h">5154</td><td colspan="7"></td></tr><tr><td class="h">5155</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# setup LDAP handler if this is the first time</td></tr>
<tr><td class="h">5156</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5156">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5156">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::LDAP_HOST &amp;&amp; ! $LJ::AUTH_EXISTS) {</td></tr>
<tr><td class="h">5157</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require LJ::LDAP;</td></tr>
<tr><td class="h">5158</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::AUTH_EXISTS = sub {</td></tr>
<tr><td class="h">5159</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5159">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $user = shift;</td></tr>
<tr><td class="h">5160</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rec = LJ::LDAP::load_ldap_user($user);</td></tr>
<tr><td class="h">5161</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5161">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $rec ? $rec : undef;</td></tr>
<tr><td class="h">5162</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">5163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5164</td><td colspan="7"></td></tr><tr><td class="h">5165</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if user doesn&#39;t exist in the LJ database, it&#39;s possible we&#39;re using</td></tr>
<tr><td class="h">5166</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# an external authentication source and we should create the account</td></tr>
<tr><td class="h">5167</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# implicitly.</td></tr>
<tr><td class="h">5168</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $lu;</td></tr>
<tr><td class="h">5169</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5169">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5169">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref $LJ::AUTH_EXISTS eq &quot;CODE&quot; &amp;&amp; ($lu = $LJ::AUTH_EXISTS-&gt;($user)))</td></tr>
<tr><td class="h">5170</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">5171</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5171">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5171">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $name = ref $lu eq &quot;HASH&quot; ? ($lu-&gt;{&#39;nick&#39;} || $lu-&gt;{name} || $user) : $user;</td></tr>
<tr><td class="h">5172</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5172">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5172">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::create_account({</td></tr>
<tr><td class="h">5173</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;user&#39; =&gt; $user,</td></tr>
<tr><td class="h">5174</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;name&#39; =&gt; $name,</td></tr>
<tr><td class="h">5175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;email&#39; =&gt; ref $lu eq &quot;HASH&quot; ? $lu-&gt;email_raw : &quot;&quot;,</td></tr>
<tr><td class="h">5176</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;password&#39; =&gt; &quot;&quot;,</td></tr>
<tr><td class="h">5177</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}))</td></tr>
<tr><td class="h">5178</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">5179</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# this should pull from the master, since it was _just_ created</td></tr>
<tr><td class="h">5180</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $get_user-&gt;(&quot;master&quot;);</td></tr>
<tr><td class="h">5181</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5182</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5183</td><td colspan="7"></td></tr><tr><td class="h">5184</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">5185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5186</td><td colspan="7"></td></tr><tr><td class="h">5187</td><td colspan="7"></td></tr><tr><td class="h">5188</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_user_or_identity {</td></tr>
<tr><td class="h">5189</td><td><div class="c3">4</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5189">4</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $arg = shift;</td></tr>
<tr><td class="h">5190</td><td colspan="7"></td></tr><tr><td class="h">5191</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $user = LJ::canonical_username($arg);</td></tr>
<tr><td class="h">5192</td><td><div class="c3">4</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5192">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::load_user($user) if $user;</td></tr>
<tr><td class="h">5193</td><td colspan="7"></td></tr><tr><td class="h">5194</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return undef if not dot in arg (can&#39;t be a URL)</td></tr>
<tr><td class="h">5195</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5195">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $arg =~ /\./;</td></tr>
<tr><td class="h">5196</td><td colspan="7"></td></tr><tr><td class="h">5197</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $url = lc($arg);</td></tr>
<tr><td class="h">5198</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5198">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$url = &quot;http://$url&quot; unless $url =~ m!^http://!;</td></tr>
<tr><td class="h">5199</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5199">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$url .= &quot;/&quot; unless $url =~ m!/$!;</td></tr>
<tr><td class="h">5200</td><td colspan="7"></td></tr><tr><td class="h">5201</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get from memcache</td></tr>
<tr><td class="h">5202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">5203</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# overload the uidof memcache key to accept both display name and name</td></tr>
<tr><td class="h">5204</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $uid = LJ::MemCache::get( &quot;uidof:$url&quot; );</td></tr>
<tr><td class="h">5205</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5205">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::memcache_get_u( [ $uid, &quot;userid:$uid&quot; ] ) if $uid;</td></tr>
<tr><td class="h">5206</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5206">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return _set_u_req_cache( $u ) if $u;</td></tr>
<tr><td class="h">5207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5208</td><td colspan="7"></td></tr><tr><td class="h">5209</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">5210</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $dbh-&gt;selectrow_array(&quot;SELECT userid FROM identitymap WHERE idtype=? AND identity=?&quot;,</td></tr>
<tr><td class="h">5211</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, &#39;O&#39;, $url);</td></tr>
<tr><td class="h">5212</td><td colspan="7"></td></tr><tr><td class="h">5213</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5213">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::load_userid($uid) if $uid;</td></tr>
<tr><td class="h">5214</td><td colspan="7"></td></tr><tr><td class="h">5215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set user in memcache</td></tr>
<tr><td class="h">5216</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5216">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $u ) {</td></tr>
<tr><td class="h">5217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# memcache URL-to-userid for identity users</td></tr>
<tr><td class="h">5218</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set( &quot;uidof:$url&quot;, $uid, 1800 );</td></tr>
<tr><td class="h">5219</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_set_u( $u );</td></tr>
<tr><td class="h">5220</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return _set_u_req_cache( $u );</td></tr>
<tr><td class="h">5221</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5222</td><td colspan="7"></td></tr><tr><td class="h">5223</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">5224</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5225</td><td colspan="7"></td></tr><tr><td class="h">5226</td><td colspan="7"></td></tr><tr><td class="h">5227</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5228</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::load_userid</td></tr>
<tr><td class="h">5229</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Loads a user record, from the [dbtable[user]] table, given a userid.</td></tr>
<tr><td class="h">5230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, userid, force?</td></tr>
<tr><td class="h">5231</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-userid: Userid of user to load.</td></tr>
<tr><td class="h">5232</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-force: if set to true, won&#39;t return cached user object and will</td></tr>
<tr><td class="h">5233</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            query a dbh</td></tr>
<tr><td class="h">5234</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Hashref with keys being columns of [dbtable[user]] table.</td></tr>
<tr><td class="h">5235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_userid</td></tr>
<tr><td class="h">5237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5238</td><td><div class="c3">5202</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5238">5202</a></div></td><td></td><td><div>24001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">5239</td><td><div class="c3">5202</div></td><td></td><td></td><td></td><td></td><td><div>16000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($userid, $force) = @_;</td></tr>
<tr><td class="h">5240</td><td><div class="c3">5202</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5240">100</a></div></td><td></td><td></td><td></td><td><div>28002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $userid;</td></tr>
<tr><td class="h">5241</td><td colspan="7"></td></tr><tr><td class="h">5242</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $get_user = sub {</td></tr>
<tr><td class="h">5243</td><td><div class="c3">339</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5243">339</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $use_dbh = shift;</td></tr>
<tr><td class="h">5244</td><td><div class="c3">339</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5244">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = $use_dbh ? LJ::get_db_writer() : LJ::get_db_reader();</td></tr>
<tr><td class="h">5245</td><td><div class="c3">339</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5245">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = _load_user_raw($db, &quot;userid&quot;, $userid)</td></tr>
<tr><td class="h">5246</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or return undef;</td></tr>
<tr><td class="h">5247</td><td colspan="7"></td></tr><tr><td class="h">5248</td><td><div class="c3">339</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5248">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_set_u($u) if $use_dbh;</td></tr>
<tr><td class="h">5249</td><td><div class="c3">339</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return _set_u_req_cache($u);</td></tr>
<tr><td class="h">5250</td><td><div class="c3">4572</div></td><td></td><td></td><td></td><td></td><td><div>76008</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">5251</td><td colspan="7"></td></tr><tr><td class="h">5252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user is forcing master, return now</td></tr>
<tr><td class="h">5253</td><td><div class="c3">4572</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5253">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L5253">100</a></div></td><td></td><td></td><td><div>40002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $get_user-&gt;(&quot;master&quot;) if $force || $LJ::_PRAGMA_FORCE_MASTER;</td></tr>
<tr><td class="h">5254</td><td colspan="7"></td></tr><tr><td class="h">5255</td><td><div class="c3">4240</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u;</td></tr>
<tr><td class="h">5256</td><td colspan="7"></td></tr><tr><td class="h">5257</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check process cache</td></tr>
<tr><td class="h">5258</td><td><div class="c3">4240</div></td><td></td><td></td><td></td><td></td><td><div>24000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = $LJ::REQ_CACHE_USER_ID{$userid};</td></tr>
<tr><td class="h">5259</td><td><div class="c3">4240</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5259">100</a></div></td><td></td><td></td><td></td><td><div>20001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u) {</td></tr>
<tr><td class="h">5260</td><td><div class="c3">4233</div></td><td></td><td></td><td></td><td></td><td><div>24000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;selfassert;</td></tr>
<tr><td class="h">5261</td><td><div class="c3">4233</div></td><td></td><td></td><td></td><td></td><td><div>32002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">5262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5263</td><td colspan="7"></td></tr><tr><td class="h">5264</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check memcache</td></tr>
<tr><td class="h">5265</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::memcache_get_u([$userid,&quot;userid:$userid&quot;]);</td></tr>
<tr><td class="h">5266</td><td><div class="c3">7</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5266">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return _set_u_req_cache($u) if $u;</td></tr>
<tr><td class="h">5267</td><td colspan="7"></td></tr><tr><td class="h">5268</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get from master if using memcache</td></tr>
<tr><td class="h">5269</td><td><div class="c3">7</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5269">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $get_user-&gt;(&quot;master&quot;) if @LJ::MEMCACHE_SERVERS;</td></tr>
<tr><td class="h">5270</td><td colspan="7"></td></tr><tr><td class="h">5271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check slave</td></tr>
<tr><td class="h">5272</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = $get_user-&gt;();</td></tr>
<tr><td class="h">5273</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5273">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u if $u;</td></tr>
<tr><td class="h">5274</td><td colspan="7"></td></tr><tr><td class="h">5275</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we didn&#39;t get a u from the reader, fall back to master</td></tr>
<tr><td class="h">5276</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $get_user-&gt;(&quot;master&quot;);</td></tr>
<tr><td class="h">5277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5278</td><td colspan="7"></td></tr><tr><td class="h">5279</td><td colspan="7"></td></tr><tr><td class="h">5280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::load_userids</td></tr>
<tr><td class="h">5282</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Simple interface to [func[LJ::load_userids_multiple]].</td></tr>
<tr><td class="h">5283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: userids</td></tr>
<tr><td class="h">5284</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: hashref with keys ids, values $u refs.</td></tr>
<tr><td class="h">5285</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5286</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_userids</td></tr>
<tr><td class="h">5287</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5288</td><td><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5288">15</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %u;</td></tr>
<tr><td class="h">5289</td><td><div class="c3">15</div><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userids_multiple([ map { $_ =&gt; \$u{$_} } @_ ]);</td></tr>
<tr><td class="h">5290</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \%u;</td></tr>
<tr><td class="h">5291</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5292</td><td colspan="7"></td></tr><tr><td class="h">5293</td><td colspan="7"></td></tr><tr><td class="h">5294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5295</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::load_userids_multiple</td></tr>
<tr><td class="h">5296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Loads a number of users at once, efficiently.</td></tr>
<tr><td class="h">5297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: loads a few users at once, their userids given in the keys of $map</td></tr>
<tr><td class="h">5298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       listref (not hashref: can&#39;t have dups).  values of $map listref are</td></tr>
<tr><td class="h">5299</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       scalar refs to put result in.  $have is an optional listref of user</td></tr>
<tr><td class="h">5300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       object caller already has, but is too lazy to sort by themselves.</td></tr>
<tr><td class="h">5301</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       &lt;strong&gt;Note&lt;/strong&gt;: The $have parameter is deprecated,</td></tr>
<tr><td class="h">5302</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       as is $memcache_only; but it is still preserved for now.</td></tr>
<tr><td class="h">5303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       Really, this whole API (i.e. LJ::load_userids_multiple) is clumsy.</td></tr>
<tr><td class="h">5304</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       Use [func[LJ::load_userids]] instead.</td></tr>
<tr><td class="h">5305</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, map, have, memcache_only?</td></tr>
<tr><td class="h">5306</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-map: Arrayref of pairs (userid, destination scalarref).</td></tr>
<tr><td class="h">5307</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-have: Arrayref of user objects caller already has.</td></tr>
<tr><td class="h">5308</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-memcache_only: Flag to only retrieve data from memcache.</td></tr>
<tr><td class="h">5309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Nothing.</td></tr>
<tr><td class="h">5310</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_userids_multiple</td></tr>
<tr><td class="h">5312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5313</td><td><div class="c3">15</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5313">15</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">5314</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the $have parameter is deprecated, as is $memcache_only, but it&#39;s still preserved for now.</td></tr>
<tr><td class="h">5315</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# actually this whole API is crap.  use LJ::load_userids() instead.</td></tr>
<tr><td class="h">5316</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($map, undef, $memcache_only) = @_;</td></tr>
<tr><td class="h">5317</td><td colspan="7"></td></tr><tr><td class="h">5318</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth;</td></tr>
<tr><td class="h">5319</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @have;</td></tr>
<tr><td class="h">5320</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %need;</td></tr>
<tr><td class="h">5321</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (@$map) {</td></tr>
<tr><td class="h">5322</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $id = shift @$map;</td></tr>
<tr><td class="h">5323</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ref = shift @$map;</td></tr>
<tr><td class="h">5324</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5324">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless int($id);</td></tr>
<tr><td class="h">5325</td><td><div class="c3">12</div><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$need{$id}}, $ref;</td></tr>
<tr><td class="h">5326</td><td colspan="7"></td></tr><tr><td class="h">5327</td><td><div class="c3">12</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5327">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::REQ_CACHE_USER_ID{$id}) {</td></tr>
<tr><td class="h">5328</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @have, $LJ::REQ_CACHE_USER_ID{$id};</td></tr>
<tr><td class="h">5329</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5330</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5331</td><td colspan="7"></td></tr><tr><td class="h">5332</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $satisfy = sub {</td></tr>
<tr><td class="h">5333</td><td><div class="c3">12</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5333">12</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">5334</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5334">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless ref $u eq &quot;LJ::User&quot;;</td></tr>
<tr><td class="h">5335</td><td colspan="7"></td></tr><tr><td class="h">5336</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# this could change the $u returned to an</td></tr>
<tr><td class="h">5337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# existing one we already have loaded in memory,</td></tr>
<tr><td class="h">5338</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# once it&#39;s been upgraded.  then everybody points</td></tr>
<tr><td class="h">5339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# to the same one.</td></tr>
<tr><td class="h">5340</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u = _set_u_req_cache($u);</td></tr>
<tr><td class="h">5341</td><td colspan="7"></td></tr><tr><td class="h">5342</td><td><div class="c3">12</div><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ( @{$need{$u-&gt;userid}} ) {</td></tr>
<tr><td class="h">5343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# check if existing target is defined and not what we already have.</td></tr>
<tr><td class="h">5344</td><td><div class="c3">12</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5344">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $eu = $$_) {</td></tr>
<tr><td class="h">5345</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::assert_is( $u-&gt;userid, $eu-&gt;userid );</td></tr>
<tr><td class="h">5346</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5347</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$_ = $u;</td></tr>
<tr><td class="h">5348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5349</td><td colspan="7"></td></tr><tr><td class="h">5350</td><td><div class="c3">12</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $need{$u-&gt;userid};</td></tr>
<tr><td class="h">5351</td><td><div class="c3">15</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">5352</td><td colspan="7"></td></tr><tr><td class="h">5353</td><td><div class="c3">15</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5353">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($LJ::_PRAGMA_FORCE_MASTER) {</td></tr>
<tr><td class="h">5354</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $u (@have) {</td></tr>
<tr><td class="h">5355</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$satisfy-&gt;($u);</td></tr>
<tr><td class="h">5356</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5357</td><td colspan="7"></td></tr><tr><td class="h">5358</td><td><div class="c3">5</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5358">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (%need) {</td></tr>
<tr><td class="h">5359</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (LJ::memcache_get_u(map { [$_,&quot;userid:$_&quot;] } keys %need)) {</td></tr>
<tr><td class="h">5360</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$satisfy-&gt;($_);</td></tr>
<tr><td class="h">5361</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5363</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5364</td><td colspan="7"></td></tr><tr><td class="h">5365</td><td><div class="c3">15</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5365">100</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5365">67</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%need &amp;&amp; ! $memcache_only) {</td></tr>
<tr><td class="h">5366</td><td><div class="c3">10</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5366">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5366">67</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = @LJ::MEMCACHE_SERVERS || $LJ::_PRAGMA_FORCE_MASTER ?</td></tr>
<tr><td class="h">5367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::get_db_writer() : LJ::get_db_reader();</td></tr>
<tr><td class="h">5368</td><td colspan="7"></td></tr><tr><td class="h">5369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_load_user_raw($db, &quot;userid&quot;, [ keys %need ], sub {</td></tr>
<tr><td class="h">5370</td><td><div class="c3">10</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5370">10</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">5371</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_set_u($u);</td></tr>
<tr><td class="h">5372</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$satisfy-&gt;($u);</td></tr>
<tr><td class="h">5373</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">5374</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5375</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5376</td><td colspan="7"></td></tr><tr><td class="h">5377</td><td colspan="7"></td></tr><tr><td class="h">5378</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5379</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::make_user_active</td></tr>
<tr><td class="h">5380</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des:  Record user activity per cluster, on [dbtable[clustertrack2]], to</td></tr>
<tr><td class="h">5381</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       make per-activity cluster stats easier.</td></tr>
<tr><td class="h">5382</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: userid, type</td></tr>
<tr><td class="h">5383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-userid: source userobj ref</td></tr>
<tr><td class="h">5384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-type: currently unused</td></tr>
<tr><td class="h">5385</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5386</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub mark_user_active {</td></tr>
<tr><td class="h">5387</td><td><div class="c3">248</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5387">248</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $type) = @_;  # not currently using type</td></tr>
<tr><td class="h">5388</td><td><div class="c3">248</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5388">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u;   # do not auto-vivify $u</td></tr>
<tr><td class="h">5389</td><td><div class="c3">38</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $u-&gt;userid;</td></tr>
<tr><td class="h">5390</td><td><div class="c3">38</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5390">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5390">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $uid &amp;&amp; $u-&gt;clusterid;</td></tr>
<tr><td class="h">5391</td><td colspan="7"></td></tr><tr><td class="h">5392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Update the clustertrack2 table, but not if we&#39;ve done it for this</td></tr>
<tr><td class="h">5393</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user in the last hour.  if no memcache servers are configured</td></tr>
<tr><td class="h">5394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we don&#39;t do the optimization and just always log the activity info</td></tr>
<tr><td class="h">5395</td><td><div class="c3">38</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5395">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L5395">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@LJ::MEMCACHE_SERVERS == 0 ||</td></tr>
<tr><td class="h">5396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add(&quot;rate:tracked:$uid&quot;, 1, 3600)) {</td></tr>
<tr><td class="h">5397</td><td colspan="7"></td></tr><tr><td class="h">5398</td><td><div class="c3">11</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5398">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;writer;</td></tr>
<tr><td class="h">5399</td><td><div class="c3">11</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $active = time();</td></tr>
<tr><td class="h">5400</td><td><div class="c3">11</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5400">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;REPLACE INTO clustertrack2 SET &quot;.</td></tr>
<tr><td class="h">5401</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;userid=?, timeactive=?, clusterid=?&quot;, undef,</td></tr>
<tr><td class="h">5402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uid, $active, $u-&gt;clusterid) or return 0;</td></tr>
<tr><td class="h">5403</td><td><div class="c3">11</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;userid, &quot;timeactive:&quot; . $u-&gt;userid];</td></tr>
<tr><td class="h">5404</td><td><div class="c3">11</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $active, 86400);</td></tr>
<tr><td class="h">5405</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5406</td><td><div class="c3">38</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">5407</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5408</td><td colspan="7"></td></tr><tr><td class="h">5409</td><td colspan="7"></td></tr><tr><td class="h">5410</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::u_equals</td></tr>
<tr><td class="h">5412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Compares two user objects to see if they are the same user.</td></tr>
<tr><td class="h">5413</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: userobj1, userobj2</td></tr>
<tr><td class="h">5414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-userobj1: First user to compare.</td></tr>
<tr><td class="h">5415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-userobj2: Second user to compare.</td></tr>
<tr><td class="h">5416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: Boolean, true if userobj1 and userobj2 are defined and have equal userids.</td></tr>
<tr><td class="h">5417</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5418</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub u_equals {</td></tr>
<tr><td class="h">5419</td><td><div class="c3">296</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5419">296</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u1, $u2) = @_;</td></tr>
<tr><td class="h">5420</td><td><div class="c3">296</div></td><td></td><td><div class="c1"><a href="cgi-bin-LJ-User-pm--condition.html#L5420">75</a></div></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u1 &amp;&amp; $u2 &amp;&amp; $u1-&gt;userid == $u2-&gt;userid;</td></tr>
<tr><td class="h">5421</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5422</td><td colspan="7"></td></tr><tr><td class="h">5423</td><td colspan="7"></td></tr><tr><td class="h">5424</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::want_user</td></tr>
<tr><td class="h">5426</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Returns user object when passed either userid or user object. Useful to functions that</td></tr>
<tr><td class="h">5427</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      want to accept either.</td></tr>
<tr><td class="h">5428</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: user</td></tr>
<tr><td class="h">5429</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-user: Either a userid or a user hash with the userid in its &#39;userid&#39; key.</td></tr>
<tr><td class="h">5430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: The user object represented by said userid or username.</td></tr>
<tr><td class="h">5431</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub want_user</td></tr>
<tr><td class="h">5433</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5434</td><td><div class="c3">1110</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5434">1110</a></div></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uuid = shift;</td></tr>
<tr><td class="h">5435</td><td><div class="c3">1110</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5435">100</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $uuid;</td></tr>
<tr><td class="h">5436</td><td><div class="c3">1107</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5436">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $uuid if ref $uuid;</td></tr>
<tr><td class="h">5437</td><td><div class="c3">23</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5437">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::load_userid($uuid) if $uuid =~ /^\d+$/;</td></tr>
<tr><td class="h">5438</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;Carp::croak(&quot;Bogus caller of LJ::want_user with non-ref/non-numeric parameter&quot;);</td></tr>
<tr><td class="h">5439</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5440</td><td colspan="7"></td></tr><tr><td class="h">5441</td><td colspan="7"></td></tr><tr><td class="h">5442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5443</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::want_userid</td></tr>
<tr><td class="h">5444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Returns userid when passed either userid or the user hash. Useful to functions that</td></tr>
<tr><td class="h">5445</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      want to accept either. Forces its return value to be a number (for safety).</td></tr>
<tr><td class="h">5446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: userid</td></tr>
<tr><td class="h">5447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-userid: Either a userid, or a user hash with the userid in its &#39;userid&#39; key.</td></tr>
<tr><td class="h">5448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: The userid, guaranteed to be a numeric value.</td></tr>
<tr><td class="h">5449</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5450</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub want_userid</td></tr>
<tr><td class="h">5451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5452</td><td><div class="c3">3975</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5452">3975</a></div></td><td></td><td><div>12000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uuserid = shift;</td></tr>
<tr><td class="h">5453</td><td><div class="c3">3975</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5453">100</a></div></td><td></td><td></td><td></td><td><div>48005</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ($uuserid-&gt;{userid} + 0) if ref $uuserid;</td></tr>
<tr><td class="h">5454</td><td><div class="c3">2012</div></td><td></td><td></td><td></td><td></td><td><div>12000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return ($uuserid + 0);</td></tr>
<tr><td class="h">5455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5456</td><td colspan="7"></td></tr><tr><td class="h">5457</td><td colspan="7"></td></tr><tr><td class="h">5458</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">5459</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  3. Login, Session, and Rename Functions</td></tr>
<tr><td class="h">5460</td><td colspan="7"></td></tr><tr><td class="h">5461</td><td colspan="7"></td></tr><tr><td class="h">5462</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns the country that the remote IP address comes from</td></tr>
<tr><td class="h">5463</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># undef is returned if the country cannot be determined from the IP</td></tr>
<tr><td class="h">5464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub country_of_remote_ip {</td></tr>
<tr><td class="h">5465</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5465">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5465">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (eval &quot;use IP::Country::Fast; 1;&quot;) {</td></tr>
<tr><td class="h">5466</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ip = LJ::get_remote_ip();</td></tr>
<tr><td class="h">5467</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5467">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $ip;</td></tr>
<tr><td class="h">5468</td><td colspan="7"></td></tr><tr><td class="h">5469</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $reg = IP::Country::Fast-&gt;new();</td></tr>
<tr><td class="h">5470</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $country = $reg-&gt;inet_atocc($ip);</td></tr>
<tr><td class="h">5471</td><td colspan="7"></td></tr><tr><td class="h">5472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &quot;**&quot; is returned if the IP is private</td></tr>
<tr><td class="h">5473</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5473">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef if $country eq &quot;**&quot;;</td></tr>
<tr><td class="h">5474</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $country;</td></tr>
<tr><td class="h">5475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5476</td><td colspan="7"></td></tr><tr><td class="h">5477</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">5478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5479</td><td colspan="7"></td></tr><tr><td class="h">5480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
<tr><td class="h">5481</td><td colspan="7"></td></tr><tr><td class="h">5482</td><td colspan="7"></td></tr><tr><td class="h">5483</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_active_journal</td></tr>
<tr><td class="h">5484</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5485</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5485">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::ACTIVE_JOURNAL;</td></tr>
<tr><td class="h">5486</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5487</td><td colspan="7"></td></tr><tr><td class="h">5488</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns either $remote or the authenticated user that $remote is working with</td></tr>
<tr><td class="h">5489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_effective_remote {</td></tr>
<tr><td class="h">5490</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5490">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5490">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $authas_arg = shift || &quot;authas&quot;;</td></tr>
<tr><td class="h">5491</td><td colspan="7"></td></tr><tr><td class="h">5492</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5492">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::is_web_context();</td></tr>
<tr><td class="h">5493</td><td colspan="7"></td></tr><tr><td class="h">5494</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">5495</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5495">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $remote;</td></tr>
<tr><td class="h">5496</td><td colspan="7"></td></tr><tr><td class="h">5497</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5497">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $authas = $BMLCodeBlock::GET{authas} || $BMLCodeBlock::POST{authas} || $remote-&gt;user;</td></tr>
<tr><td class="h">5498</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5498">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $remote if $authas eq $remote-&gt;user;</td></tr>
<tr><td class="h">5499</td><td colspan="7"></td></tr><tr><td class="h">5500</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::get_authas_user($authas);</td></tr>
<tr><td class="h">5501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5502</td><td colspan="7"></td></tr><tr><td class="h">5503</td><td colspan="7"></td></tr><tr><td class="h">5504</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_remote</td></tr>
<tr><td class="h">5506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: authenticates the user at the remote end based on their cookies</td></tr>
<tr><td class="h">5507</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      and returns a hashref representing them.</td></tr>
<tr><td class="h">5508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: opts?</td></tr>
<tr><td class="h">5509</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: &#39;criterr&#39;: scalar ref to set critical error flag.  if set, caller</td></tr>
<tr><td class="h">5510</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           should stop processing whatever it&#39;s doing and complain</td></tr>
<tr><td class="h">5511</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           about an invalid login with a link to the logout page.</td></tr>
<tr><td class="h">5512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           &#39;ignore_ip&#39;: ignore IP address of remote for IP-bound sessions</td></tr>
<tr><td class="h">5513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: hashref containing &#39;user&#39; and &#39;userid&#39; if valid user, else</td></tr>
<tr><td class="h">5514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          undef.</td></tr>
<tr><td class="h">5515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5516</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_remote</td></tr>
<tr><td class="h">5517</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5518</td><td><div class="c3">1974</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5518">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5518">1974</a></div></td><td></td><td><div>20001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = ref $_[0] eq &quot;HASH&quot; ? shift : {};</td></tr>
<tr><td class="h">5519</td><td><div class="c3">1974</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5519">100</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5519">67</a></div></td><td></td><td></td><td><div>36002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::CACHE_REMOTE if $LJ::CACHED_REMOTE &amp;&amp; ! $opts-&gt;{&#39;ignore_ip&#39;};</td></tr>
<tr><td class="h">5520</td><td colspan="7"></td></tr><tr><td class="h">5521</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $no_remote = sub {</td></tr>
<tr><td class="h">5522</td><td><div class="c3">26</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5522">26</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::User-&gt;set_remote(undef);</td></tr>
<tr><td class="h">5523</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">5524</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">5525</td><td colspan="7"></td></tr><tr><td class="h">5526</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t have a remote user outside of web context</td></tr>
<tr><td class="h">5527</td><td><div class="c3">26</div><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $r = eval { BML::get_request(); };</td></tr>
<tr><td class="h">5528</td><td><div class="c3">26</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5528">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $no_remote-&gt;() unless $r;</td></tr>
<tr><td class="h">5529</td><td colspan="7"></td></tr><tr><td class="h">5530</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5530">0</a></div></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $criterr = $opts-&gt;{criterr} || do { my $d; \$d; };</td></tr>
<tr><td class="h">5531</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$criterr = 0;</td></tr>
<tr><td class="h">5532</td><td colspan="7"></td></tr><tr><td class="h">5533</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::CACHE_REMOTE_BOUNCE_URL = &quot;&quot;;</td></tr>
<tr><td class="h">5534</td><td colspan="7"></td></tr><tr><td class="h">5535</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set this flag if any of their ljsession cookies contained the &quot;.FS&quot;</td></tr>
<tr><td class="h">5536</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# opt to use the fast server.  if we later find they&#39;re not logged</td></tr>
<tr><td class="h">5537</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# in and set it, or set it with a free account, then we give them</td></tr>
<tr><td class="h">5538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the invalid cookies error.</td></tr>
<tr><td class="h">5539</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $tried_fast = 0;</td></tr>
<tr><td class="h">5540</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sessobj = LJ::Session-&gt;session_from_cookies(tried_fast   =&gt; \$tried_fast,</td></tr>
<tr><td class="h">5541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;redirect_ref =&gt; \$LJ::CACHE_REMOTE_BOUNCE_URL,</td></tr>
<tr><td class="h">5542</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore_ip    =&gt; $opts-&gt;{ignore_ip},</td></tr>
<tr><td class="h">5543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">5544</td><td colspan="7"></td></tr><tr><td class="h">5545</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5545">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $sessobj ? $sessobj-&gt;owner : undef;</td></tr>
<tr><td class="h">5546</td><td colspan="7"></td></tr><tr><td class="h">5547</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# inform the caller that this user is faking their fast-server cookie</td></tr>
<tr><td class="h">5548</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# attribute.</td></tr>
<tr><td class="h">5549</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5549">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5549">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($tried_fast &amp;&amp; ! LJ::get_cap($u, &quot;fastserver&quot;)) {</td></tr>
<tr><td class="h">5550</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$criterr = 1;</td></tr>
<tr><td class="h">5551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5552</td><td colspan="7"></td></tr><tr><td class="h">5553</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5553">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $no_remote-&gt;() unless $sessobj;</td></tr>
<tr><td class="h">5554</td><td colspan="7"></td></tr><tr><td class="h">5555</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# renew soon-to-expire sessions</td></tr>
<tr><td class="h">5556</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sessobj-&gt;try_renew;</td></tr>
<tr><td class="h">5557</td><td colspan="7"></td></tr><tr><td class="h">5558</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# augment hash with session data;</td></tr>
<tr><td class="h">5559</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{&#39;_session&#39;} = $sessobj;</td></tr>
<tr><td class="h">5560</td><td colspan="7"></td></tr><tr><td class="h">5561</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# keep track of activity for the user we just loaded from db/memcache</td></tr>
<tr><td class="h">5562</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# - if necessary, this code will actually run in Apache&#39;s cleanup handler</td></tr>
<tr><td class="h">5563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#   so latency won&#39;t affect the user</td></tr>
<tr><td class="h">5564</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5564">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5564">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( @LJ::MEMCACHE_SERVERS &amp;&amp; LJ::is_enabled(&#39;active_user_tracking&#39;) ) {</td></tr>
<tr><td class="h">5565</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5565">0</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @LJ::CLEANUP_HANDLERS, sub { $u-&gt;note_activity(&#39;A&#39;) };</td></tr>
<tr><td class="h">5566</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5567</td><td colspan="7"></td></tr><tr><td class="h">5568</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::User-&gt;set_remote($u);</td></tr>
<tr><td class="h">5569</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;notes-&gt;{ljuser} = $u-&gt;user;</td></tr>
<tr><td class="h">5570</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">5571</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5572</td><td colspan="7"></td></tr><tr><td class="h">5573</td><td colspan="7"></td></tr><tr><td class="h">5574</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub handle_bad_login</td></tr>
<tr><td class="h">5575</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5576</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5576">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $ip) = @_;</td></tr>
<tr><td class="h">5577</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5577">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $u;</td></tr>
<tr><td class="h">5578</td><td colspan="7"></td></tr><tr><td class="h">5579</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5579">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ip ||= LJ::get_remote_ip();</td></tr>
<tr><td class="h">5580</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5580">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $ip;</td></tr>
<tr><td class="h">5581</td><td colspan="7"></td></tr><tr><td class="h">5582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# an IP address is permitted such a rate of failures</td></tr>
<tr><td class="h">5583</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# until it&#39;s banned for a period of time.</td></tr>
<tr><td class="h">5584</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $udbh;</td></tr>
<tr><td class="h">5585</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5585">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5585">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (! LJ::rate_log($u, &quot;failed_login&quot;, 1, { &#39;limit_by_ip&#39; =&gt; $ip }) &amp;&amp;</td></tr>
<tr><td class="h">5586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($udbh = LJ::get_cluster_master($u)))</td></tr>
<tr><td class="h">5587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">5588</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$udbh-&gt;do(&quot;REPLACE INTO loginstall (userid, ip, time) VALUES &quot;.</td></tr>
<tr><td class="h">5589</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;(?,INET_ATON(?),UNIX_TIMESTAMP())&quot;, undef, $u-&gt;userid, $ip);</td></tr>
<tr><td class="h">5590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5591</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">5592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5593</td><td colspan="7"></td></tr><tr><td class="h">5594</td><td colspan="7"></td></tr><tr><td class="h">5595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub login_ip_banned</td></tr>
<tr><td class="h">5596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5597</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5597">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $ip) = @_;</td></tr>
<tr><td class="h">5598</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5598">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u;</td></tr>
<tr><td class="h">5599</td><td colspan="7"></td></tr><tr><td class="h">5600</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5600">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ip ||= LJ::get_remote_ip();</td></tr>
<tr><td class="h">5601</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5601">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $ip;</td></tr>
<tr><td class="h">5602</td><td colspan="7"></td></tr><tr><td class="h">5603</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $udbr;</td></tr>
<tr><td class="h">5604</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rateperiod = LJ::get_cap($u, &quot;rateperiod-failed_login&quot;);</td></tr>
<tr><td class="h">5605</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5605">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5605">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($rateperiod &amp;&amp; ($udbr = LJ::get_cluster_reader($u))) {</td></tr>
<tr><td class="h">5606</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $bantime = $udbr-&gt;selectrow_array( &quot;SELECT time FROM loginstall WHERE &quot;.</td></tr>
<tr><td class="h">5607</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;userid=? AND ip=INET_ATON(?)&quot;,</td></tr>
<tr><td class="h">5608</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;userid, $ip );</td></tr>
<tr><td class="h">5609</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5609">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5609">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($bantime &amp;&amp; $bantime &gt; time() - $rateperiod) {</td></tr>
<tr><td class="h">5610</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">5611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5613</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">5614</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5615</td><td colspan="7"></td></tr><tr><td class="h">5616</td><td colspan="7"></td></tr><tr><td class="h">5617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns URL we have to bounce the remote user to in order to</td></tr>
<tr><td class="h">5618</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># get their domain cookie</td></tr>
<tr><td class="h">5619</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub remote_bounce_url {</td></tr>
<tr><td class="h">5620</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5620">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::CACHE_REMOTE_BOUNCE_URL;</td></tr>
<tr><td class="h">5621</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5622</td><td colspan="7"></td></tr><tr><td class="h">5623</td><td colspan="7"></td></tr><tr><td class="h">5624</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_active_journal</td></tr>
<tr><td class="h">5625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5626</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5626">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::ACTIVE_JOURNAL = shift;</td></tr>
<tr><td class="h">5627</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5628</td><td colspan="7"></td></tr><tr><td class="h">5629</td><td colspan="7"></td></tr><tr><td class="h">5630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_remote {</td></tr>
<tr><td class="h">5631</td><td><div class="c3">16</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5631">16</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = shift;</td></tr>
<tr><td class="h">5632</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::User-&gt;set_remote($remote);</td></tr>
<tr><td class="h">5633</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;1;</td></tr>
<tr><td class="h">5634</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5635</td><td colspan="7"></td></tr><tr><td class="h">5636</td><td colspan="7"></td></tr><tr><td class="h">5637</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub unset_remote</td></tr>
<tr><td class="h">5638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5639</td><td><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5639">8</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::User-&gt;unset_remote;</td></tr>
<tr><td class="h">5640</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;1;</td></tr>
<tr><td class="h">5641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5642</td><td colspan="7"></td></tr><tr><td class="h">5643</td><td colspan="7"></td></tr><tr><td class="h">5644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">5645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  5. Database and Memcache Functions</td></tr>
<tr><td class="h">5646</td><td colspan="7"></td></tr><tr><td class="h">5647</td><td colspan="7"></td></tr><tr><td class="h">5648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $dom: &#39;L&#39; == log, &#39;T&#39; == talk, &#39;M&#39; == modlog, &#39;S&#39; == session,</td></tr>
<tr><td class="h">5649</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       &#39;R&#39; == memory (remembrance), &#39;K&#39; == keyword id,</td></tr>
<tr><td class="h">5650</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       &#39;P&#39; == phone post, &#39;C&#39; == pending comment</td></tr>
<tr><td class="h">5651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       &#39;V&#39; == &#39;vgift&#39;, &#39;E&#39; == ESN subscription id</td></tr>
<tr><td class="h">5652</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       &#39;Q&#39; == Notification Inbox, </td></tr>
<tr><td class="h">5653</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       &#39;D&#39; == &#39;moDule embed contents&#39;, &#39;I&#39; == Import data block</td></tr>
<tr><td class="h">5654</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       &#39;Z&#39; == import status item, &#39;X&#39; == eXternal account</td></tr>
<tr><td class="h">5655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">5656</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># FIXME: both phonepost and vgift are ljcom.  need hooks. but then also</td></tr>
<tr><td class="h">5657</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#        need a separate namespace.  perhaps a separate function/table?</td></tr>
<tr><td class="h">5658</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub alloc_user_counter</td></tr>
<tr><td class="h">5659</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5660</td><td><div class="c3">258</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5660">258</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $dom, $opts) = @_;</td></tr>
<tr><td class="h">5661</td><td><div class="c3">258</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L5661">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts ||= {};</td></tr>
<tr><td class="h">5662</td><td colspan="7"></td></tr><tr><td class="h">5663</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##################################################################</td></tr>
<tr><td class="h">5664</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# IF YOU UPDATE THIS MAKE SURE YOU ADD INITIALIZATION CODE BELOW #</td></tr>
<tr><td class="h">5665</td><td><div class="c3">258</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5665">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $dom =~ /^[LTMPSRKCOVEQGDIZX]$/;             #</td></tr>
<tr><td class="h">5666</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##################################################################</td></tr>
<tr><td class="h">5667</td><td colspan="7"></td></tr><tr><td class="h">5668</td><td><div class="c3">258</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">5669</td><td><div class="c3">258</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5669">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $dbh;</td></tr>
<tr><td class="h">5670</td><td colspan="7"></td></tr><tr><td class="h">5671</td><td><div class="c3">258</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $newmax;</td></tr>
<tr><td class="h">5672</td><td><div class="c3">258</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $u-&gt;userid + 0;</td></tr>
<tr><td class="h">5673</td><td><div class="c3">258</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5673">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $uid;</td></tr>
<tr><td class="h">5674</td><td><div class="c3">258</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$uid, &quot;auc:$uid:$dom&quot;];</td></tr>
<tr><td class="h">5675</td><td colspan="7"></td></tr><tr><td class="h">5676</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# in a master-master DB cluster we need to be careful that in</td></tr>
<tr><td class="h">5677</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# an automatic failover case where one cluster is slightly behind</td></tr>
<tr><td class="h">5678</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# that the same counter ID isn&#39;t handed out twice.  use memcache</td></tr>
<tr><td class="h">5679</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# as a sanity check to record/check latest number handed out.</td></tr>
<tr><td class="h">5680</td><td><div class="c3">258</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L5680">100</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memmax = int(LJ::MemCache::get($memkey) || 0);</td></tr>
<tr><td class="h">5681</td><td colspan="7"></td></tr><tr><td class="h">5682</td><td><div class="c3">258</div></td><td></td><td></td><td></td><td></td><td><div>924057</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rs = $dbh-&gt;do(&quot;UPDATE usercounter SET max=LAST_INSERT_ID(GREATEST(max,$memmax)+1) &quot;.</td></tr>
<tr><td class="h">5683</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE journalid=? AND area=?&quot;, undef, $uid, $dom);</td></tr>
<tr><td class="h">5684</td><td><div class="c3">258</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5684">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($rs &gt; 0) {</td></tr>
<tr><td class="h">5685</td><td><div class="c3">250</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $dbh-&gt;selectrow_array(&quot;SELECT LAST_INSERT_ID()&quot;);</td></tr>
<tr><td class="h">5686</td><td colspan="7"></td></tr><tr><td class="h">5687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if we&#39;ve got a supplied callback, lets check the counter</td></tr>
<tr><td class="h">5688</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# number for consistency.  If it fails our test, wipe</td></tr>
<tr><td class="h">5689</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the counter row and start over, initializing a new one.</td></tr>
<tr><td class="h">5690</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# callbacks should return true to signal &#39;all is well.&#39;</td></tr>
<tr><td class="h">5691</td><td><div class="c3">250</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5691">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5691">33</a></div></td><td></td><td></td><td><div>40001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{callback} &amp;&amp; ref $opts-&gt;{callback} eq &#39;CODE&#39;) {</td></tr>
<tr><td class="h">5692</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rv = 0;</td></tr>
<tr><td class="h">5693</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval { $rv = $opts-&gt;{callback}-&gt;($u, $newmax) };</td></tr>
<tr><td class="h">5694</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5694">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5694">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($@ or ! $rv) {</td></tr>
<tr><td class="h">5695</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM usercounter WHERE &quot; .</td></tr>
<tr><td class="h">5696</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;journalid=? AND area=?&quot;, undef, $uid, $dom);</td></tr>
<tr><td class="h">5697</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::alloc_user_counter($u, $dom);</td></tr>
<tr><td class="h">5698</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5699</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5700</td><td colspan="7"></td></tr><tr><td class="h">5701</td><td><div class="c3">250</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $newmax);</td></tr>
<tr><td class="h">5702</td><td><div class="c3">250</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $newmax;</td></tr>
<tr><td class="h">5703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5704</td><td colspan="7"></td></tr><tr><td class="h">5705</td><td><div class="c3">8</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5705">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{recurse}) {</td></tr>
<tr><td class="h">5706</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We shouldn&#39;t ever get here if all is right with the world.</td></tr>
<tr><td class="h">5707</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">5708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5709</td><td colspan="7"></td></tr><tr><td class="h">5710</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $qry_map = {</td></tr>
<tr><td class="h">5711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# for entries:</td></tr>
<tr><td class="h">5712</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;log&#39;         =&gt; &quot;SELECT MAX(jitemid) FROM log2     WHERE journalid=?&quot;,</td></tr>
<tr><td class="h">5713</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;logtext&#39;     =&gt; &quot;SELECT MAX(jitemid) FROM logtext2 WHERE journalid=?&quot;,</td></tr>
<tr><td class="h">5714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;talk_nodeid&#39; =&gt; &quot;SELECT MAX(nodeid)  FROM talk2    WHERE nodetype=&#39;L&#39; AND journalid=?&quot;,</td></tr>
<tr><td class="h">5715</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# for comments:</td></tr>
<tr><td class="h">5716</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;talk&#39;     =&gt; &quot;SELECT MAX(jtalkid) FROM talk2     WHERE journalid=?&quot;,</td></tr>
<tr><td class="h">5717</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;talktext&#39; =&gt; &quot;SELECT MAX(jtalkid) FROM talktext2 WHERE journalid=?&quot;,</td></tr>
<tr><td class="h">5718</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">5719</td><td colspan="7"></td></tr><tr><td class="h">5720</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $consider = sub {</td></tr>
<tr><td class="h">5721</td><td><div class="c3">6</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5721">6</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @tables = @_;</td></tr>
<tr><td class="h">5722</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $t (@tables) {</td></tr>
<tr><td class="h">5723</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $res = $u-&gt;selectrow_array($qry_map-&gt;{$t}, undef, $uid);</td></tr>
<tr><td class="h">5724</td><td><div class="c3">16</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5724">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $res if $res &gt; $newmax;</td></tr>
<tr><td class="h">5725</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5726</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">5727</td><td colspan="7"></td></tr><tr><td class="h">5728</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Make sure the counter table is populated for this uid/dom.</td></tr>
<tr><td class="h">5729</td><td><div class="c3">8</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">100</a></div><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">100</a></div><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">50</a></div><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">50</a></div><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">50</a></div><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">50</a></div><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">50</a></div><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">50</a></div><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">50</a></div><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">50</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5729">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($dom eq &quot;L&quot;) {</td></tr>
<tr><td class="h">5730</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# back in the ol&#39; days IDs were reused (because of MyISAM)</td></tr>
<tr><td class="h">5731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# so now we&#39;re extra careful not to reuse a number that has</td></tr>
<tr><td class="h">5732</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# foreign junk &quot;attached&quot;.  turns out people like to delete</td></tr>
<tr><td class="h">5733</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# each entry by hand, but we do lazy deletes that are often</td></tr>
<tr><td class="h">5734</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# too lazy and a user can see old stuff come back alive</td></tr>
<tr><td class="h">5735</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$consider-&gt;(&quot;log&quot;, &quot;logtext&quot;, &quot;talk_nodeid&quot;);</td></tr>
<tr><td class="h">5736</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;T&quot;) {</td></tr>
<tr><td class="h">5737</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# just paranoia, not as bad as above.  don&#39;t think we&#39;ve ever</td></tr>
<tr><td class="h">5738</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# run into cases of talktext without a talk, but who knows.</td></tr>
<tr><td class="h">5739</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t hurt.</td></tr>
<tr><td class="h">5740</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$consider-&gt;(&quot;talk&quot;, &quot;talktext&quot;);</td></tr>
<tr><td class="h">5741</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;M&quot;) {</td></tr>
<tr><td class="h">5742</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(modid) FROM modlog WHERE journalid=?&quot;,</td></tr>
<tr><td class="h">5743</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5744</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;S&quot;) {</td></tr>
<tr><td class="h">5745</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(sessid) FROM sessions WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5746</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5747</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;R&quot;) {</td></tr>
<tr><td class="h">5748</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(memid) FROM memorable2 WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5749</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5750</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;K&quot;) {</td></tr>
<tr><td class="h">5751</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(kwid) FROM userkeywords WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5752</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5753</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;P&quot;) {</td></tr>
<tr><td class="h">5754</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $userblobmax = $u-&gt;selectrow_array(&quot;SELECT MAX(blobid) FROM userblob WHERE journalid=? AND domain=?&quot;,</td></tr>
<tr><td class="h">5755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid, LJ::get_blob_domainid(&quot;phonepost&quot;));</td></tr>
<tr><td class="h">5756</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ppemax = $u-&gt;selectrow_array(&quot;SELECT MAX(blobid) FROM phonepostentry WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5757</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5758</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5758">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = ($ppemax &gt; $userblobmax) ? $ppemax : $userblobmax;</td></tr>
<tr><td class="h">5759</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;C&quot;) {</td></tr>
<tr><td class="h">5760</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(pendid) FROM pendcomments WHERE jid=?&quot;,</td></tr>
<tr><td class="h">5761</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5762</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;V&quot;) {</td></tr>
<tr><td class="h">5763</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(giftid) FROM vgifts WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5764</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5765</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;E&quot;) {</td></tr>
<tr><td class="h">5766</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(subid) FROM subs WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5767</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5768</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;Q&quot;) {</td></tr>
<tr><td class="h">5769</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(qid) FROM notifyqueue WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5770</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5771</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;D&quot;) {</td></tr>
<tr><td class="h">5772</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(moduleid) FROM embedcontent WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5773</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5774</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;I&quot;) {</td></tr>
<tr><td class="h">5775</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $dbh-&gt;selectrow_array(&quot;SELECT MAX(import_data_id) FROM import_data WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5776</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5777</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;Z&quot;) {</td></tr>
<tr><td class="h">5778</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $dbh-&gt;selectrow_array(&quot;SELECT MAX(import_status_id) FROM import_status WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5779</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5780</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($dom eq &quot;X&quot;) {</td></tr>
<tr><td class="h">5781</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newmax = $u-&gt;selectrow_array(&quot;SELECT MAX(acctid) FROM externalaccount WHERE userid=?&quot;,</td></tr>
<tr><td class="h">5782</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid);</td></tr>
<tr><td class="h">5783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">5784</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;No user counter initializer defined for area &#39;$dom&#39;.\n&quot;;</td></tr>
<tr><td class="h">5785</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5786</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$newmax += 0;</td></tr>
<tr><td class="h">5787</td><td><div class="c3">8</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5787">50</a></div></td><td></td><td></td><td></td><td><div>36001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT IGNORE INTO usercounter (journalid, area, max) VALUES (?,?,?)&quot;,</td></tr>
<tr><td class="h">5788</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uid, $dom, $newmax) or return undef;</td></tr>
<tr><td class="h">5789</td><td colspan="7"></td></tr><tr><td class="h">5790</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# The 2nd invocation of the alloc_user_counter sub should do the</td></tr>
<tr><td class="h">5791</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# intended incrementing.</td></tr>
<tr><td class="h">5792</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::alloc_user_counter($u, $dom, { recurse =&gt; 1 });</td></tr>
<tr><td class="h">5793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5794</td><td colspan="7"></td></tr><tr><td class="h">5795</td><td colspan="7"></td></tr><tr><td class="h">5796</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub memcache_get_u</td></tr>
<tr><td class="h">5797</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5798</td><td><div class="c3">8</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5798">8</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @keys = @_;</td></tr>
<tr><td class="h">5799</td><td><div class="c3">8</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @ret;</td></tr>
<tr><td class="h">5800</td><td><div class="c3">8</div><div class="c3">8</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5800">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $ar (values %{LJ::MemCache::get_multi(@keys) || {}}) {</td></tr>
<tr><td class="h">5801</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5801">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $row = LJ::MemCache::array_to_hash(&quot;user&quot;, $ar)</td></tr>
<tr><td class="h">5802</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or next;</td></tr>
<tr><td class="h">5803</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::User-&gt;new_from_row($row);</td></tr>
<tr><td class="h">5804</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @ret, $u;</td></tr>
<tr><td class="h">5805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5806</td><td><div class="c3">8</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5806">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return wantarray ? @ret : $ret[0];</td></tr>
<tr><td class="h">5807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5808</td><td colspan="7"></td></tr><tr><td class="h">5809</td><td colspan="7"></td></tr><tr><td class="h">5810</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5811</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::memcache_kill</td></tr>
<tr><td class="h">5812</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Kills a memcache entry, given a userid and type.</td></tr>
<tr><td class="h">5813</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuserid, type</td></tr>
<tr><td class="h">5814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: a userid or u object</td></tr>
<tr><td class="h">5815</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-type: memcached key type, will be used as &quot;$type:$userid&quot;</td></tr>
<tr><td class="h">5816</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: results of LJ::MemCache::delete</td></tr>
<tr><td class="h">5817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5818</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub memcache_kill {</td></tr>
<tr><td class="h">5819</td><td><div class="c3">1054</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5819">1054</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($uuid, $type) = @_;</td></tr>
<tr><td class="h">5820</td><td><div class="c3">1054</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = LJ::want_userid($uuid);</td></tr>
<tr><td class="h">5821</td><td><div class="c3">1054</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5821">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5821">33</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $userid &amp;&amp; $type;</td></tr>
<tr><td class="h">5822</td><td colspan="7"></td></tr><tr><td class="h">5823</td><td><div class="c3">1054</div></td><td></td><td></td><td></td><td></td><td><div>16000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::MemCache::delete([$userid, &quot;$type:$userid&quot;]);</td></tr>
<tr><td class="h">5824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5825</td><td colspan="7"></td></tr><tr><td class="h">5826</td><td colspan="7"></td></tr><tr><td class="h">5827</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub memcache_set_u</td></tr>
<tr><td class="h">5828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5829</td><td><div class="c3">372</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5829">372</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">5830</td><td><div class="c3">372</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5830">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $u;</td></tr>
<tr><td class="h">5831</td><td><div class="c3">372</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $expire = time() + 1800;</td></tr>
<tr><td class="h">5832</td><td><div class="c3">372</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ar = LJ::MemCache::hash_to_array(&quot;user&quot;, $u);</td></tr>
<tr><td class="h">5833</td><td><div class="c3">372</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5833">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $ar;</td></tr>
<tr><td class="h">5834</td><td><div class="c3">372</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set( [$u-&gt;userid, &quot;userid:&quot; . $u-&gt;userid], $ar, $expire );</td></tr>
<tr><td class="h">5835</td><td><div class="c3">372</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set( &quot;uidof:&quot; . $u-&gt;user, $u-&gt;userid );</td></tr>
<tr><td class="h">5836</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5837</td><td colspan="7"></td></tr><tr><td class="h">5838</td><td colspan="7"></td></tr><tr><td class="h">5839</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub update_user</td></tr>
<tr><td class="h">5840</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5841</td><td><div class="c3">527</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5841">527</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($arg, $ref) = @_;</td></tr>
<tr><td class="h">5842</td><td><div class="c3">527</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @uid;</td></tr>
<tr><td class="h">5843</td><td colspan="7"></td></tr><tr><td class="h">5844</td><td><div class="c3">527</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5844">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref $arg eq &quot;ARRAY&quot;) {</td></tr>
<tr><td class="h">5845</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@uid = @$arg;</td></tr>
<tr><td class="h">5846</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">5847</td><td><div class="c3">527</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@uid = want_userid($arg);</td></tr>
<tr><td class="h">5848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5849</td><td><div class="c3">527</div><div class="c3">527</div><div class="c3">527</div></td><td></td><td></td><td></td><td></td><td><div>4000</div><div>0</div><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;@uid = grep { $_ } map { $_ + 0 } @uid;</td></tr>
<tr><td class="h">5850</td><td><div class="c3">527</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5850">50</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless @uid;</td></tr>
<tr><td class="h">5851</td><td colspan="7"></td></tr><tr><td class="h">5852</td><td><div class="c3">527</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @sets;</td></tr>
<tr><td class="h">5853</td><td><div class="c3">527</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @bindparams;</td></tr>
<tr><td class="h">5854</td><td><div class="c3">527</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $used_raw = 0;</td></tr>
<tr><td class="h">5855</td><td><div class="c3">527</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %$ref) {</td></tr>
<tr><td class="h">5856</td><td><div class="c3">2801</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5856">100</a></div><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5856">100</a></div><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5856">100</a></div></td><td></td><td></td><td></td><td><div>28002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($k eq &quot;raw&quot;) {</td></tr>
<tr><td class="h">5857</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$used_raw = 1;</td></tr>
<tr><td class="h">5858</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @sets, $v;</td></tr>
<tr><td class="h">5859</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($k eq &#39;email&#39;) {</td></tr>
<tr><td class="h">5860</td><td><div class="c3">326</div><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_email($_, $v) foreach @uid;</td></tr>
<tr><td class="h">5861</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($k eq &#39;password&#39;) {</td></tr>
<tr><td class="h">5862</td><td><div class="c3">326</div><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_password($_, $v) foreach @uid;</td></tr>
<tr><td class="h">5863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">5864</td><td><div class="c3">2142</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @sets, &quot;$k=?&quot;;</td></tr>
<tr><td class="h">5865</td><td><div class="c3">2142</div></td><td></td><td></td><td></td><td></td><td><div>12000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @bindparams, $v;</td></tr>
<tr><td class="h">5866</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5867</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5868</td><td><div class="c3">527</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5868">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless @sets;</td></tr>
<tr><td class="h">5869</td><td><div class="c3">525</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">5870</td><td><div class="c3">525</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5870">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $dbh;</td></tr>
<tr><td class="h">5871</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">5872</td><td><div class="c3">525</div><div class="c3">525</div></td><td></td><td></td><td></td><td></td><td><div>4000</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local $&quot; = &quot;,&quot;;</td></tr>
<tr><td class="h">5873</td><td><div class="c3">525</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5873">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $where = @uid == 1 ? &quot;userid=$uid[0]&quot; : &quot;userid IN (@uid)&quot;;</td></tr>
<tr><td class="h">5874</td><td><div class="c3">525</div></td><td></td><td></td><td></td><td></td><td><div>1932104</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE user SET @sets WHERE $where&quot;, undef,</td></tr>
<tr><td class="h">5875</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@bindparams);</td></tr>
<tr><td class="h">5876</td><td><div class="c3">525</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5876">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">5877</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5878</td><td><div class="c3">525</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5878">100</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@LJ::MEMCACHE_SERVERS) {</td></tr>
<tr><td class="h">5879</td><td><div class="c3">367</div><div class="c3">367</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($_, &quot;userid&quot;) foreach @uid;</td></tr>
<tr><td class="h">5880</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5881</td><td colspan="7"></td></tr><tr><td class="h">5882</td><td><div class="c3">525</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5882">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($used_raw) {</td></tr>
<tr><td class="h">5883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# for a load of userids from the master after update</td></tr>
<tr><td class="h">5884</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# so we pick up the values set via the &#39;raw&#39; option</td></tr>
<tr><td class="h">5885</td><td><div class="c3">7</div><div class="c3">7</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5885">7</a></div></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require_master(sub { LJ::load_userids(@uid) });</td></tr>
<tr><td class="h">5886</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">5887</td><td><div class="c3">518</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $uid (@uid) {</td></tr>
<tr><td class="h">5888</td><td><div class="c3">518</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %$ref) {</td></tr>
<tr><td class="h">5889</td><td><div class="c3">2787</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5889">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cache = $LJ::REQ_CACHE_USER_ID{$uid} or next;</td></tr>
<tr><td class="h">5890</td><td><div class="c3">2787</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cache-&gt;{$k} = $v;</td></tr>
<tr><td class="h">5891</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5892</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5894</td><td colspan="7"></td></tr><tr><td class="h">5895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# log this updates</td></tr>
<tr><td class="h">5896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;update_user&quot;, userid =&gt; $_, fields =&gt; $ref)</td></tr>
<tr><td class="h">5897</td><td><div class="c3">525</div><div class="c3">525</div></td><td></td><td></td><td></td><td></td><td><div>8001</div><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for @uid;</td></tr>
<tr><td class="h">5898</td><td colspan="7"></td></tr><tr><td class="h">5899</td><td><div class="c3">525</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">5900</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5901</td><td colspan="7"></td></tr><tr><td class="h">5902</td><td colspan="7"></td></tr><tr><td class="h">5903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5904</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::wipe_major_memcache</td></tr>
<tr><td class="h">5905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: invalidate all major memcache items associated with a given user.</td></tr>
<tr><td class="h">5906</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u</td></tr>
<tr><td class="h">5907</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: nothing</td></tr>
<tr><td class="h">5908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">5909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub wipe_major_memcache</td></tr>
<tr><td class="h">5910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5911</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: this function is unused as of Aug 2009 - kareila</td></tr>
<tr><td class="h">5912</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5912">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">5913</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = LJ::want_userid($u);</td></tr>
<tr><td class="h">5914</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $key (&quot;userid&quot;,&quot;bio&quot;,&quot;talk2ct&quot;,&quot;talkleftct&quot;,&quot;log2ct&quot;,</td></tr>
<tr><td class="h">5915</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;log2lt&quot;,&quot;memkwid&quot;,&quot;dayct2&quot;,&quot;s1overr&quot;,&quot;s1uc&quot;,&quot;fgrp&quot;,</td></tr>
<tr><td class="h">5916</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;wt_edges&quot;,&quot;wt_edges_rev&quot;,&quot;tu&quot;,&quot;upicinf&quot;,&quot;upiccom&quot;,</td></tr>
<tr><td class="h">5917</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;upicurl&quot;, &quot;upicdes&quot;, &quot;intids&quot;, &quot;memct&quot;, &quot;lastcomm&quot;)</td></tr>
<tr><td class="h">5918</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">5919</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($userid, $key);</td></tr>
<tr><td class="h">5920</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5921</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5922</td><td colspan="7"></td></tr><tr><td class="h">5923</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::_load_user_raw</td></tr>
<tr><td class="h">5925</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-db:  $dbh/$dbr</td></tr>
<tr><td class="h">5926</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-key:  either &quot;userid&quot; or &quot;user&quot;  (the WHERE part)</td></tr>
<tr><td class="h">5927</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-vals: value or arrayref of values for key to match on</td></tr>
<tr><td class="h">5928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-hook: optional code ref to run for each $u</td></tr>
<tr><td class="h">5929</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: last $u found</td></tr>
<tr><td class="h">5930</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _load_user_raw</td></tr>
<tr><td class="h">5931</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">5932</td><td><div class="c3">373</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5932">373</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($db, $key, $vals, $hook) = @_;</td></tr>
<tr><td class="h">5933</td><td><div class="c3">373</div><div class="c3">363</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L5933">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5933">363</a></div></td><td></td><td><div>8000</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$hook ||= sub {};</td></tr>
<tr><td class="h">5934</td><td><div class="c3">373</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5934">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$vals = [ $vals ] unless ref $vals eq &quot;ARRAY&quot;;</td></tr>
<tr><td class="h">5935</td><td colspan="7"></td></tr><tr><td class="h">5936</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $use_isam;</td></tr>
<tr><td class="h">5937</td><td><div class="c3">373</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5937">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5937">33</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($LJ::CACHE_NO_ISAM{user} || scalar(@$vals) &gt; 10) {</td></tr>
<tr><td class="h">5938</td><td><div class="c3">373</div><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>56004</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval { $db-&gt;do(&quot;HANDLER user OPEN&quot;); };</td></tr>
<tr><td class="h">5939</td><td><div class="c3">373</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5939">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L5939">33</a></div></td><td></td><td></td><td><div>20002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($@ || $db-&gt;err) {</td></tr>
<tr><td class="h">5940</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$LJ::CACHE_NO_ISAM{user} = 1;</td></tr>
<tr><td class="h">5941</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">5942</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$use_isam = 1;</td></tr>
<tr><td class="h">5943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5944</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5945</td><td colspan="7"></td></tr><tr><td class="h">5946</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $last;</td></tr>
<tr><td class="h">5947</td><td colspan="7"></td></tr><tr><td class="h">5948</td><td><div class="c3">373</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5948">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($use_isam) {</td></tr>
<tr><td class="h">5949</td><td><div class="c3">373</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5949">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key = &quot;PRIMARY&quot; if $key eq &quot;userid&quot;;</td></tr>
<tr><td class="h">5950</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $v (@$vals) {</td></tr>
<tr><td class="h">5951</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $db-&gt;prepare(&quot;HANDLER user READ `$key` = (?) LIMIT 1&quot;);</td></tr>
<tr><td class="h">5952</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>104004</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($v);</td></tr>
<tr><td class="h">5953</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $row = $sth-&gt;fetchrow_hashref;</td></tr>
<tr><td class="h">5954</td><td><div class="c3">373</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L5954">50</a></div></td><td></td><td></td><td></td><td><div>28001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($row) {</td></tr>
<tr><td class="h">5955</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::User-&gt;new_from_row($row);</td></tr>
<tr><td class="h">5956</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hook-&gt;($u);</td></tr>
<tr><td class="h">5957</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>24002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last = $u;</td></tr>
<tr><td class="h">5958</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5959</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5960</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>28001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;do(&quot;HANDLER user close&quot;);</td></tr>
<tr><td class="h">5961</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">5962</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&quot;, &quot;, map { $db-&gt;quote($_) } @$vals);</td></tr>
<tr><td class="h">5963</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $db-&gt;prepare(&quot;SELECT * FROM user WHERE $key IN ($in)&quot;);</td></tr>
<tr><td class="h">5964</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">5965</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my $row = $sth-&gt;fetchrow_hashref) {</td></tr>
<tr><td class="h">5966</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::User-&gt;new_from_row($row);</td></tr>
<tr><td class="h">5967</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hook-&gt;($u);</td></tr>
<tr><td class="h">5968</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last = $u;</td></tr>
<tr><td class="h">5969</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5970</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5971</td><td colspan="7"></td></tr><tr><td class="h">5972</td><td><div class="c3">373</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $last;</td></tr>
<tr><td class="h">5973</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5974</td><td colspan="7"></td></tr><tr><td class="h">5975</td><td colspan="7"></td></tr><tr><td class="h">5976</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub _set_u_req_cache {</td></tr>
<tr><td class="h">5977</td><td><div class="c3">376</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5977">50</a></div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L5977">376</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift or die &quot;no u to set&quot;;</td></tr>
<tr><td class="h">5978</td><td colspan="7"></td></tr><tr><td class="h">5979</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we have an existing user singleton, upgrade it with</td></tr>
<tr><td class="h">5980</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the latested data, but keep using its address</td></tr>
<tr><td class="h">5981</td><td><div class="c3">376</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L5981">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( my $eu = $LJ::REQ_CACHE_USER_ID{$u-&gt;userid} ) {</td></tr>
<tr><td class="h">5982</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::assert_is( $eu-&gt;userid, $u-&gt;userid );</td></tr>
<tr><td class="h">5983</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$eu-&gt;selfassert;</td></tr>
<tr><td class="h">5984</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;selfassert;</td></tr>
<tr><td class="h">5985</td><td colspan="7"></td></tr><tr><td class="h">5986</td><td><div class="c3">26</div><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$eu-&gt;{$_} = $u-&gt;{$_} foreach keys %$u;</td></tr>
<tr><td class="h">5987</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u = $eu;</td></tr>
<tr><td class="h">5988</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">5989</td><td><div class="c3">376</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::REQ_CACHE_USER_NAME{$u-&gt;user} = $u;</td></tr>
<tr><td class="h">5990</td><td><div class="c3">376</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$LJ::REQ_CACHE_USER_ID{$u-&gt;userid} = $u;</td></tr>
<tr><td class="h">5991</td><td><div class="c3">376</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">5992</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">5993</td><td colspan="7"></td></tr><tr><td class="h">5994</td><td colspan="7"></td></tr><tr><td class="h">5995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">5996</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  6. What the App Shows to Users</td></tr>
<tr><td class="h">5997</td><td colspan="7"></td></tr><tr><td class="h">5998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">5999</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_timezone</td></tr>
<tr><td class="h">6000</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets the timezone offset for the user.</td></tr>
<tr><td class="h">6001</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, offsetref, fakedref</td></tr>
<tr><td class="h">6002</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: user object.</td></tr>
<tr><td class="h">6003</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-offsetref: reference to scalar to hold timezone offset;</td></tr>
<tr><td class="h">6004</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-fakedref: reference to scalar to hold whether this timezone was</td></tr>
<tr><td class="h">6005</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#               faked.  0 if it is the timezone specified by the user.</td></tr>
<tr><td class="h">6006</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: nonzero if successful.</td></tr>
<tr><td class="h">6007</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6008</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_timezone {</td></tr>
<tr><td class="h">6009</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6009">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $offsetref, $fakedref) = @_;</td></tr>
<tr><td class="h">6010</td><td colspan="7"></td></tr><tr><td class="h">6011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# See if the user specified their timezone</td></tr>
<tr><td class="h">6012</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6012">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $tz = $u-&gt;prop(&#39;timezone&#39;)) {</td></tr>
<tr><td class="h">6013</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# If the eval fails, we&#39;ll fall through to guessing instead</td></tr>
<tr><td class="h">6014</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dt = eval {</td></tr>
<tr><td class="h">6015</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTime-&gt;from_epoch(</td></tr>
<tr><td class="h">6016</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;epoch =&gt; time(),</td></tr>
<tr><td class="h">6017</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time_zone =&gt; $tz,</td></tr>
<tr><td class="h">6018</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</td></tr>
<tr><td class="h">6019</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">6020</td><td colspan="7"></td></tr><tr><td class="h">6021</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6021">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($dt) {</td></tr>
<tr><td class="h">6022</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$offsetref = $dt-&gt;offset() / (60 * 60); # Convert from seconds to hours</td></tr>
<tr><td class="h">6023</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6023">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$fakedref  = 0 if $fakedref;</td></tr>
<tr><td class="h">6024</td><td colspan="7"></td></tr><tr><td class="h">6025</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">6026</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6027</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6028</td><td colspan="7"></td></tr><tr><td class="h">6029</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Either the user hasn&#39;t set a timezone or we failed at</td></tr>
<tr><td class="h">6030</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# loading it.  We guess their current timezone&#39;s offset</td></tr>
<tr><td class="h">6031</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# by comparing the gmtime of their last post with the time</td></tr>
<tr><td class="h">6032</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# they specified on that post.</td></tr>
<tr><td class="h">6033</td><td colspan="7"></td></tr><tr><td class="h">6034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# first, check request cache</td></tr>
<tr><td class="h">6035</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $timezone = $u-&gt;{_timezone_guess};</td></tr>
<tr><td class="h">6036</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6036">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($timezone) {</td></tr>
<tr><td class="h">6037</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$offsetref = $timezone;</td></tr>
<tr><td class="h">6038</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">6039</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6040</td><td colspan="7"></td></tr><tr><td class="h">6041</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# next, check memcache</td></tr>
<tr><td class="h">6042</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;userid, &#39;timezone_guess:&#39; . $u-&gt;userid];</td></tr>
<tr><td class="h">6043</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memcache_data = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">6044</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6044">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($memcache_data) {</td></tr>
<tr><td class="h">6045</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fill the request cache since it was empty</td></tr>
<tr><td class="h">6046</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_timezone_guess} = $memcache_data;</td></tr>
<tr><td class="h">6047</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$offsetref = $memcache_data;</td></tr>
<tr><td class="h">6048</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">6049</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6050</td><td colspan="7"></td></tr><tr><td class="h">6051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# nothing in cache; check db</td></tr>
<tr><td class="h">6052</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u);</td></tr>
<tr><td class="h">6053</td><td><div class="c3">34</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6053">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $dbcr;</td></tr>
<tr><td class="h">6054</td><td colspan="7"></td></tr><tr><td class="h">6055</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6055">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$$fakedref = 1 if $fakedref;</td></tr>
<tr><td class="h">6056</td><td colspan="7"></td></tr><tr><td class="h">6057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# grab the times on the last post that wasn&#39;t backdated.</td></tr>
<tr><td class="h">6058</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# (backdated is rlogtime == $LJ::EndOfTime)</td></tr>
<tr><td class="h">6059</td><td><div class="c3">34</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6059">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $last_row = $dbcr-&gt;selectrow_hashref(</td></tr>
<tr><td class="h">6060</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qq{</td></tr>
<tr><td class="h">6061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT rlogtime, eventtime</td></tr>
<tr><td class="h">6062</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM log2</td></tr>
<tr><td class="h">6063</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE journalid = ? AND rlogtime &lt;&gt; ?</td></tr>
<tr><td class="h">6064</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ORDER BY rlogtime LIMIT 1</td></tr>
<tr><td class="h">6065</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, undef, $u-&gt;userid, $LJ::EndOfTime)) {</td></tr>
<tr><td class="h">6066</td><td><div class="c3">30</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $logtime = $LJ::EndOfTime - $last_row-&gt;{&#39;rlogtime&#39;};</td></tr>
<tr><td class="h">6067</td><td><div class="c3">30</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $eventtime = LJ::mysqldate_to_time($last_row-&gt;{&#39;eventtime&#39;}, 1);</td></tr>
<tr><td class="h">6068</td><td><div class="c3">30</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $hourdiff = ($eventtime - $logtime) / 3600;</td></tr>
<tr><td class="h">6069</td><td colspan="7"></td></tr><tr><td class="h">6070</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if they&#39;re up to a quarter hour behind, round up.</td></tr>
<tr><td class="h">6071</td><td><div class="c3">30</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6071">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hourdiff = $hourdiff &gt; 0 ? int($hourdiff + 0.25) : int($hourdiff - 0.25);</td></tr>
<tr><td class="h">6072</td><td colspan="7"></td></tr><tr><td class="h">6073</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if the offset is more than 24h in either direction, then the last</td></tr>
<tr><td class="h">6074</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# entry is probably unreliable. don&#39;t use any offset at all.</td></tr>
<tr><td class="h">6075</td><td><div class="c3">30</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6075">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6075">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$offsetref = (-24 &lt; $hourdiff &amp;&amp; $hourdiff &lt; 24) ? $hourdiff : 0;</td></tr>
<tr><td class="h">6076</td><td colspan="7"></td></tr><tr><td class="h">6077</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# set the caches</td></tr>
<tr><td class="h">6078</td><td><div class="c3">30</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_timezone_guess} = $$offsetref;</td></tr>
<tr><td class="h">6079</td><td><div class="c3">30</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $expire = 60*60*24; # 24 hours</td></tr>
<tr><td class="h">6080</td><td><div class="c3">30</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set($memkey, $$offsetref, $expire);</td></tr>
<tr><td class="h">6081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6082</td><td colspan="7"></td></tr><tr><td class="h">6083</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">6084</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6085</td><td colspan="7"></td></tr><tr><td class="h">6086</td><td colspan="7"></td></tr><tr><td class="h">6087</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6088</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class: component</td></tr>
<tr><td class="h">6089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::ljuser</td></tr>
<tr><td class="h">6090</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Make link to userinfo/journal of user.</td></tr>
<tr><td class="h">6091</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: Returns the HTML for a userinfo/journal link pair for a given user</td></tr>
<tr><td class="h">6092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       name, just like LJUSER does in BML.  This is for files like cleanhtml.pl</td></tr>
<tr><td class="h">6093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       and ljpoll.pl which need this functionality too, but they aren&#39;t run as BML.</td></tr>
<tr><td class="h">6094</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: user, opts?</td></tr>
<tr><td class="h">6095</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-user: Username to link to, or user hashref.</td></tr>
<tr><td class="h">6096</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: Optional hashref to control output.  Key &#39;full&#39; when true causes</td></tr>
<tr><td class="h">6097</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           a link to the mode=full userinfo.   Key &#39;type&#39; when &#39;C&#39; makes</td></tr>
<tr><td class="h">6098</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           a community link, when &#39;Y&#39; makes a syndicated account link,</td></tr>
<tr><td class="h">6099</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           when &#39;I&#39; makes an identity account link (e.g. OpenID),</td></tr>
<tr><td class="h">6100</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           otherwise makes a user account</td></tr>
<tr><td class="h">6101</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           link. If user parameter is a hashref, its &#39;journaltype&#39; overrides</td></tr>
<tr><td class="h">6102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           this &#39;type&#39;.  Key &#39;del&#39;, when true, makes a tag for a deleted user.</td></tr>
<tr><td class="h">6103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           If user parameter is a hashref, its &#39;statusvis&#39; overrides &#39;del&#39;.</td></tr>
<tr><td class="h">6104</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           Key &#39;no_follow&#39;, when true, disables traversal of renamed users.</td></tr>
<tr><td class="h">6105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: HTML with a little head image &amp; bold text link.</td></tr>
<tr><td class="h">6106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6107</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub ljuser</td></tr>
<tr><td class="h">6108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">6109</td><td><div class="c3">10</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6109">10</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $user, $opts ) = @_;</td></tr>
<tr><td class="h">6110</td><td colspan="7"></td></tr><tr><td class="h">6111</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6111">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $andfull = $opts-&gt;{&#39;full&#39;} ? &quot;?mode=full&quot; : &quot;&quot;;</td></tr>
<tr><td class="h">6112</td><td><div class="c3">10</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6112">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $img = $opts-&gt;{&#39;imgroot&#39;} || $LJ::IMGPREFIX;</td></tr>
<tr><td class="h">6113</td><td><div class="c3">10</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6113">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $profile_url = $opts-&gt;{&#39;profile_url&#39;} || &#39;&#39;;</td></tr>
<tr><td class="h">6114</td><td><div class="c3">10</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6114">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $journal_url = $opts-&gt;{&#39;journal_url&#39;} || &#39;&#39;;</td></tr>
<tr><td class="h">6115</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6115">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $display_class = $opts-&gt;{no_ljuser_class} ? &quot;&quot; : &quot;class=&#39;ljuser&#39;&quot;;</td></tr>
<tr><td class="h">6116</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $profile;</td></tr>
<tr><td class="h">6117</td><td colspan="7"></td></tr><tr><td class="h">6118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $make_tag = sub {</td></tr>
<tr><td class="h">6119</td><td><div class="c3">10</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6119">33</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6119">10</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($fil, $url, $x, $y, $type) = @_;</td></tr>
<tr><td class="h">6120</td><td><div class="c3">10</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6120">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$y ||= $x;  # make square if only one dimension given</td></tr>
<tr><td class="h">6121</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6121">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $strike = $opts-&gt;{&#39;del&#39;} ? &#39; text-decoration: line-through;&#39; : &#39;&#39;;</td></tr>
<tr><td class="h">6122</td><td colspan="7"></td></tr><tr><td class="h">6123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Backwards check, because we want it to default to on</td></tr>
<tr><td class="h">6124</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6124">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6124">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $bold = (exists $opts-&gt;{&#39;bold&#39;} and $opts-&gt;{&#39;bold&#39;} == 0) ? 0 : 1;</td></tr>
<tr><td class="h">6125</td><td><div class="c3">10</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6125">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ljusername = $bold ? &quot;&lt;b&gt;$user&lt;/b&gt;&quot; : &quot;$user&quot;;</td></tr>
<tr><td class="h">6126</td><td colspan="7"></td></tr><tr><td class="h">6127</td><td><div class="c3">10</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6127">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $alttext = $type ? &quot; - $type&quot; : &quot;&quot;;</td></tr>
<tr><td class="h">6128</td><td colspan="7"></td></tr><tr><td class="h">6129</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $link_color = &quot;&quot;;</td></tr>
<tr><td class="h">6130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Make sure it&#39;s really a color</td></tr>
<tr><td class="h">6131</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6131">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6131">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;link_color&#39;} &amp;&amp; $opts-&gt;{&#39;link_color&#39;} =~ /^#([a-fA-F0-9]{3}|[a-fA-F0-9]{6})$/) {</td></tr>
<tr><td class="h">6132</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$link_color = &quot; style=&#39;color: &quot; . $opts-&gt;{&#39;link_color&#39;} . &quot;;&#39;&quot;;</td></tr>
<tr><td class="h">6133</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6134</td><td colspan="7"></td></tr><tr><td class="h">6135</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6135">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$profile = $profile_url ne &#39;&#39; ? $profile_url : $profile . $andfull;</td></tr>
<tr><td class="h">6136</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6136">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url = $journal_url ne &#39;&#39; ? $journal_url : $url;</td></tr>
<tr><td class="h">6137</td><td colspan="7"></td></tr><tr><td class="h">6138</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;span $display_class lj:user=&#39;$user&#39; style=&#39;white-space: nowrap;$strike&#39;&gt;&quot; .</td></tr>
<tr><td class="h">6139</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$profile&#39;&gt;&lt;img src=&#39;$img/$fil&#39; alt=&#39;[info$alttext] &#39; width=&#39;$x&#39; height=&#39;$y&#39;&quot; .</td></tr>
<tr><td class="h">6140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot; style=&#39;vertical-align: text-bottom; border: 0; padding-right: 1px;&#39; /&gt;&lt;/a&gt;&quot; .</td></tr>
<tr><td class="h">6141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;a href=&#39;$url&#39;$link_color&gt;$ljusername&lt;/a&gt;&lt;/span&gt;&quot;;</td></tr>
<tr><td class="h">6142</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">6143</td><td colspan="7"></td></tr><tr><td class="h">6144</td><td><div class="c3">10</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6144">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = isu($user) ? $user : LJ::load_user($user);</td></tr>
<tr><td class="h">6145</td><td colspan="7"></td></tr><tr><td class="h">6146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Traverse the renames to the final journal</td></tr>
<tr><td class="h">6147</td><td><div class="c3">10</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6147">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6147">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($u &amp;&amp; !$opts-&gt;{&#39;no_follow&#39;}) {</td></tr>
<tr><td class="h">6148</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u = $u-&gt;get_renamed_user;</td></tr>
<tr><td class="h">6149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6150</td><td colspan="7"></td></tr><tr><td class="h">6151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if invalid user, link to dummy userinfo page</td></tr>
<tr><td class="h">6152</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6152">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6152">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($u &amp;&amp; isu($u)) {</td></tr>
<tr><td class="h">6153</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user = LJ::canonical_username($user);</td></tr>
<tr><td class="h">6154</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$profile = &quot;$LJ::SITEROOT/userinfo?user=$user&quot;;</td></tr>
<tr><td class="h">6155</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;(&#39;silk/identity/user.png&#39;, &quot;$LJ::SITEROOT/userinfo?user=$user&quot;, 17);</td></tr>
<tr><td class="h">6156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6157</td><td colspan="7"></td></tr><tr><td class="h">6158</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$profile = $u-&gt;profile_url;</td></tr>
<tr><td class="h">6159</td><td colspan="7"></td></tr><tr><td class="h">6160</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $type = $u-&gt;journaltype;</td></tr>
<tr><td class="h">6161</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $type_readable = $u-&gt;journaltype_readable;</td></tr>
<tr><td class="h">6162</td><td colspan="7"></td></tr><tr><td class="h">6163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Mark accounts as deleted that aren&#39;t visible, memorial, locked, or read-only</td></tr>
<tr><td class="h">6164</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6164">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6164">20</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;del&#39;} = 1 unless $u-&gt;is_visible || $u-&gt;is_memorial || $u-&gt;is_locked || $u-&gt;is_readonly;</td></tr>
<tr><td class="h">6165</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$user = $u-&gt;user;</td></tr>
<tr><td class="h">6166</td><td colspan="7"></td></tr><tr><td class="h">6167</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $url = $u-&gt;journal_base . &quot;/&quot;;</td></tr>
<tr><td class="h">6168</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $head_size = $opts-&gt;{head_size};</td></tr>
<tr><td class="h">6169</td><td colspan="7"></td></tr><tr><td class="h">6170</td><td><div class="c3">10</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6170">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my ($icon, $size) = LJ::run_hook(&quot;head_icon&quot;, $u, head_size =&gt; $head_size)) {</td></tr>
<tr><td class="h">6171</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6171">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6171">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;($icon, $url, $size || 16) if $icon;</td></tr>
<tr><td class="h">6172</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6173</td><td colspan="7"></td></tr><tr><td class="h">6174</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6174">50</a></div><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6174">50</a></div><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6174">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $type eq &#39;C&#39; ) {</td></tr>
<tr><td class="h">6175</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6175">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;( &quot;comm_${head_size}.gif&quot;, $url, $head_size, &#39;&#39;, $type_readable ) if $head_size;</td></tr>
<tr><td class="h">6176</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;( &#39;silk/identity/community.png&#39;, $url, 16, &#39;&#39;, $type_readable );</td></tr>
<tr><td class="h">6177</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( $type eq &#39;Y&#39; ) {</td></tr>
<tr><td class="h">6178</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6178">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;( &quot;syn_${head_size}.gif&quot;, $url, $head_size, &#39;&#39;, $type_readable ) if $head_size;</td></tr>
<tr><td class="h">6179</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;( &#39;silk/identity/feed.png&#39;, $url, 16, &#39;&#39;, $type_readable );</td></tr>
<tr><td class="h">6180</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( $type eq &#39;I&#39; ) {</td></tr>
<tr><td class="h">6181</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;ljuser_display($opts);</td></tr>
<tr><td class="h">6182</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6183</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6183">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;get_cap( &#39;staff_headicon&#39; ) == 1 ) {</td></tr>
<tr><td class="h">6184</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6184">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;( &quot;staff_${head_size}.gif&quot;, $url, $head_size, &#39;&#39;, &#39;staff&#39; ) if $head_size;</td></tr>
<tr><td class="h">6185</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;( &#39;silk/identity/user_staff.png&#39;, $url, 17, &#39;&#39;, &#39;staff&#39; );</td></tr>
<tr><td class="h">6186</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6187</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</td></tr>
<tr><td class="h">6188</td><td><div class="c3">10</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6188">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;( &quot;user_${head_size}.gif&quot;, $url, $head_size, &#39;&#39;, $type_readable ) if $head_size;</td></tr>
<tr><td class="h">6189</td><td><div class="c3">10</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $make_tag-&gt;( &#39;silk/identity/user.png&#39;, $url, 17, &#39;&#39;, $type_readable );</td></tr>
<tr><td class="h">6190</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6191</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6192</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6193</td><td colspan="7"></td></tr><tr><td class="h">6194</td><td colspan="7"></td></tr><tr><td class="h">6195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">6196</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  7. Userprops, Caps, and Displaying Content to Others</td></tr>
<tr><td class="h">6197</td><td colspan="7"></td></tr><tr><td class="h">6198</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_bio</td></tr>
<tr><td class="h">6200</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: gets a user bio, from DB or memcache.</td></tr>
<tr><td class="h">6201</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, force</td></tr>
<tr><td class="h">6202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-force: true to get data from cluster master.</td></tr>
<tr><td class="h">6203</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: string</td></tr>
<tr><td class="h">6204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6205</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_bio {</td></tr>
<tr><td class="h">6206</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6206">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $force) = @_;</td></tr>
<tr><td class="h">6207</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6207">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6207">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $u &amp;&amp; $u-&gt;{&#39;has_bio&#39;} eq &quot;Y&quot;;</td></tr>
<tr><td class="h">6208</td><td colspan="7"></td></tr><tr><td class="h">6209</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $bio;</td></tr>
<tr><td class="h">6210</td><td colspan="7"></td></tr><tr><td class="h">6211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$u-&gt;userid, &quot;bio:&quot; . $u-&gt;userid];</td></tr>
<tr><td class="h">6212</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6212">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($force) {</td></tr>
<tr><td class="h">6213</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $bio = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">6214</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6214">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $bio if defined $bio;</td></tr>
<tr><td class="h">6215</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6216</td><td colspan="7"></td></tr><tr><td class="h">6217</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# not in memcache, fall back to disk</td></tr>
<tr><td class="h">6218</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6218">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6218">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $db = @LJ::MEMCACHE_SERVERS || $force ?</td></tr>
<tr><td class="h">6219</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::get_cluster_def_reader($u) : LJ::get_cluster_reader($u);</td></tr>
<tr><td class="h">6220</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$bio = $db-&gt;selectrow_array( &quot;SELECT bio FROM userbio WHERE userid=?&quot;,</td></tr>
<tr><td class="h">6221</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;userid );</td></tr>
<tr><td class="h">6222</td><td colspan="7"></td></tr><tr><td class="h">6223</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set in memcache</td></tr>
<tr><td class="h">6224</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add($memkey, $bio);</td></tr>
<tr><td class="h">6225</td><td colspan="7"></td></tr><tr><td class="h">6226</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $bio;</td></tr>
<tr><td class="h">6227</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6228</td><td colspan="7"></td></tr><tr><td class="h">6229</td><td colspan="7"></td></tr><tr><td class="h">6230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6231</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::load_user_props</td></tr>
<tr><td class="h">6232</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Given a user hashref, loads the values of the given named properties</td></tr>
<tr><td class="h">6233</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      into that user hashref.</td></tr>
<tr><td class="h">6234</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, u, opts?, propname*</td></tr>
<tr><td class="h">6235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: hashref of opts.  set key &#39;cache&#39; to use memcache.</td></tr>
<tr><td class="h">6236</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-propname: the name of a property from the [dbtable[userproplist]] table.</td></tr>
<tr><td class="h">6237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_user_props</td></tr>
<tr><td class="h">6239</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">6240</td><td><div class="c3">3796</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6240">3796</a></div></td><td></td><td><div>16003</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">6241</td><td colspan="7"></td></tr><tr><td class="h">6242</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>12002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">6243</td><td><div class="c3">3796</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6243">50</a></div></td><td></td><td></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless isu($u);</td></tr>
<tr><td class="h">6244</td><td><div class="c3">3796</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6244">50</a></div></td><td></td><td></td><td></td><td><div>20003</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return if $u-&gt;is_expunged;</td></tr>
<tr><td class="h">6245</td><td colspan="7"></td></tr><tr><td class="h">6246</td><td><div class="c3">3796</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6246">50</a></div></td><td></td><td></td><td></td><td><div>12000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = ref $_[0] ? shift : {};</td></tr>
<tr><td class="h">6247</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>12000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my (@props) = @_;</td></tr>
<tr><td class="h">6248</td><td colspan="7"></td></tr><tr><td class="h">6249</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($sql, $sth);</td></tr>
<tr><td class="h">6250</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>16000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_props(&quot;user&quot;);</td></tr>
<tr><td class="h">6251</td><td colspan="7"></td></tr><tr><td class="h">6252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## user reference</td></tr>
<tr><td class="h">6253</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>16001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $u-&gt;userid + 0;</td></tr>
<tr><td class="h">6254</td><td><div class="c3">3796</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6254">50</a></div></td><td></td><td></td><td></td><td><div>20001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$uid = LJ::get_userid( $u-&gt;user ) unless $uid;</td></tr>
<tr><td class="h">6255</td><td colspan="7"></td></tr><tr><td class="h">6256</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mem = {};</td></tr>
<tr><td class="h">6257</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>20002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $use_master = 0;</td></tr>
<tr><td class="h">6258</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $used_slave = 0;  # set later if we ended up using a slave</td></tr>
<tr><td class="h">6259</td><td colspan="7"></td></tr><tr><td class="h">6260</td><td><div class="c3">3796</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6260">100</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (@LJ::MEMCACHE_SERVERS) {</td></tr>
<tr><td class="h">6261</td><td><div class="c3">2548</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @keys;</td></tr>
<tr><td class="h">6262</td><td><div class="c3">2548</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@props) {</td></tr>
<tr><td class="h">6263</td><td><div class="c3">2648</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6263">100</a></div></td><td></td><td></td><td></td><td><div>20002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if exists $u-&gt;{$_};</td></tr>
<tr><td class="h">6264</td><td><div class="c3">283</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;user&quot;, $_);</td></tr>
<tr><td class="h">6265</td><td><div class="c3">283</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6265">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Invalid userprop $_ passed to LJ::load_user_props.&quot; unless $p;</td></tr>
<tr><td class="h">6266</td><td><div class="c3">283</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @keys, [$uid,&quot;uprop:$uid:$p-&gt;{&#39;id&#39;}&quot;];</td></tr>
<tr><td class="h">6267</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6268</td><td><div class="c3">2548</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6268">50</a></div></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mem = LJ::MemCache::get_multi(@keys) || {};</td></tr>
<tr><td class="h">6269</td><td><div class="c3">2548</div></td><td></td><td></td><td></td><td></td><td><div>24000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$use_master = 1;</td></tr>
<tr><td class="h">6270</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6271</td><td colspan="7"></td></tr><tr><td class="h">6272</td><td><div class="c3">3796</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6272">50</a></div></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$use_master = 1 if $opts-&gt;{&#39;use_master&#39;};</td></tr>
<tr><td class="h">6273</td><td colspan="7"></td></tr><tr><td class="h">6274</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @needwrite;  # [propid, propname] entries we need to save to memcache later</td></tr>
<tr><td class="h">6275</td><td colspan="7"></td></tr><tr><td class="h">6276</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>24002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %loadfrom;</td></tr>
<tr><td class="h">6277</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %multihomed; # ( $propid =&gt; 0/1 ) # 0 if we haven&#39;t loaded it, 1 if we have</td></tr>
<tr><td class="h">6278</td><td><div class="c3">3796</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6278">50</a></div></td><td></td><td></td><td></td><td><div>16002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (@props) {</td></tr>
<tr><td class="h">6279</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# case 1: load all props for a given user.</td></tr>
<tr><td class="h">6280</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# multihomed props are stored on userprop and userproplite2, but since they</td></tr>
<tr><td class="h">6281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# should always be in sync, it doesn&#39;t matter which gets loaded first, the</td></tr>
<tr><td class="h">6282</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# net results should be the same.  see doc/server/lj.int.multihomed_userprops.html</td></tr>
<tr><td class="h">6283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# for more information.</td></tr>
<tr><td class="h">6284</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$loadfrom{&#39;userprop&#39;} = 1;</td></tr>
<tr><td class="h">6285</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$loadfrom{&#39;userproplite&#39;} = 1;</td></tr>
<tr><td class="h">6286</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$loadfrom{&#39;userproplite2&#39;} = 1;</td></tr>
<tr><td class="h">6287</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$loadfrom{&#39;userpropblob&#39;} = 1;</td></tr>
<tr><td class="h">6288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6289</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# case 2: load only certain things</td></tr>
<tr><td class="h">6290</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>16002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@props) {</td></tr>
<tr><td class="h">6291</td><td><div class="c3">3936</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6291">100</a></div></td><td></td><td></td><td></td><td><div>32001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if exists $u-&gt;{$_};</td></tr>
<tr><td class="h">6292</td><td><div class="c3">416</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;user&quot;, $_);</td></tr>
<tr><td class="h">6293</td><td><div class="c3">416</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6293">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Invalid userprop $_ passed to LJ::load_user_props.&quot; unless $p;</td></tr>
<tr><td class="h">6294</td><td><div class="c3">416</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6294">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $mem-&gt;{&quot;uprop:$uid:$p-&gt;{&#39;id&#39;}&quot;}) {</td></tr>
<tr><td class="h">6295</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{$_} = $mem-&gt;{&quot;uprop:$uid:$p-&gt;{&#39;id&#39;}&quot;};</td></tr>
<tr><td class="h">6296</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next;</td></tr>
<tr><td class="h">6297</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6298</td><td><div class="c3">416</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @needwrite, [ $p-&gt;{&#39;id&#39;}, $_ ];</td></tr>
<tr><td class="h">6299</td><td><div class="c3">416</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6299">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $source = $p-&gt;{&#39;indexed&#39;} ? &quot;userprop&quot; : &quot;userproplite&quot;;</td></tr>
<tr><td class="h">6300</td><td><div class="c3">416</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6300">100</a></div><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6300">50</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6300">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6300">33</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($p-&gt;{datatype} eq &#39;blobchar&#39;) {</td></tr>
<tr><td class="h">6301</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$source = &quot;userpropblob&quot;; # clustered blob</td></tr>
<tr><td class="h">6302</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elsif ( $p-&gt;{&#39;cldversion&#39;} &amp;&amp; $u-&gt;dversion &gt;= $p-&gt;{&#39;cldversion&#39;} ) {</td></tr>
<tr><td class="h">6304</td><td><div class="c3">414</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$source = &quot;userproplite2&quot;;  # clustered</td></tr>
<tr><td class="h">6305</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6306</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elsif ($p-&gt;{multihomed}) {</td></tr>
<tr><td class="h">6307</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multihomed{$p-&gt;{id}} = 0;</td></tr>
<tr><td class="h">6308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$source = &quot;userproplite2&quot;;</td></tr>
<tr><td class="h">6309</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6310</td><td><div class="c3">416</div><div class="c3">416</div></td><td></td><td></td><td></td><td></td><td><div>4000</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$loadfrom{$source}}, $p-&gt;{&#39;id&#39;};</td></tr>
<tr><td class="h">6311</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6312</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6313</td><td colspan="7"></td></tr><tr><td class="h">6314</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>32002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $table (qw{userproplite userproplite2 userpropblob userprop}) {</td></tr>
<tr><td class="h">6315</td><td><div class="c3">15184</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6315">100</a></div></td><td></td><td></td><td></td><td><div>84006</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless exists $loadfrom{$table};</td></tr>
<tr><td class="h">6316</td><td><div class="c3">396</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db;</td></tr>
<tr><td class="h">6317</td><td><div class="c3">396</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6317">100</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($use_master) {</td></tr>
<tr><td class="h">6318</td><td><div class="c3">267</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6318">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db = ($table =~ m{userprop(lite2|blob)}) ?</td></tr>
<tr><td class="h">6319</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::get_cluster_master($u) :</td></tr>
<tr><td class="h">6320</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::get_db_writer();</td></tr>
<tr><td class="h">6321</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6322</td><td><div class="c3">396</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6322">100</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($db) {</td></tr>
<tr><td class="h">6323</td><td><div class="c3">129</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6323">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db = ($table =~ m{userprop(lite2|blob)}) ?</td></tr>
<tr><td class="h">6324</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::get_cluster_reader($u) :</td></tr>
<tr><td class="h">6325</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::get_db_reader();</td></tr>
<tr><td class="h">6326</td><td><div class="c3">129</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$used_slave = 1;</td></tr>
<tr><td class="h">6327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6328</td><td><div class="c3">396</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql = &quot;SELECT upropid, value FROM $table WHERE userid=$uid&quot;;</td></tr>
<tr><td class="h">6329</td><td><div class="c3">396</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6329">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ref $loadfrom{$table}) {</td></tr>
<tr><td class="h">6330</td><td><div class="c3">396</div><div class="c3">396</div></td><td></td><td></td><td></td><td></td><td><div>4001</div><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql .= &quot; AND upropid IN (&quot; . join(&quot;,&quot;, @{$loadfrom{$table}}) . &quot;)&quot;;</td></tr>
<tr><td class="h">6331</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6332</td><td><div class="c3">396</div></td><td></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth = $db-&gt;prepare($sql);</td></tr>
<tr><td class="h">6333</td><td><div class="c3">396</div></td><td></td><td></td><td></td><td></td><td><div>228015</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">6334</td><td><div class="c3">396</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($id, $v) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">6335</td><td><div class="c3">3</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6335">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $multihomed{$id} if $table eq &#39;userproplite2&#39;;</td></tr>
<tr><td class="h">6336</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{$LJ::CACHE_PROPID{&#39;user&#39;}-&gt;{$id}-&gt;{&#39;name&#39;}} = $v;</td></tr>
<tr><td class="h">6337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6338</td><td colspan="7"></td></tr><tr><td class="h">6339</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# push back multihomed if necessary</td></tr>
<tr><td class="h">6340</td><td><div class="c3">396</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6340">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($table eq &#39;userproplite2&#39;) {</td></tr>
<tr><td class="h">6341</td><td><div class="c3">394</div><div class="c3">394</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$loadfrom{userprop}}, $_ foreach keys %multihomed;</td></tr>
<tr><td class="h">6342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6344</td><td colspan="7"></td></tr><tr><td class="h">6345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# see if we failed to get anything above and need to hit the master.</td></tr>
<tr><td class="h">6346</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# this usually happens the first time a multihomed prop is hit.  this</td></tr>
<tr><td class="h">6347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# code will propagate that prop down to the cluster.</td></tr>
<tr><td class="h">6348</td><td><div class="c3">3796</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6348">50</a></div></td><td></td><td></td><td></td><td><div>12000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%multihomed) {</td></tr>
<tr><td class="h">6349</td><td colspan="7"></td></tr><tr><td class="h">6350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# verify that we got the database handle before we try propagating data</td></tr>
<tr><td class="h">6351</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6351">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;writer) {</td></tr>
<tr><td class="h">6352</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @values;</td></tr>
<tr><td class="h">6353</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $id (keys %multihomed) {</td></tr>
<tr><td class="h">6354</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $pname = $LJ::CACHE_PROPID{user}{$id}{name};</td></tr>
<tr><td class="h">6355</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6355">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6355">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $u-&gt;{$pname} &amp;&amp; $u-&gt;{$pname}) {</td></tr>
<tr><td class="h">6356</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @values, &quot;($uid, $id, &quot; . $u-&gt;quote($u-&gt;{$pname}) . &quot;)&quot;;</td></tr>
<tr><td class="h">6357</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6358</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @values, &quot;($uid, $id, &#39;&#39;)&quot;;</td></tr>
<tr><td class="h">6359</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6361</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;REPLACE INTO userproplite2 VALUES &quot; . join &#39;,&#39;, @values);</td></tr>
<tr><td class="h">6362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6363</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6364</td><td colspan="7"></td></tr><tr><td class="h">6365</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Add defaults to user object.</td></tr>
<tr><td class="h">6366</td><td colspan="7"></td></tr><tr><td class="h">6367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# If this was called with no @props, then the function tried</td></tr>
<tr><td class="h">6368</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# to load all metadata.  but we don&#39;t know what&#39;s missing, so</td></tr>
<tr><td class="h">6369</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# try to apply all defaults.</td></tr>
<tr><td class="h">6370</td><td><div class="c3">3796</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6370">50</a></div></td><td></td><td></td><td></td><td><div>12002</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (@props) { @props = keys %LJ::USERPROP_DEF; }</td></tr>
<tr><td class="h">6371</td><td colspan="7"></td></tr><tr><td class="h">6372</td><td><div class="c3">3796</div></td><td></td><td></td><td></td><td></td><td><div>24001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $prop (@props) {</td></tr>
<tr><td class="h">6373</td><td><div class="c3">3936</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6373">100</a></div></td><td></td><td></td><td></td><td><div>36004</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if (defined $u-&gt;{$prop});</td></tr>
<tr><td class="h">6374</td><td><div class="c3">2916</div></td><td></td><td></td><td></td><td></td><td><div>20001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{$prop} = $LJ::USERPROP_DEF{$prop};</td></tr>
<tr><td class="h">6375</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6376</td><td colspan="7"></td></tr><tr><td class="h">6377</td><td><div class="c3">3796</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6377">100</a></div></td><td></td><td></td><td></td><td><div>20000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($used_slave) {</td></tr>
<tr><td class="h">6378</td><td><div class="c3">3667</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $expire = time() + 3600*24;</td></tr>
<tr><td class="h">6379</td><td><div class="c3">3667</div></td><td></td><td></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $wr (@needwrite) {</td></tr>
<tr><td class="h">6380</td><td><div class="c3">283</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($id, $name) = ($wr-&gt;[0], $wr-&gt;[1]);</td></tr>
<tr><td class="h">6381</td><td><div class="c3">283</div></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L6381">100</a></div></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$uid,&quot;uprop:$uid:$id&quot;], $u-&gt;{$name} || &quot;&quot;, $expire);</td></tr>
<tr><td class="h">6382</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6385</td><td colspan="7"></td></tr><tr><td class="h">6386</td><td colspan="7"></td></tr><tr><td class="h">6387</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::modify_caps</td></tr>
<tr><td class="h">6389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Given a list of caps to add and caps to remove, updates a user&#39;s caps.</td></tr>
<tr><td class="h">6390</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuid, cap_add, cap_del, res</td></tr>
<tr><td class="h">6391</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-cap_add: arrayref of bit numbers to turn on</td></tr>
<tr><td class="h">6392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-cap_del: arrayref of bit numbers to turn off</td></tr>
<tr><td class="h">6393</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-res: hashref returned from &#39;modify_caps&#39; hook</td></tr>
<tr><td class="h">6394</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: updated u object, retrieved from $dbh, then &#39;caps&#39; key modified</td></tr>
<tr><td class="h">6395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#          otherwise, returns 0 unless all hooks run properly.</td></tr>
<tr><td class="h">6396</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6397</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub modify_caps {</td></tr>
<tr><td class="h">6398</td><td><div class="c3">2</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6398">2</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($argu, $cap_add, $cap_del, $res) = @_;</td></tr>
<tr><td class="h">6399</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = LJ::want_userid($argu);</td></tr>
<tr><td class="h">6400</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6400">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $userid;</td></tr>
<tr><td class="h">6401</td><td colspan="7"></td></tr><tr><td class="h">6402</td><td><div class="c3">2</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6402">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cap_add ||= [];</td></tr>
<tr><td class="h">6403</td><td><div class="c3">2</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6403">50</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cap_del ||= [];</td></tr>
<tr><td class="h">6404</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %cap_add_mod = ();</td></tr>
<tr><td class="h">6405</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %cap_del_mod = ();</td></tr>
<tr><td class="h">6406</td><td colspan="7"></td></tr><tr><td class="h">6407</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# convert capnames to bit numbers</td></tr>
<tr><td class="h">6408</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6408">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::are_hooks(&quot;get_cap_bit&quot;)) {</td></tr>
<tr><td class="h">6409</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $bit (@$cap_add, @$cap_del) {</td></tr>
<tr><td class="h">6410</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6410">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $bit =~ /^\d+$/;</td></tr>
<tr><td class="h">6411</td><td colspan="7"></td></tr><tr><td class="h">6412</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# bit is a magical reference into the array</td></tr>
<tr><td class="h">6413</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bit = LJ::run_hook(&quot;get_cap_bit&quot;, $bit);</td></tr>
<tr><td class="h">6414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6416</td><td colspan="7"></td></tr><tr><td class="h">6417</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get a u object directly from the db</td></tr>
<tr><td class="h">6418</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::load_userid($userid, &quot;force&quot;);</td></tr>
<tr><td class="h">6419</td><td colspan="7"></td></tr><tr><td class="h">6420</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# add new caps</td></tr>
<tr><td class="h">6421</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $newcaps = int($u-&gt;{&#39;caps&#39;});</td></tr>
<tr><td class="h">6422</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (@$cap_add) {</td></tr>
<tr><td class="h">6423</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cap = 1 &lt;&lt; $_;</td></tr>
<tr><td class="h">6424</td><td colspan="7"></td></tr><tr><td class="h">6425</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# about to turn bit on, is currently off?</td></tr>
<tr><td class="h">6426</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6426">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cap_add_mod{$_} = 1 unless $newcaps &amp; $cap;</td></tr>
<tr><td class="h">6427</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newcaps |= $cap;</td></tr>
<tr><td class="h">6428</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6429</td><td colspan="7"></td></tr><tr><td class="h">6430</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# remove deleted caps</td></tr>
<tr><td class="h">6431</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (@$cap_del) {</td></tr>
<tr><td class="h">6432</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $cap = 1 &lt;&lt; $_;</td></tr>
<tr><td class="h">6433</td><td colspan="7"></td></tr><tr><td class="h">6434</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# about to turn bit off, is it currently on?</td></tr>
<tr><td class="h">6435</td><td><div class="c3">1</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6435">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cap_del_mod{$_} = 1 if $newcaps &amp; $cap;</td></tr>
<tr><td class="h">6436</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$newcaps &amp;= ~$cap;</td></tr>
<tr><td class="h">6437</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6438</td><td colspan="7"></td></tr><tr><td class="h">6439</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# run hooks for modified bits</td></tr>
<tr><td class="h">6440</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6440">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::are_hooks(&quot;modify_caps&quot;)) {</td></tr>
<tr><td class="h">6441</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res = LJ::run_hook(&quot;modify_caps&quot;,</td></tr>
<tr><td class="h">6442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ &#39;u&#39; =&gt; $u,</td></tr>
<tr><td class="h">6443</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;newcaps&#39; =&gt; $newcaps,</td></tr>
<tr><td class="h">6444</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;oldcaps&#39; =&gt; $u-&gt;{&#39;caps&#39;},</td></tr>
<tr><td class="h">6445</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cap_on_req&#39;  =&gt; { map { $_ =&gt; 1 } @$cap_add },</td></tr>
<tr><td class="h">6446</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cap_off_req&#39; =&gt; { map { $_ =&gt; 1 } @$cap_del },</td></tr>
<tr><td class="h">6447</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cap_on_mod&#39;  =&gt; \%cap_add_mod,</td></tr>
<tr><td class="h">6448</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cap_off_mod&#39; =&gt; \%cap_del_mod,</td></tr>
<tr><td class="h">6449</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</td></tr>
<tr><td class="h">6450</td><td colspan="7"></td></tr><tr><td class="h">6451</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# hook should return a status code</td></tr>
<tr><td class="h">6452</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6452">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef unless defined $res;</td></tr>
<tr><td class="h">6453</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6454</td><td colspan="7"></td></tr><tr><td class="h">6455</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update user row</td></tr>
<tr><td class="h">6456</td><td><div class="c3">2</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6456">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::update_user($u, { &#39;caps&#39; =&gt; $newcaps });</td></tr>
<tr><td class="h">6457</td><td colspan="7"></td></tr><tr><td class="h">6458</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{caps} = $newcaps;</td></tr>
<tr><td class="h">6459</td><td><div class="c3">2</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6459">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$argu-&gt;{caps} = $newcaps if ref $argu; # FIXME: temp hack</td></tr>
<tr><td class="h">6460</td><td><div class="c3">2</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u;</td></tr>
<tr><td class="h">6461</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6462</td><td colspan="7"></td></tr><tr><td class="h">6463</td><td colspan="7"></td></tr><tr><td class="h">6464</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6465</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::set_userprop</td></tr>
<tr><td class="h">6466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Sets/deletes a userprop by name for a user.</td></tr>
<tr><td class="h">6467</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: This adds or deletes from the</td></tr>
<tr><td class="h">6468</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       [dbtable[userprop]]/[dbtable[userproplite]] tables.  One</td></tr>
<tr><td class="h">6469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       crappy thing about this interface is that it doesn&#39;t allow</td></tr>
<tr><td class="h">6470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       a batch of userprops to be updated at once, which is the</td></tr>
<tr><td class="h">6471</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       common thing to do.</td></tr>
<tr><td class="h">6472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, uuserid, propname, value, memonly?</td></tr>
<tr><td class="h">6473</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuserid: The userid of the user or a user hashref.</td></tr>
<tr><td class="h">6474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-propname: The name of the property.  Or a hashref of propname keys and corresponding values.</td></tr>
<tr><td class="h">6475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-value: The value to set to the property.  If undefined or the</td></tr>
<tr><td class="h">6476</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            empty string, then property is deleted.</td></tr>
<tr><td class="h">6477</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-memonly: if true, only writes to memcache, and not to database.</td></tr>
<tr><td class="h">6478</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6479</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_userprop</td></tr>
<tr><td class="h">6480</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">6481</td><td><div class="c3">849</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6481">849</a></div></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">6482</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $propname, $value, $memonly) = @_;</td></tr>
<tr><td class="h">6483</td><td><div class="c3">849</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6483">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = ref $u ? $u : LJ::load_userid($u);</td></tr>
<tr><td class="h">6484</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid + 0;</td></tr>
<tr><td class="h">6485</td><td colspan="7"></td></tr><tr><td class="h">6486</td><td><div class="c3">849</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6486">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $hash = ref $propname eq &quot;HASH&quot; ? $propname : { $propname =&gt; $value };</td></tr>
<tr><td class="h">6487</td><td colspan="7"></td></tr><tr><td class="h">6488</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %action;  # $table -&gt; {&quot;replace&quot;|&quot;delete&quot;} -&gt; [ &quot;($userid, $propid, $qvalue)&quot; | propid ]</td></tr>
<tr><td class="h">6489</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %multihomed;  # { $propid =&gt; $value }</td></tr>
<tr><td class="h">6490</td><td colspan="7"></td></tr><tr><td class="h">6491</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>12000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach $propname (keys %$hash) {</td></tr>
<tr><td class="h">6492</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>12002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hook(&quot;setprop&quot;, prop =&gt; $propname,</td></tr>
<tr><td class="h">6493</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u =&gt; $u, value =&gt; $value);</td></tr>
<tr><td class="h">6494</td><td colspan="7"></td></tr><tr><td class="h">6495</td><td><div class="c3">849</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6495">50</a></div></td><td></td><td></td><td></td><td><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $p = LJ::get_prop(&quot;user&quot;, $propname) or</td></tr>
<tr><td class="h">6496</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Invalid userprop $propname passed to LJ::set_userprop.&quot;;</td></tr>
<tr><td class="h">6497</td><td><div class="c3">849</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6497">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($p-&gt;{multihomed}) {</td></tr>
<tr><td class="h">6498</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# collect into array for later handling</td></tr>
<tr><td class="h">6499</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$multihomed{$p-&gt;{id}} = $hash-&gt;{$propname};</td></tr>
<tr><td class="h">6500</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next;</td></tr>
<tr><td class="h">6501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6502</td><td><div class="c3">849</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6502">100</a></div></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $table = $p-&gt;{&#39;indexed&#39;} ? &quot;userprop&quot; : &quot;userproplite&quot;;</td></tr>
<tr><td class="h">6503</td><td><div class="c3">849</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6503">100</a></div><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6503">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6503">33</a></div></td><td></td><td></td><td><div>8000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($p-&gt;{datatype} eq &#39;blobchar&#39;) {</td></tr>
<tr><td class="h">6504</td><td><div class="c3">4</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$table = &#39;userpropblob&#39;;</td></tr>
<tr><td class="h">6505</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elsif ( $p-&gt;{&#39;cldversion&#39;} &amp;&amp; $u-&gt;dversion &gt;= $p-&gt;{&#39;cldversion&#39;} ) {</td></tr>
<tr><td class="h">6507</td><td><div class="c3">845</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$table = &quot;userproplite2&quot;;</td></tr>
<tr><td class="h">6508</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6509</td><td><div class="c3">849</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6509">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless ($memonly) {</td></tr>
<tr><td class="h">6510</td><td><div class="c3">849</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6510">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6510">33</a></div></td><td></td><td></td><td><div>32002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = $action{$table}-&gt;{&#39;db&#39;} ||= (</td></tr>
<tr><td class="h">6511</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$table !~ m{userprop(lite2|blob)}</td></tr>
<tr><td class="h">6512</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? LJ::get_db_writer()</td></tr>
<tr><td class="h">6513</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: $u-&gt;writer );</td></tr>
<tr><td class="h">6514</td><td><div class="c3">849</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6514">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $db;</td></tr>
<tr><td class="h">6515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6516</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = $hash-&gt;{$propname};</td></tr>
<tr><td class="h">6517</td><td><div class="c3">849</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6517">100</a></div></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--condition.html#L6517">100</a></div></td><td></td><td></td><td><div>24001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $value &amp;&amp; $value) {</td></tr>
<tr><td class="h">6518</td><td><div class="c3">823</div><div class="c3">823</div></td><td></td><td></td><td></td><td></td><td><div>4000</div><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$action{$table}-&gt;{&quot;replace&quot;}}, [ $p-&gt;{&#39;id&#39;}, $value ];</td></tr>
<tr><td class="h">6519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6520</td><td><div class="c3">26</div><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$action{$table}-&gt;{&quot;delete&quot;}}, $p-&gt;{&#39;id&#39;};</td></tr>
<tr><td class="h">6521</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6522</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6523</td><td colspan="7"></td></tr><tr><td class="h">6524</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $expire = time() + 3600*24;</td></tr>
<tr><td class="h">6525</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $table (keys %action) {</td></tr>
<tr><td class="h">6526</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $db = $action{$table}-&gt;{&#39;db&#39;};</td></tr>
<tr><td class="h">6527</td><td><div class="c3">849</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6527">100</a></div></td><td></td><td></td><td></td><td><div>24001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $list = $action{$table}-&gt;{&quot;replace&quot;}) {</td></tr>
<tr><td class="h">6528</td><td><div class="c3">823</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6528">50</a></div></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($db) {</td></tr>
<tr><td class="h">6529</td><td><div class="c3">823</div><div class="c3">823</div></td><td></td><td></td><td></td><td></td><td><div>8000</div><div>12001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $vals = join(&#39;,&#39;, map { &quot;($userid,$_-&gt;[0],&quot; . $db-&gt;quote($_-&gt;[1]) . &quot;)&quot; } @$list);</td></tr>
<tr><td class="h">6530</td><td><div class="c3">823</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;do(&quot;REPLACE INTO $table (userid, upropid, value) VALUES $vals&quot;);</td></tr>
<tr><td class="h">6531</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6532</td><td><div class="c3">823</div><div class="c3">823</div></td><td></td><td></td><td></td><td></td><td><div>4000</div><div>24002</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$userid,&quot;uprop:$userid:$_-&gt;[0]&quot;], $_-&gt;[1], $expire) foreach (@$list);</td></tr>
<tr><td class="h">6533</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6534</td><td><div class="c3">849</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6534">100</a></div></td><td></td><td></td><td></td><td><div>24001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $list = $action{$table}-&gt;{&quot;delete&quot;}) {</td></tr>
<tr><td class="h">6535</td><td><div class="c3">26</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6535">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($db) {</td></tr>
<tr><td class="h">6536</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&#39;,&#39;, @$list);</td></tr>
<tr><td class="h">6537</td><td><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;do(&quot;DELETE FROM $table WHERE userid=$userid AND upropid IN ($in)&quot;);</td></tr>
<tr><td class="h">6538</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6539</td><td><div class="c3">26</div><div class="c3">26</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$userid,&quot;uprop:$userid:$_&quot;], &quot;&quot;, $expire) foreach (@$list);</td></tr>
<tr><td class="h">6540</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6541</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6542</td><td colspan="7"></td></tr><tr><td class="h">6543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we had any multihomed props, set them here</td></tr>
<tr><td class="h">6544</td><td><div class="c3">849</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6544">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%multihomed) {</td></tr>
<tr><td class="h">6545</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">6546</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6546">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6546">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $dbh &amp;&amp; $u-&gt;writer;</td></tr>
<tr><td class="h">6547</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($propid, $pvalue) = each %multihomed) {</td></tr>
<tr><td class="h">6548</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6548">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6548">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined $pvalue &amp;&amp; $pvalue) {</td></tr>
<tr><td class="h">6549</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# replace data into master</td></tr>
<tr><td class="h">6550</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;REPLACE INTO userprop VALUES (?, ?, ?)&quot;,</td></tr>
<tr><td class="h">6551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid, $propid, $pvalue);</td></tr>
<tr><td class="h">6552</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6553</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# delete data from master, but keep in cluster</td></tr>
<tr><td class="h">6554</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM userprop WHERE userid = ? AND upropid = ?&quot;,</td></tr>
<tr><td class="h">6555</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid, $propid);</td></tr>
<tr><td class="h">6556</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6557</td><td colspan="7"></td></tr><tr><td class="h">6558</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fail out?</td></tr>
<tr><td class="h">6559</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6559">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $dbh-&gt;err;</td></tr>
<tr><td class="h">6560</td><td colspan="7"></td></tr><tr><td class="h">6561</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# put data in cluster</td></tr>
<tr><td class="h">6562</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6562">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pvalue ||= &#39;&#39;;</td></tr>
<tr><td class="h">6563</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;REPLACE INTO userproplite2 VALUES (?, ?, ?)&quot;,</td></tr>
<tr><td class="h">6564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid, $propid, $pvalue);</td></tr>
<tr><td class="h">6565</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6565">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $u-&gt;err;</td></tr>
<tr><td class="h">6566</td><td colspan="7"></td></tr><tr><td class="h">6567</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# set memcache</td></tr>
<tr><td class="h">6568</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set([$userid,&quot;uprop:$userid:$propid&quot;], $pvalue, $expire);</td></tr>
<tr><td class="h">6569</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6570</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6571</td><td colspan="7"></td></tr><tr><td class="h">6572</td><td><div class="c3">849</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">6573</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6574</td><td colspan="7"></td></tr><tr><td class="h">6575</td><td colspan="7"></td></tr><tr><td class="h">6576</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">6577</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  8. Formatting Content Shown to Users</td></tr>
<tr><td class="h">6578</td><td colspan="7"></td></tr><tr><td class="h">6579</td><td colspan="7"></td></tr><tr><td class="h">6580</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Returns HTML to display user search results</td></tr>
<tr><td class="h">6581</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Args: %args</td></tr>
<tr><td class="h">6582</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-args:</td></tr>
<tr><td class="h">6583</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           users    =&gt; hash ref of userid =&gt; u object like LJ::load userids</td></tr>
<tr><td class="h">6584</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       returns or array ref of user objects</td></tr>
<tr><td class="h">6585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           userids  =&gt; array ref of userids to include in results, ignored</td></tr>
<tr><td class="h">6586</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       if users is defined</td></tr>
<tr><td class="h">6587</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           timesort =&gt; set to 1 to sort by last updated instead</td></tr>
<tr><td class="h">6588</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       of username</td></tr>
<tr><td class="h">6589</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           perpage  =&gt; Enable pagination and how many users to display on</td></tr>
<tr><td class="h">6590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       each page</td></tr>
<tr><td class="h">6591</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           curpage  =&gt; What page of results to display</td></tr>
<tr><td class="h">6592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           navbar   =&gt; Scalar reference for paging bar</td></tr>
<tr><td class="h">6593</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           pickwd   =&gt; userpic keyword to display instead of default if it</td></tr>
<tr><td class="h">6594</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#                       exists for the user</td></tr>
<tr><td class="h">6595</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           self_link =&gt; Sub ref to generate link to use for pagination</td></tr>
<tr><td class="h">6596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub user_search_display {</td></tr>
<tr><td class="h">6597</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6597">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %args = @_;</td></tr>
<tr><td class="h">6598</td><td colspan="7"></td></tr><tr><td class="h">6599</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $loaded_users;</td></tr>
<tr><td class="h">6600</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6600">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (defined $args{users}) {</td></tr>
<tr><td class="h">6601</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$loaded_users = LJ::load_userids(@{$args{userids}});</td></tr>
<tr><td class="h">6602</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6603</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6603">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6603">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ref $args{users} eq &#39;HASH&#39;) { # Assume this is direct from LJ::load_userids</td></tr>
<tr><td class="h">6604</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$loaded_users = $args{users};</td></tr>
<tr><td class="h">6605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif (ref $args{users} eq &#39;ARRAY&#39;) { # They did a grep on it or something</td></tr>
<tr><td class="h">6606</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@{$args{users}}) {</td></tr>
<tr><td class="h">6607</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$loaded_users-&gt;{$_-&gt;userid} = $_;</td></tr>
<tr><td class="h">6608</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6610</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return undef;</td></tr>
<tr><td class="h">6611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6613</td><td colspan="7"></td></tr><tr><td class="h">6614</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# If we&#39;re sorting by last updated, we need to load that</td></tr>
<tr><td class="h">6615</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# info for all users before the sort.  If sorting by</td></tr>
<tr><td class="h">6616</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# username we can load it for a subset of users later,</td></tr>
<tr><td class="h">6617</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if paginating.</td></tr>
<tr><td class="h">6618</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $updated;</td></tr>
<tr><td class="h">6619</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @display;</td></tr>
<tr><td class="h">6620</td><td colspan="7"></td></tr><tr><td class="h">6621</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6621">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($args{timesort}) {</td></tr>
<tr><td class="h">6622</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$updated = LJ::get_timeupdate_multi(keys %$loaded_users);</td></tr>
<tr><td class="h">6623</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@display = sort { $updated-&gt;{$b-&gt;{userid}} &lt;=&gt; $updated-&gt;{$a-&gt;{userid}} } values %$loaded_users;</td></tr>
<tr><td class="h">6624</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6625</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@display = sort { $a-&gt;{user} cmp $b-&gt;{user} } values %$loaded_users;</td></tr>
<tr><td class="h">6626</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6627</td><td colspan="7"></td></tr><tr><td class="h">6628</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6628">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (defined $args{perpage}) {</td></tr>
<tr><td class="h">6629</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %items = BML::paging(\@display, $args{curpage}, $args{perpage});</td></tr>
<tr><td class="h">6630</td><td colspan="7"></td></tr><tr><td class="h">6631</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Fancy paging bar</td></tr>
<tr><td class="h">6632</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $opts;</td></tr>
<tr><td class="h">6633</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6633">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{self_link} = $args{self_link} if $args{self_link};</td></tr>
<tr><td class="h">6634</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${$args{navbar}} = LJ::paging_bar($items{&#39;page&#39;}, $items{&#39;pages&#39;}, $opts);</td></tr>
<tr><td class="h">6635</td><td colspan="7"></td></tr><tr><td class="h">6636</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Now pull out the set of users to display</td></tr>
<tr><td class="h">6637</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@display = @{$items{&#39;items&#39;}};</td></tr>
<tr><td class="h">6638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6639</td><td colspan="7"></td></tr><tr><td class="h">6640</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# If we aren&#39;t sorting by time updated, load last updated time for the</td></tr>
<tr><td class="h">6641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set of users we are displaying.</td></tr>
<tr><td class="h">6642</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6642">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$updated = LJ::get_timeupdate_multi( map { $_-&gt;userid } @display )</td></tr>
<tr><td class="h">6643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $args{timesort};</td></tr>
<tr><td class="h">6644</td><td colspan="7"></td></tr><tr><td class="h">6645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Allow caller to specify a custom userpic to use instead</td></tr>
<tr><td class="h">6646</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# of the user&#39;s default all userpics</td></tr>
<tr><td class="h">6647</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $get_picid = sub {</td></tr>
<tr><td class="h">6648</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6648">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift;</td></tr>
<tr><td class="h">6649</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6649">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{&#39;defaultpicid&#39;} unless $args{&#39;pickwd&#39;};</td></tr>
<tr><td class="h">6650</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::get_picid_from_keyword($u, $args{&#39;pickwd&#39;});</td></tr>
<tr><td class="h">6651</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">6652</td><td colspan="7"></td></tr><tr><td class="h">6653</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret;</td></tr>
<tr><td class="h">6654</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $u (@display) {</td></tr>
<tr><td class="h">6655</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We should always have loaded user objects, but it seems</td></tr>
<tr><td class="h">6656</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# when the site is overloaded we don&#39;t always load the users</td></tr>
<tr><td class="h">6657</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we request.</td></tr>
<tr><td class="h">6658</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6658">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless LJ::isu($u);</td></tr>
<tr><td class="h">6659</td><td colspan="7"></td></tr><tr><td class="h">6660</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;div class=&#39;user-search-display&#39;&gt;&quot;;</td></tr>
<tr><td class="h">6661</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;table style=&#39;height: 105px&#39;&gt;&lt;tr&gt;&quot;;</td></tr>
<tr><td class="h">6662</td><td colspan="7"></td></tr><tr><td class="h">6663</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td style=&#39;width: 100px; text-align: center;&#39;&gt;&quot;;</td></tr>
<tr><td class="h">6664</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;a href=&#39;&quot; . $u-&gt;allpics_base . &quot;&#39;&gt;&quot;;</td></tr>
<tr><td class="h">6665</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6665">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $picid = $get_picid-&gt;($u)) {</td></tr>
<tr><td class="h">6666</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;img src=&#39;$LJ::USERPIC_ROOT/$picid/&quot; . $u-&gt;userid . &quot;&#39; alt=&#39;&quot;;</td></tr>
<tr><td class="h">6667</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $u-&gt;user . &quot; userpic&#39; style=&#39;border: 1px solid #000;&#39; /&gt;&quot;;</td></tr>
<tr><td class="h">6668</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6669</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;img src=&#39;$LJ::IMGPREFIX/nouserpic.png&#39; alt=&#39;&quot; . BML::ml( &#39;search.user.nopic&#39; );</td></tr>
<tr><td class="h">6670</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&#39; style=&#39;border: 1px solid #000;&#39; width=&#39;100&#39; height=&#39;100&#39; /&gt;&quot;;</td></tr>
<tr><td class="h">6671</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6672</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">6673</td><td colspan="7"></td></tr><tr><td class="h">6674</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td style=&#39;padding-left: 5px;&#39; valign=&#39;top&#39;&gt;&lt;table&gt;&quot;;</td></tr>
<tr><td class="h">6675</td><td colspan="7"></td></tr><tr><td class="h">6676</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr&gt;&lt;td class=&#39;searchusername&#39; colspan=&#39;2&#39; style=&#39;text-align: left;&#39;&gt;&quot;;</td></tr>
<tr><td class="h">6677</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= $u-&gt;ljuser_display({ head_size =&gt; $args{head_size} });</td></tr>
<tr><td class="h">6678</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&quot;;</td></tr>
<tr><td class="h">6679</td><td colspan="7"></td></tr><tr><td class="h">6680</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6680">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;{name}) {</td></tr>
<tr><td class="h">6681</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td width=&#39;1%&#39; style=&#39;font-size: smaller&#39; valign=&#39;top&#39;&gt;&quot; . BML::ml( &#39;search.user.name&#39; );</td></tr>
<tr><td class="h">6682</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td style=&#39;font-size: smaller&#39;&gt;&lt;a href=&#39;&quot; . $u-&gt;profile_url . &quot;&#39;&gt;&quot;;</td></tr>
<tr><td class="h">6683</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::ehtml($u-&gt;{name});</td></tr>
<tr><td class="h">6684</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">6685</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&quot;;</td></tr>
<tr><td class="h">6686</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6687</td><td colspan="7"></td></tr><tr><td class="h">6688</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6688">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $jtitle = $u-&gt;prop(&#39;journaltitle&#39;)) {</td></tr>
<tr><td class="h">6689</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;td width=&#39;1%&#39; style=&#39;font-size: smaller&#39; valign=&#39;top&#39;&gt;&quot; . BML::ml( &#39;search.user.journal&#39; );</td></tr>
<tr><td class="h">6690</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;td style=&#39;font-size: smaller&#39;&gt;&lt;a href=&#39;&quot; . $u-&gt;journal_base . &quot;&#39;&gt;&quot;;</td></tr>
<tr><td class="h">6691</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= LJ::ehtml($jtitle) . &quot;&lt;/a&gt;&quot;;</td></tr>
<tr><td class="h">6692</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</td></tr>
<tr><td class="h">6693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6694</td><td colspan="7"></td></tr><tr><td class="h">6695</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;tr&gt;&lt;td colspan=&#39;2&#39; style=&#39;text-align: left; font-size: smaller&#39; class=&#39;lastupdated&#39;&gt;&quot;;</td></tr>
<tr><td class="h">6696</td><td colspan="7"></td></tr><tr><td class="h">6697</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6697">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $updated-&gt;{$u-&gt;userid} &gt; 0 ) {</td></tr>
<tr><td class="h">6698</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= BML::ml( &#39;search.user.update.last&#39;, { time =&gt; LJ::ago_text( time() - $updated-&gt;{$u-&gt;userid} ) } );</td></tr>
<tr><td class="h">6699</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">6700</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= BML::ml( &#39;search.user.update.never&#39; );</td></tr>
<tr><td class="h">6701</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6702</td><td colspan="7"></td></tr><tr><td class="h">6703</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</td></tr>
<tr><td class="h">6704</td><td colspan="7"></td></tr><tr><td class="h">6705</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/table&gt;&quot;;</td></tr>
<tr><td class="h">6706</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</td></tr>
<tr><td class="h">6707</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret .= &quot;&lt;/table&gt;&lt;/div&gt;&quot;;</td></tr>
<tr><td class="h">6708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6709</td><td colspan="7"></td></tr><tr><td class="h">6710</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">6711</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6712</td><td colspan="7"></td></tr><tr><td class="h">6713</td><td colspan="7"></td></tr><tr><td class="h">6714</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">6715</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  9. Logging and Recording Actions</td></tr>
<tr><td class="h">6716</td><td colspan="7"></td></tr><tr><td class="h">6717</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6718</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::infohistory_add</td></tr>
<tr><td class="h">6719</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Add a line of text to the [[dbtable[infohistory]] table for an account.</td></tr>
<tr><td class="h">6720</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuid, what, value, other?</td></tr>
<tr><td class="h">6721</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuid: User id or user object to insert infohistory for.</td></tr>
<tr><td class="h">6722</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-what: What type of history is being inserted (15 chars max).</td></tr>
<tr><td class="h">6723</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-value: Value for the item (255 chars max).</td></tr>
<tr><td class="h">6724</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-other: Optional. Extra information / notes (30 chars max).</td></tr>
<tr><td class="h">6725</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 on success, 0 on error.</td></tr>
<tr><td class="h">6726</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6727</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub infohistory_add {</td></tr>
<tr><td class="h">6728</td><td><div class="c3">3</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6728">3</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($uuid, $what, $value, $other) = @_;</td></tr>
<tr><td class="h">6729</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$uuid = LJ::want_userid($uuid);</td></tr>
<tr><td class="h">6730</td><td><div class="c3">3</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6730">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6730">25</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $uuid &amp;&amp; $what &amp;&amp; $value;</td></tr>
<tr><td class="h">6731</td><td colspan="7"></td></tr><tr><td class="h">6732</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# get writer and insert</td></tr>
<tr><td class="h">6733</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">6734</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $gmt_now = LJ::mysql_time(time(), 1);</td></tr>
<tr><td class="h">6735</td><td><div class="c3">3</div></td><td></td><td></td><td></td><td></td><td><div>32003</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO infohistory (userid, what, timechange, oldvalue, other) VALUES (?, ?, ?, ?, ?)&quot;,</td></tr>
<tr><td class="h">6736</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $uuid, $what, $gmt_now, $value, $other);</td></tr>
<tr><td class="h">6737</td><td><div class="c3">3</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6737">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $dbh-&gt;err ? 0 : 1;</td></tr>
<tr><td class="h">6738</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6739</td><td colspan="7"></td></tr><tr><td class="h">6740</td><td colspan="7"></td></tr><tr><td class="h">6741</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1 if action is permitted.  0 if above rate or fail.</td></tr>
<tr><td class="h">6742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub rate_check {</td></tr>
<tr><td class="h">6743</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6743">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $ratename, $count, $opts) = @_;</td></tr>
<tr><td class="h">6744</td><td colspan="7"></td></tr><tr><td class="h">6745</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rateperiod = LJ::get_cap($u, &quot;rateperiod-$ratename&quot;);</td></tr>
<tr><td class="h">6746</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6746">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $rateperiod;</td></tr>
<tr><td class="h">6747</td><td colspan="7"></td></tr><tr><td class="h">6748</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6748">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rp = defined $opts-&gt;{&#39;rp&#39;} ? $opts-&gt;{&#39;rp&#39;}</td></tr>
<tr><td class="h">6749</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: LJ::get_prop(&quot;rate&quot;, $ratename);</td></tr>
<tr><td class="h">6750</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6750">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $rp;</td></tr>
<tr><td class="h">6751</td><td colspan="7"></td></tr><tr><td class="h">6752</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6752">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now = defined $opts-&gt;{&#39;now&#39;} ? $opts-&gt;{&#39;now&#39;} : time();</td></tr>
<tr><td class="h">6753</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $beforeperiod = $now - $rateperiod;</td></tr>
<tr><td class="h">6754</td><td colspan="7"></td></tr><tr><td class="h">6755</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check rate.  (okay per period)</td></tr>
<tr><td class="h">6756</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opp = LJ::get_cap($u, &quot;rateallowed-$ratename&quot;);</td></tr>
<tr><td class="h">6757</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6757">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $opp;</td></tr>
<tr><td class="h">6758</td><td colspan="7"></td></tr><tr><td class="h">6759</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check memcache, except in the case of rate limiting by ip</td></tr>
<tr><td class="h">6760</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = $u-&gt;rate_memkey($rp);</td></tr>
<tr><td class="h">6761</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6761">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{limit_by_ip}) {</td></tr>
<tr><td class="h">6762</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $attempts = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">6763</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6763">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($attempts) {</td></tr>
<tr><td class="h">6764</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $num_attempts = 0;</td></tr>
<tr><td class="h">6765</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $attempt (@$attempts) {</td></tr>
<tr><td class="h">6766</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6766">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if $attempt-&gt;{evttime} &lt; $beforeperiod;</td></tr>
<tr><td class="h">6767</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$num_attempts += $attempt-&gt;{quantity};</td></tr>
<tr><td class="h">6768</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6769</td><td colspan="7"></td></tr><tr><td class="h">6770</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6770">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $num_attempts + $count &gt; $opp ? 0 : 1;</td></tr>
<tr><td class="h">6771</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6772</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6773</td><td colspan="7"></td></tr><tr><td class="h">6774</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6774">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;writer;</td></tr>
<tr><td class="h">6775</td><td colspan="7"></td></tr><tr><td class="h">6776</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# delete inapplicable stuff (or some of it)</td></tr>
<tr><td class="h">6777</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">6778</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;DELETE FROM ratelog WHERE userid=$userid AND rlid=$rp-&gt;{&#39;id&#39;} &quot;.</td></tr>
<tr><td class="h">6779</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND evttime &lt; $beforeperiod LIMIT 1000&quot;);</td></tr>
<tr><td class="h">6780</td><td colspan="7"></td></tr><tr><td class="h">6781</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $udbr = LJ::get_cluster_reader($u);</td></tr>
<tr><td class="h">6782</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6782">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6782">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ip = defined $opts-&gt;{&#39;ip&#39;}</td></tr>
<tr><td class="h">6783</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;? $opts-&gt;{&#39;ip&#39;}</td></tr>
<tr><td class="h">6784</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: $udbr-&gt;quote($opts-&gt;{&#39;limit_by_ip&#39;} || &quot;0.0.0.0&quot;);</td></tr>
<tr><td class="h">6785</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $udbr-&gt;prepare(&quot;SELECT evttime, quantity FROM ratelog WHERE &quot;.</td></tr>
<tr><td class="h">6786</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;userid=$userid AND rlid=$rp-&gt;{&#39;id&#39;} &quot;.</td></tr>
<tr><td class="h">6787</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND ip=INET_ATON($ip) &quot;.</td></tr>
<tr><td class="h">6788</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND evttime &gt; $beforeperiod&quot;);</td></tr>
<tr><td class="h">6789</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">6790</td><td colspan="7"></td></tr><tr><td class="h">6791</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @memdata;</td></tr>
<tr><td class="h">6792</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sum = 0;</td></tr>
<tr><td class="h">6793</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my $data = $sth-&gt;fetchrow_hashref) {</td></tr>
<tr><td class="h">6794</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @memdata, $data;</td></tr>
<tr><td class="h">6795</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sum += $data-&gt;{quantity};</td></tr>
<tr><td class="h">6796</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6797</td><td colspan="7"></td></tr><tr><td class="h">6798</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# set memcache, except in the case of rate limiting by ip</td></tr>
<tr><td class="h">6799</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6799">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{limit_by_ip}) {</td></tr>
<tr><td class="h">6800</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6800">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::set( $memkey =&gt; \@memdata || [] );</td></tr>
<tr><td class="h">6801</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6802</td><td colspan="7"></td></tr><tr><td class="h">6803</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# would this transaction go over the limit?</td></tr>
<tr><td class="h">6804</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6804">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($sum + $count &gt; $opp) {</td></tr>
<tr><td class="h">6805</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# TODO: optionally log to rateabuse, unless caller is doing it themselves</td></tr>
<tr><td class="h">6806</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# somehow, like with the &quot;loginstall&quot; table.</td></tr>
<tr><td class="h">6807</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</td></tr>
<tr><td class="h">6808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6809</td><td colspan="7"></td></tr><tr><td class="h">6810</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">6811</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6812</td><td colspan="7"></td></tr><tr><td class="h">6813</td><td colspan="7"></td></tr><tr><td class="h">6814</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns 1 if action is permitted.  0 if above rate or fail.</td></tr>
<tr><td class="h">6815</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># action isn&#39;t logged on fail.</td></tr>
<tr><td class="h">6816</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">6817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># opts keys:</td></tr>
<tr><td class="h">6818</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   -- &quot;limit_by_ip&quot; =&gt; &quot;1.2.3.4&quot;  (when used for checking rate)</td></tr>
<tr><td class="h">6819</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#   --</td></tr>
<tr><td class="h">6820</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub rate_log</td></tr>
<tr><td class="h">6821</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">6822</td><td><div class="c3">34</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6822">34</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $ratename, $count, $opts) = @_;</td></tr>
<tr><td class="h">6823</td><td><div class="c3">34</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rateperiod = LJ::get_cap($u, &quot;rateperiod-$ratename&quot;);</td></tr>
<tr><td class="h">6824</td><td><div class="c3">34</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6824">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $rateperiod;</td></tr>
<tr><td class="h">6825</td><td colspan="7"></td></tr><tr><td class="h">6826</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6826">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $u-&gt;writer;</td></tr>
<tr><td class="h">6827</td><td colspan="7"></td></tr><tr><td class="h">6828</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $rp = LJ::get_prop(&quot;rate&quot;, $ratename);</td></tr>
<tr><td class="h">6829</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6829">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $rp;</td></tr>
<tr><td class="h">6830</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;rp&#39;} = $rp;</td></tr>
<tr><td class="h">6831</td><td colspan="7"></td></tr><tr><td class="h">6832</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $now = time();</td></tr>
<tr><td class="h">6833</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;now&#39;} = $now;</td></tr>
<tr><td class="h">6834</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $udbr = LJ::get_cluster_reader($u);</td></tr>
<tr><td class="h">6835</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6835">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ip = $udbr-&gt;quote($opts-&gt;{&#39;limit_by_ip&#39;} || &quot;0.0.0.0&quot;);</td></tr>
<tr><td class="h">6836</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;ip&#39;} = $ip;</td></tr>
<tr><td class="h">6837</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6837">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless LJ::rate_check($u, $ratename, $count, $opts);</td></tr>
<tr><td class="h">6838</td><td colspan="7"></td></tr><tr><td class="h">6839</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# log current</td></tr>
<tr><td class="h">6840</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$count = $count + 0;</td></tr>
<tr><td class="h">6841</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">6842</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do(&quot;INSERT INTO ratelog (userid, rlid, evttime, ip, quantity) VALUES &quot;.</td></tr>
<tr><td class="h">6843</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;($userid, $rp-&gt;{&#39;id&#39;}, $now, INET_ATON($ip), $count)&quot;);</td></tr>
<tr><td class="h">6844</td><td colspan="7"></td></tr><tr><td class="h">6845</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# delete memcache, except in the case of rate limiting by ip</td></tr>
<tr><td class="h">6846</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6846">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{limit_by_ip}) {</td></tr>
<tr><td class="h">6847</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete($u-&gt;rate_memkey($rp));</td></tr>
<tr><td class="h">6848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6849</td><td colspan="7"></td></tr><tr><td class="h">6850</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">6851</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6852</td><td colspan="7"></td></tr><tr><td class="h">6853</td><td colspan="7"></td></tr><tr><td class="h">6854</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">6855</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  12. Comment-Related Functions</td></tr>
<tr><td class="h">6856</td><td colspan="7"></td></tr><tr><td class="h">6857</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6858</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::delete_all_comments</td></tr>
<tr><td class="h">6859</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: deletes all comments from a post, permanently, for when a post is deleted</td></tr>
<tr><td class="h">6860</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: The tables [dbtable[talk2]], [dbtable[talkprop2]], [dbtable[talktext2]],</td></tr>
<tr><td class="h">6861</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       are deleted from, immediately.</td></tr>
<tr><td class="h">6862</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, nodetype, nodeid</td></tr>
<tr><td class="h">6863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-nodetype: The thread nodetype (probably &#39;L&#39; for log items).</td></tr>
<tr><td class="h">6864</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-nodeid: The thread nodeid for the given nodetype (probably the jitemid</td></tr>
<tr><td class="h">6865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             from the [dbtable[log2]] row).</td></tr>
<tr><td class="h">6866</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: boolean; success value</td></tr>
<tr><td class="h">6867</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6868</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub delete_all_comments {</td></tr>
<tr><td class="h">6869</td><td><div class="c3">1</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6869">1</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $nodetype, $nodeid) = @_;</td></tr>
<tr><td class="h">6870</td><td colspan="7"></td></tr><tr><td class="h">6871</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcm = LJ::get_cluster_master($u);</td></tr>
<tr><td class="h">6872</td><td><div class="c3">1</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6872">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6872">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $dbcm &amp;&amp; $u-&gt;writer;</td></tr>
<tr><td class="h">6873</td><td colspan="7"></td></tr><tr><td class="h">6874</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# delete comments</td></tr>
<tr><td class="h">6875</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($t, $loop) = (undef, 1);</td></tr>
<tr><td class="h">6876</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $chunk_size = 200;</td></tr>
<tr><td class="h">6877</td><td><div class="c3">1</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6877">20</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while ($loop &amp;&amp;</td></tr>
<tr><td class="h">6878</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($t = $dbcm-&gt;selectcol_arrayref(&quot;SELECT jtalkid FROM talk2 WHERE &quot;.</td></tr>
<tr><td class="h">6879</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;nodetype=? AND journalid=? &quot;.</td></tr>
<tr><td class="h">6880</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND nodeid=? LIMIT $chunk_size&quot;, undef,</td></tr>
<tr><td class="h">6881</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nodetype, $u-&gt;userid, $nodeid))</td></tr>
<tr><td class="h">6882</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; $t &amp;&amp; @$t)</td></tr>
<tr><td class="h">6883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">6884</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $in = join(&#39;,&#39;, map { $_+0 } @$t);</td></tr>
<tr><td class="h">6885</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6885">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1 unless $in;</td></tr>
<tr><td class="h">6886</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $table (qw(talkprop2 talktext2 talk2)) {</td></tr>
<tr><td class="h">6887</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;do( &quot;DELETE FROM $table WHERE journalid=? AND jtalkid IN ($in)&quot;,</td></tr>
<tr><td class="h">6888</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $u-&gt;userid );</td></tr>
<tr><td class="h">6889</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# decrement memcache</td></tr>
<tr><td class="h">6891</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::decr( [$u-&gt;userid, &quot;talk2ct:&quot; . $u-&gt;userid], scalar(@$t) );</td></tr>
<tr><td class="h">6892</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6892">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$loop = 0 unless @$t == $chunk_size;</td></tr>
<tr><td class="h">6893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">6894</td><td><div class="c3">1</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">6895</td><td colspan="7"></td></tr><tr><td class="h">6896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6897</td><td colspan="7"></td></tr><tr><td class="h">6898</td><td colspan="7"></td></tr><tr><td class="h">6899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">6900</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  13. Community-Related Functions and Authas</td></tr>
<tr><td class="h">6901</td><td colspan="7"></td></tr><tr><td class="h">6902</td><td colspan="7"></td></tr><tr><td class="h">6903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_delete_journal_item {</td></tr>
<tr><td class="h">6904</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6904">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::can_manage(@_);</td></tr>
<tr><td class="h">6905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6906</td><td colspan="7"></td></tr><tr><td class="h">6907</td><td colspan="7"></td></tr><tr><td class="h">6908</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6909</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::can_manage</td></tr>
<tr><td class="h">6910</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Given a user and a target user, will determine if the first user is an</td></tr>
<tr><td class="h">6911</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      admin for the target user.</td></tr>
<tr><td class="h">6912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: bool: true if authorized, otherwise fail</td></tr>
<tr><td class="h">6913</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: remote, u</td></tr>
<tr><td class="h">6914</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-remote: user object or userid of user to try and authenticate</td></tr>
<tr><td class="h">6915</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: user object or userid of target user</td></tr>
<tr><td class="h">6916</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6917</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_manage {</td></tr>
<tr><td class="h">6918</td><td><div class="c3">11</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6918">11</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::want_user(shift);</td></tr>
<tr><td class="h">6919</td><td><div class="c3">11</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::want_user(shift);</td></tr>
<tr><td class="h">6920</td><td><div class="c3">11</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6920">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6920">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $remote &amp;&amp; $u;</td></tr>
<tr><td class="h">6921</td><td colspan="7"></td></tr><tr><td class="h">6922</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# is same user?</td></tr>
<tr><td class="h">6923</td><td><div class="c3">11</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6923">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if LJ::u_equals($u, $remote);</td></tr>
<tr><td class="h">6924</td><td colspan="7"></td></tr><tr><td class="h">6925</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# people/syn/rename accounts can only be managed by the one account</td></tr>
<tr><td class="h">6926</td><td><div class="c3">11</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6926">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef if $u-&gt;journaltype =~ /^[PYR]$/;</td></tr>
<tr><td class="h">6927</td><td colspan="7"></td></tr><tr><td class="h">6928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check for admin access</td></tr>
<tr><td class="h">6929</td><td><div class="c3">11</div></td><td><div class="c3" title="T/F"><a href="cgi-bin-LJ-User-pm--branch.html#L6929">100</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::check_rel($u, $remote, &#39;A&#39;);</td></tr>
<tr><td class="h">6930</td><td colspan="7"></td></tr><tr><td class="h">6931</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# passed checks, return true</td></tr>
<tr><td class="h">6932</td><td><div class="c3">6</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">6933</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6934</td><td colspan="7"></td></tr><tr><td class="h">6935</td><td colspan="7"></td></tr><tr><td class="h">6936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6937</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::can_manage_other</td></tr>
<tr><td class="h">6938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Given a user and a target user, will determine if the first user is an</td></tr>
<tr><td class="h">6939</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      admin for the target user, but not if the two are the same.</td></tr>
<tr><td class="h">6940</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: remote, u</td></tr>
<tr><td class="h">6941</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-remote: user object or userid of user to try and authenticate</td></tr>
<tr><td class="h">6942</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-u: user object or userid of target user</td></tr>
<tr><td class="h">6943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: bool: true if authorized, otherwise fail</td></tr>
<tr><td class="h">6944</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6945</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_manage_other {</td></tr>
<tr><td class="h">6946</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6946">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($remote, $u) = @_;</td></tr>
<tr><td class="h">6947</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6947">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if LJ::want_userid($remote) == LJ::want_userid($u);</td></tr>
<tr><td class="h">6948</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return LJ::can_manage($remote, $u);</td></tr>
<tr><td class="h">6949</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6950</td><td colspan="7"></td></tr><tr><td class="h">6951</td><td colspan="7"></td></tr><tr><td class="h">6952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6953</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_authas_list</td></tr>
<tr><td class="h">6954</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Get a list of usernames a given user can authenticate as.</td></tr>
<tr><td class="h">6955</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: an array of usernames.</td></tr>
<tr><td class="h">6956</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, opts?</td></tr>
<tr><td class="h">6957</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: Optional hashref.  keys are:</td></tr>
<tr><td class="h">6958</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - type: &#39;P&#39; to only return users of journaltype &#39;P&#39;.</td></tr>
<tr><td class="h">6959</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - cap:  cap to filter users on.</td></tr>
<tr><td class="h">6960</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6961</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_authas_list {</td></tr>
<tr><td class="h">6962</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L6962">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $opts) = @_;</td></tr>
<tr><td class="h">6963</td><td colspan="7"></td></tr><tr><td class="h">6964</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# used to accept a user type, now accept an opts hash</td></tr>
<tr><td class="h">6965</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6965">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts = { &#39;type&#39; =&gt; $opts } unless ref $opts;</td></tr>
<tr><td class="h">6966</td><td colspan="7"></td></tr><tr><td class="h">6967</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# Two valid types, Personal or Community</td></tr>
<tr><td class="h">6968</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6968">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;type&#39;} = undef unless $opts-&gt;{&#39;type&#39;} =~ m/^(P|C)$/;</td></tr>
<tr><td class="h">6969</td><td colspan="7"></td></tr><tr><td class="h">6970</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ids = LJ::load_rel_target($u, &#39;A&#39;);</td></tr>
<tr><td class="h">6971</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6971">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $ids;</td></tr>
<tr><td class="h">6972</td><td colspan="7"></td></tr><tr><td class="h">6973</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load_userids_multiple</td></tr>
<tr><td class="h">6974</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %users;</td></tr>
<tr><td class="h">6975</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userids_multiple([ map { $_, \$users{$_} } @$ids ], [$u]);</td></tr>
<tr><td class="h">6976</td><td colspan="7"></td></tr><tr><td class="h">6977</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6977">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return map { $_-&gt;user }</td></tr>
<tr><td class="h">6978</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6978">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { ! $opts-&gt;{&#39;cap&#39;} || LJ::get_cap($_, $opts-&gt;{&#39;cap&#39;}) }</td></tr>
<tr><td class="h">6979</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6979">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L6979">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { ! $opts-&gt;{&#39;type&#39;} || $opts-&gt;{&#39;type&#39;} eq $_-&gt;{&#39;journaltype&#39;} }</td></tr>
<tr><td class="h">6980</td><td colspan="7"></td></tr><tr><td class="h">6981</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# unless overridden, hide non-visible/non-read-only journals. always display the user&#39;s acct</td></tr>
<tr><td class="h">6982</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L6982">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { $opts-&gt;{&#39;showall&#39;} || $_-&gt;is_visible || $_-&gt;is_readonly || LJ::u_equals($_, $u) }</td></tr>
<tr><td class="h">6983</td><td colspan="7"></td></tr><tr><td class="h">6984</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# can&#39;t work as an expunged account</td></tr>
<tr><td class="h">6985</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { ! $_-&gt;is_expunged &amp;&amp; $_-&gt;clusterid &gt; 0 }</td></tr>
<tr><td class="h">6986</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u,  sort { $a-&gt;user cmp $b-&gt;user } values %users;</td></tr>
<tr><td class="h">6987</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">6988</td><td colspan="7"></td></tr><tr><td class="h">6989</td><td colspan="7"></td></tr><tr><td class="h">6990</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">6991</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::get_postto_list</td></tr>
<tr><td class="h">6992</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Get the list of usernames a given user can post to.</td></tr>
<tr><td class="h">6993</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: an array of usernames</td></tr>
<tr><td class="h">6994</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, opts?</td></tr>
<tr><td class="h">6995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-opts: Optional hashref.  keys are:</td></tr>
<tr><td class="h">6996</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - type: &#39;P&#39; to only return users of journaltype &#39;P&#39;.</td></tr>
<tr><td class="h">6997</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#           - cap:  cap to filter users on.</td></tr>
<tr><td class="h">6998</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">6999</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_postto_list {</td></tr>
<tr><td class="h">7000</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7000">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $opts) = @_;</td></tr>
<tr><td class="h">7001</td><td colspan="7"></td></tr><tr><td class="h">7002</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# used to accept a user type, now accept an opts hash</td></tr>
<tr><td class="h">7003</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7003">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts = { &#39;type&#39; =&gt; $opts } unless ref $opts;</td></tr>
<tr><td class="h">7004</td><td colspan="7"></td></tr><tr><td class="h">7005</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# only one valid type right now</td></tr>
<tr><td class="h">7006</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7006">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;type&#39;} = &#39;P&#39; if $opts-&gt;{&#39;type&#39;};</td></tr>
<tr><td class="h">7007</td><td colspan="7"></td></tr><tr><td class="h">7008</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ids = LJ::load_rel_target($u, &#39;P&#39;);</td></tr>
<tr><td class="h">7009</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7009">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $ids;</td></tr>
<tr><td class="h">7010</td><td colspan="7"></td></tr><tr><td class="h">7011</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load_userids_multiple</td></tr>
<tr><td class="h">7012</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %users;</td></tr>
<tr><td class="h">7013</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::load_userids_multiple([ map { $_, \$users{$_} } @$ids ], [$u]);</td></tr>
<tr><td class="h">7014</td><td colspan="7"></td></tr><tr><td class="h">7015</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7015">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;user, sort map { $_-&gt;user }</td></tr>
<tr><td class="h">7016</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7016">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { ! $opts-&gt;{&#39;cap&#39;} || LJ::get_cap($_, $opts-&gt;{&#39;cap&#39;}) }</td></tr>
<tr><td class="h">7017</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { ! $opts-&gt;{&#39;type&#39;} || $opts-&gt;{&#39;type&#39;} eq $_-&gt;{&#39;journaltype&#39;} }</td></tr>
<tr><td class="h">7018</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { $_-&gt;clusterid &gt; 0 }</td></tr>
<tr><td class="h">7019</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;grep { $_-&gt;is_visible }</td></tr>
<tr><td class="h">7020</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values %users;</td></tr>
<tr><td class="h">7021</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7022</td><td colspan="7"></td></tr><tr><td class="h">7023</td><td colspan="7"></td></tr><tr><td class="h">7024</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">7025</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  15. Email-Related Functions</td></tr>
<tr><td class="h">7026</td><td colspan="7"></td></tr><tr><td class="h">7027</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_email {</td></tr>
<tr><td class="h">7028</td><td><div class="c3">326</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7028">326</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($userid, $email) = @_;</td></tr>
<tr><td class="h">7029</td><td colspan="7"></td></tr><tr><td class="h">7030</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">7031</td><td><div class="c3">326</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L7031">50</a></div></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::DEBUG{&#39;write_emails_to_user_table&#39;}) {</td></tr>
<tr><td class="h">7032</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE user SET email=? WHERE userid=?&quot;, undef,</td></tr>
<tr><td class="h">7033</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email, $userid);</td></tr>
<tr><td class="h">7034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7035</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>1224064</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;REPLACE INTO email (userid, email) VALUES (?, ?)&quot;,</td></tr>
<tr><td class="h">7036</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid, $email);</td></tr>
<tr><td class="h">7037</td><td colspan="7"></td></tr><tr><td class="h">7038</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update caches</td></tr>
<tr><td class="h">7039</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($userid, &quot;userid&quot;);</td></tr>
<tr><td class="h">7040</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete([$userid, &quot;email:$userid&quot;]);</td></tr>
<tr><td class="h">7041</td><td><div class="c3">326</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L7041">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cache = $LJ::REQ_CACHE_USER_ID{$userid} or return;</td></tr>
<tr><td class="h">7042</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cache-&gt;{&#39;_email&#39;} = $email;</td></tr>
<tr><td class="h">7043</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7044</td><td colspan="7"></td></tr><tr><td class="h">7045</td><td colspan="7"></td></tr><tr><td class="h">7046</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">7047</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  16. Entry-Related Functions</td></tr>
<tr><td class="h">7048</td><td colspan="7"></td></tr><tr><td class="h">7049</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">7050</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::can_view</td></tr>
<tr><td class="h">7051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Checks to see if the remote user can view a given journal entry.</td></tr>
<tr><td class="h">7052</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      &lt;b&gt;Note:&lt;/b&gt; This is meant for use on single entries at a time,</td></tr>
<tr><td class="h">7053</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      not for calling many times on every entry in a journal.</td></tr>
<tr><td class="h">7054</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: boolean; 1 if remote user can see item</td></tr>
<tr><td class="h">7055</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: remote, item</td></tr>
<tr><td class="h">7056</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-item: Hashref from the &#39;log&#39; table.</td></tr>
<tr><td class="h">7057</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">7058</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub can_view</td></tr>
<tr><td class="h">7059</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7060</td><td colspan="7"></td></tr><tr><td class="h">7061</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># TODO: fold this into LJ::Entry-&gt;visible_to :(</td></tr>
<tr><td class="h">7062</td><td colspan="7"></td></tr><tr><td class="h">7063</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7063">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">7064</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $remote, $item ) = @_;</td></tr>
<tr><td class="h">7065</td><td colspan="7"></td></tr><tr><td class="h">7066</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# public is okay</td></tr>
<tr><td class="h">7067</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7067">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $item-&gt;{&#39;security&#39;} eq &quot;public&quot;;</td></tr>
<tr><td class="h">7068</td><td colspan="7"></td></tr><tr><td class="h">7069</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# must be logged in otherwise</td></tr>
<tr><td class="h">7070</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7070">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $remote;</td></tr>
<tr><td class="h">7071</td><td colspan="7"></td></tr><tr><td class="h">7072</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7072">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = int($item-&gt;{&#39;ownerid&#39;} || $item-&gt;{&#39;journalid&#39;});</td></tr>
<tr><td class="h">7073</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remoteid = int( $remote-&gt;userid );</td></tr>
<tr><td class="h">7074</td><td colspan="7"></td></tr><tr><td class="h">7075</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# owners can always see their own.</td></tr>
<tr><td class="h">7076</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7076">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $userid == $remoteid;</td></tr>
<tr><td class="h">7077</td><td colspan="7"></td></tr><tr><td class="h">7078</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# other people can&#39;t read private</td></tr>
<tr><td class="h">7079</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7079">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 if $item-&gt;{&#39;security&#39;} eq &quot;private&quot;;</td></tr>
<tr><td class="h">7080</td><td colspan="7"></td></tr><tr><td class="h">7081</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# should be &#39;usemask&#39; security from here out, otherwise</td></tr>
<tr><td class="h">7082</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# assume it&#39;s something new and return 0</td></tr>
<tr><td class="h">7083</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7083">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $item-&gt;{&#39;security&#39;} eq &quot;usemask&quot;;</td></tr>
<tr><td class="h">7084</td><td colspan="7"></td></tr><tr><td class="h">7085</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if it&#39;s usemask, we have to refuse non-personal journals,</td></tr>
<tr><td class="h">7086</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# so we have to load the user</td></tr>
<tr><td class="h">7087</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7087">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 0 unless $remote-&gt;is_individual;</td></tr>
<tr><td class="h">7088</td><td colspan="7"></td></tr><tr><td class="h">7089</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# this far down we have to load the user</td></tr>
<tr><td class="h">7090</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7090">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::want_user( $userid ) or return 0;</td></tr>
<tr><td class="h">7091</td><td colspan="7"></td></tr><tr><td class="h">7092</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# check if it&#39;s a community and they&#39;re a member</td></tr>
<tr><td class="h">7093</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7093">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7093">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1 if $u-&gt;is_community &amp;&amp;</td></tr>
<tr><td class="h">7094</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote-&gt;member_of( $u );</td></tr>
<tr><td class="h">7095</td><td colspan="7"></td></tr><tr><td class="h">7096</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now load allowmask</td></tr>
<tr><td class="h">7097</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $allowed = ( $u-&gt;trustmask( $remoteid ) &amp; int($item-&gt;{&#39;allowmask&#39;}) );</td></tr>
<tr><td class="h">7098</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7098">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $allowed ? 1 : 0;  # no need to return matching mask</td></tr>
<tr><td class="h">7099</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7100</td><td colspan="7"></td></tr><tr><td class="h">7101</td><td colspan="7"></td></tr><tr><td class="h">7102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">7103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  17. Interest-Related Functions</td></tr>
<tr><td class="h">7104</td><td colspan="7"></td></tr><tr><td class="h">7105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># $opts is optional, with keys:</td></tr>
<tr><td class="h">7106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    forceids =&gt; 1   : don&#39;t use memcache for loading the intids</td></tr>
<tr><td class="h">7107</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    forceints =&gt; 1   : don&#39;t use memcache for loading the interest rows</td></tr>
<tr><td class="h">7108</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#    justids =&gt; 1 : return arrayref of intids only, not names/counts</td></tr>
<tr><td class="h">7109</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns otherwise an arrayref of interest rows, sorted by interest name</td></tr>
<tr><td class="h">7110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_interests</td></tr>
<tr><td class="h">7111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7112</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7112">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $opts) = @_;</td></tr>
<tr><td class="h">7113</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7113">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts ||= {};</td></tr>
<tr><td class="h">7114</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7114">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $u;</td></tr>
<tr><td class="h">7115</td><td colspan="7"></td></tr><tr><td class="h">7116</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# first check request cache inside $u</td></tr>
<tr><td class="h">7117</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7117">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (my $ints = $u-&gt;{_cache_interests}) {</td></tr>
<tr><td class="h">7118</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7118">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{justids}) {</td></tr>
<tr><td class="h">7119</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return [ map { $_-&gt;[0] } @$ints ];</td></tr>
<tr><td class="h">7120</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7121</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $ints;</td></tr>
<tr><td class="h">7122</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7123</td><td colspan="7"></td></tr><tr><td class="h">7124</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $u-&gt;userid;</td></tr>
<tr><td class="h">7125</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7125">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uitable = $u-&gt;is_community ? &#39;comminterests&#39; : &#39;userinterests&#39;;</td></tr>
<tr><td class="h">7126</td><td colspan="7"></td></tr><tr><td class="h">7127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load the ids</td></tr>
<tr><td class="h">7128</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ids;</td></tr>
<tr><td class="h">7129</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mk_ids = [$uid, &quot;intids:$uid&quot;];</td></tr>
<tr><td class="h">7130</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7130">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ids = LJ::MemCache::get($mk_ids) unless $opts-&gt;{&#39;forceids&#39;};</td></tr>
<tr><td class="h">7131</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7131">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7131">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($ids &amp;&amp; ref $ids eq &quot;ARRAY&quot;) {</td></tr>
<tr><td class="h">7132</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ids = [];</td></tr>
<tr><td class="h">7133</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">7134</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbh-&gt;prepare(&quot;SELECT intid FROM $uitable WHERE userid=?&quot;);</td></tr>
<tr><td class="h">7135</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($uid);</td></tr>
<tr><td class="h">7136</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$ids, $_ while ($_) = $sth-&gt;fetchrow_array;</td></tr>
<tr><td class="h">7137</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add($mk_ids, $ids, 3600*12);</td></tr>
<tr><td class="h">7138</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7139</td><td colspan="7"></td></tr><tr><td class="h">7140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: set a &#39;justids&#39; $u cache key in this case, then only return that</td></tr>
<tr><td class="h">7141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;#        later if &#39;justids&#39; is requested?  probably not worth it.</td></tr>
<tr><td class="h">7142</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7142">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ids if $opts-&gt;{&#39;justids&#39;};</td></tr>
<tr><td class="h">7143</td><td colspan="7"></td></tr><tr><td class="h">7144</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# load interest rows</td></tr>
<tr><td class="h">7145</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %need;</td></tr>
<tr><td class="h">7146</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$need{$_} = 1 foreach @$ids;</td></tr>
<tr><td class="h">7147</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @ret;</td></tr>
<tr><td class="h">7148</td><td colspan="7"></td></tr><tr><td class="h">7149</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7149">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($opts-&gt;{&#39;forceints&#39;}) {</td></tr>
<tr><td class="h">7150</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7150">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (my $mc = LJ::MemCache::get_multi(map { [$_, &quot;introw:$_&quot;] } @$ids)) {</td></tr>
<tr><td class="h">7151</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($k, $v) = each %$mc) {</td></tr>
<tr><td class="h">7152</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7152">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $k =~ /^introw:(\d+)/;</td></tr>
<tr><td class="h">7153</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $need{$1};</td></tr>
<tr><td class="h">7154</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @ret, $v;</td></tr>
<tr><td class="h">7155</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7158</td><td colspan="7"></td></tr><tr><td class="h">7159</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7159">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%need) {</td></tr>
<tr><td class="h">7160</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $ids = join(&quot;,&quot;, map { $_+0 } keys %need);</td></tr>
<tr><td class="h">7161</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">7162</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbr-&gt;prepare(&quot;SELECT intid, interest, intcount FROM interests &quot;.</td></tr>
<tr><td class="h">7163</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE intid IN ($ids)&quot;);</td></tr>
<tr><td class="h">7164</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">7165</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $memc_store = 0;</td></tr>
<tr><td class="h">7166</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($intid, $int, $count) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">7167</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# minimize latency... only store 25 into memcache at a time</td></tr>
<tr><td class="h">7168</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# (too bad we don&#39;t have set_multi.... hmmmm)</td></tr>
<tr><td class="h">7169</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $aref = [$intid, $int, $count];</td></tr>
<tr><td class="h">7170</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7170">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($memc_store++ &lt; 25) {</td></tr>
<tr><td class="h">7171</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if the count is fairly high, keep item in memcache longer,</td></tr>
<tr><td class="h">7172</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# since count&#39;s not so important.</td></tr>
<tr><td class="h">7173</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7173">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $expire = $count &lt; 10 ? 3600*12 : 3600*48;</td></tr>
<tr><td class="h">7174</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add([$intid, &quot;introw:$intid&quot;], $aref, $expire);</td></tr>
<tr><td class="h">7175</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7176</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @ret, $aref;</td></tr>
<tr><td class="h">7177</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7178</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7179</td><td colspan="7"></td></tr><tr><td class="h">7180</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;@ret = sort { $a-&gt;[1] cmp $b-&gt;[1] } @ret;</td></tr>
<tr><td class="h">7181</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $u-&gt;{_cache_interests} = \@ret;</td></tr>
<tr><td class="h">7182</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7183</td><td colspan="7"></td></tr><tr><td class="h">7184</td><td colspan="7"></td></tr><tr><td class="h">7185</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub interest_string_to_list {</td></tr>
<tr><td class="h">7186</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7186">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $intstr = shift;</td></tr>
<tr><td class="h">7187</td><td colspan="7"></td></tr><tr><td class="h">7188</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$intstr =~ s/^\s+//;  # strip leading space</td></tr>
<tr><td class="h">7189</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$intstr =~ s/\s+$//;  # strip trailing space</td></tr>
<tr><td class="h">7190</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$intstr =~ s/\n/,/g;  # newlines become commas</td></tr>
<tr><td class="h">7191</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$intstr =~ s/\s+/ /g; # strip duplicate spaces from the interest</td></tr>
<tr><td class="h">7192</td><td colspan="7"></td></tr><tr><td class="h">7193</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# final list is ,-sep</td></tr>
<tr><td class="h">7194</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return grep { length } split (/\s*,\s*/, $intstr);</td></tr>
<tr><td class="h">7195</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7196</td><td colspan="7"></td></tr><tr><td class="h">7197</td><td colspan="7"></td></tr><tr><td class="h">7198</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">7199</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::set_interests</td></tr>
<tr><td class="h">7200</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Change a user&#39;s interests.</td></tr>
<tr><td class="h">7201</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, u, old, new</td></tr>
<tr><td class="h">7202</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-old: hashref of old interests (hashing being interest =&gt; intid)</td></tr>
<tr><td class="h">7203</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-new: listref of new interests</td></tr>
<tr><td class="h">7204</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: 1 on success, undef on failure</td></tr>
<tr><td class="h">7205</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">7206</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_interests</td></tr>
<tr><td class="h">7207</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7208</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7208">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $old, $new) = @_;</td></tr>
<tr><td class="h">7209</td><td colspan="7"></td></tr><tr><td class="h">7210</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user($u);</td></tr>
<tr><td class="h">7211</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $userid = $u-&gt;userid;</td></tr>
<tr><td class="h">7212</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7212">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $userid;</td></tr>
<tr><td class="h">7213</td><td colspan="7"></td></tr><tr><td class="h">7214</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7214">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless ref $old eq &#39;HASH&#39;;</td></tr>
<tr><td class="h">7215</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7215">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless ref $new eq &#39;ARRAY&#39;;</td></tr>
<tr><td class="h">7216</td><td colspan="7"></td></tr><tr><td class="h">7217</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">7218</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %int_new = ();</td></tr>
<tr><td class="h">7219</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my %int_del = %$old;  # assume deleting everything, unless in @$new</td></tr>
<tr><td class="h">7220</td><td colspan="7"></td></tr><tr><td class="h">7221</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# user interests go in a different table than user interests,</td></tr>
<tr><td class="h">7222</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# though the schemas are the same so we can run the same queries on them</td></tr>
<tr><td class="h">7223</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7223">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uitable = $u-&gt;is_community ? &#39;comminterests&#39; : &#39;userinterests&#39;;</td></tr>
<tr><td class="h">7224</td><td colspan="7"></td></tr><tr><td class="h">7225</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# track if we made changes to refresh memcache later.</td></tr>
<tr><td class="h">7226</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $did_mod = 0;</td></tr>
<tr><td class="h">7227</td><td colspan="7"></td></tr><tr><td class="h">7228</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @valid_ints = LJ::validate_interest_list(@$new);</td></tr>
<tr><td class="h">7229</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $int (@valid_ints)</td></tr>
<tr><td class="h">7230</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">7231</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7231">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$int_new{$int} = 1 unless $old-&gt;{$int};</td></tr>
<tr><td class="h">7232</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $int_del{$int};</td></tr>
<tr><td class="h">7233</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7234</td><td colspan="7"></td></tr><tr><td class="h">7235</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### were interests removed?</td></tr>
<tr><td class="h">7236</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7236">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%int_del)</td></tr>
<tr><td class="h">7237</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">7238</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## easy, we know their IDs, so delete them en masse</td></tr>
<tr><td class="h">7239</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $intid_in = join(&quot;, &quot;, values %int_del);</td></tr>
<tr><td class="h">7240</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;DELETE FROM $uitable WHERE userid=$userid AND intid IN ($intid_in)&quot;);</td></tr>
<tr><td class="h">7241</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE interests SET intcount=intcount-1 WHERE intid IN ($intid_in)&quot;);</td></tr>
<tr><td class="h">7242</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$did_mod = 1;</td></tr>
<tr><td class="h">7243</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7244</td><td colspan="7"></td></tr><tr><td class="h">7245</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### do we have new interests to add?</td></tr>
<tr><td class="h">7246</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @new_intids = ();  ## existing IDs we&#39;ll add for this user</td></tr>
<tr><td class="h">7247</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7247">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%int_new)</td></tr>
<tr><td class="h">7248</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">7249</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$did_mod = 1;</td></tr>
<tr><td class="h">7250</td><td colspan="7"></td></tr><tr><td class="h">7251</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## difficult, have to find intids of interests, and create new ints for interests</td></tr>
<tr><td class="h">7252</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## that nobody has ever entered before</td></tr>
<tr><td class="h">7253</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $int_in = join(&quot;, &quot;, map { $dbh-&gt;quote($_); } keys %int_new);</td></tr>
<tr><td class="h">7254</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %int_exist;</td></tr>
<tr><td class="h">7255</td><td colspan="7"></td></tr><tr><td class="h">7256</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## find existing IDs</td></tr>
<tr><td class="h">7257</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbh-&gt;prepare(&quot;SELECT interest, intid FROM interests WHERE interest IN ($int_in)&quot;);</td></tr>
<tr><td class="h">7258</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">7259</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while (my ($intr, $intid) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">7260</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @new_intids, $intid;       # - we&#39;ll add this later.</td></tr>
<tr><td class="h">7261</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete $int_new{$intr};         # - so we don&#39;t have to make a new intid for</td></tr>
<tr><td class="h">7262</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#   this next pass.</td></tr>
<tr><td class="h">7263</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7264</td><td colspan="7"></td></tr><tr><td class="h">7265</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7265">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (@new_intids) {</td></tr>
<tr><td class="h">7266</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $sql = &quot;&quot;;</td></tr>
<tr><td class="h">7267</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $newid (@new_intids) {</td></tr>
<tr><td class="h">7268</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7268">0</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($sql) { $sql .= &quot;, &quot;; }</td></tr>
<tr><td class="h">7269</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else { $sql = &quot;REPLACE INTO $uitable (userid, intid) VALUES &quot;; }</td></tr>
<tr><td class="h">7270</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql .= &quot;($userid, $newid)&quot;;</td></tr>
<tr><td class="h">7271</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7272</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do($sql);</td></tr>
<tr><td class="h">7273</td><td colspan="7"></td></tr><tr><td class="h">7274</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $intid_in = join(&quot;, &quot;, @new_intids);</td></tr>
<tr><td class="h">7275</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE interests SET intcount=intcount+1 WHERE intid IN ($intid_in)&quot;);</td></tr>
<tr><td class="h">7276</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7277</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7278</td><td colspan="7"></td></tr><tr><td class="h">7279</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;### do we STILL have interests to add?  (must make new intids)</td></tr>
<tr><td class="h">7280</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7280">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (%int_new)</td></tr>
<tr><td class="h">7281</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">7282</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $int (keys %int_new)</td></tr>
<tr><td class="h">7283</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">7284</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $intid;</td></tr>
<tr><td class="h">7285</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $qint = $dbh-&gt;quote($int);</td></tr>
<tr><td class="h">7286</td><td colspan="7"></td></tr><tr><td class="h">7287</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO interests (intid, intcount, interest) &quot;.</td></tr>
<tr><td class="h">7288</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES (NULL, 1, $qint)&quot;);</td></tr>
<tr><td class="h">7289</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7289">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($dbh-&gt;err) {</td></tr>
<tr><td class="h">7290</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# somebody beat us to creating it.  find its id.</td></tr>
<tr><td class="h">7291</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$intid = $dbh-&gt;selectrow_array(&quot;SELECT intid FROM interests WHERE interest=$qint&quot;);</td></tr>
<tr><td class="h">7292</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE interests SET intcount=intcount+1 WHERE intid=$intid&quot;);</td></tr>
<tr><td class="h">7293</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">7294</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# newly created</td></tr>
<tr><td class="h">7295</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$intid = $dbh-&gt;{&#39;mysql_insertid&#39;};</td></tr>
<tr><td class="h">7296</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7297</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7297">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($intid) {</td></tr>
<tr><td class="h">7298</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;## now we can actually insert it into the userinterests table:</td></tr>
<tr><td class="h">7299</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;INSERT INTO $uitable (userid, intid) &quot;.</td></tr>
<tr><td class="h">7300</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;VALUES ($userid, $intid)&quot;);</td></tr>
<tr><td class="h">7301</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @new_intids, $intid;</td></tr>
<tr><td class="h">7302</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7303</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7304</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7305</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;set_interests&quot;, $u, \%int_del, \@new_intids); # interest =&gt; intid</td></tr>
<tr><td class="h">7306</td><td colspan="7"></td></tr><tr><td class="h">7307</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do migrations to clean up userinterests vs comminterests conflicts</td></tr>
<tr><td class="h">7308</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;lazy_interests_cleanup;</td></tr>
<tr><td class="h">7309</td><td colspan="7"></td></tr><tr><td class="h">7310</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7310">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($u, &quot;intids&quot;) if $did_mod;</td></tr>
<tr><td class="h">7311</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7311">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{_cache_interests} = undef if $did_mod;</td></tr>
<tr><td class="h">7312</td><td colspan="7"></td></tr><tr><td class="h">7313</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return 1;</td></tr>
<tr><td class="h">7314</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7315</td><td colspan="7"></td></tr><tr><td class="h">7316</td><td colspan="7"></td></tr><tr><td class="h">7317</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub validate_interest_list {</td></tr>
<tr><td class="h">7318</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7318">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7318">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $interrors = ref $_[0] eq &quot;ARRAY&quot; ? shift : [];</td></tr>
<tr><td class="h">7319</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @ints = @_;</td></tr>
<tr><td class="h">7320</td><td colspan="7"></td></tr><tr><td class="h">7321</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @valid_ints = ();</td></tr>
<tr><td class="h">7322</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $int (@ints) {</td></tr>
<tr><td class="h">7323</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$int = lc($int);       # FIXME: use utf8?</td></tr>
<tr><td class="h">7324</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$int =~ s/^i like //;  # *sigh*</td></tr>
<tr><td class="h">7325</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7325">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless $int;</td></tr>
<tr><td class="h">7326</td><td colspan="7"></td></tr><tr><td class="h">7327</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Specific interest failures</td></tr>
<tr><td class="h">7328</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($bytes,$chars) = LJ::text_length($int);</td></tr>
<tr><td class="h">7329</td><td colspan="7"></td></tr><tr><td class="h">7330</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $error_string = &#39;&#39;;</td></tr>
<tr><td class="h">7331</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7331">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($int =~ /[\&lt;\&gt;]/) {</td></tr>
<tr><td class="h">7332</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$int = LJ::ehtml($int);</td></tr>
<tr><td class="h">7333</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error_string .= &#39;.invalid&#39;;</td></tr>
<tr><td class="h">7334</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">7335</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7335">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error_string .= &#39;.bytes&#39; if $bytes &gt; LJ::BMAX_INTEREST;</td></tr>
<tr><td class="h">7336</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7336">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error_string .= &#39;.chars&#39; if $chars &gt; LJ::CMAX_INTEREST;</td></tr>
<tr><td class="h">7337</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7338</td><td colspan="7"></td></tr><tr><td class="h">7339</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7339">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($error_string) {</td></tr>
<tr><td class="h">7340</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error_string = &quot;error.interest$error_string&quot;;</td></tr>
<tr><td class="h">7341</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$interrors, [ $error_string,</td></tr>
<tr><td class="h">7342</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ int =&gt; $int,</td></tr>
<tr><td class="h">7343</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytes =&gt; $bytes,</td></tr>
<tr><td class="h">7344</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytes_max =&gt; LJ::BMAX_INTEREST,</td></tr>
<tr><td class="h">7345</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chars =&gt; $chars,</td></tr>
<tr><td class="h">7346</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chars_max =&gt; LJ::CMAX_INTEREST</td></tr>
<tr><td class="h">7347</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7348</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];</td></tr>
<tr><td class="h">7349</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next;</td></tr>
<tr><td class="h">7350</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7351</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @valid_ints, $int;</td></tr>
<tr><td class="h">7352</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7353</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return @valid_ints;</td></tr>
<tr><td class="h">7354</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7355</td><td colspan="7"></td></tr><tr><td class="h">7356</td><td colspan="7"></td></tr><tr><td class="h">7357</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">7358</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  19. OpenID and Identity Functions</td></tr>
<tr><td class="h">7359</td><td colspan="7"></td></tr><tr><td class="h">7360</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># create externally mapped user.</td></tr>
<tr><td class="h">7361</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return uid of LJ user on success, undef on error.</td></tr>
<tr><td class="h">7362</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># opts = {</td></tr>
<tr><td class="h">7363</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#     extuser or extuserid (or both, but one is required.),</td></tr>
<tr><td class="h">7364</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#     caps</td></tr>
<tr><td class="h">7365</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># }</td></tr>
<tr><td class="h">7366</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># opts also can contain any additional options that create_account takes. (caps?)</td></tr>
<tr><td class="h">7367</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub create_extuser</td></tr>
<tr><td class="h">7368</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7369</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7369">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($type, $opts) = @_;</td></tr>
<tr><td class="h">7370</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7370">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7370">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $type &amp;&amp; $LJ::EXTERNAL_NAMESPACE{$type}-&gt;{id};</td></tr>
<tr><td class="h">7371</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7371">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7371">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless ref $opts &amp;&amp;</td></tr>
<tr><td class="h">7372</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($opts-&gt;{extuser} || defined $opts-&gt;{extuserid});</td></tr>
<tr><td class="h">7373</td><td colspan="7"></td></tr><tr><td class="h">7374</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid;</td></tr>
<tr><td class="h">7375</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">7376</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7376">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $dbh;</td></tr>
<tr><td class="h">7377</td><td colspan="7"></td></tr><tr><td class="h">7378</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# make sure a mapping for this user doesn&#39;t already exist.</td></tr>
<tr><td class="h">7379</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$uid = LJ::get_extuser_uid( $type, $opts, &#39;force&#39; );</td></tr>
<tr><td class="h">7380</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7380">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $uid if $uid;</td></tr>
<tr><td class="h">7381</td><td colspan="7"></td></tr><tr><td class="h">7382</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# increment ext_ counter until we successfully create an LJ account.</td></tr>
<tr><td class="h">7383</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# hard cap it at 10 tries. (arbitrary, but we really shouldn&#39;t have *any*</td></tr>
<tr><td class="h">7384</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# failures here, let alone 10 in a row.)</td></tr>
<tr><td class="h">7385</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;for (1..10) {</td></tr>
<tr><td class="h">7386</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $extuser = &#39;ext_&#39; . LJ::alloc_global_counter( &#39;E&#39; );</td></tr>
<tr><td class="h">7387</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uid =</td></tr>
<tr><td class="h">7388</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::create_account(</td></tr>
<tr><td class="h">7389</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ caps =&gt; $opts-&gt;{caps}, user =&gt; $extuser, name =&gt; $extuser } );</td></tr>
<tr><td class="h">7390</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7390">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last if $uid;</td></tr>
<tr><td class="h">7391</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;select undef, undef, undef, .10;  # lets not thrash over this.</td></tr>
<tr><td class="h">7392</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7393</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7393">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $uid;</td></tr>
<tr><td class="h">7394</td><td colspan="7"></td></tr><tr><td class="h">7395</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# add extuser mapping.</td></tr>
<tr><td class="h">7396</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sql = &quot;INSERT INTO extuser SET userid=?, siteid=?&quot;;</td></tr>
<tr><td class="h">7397</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @bind = ($uid, $LJ::EXTERNAL_NAMESPACE{$type}-&gt;{id});</td></tr>
<tr><td class="h">7398</td><td colspan="7"></td></tr><tr><td class="h">7399</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7399">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{extuser}) {</td></tr>
<tr><td class="h">7400</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql .= &quot;, extuser=?&quot;;</td></tr>
<tr><td class="h">7401</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @bind, $opts-&gt;{extuser};</td></tr>
<tr><td class="h">7402</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7403</td><td colspan="7"></td></tr><tr><td class="h">7404</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7404">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{extuserid}) {</td></tr>
<tr><td class="h">7405</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql .= &quot;, extuserid=? &quot;;</td></tr>
<tr><td class="h">7406</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @bind, $opts-&gt;{extuserid}+0;</td></tr>
<tr><td class="h">7407</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7408</td><td colspan="7"></td></tr><tr><td class="h">7409</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7409">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do($sql, undef, @bind) or return undef;</td></tr>
<tr><td class="h">7410</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $uid;</td></tr>
<tr><td class="h">7411</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7412</td><td colspan="7"></td></tr><tr><td class="h">7413</td><td colspan="7"></td></tr><tr><td class="h">7414</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># given a LJ userid/u, return a hashref of:</td></tr>
<tr><td class="h">7415</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># type, extuser, extuserid</td></tr>
<tr><td class="h">7416</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns undef if user isn&#39;t an externally mapped account.</td></tr>
<tr><td class="h">7417</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_extuser_map</td></tr>
<tr><td class="h">7418</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7419</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7419">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = LJ::want_userid(shift);</td></tr>
<tr><td class="h">7420</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7420">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $uid;</td></tr>
<tr><td class="h">7421</td><td colspan="7"></td></tr><tr><td class="h">7422</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">7423</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7423">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $dbr;</td></tr>
<tr><td class="h">7424</td><td colspan="7"></td></tr><tr><td class="h">7425</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sql = &quot;SELECT * FROM extuser WHERE userid=?&quot;;</td></tr>
<tr><td class="h">7426</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $ret = $dbr-&gt;selectrow_hashref($sql, undef, $uid);</td></tr>
<tr><td class="h">7427</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7427">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $ret;</td></tr>
<tr><td class="h">7428</td><td colspan="7"></td></tr><tr><td class="h">7429</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $type = &#39;unknown&#39;;</td></tr>
<tr><td class="h">7430</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach ( keys %LJ::EXTERNAL_NAMESPACE ) {</td></tr>
<tr><td class="h">7431</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7431">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$type = $_ if $LJ::EXTERNAL_NAMESPACE{$_}-&gt;{id} == $ret-&gt;{siteid};</td></tr>
<tr><td class="h">7432</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7433</td><td colspan="7"></td></tr><tr><td class="h">7434</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$ret-&gt;{type} = $type;</td></tr>
<tr><td class="h">7435</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $ret;</td></tr>
<tr><td class="h">7436</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7437</td><td colspan="7"></td></tr><tr><td class="h">7438</td><td colspan="7"></td></tr><tr><td class="h">7439</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># given an extuserid or extuser, return the LJ uid.</td></tr>
<tr><td class="h">7440</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># return undef if there is no mapping.</td></tr>
<tr><td class="h">7441</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_extuser_uid</td></tr>
<tr><td class="h">7442</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7443</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7443">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($type, $opts, $force) = @_;</td></tr>
<tr><td class="h">7444</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7444">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7444">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $type &amp;&amp; $LJ::EXTERNAL_NAMESPACE{$type}-&gt;{id};</td></tr>
<tr><td class="h">7445</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7445">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7445">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless ref $opts &amp;&amp;</td></tr>
<tr><td class="h">7446</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($opts-&gt;{extuser} || defined $opts-&gt;{extuserid});</td></tr>
<tr><td class="h">7447</td><td colspan="7"></td></tr><tr><td class="h">7448</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7448">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = $force ? LJ::get_db_writer() : LJ::get_db_reader();</td></tr>
<tr><td class="h">7449</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7449">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $dbh;</td></tr>
<tr><td class="h">7450</td><td colspan="7"></td></tr><tr><td class="h">7451</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sql = &quot;SELECT userid FROM extuser WHERE siteid=?&quot;;</td></tr>
<tr><td class="h">7452</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @bind = ($LJ::EXTERNAL_NAMESPACE{$type}-&gt;{id});</td></tr>
<tr><td class="h">7453</td><td colspan="7"></td></tr><tr><td class="h">7454</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7454">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{extuser}) {</td></tr>
<tr><td class="h">7455</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql .= &quot; AND extuser=?&quot;;</td></tr>
<tr><td class="h">7456</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @bind, $opts-&gt;{extuser};</td></tr>
<tr><td class="h">7457</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7458</td><td colspan="7"></td></tr><tr><td class="h">7459</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7459">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{extuserid}) {</td></tr>
<tr><td class="h">7460</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7460">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql .= $opts-&gt;{extuser} ? &#39; OR &#39; : &#39; AND &#39;;</td></tr>
<tr><td class="h">7461</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql .= &quot;extuserid=?&quot;;</td></tr>
<tr><td class="h">7462</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @bind, $opts-&gt;{extuserid}+0;</td></tr>
<tr><td class="h">7463</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7464</td><td colspan="7"></td></tr><tr><td class="h">7465</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $dbh-&gt;selectrow_array($sql, undef, @bind);</td></tr>
<tr><td class="h">7466</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7467</td><td colspan="7"></td></tr><tr><td class="h">7468</td><td colspan="7"></td></tr><tr><td class="h">7469</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">7470</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  21. Password Functions</td></tr>
<tr><td class="h">7471</td><td colspan="7"></td></tr><tr><td class="h">7472</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># Checks if they are flagged as having a bad password and redirects</td></tr>
<tr><td class="h">7473</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># to changepassword.bml.  If returl is on it returns the URL to</td></tr>
<tr><td class="h">7474</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># redirect to vs doing the redirect itself.  Useful in non-BML context</td></tr>
<tr><td class="h">7475</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># and for QuickReply links</td></tr>
<tr><td class="h">7476</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub bad_password_redirect {</td></tr>
<tr><td class="h">7477</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7477">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $opts = shift;</td></tr>
<tr><td class="h">7478</td><td colspan="7"></td></tr><tr><td class="h">7479</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $remote = LJ::get_remote();</td></tr>
<tr><td class="h">7480</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7480">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $remote;</td></tr>
<tr><td class="h">7481</td><td colspan="7"></td></tr><tr><td class="h">7482</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7482">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless LJ::is_enabled(&#39;force_pass_change&#39;);</td></tr>
<tr><td class="h">7483</td><td colspan="7"></td></tr><tr><td class="h">7484</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7484">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return undef unless $remote-&gt;prop(&#39;badpassword&#39;);</td></tr>
<tr><td class="h">7485</td><td colspan="7"></td></tr><tr><td class="h">7486</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $redir = &quot;$LJ::SITEROOT/changepassword&quot;;</td></tr>
<tr><td class="h">7487</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7487">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless (defined $opts-&gt;{&#39;returl&#39;}) {</td></tr>
<tr><td class="h">7488</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return BML::redirect($redir);</td></tr>
<tr><td class="h">7489</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">7490</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $redir;</td></tr>
<tr><td class="h">7491</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7492</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7493</td><td colspan="7"></td></tr><tr><td class="h">7494</td><td colspan="7"></td></tr><tr><td class="h">7495</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub set_password {</td></tr>
<tr><td class="h">7496</td><td><div class="c3">326</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7496">326</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($userid, $password) = @_;</td></tr>
<tr><td class="h">7497</td><td colspan="7"></td></tr><tr><td class="h">7498</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer();</td></tr>
<tr><td class="h">7499</td><td><div class="c3">326</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L7499">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::DEBUG{&#39;write_passwords_to_user_table&#39;}) {</td></tr>
<tr><td class="h">7500</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;UPDATE user SET password=? WHERE userid=?&quot;, undef,</td></tr>
<tr><td class="h">7501</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$password, $userid);</td></tr>
<tr><td class="h">7502</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7503</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>1052062</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$dbh-&gt;do(&quot;REPLACE INTO password (userid, password) VALUES (?, ?)&quot;,</td></tr>
<tr><td class="h">7504</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;undef, $userid, $password);</td></tr>
<tr><td class="h">7505</td><td colspan="7"></td></tr><tr><td class="h">7506</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# update caches</td></tr>
<tr><td class="h">7507</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::memcache_kill($userid, &quot;userid&quot;);</td></tr>
<tr><td class="h">7508</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::delete([$userid, &quot;pw:$userid&quot;]);</td></tr>
<tr><td class="h">7509</td><td><div class="c3">326</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L7509">50</a></div></td><td></td><td></td><td></td><td><div>8001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $cache = $LJ::REQ_CACHE_USER_ID{$userid} or return;</td></tr>
<tr><td class="h">7510</td><td><div class="c3">326</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$cache-&gt;{&#39;_password&#39;} = $password;</td></tr>
<tr><td class="h">7511</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7512</td><td colspan="7"></td></tr><tr><td class="h">7513</td><td colspan="7"></td></tr><tr><td class="h">7514</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">7515</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  22. Priv-Related Functions</td></tr>
<tr><td class="h">7516</td><td colspan="7"></td></tr><tr><td class="h">7517</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">7518</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::load_user_privs</td></tr>
<tr><td class="h">7519</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class:</td></tr>
<tr><td class="h">7520</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: loads all of the given privs for a given user into a hashref, inside</td></tr>
<tr><td class="h">7521</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#      the user record.  See also [func[LJ::check_priv]].</td></tr>
<tr><td class="h">7522</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: u, priv, arg?</td></tr>
<tr><td class="h">7523</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-priv: Priv names to load (see [dbtable[priv_list]]).</td></tr>
<tr><td class="h">7524</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-arg: Optional argument.  See also [func[LJ::check_priv]].</td></tr>
<tr><td class="h">7525</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: boolean</td></tr>
<tr><td class="h">7526</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">7527</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_user_privs</td></tr>
<tr><td class="h">7528</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7529</td><td><div class="c3">36</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7529">36</a></div></td><td></td><td><div>4001</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">7530</td><td><div class="c3">36</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ( $remote, @privs ) = @_;</td></tr>
<tr><td class="h">7531</td><td><div class="c3">36</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L7531">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7531">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $remote and @privs;</td></tr>
<tr><td class="h">7532</td><td colspan="7"></td></tr><tr><td class="h">7533</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# return if we&#39;ve already loaded these privs for this user.</td></tr>
<tr><td class="h">7534</td><td><div class="c3">36</div><div class="c3">36</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;@privs = grep { ! $remote-&gt;{&#39;_privloaded&#39;}-&gt;{$_} } @privs;</td></tr>
<tr><td class="h">7535</td><td><div class="c3">36</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L7535">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless @privs;</td></tr>
<tr><td class="h">7536</td><td colspan="7"></td></tr><tr><td class="h">7537</td><td><div class="c3">36</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbr = LJ::get_db_reader();</td></tr>
<tr><td class="h">7538</td><td><div class="c3">36</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L7538">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $dbr;</td></tr>
<tr><td class="h">7539</td><td><div class="c3">36</div><div class="c3">36</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach (@privs) { $remote-&gt;{&#39;_privloaded&#39;}-&gt;{$_}++; }</td></tr>
<tr><td class="h">7540</td><td><div class="c3">36</div><div class="c3">36</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;@privs = map { $dbr-&gt;quote($_) } @privs;</td></tr>
<tr><td class="h">7541</td><td><div class="c3">36</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbr-&gt;prepare( &quot;SELECT pl.privcode, pm.arg &quot;.</td></tr>
<tr><td class="h">7542</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM priv_map pm, priv_list pl &quot;.</td></tr>
<tr><td class="h">7543</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE pm.prlid=pl.prlid AND &quot;.</td></tr>
<tr><td class="h">7544</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pl.privcode IN (&quot; . join(&#39;,&#39;,@privs) . &quot;) &quot;.</td></tr>
<tr><td class="h">7545</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AND pm.userid=&quot; . $remote-&gt;userid );</td></tr>
<tr><td class="h">7546</td><td><div class="c3">36</div></td><td></td><td></td><td></td><td></td><td><div>64004</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute;</td></tr>
<tr><td class="h">7547</td><td><div class="c3">36</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($priv, $arg) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">7548</td><td><div class="c3">16</div><div class="c0">0</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L7548">50</a></div></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless (defined $arg) { $arg = &quot;&quot;; }  # NULL -&gt; &quot;&quot;</td></tr>
<tr><td class="h">7549</td><td><div class="c3">16</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote-&gt;{&#39;_priv&#39;}-&gt;{$priv}-&gt;{$arg} = 1;</td></tr>
<tr><td class="h">7550</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7551</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7552</td><td colspan="7"></td></tr><tr><td class="h">7553</td><td colspan="7"></td></tr><tr><td class="h">7554</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">7555</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  24. Styles and S2-Related Functions</td></tr>
<tr><td class="h">7556</td><td colspan="7"></td></tr><tr><td class="h">7557</td><td colspan="7"></td></tr><tr><td class="h">7558</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns undef on error, or otherwise arrayref of arrayrefs,</td></tr>
<tr><td class="h">7559</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># each of format [ year, month, day, count ] for all days with</td></tr>
<tr><td class="h">7560</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># non-zero count.  examples:</td></tr>
<tr><td class="h">7561</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#  [ [ 2003, 6, 5, 3 ], [ 2003, 6, 8, 4 ], ... ]</td></tr>
<tr><td class="h">7562</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#</td></tr>
<tr><td class="h">7563</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub get_daycounts</td></tr>
<tr><td class="h">7564</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7565</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7565">0</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($u, $remote, $not_memcache) = @_;</td></tr>
<tr><td class="h">7566</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# NOTE: $remote not yet used.  one of the oldest LJ shortcomings is that</td></tr>
<tr><td class="h">7567</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# it&#39;s public how many entries users have per-day, even if the entries</td></tr>
<tr><td class="h">7568</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# are protected.  we&#39;ll be fixing that with a new table, but first</td></tr>
<tr><td class="h">7569</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# we&#39;re moving everything to this API.</td></tr>
<tr><td class="h">7570</td><td colspan="7"></td></tr><tr><td class="h">7571</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7571">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u = LJ::want_user( $u ) or return undef;</td></tr>
<tr><td class="h">7572</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $uid = $u-&gt;id;</td></tr>
<tr><td class="h">7573</td><td colspan="7"></td></tr><tr><td class="h">7574</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkind = &#39;p&#39;; # public only, changed below</td></tr>
<tr><td class="h">7575</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $secwhere = &quot;AND security=&#39;public&#39;&quot;;</td></tr>
<tr><td class="h">7576</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $viewall = 0;</td></tr>
<tr><td class="h">7577</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7577">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($remote) {</td></tr>
<tr><td class="h">7578</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# do they have the viewall priv?</td></tr>
<tr><td class="h">7579</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $r = eval { Apache-&gt;request; }; # web context</td></tr>
<tr><td class="h">7580</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7580">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %getargs = $r-&gt;args if $r;</td></tr>
<tr><td class="h">7581</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7581">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7581">0</a></div><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7581">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( defined $getargs{&#39;viewall&#39;} and $getargs{&#39;viewall&#39;} eq &#39;1&#39; and ( $remote &amp;&amp; $remote-&gt;has_priv( &#39;canview&#39;, &#39;*&#39; ) ) ) {</td></tr>
<tr><td class="h">7582</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$viewall = 1;</td></tr>
<tr><td class="h">7583</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::statushistory_add( $u-&gt;userid, $remote-&gt;userid,</td></tr>
<tr><td class="h">7584</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;viewall&quot;, &quot;calendar&quot; );</td></tr>
<tr><td class="h">7585</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7586</td><td colspan="7"></td></tr><tr><td class="h">7587</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7587">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7587">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7587">0</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $remote-&gt;userid == $uid || $viewall ) {</td></tr>
<tr><td class="h">7588</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$secwhere = &quot;&quot;;   # see everything</td></tr>
<tr><td class="h">7589</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$memkind = &#39;a&#39;; # all</td></tr>
<tr><td class="h">7590</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( $remote-&gt;is_individual ) {</td></tr>
<tr><td class="h">7591</td><td colspan="7"></td></tr><tr><td class="h">7592</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if we&#39;re viewing a community, we intuit the security mask from the membership</td></tr>
<tr><td class="h">7593</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $gmask = 0;</td></tr>
<tr><td class="h">7594</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7594">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;is_community ) {</td></tr>
<tr><td class="h">7595</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7595">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$gmask = 1</td></tr>
<tr><td class="h">7596</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $remote-&gt;member_of( $u );</td></tr>
<tr><td class="h">7597</td><td colspan="7"></td></tr><tr><td class="h">7598</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">7599</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$gmask = $u-&gt;trustmask( $remote );</td></tr>
<tr><td class="h">7600</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7601</td><td colspan="7"></td></tr><tr><td class="h">7602</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7602">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $gmask ) {</td></tr>
<tr><td class="h">7603</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$secwhere = &quot;AND (security=&#39;public&#39; OR (security=&#39;usemask&#39; AND allowmask &amp; $gmask))&quot;;</td></tr>
<tr><td class="h">7604</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$memkind = &#39;g&#39; . $gmask; # friends case: allowmask == gmask == 1</td></tr>
<tr><td class="h">7605</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7606</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7607</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7608</td><td colspan="7"></td></tr><tr><td class="h">7609</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">7610</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## the first element of array, that is stored in memcache,</td></tr>
<tr><td class="h">7611</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## is the time of the creation of the list. The memcache is</td></tr>
<tr><td class="h">7612</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;## invalid if there are new entries in journal since that time.</td></tr>
<tr><td class="h">7613</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;##</td></tr>
<tr><td class="h">7614</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $memkey = [$uid, &quot;dayct2:$uid:$memkind&quot;];</td></tr>
<tr><td class="h">7615</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7615">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($not_memcache) {</td></tr>
<tr><td class="h">7616</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $list = LJ::MemCache::get($memkey);</td></tr>
<tr><td class="h">7617</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7617">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($list) {</td></tr>
<tr><td class="h">7618</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $list_create_time = shift @$list;</td></tr>
<tr><td class="h">7619</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7619">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $list if $list_create_time &gt;= $u-&gt;timeupdate;</td></tr>
<tr><td class="h">7620</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7621</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7622</td><td colspan="7"></td></tr><tr><td class="h">7623</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7623">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u) or return undef;</td></tr>
<tr><td class="h">7624</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $sth = $dbcr-&gt;prepare(&quot;SELECT year, month, day, COUNT(*) &quot;.</td></tr>
<tr><td class="h">7625</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;FROM log2 WHERE journalid=? $secwhere GROUP BY 1, 2, 3&quot;);</td></tr>
<tr><td class="h">7626</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$sth-&gt;execute($uid);</td></tr>
<tr><td class="h">7627</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @days;</td></tr>
<tr><td class="h">7628</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while (my ($y, $m, $d, $c) = $sth-&gt;fetchrow_array) {</td></tr>
<tr><td class="h">7629</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we force each number from string scalars (from DBI) to int scalars,</td></tr>
<tr><td class="h">7630</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# so they store smaller in memcache</td></tr>
<tr><td class="h">7631</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @days, [ int($y), int($m), int($d), int($c) ];</td></tr>
<tr><td class="h">7632</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7633</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::MemCache::add($memkey, [time, @days]);</td></tr>
<tr><td class="h">7634</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return \@days;</td></tr>
<tr><td class="h">7635</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7636</td><td colspan="7"></td></tr><tr><td class="h">7637</td><td colspan="7"></td></tr><tr><td class="h">7638</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">7639</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::journal_base</td></tr>
<tr><td class="h">7640</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Returns URL of a user&#39;s journal.</td></tr>
<tr><td class="h">7641</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info: The tricky thing is that users with underscores in their usernames</td></tr>
<tr><td class="h">7642</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       can&#39;t have some_user.example.com as a hostname, so that&#39;s changed into</td></tr>
<tr><td class="h">7643</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#       some-user.example.com.</td></tr>
<tr><td class="h">7644</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: uuser, vhost?</td></tr>
<tr><td class="h">7645</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-uuser: User hashref or username of user whose URL to make.</td></tr>
<tr><td class="h">7646</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-vhost: What type of URL.  Acceptable options: &quot;users&quot;, to make a</td></tr>
<tr><td class="h">7647</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            http://user.example.com/ URL; &quot;tilde&quot; for http://example.com/~user/;</td></tr>
<tr><td class="h">7648</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            &quot;community&quot; for http://example.com/community/user; or the default</td></tr>
<tr><td class="h">7649</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            will be http://example.com/users/user.  If unspecified and uuser</td></tr>
<tr><td class="h">7650</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#            is a user hashref, then the best/preferred vhost will be chosen.</td></tr>
<tr><td class="h">7651</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns: scalar; a URL.</td></tr>
<tr><td class="h">7652</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">7653</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub journal_base</td></tr>
<tr><td class="h">7654</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7655</td><td><div class="c3">273</div></td><td></td><td></td><td><div class="c3"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7655">273</a></div></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($user, $vhost) = @_;</td></tr>
<tr><td class="h">7656</td><td colspan="7"></td></tr><tr><td class="h">7657</td><td><div class="c3">273</div></td><td><div class="c0" title="-/F"><a href="cgi-bin-LJ-User-pm--branch.html#L7657">50</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7657">33</a></div></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (! isu($user) &amp;&amp; LJ::are_hooks(&quot;journal_base&quot;)) {</td></tr>
<tr><td class="h">7658</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = LJ::load_user($user);</td></tr>
<tr><td class="h">7659</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7659">0</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user = $u if $u;</td></tr>
<tr><td class="h">7660</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7661</td><td colspan="7"></td></tr><tr><td class="h">7662</td><td><div class="c3">273</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7662">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (isu($user)) {</td></tr>
<tr><td class="h">7663</td><td><div class="c3">273</div></td><td></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $u = $user;</td></tr>
<tr><td class="h">7664</td><td colspan="7"></td></tr><tr><td class="h">7665</td><td><div class="c3">273</div></td><td></td><td></td><td></td><td></td><td><div>4000</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $hookurl = LJ::run_hook(&quot;journal_base&quot;, $u, $vhost);</td></tr>
<tr><td class="h">7666</td><td><div class="c3">273</div></td><td><div class="c0" title="T/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7666">50</a></div></td><td></td><td></td><td></td><td><div>0</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $hookurl if $hookurl;</td></tr>
<tr><td class="h">7667</td><td colspan="7"></td></tr><tr><td class="h">7668</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user = $u-&gt;user;</td></tr>
<tr><td class="h">7669</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7669">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless (defined $vhost) {</td></tr>
<tr><td class="h">7670</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7670">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7670">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7670">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::FRONTPAGE_JOURNAL eq $user) {</td></tr>
<tr><td class="h">7671</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$vhost = &quot;front&quot;;</td></tr>
<tr><td class="h">7672</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( $u-&gt;is_person ) {</td></tr>
<tr><td class="h">7673</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$vhost = &quot;&quot;;</td></tr>
<tr><td class="h">7674</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ( $u-&gt;is_community ) {</td></tr>
<tr><td class="h">7675</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$vhost = &quot;community&quot;;</td></tr>
<tr><td class="h">7676</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7677</td><td colspan="7"></td></tr><tr><td class="h">7678</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7679</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7680</td><td colspan="7"></td></tr><tr><td class="h">7681</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7681">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7681">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7681">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7681">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7681">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($vhost eq &quot;users&quot;) {</td></tr>
<tr><td class="h">7682</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $he_user = $user;</td></tr>
<tr><td class="h">7683</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$he_user =~ s/_/-/g;</td></tr>
<tr><td class="h">7684</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;http://$he_user.$LJ::USER_DOMAIN&quot;;</td></tr>
<tr><td class="h">7685</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($vhost eq &quot;tilde&quot;) {</td></tr>
<tr><td class="h">7686</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$LJ::SITEROOT/~$user&quot;;</td></tr>
<tr><td class="h">7687</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($vhost eq &quot;community&quot;) {</td></tr>
<tr><td class="h">7688</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$LJ::SITEROOT/community/$user&quot;;</td></tr>
<tr><td class="h">7689</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($vhost eq &quot;front&quot;) {</td></tr>
<tr><td class="h">7690</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $LJ::SITEROOT;</td></tr>
<tr><td class="h">7691</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($vhost =~ /^other:(.+)/) {</td></tr>
<tr><td class="h">7692</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;http://$1&quot;;</td></tr>
<tr><td class="h">7693</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">7694</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;$LJ::SITEROOT/users/$user&quot;;</td></tr>
<tr><td class="h">7695</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7696</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">7697</td><td colspan="7"></td></tr><tr><td class="h">7698</td><td colspan="7"></td></tr><tr><td class="h">7699</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># FIXME: Update to pull out S1 support.</td></tr>
<tr><td class="h">7700</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">7701</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::make_journal</td></tr>
<tr><td class="h">7702</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># class:</td></tr>
<tr><td class="h">7703</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des:</td></tr>
<tr><td class="h">7704</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># info:</td></tr>
<tr><td class="h">7705</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg, user, view, remote, opts</td></tr>
<tr><td class="h">7706</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-:</td></tr>
<tr><td class="h">7707</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># returns:</td></tr>
<tr><td class="h">7708</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">7709</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub make_journal</td></tr>
<tr><td class="h">7710</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">{</td></tr>
<tr><td class="h">7711</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7711">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&amp;nodb;</td></tr>
<tr><td class="h">7712</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($user, $view, $remote, $opts) = @_;</td></tr>
<tr><td class="h">7713</td><td colspan="7"></td></tr><tr><td class="h">7714</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $r = DW::Request-&gt;get;</td></tr>
<tr><td class="h">7715</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $geta = $opts-&gt;{&#39;getargs&#39;};</td></tr>
<tr><td class="h">7716</td><td colspan="7"></td></tr><tr><td class="h">7717</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7717">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::SERVER_DOWN) {</td></tr>
<tr><td class="h">7718</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7718">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;vhost&#39;} eq &quot;customview&quot;) {</td></tr>
<tr><td class="h">7719</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;!-- LJ down for maintenance --&gt;&quot;;</td></tr>
<tr><td class="h">7720</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7721</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::server_down_html();</td></tr>
<tr><td class="h">7722</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7723</td><td colspan="7"></td></tr><tr><td class="h">7724</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7724">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = $opts-&gt;{&#39;u&#39;} || LJ::load_user($user);</td></tr>
<tr><td class="h">7725</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7725">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ($u) {</td></tr>
<tr><td class="h">7726</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;baduser&#39;} = 1;</td></tr>
<tr><td class="h">7727</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;&lt;!-- No such user --&gt;&quot;;  # return value ignored</td></tr>
<tr><td class="h">7728</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7729</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;LJ::set_active_journal($u);</td></tr>
<tr><td class="h">7730</td><td colspan="7"></td></tr><tr><td class="h">7731</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# S1 style hashref.  won&#39;t be loaded now necessarily,</td></tr>
<tr><td class="h">7732</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# only if via customview.</td></tr>
<tr><td class="h">7733</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $style;</td></tr>
<tr><td class="h">7734</td><td colspan="7"></td></tr><tr><td class="h">7735</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my ($styleid);</td></tr>
<tr><td class="h">7736</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7736">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;styleid&#39;}) {  # s1 styleid</td></tr>
<tr><td class="h">7737</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;S1 was removed, sorry.&#39;;</td></tr>
<tr><td class="h">7738</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">7739</td><td colspan="7"></td></tr><tr><td class="h">7740</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7740">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$view ||= &quot;lastn&quot;;    # default view when none specified explicitly in URLs</td></tr>
<tr><td class="h">7741</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7741">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7741">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($LJ::viewinfo{$view} || $view eq &quot;month&quot; ||</td></tr>
<tr><td class="h">7742</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$view eq &quot;entry&quot; || $view eq &quot;reply&quot;)  {</td></tr>
<tr><td class="h">7743</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$styleid = -1;    # to get past the return, then checked later for -1 and fixed, once user is loaded.</td></tr>
<tr><td class="h">7744</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">7745</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;badargs&#39;} = 1;</td></tr>
<tr><td class="h">7746</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7747</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7748</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7748">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return unless $styleid;</td></tr>
<tr><td class="h">7749</td><td colspan="7"></td></tr><tr><td class="h">7750</td><td colspan="7"></td></tr><tr><td class="h">7751</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;{&#39;_journalbase&#39;} = LJ::journal_base( $u-&gt;user, $opts-&gt;{&#39;vhost&#39;} );</td></tr>
<tr><td class="h">7752</td><td colspan="7"></td></tr><tr><td class="h">7753</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7753">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $eff_view = $LJ::viewinfo{$view}-&gt;{&#39;styleof&#39;} || $view;</td></tr>
<tr><td class="h">7754</td><td colspan="7"></td></tr><tr><td class="h">7755</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my @needed_props = (&quot;stylesys&quot;, &quot;s2_style&quot;, &quot;url&quot;, &quot;urlname&quot;, &quot;opt_nctalklinks&quot;,</td></tr>
<tr><td class="h">7756</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;renamedto&quot;,  &quot;opt_blockrobots&quot;, &quot;opt_usesharedpic&quot;, &quot;icbm&quot;,</td></tr>
<tr><td class="h">7757</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;journaltitle&quot;, &quot;journalsubtitle&quot;, &quot;external_foaf_url&quot;,</td></tr>
<tr><td class="h">7758</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;adult_content&quot;);</td></tr>
<tr><td class="h">7759</td><td colspan="7"></td></tr><tr><td class="h">7760</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# preload props the view creation code will need later (combine two selects)</td></tr>
<tr><td class="h">7761</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7761">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (ref $LJ::viewinfo{$eff_view}-&gt;{&#39;owner_props&#39;} eq &quot;ARRAY&quot;) {</td></tr>
<tr><td class="h">7762</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @needed_props, @{$LJ::viewinfo{$eff_view}-&gt;{&#39;owner_props&#39;}};</td></tr>
<tr><td class="h">7763</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7764</td><td colspan="7"></td></tr><tr><td class="h">7765</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;preload_props(@needed_props);</td></tr>
<tr><td class="h">7766</td><td colspan="7"></td></tr><tr><td class="h">7767</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if the remote is the user to be viewed, make sure the $remote</td></tr>
<tr><td class="h">7768</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# hashref has the value of $u&#39;s opt_nctalklinks (though with</td></tr>
<tr><td class="h">7769</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# LJ::load_user caching, this may be assigning between the same</td></tr>
<tr><td class="h">7770</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# underlying hashref)</td></tr>
<tr><td class="h">7771</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7771">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7771">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$remote-&gt;{&#39;opt_nctalklinks&#39;} = $u-&gt;{&#39;opt_nctalklinks&#39;} if</td></tr>
<tr><td class="h">7772</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( $remote &amp;&amp; $remote-&gt;userid == $u-&gt;userid );</td></tr>
<tr><td class="h">7773</td><td colspan="7"></td></tr><tr><td class="h">7774</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $stylesys = 1;</td></tr>
<tr><td class="h">7775</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7775">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($styleid == -1) {</td></tr>
<tr><td class="h">7776</td><td colspan="7"></td></tr><tr><td class="h">7777</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $get_styleinfo = sub {</td></tr>
<tr><td class="h">7778</td><td colspan="7"></td></tr><tr><td class="h">7779</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# forced s2 style id</td></tr>
<tr><td class="h">7780</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7780">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7780">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($geta-&gt;{&#39;s2id&#39;}) {</td></tr>
<tr><td class="h">7781</td><td colspan="7"></td></tr><tr><td class="h">7782</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get the owner of the requested style</td></tr>
<tr><td class="h">7783</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $style = LJ::S2::load_style( $geta-&gt;{s2id} );</td></tr>
<tr><td class="h">7784</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7784">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7784">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $owner = $style &amp;&amp; $style-&gt;{userid} ? $style-&gt;{userid} : 0;</td></tr>
<tr><td class="h">7785</td><td colspan="7"></td></tr><tr><td class="h">7786</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# remote can use s2id on this journal if:</td></tr>
<tr><td class="h">7787</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# owner of the style is remote or managed by remote OR</td></tr>
<tr><td class="h">7788</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# owner of the style has s2styles cap and remote is viewing owner&#39;s journal</td></tr>
<tr><td class="h">7789</td><td colspan="7"></td></tr><tr><td class="h">7790</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7790">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7790">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;id == $owner &amp;&amp; $u-&gt;get_cap(&quot;s2styles&quot;)) {</td></tr>
<tr><td class="h">7791</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;style_u&#39;} = LJ::load_userid($owner);</td></tr>
<tr><td class="h">7792</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (2, $geta-&gt;{&#39;s2id&#39;});</td></tr>
<tr><td class="h">7793</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7794</td><td colspan="7"></td></tr><tr><td class="h">7795</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7795">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7795">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($remote &amp;&amp; $remote-&gt;can_manage($owner)) {</td></tr>
<tr><td class="h">7796</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# check is owned style still available: paid user possible became plus...</td></tr>
<tr><td class="h">7797</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $lay_id = $style-&gt;{layer}-&gt;{layout};</td></tr>
<tr><td class="h">7798</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $theme_id = $style-&gt;{layer}-&gt;{theme};</td></tr>
<tr><td class="h">7799</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %lay_info;</td></tr>
<tr><td class="h">7800</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::S2::load_layer_info(\%lay_info, [$style-&gt;{layer}-&gt;{layout}, $style-&gt;{layer}-&gt;{theme}]);</td></tr>
<tr><td class="h">7801</td><td colspan="7"></td></tr><tr><td class="h">7802</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7802">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7802">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (LJ::S2::can_use_layer($remote, $lay_info{$lay_id}-&gt;{redist_uniq})</td></tr>
<tr><td class="h">7803</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and LJ::S2::can_use_layer($remote, $lay_info{$theme_id}-&gt;{redist_uniq})) {</td></tr>
<tr><td class="h">7804</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;style_u&#39;} = LJ::load_userid($owner);</td></tr>
<tr><td class="h">7805</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (2, $geta-&gt;{&#39;s2id&#39;});</td></tr>
<tr><td class="h">7806</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} # else this style not allowed by policy</td></tr>
<tr><td class="h">7807</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7808</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7809</td><td colspan="7"></td></tr><tr><td class="h">7810</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# style=mine passed in GET?</td></tr>
<tr><td class="h">7811</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7811">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7811">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $remote &amp;&amp; ( lc( $geta-&gt;{&#39;style&#39;} ) eq &#39;mine&#39; ) ) {</td></tr>
<tr><td class="h">7812</td><td colspan="7"></td></tr><tr><td class="h">7813</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get remote props and decide what style remote uses</td></tr>
<tr><td class="h">7814</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$remote-&gt;preload_props(&quot;stylesys&quot;, &quot;s2_style&quot;);</td></tr>
<tr><td class="h">7815</td><td colspan="7"></td></tr><tr><td class="h">7816</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# remote using s2; make sure we pass down the $remote object as the style_u to</td></tr>
<tr><td class="h">7817</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# indicate that they should use $remote to load the style instead of the regular $u</td></tr>
<tr><td class="h">7818</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7818">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7818">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($remote-&gt;{&#39;stylesys&#39;} == 2 &amp;&amp; $remote-&gt;{&#39;s2_style&#39;}) {</td></tr>
<tr><td class="h">7819</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;checkremote&#39;} = 1;</td></tr>
<tr><td class="h">7820</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;style_u&#39;} = $remote;</td></tr>
<tr><td class="h">7821</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (2, $remote-&gt;{&#39;s2_style&#39;});</td></tr>
<tr><td class="h">7822</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7823</td><td colspan="7"></td></tr><tr><td class="h">7824</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# return stylesys 2; will fall back on default style</td></tr>
<tr><td class="h">7825</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ( 2, undef );</td></tr>
<tr><td class="h">7826</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7827</td><td colspan="7"></td></tr><tr><td class="h">7828</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# resource URLs have the styleid in it</td></tr>
<tr><td class="h">7829</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7829">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7829">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($view eq &quot;res&quot; &amp;&amp; $opts-&gt;{&#39;pathextra&#39;} =~ m!^/(\d+)/!) {</td></tr>
<tr><td class="h">7830</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (2, $1);</td></tr>
<tr><td class="h">7831</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7832</td><td colspan="7"></td></tr><tr><td class="h">7833</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $forceflag = 0;</td></tr>
<tr><td class="h">7834</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LJ::run_hooks(&quot;force_s1&quot;, $u, \$forceflag);</td></tr>
<tr><td class="h">7835</td><td colspan="7"></td></tr><tr><td class="h">7836</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if none of the above match, they fall through to here</td></tr>
<tr><td class="h">7837</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7837">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7837">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( !$forceflag &amp;&amp; $u-&gt;{&#39;stylesys&#39;} == 2 ) {</td></tr>
<tr><td class="h">7838</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (2, $u-&gt;{&#39;s2_style&#39;});</td></tr>
<tr><td class="h">7839</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7840</td><td colspan="7"></td></tr><tr><td class="h">7841</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# no special case, let it fall back on the default</td></tr>
<tr><td class="h">7842</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ( 2, undef );</td></tr>
<tr><td class="h">7843</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">7844</td><td colspan="7"></td></tr><tr><td class="h">7845</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($stylesys, $styleid) = $get_styleinfo-&gt;();</td></tr>
<tr><td class="h">7846</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7847</td><td colspan="7"></td></tr><tr><td class="h">7848</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# transcode the tag filtering information into the tag getarg; this has to</td></tr>
<tr><td class="h">7849</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# be done above the s1shortcomings section so that we can fall through to that</td></tr>
<tr><td class="h">7850</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# style for lastn filtered by tags view</td></tr>
<tr><td class="h">7851</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7851">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7851">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7851">0</a></div><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7851">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($view eq &#39;lastn&#39; &amp;&amp; $opts-&gt;{pathextra} &amp;&amp; $opts-&gt;{pathextra} =~ /^\/tag\/(.+)$/) {</td></tr>
<tr><td class="h">7852</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{getargs}-&gt;{tag} = LJ::durl($1);</td></tr>
<tr><td class="h">7853</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{pathextra} = undef;</td></tr>
<tr><td class="h">7854</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7855</td><td colspan="7"></td></tr><tr><td class="h">7856</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# do the same for security filtering</td></tr>
<tr><td class="h">7857</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;elsif ($view eq &#39;lastn&#39; &amp;&amp; $opts-&gt;{pathextra} &amp;&amp; $opts-&gt;{pathextra} =~ /^\/security\/(.+)$/) {</td></tr>
<tr><td class="h">7858</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{getargs}-&gt;{security} = LJ::durl($1);</td></tr>
<tr><td class="h">7859</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{pathextra} = undef;</td></tr>
<tr><td class="h">7860</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7861</td><td colspan="7"></td></tr><tr><td class="h">7862</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7862">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;note( journalid =&gt; $u-&gt;userid )</td></tr>
<tr><td class="h">7863</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $r;</td></tr>
<tr><td class="h">7864</td><td colspan="7"></td></tr><tr><td class="h">7865</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $notice = sub {</td></tr>
<tr><td class="h">7866</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7866">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $msg, $status ) = @_;</td></tr>
<tr><td class="h">7867</td><td colspan="7"></td></tr><tr><td class="h">7868</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $url = &quot;$LJ::SITEROOT/users/$user/&quot;;</td></tr>
<tr><td class="h">7869</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7869">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;status&#39;} = $status if $status;</td></tr>
<tr><td class="h">7870</td><td colspan="7"></td></tr><tr><td class="h">7871</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $head;</td></tr>
<tr><td class="h">7872</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $journalbase = LJ::journal_base($user);</td></tr>
<tr><td class="h">7873</td><td colspan="7"></td></tr><tr><td class="h">7874</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Automatic Discovery of RSS/Atom</td></tr>
<tr><td class="h">7875</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head .= qq{&lt;link rel=&quot;alternate&quot; type=&quot;application/rss+xml&quot; title=&quot;RSS&quot; href=&quot;$journalbase/data/rss&quot; /&gt;\n};</td></tr>
<tr><td class="h">7876</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head .= qq{&lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom&quot; href=&quot;$journalbase/data/atom&quot; /&gt;\n};</td></tr>
<tr><td class="h">7877</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head .= qq{&lt;link rel=&quot;service.feed&quot; type=&quot;application/atom+xml&quot; title=&quot;AtomAPI-enabled feed&quot; href=&quot;$LJ::SITEROOT/interface/atom/feed&quot; /&gt;\n};</td></tr>
<tr><td class="h">7878</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head .= qq{&lt;link rel=&quot;service.post&quot; type=&quot;application/atom+xml&quot; title=&quot;Create a new post&quot; href=&quot;$LJ::SITEROOT/interface/atom/post&quot; /&gt;\n};</td></tr>
<tr><td class="h">7879</td><td colspan="7"></td></tr><tr><td class="h">7880</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# OpenID Server and Yadis</td></tr>
<tr><td class="h">7881</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head .= $u-&gt;openid_tags;</td></tr>
<tr><td class="h">7882</td><td colspan="7"></td></tr><tr><td class="h">7883</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# FOAF autodiscovery</td></tr>
<tr><td class="h">7884</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7884">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $foafurl = $u-&gt;{external_foaf_url} ? LJ::eurl($u-&gt;{external_foaf_url}) : &quot;$journalbase/data/foaf&quot;;</td></tr>
<tr><td class="h">7885</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head .= qq{&lt;link rel=&quot;meta&quot; type=&quot;application/rdf+xml&quot; title=&quot;FOAF&quot; href=&quot;$foafurl&quot; /&gt;\n};</td></tr>
<tr><td class="h">7886</td><td colspan="7"></td></tr><tr><td class="h">7887</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7887">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($u-&gt;email_visible($remote)) {</td></tr>
<tr><td class="h">7888</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $digest = Digest::SHA1::sha1_hex(&#39;mailto:&#39; . $u-&gt;email_raw);</td></tr>
<tr><td class="h">7889</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head .= qq{&lt;meta name=&quot;foaf:maker&quot; content=&quot;foaf:mbox_sha1sum &#39;$digest&#39;&quot; /&gt;\n};</td></tr>
<tr><td class="h">7890</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7891</td><td colspan="7"></td></tr><tr><td class="h">7892</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return qq{</td></tr>
<tr><td class="h">7893</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;html&gt;</td></tr>
<tr><td class="h">7894</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;</td></tr>
<tr><td class="h">7895</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$head</td></tr>
<tr><td class="h">7896</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/head&gt;</td></tr>
<tr><td class="h">7897</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;</td></tr>
<tr><td class="h">7898</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1&gt;Notice&lt;/h1&gt;</td></tr>
<tr><td class="h">7899</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;$msg&lt;/p&gt;</td></tr>
<tr><td class="h">7900</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Instead, please use &lt;nobr&gt;&lt;a href=\&quot;$url\&quot;&gt;$url&lt;/a&gt;&lt;/nobr&gt;&lt;/p&gt;</td></tr>
<tr><td class="h">7901</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;</td></tr>
<tr><td class="h">7902</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/html&gt;</td></tr>
<tr><td class="h">7903</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.(&quot;&lt;!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --&gt;\n&quot; x 50);</td></tr>
<tr><td class="h">7904</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">7905</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $error = sub {</td></tr>
<tr><td class="h">7906</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7906">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L7906">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ( $msg, $status, $header ) = @_;</td></tr>
<tr><td class="h">7907</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7907">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$header ||= &#39;Error&#39;;</td></tr>
<tr><td class="h">7908</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7908">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;status&#39;} = $status if $status;</td></tr>
<tr><td class="h">7909</td><td colspan="7"></td></tr><tr><td class="h">7910</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return qq{</td></tr>
<tr><td class="h">7911</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1&gt;$header&lt;/h1&gt;</td></tr>
<tr><td class="h">7912</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;$msg&lt;/p&gt;</td></tr>
<tr><td class="h">7913</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.(&quot;&lt;!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --&gt;\n&quot; x 50);</td></tr>
<tr><td class="h">7914</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">7915</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7915">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7915">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $LJ::USER_VHOSTS &amp;&amp; $opts-&gt;{&#39;vhost&#39;} eq &quot;users&quot; &amp;&amp; ! $u-&gt;is_redirect &amp;&amp;</td></tr>
<tr><td class="h">7916</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;! LJ::get_cap( $u, &quot;userdomain&quot; ) ) {</td></tr>
<tr><td class="h">7917</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $notice-&gt;( BML::ml( &#39;error.vhost.nodomain&#39;, { user_domain =&gt; $LJ::USER_DOMAIN } ) );</td></tr>
<tr><td class="h">7918</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7919</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7919">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7919">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;vhost&#39;} =~ /^other:/ &amp;&amp; ! LJ::get_cap($u, &quot;domainmap&quot;)) {</td></tr>
<tr><td class="h">7920</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $notice-&gt;( BML::ml( &#39;error.vhost.noalias&#39; ) );</td></tr>
<tr><td class="h">7921</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7922</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7922">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7922">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;vhost&#39;} eq &quot;customview&quot; &amp;&amp; ! LJ::get_cap($u, &quot;styles&quot;)) {</td></tr>
<tr><td class="h">7923</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $notice-&gt;( BML::ml( &#39;error.vhost.nostyle&#39; ) );</td></tr>
<tr><td class="h">7924</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7925</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7925">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7925">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;vhost&#39;} eq &quot;community&quot; &amp;&amp; $u-&gt;journaltype !~ /[CR]/) {</td></tr>
<tr><td class="h">7926</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;badargs&#39;} = 1; # Output a generic &#39;bad URL&#39; message if available</td></tr>
<tr><td class="h">7927</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $notice-&gt;( BML::ml( &#39;error.vhost.nocomm&#39; ) );</td></tr>
<tr><td class="h">7928</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7929</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7929">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7929">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($view eq &quot;network&quot; &amp;&amp; ! LJ::get_cap($u, &quot;friendsfriendsview&quot;)) {</td></tr>
<tr><td class="h">7930</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $inline;</td></tr>
<tr><td class="h">7931</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7931">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($inline .= LJ::run_hook(&quot;cprod_inline&quot;, $u, &#39;FriendsFriendsInline&#39;)) {</td></tr>
<tr><td class="h">7932</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $inline;</td></tr>
<tr><td class="h">7933</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">7934</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return BML::ml(&#39;cprod.friendsfriendsinline.text3.v1&#39;);</td></tr>
<tr><td class="h">7935</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7936</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7937</td><td colspan="7"></td></tr><tr><td class="h">7938</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# signal to LiveJournal.pm that we can&#39;t handle this</td></tr>
<tr><td class="h">7939</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7939">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7939">0</a></div><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7939">0</a></div><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7939">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (($stylesys == 1 || $geta-&gt;{&#39;format&#39;} eq &#39;light&#39; || $geta-&gt;{&#39;style&#39;} eq &#39;light&#39;) &amp;&amp;</td></tr>
<tr><td class="h">7940</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;({ entry=&gt;1, reply=&gt;1, month=&gt;1, tag=&gt;1 }-&gt;{$view} || ($view eq &#39;lastn&#39; &amp;&amp; ($geta-&gt;{tag} || $geta-&gt;{security})))) {</td></tr>
<tr><td class="h">7941</td><td colspan="7"></td></tr><tr><td class="h">7942</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# pick which fallback method (s2 or bml) we&#39;ll use by default, as configured with</td></tr>
<tr><td class="h">7943</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# $S1_SHORTCOMINGS</td></tr>
<tr><td class="h">7944</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7944">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $fallback = $LJ::S1_SHORTCOMINGS ? &quot;s2&quot; : &quot;bml&quot;;</td></tr>
<tr><td class="h">7945</td><td colspan="7"></td></tr><tr><td class="h">7946</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# but if the user specifies which they want, override the fallback we picked</td></tr>
<tr><td class="h">7947</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7947">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7947">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($geta-&gt;{&#39;fallback&#39;} &amp;&amp; $geta-&gt;{&#39;fallback&#39;} =~ /^s2|bml$/) {</td></tr>
<tr><td class="h">7948</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fallback = $geta-&gt;{&#39;fallback&#39;};</td></tr>
<tr><td class="h">7949</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7950</td><td colspan="7"></td></tr><tr><td class="h">7951</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if we are in this path, and they have style=mine set, it means</td></tr>
<tr><td class="h">7952</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# they either think they can get a S2 styled page but their account</td></tr>
<tr><td class="h">7953</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# type won&#39;t let them, or they really want this to fallback to bml</td></tr>
<tr><td class="h">7954</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7954">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7954">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $remote &amp;&amp; ( $geta-&gt;{&#39;style&#39;} eq &#39;mine&#39; ) ) {</td></tr>
<tr><td class="h">7955</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fallback = &#39;bml&#39;;</td></tr>
<tr><td class="h">7956</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7957</td><td colspan="7"></td></tr><tr><td class="h">7958</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# If they specified ?format=light, it means they want a page easy</td></tr>
<tr><td class="h">7959</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# to deal with text-only or on a mobile device.  For now that means</td></tr>
<tr><td class="h">7960</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# render it in the lynx site scheme.</td></tr>
<tr><td class="h">7961</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7961">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7961">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $geta-&gt;{&#39;format&#39;} eq &#39;light&#39; || $geta-&gt;{&#39;style&#39;} eq &#39;light&#39; ) {</td></tr>
<tr><td class="h">7962</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fallback = &#39;bml&#39;;</td></tr>
<tr><td class="h">7963</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;note(bml_use_scheme =&gt; &#39;lynx&#39;);</td></tr>
<tr><td class="h">7964</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7965</td><td colspan="7"></td></tr><tr><td class="h">7966</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# there are no BML handlers for these views, so force s2</td></tr>
<tr><td class="h">7967</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7967">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7967">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($view eq &#39;tag&#39; || $view eq &#39;lastn&#39;) {</td></tr>
<tr><td class="h">7968</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fallback = &quot;s2&quot;;</td></tr>
<tr><td class="h">7969</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7970</td><td colspan="7"></td></tr><tr><td class="h">7971</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fall back to BML unless we&#39;re using S2</td></tr>
<tr><td class="h">7972</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fallback (the &quot;s1shortcomings/layout&quot;)</td></tr>
<tr><td class="h">7973</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7973">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($fallback eq &quot;bml&quot;) {</td></tr>
<tr><td class="h">7974</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${$opts-&gt;{&#39;handle_with_bml_ref&#39;}} = 1;</td></tr>
<tr><td class="h">7975</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</td></tr>
<tr><td class="h">7976</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7977</td><td colspan="7"></td></tr><tr><td class="h">7978</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# S1 can&#39;t handle these views, so we fall back to a</td></tr>
<tr><td class="h">7979</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# system-owned S2 style (magic value &quot;s1short&quot;) that renders</td></tr>
<tr><td class="h">7980</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# this content</td></tr>
<tr><td class="h">7981</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$stylesys = 2;</td></tr>
<tr><td class="h">7982</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$styleid = &quot;s1short&quot;;</td></tr>
<tr><td class="h">7983</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">7984</td><td colspan="7"></td></tr><tr><td class="h">7985</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now, if there&#39;s a GET argument for tags, split those out</td></tr>
<tr><td class="h">7986</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7986">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (exists $opts-&gt;{getargs}-&gt;{tag}) {</td></tr>
<tr><td class="h">7987</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tagfilter = $opts-&gt;{getargs}-&gt;{tag};</td></tr>
<tr><td class="h">7988</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7988">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.tag.noarg&#39; ), &quot;404 Not Found&quot;, BML::ml( &#39;error.tag.name&#39; ) )</td></tr>
<tr><td class="h">7989</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $tagfilter;</td></tr>
<tr><td class="h">7990</td><td colspan="7"></td></tr><tr><td class="h">7991</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# error if disabled</td></tr>
<tr><td class="h">7992</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7992">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.tag.disabled&#39; ), &quot;404 Not Found&quot;, BML::ml( &#39;error.tag.name&#39; ) )</td></tr>
<tr><td class="h">7993</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::is_enabled(&#39;tags&#39;);</td></tr>
<tr><td class="h">7994</td><td colspan="7"></td></tr><tr><td class="h">7995</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# throw an error if we&#39;re rendering in S1, but not for renamed accounts</td></tr>
<tr><td class="h">7996</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L7996">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L7996">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.tag.s1&#39; ), &quot;404 Not Found&quot;, BML::ml( &#39;error.tag.name&#39; ) )</td></tr>
<tr><td class="h">7997</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $stylesys == 1 &amp;&amp; $view ne &#39;data&#39; &amp;&amp; ! $u-&gt;is_redirect;</td></tr>
<tr><td class="h">7998</td><td colspan="7"></td></tr><tr><td class="h">7999</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# overwrite any tags that exist</td></tr>
<tr><td class="h">8000</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{tags} = [];</td></tr>
<tr><td class="h">8001</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8001">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.tag.invalid&#39; ), &quot;404 Not Found&quot;, BML::ml( &#39;error.tag.name&#39; ) )</td></tr>
<tr><td class="h">8002</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::Tags::is_valid_tagstring($tagfilter, $opts-&gt;{tags}, { omit_underscore_check =&gt; 1 });</td></tr>
<tr><td class="h">8003</td><td colspan="7"></td></tr><tr><td class="h">8004</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# get user&#39;s tags so we know what remote can see, and setup an inverse mapping</td></tr>
<tr><td class="h">8005</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# from keyword to tag</td></tr>
<tr><td class="h">8006</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{tagids} = [];</td></tr>
<tr><td class="h">8007</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tags = LJ::Tags::get_usertags($u, { remote =&gt; $remote });</td></tr>
<tr><td class="h">8008</td><td><div class="c0">0</div><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8008">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my %kwref = ( map { $tags-&gt;{$_}-&gt;{name} =&gt; $_ } keys %{$tags || {}} );</td></tr>
<tr><td class="h">8009</td><td colspan="7"></td></tr><tr><td class="h">8010</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (@{$opts-&gt;{tags}}) {</td></tr>
<tr><td class="h">8011</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8011">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.tag.undef&#39; ), &quot;404 Not Found&quot;, BML::ml( &#39;error.tag.name&#39; ) )</td></tr>
<tr><td class="h">8012</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $kwref{$_};</td></tr>
<tr><td class="h">8013</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @{$opts-&gt;{tagids}}, $kwref{$_};</td></tr>
<tr><td class="h">8014</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8015</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8016</td><td colspan="7"></td></tr><tr><td class="h">8017</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# validate the security filter</td></tr>
<tr><td class="h">8018</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8018">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (exists $opts-&gt;{getargs}-&gt;{security}) {</td></tr>
<tr><td class="h">8019</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $securityfilter = $opts-&gt;{getargs}-&gt;{security};</td></tr>
<tr><td class="h">8020</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8020">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.security.noarg&#39; ), &quot;404 Not Found&quot;, BML::ml( &#39;error.security.name&#39; ) )</td></tr>
<tr><td class="h">8021</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless $securityfilter;</td></tr>
<tr><td class="h">8022</td><td colspan="7"></td></tr><tr><td class="h">8023</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8023">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L8023">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.security.nocap&#39; ), &quot;403 Forbidden&quot;, BML::ml( &#39;error.security.name&#39; ) )</td></tr>
<tr><td class="h">8024</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::get_cap($remote, &quot;security_filter&quot;) || LJ::get_cap($u, &quot;security_filter&quot;);</td></tr>
<tr><td class="h">8025</td><td colspan="7"></td></tr><tr><td class="h">8026</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# error if disabled</td></tr>
<tr><td class="h">8027</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8027">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.security.disabled&#39; ), &quot;404 Not Found&quot;, BML::ml( &#39;error.security.name&#39; ) )</td></tr>
<tr><td class="h">8028</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless LJ::is_enabled(&quot;security_filter&quot;);</td></tr>
<tr><td class="h">8029</td><td colspan="7"></td></tr><tr><td class="h">8030</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# throw an error if we&#39;re rendering in S1, but not for renamed accounts</td></tr>
<tr><td class="h">8031</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8031">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L8031">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.security.s1&#39; ), &quot;404 Not Found&quot;, BML::ml( &#39;error.security.name&#39; ) )</td></tr>
<tr><td class="h">8032</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $stylesys == 1 &amp;&amp; $view ne &#39;data&#39; &amp;&amp; ! $u-&gt;is_redirect;</td></tr>
<tr><td class="h">8033</td><td colspan="7"></td></tr><tr><td class="h">8034</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# check the filter itself</td></tr>
<tr><td class="h">8035</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8035">0</a></div><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8035">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($securityfilter =~ /^(?:public|friends|private)$/i) {</td></tr>
<tr><td class="h">8036</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{securityfilter} = lc($securityfilter);</td></tr>
<tr><td class="h">8037</td><td colspan="7"></td></tr><tr><td class="h">8038</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# see if they want to filter by a custom group</td></tr>
<tr><td class="h">8039</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif ($securityfilter =~ /^group:(.+)$/i) {</td></tr>
<tr><td class="h">8040</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $tf = $u-&gt;trust_groups( name =&gt; $1 );</td></tr>
<tr><td class="h">8041</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8041">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L8041">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $tf &amp;&amp; ( $u-&gt;equals( $remote ) ||</td></tr>
<tr><td class="h">8042</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$u-&gt;trustmask( $remote ) &amp; ( 1 &lt;&lt; $tf-&gt;{groupnum} ) ) ) {</td></tr>
<tr><td class="h">8043</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# let them filter the results page by this group</td></tr>
<tr><td class="h">8044</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{securityfilter} = $tf-&gt;{groupnum};</td></tr>
<tr><td class="h">8045</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8046</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8047</td><td colspan="7"></td></tr><tr><td class="h">8048</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8048">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.security.invalid&#39; ), &quot;404 Not Found&quot;, BML::ml( &#39;error.security.name&#39; ) )</td></tr>
<tr><td class="h">8049</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unless defined $opts-&gt;{securityfilter};</td></tr>
<tr><td class="h">8050</td><td colspan="7"></td></tr><tr><td class="h">8051</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8052</td><td colspan="7"></td></tr><tr><td class="h">8053</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8053">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L8053">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;unless ( $geta-&gt;{&#39;viewall&#39;} &amp;&amp; $remote &amp;&amp; $remote-&gt;has_priv( &quot;canview&quot;, &quot;suspended&quot; ) ||</td></tr>
<tr><td class="h">8054</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;pathextra&#39;} =~ m!/(\d+)/stylesheet$! ) { # don&#39;t check style sheets</td></tr>
<tr><td class="h">8055</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8055">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;is_deleted ) {</td></tr>
<tr><td class="h">8056</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $warning;</td></tr>
<tr><td class="h">8057</td><td colspan="7"></td></tr><tr><td class="h">8058</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8058">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;prop( &#39;delete_reason&#39; ) ) {</td></tr>
<tr><td class="h">8059</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$warning = BML::ml( &#39;error.deleted.text.withreason&#39;, { user =&gt; $u-&gt;display_name, reason =&gt; $u-&gt;prop( &#39;delete_reason&#39; ) } );</td></tr>
<tr><td class="h">8060</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">8061</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$warning = BML::ml( &#39;error.deleted.text&#39;, { user =&gt; $u-&gt;display_name } );</td></tr>
<tr><td class="h">8062</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8063</td><td colspan="7"></td></tr><tr><td class="h">8064</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( $warning, &quot;404 Not Found&quot;, BML::ml( &#39;error.deleted.name&#39; ) );</td></tr>
<tr><td class="h">8065</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8066</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8066">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;is_suspended ) {</td></tr>
<tr><td class="h">8067</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $warning = BML::ml( &#39;error.suspended.text&#39;, { user =&gt; $u-&gt;ljuser_display, sitename =&gt; $LJ::SITENAME } );</td></tr>
<tr><td class="h">8068</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( $warning, &quot;403 Forbidden&quot;, BML::ml( &#39;error.suspended.name&#39; ) );</td></tr>
<tr><td class="h">8069</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8070</td><td colspan="7"></td></tr><tr><td class="h">8071</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $entry = $opts-&gt;{ljentry};</td></tr>
<tr><td class="h">8072</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8072">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L8072">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( $entry &amp;&amp; $entry-&gt;is_suspended_for( $remote ) ) {</td></tr>
<tr><td class="h">8073</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $warning = BML::ml( &#39;error.suspended.entry&#39;, { aopts =&gt; &quot;href=&#39;$u-&gt;journal_base/&#39;&quot; } );</td></tr>
<tr><td class="h">8074</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( $warning, &quot;403 Forbidden&quot;, BML::ml( &#39;error.suspended.name&#39; ) );</td></tr>
<tr><td class="h">8075</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8076</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8077</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8077">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( BML::ml( &#39;error.purged.text&#39; ), &quot;410 Gone&quot;, BML::ml( &#39;error.purged.name&#39; ) ) if $u-&gt;is_expunged;</td></tr>
<tr><td class="h">8078</td><td colspan="7"></td></tr><tr><td class="h">8079</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# FIXME: pretty this up at some point, to maybe auto-redirect to </td></tr>
<tr><td class="h">8080</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# the external URL or something, but let&#39;s just do this for now</td></tr>
<tr><td class="h">8081</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8081">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L8081">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;is_identity &amp;&amp; $view ne &quot;read&quot; ) {</td></tr>
<tr><td class="h">8082</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $warning = BML::ml( &#39;error.nojournal.openid&#39;, { aopts =&gt; &quot;href=&#39;$u-&gt;openid_identity&#39;&quot;, id =&gt; $u-&gt;openid_identity } );</td></tr>
<tr><td class="h">8083</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $error-&gt;( $warning, &quot;404 Not here&quot; );</td></tr>
<tr><td class="h">8084</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8085</td><td colspan="7"></td></tr><tr><td class="h">8086</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;view&#39;} = $view;</td></tr>
<tr><td class="h">8087</td><td colspan="7"></td></tr><tr><td class="h">8088</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# what charset we put in the HTML</td></tr>
<tr><td class="h">8089</td><td><div class="c0">0</div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L8089">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$opts-&gt;{&#39;saycharset&#39;} ||= &quot;utf-8&quot;;</td></tr>
<tr><td class="h">8090</td><td colspan="7"></td></tr><tr><td class="h">8091</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8091">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($view eq &#39;data&#39;) {</td></tr>
<tr><td class="h">8092</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return LJ::Feed::make_feed($r, $u, $remote, $opts);</td></tr>
<tr><td class="h">8093</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8094</td><td colspan="7"></td></tr><tr><td class="h">8095</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8095">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ($stylesys == 2) {</td></tr>
<tr><td class="h">8096</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8096">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r-&gt;note(codepath =&gt; &quot;s2.$view&quot;)</td></tr>
<tr><td class="h">8097</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if $r;</td></tr>
<tr><td class="h">8098</td><td colspan="7"></td></tr><tr><td class="h">8099</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval { LJ::S2-&gt;can(&quot;dostuff&quot;) };  # force Class::Autouse</td></tr>
<tr><td class="h">8100</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $mj = LJ::S2::make_journal($u, $styleid, $view, $remote, $opts);</td></tr>
<tr><td class="h">8101</td><td colspan="7"></td></tr><tr><td class="h">8102</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# intercept flag to handle_with_bml_ref and instead use S1 shortcomings</td></tr>
<tr><td class="h">8103</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if BML is disabled</td></tr>
<tr><td class="h">8104</td><td><div class="c0">0</div><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8104">0</a></div></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--condition.html#L8104">0</a></div></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($opts-&gt;{&#39;handle_with_bml_ref&#39;} &amp;&amp; ${$opts-&gt;{&#39;handle_with_bml_ref&#39;}} &amp;&amp;</td></tr>
<tr><td class="h">8105</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($LJ::S1_SHORTCOMINGS || $geta-&gt;{fallback} eq &quot;s2&quot;))</td></tr>
<tr><td class="h">8106</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</td></tr>
<tr><td class="h">8107</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# kill the flag</td></tr>
<tr><td class="h">8108</td><td><div class="c0">0</div><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${$opts-&gt;{&#39;handle_with_bml_ref&#39;}} = 0;</td></tr>
<tr><td class="h">8109</td><td colspan="7"></td></tr><tr><td class="h">8110</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# and proceed with s1shortcomings (which looks like BML) instead of BML</td></tr>
<tr><td class="h">8111</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mj = LJ::S2::make_journal($u, &quot;s1short&quot;, $view, $remote, $opts);</td></tr>
<tr><td class="h">8112</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8113</td><td colspan="7"></td></tr><tr><td class="h">8114</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $mj;</td></tr>
<tr><td class="h">8115</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8116</td><td colspan="7"></td></tr><tr><td class="h">8117</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# if we get here, then we tried to run the old S1 path, so die and hope that</td></tr>
<tr><td class="h">8118</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# somebody comes along to fix us :(</td></tr>
<tr><td class="h">8119</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;confess &#39;Tried to run S1 journal rendering path.&#39;;</td></tr>
<tr><td class="h">8120</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">8121</td><td colspan="7"></td></tr><tr><td class="h">8122</td><td colspan="7"></td></tr><tr><td class="h">8123</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">8124</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  28. Userpic-Related Functions</td></tr>
<tr><td class="h">8125</td><td colspan="7"></td></tr><tr><td class="h">8126</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;LJFUNC&gt;</td></tr>
<tr><td class="h">8127</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># name: LJ::userpic_count</td></tr>
<tr><td class="h">8128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des: Gets a count of userpics for a given user.</td></tr>
<tr><td class="h">8129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># args: dbarg?, upics, idlist</td></tr>
<tr><td class="h">8130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-upics: hashref to load pictures into, keys being the picids</td></tr>
<tr><td class="h">8131</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># des-idlist: [$u, $picid] or [[$u, $picid], [$u, $picid], +] objects</td></tr>
<tr><td class="h">8132</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">#             also supports deprecated old method, of an array ref of picids.</td></tr>
<tr><td class="h">8133</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># &lt;/LJFUNC&gt;</td></tr>
<tr><td class="h">8134</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub userpic_count {</td></tr>
<tr><td class="h">8135</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8135">0</a></div></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L8135">0</a></div></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $u = shift or return undef;</td></tr>
<tr><td class="h">8136</td><td colspan="7"></td></tr><tr><td class="h">8137</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8137">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if ( $u-&gt;dversion &gt; 6 ) {</td></tr>
<tr><td class="h">8138</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8138">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $dbcr = LJ::get_cluster_def_reader($u) or return undef;</td></tr>
<tr><td class="h">8139</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $dbcr-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM userpic2 &quot; .</td></tr>
<tr><td class="h">8140</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid=? AND state &lt;&gt; &#39;X&#39;&quot;, undef, $u-&gt;userid);</td></tr>
<tr><td class="h">8141</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">8142</td><td colspan="7"></td></tr><tr><td class="h">8143</td><td><div class="c0">0</div></td><td><div class="c0" title="-/-"><a href="cgi-bin-LJ-User-pm--branch.html#L8143">0</a></div></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $dbh = LJ::get_db_writer() or return undef;</td></tr>
<tr><td class="h">8144</td><td><div class="c0">0</div></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;return $dbh-&gt;selectrow_array(&quot;SELECT COUNT(*) FROM userpic &quot; .</td></tr>
<tr><td class="h">8145</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WHERE userid=? AND state &lt;&gt; &#39;X&#39;&quot;, undef, $u-&gt;userid);</td></tr>
<tr><td class="h">8146</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">8147</td><td colspan="7"></td></tr><tr><td class="h">8148</td><td colspan="7"></td></tr><tr><td class="h">8149</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">########################################################################</td></tr>
<tr><td class="h">8150</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">###  99. Miscellaneous Legacy Items</td></tr>
<tr><td class="h">8151</td><td colspan="7"></td></tr><tr><td class="h">8152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s"># FIXME: these are deprecated and no longer used; check what calls them and kill it.</td></tr>
<tr><td class="h">8153</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L8153">0</a></div></td><td></td><td></td><td class="s">sub add_friend    { confess &#39;LJ::add_friend has been deprecated.&#39;;    }</td></tr>
<tr><td class="h">8154</td><td><div class="c0">0</div></td><td></td><td></td><td><div class="c0"><a href="cgi-bin-LJ-User-pm--subroutine.html#L8154">0</a></div></td><td></td><td></td><td class="s">sub remove_friend { confess &#39;LJ::remove_friend has been deprecated.&#39;; }</td></tr>
<tr><td class="h">8155</td><td colspan="7"></td></tr><tr><td class="h">8156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
